<!DOCTYPE html>
<html>
  <head>
    <title>Plist HTML Viewer</title>

    <meta charset="UTF-8">

    <style type="text/css">
      .CodeMirror{font-family:monospace;height:300px;color:#000;direction:ltr}.CodeMirror-lines{padding:4px 0}.CodeMirror pre{padding:0 4px}.CodeMirror-gutter-filler,.CodeMirror-scrollbar-filler{background-color:#fff}.CodeMirror-gutters{border-right:1px solid #ddd;background-color:#f7f7f7;white-space:nowrap}.CodeMirror-linenumber{padding:0 3px 0 5px;min-width:20px;text-align:right;color:#999;white-space:nowrap}.CodeMirror-guttermarker{color:#000}.CodeMirror-guttermarker-subtle{color:#999}.CodeMirror-cursor{border-left:1px solid #000;border-right:none;width:0}.CodeMirror div.CodeMirror-secondarycursor{border-left:1px solid silver}.cm-fat-cursor .CodeMirror-cursor{width:auto;border:0!important;background:#7e7}.cm-fat-cursor div.CodeMirror-cursors{z-index:1}.cm-animate-fat-cursor{width:auto;border:0;-webkit-animation:blink 1.06s steps(1) infinite;-moz-animation:blink 1.06s steps(1) infinite;animation:blink 1.06s steps(1) infinite;background-color:#7e7}@-moz-keyframes blink{50%{background-color:transparent}}@-webkit-keyframes blink{50%{background-color:transparent}}@keyframes blink{50%{background-color:transparent}}.cm-tab{display:inline-block;text-decoration:inherit}.CodeMirror-rulers{position:absolute;left:0;right:0;top:-50px;bottom:-20px;overflow:hidden}.CodeMirror-ruler{border-left:1px solid #ccc;top:0;bottom:0;position:absolute}.cm-s-default .cm-header{color:#00f}.cm-s-default .cm-quote{color:#090}.cm-negative{color:#d44}.cm-positive{color:#292}.cm-header,.cm-strong{font-weight:700}.cm-em{font-style:italic}.cm-link{text-decoration:underline}.cm-strikethrough{text-decoration:line-through}.cm-s-default .cm-keyword{color:#708}.cm-s-default .cm-atom{color:#219}.cm-s-default .cm-number{color:#164}.cm-s-default .cm-def{color:#00f}.cm-s-default .cm-variable-2{color:#05a}.cm-s-default .cm-type,.cm-s-default .cm-variable-3{color:#085}.cm-s-default .cm-comment{color:#a50}.cm-s-default .cm-string{color:#a11}.cm-s-default .cm-string-2{color:#f50}.cm-s-default .cm-meta{color:#555}.cm-s-default .cm-qualifier{color:#555}.cm-s-default .cm-builtin{color:#30a}.cm-s-default .cm-bracket{color:#997}.cm-s-default .cm-tag{color:#170}.cm-s-default .cm-attribute{color:#00c}.cm-s-default .cm-hr{color:#999}.cm-s-default .cm-link{color:#00c}.cm-s-default .cm-error{color:red}.cm-invalidchar{color:red}.CodeMirror-composing{border-bottom:2px solid}div.CodeMirror span.CodeMirror-matchingbracket{color:#0f0}div.CodeMirror span.CodeMirror-nonmatchingbracket{color:#f22}.CodeMirror-matchingtag{background:rgba(255,150,0,.3)}.CodeMirror-activeline-background{background:#e8f2ff}.CodeMirror{position:relative;overflow:hidden;background:#fff}.CodeMirror-scroll{overflow:scroll!important;margin-bottom:-30px;margin-right:-30px;padding-bottom:30px;height:100%;outline:0;position:relative}.CodeMirror-sizer{position:relative;border-right:30px solid transparent}.CodeMirror-gutter-filler,.CodeMirror-hscrollbar,.CodeMirror-scrollbar-filler,.CodeMirror-vscrollbar{position:absolute;z-index:6;display:none}.CodeMirror-vscrollbar{right:0;top:0;overflow-x:hidden;overflow-y:scroll}.CodeMirror-hscrollbar{bottom:0;left:0;overflow-y:hidden;overflow-x:scroll}.CodeMirror-scrollbar-filler{right:0;bottom:0}.CodeMirror-gutter-filler{left:0;bottom:0}.CodeMirror-gutters{position:absolute;left:0;top:0;min-height:100%;z-index:3}.CodeMirror-gutter{white-space:normal;height:100%;display:inline-block;vertical-align:top;margin-bottom:-30px}.CodeMirror-gutter-wrapper{position:absolute;z-index:4;background:0 0!important;border:none!important}.CodeMirror-gutter-background{position:absolute;top:0;bottom:0;z-index:4}.CodeMirror-gutter-elt{position:absolute;cursor:default;z-index:4}.CodeMirror-gutter-wrapper ::selection{background-color:transparent}.CodeMirror-gutter-wrapper ::-moz-selection{background-color:transparent}.CodeMirror-lines{cursor:text;min-height:1px}.CodeMirror pre{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;border-width:0;background:0 0;font-family:inherit;font-size:inherit;margin:0;white-space:pre;word-wrap:normal;line-height:inherit;color:inherit;z-index:2;position:relative;overflow:visible;-webkit-tap-highlight-color:transparent;-webkit-font-variant-ligatures:contextual;font-variant-ligatures:contextual}.CodeMirror-wrap pre{word-wrap:break-word;white-space:pre-wrap;word-break:normal}.CodeMirror-linebackground{position:absolute;left:0;right:0;top:0;bottom:0;z-index:0}.CodeMirror-linewidget{position:relative;z-index:2;overflow:auto}.CodeMirror-rtl pre{direction:rtl}.CodeMirror-code{outline:0}.CodeMirror-gutter,.CodeMirror-gutters,.CodeMirror-linenumber,.CodeMirror-scroll,.CodeMirror-sizer{-moz-box-sizing:content-box;box-sizing:content-box}.CodeMirror-measure{position:absolute;width:100%;height:0;overflow:hidden;visibility:hidden}.CodeMirror-cursor{position:absolute;pointer-events:none}.CodeMirror-measure pre{position:static}div.CodeMirror-cursors{visibility:hidden;position:relative;z-index:3}div.CodeMirror-dragcursors{visibility:visible}.CodeMirror-focused div.CodeMirror-cursors{visibility:visible}.CodeMirror-selected{background:#d9d9d9}.CodeMirror-focused .CodeMirror-selected{background:#d7d4f0}.CodeMirror-crosshair{cursor:crosshair}.CodeMirror-line::selection,.CodeMirror-line>span::selection,.CodeMirror-line>span>span::selection{background:#d7d4f0}.CodeMirror-line::-moz-selection,.CodeMirror-line>span::-moz-selection,.CodeMirror-line>span>span::-moz-selection{background:#d7d4f0}.cm-searching{background-color:#ffa;background-color:rgba(255,255,0,.4)}.cm-force-border{padding-right:.1px}@media print{.CodeMirror div.CodeMirror-cursors{visibility:hidden}}.cm-tab-wrap-hack:after{content:''}span.CodeMirror-selectedtext{background:0 0}
/*# sourceMappingURL=codemirror.min.css.map */

      .severity-low {
  background-color: #669603;
}

.severity-low:after {
  content : 'L';
}

.severity-unspecified {
  background-color: #666666;
}

.severity-unspecified:after {
  content : 'U';
}

.severity-style {
  background-color: #9932cc;
}

.severity-style:after {
  content : 'S';
}

.severity-medium {
  background-color: #a9d323;
  color: black;
}

.severity-medium:after {
  content : 'M';
}

.severity-high {
  background-color: #ffa800;
}

.severity-high:after {
  content : 'H';
}

.severity-critical {
  background-color: #e92625;
}

.severity-critical:after {
  content : 'C';
}

i[class*="severity-"] {
  line-height: normal;
  text-transform: capitalize;
  font-size: 0.8em;
  font-weight: bold;
  color: white;
  display: inline-block;
  width: 16px;
  height: 16px;
  text-align: center;
  font-family: sans-serif;
}

      html, body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

div.container {
  padding: 10px;
}

#content {
  height: 100%;
  display: block;
  overflow: hidden;
}

#content > div {
  margin: 10px;
  border: 1px solid #ddd;
  border-radius: 3px;
  height: 97%;
}

#side-bar {
  overflow: auto;
}

#editor-wrapper {
  overflow: hidden;
}

.button {
  background-color: #f1f1f1;
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  color: black;
  cursor: pointer;
}

.button:hover {
  background-color: #ddd;
  color: black;
}

.review-status {
  color: white;
  text-align: center;
}

.review-status-confirmed {
  background-color: #e92625;
}

.review-status-false-positive {
  background-color: grey;
}

.review-status-intentional {
  background-color: #669603;
}

      div.container {
  width: 100%;
  height: 100%;
  padding: 0px;
}

#editor-wrapper {
  margin: 10px;
}

#side-bar {
  float: left;
  width: 260px;
  margin: 0px;
}

#report-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  overflow-y: auto;
  height: 100%;
}

#report-nav ul > li {
  padding: .4em;
  background-color: #fff;
  border-bottom: 1px solid rgba(0,0,0,.125);
  text-align: left;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

#report-nav ul > li.active {
  background-color: #427ea9;
  color: white;
}

#report-nav ul > li:hover {
  background-color: #427ea9;
  color: white;
  cursor: pointer;
}

#report-nav ul a {
  text-decoration: none;
}

#report-nav i[class*="severity-"] {
  margin-right: 5px;
}

.header {
  border-bottom: 1px solid lightgrey;
  font-family: monospace;
  padding: 10px;
  background-color: #fafbfc;
  border-bottom: 1px solid #e1e4e8;
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
}

#report-nav .header {
  font-weight: bold;
}

#editor-wrapper .header > div {
  padding-top: 2px;
}

#file-path,
#checker-name {
  color: #195ea2;
}

#review-status {
  padding: 0px 5px;
}

#file-path {
  font-family: monospace;
}

.check-msg {
  display: inline-block;
  padding: 3px 6px;
  margin: 1px;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.check-msg.info {
  color: #00546f;
  background-color: #bfdfe9;
  border: 1px solid #87a8b3;
}

.check-msg.error {
  background-color: #f2dede;
  color: #a94442;
  border: 1px solid #ebcccc;
}

.check-msg.macro {
  background-color: #d7dac2;
  color: #4f5c6d;
  border: 1px solid #d7dac2;
}

.check-msg.note {
  background-color: #d7d7d7;
  color: #4f5c6d;
  border: 1px solid #bfbfbf;
}

.check-msg.current {
  border: 2px dashed #3692ff;
}

.check-msg .tag {
  padding: 1px 5px;
  text-align: center;
  border-radius: 2px;
  margin-right: 5px;
  text-decoration: inherit;
}

.check-msg .tag.macro {
  background-color: #83876a;
  color: white;
  text-transform: capitalize;
}

.check-msg .tag.note {
  background-color: #9299a1;
  color: white;
  text-transform: capitalize;
}

.checker-enum {
  color: white;
  padding: 1px 5px;
  text-align: center;
  border-radius: 25px;
  margin-right: 5px;
  text-decoration: inherit;
}

.checker-enum.info {
  background-color: #427ea9;
}

.checker-enum.error {
  background-color: #a94442;
}

.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  cursor: pointer;
  margin: 0px 5px;
}

.arrow:hover {
  border: solid #437ea8;
  border-width: 0 3px 3px 0;
}

.left-arrow {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.right-arrow {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

    </style>

    <script type="text/javascript">
      function setNonCompatibleBrowserMessage() {
  document.body.innerHTML =
    '<h2 style="margin-left: 20px;">Your browser is not compatible with CodeChecker Viewer!</h2> \
     <p style="margin-left: 20px;">The version required for the following browsers are:</p> \
     <ul style="margin-left: 20px;"> \
     <li>Internet Explorer: version 9 or newer</li> \
     <li>Firefox: version 22.0 or newer</li> \
     </ul>';
}

// http://stackoverflow.com/questions/5916900/how-can-you-detect-the-version-of-a-browser
var browserVersion = (function(){
  var ua = navigator.userAgent, tem,
    M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];

  if (/trident/i.test(M[1])) {
    tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE ' + (tem[1] || '');
  }

  if (M[1] === 'Chrome') {
    tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
    if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }

  M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
  if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var pos = browserVersion.indexOf(' ');
var browser = browserVersion.substr(0, pos);
var version = parseInt(browserVersion.substr(pos + 1));

var browserCompatible
  = browser === 'Firefox'
  ? version >= 22
  : browser === 'IE'
  ? version >= 9
  : true;


      /* MIT License

Copyright (C) 2017 by Marijn Haverbeke <marijn@haverbeke.berlin> and others

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
 */
      !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CodeMirror=t()}(this,function(){"use strict";function e(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function t(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function r(e,r){return t(e).appendChild(r)}function n(e,t,r,n){var i=document.createElement(e);if(r&&(i.className=r),n&&(i.style.cssText=n),"string"==typeof t)i.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)i.appendChild(t[o]);return i}function i(e,t,r,i){var o=n(e,t,r,i);return o.setAttribute("role","presentation"),o}function o(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function l(){var e;try{e=document.activeElement}catch(t){e=document.body||null}for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e}function s(t,r){var n=t.className;e(r).test(n)||(t.className+=(n?" ":"")+r)}function a(t,r){for(var n=t.split(" "),i=0;i<n.length;i++)n[i]&&!e(n[i]).test(r)&&(r+=" "+n[i]);return r}function u(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function c(e,t,r){t||(t={});for(var n in e)!e.hasOwnProperty(n)||!1===r&&t.hasOwnProperty(n)||(t[n]=e[n]);return t}function f(e,t,r,n,i){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,l=i||0;;){var s=e.indexOf("\t",o);if(s<0||s>=t)return l+(t-o);l+=s-o,l+=r-l%r,o=s+1}}function h(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function d(e,t,r){for(var n=0,i=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var l=o-n;if(o==e.length||i+l>=t)return n+Math.min(l,t-i);if(i+=o-n,i+=r-i%r,n=o+1,i>=t)return n}}function p(e){for(;Kl.length<=e;)Kl.push(g(Kl)+" ");return Kl[e]}function g(e){return e[e.length-1]}function v(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function m(e,t,r){for(var n=0,i=r(t);n<e.length&&r(e[n])<=i;)n++;e.splice(n,0,t)}function y(){}function b(e,t){var r;return Object.create?r=Object.create(e):(y.prototype=e,r=new y),t&&c(t,r),r}function w(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||jl.test(e))}function x(e,t){return t?!!(t.source.indexOf("\\w")>-1&&w(e))||t.test(e):w(e)}function C(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function S(e){return e.charCodeAt(0)>=768&&Xl.test(e)}function L(e,t,r){for(;(r<0?t>0:t<e.length)&&S(e.charAt(t));)t+=r;return t}function k(e,t,r){for(var n=t>r?-1:1;;){if(t==r)return t;var i=(t+r)/2,o=n<0?Math.ceil(i):Math.floor(i);if(o==t)return e(o)?t:r;e(o)?r=o:t=o+n}}function T(e,t,r){var o=this;this.input=r,o.scrollbarFiller=n("div",null,"CodeMirror-scrollbar-filler"),o.scrollbarFiller.setAttribute("cm-not-content","true"),o.gutterFiller=n("div",null,"CodeMirror-gutter-filler"),o.gutterFiller.setAttribute("cm-not-content","true"),o.lineDiv=i("div",null,"CodeMirror-code"),o.selectionDiv=n("div",null,null,"position: relative; z-index: 1"),o.cursorDiv=n("div",null,"CodeMirror-cursors"),o.measure=n("div",null,"CodeMirror-measure"),o.lineMeasure=n("div",null,"CodeMirror-measure"),o.lineSpace=i("div",[o.measure,o.lineMeasure,o.selectionDiv,o.cursorDiv,o.lineDiv],null,"position: relative; outline: none");var l=i("div",[o.lineSpace],"CodeMirror-lines");o.mover=n("div",[l],null,"position: relative"),o.sizer=n("div",[o.mover],"CodeMirror-sizer"),o.sizerWidth=null,o.heightForcer=n("div",null,null,"position: absolute; height: "+Rl+"px; width: 1px;"),o.gutters=n("div",null,"CodeMirror-gutters"),o.lineGutter=null,o.scroller=n("div",[o.sizer,o.heightForcer,o.gutters],"CodeMirror-scroll"),o.scroller.setAttribute("tabIndex","-1"),o.wrapper=n("div",[o.scrollbarFiller,o.gutterFiller,o.scroller],"CodeMirror"),gl&&vl<8&&(o.gutters.style.zIndex=-1,o.scroller.style.paddingRight=0),ml||fl&&Tl||(o.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(o.wrapper):e(o.wrapper)),o.viewFrom=o.viewTo=t.first,o.reportedViewFrom=o.reportedViewTo=t.first,o.view=[],o.renderedView=null,o.externalMeasured=null,o.viewOffset=0,o.lastWrapHeight=o.lastWrapWidth=0,o.updateLineNumbers=null,o.nativeBarWidth=o.barHeight=o.barWidth=0,o.scrollbarsClipped=!1,o.lineNumWidth=o.lineNumInnerWidth=o.lineNumChars=null,o.alignWidgets=!1,o.cachedCharWidth=o.cachedTextHeight=o.cachedPaddingH=null,o.maxLine=null,o.maxLineLength=0,o.maxLineChanged=!1,o.wheelDX=o.wheelDY=o.wheelStartX=o.wheelStartY=null,o.shift=!1,o.selForContextMenu=null,o.activeTouch=null,r.init(o)}function M(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var i=r.children[n],o=i.chunkSize();if(t<o){r=i;break}t-=o}return r.lines[t]}function N(e,t,r){var n=[],i=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;i==r.line&&(o=o.slice(0,r.ch)),i==t.line&&(o=o.slice(t.ch)),n.push(o),++i}),n}function O(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function A(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function W(e){if(null==e.parent)return null;for(var t=e.parent,r=h(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var i=0;n.children[i]!=t;++i)r+=n.children[i].chunkSize();return r+t.first}function D(e,t){var r=e.first;e:do{for(var n=0;n<e.children.length;++n){var i=e.children[n],o=i.height;if(t<o){e=i;continue e}t-=o,r+=i.chunkSize()}return r}while(!e.lines);for(var l=0;l<e.lines.length;++l){var s=e.lines[l].height;if(t<s)break;t-=s}return r+l}function H(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function E(e,t,r){if(void 0===r&&(r=null),!(this instanceof E))return new E(e,t,r);this.line=e,this.ch=t,this.sticky=r}function P(e,t){return e.line-t.line||e.ch-t.ch}function I(e,t){return e.sticky==t.sticky&&0==P(e,t)}function z(e){return E(e.line,e.ch)}function R(e,t){return P(e,t)<0?t:e}function B(e,t){return P(e,t)<0?e:t}function G(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function U(e,t){if(t.line<e.first)return E(e.first,0);var r=e.first+e.size-1;return t.line>r?E(r,M(e,r).text.length):V(t,M(e,t.line).text.length)}function V(e,t){var r=e.ch;return null==r||r>t?E(e.line,t):r<0?E(e.line,0):e}function K(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=U(e,t[n]);return r}function j(){Yl=!0}function X(){_l=!0}function Y(e,t,r){this.marker=e,this.from=t,this.to=r}function _(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function $(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}function q(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}function Z(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==l.type&&(!r||!o.marker.insertLeft)){var s=null==o.to||(l.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new Y(l,o.from,s?null:o.to))}}return n}function Q(e,t,r){var n;if(e)for(var i=0;i<e.length;++i){var o=e[i],l=o.marker;if(null==o.to||(l.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==l.type&&(!r||o.marker.insertLeft)){var s=null==o.from||(l.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new Y(l,s?null:o.from-t,null==o.to?null:o.to-t))}}return n}function J(e,t){if(t.full)return null;var r=H(e,t.from.line)&&M(e,t.from.line).markedSpans,n=H(e,t.to.line)&&M(e,t.to.line).markedSpans;if(!r&&!n)return null;var i=t.from.ch,o=t.to.ch,l=0==P(t.from,t.to),s=Z(r,i,l),a=Q(n,o,l),u=1==t.text.length,c=g(t.text).length+(u?i:0);if(s)for(var f=0;f<s.length;++f){var h=s[f];if(null==h.to){var d=_(a,h.marker);d?u&&(h.to=null==d.to?null:d.to+c):h.to=i}}if(a)for(var p=0;p<a.length;++p){var v=a[p];null!=v.to&&(v.to+=c),null==v.from?_(s,v.marker)||(v.from=c,u&&(s||(s=[])).push(v)):(v.from+=c,u&&(s||(s=[])).push(v))}s&&(s=ee(s)),a&&a!=s&&(a=ee(a));var m=[s];if(!u){var y,b=t.text.length-2;if(b>0&&s)for(var w=0;w<s.length;++w)null==s[w].to&&(y||(y=[])).push(new Y(s[w].marker,null,null));for(var x=0;x<b;++x)m.push(y);m.push(a)}return m}function ee(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function te(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=h(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var i=[{from:t,to:r}],o=0;o<n.length;++o)for(var l=n[o],s=l.find(0),a=0;a<i.length;++a){var u=i[a];if(!(P(u.to,s.from)<0||P(u.from,s.to)>0)){var c=[a,1],f=P(u.from,s.from),d=P(u.to,s.to);(f<0||!l.inclusiveLeft&&!f)&&c.push({from:u.from,to:s.from}),(d>0||!l.inclusiveRight&&!d)&&c.push({from:s.to,to:u.to}),i.splice.apply(i,c),a+=c.length-3}}return i}function re(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function ne(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function ie(e){return e.inclusiveLeft?-1:0}function oe(e){return e.inclusiveRight?1:0}function le(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),i=t.find(),o=P(n.from,i.from)||ie(e)-ie(t);if(o)return-o;var l=P(n.to,i.to)||oe(e)-oe(t);return l||t.id-e.id}function se(e,t){var r,n=_l&&e.markedSpans;if(n)for(var i=void 0,o=0;o<n.length;++o)(i=n[o]).marker.collapsed&&null==(t?i.from:i.to)&&(!r||le(r,i.marker)<0)&&(r=i.marker);return r}function ae(e){return se(e,!0)}function ue(e){return se(e,!1)}function ce(e,t,r,n,i){var o=M(e,t),l=_l&&o.markedSpans;if(l)for(var s=0;s<l.length;++s){var a=l[s];if(a.marker.collapsed){var u=a.marker.find(0),c=P(u.from,r)||ie(a.marker)-ie(i),f=P(u.to,n)||oe(a.marker)-oe(i);if(!(c>=0&&f<=0||c<=0&&f>=0)&&(c<=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.to,r)>=0:P(u.to,r)>0)||c>=0&&(a.marker.inclusiveRight&&i.inclusiveLeft?P(u.from,n)<=0:P(u.from,n)<0)))return!0}}}function fe(e){for(var t;t=ae(e);)e=t.find(-1,!0).line;return e}function he(e){for(var t;t=ue(e);)e=t.find(1,!0).line;return e}function de(e){for(var t,r;t=ue(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}function pe(e,t){var r=M(e,t),n=fe(r);return r==n?t:W(n)}function ge(e,t){if(t>e.lastLine())return t;var r,n=M(e,t);if(!ve(e,n))return t;for(;r=ue(n);)n=r.find(1,!0).line;return W(n)+1}function ve(e,t){var r=_l&&t.markedSpans;if(r)for(var n=void 0,i=0;i<r.length;++i)if((n=r[i]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&me(e,t,n))return!0}}function me(e,t,r){if(null==r.to){var n=r.marker.find(1,!0);return me(e,n.line,_(n.line.markedSpans,r.marker))}if(r.marker.inclusiveRight&&r.to==t.text.length)return!0;for(var i=void 0,o=0;o<t.markedSpans.length;++o)if((i=t.markedSpans[o]).marker.collapsed&&!i.marker.widgetNode&&i.from==r.to&&(null==i.to||i.to!=r.from)&&(i.marker.inclusiveLeft||r.marker.inclusiveRight)&&me(e,t,i))return!0}function ye(e){for(var t=0,r=(e=fe(e)).parent,n=0;n<r.lines.length;++n){var i=r.lines[n];if(i==e)break;t+=i.height}for(var o=r.parent;o;r=o,o=r.parent)for(var l=0;l<o.children.length;++l){var s=o.children[l];if(s==r)break;t+=s.height}return t}function be(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=ae(n);){var i=t.find(0,!0);n=i.from.line,r+=i.from.ch-i.to.ch}for(n=e;t=ue(n);){var o=t.find(0,!0);r-=n.text.length-o.from.ch,r+=(n=o.to.line).text.length-o.to.ch}return r}function we(e){var t=e.display,r=e.doc;t.maxLine=M(r,r.first),t.maxLineLength=be(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=be(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function xe(e,t,r,n){if(!e)return n(t,r,"ltr",0);for(var i=!1,o=0;o<e.length;++o){var l=e[o];(l.from<r&&l.to>t||t==r&&l.to==t)&&(n(Math.max(l.from,t),Math.min(l.to,r),1==l.level?"rtl":"ltr",o),i=!0)}i||n(t,r,"ltr")}function Ce(e,t,r){var n;$l=null;for(var i=0;i<e.length;++i){var o=e[i];if(o.from<t&&o.to>t)return i;o.to==t&&(o.from!=o.to&&"before"==r?n=i:$l=i),o.from==t&&(o.from!=o.to&&"before"!=r?n=i:$l=i)}return null!=n?n:$l}function Se(e,t){var r=e.order;return null==r&&(r=e.order=ql(e.text,t)),r}function Le(e,t){return e._handlers&&e._handlers[t]||Zl}function ke(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers,i=n&&n[t];if(i){var o=h(i,r);o>-1&&(n[t]=i.slice(0,o).concat(i.slice(o+1)))}}}function Te(e,t){var r=Le(e,t);if(r.length)for(var n=Array.prototype.slice.call(arguments,2),i=0;i<r.length;++i)r[i].apply(null,n)}function Me(e,t,r){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),Te(e,r||t.type,e,t),He(t)||t.codemirrorIgnore}function Ne(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var r=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),n=0;n<t.length;++n)-1==h(r,t[n])&&r.push(t[n])}function Oe(e,t){return Le(e,t).length>0}function Ae(e){e.prototype.on=function(e,t){Ql(this,e,t)},e.prototype.off=function(e,t){ke(this,e,t)}}function We(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function De(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function He(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Fe(e){We(e),De(e)}function Ee(e){return e.target||e.srcElement}function Pe(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Ml&&e.ctrlKey&&1==t&&(t=3),t}function Ie(e){if(null==Il){var t=n("span","​");r(e,n("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Il=t.offsetWidth<=1&&t.offsetHeight>2&&!(gl&&vl<8))}var i=Il?n("span","​"):n("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return i.setAttribute("cm-text",""),i}function ze(e){if(null!=zl)return zl;var n=r(e,document.createTextNode("AخA")),i=Wl(n,0,1).getBoundingClientRect(),o=Wl(n,1,2).getBoundingClientRect();return t(e),!(!i||i.left==i.right)&&(zl=o.right-i.right<3)}function Re(e){if(null!=ns)return ns;var t=r(e,n("span","x")),i=t.getBoundingClientRect(),o=Wl(t,0,1).getBoundingClientRect();return ns=Math.abs(i.left-o.left)>1}function Be(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),is[e]=t}function Ge(e){if("string"==typeof e&&os.hasOwnProperty(e))e=os[e];else if(e&&"string"==typeof e.name&&os.hasOwnProperty(e.name)){var t=os[e.name];"string"==typeof t&&(t={name:t}),(e=b(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Ge("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Ge("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function Ue(e,t){t=Ge(t);var r=is[t.name];if(!r)return Ue(e,"text/plain");var n=r(e,t);if(ls.hasOwnProperty(t.name)){var i=ls[t.name];for(var o in i)i.hasOwnProperty(o)&&(n.hasOwnProperty(o)&&(n["_"+o]=n[o]),n[o]=i[o])}if(n.name=t.name,t.helperType&&(n.helperType=t.helperType),t.modeProps)for(var l in t.modeProps)n[l]=t.modeProps[l];return n}function Ve(e,t){c(t,ls.hasOwnProperty(e)?ls[e]:ls[e]={})}function Ke(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var i=t[n];i instanceof Array&&(i=i.concat([])),r[n]=i}return r}function je(e,t){for(var r;e.innerMode&&(r=e.innerMode(t))&&r.mode!=e;)t=r.state,e=r.mode;return r||{mode:e,state:t}}function Xe(e,t,r){return!e.startState||e.startState(t,r)}function Ye(e,t,r,n){var i=[e.state.modeGen],o={};tt(e,t.text,e.doc.mode,r,function(e,t){return i.push(e,t)},o,n);for(var l=r.state,s=0;s<e.state.overlays.length;++s)!function(n){var l=e.state.overlays[n],s=1,a=0;r.state=!0,tt(e,t.text,l.mode,r,function(e,t){for(var r=s;a<e;){var n=i[s];n>e&&i.splice(s,1,e,i[s+1],n),s+=2,a=Math.min(e,n)}if(t)if(l.opaque)i.splice(r,s-r,e,"overlay "+t),s=r+2;else for(;r<s;r+=2){var o=i[r+1];i[r+1]=(o?o+" ":"")+"overlay "+t}},o)}(s);return r.state=l,{styles:i,classes:o.bgClass||o.textClass?o:null}}function _e(e,t,r){if(!t.styles||t.styles[0]!=e.state.modeGen){var n=$e(e,W(t)),i=t.text.length>e.options.maxHighlightLength&&Ke(e.doc.mode,n.state),o=Ye(e,t,n);i&&(n.state=i),t.stateAfter=n.save(!i),t.styles=o.styles,o.classes?t.styleClasses=o.classes:t.styleClasses&&(t.styleClasses=null),r===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function $e(e,t,r){var n=e.doc,i=e.display;if(!n.mode.startState)return new us(n,!0,t);var o=rt(e,t,r),l=o>n.first&&M(n,o-1).stateAfter,s=l?us.fromSaved(n,l,o):new us(n,Xe(n.mode),o);return n.iter(o,t,function(r){qe(e,r.text,s);var n=s.line;r.stateAfter=n==t-1||n%5==0||n>=i.viewFrom&&n<i.viewTo?s.save():null,s.nextLine()}),r&&(n.modeFrontier=s.line),s}function qe(e,t,r,n){var i=e.doc.mode,o=new ss(t,e.options.tabSize,r);for(o.start=o.pos=n||0,""==t&&Ze(i,r.state);!o.eol();)Qe(i,o,r.state),o.start=o.pos}function Ze(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var r=je(e,t);return r.mode.blankLine?r.mode.blankLine(r.state):void 0}}function Qe(e,t,r,n){for(var i=0;i<10;i++){n&&(n[0]=je(e,r).mode);var o=e.token(t,r);if(t.pos>t.start)return o}throw new Error("Mode "+e.name+" failed to advance stream.")}function Je(e,t,r,n){var i,o,l=e.doc,s=l.mode,a=M(l,(t=U(l,t)).line),u=$e(e,t.line,r),c=new ss(a.text,e.options.tabSize,u);for(n&&(o=[]);(n||c.pos<t.ch)&&!c.eol();)c.start=c.pos,i=Qe(s,c,u.state),n&&o.push(new cs(c,i,Ke(l.mode,u.state)));return n?o:new cs(c,i,u.state)}function et(e,t){if(e)for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}return e}function tt(e,t,r,n,i,o,l){var s=r.flattenSpans;null==s&&(s=e.options.flattenSpans);var a,u=0,c=null,f=new ss(t,e.options.tabSize,n),h=e.options.addModeClass&&[null];for(""==t&&et(Ze(r,n.state),o);!f.eol();){if(f.pos>e.options.maxHighlightLength?(s=!1,l&&qe(e,t,n,f.pos),f.pos=t.length,a=null):a=et(Qe(r,f,n.state,h),o),h){var d=h[0].name;d&&(a="m-"+(a?d+" "+a:d))}if(!s||c!=a){for(;u<f.start;)i(u=Math.min(f.start,u+5e3),c);c=a}f.start=f.pos}for(;u<f.pos;){var p=Math.min(f.pos,u+5e3);i(p,c),u=p}}function rt(e,t,r){for(var n,i,o=e.doc,l=r?-1:t-(e.doc.mode.innerMode?1e3:100),s=t;s>l;--s){if(s<=o.first)return o.first;var a=M(o,s-1),u=a.stateAfter;if(u&&(!r||s+(u instanceof as?u.lookAhead:0)<=o.modeFrontier))return s;var c=f(a.text,null,e.options.tabSize);(null==i||n>c)&&(i=s-1,n=c)}return i}function nt(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var r=e.first,n=t-1;n>r;n--){var i=M(e,n).stateAfter;if(i&&(!(i instanceof as)||n+i.lookAhead<t)){r=n+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,r)}}function it(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),re(e),ne(e,r);var i=n?n(e):1;i!=e.height&&A(e,i)}function ot(e){e.parent=null,re(e)}function lt(e,t){if(!e||/^\s*$/.test(e))return null;var r=t.addModeClass?ps:ds;return r[e]||(r[e]=e.replace(/\S+/g,"cm-$&"))}function st(e,t){var r=i("span",null,null,ml?"padding-right: .1px":null),n={pre:i("pre",[r],"CodeMirror-line"),content:r,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:(gl||ml)&&e.getOption("lineWrapping")};t.measure={};for(var o=0;o<=(t.rest?t.rest.length:0);o++){var l=o?t.rest[o-1]:t.line,s=void 0;n.pos=0,n.addToken=ut,ze(e.display.measure)&&(s=Se(l,e.doc.direction))&&(n.addToken=ft(n.addToken,s)),n.map=[],dt(l,n,_e(e,l,t!=e.display.externalMeasured&&W(l))),l.styleClasses&&(l.styleClasses.bgClass&&(n.bgClass=a(l.styleClasses.bgClass,n.bgClass||"")),l.styleClasses.textClass&&(n.textClass=a(l.styleClasses.textClass,n.textClass||""))),0==n.map.length&&n.map.push(0,0,n.content.appendChild(Ie(e.display.measure))),0==o?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(ml){var u=n.content.lastChild;(/\bcm-tab\b/.test(u.className)||u.querySelector&&u.querySelector(".cm-tab"))&&(n.content.className="cm-tab-wrap-hack")}return Te(e,"renderLine",e,t.line,n.pre),n.pre.className&&(n.textClass=a(n.pre.className,n.textClass||"")),n}function at(e){var t=n("span","•","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function ut(e,t,r,i,o,l,s){if(t){var a,u=e.splitSpaces?ct(t,e.trailingSpace):t,c=e.cm.state.specialChars,f=!1;if(c.test(t)){a=document.createDocumentFragment();for(var h=0;;){c.lastIndex=h;var d=c.exec(t),g=d?d.index-h:t.length-h;if(g){var v=document.createTextNode(u.slice(h,h+g));gl&&vl<9?a.appendChild(n("span",[v])):a.appendChild(v),e.map.push(e.pos,e.pos+g,v),e.col+=g,e.pos+=g}if(!d)break;h+=g+1;var m=void 0;if("\t"==d[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(m=a.appendChild(n("span",p(b),"cm-tab"))).setAttribute("role","presentation"),m.setAttribute("cm-text","\t"),e.col+=b}else"\r"==d[0]||"\n"==d[0]?((m=a.appendChild(n("span","\r"==d[0]?"␍":"␤","cm-invalidchar"))).setAttribute("cm-text",d[0]),e.col+=1):((m=e.cm.options.specialCharPlaceholder(d[0])).setAttribute("cm-text",d[0]),gl&&vl<9?a.appendChild(n("span",[m])):a.appendChild(m),e.col+=1);e.map.push(e.pos,e.pos+1,m),e.pos++}}else e.col+=t.length,a=document.createTextNode(u),e.map.push(e.pos,e.pos+t.length,a),gl&&vl<9&&(f=!0),e.pos+=t.length;if(e.trailingSpace=32==u.charCodeAt(t.length-1),r||i||o||f||s){var w=r||"";i&&(w+=i),o&&(w+=o);var x=n("span",[a],w,s);return l&&(x.title=l),e.content.appendChild(x)}e.content.appendChild(a)}}function ct(e,t){if(e.length>1&&!/  /.test(e))return e;for(var r=t,n="",i=0;i<e.length;i++){var o=e.charAt(i);" "!=o||!r||i!=e.length-1&&32!=e.charCodeAt(i+1)||(o=" "),n+=o,r=" "==o}return n}function ft(e,t){return function(r,n,i,o,l,s,a){i=i?i+" cm-force-border":"cm-force-border";for(var u=r.pos,c=u+n.length;;){for(var f=void 0,h=0;h<t.length&&!((f=t[h]).to>u&&f.from<=u);h++);if(f.to>=c)return e(r,n,i,o,l,s,a);e(r,n.slice(0,f.to-u),i,o,null,s,a),o=null,n=n.slice(f.to-u),u=f.to}}}function ht(e,t,r,n){var i=!n&&r.widgetNode;i&&e.map.push(e.pos,e.pos+t,i),!n&&e.cm.display.input.needsContentAttribute&&(i||(i=e.content.appendChild(document.createElement("span"))),i.setAttribute("cm-marker",r.id)),i&&(e.cm.display.input.setUneditable(i),e.content.appendChild(i)),e.pos+=t,e.trailingSpace=!1}function dt(e,t,r){var n=e.markedSpans,i=e.text,o=0;if(n)for(var l,s,a,u,c,f,h,d=i.length,p=0,g=1,v="",m=0;;){if(m==p){a=u=c=f=s="",h=null,m=1/0;for(var y=[],b=void 0,w=0;w<n.length;++w){var x=n[w],C=x.marker;"bookmark"==C.type&&x.from==p&&C.widgetNode?y.push(C):x.from<=p&&(null==x.to||x.to>p||C.collapsed&&x.to==p&&x.from==p)?(null!=x.to&&x.to!=p&&m>x.to&&(m=x.to,u=""),C.className&&(a+=" "+C.className),C.css&&(s=(s?s+";":"")+C.css),C.startStyle&&x.from==p&&(c+=" "+C.startStyle),C.endStyle&&x.to==m&&(b||(b=[])).push(C.endStyle,x.to),C.title&&!f&&(f=C.title),C.collapsed&&(!h||le(h.marker,C)<0)&&(h=x)):x.from>p&&m>x.from&&(m=x.from)}if(b)for(var S=0;S<b.length;S+=2)b[S+1]==m&&(u+=" "+b[S]);if(!h||h.from==p)for(var L=0;L<y.length;++L)ht(t,0,y[L]);if(h&&(h.from||0)==p){if(ht(t,(null==h.to?d+1:h.to)-p,h.marker,null==h.from),null==h.to)return;h.to==p&&(h=!1)}}if(p>=d)break;for(var k=Math.min(d,m);;){if(v){var T=p+v.length;if(!h){var M=T>k?v.slice(0,k-p):v;t.addToken(t,M,l?l+a:a,c,p+M.length==m?u:"",f,s)}if(T>=k){v=v.slice(k-p),p=k;break}p=T,c=""}v=i.slice(o,o=r[g++]),l=lt(r[g++],t.cm.options)}}else for(var N=1;N<r.length;N+=2)t.addToken(t,i.slice(o,o=r[N]),lt(r[N+1],t.cm.options))}function pt(e,t,r){this.line=t,this.rest=de(t),this.size=this.rest?W(g(this.rest))-r+1:1,this.node=this.text=null,this.hidden=ve(e,t)}function gt(e,t,r){for(var n,i=[],o=t;o<r;o=n){var l=new pt(e.doc,M(e.doc,o),o);n=o+l.size,i.push(l)}return i}function vt(e){gs?gs.ops.push(e):e.ownsGroup=gs={ops:[e],delayedCallbacks:[]}}function mt(e){var t=e.delayedCallbacks,r=0;do{for(;r<t.length;r++)t[r].call(null);for(var n=0;n<e.ops.length;n++){var i=e.ops[n];if(i.cursorActivityHandlers)for(;i.cursorActivityCalled<i.cursorActivityHandlers.length;)i.cursorActivityHandlers[i.cursorActivityCalled++].call(null,i.cm)}}while(r<t.length)}function yt(e,t){var r=e.ownsGroup;if(r)try{mt(r)}finally{gs=null,t(r)}}function bt(e,t){var r=Le(e,t);if(r.length){var n,i=Array.prototype.slice.call(arguments,2);gs?n=gs.delayedCallbacks:vs?n=vs:(n=vs=[],setTimeout(wt,0));for(var o=0;o<r.length;++o)!function(e){n.push(function(){return r[e].apply(null,i)})}(o)}}function wt(){var e=vs;vs=null;for(var t=0;t<e.length;++t)e[t]()}function xt(e,t,r,n){for(var i=0;i<t.changes.length;i++){var o=t.changes[i];"text"==o?kt(e,t):"gutter"==o?Mt(e,t,r,n):"class"==o?Tt(e,t):"widget"==o&&Nt(e,t,n)}t.changes=null}function Ct(e){return e.node==e.text&&(e.node=n("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),gl&&vl<8&&(e.node.style.zIndex=2)),e.node}function St(e,t){var r=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(r&&(r+=" CodeMirror-linebackground"),t.background)r?t.background.className=r:(t.background.parentNode.removeChild(t.background),t.background=null);else if(r){var i=Ct(t);t.background=i.insertBefore(n("div",null,r),i.firstChild),e.display.input.setUneditable(t.background)}}function Lt(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):st(e,t)}function kt(e,t){var r=t.text.className,n=Lt(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,Tt(e,t)):r&&(t.text.className=r)}function Tt(e,t){St(e,t),t.line.wrapClass?Ct(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var r=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=r||""}function Mt(e,t,r,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var o=Ct(t);t.gutterBackground=n("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),o.insertBefore(t.gutterBackground,t.text)}var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var s=Ct(t),a=t.gutter=n("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(e.display.input.setUneditable(a),s.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=a.appendChild(n("div",F(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var u=0;u<e.options.gutters.length;++u){var c=e.options.gutters[u],f=l.hasOwnProperty(c)&&l[c];f&&a.appendChild(n("div",[f],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Nt(e,t,r){t.alignable&&(t.alignable=null);for(var n=t.node.firstChild,i=void 0;n;n=i)i=n.nextSibling,"CodeMirror-linewidget"==n.className&&t.node.removeChild(n);At(e,t,r)}function Ot(e,t,r,n){var i=Lt(e,t);return t.text=t.node=i.pre,i.bgClass&&(t.bgClass=i.bgClass),i.textClass&&(t.textClass=i.textClass),Tt(e,t),Mt(e,t,r,n),At(e,t,n),t.node}function At(e,t,r){if(Wt(e,t.line,t,r,!0),t.rest)for(var n=0;n<t.rest.length;n++)Wt(e,t.rest[n],t,r,!1)}function Wt(e,t,r,i,o){if(t.widgets)for(var l=Ct(r),s=0,a=t.widgets;s<a.length;++s){var u=a[s],c=n("div",[u.node],"CodeMirror-linewidget");u.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Dt(u,c,r,i),e.display.input.setUneditable(c),o&&u.above?l.insertBefore(c,r.gutter||r.text):l.appendChild(c),bt(u,"redraw")}}function Dt(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var i=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(i-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=i+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}function Ht(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!o(document.body,e.node)){var i="position: relative;";e.coverGutter&&(i+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(i+="width: "+t.display.wrapper.clientWidth+"px;"),r(t.display.measure,n("div",[e.node],null,i))}return e.height=e.node.parentNode.offsetHeight}function Ft(e,t){for(var r=Ee(t);r!=e.wrapper;r=r.parentNode)if(!r||1==r.nodeType&&"true"==r.getAttribute("cm-ignore-events")||r.parentNode==e.sizer&&r!=e.mover)return!0}function Et(e){return e.lineSpace.offsetTop}function Pt(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function It(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=r(e.measure,n("pre","x")),i=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,o={left:parseInt(i.paddingLeft),right:parseInt(i.paddingRight)};return isNaN(o.left)||isNaN(o.right)||(e.cachedPaddingH=o),o}function zt(e){return Rl-e.display.nativeBarWidth}function Rt(e){return e.display.scroller.clientWidth-zt(e)-e.display.barWidth}function Bt(e){return e.display.scroller.clientHeight-zt(e)-e.display.barHeight}function Gt(e,t,r){var n=e.options.lineWrapping,i=n&&Rt(e);if(!t.measure.heights||n&&t.measure.width!=i){var o=t.measure.heights=[];if(n){t.measure.width=i;for(var l=t.text.firstChild.getClientRects(),s=0;s<l.length-1;s++){var a=l[s],u=l[s+1];Math.abs(a.bottom-u.bottom)>2&&o.push((a.bottom+u.top)/2-r.top)}}o.push(r.bottom-r.top)}}function Ut(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(var n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var i=0;i<e.rest.length;i++)if(W(e.rest[i])>r)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}function Vt(e,t){var n=W(t=fe(t)),i=e.display.externalMeasured=new pt(e.doc,t,n);i.lineN=n;var o=i.built=st(e,i);return i.text=o.pre,r(e.display.lineMeasure,o.pre),i}function Kt(e,t,r,n){return Yt(e,Xt(e,t),r,n)}function jt(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Lr(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function Xt(e,t){var r=W(t),n=jt(e,r);n&&!n.text?n=null:n&&n.changes&&(xt(e,n,r,br(e)),e.curOp.forceUpdate=!0),n||(n=Vt(e,t));var i=Ut(n,t,r);return{line:t,view:n,rect:null,map:i.map,cache:i.cache,before:i.before,hasHeights:!1}}function Yt(e,t,r,n,i){t.before&&(r=-1);var o,l=r+(n||"");return t.cache.hasOwnProperty(l)?o=t.cache[l]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(Gt(e,t.view,t.rect),t.hasHeights=!0),(o=qt(e,t,r,n)).bogus||(t.cache[l]=o)),{left:o.left,right:o.right,top:i?o.rtop:o.top,bottom:i?o.rbottom:o.bottom}}function _t(e,t,r){for(var n,i,o,l,s,a,u=0;u<e.length;u+=3)if(s=e[u],a=e[u+1],t<s?(i=0,o=1,l="left"):t<a?o=(i=t-s)+1:(u==e.length-3||t==a&&e[u+3]>t)&&(i=(o=a-s)-1,t>=a&&(l="right")),null!=i){if(n=e[u+2],s==a&&r==(n.insertLeft?"left":"right")&&(l=r),"left"==r&&0==i)for(;u&&e[u-2]==e[u-3]&&e[u-1].insertLeft;)n=e[2+(u-=3)],l="left";if("right"==r&&i==a-s)for(;u<e.length-3&&e[u+3]==e[u+4]&&!e[u+5].insertLeft;)n=e[(u+=3)+2],l="right";break}return{node:n,start:i,end:o,collapse:l,coverStart:s,coverEnd:a}}function $t(e,t){var r=ms;if("left"==t)for(var n=0;n<e.length&&(r=e[n]).left==r.right;n++);else for(var i=e.length-1;i>=0&&(r=e[i]).left==r.right;i--);return r}function qt(e,t,r,n){var i,o=_t(t.map,r,n),l=o.node,s=o.start,a=o.end,u=o.collapse;if(3==l.nodeType){for(var c=0;c<4;c++){for(;s&&S(t.line.text.charAt(o.coverStart+s));)--s;for(;o.coverStart+a<o.coverEnd&&S(t.line.text.charAt(o.coverStart+a));)++a;if((i=gl&&vl<9&&0==s&&a==o.coverEnd-o.coverStart?l.parentNode.getBoundingClientRect():$t(Wl(l,s,a).getClientRects(),n)).left||i.right||0==s)break;a=s,s-=1,u="right"}gl&&vl<11&&(i=Zt(e.display.measure,i))}else{s>0&&(u=n="right");var f;i=e.options.lineWrapping&&(f=l.getClientRects()).length>1?f["right"==n?f.length-1:0]:l.getBoundingClientRect()}if(gl&&vl<9&&!s&&(!i||!i.left&&!i.right)){var h=l.parentNode.getClientRects()[0];i=h?{left:h.left,right:h.left+yr(e.display),top:h.top,bottom:h.bottom}:ms}for(var d=i.top-t.rect.top,p=i.bottom-t.rect.top,g=(d+p)/2,v=t.view.measure.heights,m=0;m<v.length-1&&!(g<v[m]);m++);var y=m?v[m-1]:0,b=v[m],w={left:("right"==u?i.right:i.left)-t.rect.left,right:("left"==u?i.left:i.right)-t.rect.left,top:y,bottom:b};return i.left||i.right||(w.bogus=!0),e.options.singleCursorHeightPerLine||(w.rtop=d,w.rbottom=p),w}function Zt(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Re(e))return t;var r=screen.logicalXDPI/screen.deviceXDPI,n=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*r,right:t.right*r,top:t.top*n,bottom:t.bottom*n}}function Qt(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function Jt(e){e.display.externalMeasure=null,t(e.display.lineMeasure);for(var r=0;r<e.display.view.length;r++)Qt(e.display.view[r])}function er(e){Jt(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function tr(){return bl&&kl?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function rr(){return bl&&kl?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function nr(e){var t=0;if(e.widgets)for(var r=0;r<e.widgets.length;++r)e.widgets[r].above&&(t+=Ht(e.widgets[r]));return t}function ir(e,t,r,n,i){if(!i){var o=nr(t);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var l=ye(t);if("local"==n?l+=Et(e.display):l-=e.display.viewOffset,"page"==n||"window"==n){var s=e.display.lineSpace.getBoundingClientRect();l+=s.top+("window"==n?0:rr());var a=s.left+("window"==n?0:tr());r.left+=a,r.right+=a}return r.top+=l,r.bottom+=l,r}function or(e,t,r){if("div"==r)return t;var n=t.left,i=t.top;if("page"==r)n-=tr(),i-=rr();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,i+=o.top}var l=e.display.lineSpace.getBoundingClientRect();return{left:n-l.left,top:i-l.top}}function lr(e,t,r,n,i){return n||(n=M(e.doc,t.line)),ir(e,n,Kt(e,n,t.ch,i),r)}function sr(e,t,r,n,i,o){function l(t,l){var s=Yt(e,i,t,l?"right":"left",o);return l?s.left=s.right:s.right=s.left,ir(e,n,s,r)}function s(e,t,r){var n=1==a[t].level;return l(r?e-1:e,n!=r)}n=n||M(e.doc,t.line),i||(i=Xt(e,n));var a=Se(n,e.doc.direction),u=t.ch,c=t.sticky;if(u>=n.text.length?(u=n.text.length,c="before"):u<=0&&(u=0,c="after"),!a)return l("before"==c?u-1:u,"before"==c);var f=Ce(a,u,c),h=$l,d=s(u,f,"before"==c);return null!=h&&(d.other=s(u,h,"before"!=c)),d}function ar(e,t){var r=0;t=U(e.doc,t),e.options.lineWrapping||(r=yr(e.display)*t.ch);var n=M(e.doc,t.line),i=ye(n)+Et(e.display);return{left:r,right:r,top:i,bottom:i+n.height}}function ur(e,t,r,n,i){var o=E(e,t,r);return o.xRel=i,n&&(o.outside=!0),o}function cr(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return ur(n.first,0,null,!0,-1);var i=D(n,r),o=n.first+n.size-1;if(i>o)return ur(n.first+n.size-1,M(n,o).text.length,null,!0,1);t<0&&(t=0);for(var l=M(n,i);;){var s=pr(e,l,i,t,r),a=ue(l),u=a&&a.find(0,!0);if(!a||!(s.ch>u.from.ch||s.ch==u.from.ch&&s.xRel>0))return s;i=W(l=u.to.line)}}function fr(e,t,r,n){n-=nr(t);var i=t.text.length,o=k(function(t){return Yt(e,r,t-1).bottom<=n},i,0);return i=k(function(t){return Yt(e,r,t).top>n},o,i),{begin:o,end:i}}function hr(e,t,r,n){return r||(r=Xt(e,t)),fr(e,t,r,ir(e,t,Yt(e,r,n),"line").top)}function dr(e,t,r,n){return!(e.bottom<=r)&&(e.top>r||(n?e.left:e.right)>t)}function pr(e,t,r,n,i){i-=ye(t);var o=Xt(e,t),l=nr(t),s=0,a=t.text.length,u=!0,c=Se(t,e.doc.direction);if(c){var f=(e.options.lineWrapping?vr:gr)(e,t,r,o,c,n,i);s=(u=1!=f.level)?f.from:f.to-1,a=u?f.to:f.from-1}var h,d,p=null,g=null,v=k(function(t){var r=Yt(e,o,t);return r.top+=l,r.bottom+=l,!!dr(r,n,i,!1)&&(r.top<=i&&r.left<=n&&(p=t,g=r),!0)},s,a),m=!1;if(g){var y=n-g.left<g.right-n,b=y==u;v=p+(b?0:1),d=b?"after":"before",h=y?g.left:g.right}else{u||v!=a&&v!=s||v++,d=0==v?"after":v==t.text.length?"before":Yt(e,o,v-(u?1:0)).bottom+l<=i==u?"after":"before";var w=sr(e,E(r,v,d),"line",t,o);h=w.left,m=i<w.top||i>=w.bottom}return v=L(t.text,v,1),ur(r,v,d,m,n-h)}function gr(e,t,r,n,i,o,l){var s=k(function(s){var a=i[s],u=1!=a.level;return dr(sr(e,E(r,u?a.to:a.from,u?"before":"after"),"line",t,n),o,l,!0)},0,i.length-1),a=i[s];if(s>0){var u=1!=a.level,c=sr(e,E(r,u?a.from:a.to,u?"after":"before"),"line",t,n);dr(c,o,l,!0)&&c.top>l&&(a=i[s-1])}return a}function vr(e,t,r,n,i,o,l){for(var s=fr(e,t,n,l),a=s.begin,u=s.end,c=null,f=null,h=0;h<i.length;h++){var d=i[h];if(!(d.from>=u||d.to<=a)){var p=Yt(e,n,1!=d.level?Math.min(u,d.to)-1:Math.max(a,d.from)).right,g=p<o?o-p+1e9:p-o;(!c||f>g)&&(c=d,f=g)}}return c||(c=i[i.length-1]),c.from<a&&(c={from:a,to:c.to,level:c.level}),c.to>u&&(c={from:c.from,to:u,level:c.level}),c}function mr(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==hs){hs=n("pre");for(var i=0;i<49;++i)hs.appendChild(document.createTextNode("x")),hs.appendChild(n("br"));hs.appendChild(document.createTextNode("x"))}r(e.measure,hs);var o=hs.offsetHeight/50;return o>3&&(e.cachedTextHeight=o),t(e.measure),o||1}function yr(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=n("span","xxxxxxxxxx"),i=n("pre",[t]);r(e.measure,i);var o=t.getBoundingClientRect(),l=(o.right-o.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function br(e){for(var t=e.display,r={},n={},i=t.gutters.clientLeft,o=t.gutters.firstChild,l=0;o;o=o.nextSibling,++l)r[e.options.gutters[l]]=o.offsetLeft+o.clientLeft+i,n[e.options.gutters[l]]=o.clientWidth;return{fixedPos:wr(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function wr(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function xr(e){var t=mr(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/yr(e.display)-3);return function(i){if(ve(e.doc,i))return 0;var o=0;if(i.widgets)for(var l=0;l<i.widgets.length;l++)i.widgets[l].height&&(o+=i.widgets[l].height);return r?o+(Math.ceil(i.text.length/n)||1)*t:o+t}}function Cr(e){var t=e.doc,r=xr(e);t.iter(function(e){var t=r(e);t!=e.height&&A(e,t)})}function Sr(e,t,r,n){var i=e.display;if(!r&&"true"==Ee(t).getAttribute("cm-not-content"))return null;var o,l,s=i.lineSpace.getBoundingClientRect();try{o=t.clientX-s.left,l=t.clientY-s.top}catch(t){return null}var a,u=cr(e,o,l);if(n&&1==u.xRel&&(a=M(e.doc,u.line).text).length==u.ch){var c=f(a,a.length,e.options.tabSize)-a.length;u=E(u.line,Math.max(0,Math.round((o-It(e.display).left)/yr(e.display))-c))}return u}function Lr(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function kr(e){e.display.input.showSelection(e.display.input.prepareSelection())}function Tr(e,t){void 0===t&&(t=!0);for(var r=e.doc,n={},i=n.cursors=document.createDocumentFragment(),o=n.selection=document.createDocumentFragment(),l=0;l<r.sel.ranges.length;l++)if(t||l!=r.sel.primIndex){var s=r.sel.ranges[l];if(!(s.from().line>=e.display.viewTo||s.to().line<e.display.viewFrom)){var a=s.empty();(a||e.options.showCursorWhenSelecting)&&Mr(e,s.head,i),a||Or(e,s,o)}}return n}function Mr(e,t,r){var i=sr(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),o=r.appendChild(n("div"," ","CodeMirror-cursor"));if(o.style.left=i.left+"px",o.style.top=i.top+"px",o.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",i.other){var l=r.appendChild(n("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));l.style.display="",l.style.left=i.other.left+"px",l.style.top=i.other.top+"px",l.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Nr(e,t){return e.top-t.top||e.left-t.left}function Or(e,t,r){function i(e,t,r,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),a.appendChild(n("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(null==r?f-e:r)+"px;\n                             height: "+(i-t)+"px"))}function o(t,r,n){function o(r,n){return lr(e,E(t,r),"div",u,n)}var l,a,u=M(s,t),h=u.text.length,d=Se(u,s.direction);return xe(d,r||0,null==n?h:n,function(t,s,p,g){var v=o(t,"ltr"==p?"left":"right"),m=o(s-1,"ltr"==p?"right":"left");if("ltr"==p){var y=null==r&&0==t?c:v.left,b=null==n&&s==h?f:m.right;m.top-v.top<=3?i(y,m.top,b-y,m.bottom):(i(y,v.top,null,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top),i(c,m.top,m.right,m.bottom))}else if(t<s){var w=null==r&&0==t?f:v.right,x=null==n&&s==h?c:m.left;if(m.top-v.top<=3)i(x,m.top,w-x,m.bottom);else{var C=c;if(g){var S=hr(e,u,null,t).end;C=o(S-(/\s/.test(u.text.charAt(S-1))?2:1),"left").left}i(C,v.top,w-C,v.bottom),v.bottom<m.top&&i(c,v.bottom,null,m.top);var L=null;d.length,L=o(hr(e,u,null,s).begin,"right").right-x,i(x,m.top,L,m.bottom)}}(!l||Nr(v,l)<0)&&(l=v),Nr(m,l)<0&&(l=m),(!a||Nr(v,a)<0)&&(a=v),Nr(m,a)<0&&(a=m)}),{start:l,end:a}}var l=e.display,s=e.doc,a=document.createDocumentFragment(),u=It(e.display),c=u.left,f=Math.max(l.sizerWidth,Rt(e)-l.sizer.offsetLeft)-u.right,h=t.from(),d=t.to();if(h.line==d.line)o(h.line,h.ch,d.ch);else{var p=M(s,h.line),g=M(s,d.line),v=fe(p)==fe(g),m=o(h.line,h.ch,v?p.text.length+1:null).end,y=o(d.line,v?0:null,d.ch).start;v&&(m.top<y.top-2?(i(m.right,m.top,null,m.bottom),i(c,y.top,y.left,y.bottom)):i(m.right,m.top,y.left-m.right,m.bottom)),m.bottom<y.top&&i(c,m.bottom,null,y.top)}r.appendChild(a)}function Ar(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval(function(){return t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Wr(e){e.state.focused||(e.display.input.focus(),Hr(e))}function Dr(e){e.state.delayingBlurEvent=!0,setTimeout(function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,Fr(e))},100)}function Hr(e,t){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(Te(e,"focus",e,t),e.state.focused=!0,s(e.display.wrapper,"CodeMirror-focused"),e.curOp||e.display.selForContextMenu==e.doc.sel||(e.display.input.reset(),ml&&setTimeout(function(){return e.display.input.reset(!0)},20)),e.display.input.receivedFocus()),Ar(e))}function Fr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(Te(e,"blur",e,t),e.state.focused=!1,Fl(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150))}function Er(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var i=t.view[n],o=void 0;if(!i.hidden){if(gl&&vl<8){var l=i.node.offsetTop+i.node.offsetHeight;o=l-r,r=l}else{var s=i.node.getBoundingClientRect();o=s.bottom-s.top}var a=i.line.height-o;if(o<2&&(o=mr(t)),(a>.005||a<-.005)&&(A(i.line,o),Pr(i.line),i.rest))for(var u=0;u<i.rest.length;u++)Pr(i.rest[u])}}}function Pr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.parentNode.offsetHeight}function Ir(e,t,r){var n=r&&null!=r.top?Math.max(0,r.top):e.scroller.scrollTop;n=Math.floor(n-Et(e));var i=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=D(t,n),l=D(t,i);if(r&&r.ensure){var s=r.ensure.from.line,a=r.ensure.to.line;s<o?(o=s,l=D(t,ye(M(t,s))+e.wrapper.clientHeight)):Math.min(a,t.lastLine())>=l&&(o=D(t,ye(M(t,a))-e.wrapper.clientHeight),l=a)}return{from:o,to:Math.max(l,o+1)}}function zr(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=wr(t)-t.scroller.scrollLeft+e.doc.scrollLeft,i=t.gutters.offsetWidth,o=n+"px",l=0;l<r.length;l++)if(!r[l].hidden){e.options.fixedGutter&&(r[l].gutter&&(r[l].gutter.style.left=o),r[l].gutterBackground&&(r[l].gutterBackground.style.left=o));var s=r[l].alignable;if(s)for(var a=0;a<s.length;a++)s[a].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+i+"px")}}function Rr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=F(e.options,t.first+t.size-1),i=e.display;if(r.length!=i.lineNumChars){var o=i.measure.appendChild(n("div",[n("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),l=o.firstChild.offsetWidth,s=o.offsetWidth-l;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(l,i.lineGutter.offsetWidth-s)+1,i.lineNumWidth=i.lineNumInnerWidth+s,i.lineNumChars=i.lineNumInnerWidth?r.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Wn(e),!0}return!1}function Br(e,t){if(!Me(e,"scrollCursorIntoView")){var r=e.display,i=r.sizer.getBoundingClientRect(),o=null;if(t.top+i.top<0?o=!0:t.bottom+i.top>(window.innerHeight||document.documentElement.clientHeight)&&(o=!1),null!=o&&!Sl){var l=n("div","​",null,"position: absolute;\n                         top: "+(t.top-r.viewOffset-Et(e.display))+"px;\n                         height: "+(t.bottom-t.top+zt(e)+r.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(l),l.scrollIntoView(o),e.display.lineSpace.removeChild(l)}}}function Gr(e,t,r,n){null==n&&(n=0);var i;e.options.lineWrapping||t!=r||(r="before"==(t=t.ch?E(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t).sticky?E(t.line,t.ch+1,"before"):t);for(var o=0;o<5;o++){var l=!1,s=sr(e,t),a=r&&r!=t?sr(e,r):s,u=Vr(e,i={left:Math.min(s.left,a.left),top:Math.min(s.top,a.top)-n,right:Math.max(s.left,a.left),bottom:Math.max(s.bottom,a.bottom)+n}),c=e.doc.scrollTop,f=e.doc.scrollLeft;if(null!=u.scrollTop&&(qr(e,u.scrollTop),Math.abs(e.doc.scrollTop-c)>1&&(l=!0)),null!=u.scrollLeft&&(Qr(e,u.scrollLeft),Math.abs(e.doc.scrollLeft-f)>1&&(l=!0)),!l)break}return i}function Ur(e,t){var r=Vr(e,t);null!=r.scrollTop&&qr(e,r.scrollTop),null!=r.scrollLeft&&Qr(e,r.scrollLeft)}function Vr(e,t){var r=e.display,n=mr(e.display);t.top<0&&(t.top=0);var i=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:r.scroller.scrollTop,o=Bt(e),l={};t.bottom-t.top>o&&(t.bottom=t.top+o);var s=e.doc.height+Pt(r),a=t.top<n,u=t.bottom>s-n;if(t.top<i)l.scrollTop=a?0:t.top;else if(t.bottom>i+o){var c=Math.min(t.top,(u?s:t.bottom)-o);c!=i&&(l.scrollTop=c)}var f=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:r.scroller.scrollLeft,h=Rt(e)-(e.options.fixedGutter?r.gutters.offsetWidth:0),d=t.right-t.left>h;return d&&(t.right=t.left+h),t.left<10?l.scrollLeft=0:t.left<f?l.scrollLeft=Math.max(0,t.left-(d?0:10)):t.right>h+f-3&&(l.scrollLeft=t.right+(d?0:10)-h),l}function Kr(e,t){null!=t&&(_r(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function jr(e){_r(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function Xr(e,t,r){null==t&&null==r||_r(e),null!=t&&(e.curOp.scrollLeft=t),null!=r&&(e.curOp.scrollTop=r)}function Yr(e,t){_r(e),e.curOp.scrollToPos=t}function _r(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,$r(e,ar(e,t.from),ar(e,t.to),t.margin))}function $r(e,t,r,n){var i=Vr(e,{left:Math.min(t.left,r.left),top:Math.min(t.top,r.top)-n,right:Math.max(t.right,r.right),bottom:Math.max(t.bottom,r.bottom)+n});Xr(e,i.scrollLeft,i.scrollTop)}function qr(e,t){Math.abs(e.doc.scrollTop-t)<2||(fl||On(e,{top:t}),Zr(e,t,!0),fl&&On(e),Cn(e,100))}function Zr(e,t,r){t=Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t),(e.display.scroller.scrollTop!=t||r)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function Qr(e,t,r,n){t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)&&!n||(e.doc.scrollLeft=t,zr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function Jr(e){var t=e.display,r=t.gutters.offsetWidth,n=Math.round(e.doc.height+Pt(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?r:0,docHeight:n,scrollHeight:n+zt(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:r}}function en(e,t){t||(t=Jr(e));var r=e.display.barWidth,n=e.display.barHeight;tn(e,t);for(var i=0;i<4&&r!=e.display.barWidth||n!=e.display.barHeight;i++)r!=e.display.barWidth&&e.options.lineWrapping&&Er(e),tn(e,Jr(e)),r=e.display.barWidth,n=e.display.barHeight}function tn(e,t){var r=e.display,n=r.scrollbars.update(t);r.sizer.style.paddingRight=(r.barWidth=n.right)+"px",r.sizer.style.paddingBottom=(r.barHeight=n.bottom)+"px",r.heightForcer.style.borderBottom=n.bottom+"px solid transparent",n.right&&n.bottom?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=n.bottom+"px",r.scrollbarFiller.style.width=n.right+"px"):r.scrollbarFiller.style.display="",n.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=n.bottom+"px",r.gutterFiller.style.width=t.gutterWidth+"px"):r.gutterFiller.style.display=""}function rn(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&Fl(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new ws[e.options.scrollbarStyle](function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),Ql(t,"mousedown",function(){e.state.focused&&setTimeout(function(){return e.display.input.focus()},0)}),t.setAttribute("cm-not-content","true")},function(t,r){"horizontal"==r?Qr(e,t):qr(e,t)},e),e.display.scrollbars.addClass&&s(e.display.wrapper,e.display.scrollbars.addClass)}function nn(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++xs},vt(e.curOp)}function on(e){yt(e.curOp,function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;ln(e)})}function ln(e){for(var t=e.ops,r=0;r<t.length;r++)sn(t[r]);for(var n=0;n<t.length;n++)an(t[n]);for(var i=0;i<t.length;i++)un(t[i]);for(var o=0;o<t.length;o++)cn(t[o]);for(var l=0;l<t.length;l++)fn(t[l])}function sn(e){var t=e.cm,r=t.display;Ln(t),e.updateMaxLine&&we(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<r.viewFrom||e.scrollToPos.to.line>=r.viewTo)||r.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Cs(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function an(e){e.updatedDisplay=e.mustUpdate&&Mn(e.cm,e.update)}function un(e){var t=e.cm,r=t.display;e.updatedDisplay&&Er(t),e.barMeasure=Jr(t),r.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=Kt(t,r.maxLine,r.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(r.scroller.clientWidth,r.sizer.offsetLeft+e.adjustWidthTo+zt(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,r.sizer.offsetLeft+e.adjustWidthTo-Rt(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=r.input.prepareSelection())}function cn(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&Qr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var r=e.focus&&e.focus==l();e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,r),(e.updatedDisplay||e.startHeight!=t.doc.height)&&en(t,e.barMeasure),e.updatedDisplay&&Dn(t,e.barMeasure),e.selectionChanged&&Ar(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),r&&Wr(e.cm)}function fn(e){var t=e.cm,r=t.display,n=t.doc;e.updatedDisplay&&Nn(t,e.update),null==r.wheelStartX||null==e.scrollTop&&null==e.scrollLeft&&!e.scrollToPos||(r.wheelStartX=r.wheelStartY=null),null!=e.scrollTop&&Zr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&Qr(t,e.scrollLeft,!0,!0),e.scrollToPos&&Br(t,Gr(t,U(n,e.scrollToPos.from),U(n,e.scrollToPos.to),e.scrollToPos.margin));var i=e.maybeHiddenMarkers,o=e.maybeUnhiddenMarkers;if(i)for(var l=0;l<i.length;++l)i[l].lines.length||Te(i[l],"hide");if(o)for(var s=0;s<o.length;++s)o[s].lines.length&&Te(o[s],"unhide");r.wrapper.offsetHeight&&(n.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&Te(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function hn(e,t){if(e.curOp)return t();nn(e);try{return t()}finally{on(e)}}function dn(e,t){return function(){if(e.curOp)return t.apply(e,arguments);nn(e);try{return t.apply(e,arguments)}finally{on(e)}}}function pn(e){return function(){if(this.curOp)return e.apply(this,arguments);nn(this);try{return e.apply(this,arguments)}finally{on(this)}}}function gn(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);nn(t);try{return e.apply(this,arguments)}finally{on(t)}}}function vn(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var i=e.display;if(n&&r<i.viewTo&&(null==i.updateLineNumbers||i.updateLineNumbers>t)&&(i.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=i.viewTo)_l&&pe(e.doc,t)<i.viewTo&&yn(e);else if(r<=i.viewFrom)_l&&ge(e.doc,r+n)>i.viewFrom?yn(e):(i.viewFrom+=n,i.viewTo+=n);else if(t<=i.viewFrom&&r>=i.viewTo)yn(e);else if(t<=i.viewFrom){var o=bn(e,r,r+n,1);o?(i.view=i.view.slice(o.index),i.viewFrom=o.lineN,i.viewTo+=n):yn(e)}else if(r>=i.viewTo){var l=bn(e,t,t,-1);l?(i.view=i.view.slice(0,l.index),i.viewTo=l.lineN):yn(e)}else{var s=bn(e,t,t,-1),a=bn(e,r,r+n,1);s&&a?(i.view=i.view.slice(0,s.index).concat(gt(e,s.lineN,a.lineN)).concat(i.view.slice(a.index)),i.viewTo+=n):yn(e)}var u=i.externalMeasured;u&&(r<u.lineN?u.lineN+=n:t<u.lineN+u.size&&(i.externalMeasured=null))}function mn(e,t,r){e.curOp.viewChanged=!0;var n=e.display,i=e.display.externalMeasured;if(i&&t>=i.lineN&&t<i.lineN+i.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Lr(e,t)];if(null!=o.node){var l=o.changes||(o.changes=[]);-1==h(l,r)&&l.push(r)}}}function yn(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function bn(e,t,r,n){var i,o=Lr(e,t),l=e.display.view;if(!_l||r==e.doc.first+e.doc.size)return{index:o,lineN:r};for(var s=e.display.viewFrom,a=0;a<o;a++)s+=l[a].size;if(s!=t){if(n>0){if(o==l.length-1)return null;i=s+l[o].size-t,o++}else i=s-t;t+=i,r+=i}for(;pe(e.doc,r)!=r;){if(o==(n<0?0:l.length-1))return null;r+=n*l[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function wn(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=gt(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=gt(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Lr(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(gt(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Lr(e,r)))),n.viewTo=r}function xn(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var i=t[n];i.hidden||i.node&&!i.changes||++r}return r}function Cn(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,u(Sn,e))}function Sn(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=$e(e,t.highlightFrontier),i=[];t.iter(n.line,Math.min(t.first+t.size,e.display.viewTo+500),function(o){if(n.line>=e.display.viewFrom){var l=o.styles,s=o.text.length>e.options.maxHighlightLength?Ke(t.mode,n.state):null,a=Ye(e,o,n,!0);s&&(n.state=s),o.styles=a.styles;var u=o.styleClasses,c=a.classes;c?o.styleClasses=c:u&&(o.styleClasses=null);for(var f=!l||l.length!=o.styles.length||u!=c&&(!u||!c||u.bgClass!=c.bgClass||u.textClass!=c.textClass),h=0;!f&&h<l.length;++h)f=l[h]!=o.styles[h];f&&i.push(n.line),o.stateAfter=n.save(),n.nextLine()}else o.text.length<=e.options.maxHighlightLength&&qe(e,o.text,n),o.stateAfter=n.line%5==0?n.save():null,n.nextLine();if(+new Date>r)return Cn(e,e.options.workDelay),!0}),t.highlightFrontier=n.line,t.modeFrontier=Math.max(t.modeFrontier,n.line),i.length&&hn(e,function(){for(var t=0;t<i.length;t++)mn(e,i[t],"text")})}}function Ln(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=zt(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=zt(e)+"px",t.scrollbarsClipped=!0)}function kn(e){if(e.hasFocus())return null;var t=l();if(!t||!o(e.display.lineDiv,t))return null;var r={activeElt:t};if(window.getSelection){var n=window.getSelection();n.anchorNode&&n.extend&&o(e.display.lineDiv,n.anchorNode)&&(r.anchorNode=n.anchorNode,r.anchorOffset=n.anchorOffset,r.focusNode=n.focusNode,r.focusOffset=n.focusOffset)}return r}function Tn(e){if(e&&e.activeElt&&e.activeElt!=l()&&(e.activeElt.focus(),e.anchorNode&&o(document.body,e.anchorNode)&&o(document.body,e.focusNode))){var t=window.getSelection(),r=document.createRange();r.setEnd(e.anchorNode,e.anchorOffset),r.collapse(!1),t.removeAllRanges(),t.addRange(r),t.extend(e.focusNode,e.focusOffset)}}function Mn(e,r){var n=e.display,i=e.doc;if(r.editorIsHidden)return yn(e),!1;if(!r.force&&r.visible.from>=n.viewFrom&&r.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==xn(e))return!1;Rr(e)&&(yn(e),r.dims=br(e));var o=i.first+i.size,l=Math.max(r.visible.from-e.options.viewportMargin,i.first),s=Math.min(o,r.visible.to+e.options.viewportMargin);n.viewFrom<l&&l-n.viewFrom<20&&(l=Math.max(i.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(o,n.viewTo)),_l&&(l=pe(e.doc,l),s=ge(e.doc,s));var a=l!=n.viewFrom||s!=n.viewTo||n.lastWrapHeight!=r.wrapperHeight||n.lastWrapWidth!=r.wrapperWidth;wn(e,l,s),n.viewOffset=ye(M(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=xn(e);if(!a&&0==u&&!r.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=kn(e);return u>4&&(n.lineDiv.style.display="none"),An(e,n.updateLineNumbers,r.dims),u>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,Tn(c),t(n.cursorDiv),t(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=r.wrapperHeight,n.lastWrapWidth=r.wrapperWidth,Cn(e,400)),n.updateLineNumbers=null,!0}function Nn(e,t){for(var r=t.viewport,n=!0;(n&&e.options.lineWrapping&&t.oldDisplayWidth!=Rt(e)||(r&&null!=r.top&&(r={top:Math.min(e.doc.height+Pt(e.display)-Bt(e),r.top)}),t.visible=Ir(e.display,e.doc,r),!(t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)))&&Mn(e,t);n=!1){Er(e);var i=Jr(e);kr(e),en(e,i),Dn(e,i),t.force=!1}t.signal(e,"update",e),e.display.viewFrom==e.display.reportedViewFrom&&e.display.viewTo==e.display.reportedViewTo||(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function On(e,t){var r=new Cs(e,t);if(Mn(e,r)){Er(e),Nn(e,r);var n=Jr(e);kr(e),en(e,n),Dn(e,n),r.finish()}}function An(e,r,n){function i(t){var r=t.nextSibling;return ml&&Ml&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var o=e.display,l=e.options.lineNumbers,s=o.lineDiv,a=s.firstChild,u=o.view,c=o.viewFrom,f=0;f<u.length;f++){var d=u[f];if(d.hidden);else if(d.node&&d.node.parentNode==s){for(;a!=d.node;)a=i(a);var p=l&&null!=r&&r<=c&&d.lineNumber;d.changes&&(h(d.changes,"gutter")>-1&&(p=!1),xt(e,d,c,n)),p&&(t(d.lineNumber),d.lineNumber.appendChild(document.createTextNode(F(e.options,c)))),a=d.node.nextSibling}else{var g=Ot(e,d,c,n);s.insertBefore(g,a)}c+=d.size}for(;a;)a=i(a)}function Wn(e){var t=e.display.gutters.offsetWidth;e.display.sizer.style.marginLeft=t+"px"}function Dn(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+zt(e)+"px"}function Hn(e){var r=e.display.gutters,i=e.options.gutters;t(r);for(var o=0;o<i.length;++o){var l=i[o],s=r.appendChild(n("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=s,s.style.width=(e.display.lineNumWidth||1)+"px")}r.style.display=o?"":"none",Wn(e)}function Fn(e){var t=h(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function En(e){var t=e.wheelDeltaX,r=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==r&&e.detail&&e.axis==e.VERTICAL_AXIS?r=e.detail:null==r&&(r=e.wheelDelta),{x:t,y:r}}function Pn(e){var t=En(e);return t.x*=Ls,t.y*=Ls,t}function In(e,t){var r=En(t),n=r.x,i=r.y,o=e.display,l=o.scroller,s=l.scrollWidth>l.clientWidth,a=l.scrollHeight>l.clientHeight;if(n&&s||i&&a){if(i&&Ml&&ml)e:for(var u=t.target,c=o.view;u!=l;u=u.parentNode)for(var f=0;f<c.length;f++)if(c[f].node==u){e.display.currentWheelTarget=u;break e}if(n&&!fl&&!wl&&null!=Ls)return i&&a&&qr(e,Math.max(0,l.scrollTop+i*Ls)),Qr(e,Math.max(0,l.scrollLeft+n*Ls)),(!i||i&&a)&&We(t),void(o.wheelStartX=null);if(i&&null!=Ls){var h=i*Ls,d=e.doc.scrollTop,p=d+o.wrapper.clientHeight;h<0?d=Math.max(0,d+h-50):p=Math.min(e.doc.height,p+h+50),On(e,{top:d,bottom:p})}Ss<20&&(null==o.wheelStartX?(o.wheelStartX=l.scrollLeft,o.wheelStartY=l.scrollTop,o.wheelDX=n,o.wheelDY=i,setTimeout(function(){if(null!=o.wheelStartX){var e=l.scrollLeft-o.wheelStartX,t=l.scrollTop-o.wheelStartY,r=t&&o.wheelDY&&t/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,r&&(Ls=(Ls*Ss+r)/(Ss+1),++Ss)}},200)):(o.wheelDX+=n,o.wheelDY+=i))}}function zn(e,t){var r=e[t];e.sort(function(e,t){return P(e.from(),t.from())}),t=h(e,r);for(var n=1;n<e.length;n++){var i=e[n],o=e[n-1];if(P(o.to(),i.from())>=0){var l=B(o.from(),i.from()),s=R(o.to(),i.to()),a=o.empty()?i.from()==i.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new Ts(a?s:l,a?l:s))}}return new ks(e,t)}function Rn(e,t){return new ks([new Ts(e,t||e)],0)}function Bn(e){return e.text?E(e.from.line+e.text.length-1,g(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function Gn(e,t){if(P(e,t.from)<0)return e;if(P(e,t.to)<=0)return Bn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Bn(t).ch-t.to.ch),E(r,n)}function Un(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var i=e.sel.ranges[n];r.push(new Ts(Gn(i.anchor,t),Gn(i.head,t)))}return zn(r,e.sel.primIndex)}function Vn(e,t,r){return e.line==t.line?E(r.line,e.ch-t.ch+r.ch):E(r.line+(e.line-t.line),e.ch)}function Kn(e,t,r){for(var n=[],i=E(e.first,0),o=i,l=0;l<t.length;l++){var s=t[l],a=Vn(s.from,i,o),u=Vn(Bn(s),i,o);if(i=s.to,o=u,"around"==r){var c=e.sel.ranges[l],f=P(c.head,c.anchor)<0;n[l]=new Ts(f?u:a,f?a:u)}else n[l]=new Ts(a,a)}return new ks(n,e.sel.primIndex)}function jn(e){e.doc.mode=Ue(e.options,e.doc.modeOption),Xn(e)}function Xn(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Cn(e,100),e.state.modeGen++,e.curOp&&vn(e)}function Yn(e,t){return 0==t.from.ch&&0==t.to.ch&&""==g(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function _n(e,t,r,n){function i(e){return r?r[e]:null}function o(e,r,i){it(e,r,i,n),bt(e,"change",e,t)}function l(e,t){for(var r=[],o=e;o<t;++o)r.push(new fs(u[o],i(o),n));return r}var s=t.from,a=t.to,u=t.text,c=M(e,s.line),f=M(e,a.line),h=g(u),d=i(u.length-1),p=a.line-s.line;if(t.full)e.insert(0,l(0,u.length)),e.remove(u.length,e.size-u.length);else if(Yn(e,t)){var v=l(0,u.length-1);o(f,f.text,d),p&&e.remove(s.line,p),v.length&&e.insert(s.line,v)}else if(c==f)if(1==u.length)o(c,c.text.slice(0,s.ch)+h+c.text.slice(a.ch),d);else{var m=l(1,u.length-1);m.push(new fs(h+c.text.slice(a.ch),d,n)),o(c,c.text.slice(0,s.ch)+u[0],i(0)),e.insert(s.line+1,m)}else if(1==u.length)o(c,c.text.slice(0,s.ch)+u[0]+f.text.slice(a.ch),i(0)),e.remove(s.line+1,p);else{o(c,c.text.slice(0,s.ch)+u[0],i(0)),o(f,h+f.text.slice(a.ch),d);var y=l(1,u.length-1);p>1&&e.remove(s.line+1,p-1),e.insert(s.line+1,y)}bt(e,"change",e,t)}function $n(e,t,r){function n(e,i,o){if(e.linked)for(var l=0;l<e.linked.length;++l){var s=e.linked[l];if(s.doc!=i){var a=o&&s.sharedHist;r&&!a||(t(s.doc,a),n(s.doc,e,a))}}}n(e,null,!0)}function qn(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,Cr(e),jn(e),Zn(e),e.options.lineWrapping||we(e),e.options.mode=t.modeOption,vn(e)}function Zn(e){("rtl"==e.doc.direction?s:Fl)(e.display.lineDiv,"CodeMirror-rtl")}function Qn(e){hn(e,function(){Zn(e),vn(e)})}function Jn(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function ei(e,t){var r={from:z(t.from),to:Bn(t),text:N(e,t.from,t.to)};return si(e,r,t.from.line,t.to.line+1),$n(e,function(e){return si(e,r,t.from.line,t.to.line+1)},!0),r}function ti(e){for(;e.length&&g(e).ranges;)e.pop()}function ri(e,t){return t?(ti(e.done),g(e.done)):e.done.length&&!g(e.done).ranges?g(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),g(e.done)):void 0}function ni(e,t,r,n){var i=e.history;i.undone.length=0;var o,l,s=+new Date;if((i.lastOp==n||i.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&i.lastModTime>s-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=ri(i,i.lastOp==n)))l=g(o.changes),0==P(t.from,t.to)&&0==P(t.from,l.to)?l.to=Bn(t):o.changes.push(ei(e,t));else{var a=g(i.done);for(a&&a.ranges||li(e.sel,i.done),o={changes:[ei(e,t)],generation:i.generation},i.done.push(o);i.done.length>i.undoDepth;)i.done.shift(),i.done[0].ranges||i.done.shift()}i.done.push(r),i.generation=++i.maxGeneration,i.lastModTime=i.lastSelTime=s,i.lastOp=i.lastSelOp=n,i.lastOrigin=i.lastSelOrigin=t.origin,l||Te(e,"historyAdded")}function ii(e,t,r,n){var i=t.charAt(0);return"*"==i||"+"==i&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function oi(e,t,r,n){var i=e.history,o=n&&n.origin;r==i.lastSelOp||o&&i.lastSelOrigin==o&&(i.lastModTime==i.lastSelTime&&i.lastOrigin==o||ii(e,o,g(i.done),t))?i.done[i.done.length-1]=t:li(t,i.done),i.lastSelTime=+new Date,i.lastSelOrigin=o,i.lastSelOp=r,n&&!1!==n.clearRedo&&ti(i.undone)}function li(e,t){var r=g(t);r&&r.ranges&&r.equals(e)||t.push(e)}function si(e,t,r,n){var i=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((i||(i=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function ai(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function ui(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=[],i=0;i<t.text.length;++i)n.push(ai(r[i]));return n}function ci(e,t){var r=ui(e,t),n=J(e,t);if(!r)return n;if(!n)return r;for(var i=0;i<r.length;++i){var o=r[i],l=n[i];if(o&&l)e:for(var s=0;s<l.length;++s){for(var a=l[s],u=0;u<o.length;++u)if(o[u].marker==a.marker)continue e;o.push(a)}else l&&(r[i]=l)}return r}function fi(e,t,r){for(var n=[],i=0;i<e.length;++i){var o=e[i];if(o.ranges)n.push(r?ks.prototype.deepCopy.call(o):o);else{var l=o.changes,s=[];n.push({changes:s});for(var a=0;a<l.length;++a){var u=l[a],c=void 0;if(s.push({from:u.from,to:u.to,text:u.text}),t)for(var f in u)(c=f.match(/^spans_(\d+)$/))&&h(t,Number(c[1]))>-1&&(g(s)[f]=u[f],delete u[f])}}}return n}function hi(e,t,r,n){if(n){var i=e.anchor;if(r){var o=P(t,i)<0;o!=P(r,i)<0?(i=t,t=r):o!=P(t,r)<0&&(t=r)}return new Ts(i,t)}return new Ts(r||t,t)}function di(e,t,r,n,i){null==i&&(i=e.cm&&(e.cm.display.shift||e.extend)),bi(e,new ks([hi(e.sel.primary(),t,r,i)],0),n)}function pi(e,t,r){for(var n=[],i=e.cm&&(e.cm.display.shift||e.extend),o=0;o<e.sel.ranges.length;o++)n[o]=hi(e.sel.ranges[o],t[o],null,i);bi(e,zn(n,e.sel.primIndex),r)}function gi(e,t,r,n){var i=e.sel.ranges.slice(0);i[t]=r,bi(e,zn(i,e.sel.primIndex),n)}function vi(e,t,r,n){bi(e,Rn(t,r),n)}function mi(e,t,r){var n={ranges:t.ranges,update:function(t){var r=this;this.ranges=[];for(var n=0;n<t.length;n++)r.ranges[n]=new Ts(U(e,t[n].anchor),U(e,t[n].head))},origin:r&&r.origin};return Te(e,"beforeSelectionChange",e,n),e.cm&&Te(e.cm,"beforeSelectionChange",e.cm,n),n.ranges!=t.ranges?zn(n.ranges,n.ranges.length-1):t}function yi(e,t,r){var n=e.history.done,i=g(n);i&&i.ranges?(n[n.length-1]=t,wi(e,t,r)):bi(e,t,r)}function bi(e,t,r){wi(e,t,r),oi(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function wi(e,t,r){(Oe(e,"beforeSelectionChange")||e.cm&&Oe(e.cm,"beforeSelectionChange"))&&(t=mi(e,t,r)),xi(e,Si(e,t,r&&r.bias||(P(t.primary().head,e.sel.primary().head)<0?-1:1),!0)),r&&!1===r.scroll||!e.cm||jr(e.cm)}function xi(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=!0,Ne(e.cm)),bt(e,"cursorActivity",e))}function Ci(e){xi(e,Si(e,e.sel,null,!1))}function Si(e,t,r,n){for(var i,o=0;o<t.ranges.length;o++){var l=t.ranges[o],s=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[o],a=ki(e,l.anchor,s&&s.anchor,r,n),u=ki(e,l.head,s&&s.head,r,n);(i||a!=l.anchor||u!=l.head)&&(i||(i=t.ranges.slice(0,o)),i[o]=new Ts(a,u))}return i?zn(i,t.primIndex):t}function Li(e,t,r,n,i){var o=M(e,t.line);if(o.markedSpans)for(var l=0;l<o.markedSpans.length;++l){var s=o.markedSpans[l],a=s.marker;if((null==s.from||(a.inclusiveLeft?s.from<=t.ch:s.from<t.ch))&&(null==s.to||(a.inclusiveRight?s.to>=t.ch:s.to>t.ch))){if(i&&(Te(a,"beforeCursorEnter"),a.explicitlyCleared)){if(o.markedSpans){--l;continue}break}if(!a.atomic)continue;if(r){var u=a.find(n<0?1:-1),c=void 0;if((n<0?a.inclusiveRight:a.inclusiveLeft)&&(u=Ti(e,u,-n,u&&u.line==t.line?o:null)),u&&u.line==t.line&&(c=P(u,r))&&(n<0?c<0:c>0))return Li(e,u,t,n,i)}var f=a.find(n<0?-1:1);return(n<0?a.inclusiveLeft:a.inclusiveRight)&&(f=Ti(e,f,n,f.line==t.line?o:null)),f?Li(e,f,t,n,i):null}}return t}function ki(e,t,r,n,i){var o=n||1,l=Li(e,t,r,o,i)||!i&&Li(e,t,r,o,!0)||Li(e,t,r,-o,i)||!i&&Li(e,t,r,-o,!0);return l||(e.cantEdit=!0,E(e.first,0))}function Ti(e,t,r,n){return r<0&&0==t.ch?t.line>e.first?U(e,E(t.line-1)):null:r>0&&t.ch==(n||M(e,t.line)).text.length?t.line<e.first+e.size-1?E(t.line+1,0):null:new E(t.line,t.ch+r)}function Mi(e){e.setSelection(E(e.firstLine(),0),E(e.lastLine()),Gl)}function Ni(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return n.canceled=!0}};return r&&(n.update=function(t,r,i,o){t&&(n.from=U(e,t)),r&&(n.to=U(e,r)),i&&(n.text=i),void 0!==o&&(n.origin=o)}),Te(e,"beforeChange",e,n),e.cm&&Te(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function Oi(e,t,r){if(e.cm){if(!e.cm.curOp)return dn(e.cm,Oi)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"))||(t=Ni(e,t,!0))){var n=Yl&&!r&&te(e,t.from,t.to);if(n)for(var i=n.length-1;i>=0;--i)Ai(e,{from:n[i].from,to:n[i].to,text:i?[""]:t.text,origin:t.origin});else Ai(e,t)}}function Ai(e,t){if(1!=t.text.length||""!=t.text[0]||0!=P(t.from,t.to)){var r=Un(e,t);ni(e,t,r,e.cm?e.cm.curOp.id:NaN),Hi(e,t,r,J(e,t));var n=[];$n(e,function(e,r){r||-1!=h(n,e.history)||(zi(e.history,t),n.push(e.history)),Hi(e,t,null,J(e,t))})}}function Wi(e,t,r){if(!e.cm||!e.cm.state.suppressEdits||r){for(var n,i=e.history,o=e.sel,l="undo"==t?i.done:i.undone,s="undo"==t?i.undone:i.done,a=0;a<l.length&&(n=l[a],r?!n.ranges||n.equals(e.sel):n.ranges);a++);if(a!=l.length){for(i.lastOrigin=i.lastSelOrigin=null;(n=l.pop()).ranges;){if(li(n,s),r&&!n.equals(e.sel))return void bi(e,n,{clearRedo:!1});o=n}var u=[];li(o,s),s.push({changes:u,generation:i.generation}),i.generation=n.generation||++i.maxGeneration;for(var c=Oe(e,"beforeChange")||e.cm&&Oe(e.cm,"beforeChange"),f=n.changes.length-1;f>=0;--f){var d=function(r){var i=n.changes[r];if(i.origin=t,c&&!Ni(e,i,!1))return l.length=0,{};u.push(ei(e,i));var o=r?Un(e,i):g(l);Hi(e,i,o,ci(e,i)),!r&&e.cm&&e.cm.scrollIntoView({from:i.from,to:Bn(i)});var s=[];$n(e,function(e,t){t||-1!=h(s,e.history)||(zi(e.history,i),s.push(e.history)),Hi(e,i,null,ci(e,i))})}(f);if(d)return d.v}}}}function Di(e,t){if(0!=t&&(e.first+=t,e.sel=new ks(v(e.sel.ranges,function(e){return new Ts(E(e.anchor.line+t,e.anchor.ch),E(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm)){vn(e.cm,e.first,e.first-t,t);for(var r=e.cm.display,n=r.viewFrom;n<r.viewTo;n++)mn(e.cm,n,"gutter")}}function Hi(e,t,r,n){if(e.cm&&!e.cm.curOp)return dn(e.cm,Hi)(e,t,r,n);if(t.to.line<e.first)Di(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var i=t.text.length-1-(e.first-t.from.line);Di(e,i),t={from:E(e.first,0),to:E(t.to.line+i,t.to.ch),text:[g(t.text)],origin:t.origin}}var o=e.lastLine();t.to.line>o&&(t={from:t.from,to:E(o,M(e,o).text.length),text:[t.text[0]],origin:t.origin}),t.removed=N(e,t.from,t.to),r||(r=Un(e,t)),e.cm?Fi(e.cm,t,n):_n(e,t,n),wi(e,r,Gl)}}function Fi(e,t,r){var n=e.doc,i=e.display,o=t.from,l=t.to,s=!1,a=o.line;e.options.lineWrapping||(a=W(fe(M(n,o.line))),n.iter(a,l.line+1,function(e){if(e==i.maxLine)return s=!0,!0})),n.sel.contains(t.from,t.to)>-1&&Ne(e),_n(n,t,r,xr(e)),e.options.lineWrapping||(n.iter(a,o.line+t.text.length,function(e){var t=be(e);t>i.maxLineLength&&(i.maxLine=e,i.maxLineLength=t,i.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),nt(n,o.line),Cn(e,400);var u=t.text.length-(l.line-o.line)-1;t.full?vn(e):o.line!=l.line||1!=t.text.length||Yn(e.doc,t)?vn(e,o.line,l.line+1,u):mn(e,o.line,"text");var c=Oe(e,"changes"),f=Oe(e,"change");if(f||c){var h={from:o,to:l,text:t.text,removed:t.removed,origin:t.origin};f&&bt(e,"change",e,h),c&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function Ei(e,t,r,n,i){if(n||(n=r),P(n,r)<0){var o;r=(o=[n,r])[0],n=o[1]}"string"==typeof t&&(t=e.splitLines(t)),Oi(e,{from:r,to:n,text:t,origin:i})}function Pi(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Ii(e,t,r,n){for(var i=0;i<e.length;++i){var o=e[i],l=!0;if(o.ranges){o.copied||((o=e[i]=o.deepCopy()).copied=!0);for(var s=0;s<o.ranges.length;s++)Pi(o.ranges[s].anchor,t,r,n),Pi(o.ranges[s].head,t,r,n)}else{for(var a=0;a<o.changes.length;++a){var u=o.changes[a];if(r<u.from.line)u.from=E(u.from.line+n,u.from.ch),u.to=E(u.to.line+n,u.to.ch);else if(t<=u.to.line){l=!1;break}}l||(e.splice(0,i+1),i=0)}}}function zi(e,t){var r=t.from.line,n=t.to.line,i=t.text.length-(n-r)-1;Ii(e.done,r,n,i),Ii(e.undone,r,n,i)}function Ri(e,t,r,n){var i=t,o=t;return"number"==typeof t?o=M(e,G(e,t)):i=W(t),null==i?null:(n(o,i)&&e.cm&&mn(e.cm,i,r),o)}function Bi(e){var t=this;this.lines=e,this.parent=null;for(var r=0,n=0;n<e.length;++n)e[n].parent=t,r+=e[n].height;this.height=r}function Gi(e){var t=this;this.children=e;for(var r=0,n=0,i=0;i<e.length;++i){var o=e[i];r+=o.chunkSize(),n+=o.height,o.parent=t}this.size=r,this.height=n,this.parent=null}function Ui(e,t,r){ye(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&Kr(e,r)}function Vi(e,t,r,n){var i=new Ms(e,r,n),o=e.cm;return o&&i.noHScroll&&(o.display.alignWidgets=!0),Ri(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==i.insertAt?r.push(i):r.splice(Math.min(r.length-1,Math.max(0,i.insertAt)),0,i),i.line=t,o&&!ve(e,t)){var n=ye(t)<e.scrollTop;A(t,t.height+Ht(i)),n&&Kr(o,i.height),o.curOp.forceUpdate=!0}return!0}),bt(o,"lineWidgetAdded",o,i,"number"==typeof t?t:W(t)),i}function Ki(e,t,r,n,o){if(n&&n.shared)return ji(e,t,r,n,o);if(e.cm&&!e.cm.curOp)return dn(e.cm,Ki)(e,t,r,n,o);var l=new Os(e,o),s=P(t,r);if(n&&c(n,l,!1),s>0||0==s&&!1!==l.clearWhenEmpty)return l;if(l.replacedWith&&(l.collapsed=!0,l.widgetNode=i("span",[l.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||l.widgetNode.setAttribute("cm-ignore-events","true"),n.insertLeft&&(l.widgetNode.insertLeft=!0)),l.collapsed){if(ce(e,t.line,t,r,l)||t.line!=r.line&&ce(e,r.line,t,r,l))throw new Error("Inserting collapsed marker partially overlapping an existing one");X()}l.addToHistory&&ni(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,u=t.line,f=e.cm;if(e.iter(u,r.line+1,function(e){f&&l.collapsed&&!f.options.lineWrapping&&fe(e)==f.display.maxLine&&(a=!0),l.collapsed&&u!=t.line&&A(e,0),q(e,new Y(l,u==t.line?t.ch:null,u==r.line?r.ch:null)),++u}),l.collapsed&&e.iter(t.line,r.line+1,function(t){ve(e,t)&&A(t,0)}),l.clearOnEnter&&Ql(l,"beforeCursorEnter",function(){return l.clear()}),l.readOnly&&(j(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),l.collapsed&&(l.id=++Ns,l.atomic=!0),f){if(a&&(f.curOp.updateMaxLine=!0),l.collapsed)vn(f,t.line,r.line+1);else if(l.className||l.title||l.startStyle||l.endStyle||l.css)for(var h=t.line;h<=r.line;h++)mn(f,h,"text");l.atomic&&Ci(f.doc),bt(f,"markerAdded",f,l)}return l}function ji(e,t,r,n,i){(n=c(n)).shared=!1;var o=[Ki(e,t,r,n,i)],l=o[0],s=n.widgetNode;return $n(e,function(e){s&&(n.widgetNode=s.cloneNode(!0)),o.push(Ki(e,U(e,t),U(e,r),n,i));for(var a=0;a<e.linked.length;++a)if(e.linked[a].isParent)return;l=g(o)}),new As(o,l)}function Xi(e){return e.findMarks(E(e.first,0),e.clipPos(E(e.lastLine())),function(e){return e.parent})}function Yi(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n.find(),o=e.clipPos(i.from),l=e.clipPos(i.to);if(P(o,l)){var s=Ki(e,o,l,n.primary,n.primary.type);n.markers.push(s),s.parent=n}}}function _i(e){for(var t=0;t<e.length;t++)!function(t){var r=e[t],n=[r.primary.doc];$n(r.primary.doc,function(e){return n.push(e)});for(var i=0;i<r.markers.length;i++){var o=r.markers[i];-1==h(n,o.doc)&&(o.parent=null,r.markers.splice(i--,1))}}(t)}function $i(e){var t=this;if(Qi(t),!Me(t,e)&&!Ft(t.display,e)){We(e),gl&&(Hs=+new Date);var r=Sr(t,e,!0),n=e.dataTransfer.files;if(r&&!t.isReadOnly())if(n&&n.length&&window.FileReader&&window.File)for(var i=n.length,o=Array(i),l=0,s=0;s<i;++s)!function(e,n){if(!t.options.allowDropFileTypes||-1!=h(t.options.allowDropFileTypes,e.type)){var s=new FileReader;s.onload=dn(t,function(){var e=s.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(e)&&(e=""),o[n]=e,++l==i){var a={from:r=U(t.doc,r),to:r,text:t.doc.splitLines(o.join(t.doc.lineSeparator())),origin:"paste"};Oi(t.doc,a),yi(t.doc,Rn(r,Bn(a)))}}),s.readAsText(e)}}(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(function(){return t.display.input.focus()},20);try{var a=e.dataTransfer.getData("Text");if(a){var u;if(t.state.draggingText&&!t.state.draggingText.copy&&(u=t.listSelections()),wi(t.doc,Rn(r,r)),u)for(var c=0;c<u.length;++c)Ei(t.doc,"",u[c].anchor,u[c].head,"drag");t.replaceSelection(a,"around","paste"),t.display.input.focus()}}catch(e){}}}}function qi(e,t){if(gl&&(!e.state.draggingText||+new Date-Hs<100))Fe(t);else if(!Me(e,t)&&!Ft(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!xl)){var r=n("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",wl&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),wl&&r.parentNode.removeChild(r)}}function Zi(e,t){var i=Sr(e,t);if(i){var o=document.createDocumentFragment();Mr(e,i,o),e.display.dragCursor||(e.display.dragCursor=n("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),r(e.display.dragCursor,o)}}function Qi(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ji(e){if(document.getElementsByClassName)for(var t=document.getElementsByClassName("CodeMirror"),r=0;r<t.length;r++){var n=t[r].CodeMirror;n&&e(n)}}function eo(){Fs||(to(),Fs=!0)}function to(){var e;Ql(window,"resize",function(){null==e&&(e=setTimeout(function(){e=null,Ji(ro)},100))}),Ql(window,"blur",function(){return Ji(Fr)})}function ro(e){var t=e.display;t.lastWrapHeight==t.wrapper.clientHeight&&t.lastWrapWidth==t.wrapper.clientWidth||(t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize())}function no(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var r,n,i,o,l=0;l<t.length-1;l++){var s=t[l];if(/^(cmd|meta|m)$/i.test(s))o=!0;else if(/^a(lt)?$/i.test(s))r=!0;else if(/^(c|ctrl|control)$/i.test(s))n=!0;else{if(!/^s(hift)?$/i.test(s))throw new Error("Unrecognized modifier name: "+s);i=!0}}return r&&(e="Alt-"+e),n&&(e="Ctrl-"+e),o&&(e="Cmd-"+e),i&&(e="Shift-"+e),e}function io(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(/^(name|fallthrough|(de|at)tach)$/.test(r))continue;if("..."==n){delete e[r];continue}for(var i=v(r.split(" "),no),o=0;o<i.length;o++){var l=void 0,s=void 0;o==i.length-1?(s=i.join(" "),l=n):(s=i.slice(0,o+1).join(" "),l="...");var a=t[s];if(a){if(a!=l)throw new Error("Inconsistent bindings for "+s)}else t[s]=l}delete e[r]}for(var u in t)e[u]=t[u];return e}function oo(e,t,r,n){var i=(t=uo(t)).call?t.call(e,n):t[e];if(!1===i)return"nothing";if("..."===i)return"multi";if(null!=i&&r(i))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return oo(e,t.fallthrough,r,n);for(var o=0;o<t.fallthrough.length;o++){var l=oo(e,t.fallthrough[o],r,n);if(l)return l}}}function lo(e){var t="string"==typeof e?e:Es[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function so(e,t,r){var n=e;return t.altKey&&"Alt"!=n&&(e="Alt-"+e),(Dl?t.metaKey:t.ctrlKey)&&"Ctrl"!=n&&(e="Ctrl-"+e),(Dl?t.ctrlKey:t.metaKey)&&"Cmd"!=n&&(e="Cmd-"+e),!r&&t.shiftKey&&"Shift"!=n&&(e="Shift-"+e),e}function ao(e,t){if(wl&&34==e.keyCode&&e.char)return!1;var r=Es[e.keyCode];return null!=r&&!e.altGraphKey&&so(r,e,t)}function uo(e){return"string"==typeof e?Rs[e]:e}function co(e,t){for(var r=e.doc.sel.ranges,n=[],i=0;i<r.length;i++){for(var o=t(r[i]);n.length&&P(o.from,g(n).to)<=0;){var l=n.pop();if(P(l.from,o.from)<0){o.from=l.from;break}}n.push(o)}hn(e,function(){for(var t=n.length-1;t>=0;t--)Ei(e.doc,"",n[t].from,n[t].to,"+delete");jr(e)})}function fo(e,t,r){var n=L(e.text,t+r,r);return n<0||n>e.text.length?null:n}function ho(e,t,r){var n=fo(e,t.ch,r);return null==n?null:new E(t.line,n,r<0?"after":"before")}function po(e,t,r,n,i){if(e){var o=Se(r,t.doc.direction);if(o){var l,s=i<0?g(o):o[0],a=i<0==(1==s.level)?"after":"before";if(s.level>0){var u=Xt(t,r);l=i<0?r.text.length-1:0;var c=Yt(t,u,l).top;l=k(function(e){return Yt(t,u,e).top==c},i<0==(1==s.level)?s.from:s.to-1,l),"before"==a&&(l=fo(r,l,1))}else l=i<0?s.to:s.from;return new E(n,l,a)}}return new E(n,i<0?r.text.length:0,i<0?"before":"after")}function go(e,t,r,n){var i=Se(t,e.doc.direction);if(!i)return ho(t,r,n);r.ch>=t.text.length?(r.ch=t.text.length,r.sticky="before"):r.ch<=0&&(r.ch=0,r.sticky="after");var o=Ce(i,r.ch,r.sticky),l=i[o];if("ltr"==e.doc.direction&&l.level%2==0&&(n>0?l.to>r.ch:l.from<r.ch))return ho(t,r,n);var s,a=function(e,r){return fo(t,e instanceof E?e.ch:e,r)},u=function(r){return e.options.lineWrapping?(s=s||Xt(e,t),hr(e,t,s,r)):{begin:0,end:t.text.length}},c=u("before"==r.sticky?a(r,-1):r.ch);if("rtl"==e.doc.direction||1==l.level){var f=1==l.level==n<0,h=a(r,f?1:-1);if(null!=h&&(f?h<=l.to&&h<=c.end:h>=l.from&&h>=c.begin)){var d=f?"before":"after";return new E(r.line,h,d)}}var p=function(e,t,n){for(var o=function(e,t){return t?new E(r.line,a(e,1),"before"):new E(r.line,e,"after")};e>=0&&e<i.length;e+=t){var l=i[e],s=t>0==(1!=l.level),u=s?n.begin:a(n.end,-1);if(l.from<=u&&u<l.to)return o(u,s);if(u=s?l.from:a(l.to,-1),n.begin<=u&&u<n.end)return o(u,s)}},g=p(o+n,n,c);if(g)return g;var v=n>0?c.end:a(c.begin,-1);return null==v||n>0&&v==t.text.length||!(g=p(n>0?0:i.length-1,n,u(v)))?null:g}function vo(e,t){var r=M(e.doc,t),n=fe(r);return n!=r&&(t=W(n)),po(!0,e,n,t,1)}function mo(e,t){var r=M(e.doc,t),n=he(r);return n!=r&&(t=W(n)),po(!0,e,r,t,-1)}function yo(e,t){var r=vo(e,t.line),n=M(e.doc,r.line),i=Se(n,e.doc.direction);if(!i||0==i[0].level){var o=Math.max(0,n.text.search(/\S/)),l=t.line==r.line&&t.ch<=o&&t.ch;return E(r.line,l?0:o,r.sticky)}return r}function bo(e,t,r){if("string"==typeof t&&!(t=Bs[t]))return!1;e.display.input.ensurePolled();var n=e.display.shift,i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),i=t(e)!=Bl}finally{e.display.shift=n,e.state.suppressEdits=!1}return i}function wo(e,t,r){for(var n=0;n<e.state.keyMaps.length;n++){var i=oo(t,e.state.keyMaps[n],r,e);if(i)return i}return e.options.extraKeys&&oo(t,e.options.extraKeys,r,e)||oo(t,e.options.keyMap,r,e)}function xo(e,t,r,n){var i=e.state.keySeq;if(i){if(lo(t))return"handled";Gs.set(50,function(){e.state.keySeq==i&&(e.state.keySeq=null,e.display.input.reset())}),t=i+" "+t}var o=wo(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&bt(e,"keyHandled",e,t,r),"handled"!=o&&"multi"!=o||(We(r),Ar(e)),i&&!o&&/\'$/.test(t)?(We(r),!0):!!o}function Co(e,t){var r=ao(t,!0);return!!r&&(t.shiftKey&&!e.state.keySeq?xo(e,"Shift-"+r,t,function(t){return bo(e,t,!0)})||xo(e,r,t,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return bo(e,t)}):xo(e,r,t,function(t){return bo(e,t)}))}function So(e,t,r){return xo(e,"'"+r+"'",t,function(t){return bo(e,t,!0)})}function Lo(e){var t=this;if(t.curOp.focus=l(),!Me(t,e)){gl&&vl<11&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=Co(t,e);wl&&(Us=n?r:null,!n&&88==r&&!rs&&(Ml?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),18!=r||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||ko(t)}}function ko(e){function t(e){18!=e.keyCode&&e.altKey||(Fl(r,"CodeMirror-crosshair"),ke(document,"keyup",t),ke(document,"mouseover",t))}var r=e.display.lineDiv;s(r,"CodeMirror-crosshair"),Ql(document,"keyup",t),Ql(document,"mouseover",t)}function To(e){16==e.keyCode&&(this.doc.sel.shift=!1),Me(this,e)}function Mo(e){var t=this;if(!(Ft(t.display,e)||Me(t,e)||e.ctrlKey&&!e.altKey||Ml&&e.metaKey)){var r=e.keyCode,n=e.charCode;if(wl&&r==Us)return Us=null,void We(e);if(!wl||e.which&&!(e.which<10)||!Co(t,e)){var i=String.fromCharCode(null==n?r:n);"\b"!=i&&(So(t,e,i)||t.display.input.onKeyPress(e))}}}function No(e,t){var r=+new Date;return js&&js.compare(r,e,t)?(Ks=js=null,"triple"):Ks&&Ks.compare(r,e,t)?(js=new Vs(r,e,t),Ks=null,"double"):(Ks=new Vs(r,e,t),js=null,"single")}function Oo(e){var t=this,r=t.display;if(!(Me(t,e)||r.activeTouch&&r.input.supportsTouch()))if(r.input.ensurePolled(),r.shift=e.shiftKey,Ft(r,e))ml||(r.scroller.draggable=!1,setTimeout(function(){return r.scroller.draggable=!0},100));else if(!zo(t,e)){var n=Sr(t,e),i=Pe(e),o=n?No(n,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),n&&Ao(t,i,n,o,e)||(1==i?n?Do(t,n,o,e):Ee(e)==r.scroller&&We(e):2==i?(n&&di(t.doc,n),setTimeout(function(){return r.input.focus()},20)):3==i&&(Hl?Ro(t,e):Dr(t)))}}function Ao(e,t,r,n,i){var o="Click";return"double"==n?o="Double"+o:"triple"==n&&(o="Triple"+o),o=(1==t?"Left":2==t?"Middle":"Right")+o,xo(e,so(o,i),i,function(t){if("string"==typeof t&&(t=Bs[t]),!t)return!1;var n=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n=t(e,r)!=Bl}finally{e.state.suppressEdits=!1}return n})}function Wo(e,t,r){var n=e.getOption("configureMouse"),i=n?n(e,t,r):{};if(null==i.unit){var o=Nl?r.shiftKey&&r.metaKey:r.altKey;i.unit=o?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||r.shiftKey),null==i.addNew&&(i.addNew=Ml?r.metaKey:r.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(Ml?r.altKey:r.ctrlKey)),i}function Do(e,t,r,n){gl?setTimeout(u(Wr,e),0):e.curOp.focus=l();var i,o=Wo(e,r,n),s=e.doc.sel;e.options.dragDrop&&Jl&&!e.isReadOnly()&&"single"==r&&(i=s.contains(t))>-1&&(P((i=s.ranges[i]).from(),t)<0||t.xRel>0)&&(P(i.to(),t)>0||t.xRel<0)?Ho(e,n,t,o):Eo(e,n,t,o)}function Ho(e,t,r,n){var i=e.display,o=!1,l=dn(e,function(t){ml&&(i.scroller.draggable=!1),e.state.draggingText=!1,ke(document,"mouseup",l),ke(document,"mousemove",s),ke(i.scroller,"dragstart",a),ke(i.scroller,"drop",l),o||(We(t),n.addNew||di(e.doc,r,null,null,n.extend),ml||gl&&9==vl?setTimeout(function(){document.body.focus(),i.input.focus()},20):i.input.focus())}),s=function(e){o=o||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=function(){return o=!0};ml&&(i.scroller.draggable=!0),e.state.draggingText=l,l.copy=!n.moveOnDrag,i.scroller.dragDrop&&i.scroller.dragDrop(),Ql(document,"mouseup",l),Ql(document,"mousemove",s),Ql(i.scroller,"dragstart",a),Ql(i.scroller,"drop",l),Dr(e),setTimeout(function(){return i.input.focus()},20)}function Fo(e,t,r){if("char"==r)return new Ts(t,t);if("word"==r)return e.findWordAt(t);if("line"==r)return new Ts(E(t.line,0),U(e.doc,E(t.line+1,0)));var n=r(e,t);return new Ts(n.from,n.to)}function Eo(e,t,r,n){function i(t){if(0!=P(m,t))if(m=t,"rectangle"==n.unit){for(var i=[],o=e.options.tabSize,l=f(M(u,r.line).text,r.ch,o),s=f(M(u,t.line).text,t.ch,o),a=Math.min(l,s),g=Math.max(l,s),v=Math.min(r.line,t.line),y=Math.min(e.lastLine(),Math.max(r.line,t.line));v<=y;v++){var b=M(u,v).text,w=d(b,a,o);a==g?i.push(new Ts(E(v,w),E(v,w))):b.length>w&&i.push(new Ts(E(v,w),E(v,d(b,g,o))))}i.length||i.push(new Ts(r,r)),bi(u,zn(p.ranges.slice(0,h).concat(i),h),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var x,C=c,S=Fo(e,t,n.unit),L=C.anchor;P(S.anchor,L)>0?(x=S.head,L=B(C.from(),S.anchor)):(x=S.anchor,L=R(C.to(),S.head));var k=p.ranges.slice(0);k[h]=Po(e,new Ts(U(u,L),x)),bi(u,zn(k,h),Ul)}}function o(t){var r=++b,s=Sr(e,t,!0,"rectangle"==n.unit);if(s)if(0!=P(s,m)){e.curOp.focus=l(),i(s);var c=Ir(a,u);(s.line>=c.to||s.line<c.from)&&setTimeout(dn(e,function(){b==r&&o(t)}),150)}else{var f=t.clientY<y.top?-20:t.clientY>y.bottom?20:0;f&&setTimeout(dn(e,function(){b==r&&(a.scroller.scrollTop+=f,o(t))}),50)}}function s(t){e.state.selectingText=!1,b=1/0,We(t),a.input.focus(),ke(document,"mousemove",w),ke(document,"mouseup",x),u.history.lastSelOrigin=null}var a=e.display,u=e.doc;We(t);var c,h,p=u.sel,g=p.ranges;if(n.addNew&&!n.extend?(h=u.sel.contains(r),c=h>-1?g[h]:new Ts(r,r)):(c=u.sel.primary(),h=u.sel.primIndex),"rectangle"==n.unit)n.addNew||(c=new Ts(r,r)),r=Sr(e,t,!0,!0),h=-1;else{var v=Fo(e,r,n.unit);c=n.extend?hi(c,v.anchor,v.head,n.extend):v}n.addNew?-1==h?(h=g.length,bi(u,zn(g.concat([c]),h),{scroll:!1,origin:"*mouse"})):g.length>1&&g[h].empty()&&"char"==n.unit&&!n.extend?(bi(u,zn(g.slice(0,h).concat(g.slice(h+1)),0),{scroll:!1,origin:"*mouse"}),p=u.sel):gi(u,h,c,Ul):(h=0,bi(u,new ks([c],0),Ul),p=u.sel);var m=r,y=a.wrapper.getBoundingClientRect(),b=0,w=dn(e,function(e){Pe(e)?o(e):s(e)}),x=dn(e,s);e.state.selectingText=x,Ql(document,"mousemove",w),Ql(document,"mouseup",x)}function Po(e,t){var r=t.anchor,n=t.head,i=M(e.doc,r.line);if(0==P(r,n)&&r.sticky==n.sticky)return t;var o=Se(i);if(!o)return t;var l=Ce(o,r.ch,r.sticky),s=o[l];if(s.from!=r.ch&&s.to!=r.ch)return t;var a=l+(s.from==r.ch==(1!=s.level)?0:1);if(0==a||a==o.length)return t;var u;if(n.line!=r.line)u=(n.line-r.line)*("ltr"==e.doc.direction?1:-1)>0;else{var c=Ce(o,n.ch,n.sticky),f=c-l||(n.ch-r.ch)*(1==s.level?-1:1);u=c==a-1||c==a?f<0:f>0}var h=o[a+(u?-1:0)],d=u==(1==h.level),p=d?h.from:h.to,g=d?"after":"before";return r.ch==p&&r.sticky==g?t:new Ts(new E(r.line,p,g),n)}function Io(e,t,r,n){var i,o;if(t.touches)i=t.touches[0].clientX,o=t.touches[0].clientY;else try{i=t.clientX,o=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&We(t);var l=e.display,s=l.lineDiv.getBoundingClientRect();if(o>s.bottom||!Oe(e,r))return He(t);o-=s.top-l.viewOffset;for(var a=0;a<e.options.gutters.length;++a){var u=l.gutters.childNodes[a];if(u&&u.getBoundingClientRect().right>=i)return Te(e,r,e,D(e.doc,o),e.options.gutters[a],t),He(t)}}function zo(e,t){return Io(e,t,"gutterClick",!0)}function Ro(e,t){Ft(e.display,t)||Bo(e,t)||Me(e,t,"contextmenu")||e.display.input.onContextMenu(t)}function Bo(e,t){return!!Oe(e,"gutterContextMenu")&&Io(e,t,"gutterContextMenu",!1)}function Go(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),er(e)}function Uo(e){Hn(e),vn(e),zr(e)}function Vo(e,t,r){if(!t!=!(r&&r!=Xs)){var n=e.display.dragFunctions,i=t?Ql:ke;i(e.display.scroller,"dragstart",n.start),i(e.display.scroller,"dragenter",n.enter),i(e.display.scroller,"dragover",n.over),i(e.display.scroller,"dragleave",n.leave),i(e.display.scroller,"drop",n.drop)}}function Ko(e){e.options.lineWrapping?(s(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(Fl(e.display.wrapper,"CodeMirror-wrap"),we(e)),Cr(e),vn(e),er(e),setTimeout(function(){return en(e)},100)}function jo(e,t){var r=this;if(!(this instanceof jo))return new jo(e,t);this.options=t=t?c(t):{},c(Ys,t,!1),Fn(t);var n=t.value;"string"==typeof n&&(n=new Ds(n,t.mode,null,t.lineSeparator,t.direction)),this.doc=n;var i=new jo.inputStyles[t.inputStyle](this),o=this.display=new T(e,n,i);o.wrapper.CodeMirror=this,Hn(this),Go(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),rn(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,selectingText:!1,draggingText:!1,highlight:new Pl,keySeq:null,specialChars:null},t.autofocus&&!Tl&&o.input.focus(),gl&&vl<11&&setTimeout(function(){return r.display.input.reset(!0)},20),Xo(this),eo(),nn(this),this.curOp.forceUpdate=!0,qn(this,n),t.autofocus&&!Tl||this.hasFocus()?setTimeout(u(Hr,this),20):Fr(this);for(var l in _s)_s.hasOwnProperty(l)&&_s[l](r,t[l],Xs);Rr(this),t.finishInit&&t.finishInit(this);for(var s=0;s<$s.length;++s)$s[s](r);on(this),ml&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(o.lineDiv).textRendering&&(o.lineDiv.style.textRendering="auto")}function Xo(e){function t(){i.activeTouch&&(o=setTimeout(function(){return i.activeTouch=null},1e3),(l=i.activeTouch).end=+new Date)}function r(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function n(e,t){if(null==t.left)return!0;var r=t.left-e.left,n=t.top-e.top;return r*r+n*n>400}var i=e.display;Ql(i.scroller,"mousedown",dn(e,Oo)),gl&&vl<11?Ql(i.scroller,"dblclick",dn(e,function(t){if(!Me(e,t)){var r=Sr(e,t);if(r&&!zo(e,t)&&!Ft(e.display,t)){We(t);var n=e.findWordAt(r);di(e.doc,n.anchor,n.head)}}})):Ql(i.scroller,"dblclick",function(t){return Me(e,t)||We(t)}),Hl||Ql(i.scroller,"contextmenu",function(t){return Ro(e,t)});var o,l={end:0};Ql(i.scroller,"touchstart",function(t){if(!Me(e,t)&&!r(t)&&!zo(e,t)){i.input.ensurePolled(),clearTimeout(o);var n=+new Date;i.activeTouch={start:n,moved:!1,prev:n-l.end<=300?l:null},1==t.touches.length&&(i.activeTouch.left=t.touches[0].pageX,i.activeTouch.top=t.touches[0].pageY)}}),Ql(i.scroller,"touchmove",function(){i.activeTouch&&(i.activeTouch.moved=!0)}),Ql(i.scroller,"touchend",function(r){var o=i.activeTouch;if(o&&!Ft(i,r)&&null!=o.left&&!o.moved&&new Date-o.start<300){var l,s=e.coordsChar(i.activeTouch,"page");l=!o.prev||n(o,o.prev)?new Ts(s,s):!o.prev.prev||n(o,o.prev.prev)?e.findWordAt(s):new Ts(E(s.line,0),U(e.doc,E(s.line+1,0))),e.setSelection(l.anchor,l.head),e.focus(),We(r)}t()}),Ql(i.scroller,"touchcancel",t),Ql(i.scroller,"scroll",function(){i.scroller.clientHeight&&(qr(e,i.scroller.scrollTop),Qr(e,i.scroller.scrollLeft,!0),Te(e,"scroll",e))}),Ql(i.scroller,"mousewheel",function(t){return In(e,t)}),Ql(i.scroller,"DOMMouseScroll",function(t){return In(e,t)}),Ql(i.wrapper,"scroll",function(){return i.wrapper.scrollTop=i.wrapper.scrollLeft=0}),i.dragFunctions={enter:function(t){Me(e,t)||Fe(t)},over:function(t){Me(e,t)||(Zi(e,t),Fe(t))},start:function(t){return qi(e,t)},drop:dn(e,$i),leave:function(t){Me(e,t)||Qi(e)}};var s=i.input.getField();Ql(s,"keyup",function(t){return To.call(e,t)}),Ql(s,"keydown",dn(e,Lo)),Ql(s,"keypress",dn(e,Mo)),Ql(s,"focus",function(t){return Hr(e,t)}),Ql(s,"blur",function(t){return Fr(e,t)})}function Yo(e,t,r,n){var i,o=e.doc;null==r&&(r="add"),"smart"==r&&(o.mode.indent?i=$e(e,t).state:r="prev");var l=e.options.tabSize,s=M(o,t),a=f(s.text,null,l);s.stateAfter&&(s.stateAfter=null);var u,c=s.text.match(/^\s*/)[0];if(n||/\S/.test(s.text)){if("smart"==r&&((u=o.mode.indent(i,s.text.slice(c.length),s.text))==Bl||u>150)){if(!n)return;r="prev"}}else u=0,r="not";"prev"==r?u=t>o.first?f(M(o,t-1).text,null,l):0:"add"==r?u=a+e.options.indentUnit:"subtract"==r?u=a-e.options.indentUnit:"number"==typeof r&&(u=a+r),u=Math.max(0,u);var h="",d=0;if(e.options.indentWithTabs)for(var g=Math.floor(u/l);g;--g)d+=l,h+="\t";if(d<u&&(h+=p(u-d)),h!=c)return Ei(o,h,E(t,0),E(t,c.length),"+input"),s.stateAfter=null,!0;for(var v=0;v<o.sel.ranges.length;v++){var m=o.sel.ranges[v];if(m.head.line==t&&m.head.ch<c.length){var y=E(t,c.length);gi(o,v,new Ts(y,y));break}}}function _o(e){qs=e}function $o(e,t,r,n,i){var o=e.doc;e.display.shift=!1,n||(n=o.sel);var l=e.state.pasteIncoming||"paste"==i,s=es(t),a=null;if(l&&n.ranges.length>1)if(qs&&qs.text.join("\n")==t){if(n.ranges.length%qs.text.length==0){a=[];for(var u=0;u<qs.text.length;u++)a.push(o.splitLines(qs.text[u]))}}else s.length==n.ranges.length&&e.options.pasteLinesPerSelection&&(a=v(s,function(e){return[e]}));for(var c,f=n.ranges.length-1;f>=0;f--){var h=n.ranges[f],d=h.from(),p=h.to();h.empty()&&(r&&r>0?d=E(d.line,d.ch-r):e.state.overwrite&&!l?p=E(p.line,Math.min(M(o,p.line).text.length,p.ch+g(s).length)):qs&&qs.lineWise&&qs.text.join("\n")==t&&(d=p=E(d.line,0))),c=e.curOp.updateInput;var m={from:d,to:p,text:a?a[f%a.length]:s,origin:i||(l?"paste":e.state.cutIncoming?"cut":"+input")};Oi(e.doc,m),bt(e,"inputRead",e,m)}t&&!l&&Zo(e,t),jr(e),e.curOp.updateInput=c,e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=!1}function qo(e,t){var r=e.clipboardData&&e.clipboardData.getData("Text");if(r)return e.preventDefault(),t.isReadOnly()||t.options.disableInput||hn(t,function(){return $o(t,r,0,null,"paste")}),!0}function Zo(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var r=e.doc.sel,n=r.ranges.length-1;n>=0;n--){var i=r.ranges[n];if(!(i.head.ch>100||n&&r.ranges[n-1].head.line==i.head.line)){var o=e.getModeAt(i.head),l=!1;if(o.electricChars){for(var s=0;s<o.electricChars.length;s++)if(t.indexOf(o.electricChars.charAt(s))>-1){l=Yo(e,i.head.line,"smart");break}}else o.electricInput&&o.electricInput.test(M(e.doc,i.head.line).text.slice(0,i.head.ch))&&(l=Yo(e,i.head.line,"smart"));l&&bt(e,"electricInput",e,i.head.line)}}}function Qo(e){for(var t=[],r=[],n=0;n<e.doc.sel.ranges.length;n++){var i=e.doc.sel.ranges[n].head.line,o={anchor:E(i,0),head:E(i+1,0)};r.push(o),t.push(e.getRange(o.anchor,o.head))}return{text:t,ranges:r}}function Jo(e,t){e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck",!!t)}function el(){var e=n("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),t=n("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return ml?e.style.width="1000px":e.setAttribute("wrap","off"),Ll&&(e.style.border="1px solid black"),Jo(e),t}function tl(e,t,r,n,i){function o(){var n=t.line+r;return!(n<e.first||n>=e.first+e.size)&&(t=new E(n,t.ch,t.sticky),u=M(e,n))}function l(n){var l;if(null==(l=i?go(e.cm,u,t,r):ho(u,t,r))){if(n||!o())return!1;t=po(i,e.cm,u,t.line,r)}else t=l;return!0}var s=t,a=r,u=M(e,t.line);if("char"==n)l();else if("column"==n)l(!0);else if("word"==n||"group"==n)for(var c=null,f="group"==n,h=e.cm&&e.cm.getHelper(t,"wordChars"),d=!0;!(r<0)||l(!d);d=!1){var p=u.text.charAt(t.ch)||"\n",g=x(p,h)?"w":f&&"\n"==p?"n":!f||/\s/.test(p)?null:"p";if(!f||d||g||(g="s"),c&&c!=g){r<0&&(r=1,l(),t.sticky="after");break}if(g&&(c=g),r>0&&!l(!d))break}var v=ki(e,t,s,a,!0);return I(s,v)&&(v.hitSide=!0),v}function rl(e,t,r,n){var i,o=e.doc,l=t.left;if("page"==n){var s=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),a=Math.max(s-.5*mr(e.display),3);i=(r>0?t.bottom:t.top)+r*a}else"line"==n&&(i=r>0?t.bottom+3:t.top-3);for(var u;(u=cr(e,l,i)).outside;){if(r<0?i<=0:i>=o.height){u.hitSide=!0;break}i+=5*r}return u}function nl(e,t){var r=jt(e,t.line);if(!r||r.hidden)return null;var n=M(e.doc,t.line),i=Ut(r,n,t.line),o=Se(n,e.doc.direction),l="left";o&&(l=Ce(o,t.ch)%2?"right":"left");var s=_t(i.map,t.ch,l);return s.offset="right"==s.collapse?s.end:s.start,s}function il(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function ol(e,t){return t&&(e.bad=!0),e}function ll(e,t,r,n,i){function o(e){return function(t){return t.id==e}}function l(){c&&(u+=f,c=!1)}function s(e){e&&(l(),u+=e)}function a(t){if(1==t.nodeType){var r=t.getAttribute("cm-text");if(null!=r)return void s(r||t.textContent.replace(/\u200b/g,""));var u,h=t.getAttribute("cm-marker");if(h){var d=e.findMarks(E(n,0),E(i+1,0),o(+h));return void(d.length&&(u=d[0].find(0))&&s(N(e.doc,u.from,u.to).join(f)))}if("false"==t.getAttribute("contenteditable"))return;var p=/^(pre|div|p)$/i.test(t.nodeName);p&&l();for(var g=0;g<t.childNodes.length;g++)a(t.childNodes[g]);p&&(c=!0)}else 3==t.nodeType&&s(t.nodeValue)}for(var u="",c=!1,f=e.doc.lineSeparator();a(t),t!=r;)t=t.nextSibling;return u}function sl(e,t,r){var n;if(t==e.display.lineDiv){if(!(n=e.display.lineDiv.childNodes[r]))return ol(e.clipPos(E(e.display.viewTo-1)),!0);t=null,r=0}else for(n=t;;n=n.parentNode){if(!n||n==e.display.lineDiv)return null;if(n.parentNode&&n.parentNode==e.display.lineDiv)break}for(var i=0;i<e.display.view.length;i++){var o=e.display.view[i];if(o.node==n)return al(o,t,r)}}function al(e,t,r){function n(t,r,n){for(var i=-1;i<(f?f.length:0);i++)for(var o=i<0?c.map:f[i],l=0;l<o.length;l+=3){var s=o[l+2];if(s==t||s==r){var a=W(i<0?e.line:e.rest[i]),u=o[l]+n;return(n<0||s!=t)&&(u=o[l+(n?1:0)]),E(a,u)}}}var i=e.text.firstChild,l=!1;if(!t||!o(i,t))return ol(E(W(e.line),0),!0);if(t==i&&(l=!0,t=i.childNodes[r],r=0,!t)){var s=e.rest?g(e.rest):e.line;return ol(E(W(s),s.text.length),l)}var a=3==t.nodeType?t:null,u=t;for(a||1!=t.childNodes.length||3!=t.firstChild.nodeType||(a=t.firstChild,r&&(r=a.nodeValue.length));u.parentNode!=i;)u=u.parentNode;var c=e.measure,f=c.maps,h=n(a,u,r);if(h)return ol(h,l);for(var d=u.nextSibling,p=a?a.nodeValue.length-r:0;d;d=d.nextSibling){if(h=n(d,d.firstChild,0))return ol(E(h.line,h.ch-p),l);p+=d.textContent.length}for(var v=u.previousSibling,m=r;v;v=v.previousSibling){if(h=n(v,v.firstChild,-1))return ol(E(h.line,h.ch+m),l);m+=v.textContent.length}}var ul=navigator.userAgent,cl=navigator.platform,fl=/gecko\/\d/i.test(ul),hl=/MSIE \d/.test(ul),dl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(ul),pl=/Edge\/(\d+)/.exec(ul),gl=hl||dl||pl,vl=gl&&(hl?document.documentMode||6:+(pl||dl)[1]),ml=!pl&&/WebKit\//.test(ul),yl=ml&&/Qt\/\d+\.\d+/.test(ul),bl=!pl&&/Chrome\//.test(ul),wl=/Opera\//.test(ul),xl=/Apple Computer/.test(navigator.vendor),Cl=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(ul),Sl=/PhantomJS/.test(ul),Ll=!pl&&/AppleWebKit/.test(ul)&&/Mobile\/\w+/.test(ul),kl=/Android/.test(ul),Tl=Ll||kl||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(ul),Ml=Ll||/Mac/.test(cl),Nl=/\bCrOS\b/.test(ul),Ol=/win/i.test(cl),Al=wl&&ul.match(/Version\/(\d*\.\d*)/);Al&&(Al=Number(Al[1])),Al&&Al>=15&&(wl=!1,ml=!0);var Wl,Dl=Ml&&(yl||wl&&(null==Al||Al<12.11)),Hl=fl||gl&&vl>=9,Fl=function(t,r){var n=t.className,i=e(r).exec(n);if(i){var o=n.slice(i.index+i[0].length);t.className=n.slice(0,i.index)+(o?i[1]+o:"")}};Wl=document.createRange?function(e,t,r,n){var i=document.createRange();return i.setEnd(n||e,r),i.setStart(e,t),i}:function(e,t,r){var n=document.body.createTextRange();try{n.moveToElementText(e.parentNode)}catch(e){return n}return n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n};var El=function(e){e.select()};Ll?El=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:gl&&(El=function(e){try{e.select()}catch(e){}});var Pl=function(){this.id=null};Pl.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Il,zl,Rl=30,Bl={toString:function(){return"CodeMirror.Pass"}},Gl={scroll:!1},Ul={origin:"*mouse"},Vl={origin:"+move"},Kl=[""],jl=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Xl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/,Yl=!1,_l=!1,$l=null,ql=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1785?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111",i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,l=/[LRr]/,s=/[Lb1n]/,a=/[1n]/;return function(r,n){var u="ltr"==n?"L":"R";if(0==r.length||"ltr"==n&&!i.test(r))return!1;for(var c=r.length,f=[],h=0;h<c;++h)f.push(e(r.charCodeAt(h)));for(var d=0,p=u;d<c;++d){var v=f[d];"m"==v?f[d]=p:p=v}for(var m=0,y=u;m<c;++m){var b=f[m];"1"==b&&"r"==y?f[m]="n":l.test(b)&&(y=b,"r"==b&&(f[m]="R"))}for(var w=1,x=f[0];w<c-1;++w){var C=f[w];"+"==C&&"1"==x&&"1"==f[w+1]?f[w]="1":","!=C||x!=f[w+1]||"1"!=x&&"n"!=x||(f[w]=x),x=C}for(var S=0;S<c;++S){var L=f[S];if(","==L)f[S]="N";else if("%"==L){var k=void 0;for(k=S+1;k<c&&"%"==f[k];++k);for(var T=S&&"!"==f[S-1]||k<c&&"1"==f[k]?"1":"N",M=S;M<k;++M)f[M]=T;S=k-1}}for(var N=0,O=u;N<c;++N){var A=f[N];"L"==O&&"1"==A?f[N]="L":l.test(A)&&(O=A)}for(var W=0;W<c;++W)if(o.test(f[W])){var D=void 0;for(D=W+1;D<c&&o.test(f[D]);++D);for(var H="L"==(W?f[W-1]:u),F=H==("L"==(D<c?f[D]:u))?H?"L":"R":u,E=W;E<D;++E)f[E]=F;W=D-1}for(var P,I=[],z=0;z<c;)if(s.test(f[z])){var R=z;for(++z;z<c&&s.test(f[z]);++z);I.push(new t(0,R,z))}else{var B=z,G=I.length;for(++z;z<c&&"L"!=f[z];++z);for(var U=B;U<z;)if(a.test(f[U])){B<U&&I.splice(G,0,new t(1,B,U));var V=U;for(++U;U<z&&a.test(f[U]);++U);I.splice(G,0,new t(2,V,U)),B=U}else++U;B<z&&I.splice(G,0,new t(1,B,z))}return 1==I[0].level&&(P=r.match(/^\s+/))&&(I[0].from=P[0].length,I.unshift(new t(0,0,P[0].length))),1==g(I).level&&(P=r.match(/\s+$/))&&(g(I).to-=P[0].length,I.push(new t(0,c-P[0].length,c))),"rtl"==n?I.reverse():I}}(),Zl=[],Ql=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});n[t]=(n[t]||Zl).concat(r)}},Jl=function(){if(gl&&vl<9)return!1;var e=n("div");return"draggable"in e||"dragDrop"in e}(),es=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var i=e.indexOf("\n",t);-1==i&&(i=e.length);var o=e.slice(t,"\r"==e.charAt(i-1)?i-1:i),l=o.indexOf("\r");-1!=l?(r.push(o.slice(0,l)),t+=l+1):(r.push(o),t=i+1)}return r}:function(e){return e.split(/\r\n?|\n/)},ts=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},rs=function(){var e=n("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),ns=null,is={},os={},ls={},ss=function(e,t,r){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=r};ss.prototype.eol=function(){return this.pos>=this.string.length},ss.prototype.sol=function(){return this.pos==this.lineStart},ss.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},ss.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},ss.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},ss.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},ss.prototype.eatSpace=function(){for(var e=this,t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++e.pos;return this.pos>t},ss.prototype.skipToEnd=function(){this.pos=this.string.length},ss.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},ss.prototype.backUp=function(e){this.pos-=e},ss.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=f(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.indentation=function(){return f(this.string,null,this.tabSize)-(this.lineStart?f(this.string,this.lineStart,this.tabSize):0)},ss.prototype.match=function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var i=function(e){return r?e.toLowerCase():e};if(i(this.string.substr(this.pos,e.length))==i(e))return!1!==t&&(this.pos+=e.length),!0},ss.prototype.current=function(){return this.string.slice(this.start,this.pos)},ss.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},ss.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)};var as=function(e,t){this.state=e,this.lookAhead=t},us=function(e,t,r,n){this.state=t,this.doc=e,this.line=r,this.maxLookAhead=n||0};us.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},us.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},us.fromSaved=function(e,t,r){return t instanceof as?new us(e,Ke(e.mode,t.state),r,t.lookAhead):new us(e,Ke(e.mode,t),r)},us.prototype.save=function(e){var t=!1!==e?Ke(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new as(t,this.maxLookAhead):t};var cs=function(e,t,r){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=r},fs=function(e,t,r){this.text=e,ne(this,t),this.height=r?r(this):1};fs.prototype.lineNo=function(){return W(this)},Ae(fs);var hs,ds={},ps={},gs=null,vs=null,ms={left:0,right:0,top:0,bottom:0},ys=function(e,t,r){this.cm=r;var i=this.vert=n("div",[n("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),o=this.horiz=n("div",[n("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");e(i),e(o),Ql(i,"scroll",function(){i.clientHeight&&t(i.scrollTop,"vertical")}),Ql(o,"scroll",function(){o.clientWidth&&t(o.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,gl&&vl<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};ys.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,r=e.scrollHeight>e.clientHeight+1,n=e.nativeBarWidth;if(r){this.vert.style.display="block",this.vert.style.bottom=t?n+"px":"0";var i=e.viewHeight-(t?n:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+i)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=r?n+"px":"0",this.horiz.style.left=e.barLeft+"px";var o=e.viewWidth-e.barLeft-(r?n:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+o)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==n&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:r?n:0,bottom:t?n:0}},ys.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},ys.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},ys.prototype.zeroWidthHack=function(){var e=Ml&&!Cl?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pl,this.disableVert=new Pl},ys.prototype.enableZeroWidthBar=function(e,t,r){function n(){var i=e.getBoundingClientRect();("vert"==r?document.elementFromPoint(i.right-1,(i.top+i.bottom)/2):document.elementFromPoint((i.right+i.left)/2,i.bottom-1))!=e?e.style.pointerEvents="none":t.set(1e3,n)}e.style.pointerEvents="auto",t.set(1e3,n)},ys.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var bs=function(){};bs.prototype.update=function(){return{bottom:0,right:0}},bs.prototype.setScrollLeft=function(){},bs.prototype.setScrollTop=function(){},bs.prototype.clear=function(){};var ws={native:ys,null:bs},xs=0,Cs=function(e,t,r){var n=e.display;this.viewport=t,this.visible=Ir(n,e.doc,t),this.editorIsHidden=!n.wrapper.offsetWidth,this.wrapperHeight=n.wrapper.clientHeight,this.wrapperWidth=n.wrapper.clientWidth,this.oldDisplayWidth=Rt(e),this.force=r,this.dims=br(e),this.events=[]};Cs.prototype.signal=function(e,t){Oe(e,t)&&this.events.push(arguments)},Cs.prototype.finish=function(){for(var e=this,t=0;t<this.events.length;t++)Te.apply(null,e.events[t])};var Ss=0,Ls=null;gl?Ls=-.53:fl?Ls=15:bl?Ls=-.7:xl&&(Ls=-1/3);var ks=function(e,t){this.ranges=e,this.primIndex=t};ks.prototype.primary=function(){return this.ranges[this.primIndex]},ks.prototype.equals=function(e){var t=this;if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var r=0;r<this.ranges.length;r++){var n=t.ranges[r],i=e.ranges[r];if(!I(n.anchor,i.anchor)||!I(n.head,i.head))return!1}return!0},ks.prototype.deepCopy=function(){for(var e=this,t=[],r=0;r<this.ranges.length;r++)t[r]=new Ts(z(e.ranges[r].anchor),z(e.ranges[r].head));return new ks(t,this.primIndex)},ks.prototype.somethingSelected=function(){for(var e=this,t=0;t<this.ranges.length;t++)if(!e.ranges[t].empty())return!0;return!1},ks.prototype.contains=function(e,t){var r=this;t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=r.ranges[n];if(P(t,i.from())>=0&&P(e,i.to())<=0)return n}return-1};var Ts=function(e,t){this.anchor=e,this.head=t};Ts.prototype.from=function(){return B(this.anchor,this.head)},Ts.prototype.to=function(){return R(this.anchor,this.head)},Ts.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},Bi.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=this,n=e,i=e+t;n<i;++n){var o=r.lines[n];r.height-=o.height,ot(o),bt(o,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){var n=this;this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=n},iterN:function(e,t,r){for(var n=this,i=e+t;e<i;++e)if(r(n.lines[e]))return!0}},Gi.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){var r=this;this.size-=t;for(var n=0;n<this.children.length;++n){var i=r.children[n],o=i.chunkSize();if(e<o){var l=Math.min(t,o-e),s=i.height;if(i.removeInner(e,l),r.height-=s-i.height,o==l&&(r.children.splice(n--,1),i.parent=null),0==(t-=l))break;e=0}else e-=o}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof Bi))){var a=[];this.collapse(a),this.children=[new Bi(a)],this.children[0].parent=this}},collapse:function(e){for(var t=this,r=0;r<this.children.length;++r)t.children[r].collapse(e)},insertInner:function(e,t,r){var n=this;this.size+=t.length,this.height+=r;for(var i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<=l){if(o.insertInner(e,t,r),o.lines&&o.lines.length>50){for(var s=o.lines.length%25+25,a=s;a<o.lines.length;){var u=new Bi(o.lines.slice(a,a+=25));o.height-=u.height,n.children.splice(++i,0,u),u.parent=n}o.lines=o.lines.slice(0,s),n.maybeSpill()}break}e-=l}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new Gi(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=h(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new Gi(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=this,i=0;i<this.children.length;++i){var o=n.children[i],l=o.chunkSize();if(e<l){var s=Math.min(t,l-e);if(o.iterN(e,s,r))return!0;if(0==(t-=s))break;e=0}else e-=l}}};var Ms=function(e,t,r){var n=this;if(r)for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);this.doc=e,this.node=t};Ms.prototype.clear=function(){var e=this,t=this.doc.cm,r=this.line.widgets,n=this.line,i=W(n);if(null!=i&&r){for(var o=0;o<r.length;++o)r[o]==e&&r.splice(o--,1);r.length||(n.widgets=null);var l=Ht(this);A(n,Math.max(0,n.height-l)),t&&(hn(t,function(){Ui(t,n,-l),mn(t,i,"widget")}),bt(t,"lineWidgetCleared",t,this,i))}},Ms.prototype.changed=function(){var e=this,t=this.height,r=this.doc.cm,n=this.line;this.height=null;var i=Ht(this)-t;i&&(A(n,n.height+i),r&&hn(r,function(){r.curOp.forceUpdate=!0,Ui(r,n,i),bt(r,"lineWidgetChanged",r,e,W(n))}))},Ae(Ms);var Ns=0,Os=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++Ns};Os.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){var t=this.doc.cm,r=t&&!t.curOp;if(r&&nn(t),Oe(this,"clear")){var n=this.find();n&&bt(this,"clear",n.from,n.to)}for(var i=null,o=null,l=0;l<this.lines.length;++l){var s=e.lines[l],a=_(s.markedSpans,e);t&&!e.collapsed?mn(t,W(s),"text"):t&&(null!=a.to&&(o=W(s)),null!=a.from&&(i=W(s))),s.markedSpans=$(s.markedSpans,a),null==a.from&&e.collapsed&&!ve(e.doc,s)&&t&&A(s,mr(t.display))}if(t&&this.collapsed&&!t.options.lineWrapping)for(var u=0;u<this.lines.length;++u){var c=fe(e.lines[u]),f=be(c);f>t.display.maxLineLength&&(t.display.maxLine=c,t.display.maxLineLength=f,t.display.maxLineChanged=!0)}null!=i&&t&&this.collapsed&&vn(t,i,o+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,t&&Ci(t.doc)),t&&bt(t,"markerCleared",t,this,i,o),r&&on(t),this.parent&&this.parent.clear()}},Os.prototype.find=function(e,t){var r=this;null==e&&"bookmark"==this.type&&(e=1);for(var n,i,o=0;o<this.lines.length;++o){var l=r.lines[o],s=_(l.markedSpans,r);if(null!=s.from&&(n=E(t?l:W(l),s.from),-1==e))return n;if(null!=s.to&&(i=E(t?l:W(l),s.to),1==e))return i}return n&&{from:n,to:i}},Os.prototype.changed=function(){var e=this,t=this.find(-1,!0),r=this,n=this.doc.cm;t&&n&&hn(n,function(){var i=t.line,o=W(t.line),l=jt(n,o);if(l&&(Qt(l),n.curOp.selectionChanged=n.curOp.forceUpdate=!0),n.curOp.updateMaxLine=!0,!ve(r.doc,i)&&null!=r.height){var s=r.height;r.height=null;var a=Ht(r)-s;a&&A(i,i.height+a)}bt(n,"markerChanged",n,e)})},Os.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=h(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},Os.prototype.detachLine=function(e){if(this.lines.splice(h(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ae(Os);var As=function(e,t){var r=this;this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=r};As.prototype.clear=function(){var e=this;if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var t=0;t<this.markers.length;++t)e.markers[t].clear();bt(this,"clear")}},As.prototype.find=function(e,t){return this.primary.find(e,t)},Ae(As);var Ws=0,Ds=function(e,t,r,n,i){if(!(this instanceof Ds))return new Ds(e,t,r,n,i);null==r&&(r=0),Gi.call(this,[new Bi([new fs("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=r;var o=E(r,0);this.sel=Rn(o),this.history=new Jn(null),this.id=++Ws,this.modeOption=t,this.lineSep=n,this.direction="rtl"==i?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),_n(this,{from:o,to:o,text:e}),bi(this,Rn(o),Gl)};Ds.prototype=b(Gi.prototype,{constructor:Ds,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=O(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:gn(function(e){var t=E(this.first,0),r=this.first+this.size-1;Oi(this,{from:t,to:E(r,M(this,r).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&Xr(this.cm,0,0),bi(this,Rn(t),Gl)}),replaceRange:function(e,t,r,n){Ei(this,e,t=U(this,t),r=r?U(this,r):t,n)},getRange:function(e,t,r){var n=N(this,U(this,e),U(this,t));return!1===r?n:n.join(r||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(H(this,e))return M(this,e)},getLineNumber:function(e){return W(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=M(this,e)),fe(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return U(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:gn(function(e,t,r){vi(this,U(this,"number"==typeof e?E(e,t||0):e),null,r)}),setSelection:gn(function(e,t,r){vi(this,U(this,e),U(this,t||e),r)}),extendSelection:gn(function(e,t,r){di(this,U(this,e),t&&U(this,t),r)}),extendSelections:gn(function(e,t){pi(this,K(this,e),t)}),extendSelectionsBy:gn(function(e,t){pi(this,K(this,v(this.sel.ranges,e)),t)}),setSelections:gn(function(e,t,r){var n=this;if(e.length){for(var i=[],o=0;o<e.length;o++)i[o]=new Ts(U(n,e[o].anchor),U(n,e[o].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),bi(this,zn(i,t),r)}}),addSelection:gn(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new Ts(U(this,e),U(this,t||e))),bi(this,zn(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this,n=this.sel.ranges,i=0;i<n.length;i++){var o=N(r,n[i].from(),n[i].to());t=t?t.concat(o):o}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=this,r=[],n=this.sel.ranges,i=0;i<n.length;i++){var o=N(t,n[i].from(),n[i].to());!1!==e&&(o=o.join(e||t.lineSeparator())),r[i]=o}return r},replaceSelection:function(e,t,r){for(var n=[],i=0;i<this.sel.ranges.length;i++)n[i]=e;this.replaceSelections(n,t,r||"+input")},replaceSelections:gn(function(e,t,r){for(var n=this,i=[],o=this.sel,l=0;l<o.ranges.length;l++){var s=o.ranges[l];i[l]={from:s.from(),to:s.to(),text:n.splitLines(e[l]),origin:r}}for(var a=t&&"end"!=t&&Kn(this,i,t),u=i.length-1;u>=0;u--)Oi(n,i[u]);a?yi(this,a):this.cm&&jr(this.cm)}),undo:gn(function(){Wi(this,"undo")}),redo:gn(function(){Wi(this,"redo")}),undoSelection:gn(function(){Wi(this,"undo",!0)}),redoSelection:gn(function(){Wi(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(var i=0;i<e.undone.length;i++)e.undone[i].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new Jn(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:fi(this.history.done),undone:fi(this.history.undone)}},setHistory:function(e){var t=this.history=new Jn(this.history.maxGeneration);t.done=fi(e.done.slice(0),null,!0),t.undone=fi(e.undone.slice(0),null,!0)},setGutterMarker:gn(function(e,t,r){return Ri(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&C(n)&&(e.gutterMarkers=null),!0})}),clearGutter:gn(function(e){var t=this;this.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&Ri(t,r,"gutter",function(){return r.gutterMarkers[e]=null,C(r.gutterMarkers)&&(r.gutterMarkers=null),!0})})}),lineInfo:function(e){var t;if("number"==typeof e){if(!H(this,e))return null;if(t=e,!(e=M(this,e)))return null}else if(null==(t=W(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass";if(t[i]){if(e(n).test(t[i]))return!1;t[i]+=" "+n}else t[i]=n;return!0})}),removeLineClass:gn(function(t,r,n){return Ri(this,t,"gutter"==r?"gutter":"class",function(t){var i="text"==r?"textClass":"background"==r?"bgClass":"gutter"==r?"gutterClass":"wrapClass",o=t[i];if(!o)return!1;if(null==n)t[i]=null;else{var l=o.match(e(n));if(!l)return!1;var s=l.index+l[0].length;t[i]=o.slice(0,l.index)+(l.index&&s!=o.length?" ":"")+o.slice(s)||null}return!0})}),addLineWidget:gn(function(e,t,r){return Vi(this,e,t,r)}),removeLineWidget:function(e){e.clear()},markText:function(e,t,r){return Ki(this,U(this,e),U(this,t),r,r&&r.type||"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return e=U(this,e),Ki(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=M(this,(e=U(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var i=r[n];(null==i.from||i.from<=e.ch)&&(null==i.to||i.to>=e.ch)&&t.push(i.marker.parent||i.marker)}return t},findMarks:function(e,t,r){e=U(this,e),t=U(this,t);var n=[],i=e.line;return this.iter(e.line,t.line+1,function(o){var l=o.markedSpans;if(l)for(var s=0;s<l.length;s++){var a=l[s];null!=a.to&&i==e.line&&e.ch>=a.to||null==a.from&&i!=e.line||null!=a.from&&i==t.line&&a.from>=t.ch||r&&!r(a.marker)||n.push(a.marker.parent||a.marker)}++i}),n},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first,n=this.lineSeparator().length;return this.iter(function(i){var o=i.text.length+n;if(o>e)return t=e,!0;e-=o,++r}),U(this,E(r,t))},indexFromPos:function(e){var t=(e=U(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var r=this.lineSeparator().length;return this.iter(this.first,e.line,function(e){t+=e.text.length+r}),t},copy:function(e){var t=new Ds(O(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new Ds(O(this,t,r),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],Yi(n,Xi(this)),n},unlinkDoc:function(e){var t=this;if(e instanceof jo&&(e=e.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(t.linked[r].doc==e){t.linked.splice(r,1),e.unlinkDoc(t),_i(Xi(t));break}if(e.history==this.history){var n=[e.id];$n(e,function(e){return n.push(e.id)},!0),e.history=new Jn(null),e.history.done=fi(this.history.done,n),e.history.undone=fi(this.history.undone,n)}},iterLinkedDocs:function(e){$n(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):es(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:gn(function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter(function(e){return e.order=null}),this.cm&&Qn(this.cm))})}),Ds.prototype.eachLine=Ds.prototype.iter;for(var Hs=0,Fs=!1,Es={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Ps=0;Ps<10;Ps++)Es[Ps+48]=Es[Ps+96]=String(Ps);for(var Is=65;Is<=90;Is++)Es[Is]=String.fromCharCode(Is);for(var zs=1;zs<=12;zs++)Es[zs+111]=Es[zs+63235]="F"+zs;var Rs={};Rs.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Rs.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Rs.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Rs.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Rs.default=Ml?Rs.macDefault:Rs.pcDefault;var Bs={selectAll:Mi,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Gl)},killLine:function(e){return co(e,function(t){if(t.empty()){var r=M(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:E(t.head.line+1,0)}:{from:t.head,to:E(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){return co(e,function(t){return{from:E(t.from().line,0),to:U(e.doc,E(t.to().line+1,0))}})},delLineLeft:function(e){return co(e,function(e){return{from:E(e.from().line,0),to:e.from()}})},delWrappedLineLeft:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:r},"div"),to:t.from()}})},delWrappedLineRight:function(e){return co(e,function(t){var r=e.charCoords(t.head,"div").top+5,n=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div");return{from:t.from(),to:n}})},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(E(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(E(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy(function(t){return vo(e,t.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy(function(t){return yo(e,t.head)},{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy(function(t){return mo(e,t.head.line)},{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Vl)},goLineLeft:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Vl)},goLineLeftSmart:function(e){return e.extendSelectionsBy(function(t){var r=e.cursorCoords(t.head,"div").top+5,n=e.coordsChar({left:0,top:r},"div");return n.ch<e.getLine(n.line).search(/\S/)?yo(e,t.head):n},Vl)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"char")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],r=e.listSelections(),n=e.options.tabSize,i=0;i<r.length;i++){var o=r[i].from(),l=f(e.getLine(o.line),o.ch,n);t.push(p(n-l%n))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return hn(e,function(){for(var t=e.listSelections(),r=[],n=0;n<t.length;n++)if(t[n].empty()){var i=t[n].head,o=M(e.doc,i.line).text;if(o)if(i.ch==o.length&&(i=new E(i.line,i.ch-1)),i.ch>0)i=new E(i.line,i.ch+1),e.replaceRange(o.charAt(i.ch-1)+o.charAt(i.ch-2),E(i.line,i.ch-2),i,"+transpose");else if(i.line>e.doc.first){var l=M(e.doc,i.line-1).text;l&&(i=new E(i.line,1),e.replaceRange(o.charAt(0)+e.doc.lineSeparator()+l.charAt(l.length-1),E(i.line-1,l.length-1),i,"+transpose"))}r.push(new Ts(i,i))}e.setSelections(r)})},newlineAndIndent:function(e){return hn(e,function(){for(var t=e.listSelections(),r=t.length-1;r>=0;r--)e.replaceRange(e.doc.lineSeparator(),t[r].anchor,t[r].head,"+input");t=e.listSelections();for(var n=0;n<t.length;n++)e.indentLine(t[n].from().line,null,!0);jr(e)})},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}},Gs=new Pl,Us=null,Vs=function(e,t,r){this.time=e,this.pos=t,this.button=r};Vs.prototype.compare=function(e,t,r){return this.time+400>e&&0==P(t,this.pos)&&r==this.button};var Ks,js,Xs={toString:function(){return"CodeMirror.Init"}},Ys={},_s={};jo.defaults=Ys,jo.optionHandlers=_s;var $s=[];jo.defineInitHook=function(e){return $s.push(e)};var qs=null,Zs=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pl,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Zs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation(function(){i.setSelections(t.ranges,0,Gl),i.replaceSelection("",null,"cut")})}if(e.clipboardData){e.clipboardData.clearData();var r=qs.text.join("\n");if(e.clipboardData.setData("Text",r),e.clipboardData.getData("Text")==r)return void e.preventDefault()}var l=el(),s=l.firstChild;i.display.lineSpace.insertBefore(l,i.display.lineSpace.firstChild),s.value=qs.text.join("\n");var a=document.activeElement;El(s),setTimeout(function(){i.display.lineSpace.removeChild(l),a.focus(),a==o&&n.showPrimarySelection()},50)}}var r=this,n=this,i=n.cm,o=n.div=e.lineDiv;Jo(o,i.options.spellcheck),Ql(o,"paste",function(e){Me(i,e)||qo(e,i)||vl<=11&&setTimeout(dn(i,function(){return r.updateFromDOM()}),20)}),Ql(o,"compositionstart",function(e){r.composing={data:e.data,done:!1}}),Ql(o,"compositionupdate",function(e){r.composing||(r.composing={data:e.data,done:!1})}),Ql(o,"compositionend",function(e){r.composing&&(e.data!=r.composing.data&&r.readFromDOMSoon(),r.composing.done=!0)}),Ql(o,"touchstart",function(){return n.forceCompositionEnd()}),Ql(o,"input",function(){r.composing||r.readFromDOMSoon()}),Ql(o,"copy",t),Ql(o,"cut",t)},Zs.prototype.prepareSelection=function(){var e=Tr(this.cm,!1);return e.focus=this.cm.state.focused,e},Zs.prototype.showSelection=function(e,t){e&&this.cm.display.view.length&&((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},Zs.prototype.showPrimarySelection=function(){var e=window.getSelection(),t=this.cm,r=t.doc.sel.primary(),n=r.from(),i=r.to();if(t.display.viewTo==t.display.viewFrom||n.line>=t.display.viewTo||i.line<t.display.viewFrom)e.removeAllRanges();else{var o=sl(t,e.anchorNode,e.anchorOffset),l=sl(t,e.focusNode,e.focusOffset);if(!o||o.bad||!l||l.bad||0!=P(B(o,l),n)||0!=P(R(o,l),i)){var s=t.display.view,a=n.line>=t.display.viewFrom&&nl(t,n)||{node:s[0].measure.map[2],offset:0},u=i.line<t.display.viewTo&&nl(t,i);if(!u){var c=s[s.length-1].measure,f=c.maps?c.maps[c.maps.length-1]:c.map;u={node:f[f.length-1],offset:f[f.length-2]-f[f.length-3]}}if(a&&u){var h,d=e.rangeCount&&e.getRangeAt(0);try{h=Wl(a.node,a.offset,u.offset,u.node)}catch(e){}h&&(!fl&&t.state.focused?(e.collapse(a.node,a.offset),h.collapsed||(e.removeAllRanges(),e.addRange(h))):(e.removeAllRanges(),e.addRange(h)),d&&null==e.anchorNode?e.addRange(d):fl&&this.startGracePeriod()),this.rememberSelection()}else e.removeAllRanges()}}},Zs.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation(function(){return e.cm.curOp.selectionChanged=!0})},20)},Zs.prototype.showMultipleSelections=function(e){r(this.cm.display.cursorDiv,e.cursors),r(this.cm.display.selectionDiv,e.selection)},Zs.prototype.rememberSelection=function(){var e=window.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},Zs.prototype.selectionInEditor=function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return o(this.div,t)},Zs.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&(this.selectionInEditor()||this.showSelection(this.prepareSelection(),!0),this.div.focus())},Zs.prototype.blur=function(){this.div.blur()},Zs.prototype.getField=function(){return this.div},Zs.prototype.supportsTouch=function(){return!0},Zs.prototype.receivedFocus=function(){function e(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,e))}var t=this;this.selectionInEditor()?this.pollSelection():hn(this.cm,function(){return t.cm.curOp.selectionChanged=!0}),this.polling.set(this.cm.options.pollInterval,e)},Zs.prototype.selectionChanged=function(){var e=window.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},Zs.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=window.getSelection(),t=this.cm;if(kl&&bl&&this.cm.options.gutters.length&&il(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var r=sl(t,e.anchorNode,e.anchorOffset),n=sl(t,e.focusNode,e.focusOffset);r&&n&&hn(t,function(){bi(t.doc,Rn(r,n),Gl),(r.bad||n.bad)&&(t.curOp.selectionChanged=!0)})}}},Zs.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e=this.cm,t=e.display,r=e.doc.sel.primary(),n=r.from(),i=r.to();if(0==n.ch&&n.line>e.firstLine()&&(n=E(n.line-1,M(e.doc,n.line-1).length)),i.ch==M(e.doc,i.line).text.length&&i.line<e.lastLine()&&(i=E(i.line+1,0)),n.line<t.viewFrom||i.line>t.viewTo-1)return!1;var o,l,s;n.line==t.viewFrom||0==(o=Lr(e,n.line))?(l=W(t.view[0].line),s=t.view[0].node):(l=W(t.view[o].line),s=t.view[o-1].node.nextSibling);var a,u,c=Lr(e,i.line);if(c==t.view.length-1?(a=t.viewTo-1,u=t.lineDiv.lastChild):(a=W(t.view[c+1].line)-1,u=t.view[c+1].node.previousSibling),!s)return!1;for(var f=e.doc.splitLines(ll(e,s,u,l,a)),h=N(e.doc,E(l,0),E(a,M(e.doc,a).text.length));f.length>1&&h.length>1;)if(g(f)==g(h))f.pop(),h.pop(),a--;else{if(f[0]!=h[0])break;f.shift(),h.shift(),l++}for(var d=0,p=0,v=f[0],m=h[0],y=Math.min(v.length,m.length);d<y&&v.charCodeAt(d)==m.charCodeAt(d);)++d;for(var b=g(f),w=g(h),x=Math.min(b.length-(1==f.length?d:0),w.length-(1==h.length?d:0));p<x&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)++p;if(1==f.length&&1==h.length&&l==n.line)for(;d&&d>n.ch&&b.charCodeAt(b.length-p-1)==w.charCodeAt(w.length-p-1);)d--,p++;f[f.length-1]=b.slice(0,b.length-p).replace(/^\u200b+/,""),f[0]=f[0].slice(d).replace(/\u200b+$/,"");var C=E(l,d),S=E(a,h.length?g(h).length-p:0);return f.length>1||f[0]||P(C,S)?(Ei(e.doc,f,C,S,"+input"),!0):void 0},Zs.prototype.ensurePolled=function(){this.forceCompositionEnd()},Zs.prototype.reset=function(){this.forceCompositionEnd()},Zs.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Zs.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout(function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()},80))},Zs.prototype.updateFromDOM=function(){var e=this;!this.cm.isReadOnly()&&this.pollContent()||hn(this.cm,function(){return vn(e.cm)})},Zs.prototype.setUneditable=function(e){e.contentEditable="false"},Zs.prototype.onKeyPress=function(e){0!=e.charCode&&(e.preventDefault(),this.cm.isReadOnly()||dn(this.cm,$o)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},Zs.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},Zs.prototype.onContextMenu=function(){},Zs.prototype.resetPosition=function(){},Zs.prototype.needsContentAttribute=!0;var Qs=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new Pl,this.hasSelection=!1,this.composing=null};Qs.prototype.init=function(e){function t(e){if(!Me(i,e)){if(i.somethingSelected())_o({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Qo(i);_o({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,Gl):(n.prevInput="",l.value=t.text.join("\n"),El(l))}"cut"==e.type&&(i.state.cutIncoming=!0)}}var r=this,n=this,i=this.cm,o=this.wrapper=el(),l=this.textarea=o.firstChild;e.wrapper.insertBefore(o,e.wrapper.firstChild),Ll&&(l.style.width="0px"),Ql(l,"input",function(){gl&&vl>=9&&r.hasSelection&&(r.hasSelection=null),n.poll()}),Ql(l,"paste",function(e){Me(i,e)||qo(e,i)||(i.state.pasteIncoming=!0,n.fastPoll())}),Ql(l,"cut",t),Ql(l,"copy",t),Ql(e.scroller,"paste",function(t){Ft(e,t)||Me(i,t)||(i.state.pasteIncoming=!0,n.focus())}),Ql(e.lineSpace,"selectstart",function(t){Ft(e,t)||We(t)}),Ql(l,"compositionstart",function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}}),Ql(l,"compositionend",function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)})},Qs.prototype.prepareSelection=function(){var e=this.cm,t=e.display,r=e.doc,n=Tr(e);if(e.options.moveInputWithCursor){var i=sr(e,r.sel.primary().head,"div"),o=t.wrapper.getBoundingClientRect(),l=t.lineDiv.getBoundingClientRect();n.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,i.top+l.top-o.top)),n.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,i.left+l.left-o.left))}return n},Qs.prototype.showSelection=function(e){var t=this.cm.display;r(t.cursorDiv,e.cursors),r(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},Qs.prototype.reset=function(e){if(!this.contextMenuPending&&!this.composing){var t=this.cm;if(t.somethingSelected()){this.prevInput="";var r=t.getSelection();this.textarea.value=r,t.state.focused&&El(this.textarea),gl&&vl>=9&&(this.hasSelection=r)}else e||(this.prevInput=this.textarea.value="",gl&&vl>=9&&(this.hasSelection=null))}},Qs.prototype.getField=function(){return this.textarea},Qs.prototype.supportsTouch=function(){return!1},Qs.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!Tl||l()!=this.textarea))try{this.textarea.focus()}catch(e){}},Qs.prototype.blur=function(){this.textarea.blur()},Qs.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Qs.prototype.receivedFocus=function(){this.slowPoll()},Qs.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){e.poll(),e.cm.state.focused&&e.slowPoll()})},Qs.prototype.fastPoll=function(){function e(){r.poll()||t?(r.pollingFast=!1,r.slowPoll()):(t=!0,r.polling.set(60,e))}var t=!1,r=this;r.pollingFast=!0,r.polling.set(20,e)},Qs.prototype.poll=function(){var e=this,t=this.cm,r=this.textarea,n=this.prevInput;if(this.contextMenuPending||!t.state.focused||ts(r)&&!n&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var i=r.value;if(i==n&&!t.somethingSelected())return!1;if(gl&&vl>=9&&this.hasSelection===i||Ml&&/[\uf700-\uf7ff]/.test(i))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var o=i.charCodeAt(0);if(8203!=o||n||(n="​"),8666==o)return this.reset(),this.cm.execCommand("undo")}for(var l=0,s=Math.min(n.length,i.length);l<s&&n.charCodeAt(l)==i.charCodeAt(l);)++l;return hn(t,function(){$o(t,i.slice(l),n.length-l,null,e.composing?"*compose":null),i.length>1e3||i.indexOf("\n")>-1?r.value=e.prevInput="":e.prevInput=i,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Qs.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Qs.prototype.onKeyPress=function(){gl&&vl>=9&&(this.hasSelection=null),this.fastPoll()},Qs.prototype.onContextMenu=function(e){function t(){if(null!=l.selectionStart){var e=i.somethingSelected(),t="​"+(e?l.value:"");l.value="⇚",l.value=t,n.prevInput=e?"":"​",l.selectionStart=1,l.selectionEnd=t.length,o.selForContextMenu=i.doc.sel}}function r(){if(n.contextMenuPending=!1,n.wrapper.style.cssText=c,l.style.cssText=u,gl&&vl<9&&o.scrollbars.setScrollTop(o.scroller.scrollTop=a),null!=l.selectionStart){(!gl||gl&&vl<9)&&t();var e=0,r=function(){o.selForContextMenu==i.doc.sel&&0==l.selectionStart&&l.selectionEnd>0&&"​"==n.prevInput?dn(i,Mi)(i):e++<10?o.detectingSelectAll=setTimeout(r,500):(o.selForContextMenu=null,o.input.reset())};o.detectingSelectAll=setTimeout(r,200)}}var n=this,i=n.cm,o=i.display,l=n.textarea,s=Sr(i,e),a=o.scroller.scrollTop;if(s&&!wl){i.options.resetSelectionOnContextMenu&&-1==i.doc.sel.contains(s)&&dn(i,bi)(i.doc,Rn(s),Gl);var u=l.style.cssText,c=n.wrapper.style.cssText;n.wrapper.style.cssText="position: absolute";var f=n.wrapper.getBoundingClientRect();l.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(gl?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";var h;if(ml&&(h=window.scrollY),o.input.focus(),ml&&window.scrollTo(null,h),o.input.reset(),i.somethingSelected()||(l.value=n.prevInput=" "),n.contextMenuPending=!0,o.selForContextMenu=i.doc.sel,clearTimeout(o.detectingSelectAll),gl&&vl>=9&&t(),Hl){Fe(e);var d=function(){ke(window,"mouseup",d),setTimeout(r,20)};Ql(window,"mouseup",d)}else setTimeout(r,50)}},Qs.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e},Qs.prototype.setUneditable=function(){},Qs.prototype.needsContentAttribute=!1,function(e){function t(t,n,i,o){e.defaults[t]=n,i&&(r[t]=o?function(e,t,r){r!=Xs&&i(e,t,r)}:i)}var r=e.optionHandlers;e.defineOption=t,e.Init=Xs,t("value","",function(e,t){return e.setValue(t)},!0),t("mode",null,function(e,t){e.doc.modeOption=t,jn(e)},!0),t("indentUnit",2,jn,!0),t("indentWithTabs",!1),t("smartIndent",!0),t("tabSize",4,function(e){Xn(e),er(e),vn(e)},!0),t("lineSeparator",null,function(e,t){if(e.doc.lineSep=t,t){var r=[],n=e.doc.first;e.doc.iter(function(e){for(var i=0;;){var o=e.text.indexOf(t,i);if(-1==o)break;i=o+t.length,r.push(E(n,o))}n++});for(var i=r.length-1;i>=0;i--)Ei(e.doc,t,r[i],E(r[i].line,r[i].ch+t.length))}}),t("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g,function(e,t,r){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),r!=Xs&&e.refresh()}),t("specialCharPlaceholder",at,function(e){return e.refresh()},!0),t("electricChars",!0),t("inputStyle",Tl?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),t("spellcheck",!1,function(e,t){return e.getInputField().spellcheck=t},!0),t("rtlMoveVisually",!Ol),t("wholeLineUpdateBefore",!0),t("theme","default",function(e){Go(e),Uo(e)},!0),t("keyMap","default",function(e,t,r){var n=uo(t),i=r!=Xs&&uo(r);i&&i.detach&&i.detach(e,n),n.attach&&n.attach(e,i||null)}),t("extraKeys",null),t("configureMouse",null),t("lineWrapping",!1,Ko,!0),t("gutters",[],function(e){Fn(e.options),Uo(e)},!0),t("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?wr(e.display)+"px":"0",e.refresh()},!0),t("coverGutterNextToScrollbar",!1,function(e){return en(e)},!0),t("scrollbarStyle","native",function(e){rn(e),en(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)},!0),t("lineNumbers",!1,function(e){Fn(e.options),Uo(e)},!0),t("firstLineNumber",1,Uo,!0),t("lineNumberFormatter",function(e){return e},Uo,!0),t("showCursorWhenSelecting",!1,kr,!0),t("resetSelectionOnContextMenu",!0),t("lineWiseCopyCut",!0),t("pasteLinesPerSelection",!0),t("readOnly",!1,function(e,t){"nocursor"==t&&(Fr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)}),t("disableInput",!1,function(e,t){t||e.display.input.reset()},!0),t("dragDrop",!0,Vo),t("allowDropFileTypes",null),t("cursorBlinkRate",530),t("cursorScrollMargin",0),t("cursorHeight",1,kr,!0),t("singleCursorHeightPerLine",!0,kr,!0),t("workTime",100),t("workDelay",100),t("flattenSpans",!0,Xn,!0),t("addModeClass",!1,Xn,!0),t("pollInterval",100),t("undoDepth",200,function(e,t){return e.doc.history.undoDepth=t}),t("historyEventDelay",1250),t("viewportMargin",10,function(e){return e.refresh()},!0),t("maxHighlightLength",1e4,Xn,!0),t("moveInputWithCursor",!0,function(e,t){t||e.display.input.resetPosition()}),t("tabindex",null,function(e,t){return e.display.input.getField().tabIndex=t||""}),t("autofocus",null),t("direction","ltr",function(e,t){return e.doc.setDirection(t)},!0)}(jo),function(e){var t=e.optionHandlers,r=e.helpers={};e.prototype={constructor:e,focus:function(){window.focus(),this.display.input.focus()},setOption:function(e,r){var n=this.options,i=n[e];n[e]==r&&"mode"!=e||(n[e]=r,t.hasOwnProperty(e)&&dn(this,t[e])(this,r,i),Te(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](uo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||t[r].name==e)return t.splice(r,1),!0},addOverlay:pn(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");m(this.state.overlays,{mode:n,modeSpec:t,opaque:r&&r.opaque,priority:r&&r.priority||0},function(e){return e.priority}),this.state.modeGen++,vn(this)}),removeOverlay:pn(function(e){for(var t=this,r=this.state.overlays,n=0;n<r.length;++n){var i=r[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return r.splice(n,1),t.state.modeGen++,void vn(t)}}),indentLine:pn(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),H(this.doc,e)&&Yo(this,e,t,r)}),indentSelection:pn(function(e){for(var t=this,r=this.doc.sel.ranges,n=-1,i=0;i<r.length;i++){var o=r[i];if(o.empty())o.head.line>n&&(Yo(t,o.head.line,e,!0),n=o.head.line,i==t.doc.sel.primIndex&&jr(t));else{var l=o.from(),s=o.to(),a=Math.max(n,l.line);n=Math.min(t.lastLine(),s.line-(s.ch?0:1))+1;for(var u=a;u<n;++u)Yo(t,u,e);var c=t.doc.sel.ranges;0==l.ch&&r.length==c.length&&c[i].from().ch>0&&gi(t.doc,i,new Ts(l,c[i].to()),Gl)}}}),getTokenAt:function(e,t){return Je(this,e,t)},getLineTokens:function(e,t){return Je(this,E(e),t,!0)},getTokenTypeAt:function(e){e=U(this.doc,e);var t,r=_e(this,M(this.doc,e.line)),n=0,i=(r.length-1)/2,o=e.ch;if(0==o)t=r[2];else for(;;){var l=n+i>>1;if((l?r[2*l-1]:0)>=o)i=l;else{if(!(r[2*l+1]<o)){t=r[2*l+2];break}n=l+1}}var s=t?t.indexOf("overlay "):-1;return s<0?t:0==s?null:t.slice(0,s-1)},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var n=this,i=[];if(!r.hasOwnProperty(t))return i;var o=r[t],l=this.getModeAt(e);if("string"==typeof l[t])o[l[t]]&&i.push(o[l[t]]);else if(l[t])for(var s=0;s<l[t].length;s++){var a=o[l[t][s]];a&&i.push(a)}else l.helperType&&o[l.helperType]?i.push(o[l.helperType]):o[l.name]&&i.push(o[l.name]);for(var u=0;u<o._global.length;u++){var c=o._global[u];c.pred(l,n)&&-1==h(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var r=this.doc;return e=G(r,null==e?r.first+r.size-1:e),$e(this,e+1,t).state},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?U(this.doc,e):e?n.from():n.to(),sr(this,r,t||"page")},charCoords:function(e,t){return lr(this,U(this.doc,e),t||"page")},coordsChar:function(e,t){return e=or(this,e,t||"page"),cr(this,e.left,e.top)},lineAtHeight:function(e,t){return e=or(this,{top:e,left:0},t||"page").top,D(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,r){var n,i=!1;if("number"==typeof e){var o=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>o&&(e=o,i=!0),n=M(this.doc,e)}else n=e;return ir(this,n,{top:0,left:0},t||"page",r||i).top+(i?this.doc.height-ye(n):0)},defaultTextHeight:function(){return mr(this.display)},defaultCharWidth:function(){return yr(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,i){var o=this.display,l=(e=sr(this,U(this.doc,e))).bottom,s=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),o.sizer.appendChild(t),"over"==n)l=e.top;else if("above"==n||"near"==n){var a=Math.max(o.wrapper.clientHeight,this.doc.height),u=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>a)&&e.top>t.offsetHeight?l=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=a&&(l=e.bottom),s+t.offsetWidth>u&&(s=u-t.offsetWidth)}t.style.top=l+"px",t.style.left=t.style.right="","right"==i?(s=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==i?s=0:"middle"==i&&(s=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=s+"px"),r&&Ur(this,{left:s,top:l,right:s+t.offsetWidth,bottom:l+t.offsetHeight})},triggerOnKeyDown:pn(Lo),triggerOnKeyPress:pn(Mo),triggerOnKeyUp:To,triggerOnMouseDown:pn(Oo),execCommand:function(e){if(Bs.hasOwnProperty(e))return Bs[e].call(null,this)},triggerElectric:pn(function(e){Zo(this,e)}),findPosH:function(e,t,r,n){var i=this,o=1;t<0&&(o=-1,t=-t);for(var l=U(this.doc,e),s=0;s<t&&!(l=tl(i.doc,l,o,r,n)).hitSide;++s);return l},moveH:pn(function(e,t){var r=this;this.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?tl(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Vl)}),deleteH:pn(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):co(this,function(r){var i=tl(n,r.head,e,t,!1);return e<0?{from:i,to:r.head}:{from:r.head,to:i}})}),findPosV:function(e,t,r,n){var i=this,o=1,l=n;t<0&&(o=-1,t=-t);for(var s=U(this.doc,e),a=0;a<t;++a){var u=sr(i,s,"div");if(null==l?l=u.left:u.left=l,(s=rl(i,u,o,r)).hitSide)break}return s},moveV:pn(function(e,t){var r=this,n=this.doc,i=[],o=!this.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(l){if(o)return e<0?l.from():l.to();var s=sr(r,l.head,"div");null!=l.goalColumn&&(s.left=l.goalColumn),i.push(s.left);var a=rl(r,s,e,t);return"page"==t&&l==n.sel.primary()&&Kr(r,lr(r,a,"div").top-s.top),a},Vl),i.length)for(var l=0;l<n.sel.ranges.length;l++)n.sel.ranges[l].goalColumn=i[l]}),findWordAt:function(e){var t=M(this.doc,e.line).text,r=e.ch,n=e.ch;if(t){var i=this.getHelper(e,"wordChars");"before"!=e.sticky&&n!=t.length||!r?++n:--r;for(var o=t.charAt(r),l=x(o,i)?function(e){return x(e,i)}:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!x(e)};r>0&&l(t.charAt(r-1));)--r;for(;n<t.length&&l(t.charAt(n));)++n}return new Ts(E(e.line,r),E(e.line,n))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?s(this.display.cursorDiv,"CodeMirror-overwrite"):Fl(this.display.cursorDiv,"CodeMirror-overwrite"),Te(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==l()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:pn(function(e,t){Xr(this,e,t)}),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-zt(this)-this.display.barHeight,width:e.scrollWidth-zt(this)-this.display.barWidth,clientHeight:Bt(this),clientWidth:Rt(this)}},scrollIntoView:pn(function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:E(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?Yr(this,e):$r(this,e.from,e.to,e.margin)}),setSize:pn(function(e,t){var r=this,n=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=n(e)),null!=t&&(this.display.wrapper.style.height=n(t)),this.options.lineWrapping&&Jt(this);var i=this.display.viewFrom;this.doc.iter(i,this.display.viewTo,function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){mn(r,i,"widget");break}++i}),this.curOp.forceUpdate=!0,Te(this,"refresh",this)}),operation:function(e){return hn(this,e)},startOperation:function(){return nn(this)},endOperation:function(){return on(this)},refresh:pn(function(){var e=this.display.cachedTextHeight;vn(this),this.curOp.forceUpdate=!0,er(this),Xr(this,this.doc.scrollLeft,this.doc.scrollTop),Wn(this),(null==e||Math.abs(e-mr(this.display))>.5)&&Cr(this),Te(this,"refresh",this)}),swapDoc:pn(function(e){var t=this.doc;return t.cm=null,qn(this,e),er(this),this.display.input.reset(),Xr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,bt(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ae(e),e.registerHelper=function(t,n,i){r.hasOwnProperty(t)||(r[t]=e[t]={_global:[]}),r[t][n]=i},e.registerGlobalHelper=function(t,n,i,o){e.registerHelper(t,n,o),r[t]._global.push({pred:i,val:o})}}(jo);var Js="iter insert remove copy getEditor constructor".split(" ");for(var ea in Ds.prototype)Ds.prototype.hasOwnProperty(ea)&&h(Js,ea)<0&&(jo.prototype[ea]=function(e){return function(){return e.apply(this.doc,arguments)}}(Ds.prototype[ea]));return Ae(Ds),jo.inputStyles={textarea:Qs,contenteditable:Zs},jo.defineMode=function(e){jo.defaults.mode||"null"==e||(jo.defaults.mode=e),Be.apply(this,arguments)},jo.defineMIME=function(e,t){os[e]=t},jo.defineMode("null",function(){return{token:function(e){return e.skipToEnd()}}}),jo.defineMIME("text/plain","null"),jo.defineExtension=function(e,t){jo.prototype[e]=t},jo.defineDocExtension=function(e,t){Ds.prototype[e]=t},jo.fromTextArea=function(e,t){function r(){e.value=a.getValue()}if(t=t?c(t):{},t.value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=l();t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}var i;if(e.form&&(Ql(e.form,"submit",r),!t.leaveSubmitMethodAlone)){var o=e.form;i=o.submit;try{var s=o.submit=function(){r(),o.submit=i,o.submit(),o.submit=s}}catch(e){}}t.finishInit=function(t){t.save=r,t.getTextArea=function(){return e},t.toTextArea=function(){t.toTextArea=isNaN,r(),e.parentNode.removeChild(t.getWrapperElement()),e.style.display="",e.form&&(ke(e.form,"submit",r),"function"==typeof e.form.submit&&(e.form.submit=i))}},e.style.display="none";var a=jo(function(t){return e.parentNode.insertBefore(t,e.nextSibling)},t);return a},function(e){e.off=ke,e.on=Ql,e.wheelEventPixels=Pn,e.Doc=Ds,e.splitLines=es,e.countColumn=f,e.findColumn=d,e.isWordChar=w,e.Pass=Bl,e.signal=Te,e.Line=fs,e.changeEnd=Bn,e.scrollbarModel=ws,e.Pos=E,e.cmpPos=P,e.modes=is,e.mimeModes=os,e.resolveMode=Ge,e.getMode=Ue,e.modeExtensions=ls,e.extendMode=Ve,e.copyState=Ke,e.startState=Xe,e.innerMode=je,e.commands=Bs,e.keyMap=Rs,e.keyName=ao,e.isModifierKey=lo,e.lookupKey=oo,e.normalizeKeyMap=io,e.StringStream=ss,e.SharedTextMarker=As,e.TextMarker=Os,e.LineWidget=Ms,e.e_preventDefault=We,e.e_stopPropagation=De,e.e_stop=Fe,e.addClass=s,e.contains=o,e.rmClass=Fl,e.keyNames=Es}(jo),jo.version="5.30.0",jo});
      !function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n,r,o,a){this.indented=e,this.column=t,this.type=n,this.info=r,this.align=o,this.prev=a}function n(e,n,r,o){var a=e.indented;return e.context&&"statement"==e.context.type&&"statement"!=r&&(a=e.context.indented),e.context=new t(a,n,r,o,null,e.context)}function r(e){var t=e.context.type;return")"!=t&&"]"!=t&&"}"!=t||(e.indented=e.context.indented),e.context=e.context.prev}function o(e,t,n){return"variable"==t.prevToken||"type"==t.prevToken||(!!/\S(?:[^- ]>|[*\]])\s*$|\*$/.test(e.string.slice(0,n))||(!(!t.typeAtEndOfLine||e.column()!=e.indentation())||void 0))}function a(e){for(;;){if(!e||"top"==e.type)return!0;if("}"==e.type&&"namespace"!=e.prev.info)return!1;e=e.prev}}function i(e){for(var t={},n=e.split(" "),r=0;r<n.length;++r)t[n[r]]=!0;return t}function l(e,t){return"function"==typeof e?e(t):e.propertyIsEnumerable(t)}function s(e,t){if(!t.startOfLine)return!1;for(var n,r=null;n=e.peek();){if("\\"==n&&e.match(/^.$/)){r=s;break}if("/"==n&&e.match(/^\/[\/\*]/,!1))break;e.next()}return t.tokenize=r,"meta"}function c(e,t){return"type"==t.prevToken&&"type"}function u(e){return e.eatWhile(/[\w\.']/),"number"}function d(e,t){if(e.backUp(1),e.match(/(R|u8R|uR|UR|LR)/)){var n=e.match(/"([^\s\\()]{0,16})\(/);return!!n&&(t.cpp11RawStringDelim=n[1],t.tokenize=m,m(e,t))}return e.match(/(u8|u|U|L)/)?!!e.match(/["']/,!1)&&"string":(e.next(),!1)}function f(e){var t=/(\w+)::~?(\w+)$/.exec(e);return t&&t[1]==t[2]}function p(e,t){for(var n;null!=(n=e.next());)if('"'==n&&!e.eat('"')){t.tokenize=null;break}return"string"}function m(e,t){var n=t.cpp11RawStringDelim.replace(/[^\w\s]/g,"\\$&");return e.match(new RegExp(".*?\\)"+n+'"'))?t.tokenize=null:e.skipToEnd(),"string"}function h(t,n){function r(e){if(e)for(var t in e)e.hasOwnProperty(t)&&o.push(t)}"string"==typeof t&&(t=[t]);var o=[];r(n.keywords),r(n.types),r(n.builtin),r(n.atoms),o.length&&(n.helperType=t[0],e.registerHelper("hintWords",t[0],o));for(var a=0;a<t.length;++a)e.defineMIME(t[a],n)}function g(e,t){for(var n=!1;!e.eol();){if(!n&&e.match('"""')){t.tokenize=null;break}n="\\"==e.next()&&!n}return"string"}function y(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!e&&!o&&t.match('"')){a=!0;break}if(e&&t.match('"""')){a=!0;break}r=t.next(),!o&&"$"==r&&t.match("{")&&t.skipTo("}"),o=!o&&"\\"==r&&!e}return!a&&e||(n.tokenize=null),"string"}}function x(e){return function(t,n){for(var r,o=!1,a=!1;!t.eol();){if(!o&&t.match('"')&&("single"==e||t.match('""'))){a=!0;break}if(!o&&t.match("``")){w=x(e),a=!0;break}r=t.next(),o="single"==e&&!o&&"\\"==r}return a&&(n.tokenize=null),"string"}}e.defineMode("clike",function(i,s){function c(e,t){var n=e.next();if(S[n]){var r=S[n](e,t);if(!1!==r)return r}if('"'==n||"'"==n)return t.tokenize=u(n),t.tokenize(e,t);if(D.test(n))return p=n,null;if(L.test(n)){if(e.backUp(1),e.match(I))return"number";e.next()}if("/"==n){if(e.eat("*"))return t.tokenize=d,d(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if(F.test(n)){for(;!e.match(/^\/[\/*]/,!1)&&e.eat(F););return"operator"}if(e.eatWhile(z),P)for(;e.match(P);)e.eatWhile(z);var o=e.current();return l(x,o)?(l(w,o)&&(p="newstatement"),l(v,o)&&(m=!0),"keyword"):l(b,o)?"type":l(k,o)?(l(w,o)&&(p="newstatement"),"builtin"):l(_,o)?"atom":"variable"}function u(e){return function(t,n){for(var r,o=!1,a=!1;null!=(r=t.next());){if(r==e&&!o){a=!0;break}o=!o&&"\\"==r}return(a||!o&&!C)&&(n.tokenize=null),"string"}}function d(e,t){for(var n,r=!1;n=e.next();){if("/"==n&&r){t.tokenize=null;break}r="*"==n}return"comment"}function f(e,t){s.typeFirstDefinitions&&e.eol()&&a(t.context)&&(t.typeAtEndOfLine=o(e,t,e.pos))}var p,m,h=i.indentUnit,g=s.statementIndentUnit||h,y=s.dontAlignCalls,x=s.keywords||{},b=s.types||{},k=s.builtin||{},w=s.blockKeywords||{},v=s.defKeywords||{},_=s.atoms||{},S=s.hooks||{},C=s.multiLineStrings,T=!1!==s.indentStatements,M=!1!==s.indentSwitch,P=s.namespaceSeparator,D=s.isPunctuationChar||/[\[\]{}\(\),;\:\.]/,L=s.numberStart||/[\d\.]/,I=s.number||/^(?:0x[a-f\d]+|0b[01]+|(?:\d+\.?\d*|\.\d+)(?:e[-+]?\d+)?)(u|ll?|l|f)?/i,F=s.isOperatorChar||/[+\-*&%=<>!?|\/]/,z=s.isIdentifierChar||/[\w\$_\xa1-\uffff]/;return{startState:function(e){return{tokenize:null,context:new t((e||0)-h,0,"top",null,!1),indented:0,startOfLine:!0,prevToken:null}},token:function(e,t){var i=t.context;if(e.sol()&&(null==i.align&&(i.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return f(e,t),null;p=m=null;var l=(t.tokenize||c)(e,t);if("comment"==l||"meta"==l)return l;if(null==i.align&&(i.align=!0),";"==p||":"==p||","==p&&e.match(/^\s*(?:\/\/.*)?$/,!1))for(;"statement"==t.context.type;)r(t);else if("{"==p)n(t,e.column(),"}");else if("["==p)n(t,e.column(),"]");else if("("==p)n(t,e.column(),")");else if("}"==p){for(;"statement"==i.type;)i=r(t);for("}"==i.type&&(i=r(t));"statement"==i.type;)i=r(t)}else p==i.type?r(t):T&&(("}"==i.type||"top"==i.type)&&";"!=p||"statement"==i.type&&"newstatement"==p)&&n(t,e.column(),"statement",e.current());if("variable"==l&&("def"==t.prevToken||s.typeFirstDefinitions&&o(e,t,e.start)&&a(t.context)&&e.match(/^\s*\(/,!1))&&(l="def"),S.token){var u=S.token(e,t,l);void 0!==u&&(l=u)}return"def"==l&&!1===s.styleDefs&&(l="variable"),t.startOfLine=!1,t.prevToken=m?"def":l||p,f(e,t),l},indent:function(t,n){if(t.tokenize!=c&&null!=t.tokenize||t.typeAtEndOfLine)return e.Pass;var r=t.context,o=n&&n.charAt(0);if("statement"==r.type&&"}"==o&&(r=r.prev),s.dontIndentStatements)for(;"statement"==r.type&&s.dontIndentStatements.test(r.info);)r=r.prev;if(S.indent){var a=S.indent(t,r,n);if("number"==typeof a)return a}var i=o==r.type,l=r.prev&&"switch"==r.prev.info;if(s.allmanIndentation&&/[{(]/.test(o)){for(;"top"!=r.type&&"}"!=r.type;)r=r.prev;return r.indented}return"statement"==r.type?r.indented+("{"==o?0:g):!r.align||y&&")"==r.type?")"!=r.type||i?r.indented+(i?0:h)+(i||!l||/^(?:case|default)\b/.test(n)?0:h):r.indented+g:r.column+(i?0:1)},electricInput:M?/^\s*(?:case .*?:|default:|\{\}?|\})$/:/^\s*[{}]$/,blockCommentStart:"/*",blockCommentEnd:"*/",lineComment:"//",fold:"brace"}});var b="auto if break case register continue return default do sizeof static else struct switch extern typedef union for goto while enum const volatile",k="int long char short double float unsigned signed void size_t ptrdiff_t";h(["text/x-csrc","text/x-c","text/x-chdr"],{name:"clike",keywords:i(b),types:i(k+" bool _Complex _Bool float_t double_t intptr_t intmax_t int8_t int16_t int32_t int64_t uintptr_t uintmax_t uint8_t uint16_t uint32_t uint64_t"),blockKeywords:i("case do else for if switch while struct"),defKeywords:i("struct"),typeFirstDefinitions:!0,atoms:i("null true false"),hooks:{"#":s,"*":c},modeProps:{fold:["brace","include"]}}),h(["text/x-c++src","text/x-c++hdr"],{name:"clike",keywords:i(b+" asm dynamic_cast namespace reinterpret_cast try explicit new static_cast typeid catch operator template typename class friend private this using const_cast inline public throw virtual delete mutable protected alignas alignof constexpr decltype nullptr noexcept thread_local final static_assert override"),types:i(k+" bool wchar_t"),blockKeywords:i("catch class do else finally for if struct switch try while"),defKeywords:i("class namespace struct enum union"),typeFirstDefinitions:!0,atoms:i("true false null"),dontIndentStatements:/^template$/,isIdentifierChar:/[\w\$_~\xa1-\uffff]/,hooks:{"#":s,"*":c,u:d,U:d,L:d,R:d,0:u,1:u,2:u,3:u,4:u,5:u,6:u,7:u,8:u,9:u,token:function(e,t,n){if("variable"==n&&"("==e.peek()&&(";"==t.prevToken||null==t.prevToken||"}"==t.prevToken)&&f(e.current()))return"def"}},namespaceSeparator:"::",modeProps:{fold:["brace","include"]}}),h("text/x-java",{name:"clike",keywords:i("abstract assert break case catch class const continue default do else enum extends final finally float for goto if implements import instanceof interface native new package private protected public return static strictfp super switch synchronized this throw throws transient try volatile while @interface"),types:i("byte short int long float double boolean char void Boolean Byte Character Double Float Integer Long Number Object Short String StringBuffer StringBuilder Void"),blockKeywords:i("catch class do else finally for if switch try while"),defKeywords:i("class interface package enum @interface"),typeFirstDefinitions:!0,atoms:i("true false null"),number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,hooks:{"@":function(e){return!e.match("interface",!1)&&(e.eatWhile(/[\w\$_]/),"meta")}},modeProps:{fold:["brace","import"]}}),h("text/x-csharp",{name:"clike",keywords:i("abstract as async await base break case catch checked class const continue default delegate do else enum event explicit extern finally fixed for foreach goto if implicit in interface internal is lock namespace new operator out override params private protected public readonly ref return sealed sizeof stackalloc static struct switch this throw try typeof unchecked unsafe using virtual void volatile while add alias ascending descending dynamic from get global group into join let orderby partial remove select set value var yield"),types:i("Action Boolean Byte Char DateTime DateTimeOffset Decimal Double Func Guid Int16 Int32 Int64 Object SByte Single String Task TimeSpan UInt16 UInt32 UInt64 bool byte char decimal double short int long object sbyte float string ushort uint ulong"),blockKeywords:i("catch class do else finally for foreach if struct switch try while"),defKeywords:i("class interface namespace struct var"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"@":function(e,t){return e.eat('"')?(t.tokenize=p,p(e,t)):(e.eatWhile(/[\w\$_]/),"meta")}}}),h("text/x-scala",{name:"clike",keywords:i("abstract case catch class def do else extends final finally for forSome if implicit import lazy match new null object override package private protected return sealed super this throw trait try type val var while with yield _ assert assume require print println printf readLine readBoolean readByte readShort readChar readInt readLong readFloat readDouble"),types:i("AnyVal App Application Array BufferedIterator BigDecimal BigInt Char Console Either Enumeration Equiv Error Exception Fractional Function IndexedSeq Int Integral Iterable Iterator List Map Numeric Nil NotNull Option Ordered Ordering PartialFunction PartialOrdering Product Proxy Range Responder Seq Serializable Set Specializable Stream StringBuilder StringContext Symbol Throwable Traversable TraversableOnce Tuple Unit Vector Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),multiLineStrings:!0,blockKeywords:i("catch class enum do else finally for forSome if match switch try while"),defKeywords:i("class enum def object package trait type val var"),atoms:i("true false null"),indentStatements:!1,indentSwitch:!1,isOperatorChar:/[+\-*&%=<>!?|\/#:@]/,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return!!e.match('""')&&(t.tokenize=g,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},"=":function(e,n){var r=n.context;return!("}"!=r.type||!r.align||!e.eat(">"))&&(n.context=new t(r.indented,r.column,r.type,r.info,null,r.prev),"operator")}},modeProps:{closeBrackets:{triples:'"'}}}),h("text/x-kotlin",{name:"clike",keywords:i("package as typealias class interface this super val var fun for is in This throw return break continue object if else while do try when !in !is as? file import where by get set abstract enum open inner override private public internal protected catch finally out final vararg reified dynamic companion constructor init sealed field property receiver param sparam lateinit data inline noinline tailrec external annotation crossinline const operator infix suspend"),types:i("Boolean Byte Character CharSequence Class ClassLoader Cloneable Comparable Compiler Double Exception Float Integer Long Math Number Object Package Pair Process Runtime Runnable SecurityManager Short StackTraceElement StrictMath String StringBuffer System Thread ThreadGroup ThreadLocal Throwable Triple Void"),intendSwitch:!1,indentStatements:!1,multiLineStrings:!0,number:/^(?:0x[a-f\d_]+|0b[01_]+|(?:[\d_]+\.?\d*|\.\d+)(?:e[-+]?[\d_]+)?)(u|ll?|l|f)?/i,blockKeywords:i("catch class do else finally for if where try while enum"),defKeywords:i("class val var object package interface fun"),atoms:i("true false null this"),hooks:{'"':function(e,t){return t.tokenize=y(e.match('""')),t.tokenize(e,t)}},modeProps:{closeBrackets:{triples:'"'}}}),h(["x-shader/x-vertex","x-shader/x-fragment"],{name:"clike",keywords:i("sampler1D sampler2D sampler3D samplerCube sampler1DShadow sampler2DShadow const attribute uniform varying break continue discard return for while do if else struct in out inout"),types:i("float int bool void vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 mat2 mat3 mat4"),blockKeywords:i("for while do if else struct"),builtin:i("radians degrees sin cos tan asin acos atan pow exp log exp2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize ftransform faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not texture1D texture1DProj texture1DLod texture1DProjLod texture2D texture2DProj texture2DLod texture2DProjLod texture3D texture3DProj texture3DLod texture3DProjLod textureCube textureCubeLod shadow1D shadow2D shadow1DProj shadow2DProj shadow1DLod shadow2DLod shadow1DProjLod shadow2DProjLod dFdx dFdy fwidth noise1 noise2 noise3 noise4"),atoms:i("true false gl_FragColor gl_SecondaryColor gl_Normal gl_Vertex gl_MultiTexCoord0 gl_MultiTexCoord1 gl_MultiTexCoord2 gl_MultiTexCoord3 gl_MultiTexCoord4 gl_MultiTexCoord5 gl_MultiTexCoord6 gl_MultiTexCoord7 gl_FogCoord gl_PointCoord gl_Position gl_PointSize gl_ClipVertex gl_FrontColor gl_BackColor gl_FrontSecondaryColor gl_BackSecondaryColor gl_TexCoord gl_FogFragCoord gl_FragCoord gl_FrontFacing gl_FragData gl_FragDepth gl_ModelViewMatrix gl_ProjectionMatrix gl_ModelViewProjectionMatrix gl_TextureMatrix gl_NormalMatrix gl_ModelViewMatrixInverse gl_ProjectionMatrixInverse gl_ModelViewProjectionMatrixInverse gl_TexureMatrixTranspose gl_ModelViewMatrixInverseTranspose gl_ProjectionMatrixInverseTranspose gl_ModelViewProjectionMatrixInverseTranspose gl_TextureMatrixInverseTranspose gl_NormalScale gl_DepthRange gl_ClipPlane gl_Point gl_FrontMaterial gl_BackMaterial gl_LightSource gl_LightModel gl_FrontLightModelProduct gl_BackLightModelProduct gl_TextureColor gl_EyePlaneS gl_EyePlaneT gl_EyePlaneR gl_EyePlaneQ gl_FogParameters gl_MaxLights gl_MaxClipPlanes gl_MaxTextureUnits gl_MaxTextureCoords gl_MaxVertexAttribs gl_MaxVertexUniformComponents gl_MaxVaryingFloats gl_MaxVertexTextureImageUnits gl_MaxTextureImageUnits gl_MaxFragmentUniformComponents gl_MaxCombineTextureImageUnits gl_MaxDrawBuffers"),indentSwitch:!1,hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-nesc",{name:"clike",keywords:i(b+"as atomic async call command component components configuration event generic implementation includes interface module new norace nx_struct nx_union post provides signal task uses abstract extends"),types:i(k),blockKeywords:i("case do else for if switch while struct"),atoms:i("null true false"),hooks:{"#":s},modeProps:{fold:["brace","include"]}}),h("text/x-objectivec",{name:"clike",keywords:i(b+"inline restrict _Bool _Complex _Imaginary BOOL Class bycopy byref id IMP in inout nil oneway out Protocol SEL self super atomic nonatomic retain copy readwrite readonly"),types:i(k),atoms:i("YES NO NULL NILL ON OFF true false"),hooks:{"@":function(e){return e.eatWhile(/[\w\$]/),"keyword"},"#":s,indent:function(e,t,n){if("statement"==t.type&&/^@\w/.test(n))return t.indented}},modeProps:{fold:"brace"}}),h("text/x-squirrel",{name:"clike",keywords:i("base break clone continue const default delete enum extends function in class foreach local resume return this throw typeof yield constructor instanceof static"),types:i(k),blockKeywords:i("case catch class else for foreach if switch try while"),defKeywords:i("function local class"),typeFirstDefinitions:!0,atoms:i("true false null"),hooks:{"#":s},modeProps:{fold:["brace","include"]}});var w=null;h("text/x-ceylon",{name:"clike",keywords:i("abstracts alias assembly assert assign break case catch class continue dynamic else exists extends finally for function given if import in interface is let module new nonempty object of out outer package return satisfies super switch then this throw try value void while"),types:function(e){var t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()},blockKeywords:i("case catch class dynamic else finally for function if interface module new object switch try while"),defKeywords:i("class dynamic function interface module object package value"),builtin:i("abstract actual aliased annotation by default deprecated doc final formal late license native optional sealed see serializable shared suppressWarnings tagged throws variable"),isPunctuationChar:/[\[\]{}\(\),;\:\.`]/,isOperatorChar:/[+\-*&%=<>!?|^~:\/]/,numberStart:/[\d#$]/,number:/^(?:#[\da-fA-F_]+|\$[01_]+|[\d_]+[kMGTPmunpf]?|[\d_]+\.[\d_]+(?:[eE][-+]?\d+|[kMGTPmunpf]|)|)/i,multiLineStrings:!0,typeFirstDefinitions:!0,atoms:i("true false null larger smaller equal empty finished"),indentSwitch:!1,styleDefs:!1,hooks:{"@":function(e){return e.eatWhile(/[\w\$_]/),"meta"},'"':function(e,t){return t.tokenize=x(e.match('""')?"triple":"single"),t.tokenize(e,t)},"`":function(e,t){return!(!w||!e.match("`"))&&(t.tokenize=w,w=null,t.tokenize(e,t))},"'":function(e){return e.eatWhile(/[\w\$_\xa1-\uffff]/),"atom"},token:function(e,t,n){if(("variable"==n||"type"==n)&&"."==t.prevToken)return"variable-2"}},modeProps:{fold:["brace","import"],closeBrackets:{triples:'"'}}})});
      // -------------------------------------------------------------------------
//  Part of the CodeChecker project, under the Apache License v2.0 with
//  LLVM Exceptions. See LICENSE for license information.
//  SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
// -------------------------------------------------------------------------

var BugViewer = {
  _files : [],
  _reports : [],
  _lineWidgets : [],
  _navigationMenuItems : [],
  _sourceFileData : null,
  _currentReport : null,
  _lastBugEvent  : null,

  init : function (files, reports) {
    this._files = files;
    this._reports = reports;

    this.initEscapeChars();
  },

  initEscapeChars : function () {
    this.escapeChars = {
      ' ' : 'nbsp',
      '<' : 'lt',
      '>' : 'gt',
      '"' : 'quot',
      '&' : 'amp'
    };

    var regexString = '[';
    for (var key in this.escapeChars) {
      regexString += key;
    }
    regexString += ']';

    this.escapeRegExp = new RegExp( regexString, 'g');
  },

  escapeHTML : function (str) {
    var that = this;

    return str.replace(this.escapeRegExp, function (m) {
      return '&' + that.escapeChars[m] + ';';
    });
  },

  initByUrl : function () {
    if (!this._reports) return;

    var state = {};
    window.location.hash.substr(1).split('&').forEach(function (s) {
      var parts = s.split('=');
      state[parts[0]] = parts[1];
    });

    for (var key in this._reports) {
      var report = this._reports[key];
      if (report.reportHash === state['reportHash']) {
        this.navigate(report);
        return;
      }
    }

    this.navigate(this._reports[0]);
  },

  create : function () {
    this._content = document.getElementById('editor-wrapper');
    this._filepath = document.getElementById('file-path');
    this._checkerName = document.getElementById('checker-name');
    this._reviewStatusWrapper =
      document.getElementById('review-status-wrapper');
    this._reviewStatus = document.getElementById('review-status');
    this._editor = document.getElementById('editor');

    this._codeMirror = CodeMirror(this._editor, {
      mode: 'text/x-c++src',
      matchBrackets : true,
      lineNumbers : true,
      readOnly : true,
      foldGutter : true,
      extraKeys : {},
      viewportMargin : 100
    });

    this._createNavigationMenu();
  },

  navigate : function (report, item) {
    if (!item) {
      var items = this._navigationMenuItems.filter(function (navItem) {
        return navItem.report.reportHash === report.reportHash;
      });

      if (!items.length) return;

      item = items[0].widget;
    }

    this._selectedReport.classList.remove('active');
    this._selectedReport = item;
    this._selectedReport.classList.add('active');
    this.setReport(report);
  },

  _createNavigationMenu : function () {
    var that = this;

    var nav = document.getElementById('report-nav');
    var list = document.createElement('ul');
    this._reports.forEach(function (report) {
      var events = report.events;
      var lastBugEvent = events[events.length - 1];
      var item = document.createElement('li');

      var severity = document.createElement('i');
      severity.className = 'severity-' + report.severity.toLowerCase();

      item.appendChild(severity);
      item.appendChild(document.createTextNode(lastBugEvent.message));

      item.addEventListener('click', function () {
        that.navigate(report, item);
      })
      list.appendChild(item);
      that._navigationMenuItems.push({ report : report, widget : item });
    });

    if (!this._selectedReport && list.childNodes.length) {
      this._selectedReport = list.childNodes[0];
      this._selectedReport.classList.add('active');
    }

    nav.appendChild(list);
  },

  setReport : function (report) {
    this._currentReport = report;
    var events = report.events;
    var lastBugEvent = events[events.length - 1];
    this.setCurrentBugEvent(lastBugEvent, events.length - 1);
    this.setChecker(report.checker);
    this.setReviewStatus(report.reviewStatus);

    window.location.hash = '#reportHash=' + report.reportHash;
  },

  setCurrentBugEvent : function (event, idx) {
    this._currentBugEvent = event;
    this.setSourceFileData(this._files[event.fileId]);
    this.drawBugPath();

    this.jumpTo(event.line, 0);
    this.highlightBugEvent(idx);
  },

  highlightBugEvent : function (idx) {
    this._lineWidgets.forEach(function (widget) {
      var lineIdx = widget.node.getAttribute('idx');
      if (parseInt(lineIdx) === idx) {
        widget.node.classList.add('current');
      }
    });
  },

  setChecker : function (checker) {
    var content = checker.name;
    if (checker.url) {
      content = '<a href="' + checker.url + '" target="_blank">' +
        checker.name + '</a>';
    }

    this._checkerName.innerHTML = content;
  },

  setReviewStatus : function (status) {
    if (status) {
      var className =
        'review-status-' + status.toLowerCase().split(' ').join('-');
      this._reviewStatus.className = "review-status " + className;

      this._reviewStatus.innerHTML = status;
      this._reviewStatusWrapper.style.display = 'block';
    } else {
      this._reviewStatusWrapper.style.display = 'none';
    }
  },

  setSourceFileData : function (file) {
    if (this._sourceFileData && file.id === this._sourceFileData.id) {
      return;
    }

    this._sourceFileData = file;
    this._filepath.innerHTML = file.filePath;
    let e = document.createElement('div');
    e.innerHTML = file.content;
    this._codeMirror.doc.setValue(e.innerText);
    this._refresh();
  },

  _refresh : function () {
    var that = this;
    setTimeout(function () {
      var fullHeight = parseInt(that._content.clientHeight);
      var headerHeight = that._filepath.clientHeight;

      that._codeMirror.setSize('auto', fullHeight - headerHeight);
      that._codeMirror.refresh();
    }, 200);
  },

  clearBubbles : function () {
    this._lineWidgets.forEach(function (widget) { widget.clear(); });
    this._lineWidgets = [];
  },

  getMessage : function (event, kind) {
    if (kind === 'macro') {
      var name = 'macro expansion' + (event.name ? ': ' + event.name : '');

      return '<span class="tag macro">' + name + '</span>'
        + this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    } else if (kind === 'note') {
      return '<span class="tag note">note</span>'
        +  this.escapeHTML(event.message).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }
  },

  addExtraPathEvents : function (events, kind) {
    var that = this;

    if (!events) {
      return;
    }

    events.forEach(function (event) {
      if (event.fileId !== that._currentBugEvent.fileId) {
        return;
      }

      var left = that._codeMirror.defaultCharWidth() * event.column + 'px';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + kind);

      var msg = document.createElement('span');
      msg.innerHTML = that.getMessage(event, kind);
      element.appendChild(msg);

      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.line - 1, element));
    });
  },

  drawBugPath : function () {
    var that = this;

    this.clearBubbles();

    this.addExtraPathEvents(this._currentReport.macros, 'macro');
    this.addExtraPathEvents(this._currentReport.notes, 'note');

    // Processing bug path events.
    var currentEvents = this._currentReport.events;
    currentEvents.forEach(function (event, step) {
      if (event.fileId !== that._currentBugEvent.fileId)
        return;

      var left = that._codeMirror.defaultCharWidth() * event.column + 'px';
      var type = step === currentEvents.length - 1 ? 'error' : 'info';

      var element = document.createElement('div');
      element.setAttribute('style', 'margin-left: ' + left);
      element.setAttribute('class', 'check-msg ' + type);
      element.setAttribute('idx', step);

      var enumeration = document.createElement('span');
      enumeration.setAttribute('class', 'checker-enum ' + type);
      enumeration.innerHTML = step + 1;

      if (currentEvents.length > 1)
        element.appendChild(enumeration);

      var prevBugEvent = step - 1;
      if (step > 0) {
        var prevBug = document.createElement('span');
        prevBug.setAttribute('class', 'arrow left-arrow');
        prevBug.addEventListener('click', function () {
          var event = currentEvents[prevBugEvent];
          that.setCurrentBugEvent(event, prevBugEvent);
        });
        element.appendChild(prevBug);
      }

      var msg = document.createElement('span');
      msg.innerHTML = that.escapeHTML(event.message)
        .replace(/(?:\r\n|\r|\n)/g, '<br>');

      element.appendChild(msg);

      var nextBugEvent = step + 1;
      if (nextBugEvent < currentEvents.length) {
        var nextBug = document.createElement('span');
        nextBug.setAttribute('class', 'arrow right-arrow');
        nextBug.addEventListener('click', function () {
          var event = currentEvents[nextBugEvent];
          that.setCurrentBugEvent(event, nextBugEvent);
        });
        element.appendChild(nextBug);
      }


      that._lineWidgets.push(that._codeMirror.addLineWidget(
        event.line - 1, element));
    });
  },

  jumpTo : function (line, column) {
    var that = this;

    setTimeout(function () {
      var selPosPixel
        = that._codeMirror.charCoords({ line : line, ch : column }, 'local');
      var editorSize = {
        width  : that._editor.clientWidth,
        height : that._editor.clientHeight
      };

      that._codeMirror.scrollIntoView({
        top    : selPosPixel.top - 100,
        bottom : selPosPixel.top + editorSize.height - 150,
        left   : selPosPixel.left < editorSize.width - 100
               ? 0
               : selPosPixel.left - 50,
        right  : selPosPixel.left < editorSize.width - 100
               ? 10
               : selPosPixel.left + editorSize.width - 100
      });
    }, 0);
  }
}


      var data = {"files": {"/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c": {"id": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "filePath": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "content": "/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre, Romain Bouqueau, Cyril Concolato\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2022\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / Media Tools sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include &lt;gpac/internal/media_dev.h&gt;\n#include &lt;gpac/constants.h&gt;\n#include &lt;gpac/mpeg4_odf.h&gt;\n#include &lt;gpac/maths.h&gt;\n#include &lt;gpac/avparse.h&gt;\n\n#ifndef GPAC_DISABLE_OGG\n#include &lt;gpac/internal/ogg.h&gt;\n#endif\n\n//uncomment/define globally to remove all bitstream parsing logging from code (this will break inspect mode analyze=bs)\n//#define GPAC_DISABLE_AVPARSE_LOGS\n\n#ifndef GPAC_DISABLE_AVPARSE_LOGS\nvoid gf_bs_log_idx(GF_BitStream *bs, u32 nBits, const char *fname, s64 val, s32 idx1, s32 idx2, s32 idx3);\n\n#define gf_bs_log(_bs, _nBits, _fname, _val) gf_bs_log_idx(_bs, _nBits, _fname, _val, -1, -1, -1)\n\nu32 gf_bs_read_int_log_idx3(GF_BitStream *bs, u32 nBits, const char *fname, s32 idx1, s32 idx2, s32 idx3)\n{\n\tu32 val = gf_bs_read_int(bs, nBits);\n\tgf_bs_log_idx(bs, nBits, fname, val, idx1, idx2, idx3);\n\treturn val;\n}\n\n#define gf_bs_read_int_log(_bs, _nBits, _fname) gf_bs_read_int_log_idx3(_bs, _nBits, _fname, -1, -1, -1)\n#define gf_bs_read_int_log_idx(_bs, _nBits, _fname, _idx) gf_bs_read_int_log_idx3(_bs, _nBits, _fname, _idx, -1, -1)\n#define gf_bs_read_int_log_idx2(_bs, _nBits, _fname, _idx1, _idx2) gf_bs_read_int_log_idx3(_bs, _nBits, _fname, (s32) _idx1, (s32) _idx2, -1)\n\n\n#else\n\n#define gf_bs_log(_bs, _nBits, _fname, _val)\n#define gf_bs_log_idx(_bs, _nBits, _fname, _val, _idx1, _idx2, _idx3)\n\n#define gf_bs_read_int_log(_bs, _nbb, _f) gf_bs_read_int(_bs, _nbb)\n#define gf_bs_read_int_log_idx(_bs, _nbb, _f, _idx) gf_bs_read_int(_bs, _nbb)\n#define gf_bs_read_int_log_idx2(_bs, _nbb, _f, _idx1, _idx2) gf_bs_read_int(_bs, _nbb)\n#define gf_bs_read_int_log_idx3(_bs, _nbb, _f, _idx1, _idx2, _idx3) gf_bs_read_int(_bs, _nbb)\n\n#endif\n\n\n\n\nstatic const struct {\n\tu32 w, h;\n} std_par[] =\n{\n\t{ 4, 3}, {3, 2}, {16, 9}, {5, 3}, {5, 4}, {8, 5}, {2, 1}, {1, 1},\n\t{0, 0},\n};\n\nGF_EXPORT\nvoid gf_media_reduce_aspect_ratio(u32 *width, u32 *height)\n{\n\tu32 i = 0;\n\tu32 w = *width;\n\tu32 h = *height;\n\twhile (std_par[i].w) {\n\t\tif (std_par[i].w * h == std_par[i].h * w) {\n\t\t\t*width = std_par[i].w;\n\t\t\t*height = std_par[i].h;\n\t\t\treturn;\n\t\t}\n\t\ti++;\n\t}\n\t//not standard one, reduce by power of 2\n\ti = 2;\n\twhile (1) {\n\t\tif (w &lt;= i) return;\n\t\tif (h &lt;= i) return;\n\n\t\tif (w % i) return;\n\t\tif (h % i) return;\n\t\t*width = w / i;\n\t\t*height = h / i;\n\t\ti *= 2;\n\t}\n}\n\nGF_EXPORT\nvoid gf_media_get_reduced_frame_rate(u32 *timescale, u32 *sample_dur)\n{\n\tu32 res;\n\tif (!*sample_dur) return;\n\tres = *timescale / *sample_dur;\n\tif (res * (*sample_dur) == *timescale) {\n\t\t*timescale = res;\n\t\t*sample_dur = 1;\n\t}\n\telse if ((double)(*timescale * 1001 - (res + 1) * *sample_dur * 1000) / ((res + 1) * *sample_dur * 1000) &lt; 0.001) {\n\t\t*timescale = (res + 1) * 1000;\n\t\t*sample_dur = 1001;\n\t}\n}\n\nstruct __m4v_profile\n{\n\tu32 value;\n\tconst char *name;\n} M4VProfiles[] = {\n\t{0x00, &quot;Reserved (0x00) Profile&quot;},\n\t{0x01, &quot;Simple Profile @ Level 1&quot;},\n\t{0x02, &quot;Simple Profile @ Level 2&quot;},\n\t{0x03, &quot;Simple Profile @ Level 3&quot;},\n\t{0x08, &quot;Simple Profile @ Level 0&quot;},\n\t{0x10, &quot;Simple Scalable Profile @ Level 0&quot;},\n\t{0x11, &quot;Simple Scalable Profile @ Level 1&quot;},\n\t{0x12, &quot;Simple Scalable Profile @ Level 2&quot;},\n\t{0x21, &quot;Core Profile @ Level 1&quot;},\n\t{0x22, &quot;Core Profile @ Level 2&quot;},\n\t{0x32, &quot;Main Profile @ Level 2&quot;},\n\t{0x33, &quot;Main Profile @ Level 3&quot;},\n\t{0x34, &quot;Main Profile @ Level 4&quot;},\n\t{0x42, &quot;N-bit Profile @ Level 2&quot;},\n\t{0x51, &quot;Scalable Texture Profile @ Level 1&quot;},\n\t{0x61, &quot;Simple Face Animation Profile @ Level 1&quot;},\n\t{0x62, &quot;Simple Face Animation Profile @ Level 2&quot;},\n\t{0x63, &quot;Simple FBA Profile @ Level 1&quot;},\n\t{0x64, &quot;Simple FBA Profile @ Level 2&quot;},\n\t{0x71, &quot;Basic Animated Texture Profile @ Level 1&quot;},\n\t{0x72, &quot;Basic Animated Texture Profile @ Level 2&quot;},\n\t{0x7F, &quot;AVC/H264 Profile&quot;},\n\t{0x81, &quot;Hybrid Profile @ Level 1&quot;},\n\t{0x82, &quot;Hybrid Profile @ Level 2&quot;},\n\t{0x91, &quot;Advanced Real Time Simple Profile @ Level 1&quot;},\n\t{0x92, &quot;Advanced Real Time Simple Profile @ Level 2&quot;},\n\t{0x93, &quot;Advanced Real Time Simple Profile @ Level 3&quot;},\n\t{0x94, &quot;Advanced Real Time Simple Profile @ Level 4&quot;},\n\t{0xA1, &quot;Core Scalable Profile @ Level1&quot;},\n\t{0xA2, &quot;Core Scalable Profile @ Level2&quot;},\n\t{0xA3, &quot;Core Scalable Profile @ Level3&quot;},\n\t{0xB1, &quot;Advanced Coding Efficiency Profile @ Level 1&quot;},\n\t{0xB2, &quot;Advanced Coding Efficiency Profile @ Level 2&quot;},\n\t{0xB3, &quot;Advanced Coding Efficiency Profile @ Level 3&quot;},\n\t{0xB4, &quot;Advanced Coding Efficiency Profile @ Level 4&quot;},\n\t{0xC1, &quot;Advanced Core Profile @ Level 1&quot;},\n\t{0xC2, &quot;Advanced Core Profile @ Level 2&quot;},\n\t{0xD1, &quot;Advanced Scalable Texture @ Level1&quot;},\n\t{0xD2, &quot;Advanced Scalable Texture @ Level2&quot;},\n\t{0xE1, &quot;Simple Studio Profile @ Level 1&quot;},\n\t{0xE2, &quot;Simple Studio Profile @ Level 2&quot;},\n\t{0xE3, &quot;Simple Studio Profile @ Level 3&quot;},\n\t{0xE4, &quot;Simple Studio Profile @ Level 4&quot;},\n\t{0xE5, &quot;Core Studio Profile @ Level 1&quot;},\n\t{0xE6, &quot;Core Studio Profile @ Level 2&quot;},\n\t{0xE7, &quot;Core Studio Profile @ Level 3&quot;},\n\t{0xE8, &quot;Core Studio Profile @ Level 4&quot;},\n\t{0xF0, &quot;Advanced Simple Profile @ Level 0&quot;},\n\t{0xF1, &quot;Advanced Simple Profile @ Level 1&quot;},\n\t{0xF2, &quot;Advanced Simple Profile @ Level 2&quot;},\n\t{0xF3, &quot;Advanced Simple Profile @ Level 3&quot;},\n\t{0xF4, &quot;Advanced Simple Profile @ Level 4&quot;},\n\t{0xF5, &quot;Advanced Simple Profile @ Level 5&quot;},\n\t{0xF7, &quot;Advanced Simple Profile @ Level 3b&quot;},\n\t{0xF8, &quot;Fine Granularity Scalable Profile @ Level 0&quot;},\n\t{0xF9, &quot;Fine Granularity Scalable Profile @ Level 1&quot;},\n\t{0xFA, &quot;Fine Granularity Scalable Profile @ Level 2&quot;},\n\t{0xFB, &quot;Fine Granularity Scalable Profile @ Level 3&quot;},\n\t{0xFC, &quot;Fine Granularity Scalable Profile @ Level 4&quot;},\n\t{0xFD, &quot;Fine Granularity Scalable Profile @ Level 5&quot;},\n\t{0xFE, &quot;Not part of MPEG-4 Visual profiles&quot;},\n\t{0xFF, &quot;No visual capability required&quot;}\n};\n\nGF_EXPORT\nconst char *gf_m4v_get_profile_name(u8 video_pl)\n{\n\tu32 i, count = GF_ARRAY_LENGTH(M4VProfiles);\n\tfor (i=0; i&lt;count; i++) {\n\t\tif ((u32)video_pl == M4VProfiles[i].value)\n\t\t\treturn M4VProfiles[i].name;\n\t}\n\treturn &quot;ISO Reserved Profile&quot;;\n}\n\n\n#ifndef GPAC_DISABLE_AV_PARSERS\n\n#define MPEG12_START_CODE_PREFIX\t\t0x000001\n#define MPEG12_PICTURE_START_CODE\t\t0x00000100\n#define MPEG12_SLICE_MIN_START\t\t\t0x00000101\n#define MPEG12_SLICE_MAX_START\t\t\t0x000001af\n#define MPEG12_USER_DATA_START_CODE\t\t0x000001b2\n#define MPEG12_SEQUENCE_START_CODE\t\t0x000001b3\n#define MPEG12_SEQUENCE_ERR_START_CODE\t0x000001b4\n#define MPEG12_EXT_START_CODE\t\t\t0x000001b5\n#define MPEG12_SEQUENCE_END_START_CODE\t0x000001b7\n#define MPEG12_GOP_START_CODE\t\t\t0x000001b8\n\ns32 gf_mv12_next_start_code(unsigned char *pbuffer, u32 buflen, u32 *optr, u32 *scode)\n{\n\tu32 value;\n\tu32 offset;\n\n\tif (buflen &lt; 4) return -1;\n\tfor (offset = 0; offset &lt; buflen - 3; offset++, pbuffer++) {\n#ifdef GPAC_BIG_ENDIAN\n\t\tvalue = *(u32 *)pbuffer &gt;&gt; 8;\n#else\n\t\tvalue = (pbuffer[0] &lt;&lt; 16) | (pbuffer[1] &lt;&lt; 8) | (pbuffer[2] &lt;&lt; 0);\n#endif\n\n\t\tif (value == MPEG12_START_CODE_PREFIX) {\n\t\t\t*optr = offset;\n\t\t\t*scode = (value &lt;&lt; 8) | pbuffer[3];\n\t\t\treturn 0;\n\t\t}\n\t}\n\treturn -1;\n}\n\ns32 gf_mv12_next_slice_start(unsigned char *pbuffer, u32 startoffset, u32 buflen, u32 *slice_offset)\n{\n\tu32 slicestart, code;\n\twhile (gf_mv12_next_start_code(pbuffer + startoffset, buflen - startoffset, &amp;slicestart, &amp;code) &gt;= 0) {\n\t\tif ((code &gt;= MPEG12_SLICE_MIN_START) &amp;&amp; (code &lt;= MPEG12_SLICE_MAX_START)) {\n\t\t\t*slice_offset = slicestart + startoffset;\n\t\t\treturn 0;\n\t\t}\n\t\tstartoffset += slicestart + 4;\n\t}\n\treturn -1;\n}\n\n\n/*\n\tMPEG-4 video (14496-2)\n*/\n\nstruct __tag_m4v_parser\n{\n\tGF_BitStream *bs;\n\tBool mpeg12, step_mode;\n\tu32 current_object_type;\n\tu32 force_next_obj_type;\n\tu64 current_object_start;\n\tu32 tc_dec, prev_tc_dec, tc_disp, prev_tc_disp;\n};\n\nGF_EXPORT\nGF_M4VParser *gf_m4v_parser_new(u8 *data, u64 data_size, Bool mpeg12video)\n{\n\tGF_M4VParser *tmp;\n\tif (!data || !data_size) return NULL;\n\tGF_SAFEALLOC(tmp, GF_M4VParser);\n\tif (!tmp) return NULL;\n\ttmp-&gt;bs = gf_bs_new(data, data_size, GF_BITSTREAM_READ);\n\ttmp-&gt;mpeg12 = mpeg12video;\n\treturn tmp;\n}\n\nGF_M4VParser *gf_m4v_parser_bs_new(GF_BitStream *bs, Bool mpeg12video)\n{\n\tGF_M4VParser *tmp;\n\tGF_SAFEALLOC(tmp, GF_M4VParser);\n\tif (!tmp) return NULL;\n\ttmp-&gt;bs = bs;\n\ttmp-&gt;mpeg12 = mpeg12video;\n\treturn tmp;\n}\n\nGF_EXPORT\nvoid gf_m4v_parser_del(GF_M4VParser *m4v)\n{\n\tgf_bs_del(m4v-&gt;bs);\n\tgf_free(m4v);\n}\n\nGF_EXPORT\nvoid gf_m4v_parser_del_no_bs(GF_M4VParser *m4v)\n{\n\tgf_free(m4v);\n}\n\nGF_EXPORT\nvoid gf_m4v_parser_set_inspect(GF_M4VParser *m4v)\n{\n\tif (m4v) m4v-&gt;step_mode = 1;\n}\nGF_EXPORT\nu32 gf_m4v_parser_get_obj_type(GF_M4VParser *m4v)\n{\n\tif (m4v) return m4v-&gt;current_object_type;\n\treturn 0;\n}\n\n#define M4V_CACHE_SIZE\t\t4096\ns32 M4V_LoadObject(GF_M4VParser *m4v)\n{\n\tu32 v, bpos, found;\n\tchar m4v_cache[M4V_CACHE_SIZE];\n\tu64 end, cache_start, load_size;\n\tif (!m4v) return 0;\n\tif (m4v-&gt;force_next_obj_type) {\n\t\tm4v-&gt;current_object_type = m4v-&gt;force_next_obj_type - 1;\n\t\tm4v-&gt;force_next_obj_type = 0;\n\t\treturn (s32)m4v-&gt;current_object_type;\n\t}\n\n\tbpos = 0;\n\tfound = 0;\n\tload_size = 0;\n\tend = 0;\n\tcache_start = 0;\n\tv = 0xffffffff;\n\twhile (!end) {\n\t\t/*refill cache*/\n\t\tif (bpos == (u32)load_size) {\n\t\t\tif (!gf_bs_available(m4v-&gt;bs)) break;\n\t\t\tload_size = gf_bs_available(m4v-&gt;bs);\n\t\t\tif (load_size &gt; M4V_CACHE_SIZE) load_size = M4V_CACHE_SIZE;\n\t\t\tbpos = 0;\n\t\t\tcache_start = gf_bs_get_position(m4v-&gt;bs);\n\t\t\tgf_bs_read_data(m4v-&gt;bs, m4v_cache, (u32)load_size);\n\t\t}\n\t\tv = ((v &lt;&lt; 8) &amp; 0xFFFFFF00) | ((u8)m4v_cache[bpos]);\n\t\tbpos++;\n\t\tif ((v &amp; 0xFFFFFF00) == 0x00000100) {\n\t\t\tend = cache_start + bpos - 4;\n\t\t\tfound = 1;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (!found) return -1;\n\tm4v-&gt;current_object_start = end;\n\tgf_bs_seek(m4v-&gt;bs, end + 3);\n\tm4v-&gt;current_object_type = gf_bs_read_u8(m4v-&gt;bs);\n\treturn (s32)m4v-&gt;current_object_type;\n}\n\n\nGF_EXPORT\nvoid gf_m4v_rewrite_pl(u8 **o_data, u32 *o_dataLen, u8 PL)\n{\n\tu32 pos = 0;\n\tunsigned char *data = (unsigned char *)*o_data;\n\tu32 dataLen = *o_dataLen;\n\n\twhile (pos + 4 &lt; dataLen) {\n\t\tif (!data[pos] &amp;&amp; !data[pos + 1] &amp;&amp; (data[pos + 2] == 0x01) &amp;&amp; (data[pos + 3] == M4V_VOS_START_CODE)) {\n\t\t\tdata[pos + 4] = PL;\n\t\t\treturn;\n\t\t}\n\t\tpos++;\n\t}\n\t/*emulate VOS at beggining*/\n\t(*o_data) = (char *)gf_malloc(sizeof(char)*(dataLen + 5));\n\t(*o_data)[0] = 0;\n\t(*o_data)[1] = 0;\n\t(*o_data)[2] = 1;\n\t(*o_data)[3] = (char)M4V_VOS_START_CODE;\n\t(*o_data)[4] = PL;\n\tmemcpy((*o_data + 5), data, sizeof(char)*dataLen);\n\tgf_free(data);\n\t(*o_dataLen) = dataLen + 5;\n}\n\nstatic GF_Err M4V_Reset(GF_M4VParser *m4v, u64 start)\n{\n\tgf_bs_seek(m4v-&gt;bs, start);\n\n\tassert(start &lt; (u64)1&lt;&lt;31);\n\tm4v-&gt;current_object_start = (u32)start;\n\tm4v-&gt;current_object_type = 0;\n\treturn GF_OK;\n}\n\nvoid gf_m4v_parser_reset(GF_M4VParser *m4v, u8 sc_type)\n{\n\tm4v-&gt;current_object_start = 0;\n\tm4v-&gt;current_object_type = 0;\n\tm4v-&gt;force_next_obj_type = sc_type;\n}\nstatic GF_Err gf_m4v_parse_config_mpeg12(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi)\n{\n\tunsigned char p[4];\n\tu32 ext_type;\n\ts32 o_type;\n\tu8 go, par;\n\n\tif (!m4v || !dsi) return GF_BAD_PARAM;\n\n\tmemset(dsi, 0, sizeof(GF_M4VDecSpecInfo));\n\tdsi-&gt;VideoPL = 0;\n\n\tgo = 1;\n\twhile (go) {\n\t\to_type = M4V_LoadObject(m4v);\n\t\tswitch (o_type) {\n\t\tcase M2V_SEQ_START_CODE:\n\t\t\tdsi-&gt;RAP_stream = 1;\n\t\t\tgf_bs_read_data(m4v-&gt;bs, (char *)p, 4);\n\t\t\tdsi-&gt;width = (p[0] &lt;&lt; 4) | ((p[1] &gt;&gt; 4) &amp; 0xf);\n\t\t\tdsi-&gt;height = ((p[1] &amp; 0xf) &lt;&lt; 8) | p[2];\n\n\t\t\tdsi-&gt;VideoPL = GF_CODECID_MPEG1;\n\t\t\tpar = (p[3] &gt;&gt; 4) &amp; 0xf;\n\t\t\tswitch (par) {\n\t\t\tcase 2:\n\t\t\t\tdsi-&gt;par_num = dsi-&gt;height / 3;\n\t\t\t\tdsi-&gt;par_den = dsi-&gt;width / 4;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tdsi-&gt;par_num = dsi-&gt;height / 9;\n\t\t\t\tdsi-&gt;par_den = dsi-&gt;width / 16;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tdsi-&gt;par_num = dsi-&gt;height / 2;\n\t\t\t\tdsi-&gt;par_den = dsi-&gt;width / 21;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdsi-&gt;par_den = dsi-&gt;par_num = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tswitch (p[3] &amp; 0xf) {\n\t\t\tcase 0:\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tdsi-&gt;fps = 24000.0 / 1001.0;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tdsi-&gt;fps = 24.0;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tdsi-&gt;fps = 25.0;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tdsi-&gt;fps = 30000.0 / 1001.0;\n\t\t\t\tbreak;\n\t\t\tcase 5:\n\t\t\t\tdsi-&gt;fps = 30.0;\n\t\t\t\tbreak;\n\t\t\tcase 6:\n\t\t\t\tdsi-&gt;fps = 50.0;\n\t\t\t\tbreak;\n\t\t\tcase 7:\n\t\t\t\tdsi-&gt;fps = ((60.0*1000.0) / 1001.0);\n\t\t\t\tbreak;\n\t\t\tcase 8:\n\t\t\t\tdsi-&gt;fps = 60.0;\n\t\t\t\tbreak;\n\t\t\tcase 9:\n\t\t\t\tdsi-&gt;fps = 1;\n\t\t\t\tbreak;\n\t\t\tcase 10:\n\t\t\t\tdsi-&gt;fps = 5;\n\t\t\t\tbreak;\n\t\t\tcase 11:\n\t\t\t\tdsi-&gt;fps = 10;\n\t\t\t\tbreak;\n\t\t\tcase 12:\n\t\t\t\tdsi-&gt;fps = 12;\n\t\t\t\tbreak;\n\t\t\tcase 13:\n\t\t\t\tdsi-&gt;fps = 15;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase M2V_EXT_START_CODE:\n\t\t\tgf_bs_read_data(m4v-&gt;bs, (char *)p, 4);\n\t\t\text_type = ((p[0] &gt;&gt; 4) &amp; 0xf);\n\t\t\tif (ext_type == 1) {\n\t\t\t\tdsi-&gt;VideoPL = (p[0]&amp;0xf) | ((p[1] &gt;&gt; 4) &amp; 0xf);\n\t\t\t\tdsi-&gt;progresive = (p[1] &amp; 0x8) ? 1 : 0;\n\t\t\t\tdsi-&gt;chroma_fmt = (p[1]&gt;&gt;1) &amp; 0x3;\n\t\t\t\tdsi-&gt;height = ((p[1] &amp; 0x1) &lt;&lt; 13) | ((p[2] &amp; 0x80) &lt;&lt; 5) | (dsi-&gt;height &amp; 0x0fff);\n\t\t\t\tdsi-&gt;width = (((p[2] &gt;&gt; 5) &amp; 0x3) &lt;&lt; 12) | (dsi-&gt;width &amp; 0x0fff);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase M2V_PIC_START_CODE:\n\t\t\tif (dsi-&gt;width) go = 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t\t/*EOS*/\n\t\tcase -1:\n\t\t\tgo = 0;\n\t\t\tm4v-&gt;current_object_start = gf_bs_get_position(m4v-&gt;bs);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nstatic const struct {\n\tu32 w, h;\n} m4v_sar[6] = { { 0,   0 }, { 1,   1 }, { 12, 11 }, { 10, 11 }, { 16, 11 }, { 40, 33 } };\n\nstatic u8 m4v_get_sar_idx(u32 w, u32 h)\n{\n\tu32 i;\n\tfor (i = 0; i &lt; 6; i++) {\n\t\tif ((m4v_sar[i].w == w) &amp;&amp; (m4v_sar[i].h == h)) return i;\n\t}\n\treturn 0xF;\n}\n\nstatic void gf_m4v_parse_vol(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi)\n{\n\tu8 verid, par;\n\ts32 clock_rate;\n\tu8 vpl = dsi-&gt;VideoPL;\n\n\tmemset(dsi, 0, sizeof(GF_M4VDecSpecInfo));\n\tdsi-&gt;VideoPL = vpl;\n\n\tverid = 0;\n\tdsi-&gt;RAP_stream = gf_bs_read_int(m4v-&gt;bs, 1);\n\tdsi-&gt;objectType = gf_bs_read_int(m4v-&gt;bs, 8);\n\tif (gf_bs_read_int(m4v-&gt;bs, 1)) {\n\t\tverid = gf_bs_read_int(m4v-&gt;bs, 4);\n\t\tgf_bs_read_int(m4v-&gt;bs, 3);\n\t}\n\tpar = gf_bs_read_int(m4v-&gt;bs, 4);\n\tif (par == 0xF) {\n\t\tdsi-&gt;par_num = gf_bs_read_int(m4v-&gt;bs, 8);\n\t\tdsi-&gt;par_den = gf_bs_read_int(m4v-&gt;bs, 8);\n\t} else if (par&lt;6) {\n\t\tdsi-&gt;par_num = m4v_sar[par].w;\n\t\tdsi-&gt;par_den = m4v_sar[par].h;\n\t}\n\tif (gf_bs_read_int(m4v-&gt;bs, 1)) {\n\t\tdsi-&gt;chroma_fmt = gf_bs_read_int(m4v-&gt;bs, 2);\n\t\tgf_bs_read_int(m4v-&gt;bs, 1);\n\t\tif (gf_bs_read_int(m4v-&gt;bs, 1)) gf_bs_read_int(m4v-&gt;bs, 79);\n\t}\n\tdsi-&gt;has_shape = gf_bs_read_int(m4v-&gt;bs, 2);\n\tif (dsi-&gt;has_shape &amp;&amp; (verid!=1) ) gf_bs_read_int(m4v-&gt;bs, 4);\n\tgf_bs_read_int(m4v-&gt;bs, 1);\n\t/*clock rate*/\n\tdsi-&gt;clock_rate = gf_bs_read_int(m4v-&gt;bs, 16);\n\t/*marker*/\n\tgf_bs_read_int(m4v-&gt;bs, 1);\n\n\tclock_rate = dsi-&gt;clock_rate-1;\n\tif (clock_rate &gt;= 65536) clock_rate = 65535;\n\tif (clock_rate &gt; 0) {\n\t\tfor (dsi-&gt;NumBitsTimeIncrement = 1; dsi-&gt;NumBitsTimeIncrement &lt; 16; dsi-&gt;NumBitsTimeIncrement++)\t{\n\t\t\tif (clock_rate == 1) break;\n\t\t\tclock_rate = (clock_rate &gt;&gt; 1);\n\t\t}\n\t} else {\n\t\t/*fix from vivien for divX*/\n\t\tdsi-&gt;NumBitsTimeIncrement = 1;\n\t}\n\t/*fixed FPS stream*/\n\tdsi-&gt;time_increment = 0;\n\tif (gf_bs_read_int(m4v-&gt;bs, 1)) {\n\t\tdsi-&gt;time_increment = gf_bs_read_int(m4v-&gt;bs, dsi-&gt;NumBitsTimeIncrement);\n\t}\n\tif (!dsi-&gt;has_shape) {\n\t\tgf_bs_read_int(m4v-&gt;bs, 1); //marker bit\n\t\tdsi-&gt;width = gf_bs_read_int(m4v-&gt;bs, 13);\n\t\tgf_bs_read_int(m4v-&gt;bs, 1); //marker bit\n\t\tdsi-&gt;height = gf_bs_read_int(m4v-&gt;bs, 13);\n\t\tgf_bs_read_int(m4v-&gt;bs, 1); //marker bit\n\t\tdsi-&gt;progresive = !gf_bs_read_int(m4v-&gt;bs, 1);\n\t} else {\n\t\tdsi-&gt;width = dsi-&gt;height = 0;\n\t}\n\tgf_bs_align(m4v-&gt;bs);\n}\n\nstatic GF_Err gf_m4v_parse_config_mpeg4(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi)\n{\n\ts32 o_type;\n\tu8 go;\n\n\tif (!m4v || !dsi) return GF_BAD_PARAM;\n\n\tmemset(dsi, 0, sizeof(GF_M4VDecSpecInfo));\n\n\tgo = 1;\n\twhile (go) {\n\t\to_type = M4V_LoadObject(m4v);\n\t\tswitch (o_type) {\n\t\t\t/*vosh*/\n\t\tcase M4V_VOS_START_CODE:\n\t\t\tdsi-&gt;VideoPL = (u8)gf_bs_read_u8(m4v-&gt;bs);\n\t\t\tbreak;\n\n\t\tcase M4V_VOL_START_CODE:\n\t\t\tgf_m4v_parse_vol(m4v, dsi);\n\t\t\t/*shape will be done later*/\n\t\t\tgf_bs_align(m4v-&gt;bs);\n\t\t\tbreak;\n\n\t\tcase M4V_VOP_START_CODE:\n\t\tcase M4V_GOV_START_CODE:\n\t\t\tgo = 0;\n\t\t\tbreak;\n\t\t\t/*EOS*/\n\t\tcase -1:\n\t\t\tm4v-&gt;current_object_start = gf_bs_get_position(m4v-&gt;bs);\n\t\t\treturn GF_EOS;\n\t\t\t/*don&#x27;t interest us*/\n\t\tcase M4V_UDTA_START_CODE:\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_m4v_parse_config(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi)\n{\n\tif (m4v-&gt;mpeg12) {\n\t\treturn gf_m4v_parse_config_mpeg12(m4v, dsi);\n\t}\n\telse {\n\t\treturn gf_m4v_parse_config_mpeg4(m4v, dsi);\n\t}\n}\n\nstatic GF_Err gf_m4v_parse_frame_mpeg12(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi, u8 *frame_type, u32 *time_inc, u64 *size, u64 *start, Bool *is_coded)\n{\n\tu8 go, hasVOP, firstObj, val;\n\ts32 o_type;\n\n\tif (!m4v || !size || !start || !frame_type) return GF_BAD_PARAM;\n\n\t*size = 0;\n\tfirstObj = 1;\n\thasVOP = 0;\n\t*is_coded = GF_FALSE;\n\t*frame_type = 0;\n\n\tif (!m4v-&gt;step_mode)\n\t\tM4V_Reset(m4v, m4v-&gt;current_object_start);\n\n\tm4v-&gt;current_object_type = (u32)-1;\n\tgo = 1;\n\twhile (go) {\n\t\to_type = M4V_LoadObject(m4v);\n\t\tswitch (o_type) {\n\t\tcase M2V_PIC_START_CODE:\n\t\t\t/*done*/\n\t\t\tif (hasVOP) {\n\t\t\t\tgo = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (firstObj) {\n\t\t\t\t*start = m4v-&gt;current_object_start;\n\t\t\t\tfirstObj = 0;\n\t\t\t}\n\t\t\thasVOP = 1;\n\t\t\t*is_coded = 1;\n\n\t\t\t/*val = */gf_bs_read_u8(m4v-&gt;bs);\n\t\t\tval = gf_bs_read_u8(m4v-&gt;bs);\n\t\t\t*frame_type = ((val &gt;&gt; 3) &amp; 0x7);\n\t\t\tbreak;\n\t\tcase M2V_GOP_START_CODE:\n\t\t\tif (firstObj) {\n\t\t\t\t*start = m4v-&gt;current_object_start;\n\t\t\t\tfirstObj = 0;\n\t\t\t}\n\t\t\tif (hasVOP) go = 0;\n\t\t\tbreak;\n\n\t\tcase M2V_SEQ_START_CODE:\n\t\t\tif (firstObj) {\n\t\t\t\t*start = m4v-&gt;current_object_start;\n\t\t\t\tfirstObj = 0;\n\t\t\t}\n\t\t\tif (hasVOP) {\n\t\t\t\tgo = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t/**/\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tbreak;\n\n\t\tcase -1:\n\t\t\t*size = gf_bs_get_position(m4v-&gt;bs) - *start;\n\t\t\treturn GF_EOS;\n\t\t}\n\t\tif (m4v-&gt;step_mode)\n\t\t\treturn GF_OK;\n\t}\n\t*size = m4v-&gt;current_object_start - *start;\n\treturn GF_OK;\n}\n\nstatic GF_Err gf_m4v_parse_frame_mpeg4(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi, u8 *frame_type, u32 *time_inc, u64 *size, u64 *start, Bool *is_coded)\n{\n\tu8 go, hasVOP, firstObj, secs;\n\ts32 o_type;\n\tu32 vop_inc = 0;\n\n\tif (!m4v || !size || !start || !frame_type) return GF_BAD_PARAM;\n\n\t*size = 0;\n\tfirstObj = 1;\n\thasVOP = 0;\n\t*is_coded = 0;\n\tm4v-&gt;current_object_type = (u32)-1;\n\t*frame_type = 0;\n\t*start = 0;\n\n\tif (!m4v-&gt;step_mode)\n\t\tM4V_Reset(m4v, m4v-&gt;current_object_start);\n\n\tgo = 1;\n\twhile (go) {\n\t\to_type = M4V_LoadObject(m4v);\n\t\tswitch (o_type) {\n\t\tcase M4V_VOP_START_CODE:\n\t\t\t/*done*/\n\t\t\tif (hasVOP) {\n\t\t\t\tgo = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (firstObj) {\n\t\t\t\t*start = m4v-&gt;current_object_start;\n\t\t\t\tfirstObj = 0;\n\t\t\t}\n\t\t\thasVOP = 1;\n\n\t\t\t/*coding type*/\n\t\t\t*frame_type = 1 + gf_bs_read_int(m4v-&gt;bs, 2);\n\t\t\t/*modulo time base*/\n\t\t\tsecs = 0;\n\t\t\twhile (gf_bs_read_int(m4v-&gt;bs, 1) != 0)\n\t\t\t\tsecs++;\n\t\t\t/*no support for B frames in parsing*/\n\t\t\tsecs += (dsi-&gt;enh_layer || *frame_type!=2) ? m4v-&gt;tc_dec : m4v-&gt;tc_disp;\n\t\t\t/*marker*/\n\t\t\tgf_bs_read_int(m4v-&gt;bs, 1);\n\t\t\t/*vop_time_inc*/\n\t\t\tif (dsi-&gt;NumBitsTimeIncrement)\n\t\t\t\tvop_inc = gf_bs_read_int(m4v-&gt;bs, dsi-&gt;NumBitsTimeIncrement);\n\n\t\t\tm4v-&gt;prev_tc_dec = m4v-&gt;tc_dec;\n\t\t\tm4v-&gt;prev_tc_disp = m4v-&gt;tc_disp;\n\t\t\tif (dsi-&gt;enh_layer || *frame_type!=2) {\n\t\t\t\tm4v-&gt;tc_disp = m4v-&gt;tc_dec;\n\t\t\t\tm4v-&gt;tc_dec = secs;\n\t\t\t}\n\t\t\t*time_inc = secs * dsi-&gt;clock_rate + vop_inc;\n\t\t\t/*marker*/\n\t\t\tgf_bs_read_int(m4v-&gt;bs, 1);\n\t\t\t/*coded*/\n\t\t\t*is_coded = gf_bs_read_int(m4v-&gt;bs, 1);\n\t\t\tgf_bs_align(m4v-&gt;bs);\n\t\t\tbreak;\n\t\tcase M4V_GOV_START_CODE:\n\t\t\tif (firstObj) {\n\t\t\t\t*start = m4v-&gt;current_object_start;\n\t\t\t\tfirstObj = 0;\n\t\t\t}\n\t\t\tif (hasVOP) go = 0;\n\t\t\tbreak;\n\n\t\tcase M4V_VOL_START_CODE:\n\t\t\tif (m4v-&gt;step_mode)\n\t\t\t\tgf_m4v_parse_vol(m4v, dsi);\n\t\tcase M4V_VOS_START_CODE:\n\t\t\tif (hasVOP) {\n\t\t\t\tgo = 0;\n\t\t\t}\n\t\t\telse if (firstObj) {\n\t\t\t\t*start = m4v-&gt;current_object_start;\n\t\t\t\tfirstObj = 0;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase M4V_VO_START_CODE:\n\t\tdefault:\n\t\t\tbreak;\n\n\t\tcase -1:\n\t\t\t*size = gf_bs_get_position(m4v-&gt;bs) - *start;\n\t\t\treturn GF_EOS;\n\t\t}\n\t\tif (m4v-&gt;step_mode)\n\t\t\treturn GF_OK;\n\t}\n\tassert(m4v-&gt;current_object_start &gt;= *start);\n\t*size = m4v-&gt;current_object_start - *start;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_m4v_parse_frame(GF_M4VParser *m4v, GF_M4VDecSpecInfo *dsi, u8 *frame_type, u32 *time_inc, u64 *size, u64 *start, Bool *is_coded)\n{\n\tif (m4v-&gt;mpeg12) {\n\t\treturn gf_m4v_parse_frame_mpeg12(m4v, dsi, frame_type, time_inc, size, start, is_coded);\n\t}\n\telse {\n\t\treturn gf_m4v_parse_frame_mpeg4(m4v, dsi, frame_type, time_inc, size, start, is_coded);\n\t}\n}\n\nGF_Err gf_m4v_rewrite_par(u8 **o_data, u32 *o_dataLen, s32 par_n, s32 par_d)\n{\n\tu64 start, end, size;\n\tGF_BitStream *mod;\n\tGF_M4VParser *m4v;\n\tBool go = 1;\n\n\tm4v = gf_m4v_parser_new(*o_data, *o_dataLen, 0);\n\tmod = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\n\tstart = 0;\n\twhile (go) {\n\t\tu32 type = M4V_LoadObject(m4v);\n\n\t\tend = gf_bs_get_position(m4v-&gt;bs) - 4;\n\t\tsize = end - start;\n\t\t/*store previous object*/\n\t\tif (size) {\n\t\t\tassert (size &lt; (u64)1&lt;&lt;31);\n\t\t\tgf_bs_write_data(mod, *o_data + start, (u32)size);\n\t\t\tstart = end;\n\t\t}\n\n\t\tswitch (type) {\n\t\tcase M4V_VOL_START_CODE:\n\t\t\tgf_bs_write_int(mod, 0, 8);\n\t\t\tgf_bs_write_int(mod, 0, 8);\n\t\t\tgf_bs_write_int(mod, 1, 8);\n\t\t\tgf_bs_write_int(mod, M4V_VOL_START_CODE, 8);\n\t\t\tgf_bs_write_int(mod, gf_bs_read_int(m4v-&gt;bs, 1), 1);\n\t\t\tgf_bs_write_int(mod, gf_bs_read_int(m4v-&gt;bs, 8), 8);\n\t\t\tstart = gf_bs_read_int(m4v-&gt;bs, 1);\n\t\t\tgf_bs_write_int(mod, (u32)start, 1);\n\t\t\tif (start) {\n\t\t\t\tgf_bs_write_int(mod, gf_bs_read_int(m4v-&gt;bs, 7), 7);\n\t\t\t}\n\t\t\tstart = gf_bs_read_int(m4v-&gt;bs, 4);\n\t\t\tif (start == 0xF) {\n\t\t\t\tgf_bs_read_int(m4v-&gt;bs, 8);\n\t\t\t\tgf_bs_read_int(m4v-&gt;bs, 8);\n\t\t\t}\n\t\t\tif ((par_n &gt;= 0) &amp;&amp; (par_d &gt;= 0)) {\n\t\t\t\tu8 par = m4v_get_sar_idx(par_n, par_d);\n\t\t\t\tgf_bs_write_int(mod, par, 4);\n\t\t\t\tif (par == 0xF) {\n\t\t\t\t\tgf_bs_write_int(mod, par_n, 8);\n\t\t\t\t\tgf_bs_write_int(mod, par_d, 8);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tgf_bs_write_int(mod, 0x0, 4);\n\t\t\t}\n\t\tcase -1:\n\t\t\tgo = 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\twhile (gf_bs_bits_available(m4v-&gt;bs)) {\n\t\tu32 b = gf_bs_read_int(m4v-&gt;bs, 1);\n\t\tgf_bs_write_int(mod, b, 1);\n\t}\n\n\tgf_m4v_parser_del(m4v);\n\tgf_free(*o_data);\n\tgf_bs_get_content(mod, o_data, o_dataLen);\n\tgf_bs_del(mod);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nu64 gf_m4v_get_object_start(GF_M4VParser *m4v)\n{\n\treturn m4v-&gt;current_object_start;\n}\n\n#if 0 //unused\nBool gf_m4v_is_valid_object_type(GF_M4VParser *m4v)\n{\n\treturn ((s32)m4v-&gt;current_object_type == -1) ? 0 : 1;\n}\n#endif\n\n\nGF_EXPORT\nGF_Err gf_m4v_get_config(u8 *rawdsi, u32 rawdsi_size, GF_M4VDecSpecInfo *dsi)\n{\n\tGF_Err e;\n\tGF_M4VParser *vparse;\n\tif (!rawdsi || !rawdsi_size) return GF_NON_COMPLIANT_BITSTREAM;\n\tvparse = gf_m4v_parser_new(rawdsi, rawdsi_size, 0);\n\te = gf_m4v_parse_config(vparse, dsi);\n\tdsi-&gt;next_object_start = (u32)vparse-&gt;current_object_start;\n\tgf_m4v_parser_del(vparse);\n\treturn e &lt; 0 ? e : GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_mpegv12_get_config(u8 *rawdsi, u32 rawdsi_size, GF_M4VDecSpecInfo *dsi)\n{\n\tGF_Err e;\n\tGF_M4VParser *vparse;\n\tif (!rawdsi || !rawdsi_size) return GF_NON_COMPLIANT_BITSTREAM;\n\tvparse = gf_m4v_parser_new(rawdsi, rawdsi_size, GF_TRUE);\n\te = gf_m4v_parse_config(vparse, dsi);\n\tdsi-&gt;next_object_start = (u32)vparse-&gt;current_object_start;\n\tgf_m4v_parser_del(vparse);\n\treturn e;\n}\n\n#endif\n\n\n/*\n\tAAC parser\n*/\n\nstruct __m4a_oti\n{\n\tu32 type;\n\tconst char *name;\n} M4AObjectTypes[] = {\n\t{0, &quot;MPEG-4 Audio Reserved&quot;},\n\t{1, &quot;MPEG-4 Audio AAC Main&quot;},\n\t{2, &quot;MPEG-4 Audio AAC LC&quot;},\n\t{3, &quot;MPEG-4 Audio AAC SSR&quot;},\n\t{4, &quot;MPEG-4 Audio AAC LTP&quot;},\n\t{5, &quot;MPEG-4 Audio SBR&quot;},\n\t{6, &quot;MPEG-4 Audio AAC Scalable&quot;},\n\t{7, &quot;MPEG-4 Audio TwinVQ&quot;},\n\t{8, &quot;MPEG-4 Audio CELP&quot;},\n\t{9, &quot;MPEG-4 Audio HVXC&quot;},\n\t{10, &quot;MPEG-4 Audio Reserved&quot;},\n\t{11, &quot;MPEG-4 Audio Reserved&quot;},\n\t{12, &quot;MPEG-4 Audio TTSI&quot;},\n\t{13, &quot;MPEG-4 Audio Main synthetic&quot;},\n\t{14, &quot;MPEG-4 Audio Wavetable synthesis&quot;},\n\t{15, &quot;MPEG-4 Audio General MIDI&quot;},\n\t{16, &quot;MPEG-4 Audio Algorithmic Synthesis and Audio FX&quot;},\n\t{17, &quot;MPEG-4 Audio ER AAC LC&quot;},\n\t{18, &quot;MPEG-4 Audio Reserved&quot;},\n\t{19, &quot;MPEG-4 Audio ER AAC LTP&quot;},\n\t{20, &quot;MPEG-4 Audio ER AAC scalable&quot;},\n\t{21, &quot;MPEG-4 Audio ER TwinVQ&quot;},\n\t{22, &quot;MPEG-4 Audio ER BSAC&quot;},\n\t{23, &quot;MPEG-4 Audio ER AAC LD&quot;},\n\t{24, &quot;MPEG-4 Audio ER CELP&quot;},\n\t{25, &quot;MPEG-4 Audio ER HVXC&quot;},\n\t{26, &quot;MPEG-4 Audio ER HILN&quot;},\n\t{27, &quot;MPEG-4 Audio ER Parametric&quot;},\n\t{28, &quot;MPEG-4 Audio SSC&quot;},\n\t{29, &quot;MPEG-4 Audio ParametricStereo&quot;},\n\t{30, &quot;MPEG-4 Audio Reserved&quot;},\n\t{31, &quot;MPEG-4 Audio Reserved&quot;},\n\t{32, &quot;MPEG-1 Audio Layer-1&quot;},\n\t{33, &quot;MPEG-1 Audio Layer-2&quot;},\n\t{34, &quot;MPEG-1 Audio Layer-3&quot;},\n\t{35, &quot;MPEG-4 Audio DST&quot;},\n\t{36, &quot;MPEG-4 Audio ALS&quot;},\n\t{37, &quot;MPEG-4 Audio SLS&quot;},\n\t{42, &quot;MPEG Audio xHE-AAC&quot;},\n};\n\nGF_EXPORT\nconst char *gf_m4a_object_type_name(u32 objectType)\n{\n\tu32 i, count = GF_ARRAY_LENGTH(M4AObjectTypes);\n\tfor (i=0; i&lt;count; i++) {\n\t\tif (objectType==M4AObjectTypes[i].type)\n\t\t\treturn M4AObjectTypes[i].name;\n\t}\n\treturn &quot;MPEG-4 Audio Unknown&quot;;\n}\n\nstruct __m4a_profile\n{\n\tu32 value;\n\tconst char *name;\n} M4AProfiles[] = {\n\t{0x00, &quot;ISO Reserved (0x00)&quot;},\n\t{0x01, &quot;Main Audio Profile @ Level 1&quot;},\n\t{0x02, &quot;Main Audio Profile @ Level 2&quot;},\n\t{0x03, &quot;Main Audio Profile @ Level 3&quot;},\n\t{0x04, &quot;Main Audio Profile @ Level 4&quot;},\n\t{0x05, &quot;Scalable Audio Profile @ Level 1&quot;},\n\t{0x06, &quot;Scalable Audio Profile @ Level 2&quot;},\n\t{0x07, &quot;Scalable Audio Profile @ Level 3&quot;},\n\t{0x08, &quot;Scalable Audio Profile @ Level 4&quot;},\n\t{0x09, &quot;Speech Audio Profile @ Level 1&quot;},\n\t{0x0A, &quot;Speech Audio Profile @ Level 2&quot;},\n\t{0x0B, &quot;Synthetic Audio Profile @ Level 1&quot;},\n\t{0x0C, &quot;Synthetic Audio Profile @ Level 2&quot;},\n\t{0x0D, &quot;Synthetic Audio Profile @ Level 3&quot;},\n\t{0x0E, &quot;High Quality Audio Profile @ Level 1&quot;},\n\t{0x0F, &quot;High Quality Audio Profile @ Level 2&quot;},\n\t{0x10, &quot;High Quality Audio Profile @ Level 3&quot;},\n\t{0x11, &quot;High Quality Audio Profile @ Level 4&quot;},\n\t{0x12, &quot;High Quality Audio Profile @ Level 5&quot;},\n\t{0x13, &quot;High Quality Audio Profile @ Level 6&quot;},\n\t{0x14, &quot;High Quality Audio Profile @ Level 7&quot;},\n\t{0x15, &quot;High Quality Audio Profile @ Level 8&quot;},\n\t{0x16, &quot;Low Delay Audio Profile @ Level 1&quot;},\n\t{0x17, &quot;Low Delay Audio Profile @ Level 2&quot;},\n\t{0x18, &quot;Low Delay Audio Profile @ Level 3&quot;},\n\t{0x19, &quot;Low Delay Audio Profile @ Level 4&quot;},\n\t{0x1A, &quot;Low Delay Audio Profile @ Level 5&quot;},\n\t{0x1B, &quot;Low Delay Audio Profile @ Level 6&quot;},\n\t{0x1C, &quot;Low Delay Audio Profile @ Level 7&quot;},\n\t{0x1D, &quot;Low Delay Audio Profile @ Level 8&quot;},\n\t{0x1E, &quot;Natural Audio Profile @ Level 1&quot;},\n\t{0x1F, &quot;Natural Audio Profile @ Level 2&quot;},\n\t{0x20, &quot;Natural Audio Profile @ Level 3&quot;},\n\t{0x21, &quot;Natural Audio Profile @ Level 4&quot;},\n\t{0x22, &quot;Mobile Audio Internetworking Profile @ Level 1&quot;},\n\t{0x23, &quot;Mobile Audio Internetworking Profile @ Level 2&quot;},\n\t{0x24, &quot;Mobile Audio Internetworking Profile @ Level 3&quot;},\n\t{0x25, &quot;Mobile Audio Internetworking Profile @ Level 4&quot;},\n\t{0x26, &quot;Mobile Audio Internetworking Profile @ Level 5&quot;},\n\t{0x27, &quot;Mobile Audio Internetworking Profile @ Level 6&quot;},\n\t{0x28, &quot;AAC Profile @ Level 1&quot;},\n\t{0x29, &quot;AAC Profile @ Level 2&quot;},\n\t{0x2A, &quot;AAC Profile @ Level 4&quot;},\n\t{0x2B, &quot;AAC Profile @ Level 5&quot;},\n\t{0x2C, &quot;High Efficiency AAC Profile @ Level 2&quot;},\n\t{0x2D, &quot;High Efficiency AAC Profile @ Level 3&quot;},\n\t{0x2E, &quot;High Efficiency AAC Profile @ Level 4&quot;},\n\t{0x2F, &quot;High Efficiency AAC Profile @ Level 5&quot;},\n\t{0x30, &quot;High Efficiency AAC v2 Profile @ Level 2&quot;},\n\t{0x31, &quot;High Efficiency AAC v2 Profile @ Level 3&quot;},\n\t{0x32, &quot;High Efficiency AAC v2 Profile @ Level 4&quot;},\n\t{0x33, &quot;High Efficiency AAC v2 Profile @ Level 5&quot;},\n\t{0x34, &quot;Low Delay AAC Profile&quot;},\n\t{0x35, &quot;Baseline MPEG Surround Profile @ Level 1&quot;},\n\t{0x36, &quot;Baseline MPEG Surround Profile @ Level 2&quot;},\n\t{0x37, &quot;Baseline MPEG Surround Profile @ Level 3&quot;},\n\t{0x38, &quot;Baseline MPEG Surround Profile @ Level 4&quot;},\n\t{0x39, &quot;Baseline MPEG Surround Profile @ Level 5&quot;},\n\t{0x3A, &quot;Baseline MPEG Surround Profile @ Level 6&quot;},\n\t{0x3B, &quot;High Definition AAC Profile @ Level 1&quot;},\n\t{0x3C, &quot;ALS Simple Profile @ Level 1&quot;},\n\t{0x50, &quot;AAC Profile @ Level 6&quot;},\n\t{0x51, &quot;AAC Profile @ Level 7&quot;},\n\t{0x52, &quot;High Efficiency AAC Profile @ Level 6&quot;},\n\t{0x53, &quot;High Efficiency AAC Profile @ Level 7&quot;},\n\t{0x54, &quot;High Efficiency AAC v2 Profile @ Level 6&quot;},\n\t{0x55, &quot;High Efficiency AAC v2 Profile @ Level 7&quot;},\n\t{0x56, &quot;Extended High Efficiency AAC Profile @ Level 6&quot;},\n\t{0x57, &quot;Extended High Efficiency AAC Profile @ Level 7&quot;},\n\t{0xFE, &quot;Not part of MPEG-4 audio profiles&quot;},\n\t{0xFF, &quot;No audio capability required&quot;}\n};\n\nGF_EXPORT\nconst char *gf_m4a_get_profile_name(u8 audio_pl)\n{\n\tu32 i, count = GF_ARRAY_LENGTH(M4AProfiles);\n\tfor (i=0; i&lt;count; i++) {\n\t\tif ((u32) audio_pl==M4AProfiles[i].value)\n\t\t\treturn M4AProfiles[i].name;\n\t}\n\treturn &quot;ISO Reserved / User Private&quot;;\n}\n\n#ifndef GPAC_DISABLE_AV_PARSERS\n\nGF_EXPORT\nu32 gf_m4a_get_profile(GF_M4ADecSpecInfo *cfg)\n{\n\tswitch (cfg-&gt;base_object_type) {\n\tcase 2: /*AAC LC*/\n\t\tif (cfg-&gt;nb_chan &lt;= 2)\n\t\t\treturn (cfg-&gt;base_sr &lt;= 24000) ? 0x28 : 0x29; /*LC@L1 or LC@L2*/\n\t\tif (cfg-&gt;nb_chan &lt;= 5)\n\t\t\treturn (cfg-&gt;base_sr &lt;= 48000) ? 0x2A : 0x2B; /*LC@L4 or LC@L5*/\n\t\treturn (cfg-&gt;base_sr &lt;= 48000) ? 0x50 : 0x51; /*LC@L4 or LC@L5*/\n\tcase 5: /*HE-AAC - SBR*/\n\t\tif (cfg-&gt;nb_chan &lt;= 2)\n\t\t\treturn (cfg-&gt;base_sr &lt;= 24000) ? 0x2C : 0x2D; /*HE@L2 or HE@L3*/\n\t\tif (cfg-&gt;nb_chan &lt;= 5)\n\t\t\treturn (cfg-&gt;base_sr &lt;= 48000) ? 0x2E : 0x2F; /*HE@L4 or HE@L5*/\n\t\treturn (cfg-&gt;base_sr &lt;= 48000) ? 0x52 : 0x53; /*HE@L6 or HE@L7*/\n\tcase 29: /*HE-AACv2 - SBR+PS*/\n\t\tif (cfg-&gt;nb_chan &lt;= 2)\n\t\t\treturn (cfg-&gt;base_sr &lt;= 24000) ? 0x30 : 0x31; /*HE-AACv2@L2 or HE-AACv2@L3*/\n\t\tif (cfg-&gt;nb_chan &lt;= 5)\n\t\t\treturn (cfg-&gt;base_sr &lt;= 48000) ? 0x32 : 0x33; /*HE-AACv2@L4 or HE-AACv2@L5*/\n\t\treturn (cfg-&gt;base_sr &lt;= 48000) ? 0x54 : 0x55; /*HE-AACv2@L6 or HE-AACv2@L7*/\n\t/*default to HQ*/\n\tdefault:\n\t\tif (cfg-&gt;nb_chan &lt;= 2) return (cfg-&gt;base_sr &lt; 24000) ? 0x0E : 0x0F; /*HQ@L1 or HQ@L2*/\n\t\treturn 0x10; /*HQ@L3*/\n\t}\n}\n\nGF_EXPORT\nGF_Err gf_m4a_parse_program_config_element(GF_BitStream *bs, GF_M4ADecSpecInfo *cfg)\n{\n\tu32 i;\n\n\tcfg-&gt;program_config_element_present = 1;\n\tcfg-&gt;cpe_channels = 0;\n\n\tcfg-&gt;element_instance_tag = gf_bs_read_int_log(bs, 4, &quot;element_instance_tag&quot;);\n\tcfg-&gt;object_type = gf_bs_read_int_log(bs, 2, &quot;object_type&quot;);\n\tcfg-&gt;sampling_frequency_index = gf_bs_read_int_log(bs, 4, &quot;sampling_frequency_index&quot;);\n\tcfg-&gt;num_front_channel_elements = gf_bs_read_int_log(bs, 4, &quot;num_front_channel_elements&quot;);\n\tcfg-&gt;num_side_channel_elements = gf_bs_read_int_log(bs, 4, &quot;num_side_channel_elements&quot;);\n\tcfg-&gt;num_back_channel_elements = gf_bs_read_int_log(bs, 4, &quot;num_back_channel_elements&quot;);\n\tcfg-&gt;num_lfe_channel_elements = gf_bs_read_int_log(bs, 2, &quot;num_lfe_channel_elements&quot;);\n\tcfg-&gt;num_assoc_data_elements = gf_bs_read_int_log(bs, 3, &quot;num_assoc_data_elements&quot;);\n\tcfg-&gt;num_valid_cc_elements = gf_bs_read_int_log(bs, 4, &quot;num_valid_cc_elements&quot;);\n\tcfg-&gt;mono_mixdown_present = (Bool)gf_bs_read_int_log(bs, 1, &quot;mono_mixdown_present&quot;);\n\tif (cfg-&gt;mono_mixdown_present) {\n\t\tcfg-&gt;mono_mixdown_element_number = gf_bs_read_int_log(bs, 4, &quot;mono_mixdown_element_number&quot;);\n\t}\n\tcfg-&gt;stereo_mixdown_present = gf_bs_read_int_log(bs, 1, &quot;stereo_mixdown_present&quot;);\n\tif (cfg-&gt;stereo_mixdown_present) {\n\t\tcfg-&gt;stereo_mixdown_element_number = gf_bs_read_int_log(bs, 4, &quot;stereo_mixdown_element_number&quot;);\n\t}\n\tcfg-&gt;matrix_mixdown_idx_present = gf_bs_read_int_log(bs, 1, &quot;matrix_mixdown_idx_present&quot;);\n\tif (cfg-&gt;matrix_mixdown_idx_present) {\n\t\tcfg-&gt;matrix_mixdown_idx = gf_bs_read_int_log(bs, 2, &quot;matrix_mixdown_idx&quot;);\n\t\tcfg-&gt;pseudo_surround_enable = gf_bs_read_int_log(bs, 1, &quot;pseudo_surround_enable&quot;);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_front_channel_elements; i++) {\n\t\tcfg-&gt;front_element_is_cpe[i] = gf_bs_read_int_log_idx(bs, 1, &quot;front_element_is_cpe&quot;, i);\n\t\tcfg-&gt;front_element_tag_select[i] = gf_bs_read_int_log_idx(bs, 4, &quot;front_element_tag_select&quot;, i);\n\t\tif (cfg-&gt;front_element_is_cpe[i]) cfg-&gt;cpe_channels++;\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_side_channel_elements; i++) {\n\t\tcfg-&gt;side_element_is_cpe[i] = gf_bs_read_int_log_idx(bs, 1, &quot;side_element_is_cpe&quot;, i);\n\t\tcfg-&gt;side_element_tag_select[i] = gf_bs_read_int_log_idx(bs, 4, &quot;side_element_tag_select&quot;, i);\n\t\tif (cfg-&gt;side_element_is_cpe[i]) cfg-&gt;cpe_channels++;\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_back_channel_elements; i++) {\n\t\tcfg-&gt;back_element_is_cpe[i] = gf_bs_read_int_log_idx(bs, 1, &quot;back_element_is_cpe&quot;, i);\n\t\tcfg-&gt;back_element_tag_select[i] = gf_bs_read_int_log_idx(bs, 4, &quot;back_element_tag_select&quot;, i);\n\t\tif (cfg-&gt;back_element_is_cpe[i]) cfg-&gt;cpe_channels++;\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_lfe_channel_elements; i++) {\n\t\tcfg-&gt;lfe_element_tag_select[i] = gf_bs_read_int_log_idx(bs, 4, &quot;lfe_element_tag_select&quot;, i);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_assoc_data_elements; i++) {\n\t\tcfg-&gt;assoc_data_element_tag_select[i] = gf_bs_read_int_log_idx(bs, 4, &quot;assoc_data_element_tag_select&quot;, i);\n\t}\n\n\tfor (i = 0; i &lt; cfg-&gt;num_valid_cc_elements; i++) {\n\t\tcfg-&gt;cc_element_is_ind_sw[i] = gf_bs_read_int_log_idx(bs, 1, &quot;cc_element_is_ind_sw&quot;, i);\n\t\tcfg-&gt;valid_cc_element_tag_select[i] = gf_bs_read_int_log_idx(bs, 4, &quot;valid_cc_element_tag_select&quot;, i);\n\t}\n\tgf_bs_align(bs);\n\tcfg-&gt;comment_field_bytes = gf_bs_read_int_log(bs, 8, &quot;comment_field_bytes&quot;);\n\tgf_bs_read_data(bs, (char *)cfg-&gt;comments, cfg-&gt;comment_field_bytes);\n\n\tcfg-&gt;nb_chan = cfg-&gt;num_front_channel_elements + cfg-&gt;num_back_channel_elements + cfg-&gt;num_side_channel_elements + cfg-&gt;num_lfe_channel_elements;\n\tcfg-&gt;nb_chan += cfg-&gt;cpe_channels;\n\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_m4a_parse_config(GF_BitStream *bs, GF_M4ADecSpecInfo *cfg, Bool size_known)\n{\n\tu32 audio_obj_type;\n\tmemset(cfg, 0, sizeof(GF_M4ADecSpecInfo));\n\tcfg-&gt;base_object_type = gf_bs_read_int_log(bs, 5, &quot;base_object_type&quot;);\n\t/*extended object type*/\n\tif (cfg-&gt;base_object_type == 31) {\n\t\tcfg-&gt;base_object_type = 32 + gf_bs_read_int_log(bs, 6, &quot;extended_base_object_type&quot;);\n\t}\n\tcfg-&gt;base_sr_index = gf_bs_read_int_log(bs, 4, &quot;base_samplerate_index&quot;);\n\tif (cfg-&gt;base_sr_index == 0x0F) {\n\t\tcfg-&gt;base_sr = gf_bs_read_int_log(bs, 24, &quot;base_samplerate&quot;);\n\t}\n\telse {\n\t\tcfg-&gt;base_sr = GF_M4ASampleRates[cfg-&gt;base_sr_index];\n\t}\n\n\tcfg-&gt;chan_cfg = gf_bs_read_int_log(bs, 4, &quot;channel_configuration&quot;);\n\tif (cfg-&gt;chan_cfg) {\n\t\tcfg-&gt;nb_chan = GF_M4ANumChannels[cfg-&gt;chan_cfg - 1];\n\t}\n\n\taudio_obj_type = cfg-&gt;base_object_type;\n\tif (cfg-&gt;base_object_type == 5 || cfg-&gt;base_object_type == 29) {\n\t\tif (cfg-&gt;base_object_type == 29) {\n\t\t\tcfg-&gt;has_ps = 1;\n\t\t\tcfg-&gt;nb_chan = 1;\n\t\t}\n\t\tcfg-&gt;has_sbr = GF_TRUE;\n\t\tcfg-&gt;sbr_sr_index = gf_bs_read_int_log(bs, 4, &quot;sbr_samplerate_index&quot;);\n\t\tif (cfg-&gt;sbr_sr_index == 0x0F) {\n\t\t\tcfg-&gt;sbr_sr = gf_bs_read_int_log(bs, 24, &quot;sbr_samplerate&quot;);\n\t\t}\n\t\telse {\n\t\t\tcfg-&gt;sbr_sr = GF_M4ASampleRates[cfg-&gt;sbr_sr_index];\n\t\t}\n\t\tcfg-&gt;sbr_object_type = gf_bs_read_int_log(bs, 5, &quot;sbr_object_type&quot;);\n\t\tif (cfg-&gt;sbr_object_type==31)\n\t\t\tcfg-&gt;sbr_object_type = 32 + gf_bs_read_int_log(bs, 6, &quot;audioObjectTypeExt&quot;);\n\t\taudio_obj_type = cfg-&gt;sbr_object_type;\n\t\tif (cfg-&gt;sbr_object_type==22) {\n\t\t\t/*ext_chan_cfg = */gf_bs_read_int_log(bs, 4, &quot;channel_configuration&quot;);\n\t\t}\n\t}\n\n\t/*object cfg*/\n\tswitch (audio_obj_type) {\n\tcase 1:\n\tcase 2:\n\tcase 3:\n\tcase 4:\n\tcase 6:\n\tcase 7:\n\tcase 17:\n\tcase 19:\n\tcase 20:\n\tcase 21:\n\tcase 22:\n\tcase 23:\n\tcase 42:\n\t{\n\t\tBool ext_flag;\n\t\tgf_bs_read_int_log(bs, 1, &quot;frame_length_flag&quot;);\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;depends_on_core_coder&quot;))\n\t\t\tgf_bs_read_int_log(bs, 14, &quot;delay&quot;);\n\t\text_flag = gf_bs_read_int_log(bs, 1, &quot;extension_flag&quot;);\n\n\t\tif (!cfg-&gt;chan_cfg) {\n\t\t\tgf_m4a_parse_program_config_element(bs, cfg);\n\t\t}\n\n\t\tif ((cfg-&gt;base_object_type == 6) || (cfg-&gt;base_object_type == 20)) {\n\t\t\tgf_bs_read_int_log(bs, 3, &quot;layerN&quot;);\n\t\t}\n\t\tif (ext_flag) {\n\t\t\tif (cfg-&gt;base_object_type == 22) {\n\t\t\t\tgf_bs_read_int_log(bs, 5, &quot;numOfSubFrame&quot;);\n\t\t\t\tgf_bs_read_int_log(bs, 11, &quot;layer_length&quot;);\n\t\t\t}\n\t\t\tif ((cfg-&gt;base_object_type == 17)\n\t\t\t\t|| (cfg-&gt;base_object_type == 19)\n\t\t\t\t|| (cfg-&gt;base_object_type == 20)\n\t\t\t\t|| (cfg-&gt;base_object_type == 23)\n\t\t\t) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;aacSectionDataResilienceFlag&quot;);\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;aacScalefactorDataResilienceFlag&quot;);\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;aacSpectralDataResilienceFlag&quot;);\n\t\t\t}\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;extensionFlag3&quot;);\n\t\t}\n\t}\n\tbreak;\n\t}\n\t/*ER cfg*/\n\tswitch (audio_obj_type) {\n\tcase 17:\n\tcase 19:\n\tcase 20:\n\tcase 21:\n\tcase 22:\n\tcase 23:\n\tcase 24:\n\tcase 25:\n\tcase 26:\n\tcase 27:\n\t{\n\t\tu32 epConfig = gf_bs_read_int_log(bs, 2, &quot;epConfig&quot;);\n\t\tif ((epConfig == 2) || (epConfig == 3)) {\n\t\t}\n\t\tif (epConfig == 3) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;directMapping&quot;);\n\t\t}\n\t}\n\tbreak;\n\t}\n\n\tif (size_known &amp;&amp; (cfg-&gt;base_object_type != 5) &amp;&amp; (cfg-&gt;base_object_type != 29)) {\n\t\twhile (gf_bs_available(bs) &gt;= 2) {\n\t\t\tu32 sync = gf_bs_peek_bits(bs, 11, 0);\n\t\t\tif (sync == 0x2b7) {\n\t\t\t\tgf_bs_read_int_log(bs, 11, &quot;syncExtensionType&quot;);\n\t\t\t\tcfg-&gt;sbr_object_type = gf_bs_read_int_log(bs, 5, &quot;extensionAudioObjectType &quot;);\n\t\t\t\tcfg-&gt;has_sbr = gf_bs_read_int_log(bs, 1, &quot;sbrPresentFlag&quot;);\n\t\t\t\tif (cfg-&gt;has_sbr) {\n\t\t\t\t\tcfg-&gt;sbr_sr_index = gf_bs_read_int_log(bs, 4, &quot;extensionSamplingFrequencyIndex&quot;);\n\t\t\t\t\tif (cfg-&gt;sbr_sr_index == 0x0F) {\n\t\t\t\t\t\tcfg-&gt;sbr_sr = gf_bs_read_int_log(bs, 24, &quot;extensionSamplingFrequency&quot;);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcfg-&gt;sbr_sr = GF_M4ASampleRates[cfg-&gt;sbr_sr_index];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (sync == 0x548) {\n\t\t\t\tgf_bs_read_int_log(bs, 11, &quot;syncExtensionType&quot;);\n\t\t\t\tcfg-&gt;has_ps = gf_bs_read_int_log(bs, 1, &quot;hasParametricStereo&quot;);\n\t\t\t\tif (cfg-&gt;has_ps)\n\t\t\t\t\tcfg-&gt;nb_chan = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tcfg-&gt;audioPL = gf_m4a_get_profile(cfg);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_m4a_get_config(u8 *dsi, u32 dsi_size, GF_M4ADecSpecInfo *cfg)\n{\n\tGF_BitStream *bs;\n\tif (!dsi || !dsi_size || (dsi_size &lt; 2)) return GF_NON_COMPLIANT_BITSTREAM;\n\tbs = gf_bs_new(dsi, dsi_size, GF_BITSTREAM_READ);\n\tgf_m4a_parse_config(bs, cfg, GF_TRUE);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\nu32 gf_latm_get_value(GF_BitStream *bs)\n{\n\tu32 i, tmp, value = 0;\n\tu32 bytesForValue = gf_bs_read_int(bs, 2);\n\tfor (i = 0; i &lt;= bytesForValue; i++) {\n\t\tvalue &lt;&lt;= 8;\n\t\ttmp = gf_bs_read_int(bs, 8);\n\t\tvalue += tmp;\n\t}\n\treturn value;\n}\n\nGF_EXPORT\nu32 gf_m4a_get_channel_cfg(u32 nb_chan)\n{\n\tu32 i, count = sizeof(GF_M4ANumChannels) / sizeof(u32);\n\tfor (i = 0; i &lt; count; i++) {\n\t\tif (GF_M4ANumChannels[i] == nb_chan) return i + 1;\n\t}\n\treturn 0;\n}\n\nGF_EXPORT\nGF_Err gf_m4a_write_program_config_element_bs(GF_BitStream *bs, GF_M4ADecSpecInfo *cfg)\n{\n\tu32 i;\n\tgf_bs_write_int(bs, cfg-&gt;element_instance_tag, 4);\n\tgf_bs_write_int(bs, cfg-&gt;object_type, 2);\n\tgf_bs_write_int(bs, cfg-&gt;sampling_frequency_index, 4);\n\tgf_bs_write_int(bs, cfg-&gt;num_front_channel_elements, 4);\n\tgf_bs_write_int(bs, cfg-&gt;num_side_channel_elements, 4);\n\tgf_bs_write_int(bs, cfg-&gt;num_back_channel_elements, 4);\n\tgf_bs_write_int(bs, cfg-&gt;num_lfe_channel_elements, 2);\n\tgf_bs_write_int(bs, cfg-&gt;num_assoc_data_elements, 3);\n\tgf_bs_write_int(bs, cfg-&gt;num_valid_cc_elements, 4);\n\tgf_bs_write_int(bs, cfg-&gt;mono_mixdown_present, 1);\n\tif (cfg-&gt;mono_mixdown_present) {\n\t\tgf_bs_write_int(bs, cfg-&gt;mono_mixdown_element_number, 4);\n\t}\n\tgf_bs_write_int(bs, cfg-&gt;stereo_mixdown_present, 1);\n\tif (cfg-&gt;stereo_mixdown_present) {\n\t\tgf_bs_write_int(bs, cfg-&gt;stereo_mixdown_element_number, 4);\n\t}\n\tgf_bs_write_int(bs, cfg-&gt;matrix_mixdown_idx_present, 1);\n\tif (cfg-&gt;matrix_mixdown_idx_present) {\n\t\tgf_bs_write_int(bs, cfg-&gt;matrix_mixdown_idx, 2);\n\t\tgf_bs_write_int(bs, cfg-&gt;pseudo_surround_enable, 1);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_front_channel_elements; i++) {\n\t\tgf_bs_write_int(bs, cfg-&gt;front_element_is_cpe[i], 1);\n\t\tgf_bs_write_int(bs, cfg-&gt;front_element_tag_select[i], 4);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_side_channel_elements; i++) {\n\t\tgf_bs_write_int(bs, cfg-&gt;side_element_is_cpe[i], 1);\n\t\tgf_bs_write_int(bs, cfg-&gt;side_element_tag_select[i], 4);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_back_channel_elements; i++) {\n\t\tgf_bs_write_int(bs, cfg-&gt;back_element_is_cpe[i], 1);\n\t\tgf_bs_write_int(bs, cfg-&gt;back_element_tag_select[i], 4);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_lfe_channel_elements; i++) {\n\t\tgf_bs_write_int(bs, cfg-&gt;lfe_element_tag_select[i], 4);\n\t}\n\tfor (i = 0; i &lt; cfg-&gt;num_assoc_data_elements; i++) {\n\t\tgf_bs_write_int(bs, cfg-&gt;assoc_data_element_tag_select[i], 4);\n\t}\n\n\tfor (i = 0; i &lt; cfg-&gt;num_valid_cc_elements; i++) {\n\t\tgf_bs_write_int(bs, cfg-&gt;cc_element_is_ind_sw[i], 1);\n\t\tgf_bs_write_int(bs, cfg-&gt;valid_cc_element_tag_select[i], 4);\n\t}\n\tgf_bs_align(bs);\n\tgf_bs_write_int(bs, cfg-&gt;comment_field_bytes, 8);\n\tgf_bs_write_data(bs, (char *)cfg-&gt;comments, cfg-&gt;comment_field_bytes);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_m4a_write_config_bs(GF_BitStream *bs, GF_M4ADecSpecInfo *cfg)\n{\n\tif (!cfg-&gt;base_sr_index) {\n\t\tif (!cfg-&gt;base_sr) return GF_BAD_PARAM;\n\t\twhile (GF_M4ASampleRates[cfg-&gt;base_sr_index]) {\n\t\t\tif (GF_M4ASampleRates[cfg-&gt;base_sr_index] == cfg-&gt;base_sr)\n\t\t\t\tbreak;\n\t\t\tcfg-&gt;base_sr_index++;\n\t\t}\n\t}\n\tif (cfg-&gt;sbr_sr &amp;&amp; !cfg-&gt;sbr_sr_index) {\n\t\twhile (GF_M4ASampleRates[cfg-&gt;sbr_sr_index]) {\n\t\t\tif (GF_M4ASampleRates[cfg-&gt;sbr_sr_index] == cfg-&gt;sbr_sr)\n\t\t\t\tbreak;\n\t\t\tcfg-&gt;sbr_sr_index++;\n\t\t}\n\t}\n\t/*extended object type*/\n\tif (cfg-&gt;base_object_type &gt;= 32) {\n\t\tgf_bs_write_int(bs, 31, 5);\n\t\tgf_bs_write_int(bs, cfg-&gt;base_object_type - 32, 6);\n\t}\n\telse {\n\t\tgf_bs_write_int(bs, cfg-&gt;base_object_type, 5);\n\t}\n\tgf_bs_write_int(bs, cfg-&gt;base_sr_index, 4);\n\tif (cfg-&gt;base_sr_index == 0x0F) {\n\t\tgf_bs_write_int(bs, cfg-&gt;base_sr, 24);\n\t}\n\n\tif (cfg-&gt;program_config_element_present) {\n\t\tgf_bs_write_int(bs, 0, 4);\n\t} else {\n\t\tcfg-&gt;chan_cfg = gf_m4a_get_channel_cfg(cfg-&gt;nb_chan);\n\t\tif (!cfg-&gt;chan_cfg) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AAC] Cannot write decoder config, ProgramConfigElement is missing and channel configuration is not a predefined one !\\n&quot;));\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tgf_bs_write_int(bs, cfg-&gt;chan_cfg, 4);\n\t}\n\n\tif (cfg-&gt;base_object_type == 5 || cfg-&gt;base_object_type == 29) {\n\t\tif (cfg-&gt;base_object_type == 29) {\n\t\t\tcfg-&gt;has_ps = 1;\n\t\t\tcfg-&gt;nb_chan = 1;\n\t\t}\n\t\tcfg-&gt;has_sbr = 1;\n\t\tgf_bs_write_int(bs, cfg-&gt;sbr_sr_index, 4);\n\t\tif (cfg-&gt;sbr_sr_index == 0x0F) {\n\t\t\tgf_bs_write_int(bs, cfg-&gt;sbr_sr, 24);\n\t\t}\n\t\tgf_bs_write_int(bs, cfg-&gt;sbr_object_type, 5);\n\t}\n\n\t/*object cfg*/\n\tswitch (cfg-&gt;base_object_type) {\n\tcase 1:\n\tcase 2:\n\tcase 3:\n\tcase 4:\n\tcase 6:\n\tcase 7:\n\tcase 17:\n\tcase 19:\n\tcase 20:\n\tcase 21:\n\tcase 22:\n\tcase 23:\n\tcase 42:\n\t{\n\t\t/*frame length flag*/\n\t\tgf_bs_write_int(bs, 0, 1);\n\t\t/*depends on core coder*/\n\t\tgf_bs_write_int(bs, 0, 1);\n\t\t/*ext flag*/\n\t\tgf_bs_write_int(bs, 0, 1);\n\n\t\tif (cfg-&gt;program_config_element_present) {\n\t\t\tgf_m4a_write_program_config_element_bs(bs, cfg);\n\t\t}\n\n\t\tif ((cfg-&gt;base_object_type == 6) || (cfg-&gt;base_object_type == 20)) {\n\t\t\tgf_bs_write_int(bs, 0, 3);\n\t\t}\n\t}\n\tbreak;\n\t}\n\t/*ER cfg - not supported*/\n\n\t/*implicit sbr/ps signaling not written here, cf reframe_adts*/\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_m4a_write_config(GF_M4ADecSpecInfo *cfg, u8 **dsi, u32 *dsi_size)\n{\n\tGF_BitStream *bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\tgf_m4a_write_config_bs(bs, cfg);\n\tgf_bs_get_content(bs, dsi, dsi_size);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n/*AV1 parsing*/\n\nstatic u32 av1_read_ns(GF_BitStream *bs, u32 n, const char *fname)\n{\n\tu32 v, res;\n\tBool extra_bit;\n\tint w = (u32)(log(n) / log(2)) + 1;\n\tu32 m = (1 &lt;&lt; w) - n;\n\tassert(w &lt; 32);\n\tv = gf_bs_read_int(bs, w - 1);\n\tif (v &lt; m) {\n\t\tif (fname) {\n\t\t\tgf_bs_log(bs, w-1, fname, v);\n\t\t}\n\t\treturn v;\n\t}\n\textra_bit = gf_bs_read_int(bs, 1);\n\tres = (v &lt;&lt; 1) - m + extra_bit;\n\tif (fname) {\n\t\tgf_bs_log(bs, w, fname, res);\n\t}\n\treturn res;\n}\n\nstatic void av1_color_config(GF_BitStream *bs, AV1State *state)\n{\n\tstate-&gt;config-&gt;high_bitdepth = gf_bs_read_int_log(bs, 1, &quot;high_bitdepth&quot;);\n\tstate-&gt;bit_depth = 8;\n\tif (state-&gt;config-&gt;seq_profile == 2 &amp;&amp; state-&gt;config-&gt;high_bitdepth) {\n\t\tstate-&gt;config-&gt;twelve_bit = gf_bs_read_int_log(bs, 1, &quot;twelve_bit&quot;);\n\t\tstate-&gt;bit_depth = state-&gt;config-&gt;twelve_bit ? 12 : 10;\n\t}\n\telse if (state-&gt;config-&gt;seq_profile &lt;= 2) {\n\t\tstate-&gt;bit_depth = state-&gt;config-&gt;high_bitdepth ? 10 : 8;\n\t}\n\n\tstate-&gt;config-&gt;monochrome = GF_FALSE;\n\tif (state-&gt;config-&gt;seq_profile == 1) {\n\t\tstate-&gt;config-&gt;monochrome = GF_FALSE;\n\t}\n\telse {\n\t\tstate-&gt;config-&gt;monochrome = gf_bs_read_int_log(bs, 1, &quot;monochrome&quot;);\n\t}\n\t/*NumPlanes = mono_chrome ? 1 : 3;*/\n\tstate-&gt;color_description_present_flag = gf_bs_read_int_log(bs, 1, &quot;color_description_present_flag&quot;);\n\tif (state-&gt;color_description_present_flag) {\n\t\tstate-&gt;color_primaries = gf_bs_read_int_log(bs, 8, &quot;color_primaries&quot;);\n\t\tstate-&gt;transfer_characteristics = gf_bs_read_int_log(bs, 8, &quot;transfer_characteristics&quot;);\n\t\tstate-&gt;matrix_coefficients = gf_bs_read_int_log(bs, 8, &quot;matrix_coefficients&quot;);\n\t}\n\telse {\n\t\tstate-&gt;color_primaries = 2/*CP_UNSPECIFIED*/;\n\t\tstate-&gt;transfer_characteristics = 2/*TC_UNSPECIFIED*/;\n\t\tstate-&gt;matrix_coefficients = 2/*MC_UNSPECIFIED*/;\n\t}\n\tif (state-&gt;config-&gt;monochrome) {\n\t\tstate-&gt;color_range = gf_bs_read_int_log(bs, 1, &quot;color_range&quot;);\n\t\tstate-&gt;config-&gt;chroma_subsampling_x = GF_TRUE;\n\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_TRUE;\n\t\tstate-&gt;config-&gt;chroma_sample_position = 0/*CSP_UNKNOWN*/;\n\t\tstate-&gt;separate_uv_delta_q = 0;\n\t\treturn;\n\t}\n\telse if (state-&gt;color_primaries == 0/*CP_BT_709*/ &amp;&amp;\n\t\tstate-&gt;transfer_characteristics == 13/*TC_SRGB*/ &amp;&amp;\n\t\tstate-&gt;matrix_coefficients == 0/*MC_IDENTITY*/) {\n\t\tstate-&gt;color_range = GF_TRUE;\n\t\tstate-&gt;config-&gt;chroma_subsampling_x = GF_FALSE;\n\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_FALSE;\n\t}\n\telse {\n\t\tstate-&gt;config-&gt;chroma_subsampling_x = GF_FALSE;\n\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_FALSE;\n\n\t\tstate-&gt;color_range = gf_bs_read_int_log(bs, 1, &quot;color_range&quot;);\n\t\tif (state-&gt;config-&gt;seq_profile == 0) {\n\t\t\tstate-&gt;config-&gt;chroma_subsampling_x = GF_TRUE;\n\t\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_TRUE;\n\t\t}\n\t\telse if (state-&gt;config-&gt;seq_profile == 1) {\n\t\t\tstate-&gt;config-&gt;chroma_subsampling_x = GF_FALSE;\n\t\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_FALSE;\n\t\t}\n\t\telse {\n\t\t\tif (state-&gt;bit_depth == 12) {\n\t\t\t\tstate-&gt;config-&gt;chroma_subsampling_x = gf_bs_read_int_log(bs, 1, &quot;chroma_subsampling_x&quot;);\n\t\t\t\tif (state-&gt;config-&gt;chroma_subsampling_x)\n\t\t\t\t\tstate-&gt;config-&gt;chroma_subsampling_y = gf_bs_read_int_log(bs, 1, &quot;chroma_subsampling_y&quot;);\n\t\t\t\telse\n\t\t\t\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_FALSE;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstate-&gt;config-&gt;chroma_subsampling_x = GF_TRUE;\n\t\t\t\tstate-&gt;config-&gt;chroma_subsampling_y = GF_FALSE;\n\t\t\t}\n\t\t}\n\t\tif (state-&gt;config-&gt;chroma_subsampling_x &amp;&amp; state-&gt;config-&gt;chroma_subsampling_y) {\n\t\t\tstate-&gt;config-&gt;chroma_sample_position = gf_bs_read_int_log(bs, 2, &quot;chroma_sample_position&quot;);\n\t\t}\n\t}\n\tstate-&gt;separate_uv_delta_q = gf_bs_read_int_log(bs, 1, &quot;separate_uv_delta_q&quot;);\n}\n\n\nstatic u32 av1_uvlc(GF_BitStream *bs, const char *fname)\n{\n\tu32 res;\n\tu8 leadingZeros = 0;\n\twhile (1) {\n\t\tBool done = gf_bs_read_int(bs, 1);\n\t\tif (done)\n\t\t\tbreak;\n\t\tleadingZeros++;\n\t}\n\tif (leadingZeros &gt;= 32) {\n\t\treturn 0xFFFFFFFF;\n\t}\n\tres = gf_bs_read_int(bs, leadingZeros) + (1 &lt;&lt; leadingZeros) - 1;\n\tgf_bs_log(bs, 2*leadingZeros, fname, res);\n\treturn res;\n}\n\nstatic void timing_info(GF_BitStream *bs, AV1State *state) {\n\tu32 time_scale = 0;\n\tu32 num_units_in_display_tick = gf_bs_read_int_log(bs, 32, &quot;num_units_in_display_tick&quot;);\n\tif (num_units_in_display_tick == 0) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] num_units_in_display_tick must be greater than 0.\\n&quot;));\n\t}\n\ttime_scale = gf_bs_read_int_log(bs, 32, &quot;time_scale&quot;);\n\tif (time_scale == 0) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] time_scale must be greater than 0.\\n&quot;));\n\t}\n\tstate-&gt;equal_picture_interval = gf_bs_read_int_log(bs, 1, &quot;equal_picture_interval&quot;);\n\tif (state-&gt;equal_picture_interval) {\n\t\tu32 num_ticks_per_picture_minus_1 = av1_uvlc(bs, &quot;num_ticks_per_picture_minus_1&quot;);\n\t\tstate-&gt;tb_num = time_scale;\n\t\tstate-&gt;tb_den = (num_ticks_per_picture_minus_1 + 1)*num_units_in_display_tick;\n\t}\n\telse {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] VFR not supported.\\n&quot;));\n\t\t//TODO: upload num_units_in_display_tick (eq. to the POC in H264), compute delta between frames, set it as dts_inc in gf_import_aom_av1()\n\t}\n}\n\nstatic void decoder_model_info(AV1State *state, GF_BitStream *bs) {\n\tstate-&gt;buffer_delay_length = 1 + gf_bs_read_int_log(bs, 5, &quot;buffer_delay_length_minus1&quot;);\n\tgf_bs_read_int_log(bs, 32, &quot;num_units_in_decoding_tick&quot;);\n\tstate-&gt;buffer_removal_time_length = gf_bs_read_int_log(bs, 5, &quot;buffer_removal_time_length&quot;);\n\tstate-&gt;frame_presentation_time_length = 1 + gf_bs_read_int_log(bs, 5, &quot;frame_presentation_time_length_minus1&quot;);\n}\n\nstatic void operating_parameters_info(GF_BitStream *bs, const u8 idx, const u8 buffer_delay_length_minus_1) {\n\tconst u8 n = buffer_delay_length_minus_1 + 1;\n\tgf_bs_read_int_log(bs, n, &quot;decoder_buffer_delay&quot;);\n\tgf_bs_read_int_log(bs, n, &quot;encoder_buffer_delay&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;low_delay_mode_flag&quot;);\n}\n\nstatic void av1_parse_sequence_header_obu(GF_BitStream *bs, AV1State *state)\n{\n\tu8 buffer_delay_length_minus_1 = 0;\n\tstate-&gt;frame_state.seen_seq_header = GF_TRUE;\n\tstate-&gt;config-&gt;seq_profile = gf_bs_read_int_log(bs, 3, &quot;seq_profile&quot;);\n\tstate-&gt;still_picture = gf_bs_read_int_log(bs, 1, &quot;still_picture&quot;);\n\tstate-&gt;reduced_still_picture_header = gf_bs_read_int_log(bs, 1, &quot;reduced_still_picture_header&quot;);\n\tif (state-&gt;reduced_still_picture_header) {\n\t\t//timing_info_present_flag = GF_FALSE;\n\t\t//initial_display_delay_present_flag = GF_FALSE;\n\t\tstate-&gt;operating_points_count = 1;\n\t\tstate-&gt;config-&gt;seq_level_idx_0 = gf_bs_read_int_log(bs, 5, &quot;seq_level_idx_0&quot;);\n\t}\n\telse {\n\t\tu8 i = 0;\n\t\tBool initial_display_delay_present_flag;\n\t\tBool timing_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;timing_info_present_flag&quot;);\n\t\tif (timing_info_present_flag) {\n\t\t\ttiming_info(bs, state);\n\t\t\tstate-&gt;decoder_model_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;decoder_model_info_present_flag&quot;);\n\t\t\tif (state-&gt;decoder_model_info_present_flag) {\n\t\t\t\tdecoder_model_info(state, bs);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tstate-&gt;decoder_model_info_present_flag = GF_FALSE;\n\t\t}\n\t\tinitial_display_delay_present_flag = gf_bs_read_int_log(bs, 1, &quot;initial_display_delay_present_flag&quot;);\n\t\tstate-&gt;operating_points_count = 1 + gf_bs_read_int_log(bs, 5, &quot;operating_points_count_minus1&quot;);\n\t\tfor (i = 0; i &lt; state-&gt;operating_points_count; i++) {\n\t\t\tu8 seq_level_idx_i, seq_tier = 0;\n\n\t\t\tstate-&gt;operating_point_idc[i] = gf_bs_read_int_log_idx(bs, 12, &quot;operating_point_idc&quot;, i);\n\n\t\t\tseq_level_idx_i = gf_bs_read_int_log_idx(bs, 5, &quot;seq_level_idx&quot;, i);\n\t\t\tif (i == 0) state-&gt;config-&gt;seq_level_idx_0 = seq_level_idx_i;\n\n\t\t\tif (seq_level_idx_i &gt; 7) {\n\t\t\t\tseq_tier = gf_bs_read_int_log_idx(bs, 1, &quot;seq_tier&quot;, i);\n\t\t\t}\n\t\t\tif (i == 0) state-&gt;config-&gt;seq_tier_0 = seq_tier;\n\n\t\t\tif (state-&gt;decoder_model_info_present_flag) {\n\t\t\t\tstate-&gt;decoder_model_present_for_this_op[i] = gf_bs_read_int_log_idx(bs, 1, &quot;decoder_model_present_for_this_op&quot;, i);\n\t\t\t\tif (state-&gt;decoder_model_present_for_this_op[i]) {\n\t\t\t\t\toperating_parameters_info(bs, i, buffer_delay_length_minus_1);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstate-&gt;decoder_model_present_for_this_op[i] = 0;\n\t\t\t}\n\t\t\tif (initial_display_delay_present_flag) {\n\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;initial_display_delay_present_for_this_op&quot;, i) ) {\n\t\t\t\t\tgf_bs_read_int_log_idx(bs, 4, &quot;initial_display_delay_minus1&quot;, i);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t//operatingPoint = av1_choose_operating_point(bs);\n\tstate-&gt;OperatingPointIdc = 0;//TODO: operating_point_idc[operatingPoint];\n\n\tstate-&gt;frame_width_bits_minus_1 = gf_bs_read_int_log(bs, 4, &quot;frame_width_bits_minus1&quot;);\n\tstate-&gt;frame_height_bits_minus_1 = gf_bs_read_int_log(bs, 4, &quot;frame_height_bits_minus1&quot;);\n\tstate-&gt;width = gf_bs_read_int_log(bs, state-&gt;frame_width_bits_minus_1 + 1, &quot;width_minus1&quot;) + 1;\n\tstate-&gt;height = gf_bs_read_int_log(bs, state-&gt;frame_height_bits_minus_1 + 1, &quot;height_minus1&quot;) + 1;\n\tstate-&gt;sequence_width = state-&gt;width;\n\tstate-&gt;sequence_height = state-&gt;height;\n\tstate-&gt;frame_id_numbers_present_flag = GF_FALSE;\n\tif (!state-&gt;reduced_still_picture_header) {\n\t\tstate-&gt;frame_id_numbers_present_flag = gf_bs_read_int_log(bs, 1, &quot;frame_id_numbers_present_flag&quot;);\n\t}\n\tif (state-&gt;frame_id_numbers_present_flag) {\n\t\tstate-&gt;delta_frame_id_length_minus_2 = gf_bs_read_int_log(bs, 4, &quot;delta_frame_id_length_minus2&quot;);\n\t\tstate-&gt;additional_frame_id_length_minus_1 = gf_bs_read_int_log(bs, 3, &quot;additional_frame_id_length_minus1&quot;);\n\t}\n\tstate-&gt;use_128x128_superblock = gf_bs_read_int_log(bs, 1, &quot;use_128x128_superblock&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;enable_filter_intra&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;enable_intra_edge_filter&quot;);\n\tif (state-&gt;reduced_still_picture_header) {\n\t\t/*enable_interintra_compound = 0;\n\t\tenable_masked_compound = 0;\n\t\tenable_dual_filter = 0;\n\t\tenable_jnt_comp = 0;\n\t\tenable_ref_frame_mvs = 0;*/\n\t\tstate-&gt;enable_warped_motion = 0;\n\t\tstate-&gt;enable_order_hint = GF_FALSE;\n\t\tstate-&gt;OrderHintBits = 0;\n\t\tstate-&gt;seq_force_integer_mv = 2/*SELECT_INTEGER_MV*/;\n\t\tstate-&gt;seq_force_screen_content_tools = 2/*SELECT_SCREEN_CONTENT_TOOLS*/;\n\t}\n\telse {\n\t\tBool seq_choose_screen_content_tools;\n\t\tgf_bs_read_int_log(bs, 1, &quot;enable_interintra_compound&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;enable_masked_compound&quot;);\n\t\tstate-&gt;enable_warped_motion = gf_bs_read_int_log(bs, 1, &quot;enable_warped_motion&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;enable_dual_filter&quot;);\n\t\tstate-&gt;enable_order_hint = gf_bs_read_int_log(bs, 1, &quot;enable_order_hint&quot;);\n\t\tif (state-&gt;enable_order_hint) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;enable_jnt_comp&quot;);\n\t\t\tstate-&gt;enable_ref_frame_mvs = gf_bs_read_int_log(bs, 1, &quot;enable_ref_frame_mvs&quot;);\n\t\t}\n\t\telse {\n\t\t\t/*enable_jnt_comp =  0*/;\n\t\t\t/*enable_ref_frame_mvs = 0*/;\n\t\t}\n\t\tseq_choose_screen_content_tools = gf_bs_read_int_log(bs, 1, &quot;seq_choose_screen_content_tools&quot;);\n\t\tstate-&gt;seq_force_screen_content_tools = 0;\n\t\tif (seq_choose_screen_content_tools) {\n\t\t\tstate-&gt;seq_force_screen_content_tools = 2/*SELECT_SCREEN_CONTENT_TOOLS*/;\n\t\t}\n\t\telse {\n\t\t\tstate-&gt;seq_force_screen_content_tools = gf_bs_read_int_log(bs, 1, &quot;seq_force_screen_content_tools&quot;);\n\t\t}\n\n\t\tstate-&gt;seq_force_integer_mv = 0;\n\t\tif (state-&gt;seq_force_screen_content_tools &gt; 0) {\n\t\t\tconst Bool seq_choose_integer_mv = gf_bs_read_int_log(bs, 1, &quot;seq_choose_integer_mv&quot;);\n\t\t\tif (seq_choose_integer_mv) {\n\t\t\t\tstate-&gt;seq_force_integer_mv = 2/*SELECT_INTEGER_MV*/;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstate-&gt;seq_force_integer_mv = gf_bs_read_int_log(bs, 1, &quot;seq_force_integer_mv&quot;);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tstate-&gt;seq_force_integer_mv = 2/*SELECT_INTEGER_MV*/;\n\t\t}\n\t\tif (state-&gt;enable_order_hint) {\n\t\t\tu8 order_hint_bits_minus_1 = gf_bs_read_int_log(bs, 3, &quot;order_hint_bits_minus1&quot;);\n\t\t\tstate-&gt;OrderHintBits = order_hint_bits_minus_1 + 1;\n\t\t}\n\t\telse {\n\t\t\tstate-&gt;OrderHintBits = 0;\n\t\t}\n\t}\n\n\tstate-&gt;enable_superres = gf_bs_read_int_log(bs, 1, &quot;enable_superres&quot;);\n\tstate-&gt;enable_cdef = gf_bs_read_int_log(bs, 1, &quot;enable_cdef&quot;);\n\tstate-&gt;enable_restoration = gf_bs_read_int_log(bs, 1, &quot;enable_restoration&quot;);\n\tav1_color_config(bs, state);\n\tstate-&gt;film_grain_params_present = gf_bs_read_int_log(bs, 1, &quot;film_grain_params_present&quot;);\n}\n\n\n\n#define IVF_FILE_HEADER_SIZE 32\n\nBool gf_media_probe_ivf(GF_BitStream *bs)\n{\n\tu32 dw = 0;\n\tif (gf_bs_available(bs) &lt; IVF_FILE_HEADER_SIZE) return GF_FALSE;\n\n\tdw = gf_bs_peek_bits(bs, 32, 0);\n\tif (dw != GF_4CC(&#x27;D&#x27;, &#x27;K&#x27;, &#x27;I&#x27;, &#x27;F&#x27;)) {\n\t\treturn GF_FALSE;\n\t}\n\treturn GF_TRUE;\n}\n\nGF_Err gf_media_parse_ivf_file_header(GF_BitStream *bs, u32 *width, u32 *height, u32 *codec_fourcc, u32 *timebase_num, u32 *timebase_den, u32 *num_frames)\n{\n\tu32 dw = 0;\n\n\tif (!width || !height || !codec_fourcc || !timebase_den || !timebase_num || !num_frames) {\n\t\tassert(0);\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (gf_bs_available(bs) &lt; IVF_FILE_HEADER_SIZE) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[IVF] Not enough bytes available (&quot;LLU&quot;).\\n&quot;, gf_bs_available(bs)));\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\tdw = gf_bs_read_u32(bs);\n\tif (dw != GF_4CC(&#x27;D&#x27;, &#x27;K&#x27;, &#x27;I&#x27;, &#x27;F&#x27;)) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CODING, (&quot;[IVF] Invalid signature\\n&quot;));\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\tdw = gf_bs_read_u16_le(bs);\n\tif (dw != 0) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[IVF] Wrong IVF version. 0 expected, got %u\\n&quot;, dw));\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\tdw = gf_bs_read_u16_le(bs); //length of header in bytes\n\tif (dw != IVF_FILE_HEADER_SIZE) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[IVF] Wrong IVF header length. Expected 32 bytes, got %u\\n&quot;, dw));\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\t*codec_fourcc = gf_bs_read_u32(bs);\n\n\t*width = gf_bs_read_u16_le(bs);\n\t*height = gf_bs_read_u16_le(bs);\n\n\t*timebase_num = gf_bs_read_u32_le(bs);\n\t*timebase_den = gf_bs_read_u32_le(bs);\n\n\t*num_frames = gf_bs_read_u32_le(bs);\n\tgf_bs_read_u32_le(bs); //skip unused\n\n\treturn GF_OK;\n}\n\nGF_Err gf_media_parse_ivf_frame_header(GF_BitStream *bs, u64 *frame_size, u64 *pts)\n{\n\tif (!frame_size) return GF_BAD_PARAM;\n\tif (gf_bs_available(bs) &lt; 12)\n\t\treturn GF_BUFFER_TOO_SMALL;\n\n\t*frame_size = gf_bs_read_u32_le(bs);\n\tif (*frame_size &gt; 256 * 1024 * 1024) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[IVF] Wrong frame size %u\\n&quot;, *frame_size));\n\t\t*frame_size = 0;\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\t*pts = gf_bs_read_u64_le(bs);\n\n\treturn GF_OK;\n}\n\nGF_Err gf_vp9_parse_superframe(GF_BitStream *bs, u64 ivf_frame_size, u32 *num_frames_in_superframe, u32 frame_sizes[VP9_MAX_FRAMES_IN_SUPERFRAME], u32 *superframe_index_size)\n{\n\tu32 byte, bytes_per_framesize;\n\tu64 pos = gf_bs_get_position(bs), i = 0;\n\tGF_Err e;\n\n\tassert(bs &amp;&amp; num_frames_in_superframe);\n\n\t/*initialize like there is no superframe*/\n\tmemset(frame_sizes, 0, VP9_MAX_FRAMES_IN_SUPERFRAME * sizeof(frame_sizes[0]));\n\t*num_frames_in_superframe = 1;\n\tframe_sizes[0] = (u32)ivf_frame_size;\n\t*superframe_index_size = 0;\n\n\te = gf_bs_seek(bs, pos + ivf_frame_size - 1);\n\tif (e) return e;\n\n\tgf_bs_mark_overflow(bs, GF_TRUE);\n\n\tbyte = gf_bs_read_u8(bs);\n\tif ((byte &amp; 0xe0) != 0xc0)\n\t\tgoto exit; /*no superframe*/\n\n\tbytes_per_framesize = 1 + ((byte &amp; 0x18) &gt;&gt; 3);\n\t*num_frames_in_superframe = (u32)(1 + (byte &amp; 0x7));\n\n\t/*superframe_index()*/\n\t*superframe_index_size = 2 + bytes_per_framesize * *num_frames_in_superframe;\n\tgf_bs_seek(bs, pos + ivf_frame_size - *superframe_index_size);\n\tbyte = gf_bs_read_u8(bs);\n\tif ((byte &amp; 0xe0) != 0xc0) {\n\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\tgoto exit; /*no superframe*/\n\t}\n\tframe_sizes[0] = 0;\n\tfor (i = 0; i &lt; *num_frames_in_superframe; ++i) {\n\t\tgf_bs_read_data(bs, (char*)(frame_sizes + i), bytes_per_framesize);\n\t}\n\nexit:\n\tgf_bs_seek(bs, pos);\n\n\tif (gf_bs_is_overflow(bs)) e = GF_NON_COMPLIANT_BITSTREAM;\n\n\treturn e;\n}\n\n\nstatic Bool vp9_frame_sync_code(GF_BitStream *bs)\n{\n\tu8 val = gf_bs_read_int_log(bs, 8, &quot;syncbyte1&quot;);\n\tif (val != 0x49)\n\t\treturn GF_FALSE;\n\n\tval = gf_bs_read_int_log(bs, 8, &quot;syncbyte2&quot;);\n\tif (val != 0x83)\n\t\treturn GF_FALSE;\n\n\tval = gf_bs_read_int_log(bs, 8, &quot;syncbyte3&quot;);\n\tif (val != 0x42)\n\t\treturn GF_FALSE;\n\n\treturn GF_TRUE;\n}\n\ntypedef enum {\n\tCS_UNKNOWN = 0,\n\tCS_BT_601 = 1,\n\tCS_BT_709 = 2,\n\tCS_SMPTE_170 = 3,\n\tCS_SMPTE_240 = 4,\n\tCS_BT_2020 = 5,\n\tCS_RESERVED = 6,\n\tCS_RGB = 7,\n} VP9_color_space;\n\nstatic const int VP9_CS_to_23001_8_colour_primaries[] = { 2/*unspecified*/, 5, 1, 6, 7, 9, -1/*reserved*/, 1 };\nstatic const int VP9_CS_to_23001_8_transfer_characteristics[] = { 2/*unspecified*/, 5, 1, 6, 7, 9, -1/*reserved*/, 13 };\nstatic const int VP9_CS_to_23001_8_matrix_coefficients[] = { 2/*unspecified*/, 6, 1, -1, -1, 9, -1/*reserved*/, 0 };\n\nstatic GF_Err vp9_color_config(GF_BitStream *bs, GF_VPConfig *vp9_cfg)\n{\n\tVP9_color_space color_space;\n\n\tif (vp9_cfg-&gt;profile &gt;= 2) {\n\t\tBool ten_or_twelve_bit = gf_bs_read_int_log(bs, 1, &quot;ten_or_twelve_bit&quot;);\n\t\tvp9_cfg-&gt;bit_depth = ten_or_twelve_bit ? 12 : 10;\n\t}\n\telse {\n\t\tvp9_cfg-&gt;bit_depth = 8;\n\t}\n\n\tcolor_space = gf_bs_read_int_log(bs, 3, &quot;color_space&quot;);\n\tvp9_cfg-&gt;colour_primaries = VP9_CS_to_23001_8_colour_primaries[color_space];\n\tvp9_cfg-&gt;transfer_characteristics = VP9_CS_to_23001_8_transfer_characteristics[color_space];\n\tvp9_cfg-&gt;matrix_coefficients = VP9_CS_to_23001_8_matrix_coefficients[color_space];\n\tif (color_space != CS_RGB) {\n\t\tvp9_cfg-&gt;video_fullRange_flag = gf_bs_read_int_log(bs, 1, &quot;video_fullRange_flag&quot;);\n\t\tif (vp9_cfg-&gt;profile == 1 || vp9_cfg-&gt;profile == 3) {\n\t\t\tu8 subsampling_x, subsampling_y, subsampling_xy_to_chroma_subsampling[2][2] = { {3, 0}, {2, 0} };\n\t\t\tsubsampling_x = gf_bs_read_int_log(bs, 1, &quot;subsampling_x&quot;);\n\t\t\tsubsampling_y = gf_bs_read_int_log(bs, 1, &quot;subsampling_x&quot;);\n\t\t\tvp9_cfg-&gt;chroma_subsampling = subsampling_xy_to_chroma_subsampling[subsampling_x][subsampling_y];\n\t\t\tBool reserved_zero = gf_bs_read_int_log(bs, 1, &quot;reserved_zero&quot;);\n\t\t\tif (reserved_zero) {\n\t\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VP9] color config reserved zero (1) is not zero.\\n&quot;));\n\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tvp9_cfg-&gt;chroma_subsampling = 0;\n\t\t}\n\t}\n\telse {\n\t\tvp9_cfg-&gt;video_fullRange_flag = GF_TRUE;\n\t\tif (vp9_cfg-&gt;profile == 1 || vp9_cfg-&gt;profile == 3) {\n\t\t\tvp9_cfg-&gt;chroma_subsampling = 3;\n\t\t\tBool reserved_zero = gf_bs_read_int_log(bs, 1, &quot;reserved_zero&quot;);\n\t\t\tif (reserved_zero) {\n\t\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VP9] color config reserved zero (2) is not zero.\\n&quot;));\n\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn GF_OK;\n}\n\nstatic void vp9_compute_image_size(int FrameWidth, int FrameHeight, int *Sb64Cols, int *Sb64Rows)\n{\n\tint MiCols = (FrameWidth + 7) &gt;&gt; 3;\n\tint MiRows = (FrameHeight + 7) &gt;&gt; 3;\n\t*Sb64Cols = (MiCols + 7) &gt;&gt; 3;\n\t*Sb64Rows = (MiRows + 7) &gt;&gt; 3;\n}\n\nstatic void vp9_frame_size(GF_BitStream *bs, int *FrameWidth, int *FrameHeight, int *Sb64Cols, int *Sb64Rows)\n{\n\tint frame_width_minus_1 = gf_bs_read_int_log(bs, 16, &quot;frame_width_minus_1&quot;);\n\tint frame_height_minus_1 = gf_bs_read_int_log(bs, 16, &quot;frame_height_minus_1&quot;);\n\tif (frame_width_minus_1 + 1 != *FrameWidth || frame_height_minus_1 + 1 != *FrameHeight) {\n\t\tif (*FrameWidth || *FrameHeight)\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[VP9] inconsistent frame dimensions: previous was %dx%d, new one is %dx%d.\\n&quot;, *FrameWidth, *FrameHeight, frame_width_minus_1 + 1, frame_height_minus_1 + 1));\n\t}\n\t*FrameWidth = frame_width_minus_1 + 1;\n\t*FrameHeight = frame_height_minus_1 + 1;\n\tvp9_compute_image_size(*FrameWidth, *FrameHeight, Sb64Cols, Sb64Rows);\n}\n\nstatic void vp9_render_size(GF_BitStream *bs, int FrameWidth, int FrameHeight, int *renderWidth, int *renderHeight)\n{\n\tBool render_and_frame_size_different = gf_bs_read_int_log(bs, 1, &quot;render_and_frame_size_different&quot;);\n\tif (render_and_frame_size_different == 1) {\n\t\tint render_width_minus_1 = gf_bs_read_int_log(bs, 16, &quot;render_width_minus_1&quot;);\n\t\tint render_height_minus_1 = gf_bs_read_int_log(bs, 16, &quot;render_height_minus_1&quot;);\n\t\t*renderWidth = render_width_minus_1 + 1;\n\t\t*renderHeight = render_height_minus_1 + 1;\n\t}\n\telse {\n\t\t*renderWidth = FrameWidth;\n\t\t*renderHeight = FrameHeight;\n\t}\n}\n\nstatic s64 vp9_s(GF_BitStream *bs, int n, const char *fname, u32 idx) {\n\ts64 value = gf_bs_read_int(bs, n);\n\tBool sign = gf_bs_read_int(bs, 1);\n\tif (sign) value = -value;\n\tgf_bs_log_idx(bs, n+1, fname, value, idx, -1, -1);\n\treturn value;\n}\n\nstatic void vp9_loop_filter_params(GF_BitStream *bs)\n{\n\t/*loop_filter_level = */gf_bs_read_int_log(bs, 6, &quot;loop_filter_level&quot;);\n\t/*loop_filter_sharpness = */gf_bs_read_int_log(bs, 3, &quot;loop_filter_sharpness&quot;);\n\tBool loop_filter_delta_enabled = gf_bs_read_int_log(bs, 1, &quot;loop_filter_delta_enabled&quot;);\n\tif (loop_filter_delta_enabled == 1) {\n\t\tBool loop_filter_delta_update = gf_bs_read_int_log(bs, 1, &quot;loop_filter_delta_update&quot;);\n\t\tif (loop_filter_delta_update == GF_TRUE) {\n\t\t\tint i;\n\t\t\tfor (i = 0; i &lt; 4; i++) {\n\t\t\t\tBool update_ref_delta = gf_bs_read_int_log_idx(bs, 1, &quot;update_ref_delta&quot;, i);\n\t\t\t\tif (update_ref_delta == GF_TRUE)\n\t\t\t\t\tvp9_s(bs, 6, &quot;loop_filter_ref_deltas&quot;, i);\n\t\t\t}\n\t\t\tfor (i = 0; i &lt; 2; i++) {\n\t\t\t\tBool update_mode_delta = gf_bs_read_int_log_idx(bs, 1, &quot;update_mode_delta&quot;, i);\n\t\t\t\tif (update_mode_delta == GF_TRUE)\n\t\t\t\t\tvp9_s(bs, 6, &quot;loop_filter_mode_deltas&quot;, i);\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void vp9_delta_q(GF_BitStream *bs) {\n\tBool delta_coded = gf_bs_read_int_log(bs, 1, &quot;delta_coded&quot;);\n\tif (delta_coded) {\n\t\tgf_bs_read_int_log(bs, 4, &quot;delta_q&quot;);\n\t}\n}\n\nstatic void vp9_quantization_params(GF_BitStream *bs)\n{\n\t/*base_q_idx = */gf_bs_read_int_log(bs, 8, &quot;base_q_idx&quot;);\n\tvp9_delta_q(bs); // delta_q_y_dc\n\tvp9_delta_q(bs); // delta_q_uv_dc\n\tvp9_delta_q(bs); // delta_q_uv_ac\n}\n\n#define VP9_MAX_SEGMENTS 8\n#define VP9_SEG_LVL_MAX 4\nstatic const int segmentation_feature_bits[VP9_SEG_LVL_MAX] = { 8, 6, 2, 0 };\nstatic const int segmentation_feature_signed[VP9_SEG_LVL_MAX] = { 1, 1, 0, 0 };\n\n#define VP9_MIN_TILE_WIDTH_B64 4\n#define VP9_MAX_TILE_WIDTH_B64 64\n\nstatic void vp9_read_prob(GF_BitStream *bs)\n{\n\tBool prob_coded = gf_bs_read_int_log(bs, 1, &quot;prob_coded&quot;);\n\tif (prob_coded) {\n\t\tgf_bs_read_int_log(bs, 8, &quot;prob&quot;);\n\t}\n}\n\nstatic void vp9_segmentation_params(GF_BitStream *bs)\n{\n\tBool segmentation_enabled = gf_bs_read_int_log(bs, 1, &quot;segmentation_enabled&quot;);\n\tif (segmentation_enabled == 1) {\n\t\tint i;\n\t\tBool segmentation_update_map = gf_bs_read_int_log(bs, 1, &quot;segmentation_update_map&quot;);\n\t\tif (segmentation_update_map) {\n\t\t\tfor (i = 0; i &lt; 7; i++) {\n\t\t\t\tvp9_read_prob(bs);\n\t\t\t}\n\t\t\tBool segmentation_temporal_update = gf_bs_read_int_log(bs, 1, &quot;segmentation_temporal_update&quot;);\n\t\t\tfor (i = 0; i &lt; 3; i++) {\n\t\t\t\tif (segmentation_temporal_update) {\n\t\t\t\t\tvp9_read_prob(bs);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tBool segmentation_update_data = gf_bs_read_int_log(bs, 1, &quot;segmentation_update_data&quot;);\n\t\tif (segmentation_update_data == 1) {\n\t\t\t/*segmentation_abs_or_delta_update =*/ gf_bs_read_int_log(bs, 1, &quot;segmentation_abs_or_delta_update&quot;);\n\t\t\tfor (i = 0; i &lt; VP9_MAX_SEGMENTS; i++) {\n\t\t\t\tint j;\n\t\t\t\tfor (j = 0; j &lt; VP9_SEG_LVL_MAX; j++) {\n\t\t\t\t\t/*feature_value = 0*/\n\t\t\t\t\tBool feature_enabled = gf_bs_read_int_log(bs, 1, &quot;feature_enabled&quot;);\n\t\t\t\t\t/*FeatureEnabled[i][j] = feature_enabled*/\n\t\t\t\t\tif (feature_enabled) {\n\t\t\t\t\t\tint bits_to_read = segmentation_feature_bits[j];\n\t\t\t\t\t\t/*feature_value =*/ gf_bs_read_int_log(bs, bits_to_read, &quot;feature_value&quot;);\n\t\t\t\t\t\tif (segmentation_feature_signed[j] == 1) {\n\t\t\t\t\t\t\t/*Bool feature_sign = */gf_bs_read_int_log(bs, 1, &quot;feature_sign&quot;);\n\t\t\t\t\t\t\t/*if (feature_sign == 1)\n\t\t\t\t\t\t\t\tfeature_value *= -1*/\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t/*FeatureData[i][j] = feature_value*/\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic int calc_min_log2_tile_cols(int Sb64Cols) {\n\tint minLog2 = 0;\n\twhile ((VP9_MAX_TILE_WIDTH_B64 &lt;&lt; minLog2) &lt; Sb64Cols)\n\t\tminLog2++;\n\n\treturn minLog2;\n}\n\nstatic int calc_max_log2_tile_cols(int Sb64Cols) {\n\tint maxLog2 = 1;\n\twhile ((Sb64Cols &gt;&gt; maxLog2) &gt;= VP9_MIN_TILE_WIDTH_B64)\n\t\tmaxLog2++;\n\n\treturn maxLog2 - 1;\n}\n\nstatic void vp9_tile_info(GF_BitStream *bs, int Sb64Cols)\n{\n\tBool tile_rows_log2;\n\tint minLog2TileCols = calc_min_log2_tile_cols(Sb64Cols);\n\tint maxLog2TileCols = calc_max_log2_tile_cols(Sb64Cols);\n\tint tile_cols_log2 = minLog2TileCols;\n\twhile (tile_cols_log2 &lt; maxLog2TileCols) {\n\t\tBool increment_tile_cols_log2 = gf_bs_read_int_log(bs, 1, &quot;increment_tile_cols_log2&quot;);\n\t\tif (increment_tile_cols_log2)\n\t\t\ttile_cols_log2++;\n\t\telse\n\t\t\tbreak;\n\t}\n\ttile_rows_log2 = gf_bs_read_int_log(bs, 1, &quot;tile_rows_log2&quot;);\n\tif (tile_rows_log2) {\n\t\t/*Bool increment_tile_rows_log2 = */gf_bs_read_int_log(bs, 1, &quot;increment_tile_rows_log2&quot;);\n\t\t//tile_rows_log2 += increment_tile_rows_log2;\n\t}\n}\n\nstatic void vp9_frame_size_with_refs(GF_BitStream *bs, u8 refresh_frame_flags, u8 * ref_frame_idx, int * RefFrameWidth, int *RefFrameHeight,\n\tint *FrameWidth, int *FrameHeight, int *RenderWidth, int *RenderHeight, int *Sb64Cols, int *Sb64Rows)\n{\n\tBool found_ref;\n\tint i;\n\tfor (i = 0; i &lt; 3; i++) {\n\t\tfound_ref = gf_bs_read_int_log(bs, 1, &quot;found_ref&quot;);\n\t\tif (found_ref) {\n\t\t\t*FrameWidth  = RefFrameWidth [ref_frame_idx[i]];\n\t\t\t*FrameHeight = RefFrameHeight[ref_frame_idx[i]];\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (found_ref == 0) {\n\t\tvp9_frame_size(bs, FrameWidth, FrameHeight, Sb64Cols, Sb64Rows);\n\t}\n\telse {\n\t\tvp9_compute_image_size(*FrameWidth, *FrameHeight, Sb64Cols, Sb64Rows);\n\t}\n\n\tvp9_render_size(bs, *FrameWidth, *FrameHeight, RenderWidth, RenderHeight);\n}\n\nstatic void vp9_read_interpolation_filter(GF_BitStream *bs)\n{\n\tBool is_filter_switchable = gf_bs_read_int_log(bs, 1, &quot;is_filter_switchable&quot;);\n\tif (!is_filter_switchable) {\n\t\t/*raw_interpolation_filter = */gf_bs_read_int_log(bs, 2, &quot;raw_interpolation_filter&quot;);\n\t}\n}\n\n\n#define VP9_KEY_FRAME 0\n\nGF_Err gf_vp9_parse_sample(GF_BitStream *bs, GF_VPConfig *vp9_cfg, Bool *key_frame, u32 *FrameWidth, u32 *FrameHeight, u32 *renderWidth, u32 *renderHeight)\n{\n\tBool FrameIsIntra = GF_FALSE, profile_low_bit, profile_high_bit, show_existing_frame = GF_FALSE, frame_type = GF_FALSE, show_frame = GF_FALSE, error_resilient_mode = GF_FALSE;\n\t/*u8 frame_context_idx = 0, reset_frame_context = 0, frame_marker = 0*/;\n\tint Sb64Cols = 0, Sb64Rows = 0, i;\n\tu8 refresh_frame_flags = 0;\n\n\tassert(bs &amp;&amp; key_frame);\n\n\t/*uncompressed header*/\n\t/*frame_marker = */gf_bs_read_int_log(bs, 2, &quot;frame_marker&quot;);\n\tprofile_low_bit = gf_bs_read_int_log(bs, 1, &quot;profile_low_bit&quot;);\n\tprofile_high_bit = gf_bs_read_int_log(bs, 1, &quot;profile_high_bit&quot;);\n\tvp9_cfg-&gt;profile = (profile_high_bit &lt;&lt; 1) + profile_low_bit;\n\tif (vp9_cfg-&gt;profile == 3) {\n\t\tBool reserved_zero = gf_bs_read_int_log(bs, 1, &quot;reserved_zero&quot;);\n\t\tif (reserved_zero) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VP9] uncompressed header reserved zero is not zero.\\n&quot;));\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\t}\n\n\tshow_existing_frame = gf_bs_read_int_log(bs, 1, &quot;show_existing_frame&quot;);\n\tif (show_existing_frame == GF_TRUE) {\n\t\t/*frame_to_show_map_idx = */gf_bs_read_int_log(bs, 3, &quot;frame_to_show_map_idx&quot;);\n\t\treturn GF_OK;\n\t}\n\n\tframe_type = gf_bs_read_int_log(bs, 1, &quot;frame_type&quot;);\n\tshow_frame = gf_bs_read_int_log(bs, 1, &quot;show_frame&quot;);\n\terror_resilient_mode = gf_bs_read_int_log(bs, 1, &quot;error_resilient_mode&quot;);\n\tif (frame_type == VP9_KEY_FRAME) {\n\t\tif (!vp9_frame_sync_code(bs))\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\tif (vp9_color_config(bs, vp9_cfg) != GF_OK)\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\tvp9_frame_size(bs, FrameWidth, FrameHeight, &amp;Sb64Cols, &amp;Sb64Rows);\n\t\tvp9_render_size(bs, *FrameWidth, *FrameHeight, renderWidth, renderHeight);\n\t\trefresh_frame_flags = 0xFF;\n\t\t*key_frame = GF_TRUE;\n\t\tFrameIsIntra = GF_TRUE;\n\t}\n\telse {\n\t\tBool intra_only = GF_FALSE;\n\t\t*key_frame = GF_FALSE;\n\n\t\tif (show_frame == GF_FALSE) {\n\t\t\tintra_only = gf_bs_read_int_log(bs, 1, &quot;intra_only&quot;);\n\t\t}\n\t\tFrameIsIntra = intra_only;\n\n\t\tif (error_resilient_mode == GF_FALSE) {\n\t\t\t/*reset_frame_context = */gf_bs_read_int_log(bs, 2, &quot;reset_frame_context&quot;);\n\t\t}\n\n\t\tif (intra_only == GF_TRUE) {\n\t\t\tif (!vp9_frame_sync_code(bs))\n\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\n\t\t\tif (vp9_cfg-&gt;profile &gt; 0) {\n\t\t\t\tif (vp9_color_config(bs, vp9_cfg) != GF_OK)\n\t\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tu8 color_space = CS_BT_601;\n\t\t\t\tvp9_cfg-&gt;colour_primaries = VP9_CS_to_23001_8_colour_primaries[color_space];\n\t\t\t\tvp9_cfg-&gt;transfer_characteristics = VP9_CS_to_23001_8_transfer_characteristics[color_space];\n\t\t\t\tvp9_cfg-&gt;matrix_coefficients = VP9_CS_to_23001_8_matrix_coefficients[color_space];\n\t\t\t\tvp9_cfg-&gt;chroma_subsampling = 0;\n\t\t\t\tvp9_cfg-&gt;bit_depth = 8;\n\t\t\t}\n\t\t\trefresh_frame_flags = gf_bs_read_int_log(bs, 8, &quot;refresh_frame_flags&quot;);\n\t\t\tvp9_frame_size(bs, FrameWidth, FrameHeight, &amp;Sb64Cols, &amp;Sb64Rows);\n\t\t\tvp9_render_size(bs, *FrameWidth, *FrameHeight, renderWidth, renderHeight);\n\t\t}\n\t\telse {\n\t\t\trefresh_frame_flags = gf_bs_read_int_log(bs, 8, &quot;refresh_frame_flags&quot;);\n\t\t\tu8 ref_frame_idx[3];\n\t\t\tfor (i = 0; i &lt; 3; i++) {\n\t\t\t\tref_frame_idx[i] = gf_bs_read_int_log_idx(bs, 3, &quot;ref_frame_idx&quot;, i);\n\t\t\t\t/*ref_frame_sign_bias[LAST_FRAME + i] = */gf_bs_read_int_log_idx(bs, 1, &quot;ref_frame_sign_bias&quot;, i);\n\t\t\t}\n\t\t\tvp9_frame_size_with_refs(bs, refresh_frame_flags, ref_frame_idx, vp9_cfg-&gt;RefFrameWidth, vp9_cfg-&gt;RefFrameHeight, FrameWidth, FrameHeight, renderWidth, renderHeight, &amp;Sb64Cols, &amp;Sb64Rows);\n\t\t\t/*allow_high_precision_mv = */gf_bs_read_int_log(bs, 1, &quot;allow_high_precision_mv&quot;);\n\t\t\tvp9_read_interpolation_filter(bs);\n\t\t}\n\t}\n\n\tif (error_resilient_mode == 0) {\n\t\t/*refresh_frame_context = */gf_bs_read_int_log(bs, 1, &quot;refresh_frame_context&quot;);\n\t\t/*frame_parallel_decoding_mode = */gf_bs_read_int_log(bs, 1, &quot;frame_parallel_decoding_mode&quot;);\n\t}\n\n\t/*frame_context_idx = */gf_bs_read_int_log(bs, 2, &quot;frame_context_idx&quot;);\n\tif (FrameIsIntra || error_resilient_mode) {\n\t\t/*setup_past_independence + save_probs ...*/\n\t\t//frame_context_idx = 0;\n\t}\n\n\tvp9_loop_filter_params(bs);\n\tvp9_quantization_params(bs);\n\tvp9_segmentation_params(bs);\n\tvp9_tile_info(bs, Sb64Cols);\n\n\t/*header_size_in_bytes = */gf_bs_read_int_log(bs, 16, &quot;header_size_in_bytes&quot;);\n\n\t/*Reference frame update process (8.10 - partial)*/\n\tfor (i = 0; i &lt; VP9_NUM_REF_FRAMES; i++) {\n\t\tif ((refresh_frame_flags &gt;&gt; i) &amp; 1) {\n\t\t\tvp9_cfg-&gt;RefFrameWidth[i] = *FrameWidth;\n\t\t\tvp9_cfg-&gt;RefFrameHeight[i] = *FrameHeight;\n\t\t}\n\t}\n\n\treturn GF_OK;\n}\n\nGF_Err gf_av1_parse_obu_header(GF_BitStream *bs, ObuType *obu_type, Bool *obu_extension_flag, Bool *obu_has_size_field, u8 *temporal_id, u8 *spatial_id)\n{\n\tBool forbidden = gf_bs_read_int(bs, 1);\n\tif (forbidden) {\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\t*obu_type = gf_bs_read_int(bs, 4);\n\t*obu_extension_flag = gf_bs_read_int(bs, 1);\n\t*obu_has_size_field = gf_bs_read_int(bs, 1);\n\tif (gf_bs_read_int(bs, 1) /*obu_reserved_1bit*/) {\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\tif (*obu_extension_flag) {\n\t\t*temporal_id = gf_bs_read_int(bs, 3);\n\t\t*spatial_id = gf_bs_read_int(bs, 2);\n\t\t/*extension_header_reserved_3bits = */gf_bs_read_int(bs, 3);\n\t}\n\n\treturn GF_OK;\n}\n\n#endif // GPAC_DISABLE_AV_PARSERS\n\nGF_EXPORT\nconst char *gf_av1_get_obu_name(ObuType obu_type)\n{\n\tswitch (obu_type) {\n\tcase OBU_SEQUENCE_HEADER: return &quot;seq_header&quot;;\n\tcase OBU_TEMPORAL_DELIMITER: return &quot;delimiter&quot;;\n\tcase OBU_FRAME_HEADER: return &quot;frame_header&quot;;\n\tcase OBU_TILE_GROUP: return &quot;tile_group&quot;;\n\tcase OBU_METADATA: return &quot;metadata&quot;;\n\tcase OBU_FRAME: return &quot;frame&quot;;\n\tcase OBU_REDUNDANT_FRAME_HEADER: return &quot;redundant_frame_header&quot;;\n\tcase OBU_TILE_LIST: return &quot;tile_list&quot;;\n\tcase OBU_PADDING: return &quot;padding&quot;;\n\tcase OBU_RESERVED_0:\n\tcase OBU_RESERVED_9:\n\tcase OBU_RESERVED_10:\n\tcase OBU_RESERVED_11:\n\tcase OBU_RESERVED_12:\n\tcase OBU_RESERVED_13:\n\tcase OBU_RESERVED_14:\n\t\treturn &quot;reserved&quot;;\n\tdefault: return &quot;unknown&quot;;\n\t}\n}\n\nBool av1_is_obu_header(ObuType obu_type) {\n\tswitch (obu_type) {\n\tcase OBU_SEQUENCE_HEADER:\n\tcase OBU_METADATA:\n\t\t// TODO add check based on the metadata type\n\t\treturn GF_TRUE;\n\tdefault:\n\t\treturn GF_FALSE;\n\t}\n}\n\n#ifndef GPAC_DISABLE_AV_PARSERS\n\nstatic Bool av1_is_obu_frame(AV1State *state, ObuType obu_type)\n{\n\tswitch (obu_type) {\n\tcase OBU_PADDING:\n\tcase OBU_REDUNDANT_FRAME_HEADER:\n\t\treturn GF_FALSE;\n\tcase OBU_TEMPORAL_DELIMITER:\n\t\treturn state-&gt;keep_temporal_delim ? GF_TRUE : GF_FALSE;\n\tdefault:\n\t\treturn GF_TRUE;\n\t}\n}\n\nu64 gf_av1_leb128_read(GF_BitStream *bs, u8 *opt_Leb128Bytes) {\n\tu64 value = 0;\n\tu8 Leb128Bytes = 0, i = 0;\n\tfor (i = 0; i &lt; 8; i++) {\n\t\tu8 leb128_byte = gf_bs_read_u8(bs);\n\t\tvalue |= ( ((u64) (leb128_byte &amp; 0x7f)) &lt;&lt; (i * 7));\n\t\tLeb128Bytes += 1;\n\t\tif (!(leb128_byte &amp; 0x80)) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (opt_Leb128Bytes) {\n\t\t*opt_Leb128Bytes = Leb128Bytes;\n\t}\n\treturn value;\n}\n\nu32 gf_av1_leb128_size(u64 value)\n{\n\tu32 gf_av1_leb128_size = 0;\n\tdo {\n\t\t++gf_av1_leb128_size;\n\t} while ((value &gt;&gt;= 7) != 0);\n\n\treturn gf_av1_leb128_size;\n}\n\nu64 gf_av1_leb128_write(GF_BitStream *bs, u64 value)\n{\n\tu32 i, leb_size = gf_av1_leb128_size(value);\n\tfor (i = 0; i &lt; leb_size; ++i) {\n\t\tu8 byte = value &amp; 0x7f;\n\t\tvalue &gt;&gt;= 7;\n\t\tif (value != 0) byte |= 0x80; //more bytes follow\n\t\tgf_bs_write_u8(bs, byte);\n\t}\n\n\treturn leb_size;\n}\n\n#define OBU_BLOCK_SIZE 4096\nstatic void av1_add_obu_internal(GF_BitStream *bs, u64 pos, u64 obu_length, ObuType obu_type, GF_List **obu_list, AV1State *state)\n{\n\tchar block[OBU_BLOCK_SIZE];\n\tBool has_size_field = 0, obu_extension_flag = 0;\n\tu8 temporal_id, spatial_id;\n\tGF_AV1_OBUArrayEntry *a = NULL;\n\n\tif (state &amp;&amp; state-&gt;mem_mode) {\n\t\tif (!state-&gt;bs) state-&gt;bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\t\telse gf_bs_reassign_buffer(state-&gt;bs, state-&gt;frame_obus, state-&gt;frame_obus_alloc);\n\t}\n\telse {\n\t\tGF_SAFEALLOC(a, GF_AV1_OBUArrayEntry);\n\t\tif (!a) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] Failed to allocate OBU\\n&quot;));\n\t\t\treturn;\n\t\t}\n\t}\n\n\tgf_bs_seek(bs, pos);\n\tgf_av1_parse_obu_header(bs, &amp;obu_type, &amp;obu_extension_flag, &amp;has_size_field, &amp;temporal_id, &amp;spatial_id);\n\tgf_bs_seek(bs, pos);\n\n\tif (has_size_field) {\n\t\tif (a) {\n\t\t\ta-&gt;obu = gf_malloc((size_t)obu_length);\n\t\t\tgf_bs_read_data(bs, a-&gt;obu, (u32)obu_length);\n\t\t\ta-&gt;obu_length = obu_length;\n\t\t}\n\t\telse {\n\t\t\tu32 remain = (u32)obu_length;\n\t\t\twhile (remain) {\n\t\t\t\tu32 block_size = OBU_BLOCK_SIZE;\n\t\t\t\tif (block_size &gt; remain) block_size = remain;\n\t\t\t\tgf_bs_read_data(bs, block, block_size);\n\t\t\t\tgf_bs_write_data(state-&gt;bs, block, block_size);\n\t\t\t\tremain -= block_size;\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t}\n\telse {\n\t\tu8 i, hdr_size = obu_extension_flag ? 2 : 1;\n\t\tconst u32 leb_size = (u32)gf_av1_leb128_size(obu_length);\n\t\tconst u64 obu_size = obu_length - hdr_size;\n\n\t\tif (a) {\n\t\t\ta-&gt;obu = gf_malloc((size_t)obu_length + leb_size);\n\t\t\ta-&gt;obu_length = obu_length + leb_size;\n\t\t\tfor (i = 0; i &lt; hdr_size; ++i) {\n\t\t\t\ta-&gt;obu[i] = gf_bs_read_u8(bs);\n\t\t\t\t/*add size field flag*/\n\t\t\t\tif (i == 0) a-&gt;obu[0] |= 0x02;\n\t\t\t}\n\t\t\t{\n\t\t\t\tu32 out_size = 0;\n\t\t\t\tu8 *output = NULL;\n\t\t\t\tGF_BitStream *bsLeb128 = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\t\t\t\t/*write size field*/\n\t\t\t\tgf_av1_leb128_write(bsLeb128, obu_size);\n\t\t\t\tassert(gf_bs_get_position(bsLeb128) == leb_size);\n\t\t\t\tgf_bs_get_content(bsLeb128, &amp;output, &amp;out_size);\n\t\t\t\tgf_bs_del(bsLeb128);\n\t\t\t\tmemcpy(a-&gt;obu + hdr_size, output, out_size);\n\t\t\t\tgf_free(output);\n\t\t\t}\n\t\t\tgf_bs_read_data(bs, a-&gt;obu + hdr_size + leb_size, (u32)(obu_size));\n\t\t\tassert(gf_bs_get_position(bs) == pos + obu_length);\n\t\t}\n\t\telse {\n\t\t\tu32 remain;\n\t\t\tfor (i = 0; i &lt; hdr_size; ++i) {\n\t\t\t\tu8 hdr_b = gf_bs_read_u8(bs);\n\t\t\t\tif (i == 0) hdr_b |= 0x02; /*add size field flag*/\n\t\t\t\tgf_bs_write_u8(state-&gt;bs, hdr_b);\n\t\t\t}\n\t\t\t/*add size field */\n\t\t\tgf_av1_leb128_write(state-&gt;bs, obu_size);\n\t\t\tremain = (u32)obu_length - hdr_size;\n\t\t\twhile (remain) {\n\t\t\t\tu32 block_size = OBU_BLOCK_SIZE;\n\t\t\t\tif (block_size &gt; remain) block_size = remain;\n\t\t\t\tgf_bs_read_data(bs, block, block_size);\n\t\t\t\tgf_bs_write_data(state-&gt;bs, block, block_size);\n\t\t\t\tremain -= block_size;\n\t\t\t}\n\t\t\tassert(gf_bs_get_position(bs) == pos + obu_length);\n\t\t\treturn;\n\t\t}\n\t}\n\tif (!obu_list) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] internal error, no OBU list cannot add\\n&quot;));\n\t\tgf_free(a-&gt;obu);\n\t\tgf_free(a);\n\t\treturn;\n\t}\n\ta-&gt;obu_type = obu_type;\n\tif (! *obu_list)\n\t\t*obu_list = gf_list_new();\n\tgf_list_add(*obu_list, a);\n}\n\nstatic void av1_populate_state_from_obu(GF_BitStream *bs, u64 pos, u64 obu_length, ObuType obu_type, AV1State *state)\n{\n\tif (av1_is_obu_header(obu_type)) {\n\t\tav1_add_obu_internal(bs, pos, obu_length, obu_type, &amp;state-&gt;frame_state.header_obus, NULL);\n\t}\n\tif (!state-&gt;skip_frames &amp;&amp; av1_is_obu_frame(state, obu_type)) {\n\t\tif (!state-&gt;mem_mode) {\n\t\t\tav1_add_obu_internal(bs, pos, obu_length, obu_type, &amp;state-&gt;frame_state.frame_obus, NULL);\n\t\t}\n\t\telse {\n\t\t\tav1_add_obu_internal(bs, pos, obu_length, obu_type, NULL, state);\n\t\t}\n\t}\n}\n\nGF_Err aom_av1_parse_temporal_unit_from_section5(GF_BitStream *bs, AV1State *state)\n{\n\tif (!state) return GF_BAD_PARAM;\n\tstate-&gt;obu_type = -1;\n\n\twhile (state-&gt;obu_type != OBU_TEMPORAL_DELIMITER) {\n\t\tGF_Err e;\n\t\tif (!gf_bs_available(bs))\n\t\t\treturn state-&gt;unframed ? GF_BUFFER_TOO_SMALL : GF_OK;\n\n\t\tu64 pos = gf_bs_get_position(bs), obu_size = 0;\n\n\t\te = gf_av1_parse_obu(bs, &amp;state-&gt;obu_type, &amp;obu_size, NULL, state);\n\t\tif (e)\n\t\t\treturn e;\n\n\t\tif (obu_size != gf_bs_get_position(bs) - pos) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] OBU (Section 5) frame size &quot;LLU&quot; different from consumed bytes &quot;LLU&quot;.\\n&quot;, obu_size, gf_bs_get_position(bs) - pos));\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\n\t\tGF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[AV1] Section5 OBU detected (size &quot;LLU&quot;)\\n&quot;, obu_size));\n\t\tav1_populate_state_from_obu(bs, pos, obu_size, state-&gt;obu_type, state);\n\t}\n\n\treturn GF_OK;\n}\n\nBool gf_media_aom_probe_annexb(GF_BitStream *bs)\n{\n\tBool res = GF_TRUE;\n\tu64 init_pos = gf_bs_get_position(bs);\n\tu64 sz = gf_av1_leb128_read(bs, NULL);\n\tif (!sz) res = GF_FALSE;\n\twhile (sz &gt; 0) {\n\t\tu8 Leb128Bytes = 0;\n\t\tu64 frame_unit_size = gf_av1_leb128_read(bs, &amp;Leb128Bytes);\n\n\t\tif (!frame_unit_size) {\n\t\t\tres = GF_FALSE;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (sz &lt; Leb128Bytes + frame_unit_size) {\n\t\t\tres = GF_FALSE;\n\t\t\tbreak;\n\t\t}\n\t\tsz -= Leb128Bytes + frame_unit_size;\n\n\t\twhile (frame_unit_size &gt; 0) {\n\t\t\tObuType obu_type;\n\t\t\tu64 pos, obu_length = gf_av1_leb128_read(bs, &amp;Leb128Bytes);\n\t\t\tif (frame_unit_size &lt; Leb128Bytes + obu_length) {\n\t\t\t\tres = GF_FALSE;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tpos = gf_bs_get_position(bs);\n\t\t\tframe_unit_size -= Leb128Bytes;\n\n\t\t\tu8 tid, sid;\n\t\t\tBool extflag, has_size;\n\t\t\tGF_Err e = gf_av1_parse_obu_header(bs, &amp;obu_type, &amp;extflag, &amp;has_size, &amp;tid, &amp;sid);\n\t\t\tif (e) {\n\t\t\t\tres = GF_FALSE;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (has_size) {\n\t\t\t\tobu_length = (u32)gf_av1_leb128_read(bs, NULL);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (obu_length &gt;= 1 + extflag) {\n\t\t\t\t\tobu_length = obu_length - 1 - extflag;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tres = GF_FALSE;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tu32 hdr_size = (u32)(gf_bs_get_position(bs) - pos);\n\t\t\tobu_length += hdr_size;\n\n\t\t\tif (frame_unit_size &lt; obu_length) {\n\t\t\t\tres = GF_FALSE;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tframe_unit_size -= obu_length;\n\t\t\tgf_bs_skip_bytes(bs, obu_length - hdr_size);\n\t\t}\n\t\tif (!res) break;\n\t}\n\tgf_bs_seek(bs, init_pos);\n\treturn res;\n}\n\nGF_Err aom_av1_parse_temporal_unit_from_annexb(GF_BitStream *bs, AV1State *state)\n{\n\tGF_Err e;\n\tu64 tupos;\n\tu64 tusize, sz;\n\tif (!bs || !state) return GF_BAD_PARAM;\n\n\tgf_bs_mark_overflow(bs, GF_TRUE);\n\ttusize = sz = gf_av1_leb128_read(bs, NULL);\n\ttupos = gf_bs_get_position(bs);\n\tif (!sz) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CODING, (&quot;[AV1] temporal unit size is 0, likely not annex B\\n&quot;));\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\tGF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[AV1] Annex B temporal unit detected (size &quot;LLU&quot;) ***** \\n&quot;, sz));\n\twhile (sz &gt; 0) {\n\t\tu8 Leb128Bytes = 0;\n\t\tu64 frame_unit_size = gf_av1_leb128_read(bs, &amp;Leb128Bytes);\n\n\t\tif (gf_bs_is_overflow(bs)) {\n\t\t\treturn GF_BUFFER_TOO_SMALL;\n\t\t}\n\t\tif (sz &lt; Leb128Bytes + frame_unit_size) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] Annex B sz(&quot;LLU&quot;) &lt; Leb128Bytes(&quot;LLU&quot;) + frame_unit_size(&quot;LLU&quot;)\\n&quot;, sz, Leb128Bytes, frame_unit_size));\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\t\tGF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[AV1] Annex B frame unit detected (size &quot;LLU&quot;)\\n&quot;, frame_unit_size));\n\t\tsz -= Leb128Bytes + frame_unit_size;\n\n\t\twhile (frame_unit_size &gt; 0) {\n\t\t\tu64 pos, obu_size = gf_av1_leb128_read(bs, &amp;Leb128Bytes);\n\n\t\t\tif (gf_bs_is_overflow(bs)) {\n\t\t\t\treturn GF_BUFFER_TOO_SMALL;\n\t\t\t}\n\t\t\tif (frame_unit_size &lt; Leb128Bytes + obu_size) {\n\t\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] Annex B frame_unit_size(&quot;LLU&quot;) &lt; Leb128Bytes(&quot;LLU&quot;) + obu_length(&quot;LLU&quot;)\\n&quot;, frame_unit_size, Leb128Bytes, obu_size));\n\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t\tGF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[AV1] Annex B OBU detected (size &quot;LLU&quot;)\\n&quot;, obu_size));\n\t\t\tpos = gf_bs_get_position(bs);\n\t\t\tframe_unit_size -= Leb128Bytes;\n\n\t\t\te = gf_av1_parse_obu(bs, &amp;state-&gt;obu_type, &amp;obu_size, NULL, state);\n\t\t\tif (e) return e;\n\n\t\t\tif (obu_size != gf_bs_get_position(bs) - pos) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] Annex B frame size &quot;LLU&quot; different from consumed bytes &quot;LLU&quot;.\\n&quot;, obu_size, gf_bs_get_position(bs) - pos));\n\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\n\t\t\tav1_populate_state_from_obu(bs, pos, obu_size, state-&gt;obu_type, state);\n\t\t\tif (frame_unit_size &lt; obu_size) {\n\t\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] Annex B frame_unit_size(&quot;LLU&quot;) &lt; OBU size (&quot;LLU&quot;)\\n&quot;, frame_unit_size, obu_size));\n\t\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t\tframe_unit_size -= obu_size;\n\t\t}\n\t}\n\tassert(sz == 0);\n\tif (tusize != gf_bs_get_position(bs) - tupos) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] Annex B TU size &quot;LLU&quot; different from consumed bytes &quot;LLU&quot;.\\n&quot;, tusize, gf_bs_get_position(bs) - tupos));\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\treturn GF_OK;\n}\n\nGF_Err aom_av1_parse_temporal_unit_from_ivf(GF_BitStream *bs, AV1State *state)\n{\n\tu64 frame_size, pts_ignored;\n\tGF_Err e;\n\tif (gf_bs_available(bs)&lt;12) return GF_EOS;\n\te = gf_media_parse_ivf_frame_header(bs, &amp;frame_size, &amp;pts_ignored);\n\tif (e) return e;\n\tGF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[AV1] IVF frame detected (size &quot;LLU&quot;)\\n&quot;, frame_size));\n\n\tif (gf_bs_available(bs) &lt; frame_size) return GF_EOS;\n\n\twhile (frame_size &gt; 0) {\n\t\tu64 obu_size = 0, pos = gf_bs_get_position(bs);\n\n\t\te = gf_av1_parse_obu(bs, &amp;state-&gt;obu_type, &amp;obu_size, NULL, state);\n\t\tif (e != GF_OK)\n\t\t\treturn e;\n\n\t\tif (obu_size != gf_bs_get_position(bs) - pos) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] IVF frame size &quot;LLU&quot; different from consumed bytes &quot;LLU&quot;.\\n&quot;, obu_size, gf_bs_get_position(bs) - pos));\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\n\t\tav1_populate_state_from_obu(bs, pos, obu_size, state-&gt;obu_type, state);\n\n\t\tframe_size -= obu_size;\n\t}\n\treturn GF_OK;\n}\n\n#define AV1_NUM_REF_FRAMES 8\n#define AV1_ALL_FRAMES ((1 &lt;&lt; AV1_NUM_REF_FRAMES) - 1)\n\n#define AV1_SUPERRES_DENOM_MIN 9\n#define AV1_SUPERRES_DENOM_BITS 3\n#define AV1_SUPERRES_NUM 8\n\n#define AV1_REFS_PER_FRAME 7\n#define AV1_PRIMARY_REF_NONE 7\n\n#define MAX_TILE_WIDTH 4096\n#define MAX_TILE_AREA (4096 * 2304)\n\nstatic u32 aom_av1_tile_log2(u32 blkSize, u32 target)\n{\n\tu32 k;\n\tfor (k = 0; (blkSize &lt;&lt; k) &lt; target; k++) {\n\t}\n\treturn k;\n}\n\nstatic u64 aom_av1_le(GF_BitStream *bs, u32 n, const char *name) {\n\tu32 i = 0;\n\tu64 t = 0;\n\tfor (i = 0; i &lt; n; i++) {\n\t\tu8 byte = gf_bs_read_int(bs, 8);\n\t\tt += (byte &lt;&lt; (i * 8));\n\t}\n\tgf_bs_log(bs, n*8, name, t);\n\treturn t;\n}\n\n\nstatic void av1_parse_tile_info(GF_BitStream *bs, AV1State *state)\n{\n\tu32 i;\n\tu32 MiCols = 2 * ((state-&gt;width + 7) &gt;&gt; 3);\n\tu32 MiRows = 2 * ((state-&gt;height + 7) &gt;&gt; 3);\n\tu32 sbCols = state-&gt;use_128x128_superblock ? ((MiCols + 31) &gt;&gt; 5) : ((MiCols + 15) &gt;&gt; 4);\n\tu32 sbRows = state-&gt;use_128x128_superblock ? ((MiRows + 31) &gt;&gt; 5) : ((MiRows + 15) &gt;&gt; 4);\n\tu32 sbShift = state-&gt;use_128x128_superblock ? 5 : 4;\n\tu32 sbSize = sbShift + 2;\n\tu32 maxTileWidthSb = MAX_TILE_WIDTH &gt;&gt; sbSize;\n\tu32 maxTileAreaSb = MAX_TILE_AREA &gt;&gt; (2 * sbSize);\n\tu32 minLog2tileCols = aom_av1_tile_log2(maxTileWidthSb, sbCols);\n\tu32 maxLog2tileCols = aom_av1_tile_log2(1, MIN(sbCols, AV1_MAX_TILE_COLS));\n\tu32 maxLog2tileRows = aom_av1_tile_log2(1, MIN(sbRows, AV1_MAX_TILE_ROWS));\n\tu32 minLog2Tiles = MAX(minLog2tileCols, aom_av1_tile_log2(maxTileAreaSb, sbRows * sbCols));\n\tBool uniform_tile_spacing_flag = gf_bs_read_int_log(bs, 1, &quot;uniform_tile_spacing_flag&quot;);\n\tif (uniform_tile_spacing_flag) {\n\t\tu32 startSb, tileWidthSb, tileHeightSb, minLog2tileRows;\n\t\tstate-&gt;tileColsLog2 = minLog2tileCols;\n\t\twhile (state-&gt;tileColsLog2 &lt; maxLog2tileCols) {\n\t\t\tBool increment_tile_cols_log2 = gf_bs_read_int_log(bs, 1, &quot;increment_tile_cols_log2&quot;);\n\t\t\tif (increment_tile_cols_log2 == 1)\n\t\t\t\tstate-&gt;tileColsLog2++;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t}\n\n\t\ttileWidthSb = (sbCols + (1 &lt;&lt; state-&gt;tileColsLog2) - 1) &gt;&gt; state-&gt;tileColsLog2;\n\t\ti = 0;\n\t\tfor (startSb = 0; startSb &lt; sbCols; startSb += tileWidthSb) {\n\t\t\ti += 1;\n\t\t}\n\t\tstate-&gt;tileCols = i;\n\t\tminLog2tileRows = MAX((int)(minLog2Tiles - state-&gt;tileColsLog2), 0);\n\t\tstate-&gt;tileRowsLog2 = minLog2tileRows;\n\t\twhile (state-&gt;tileRowsLog2 &lt; maxLog2tileRows) {\n\t\t\tBool increment_tile_rows_log2 = gf_bs_read_int_log(bs, 1, &quot;increment_tile_rows_log2&quot;);\n\t\t\tif (increment_tile_rows_log2 == 1)\n\t\t\t\tstate-&gt;tileRowsLog2++;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t}\n\n\t\ttileHeightSb = (sbRows + (1 &lt;&lt; state-&gt;tileRowsLog2) - 1) &gt;&gt; state-&gt;tileRowsLog2;\n\t\ti = 0;\n\t\tfor (startSb = 0; startSb &lt; sbRows; startSb += tileHeightSb) {\n\t\t\ti += 1;\n\t\t}\n\t\tstate-&gt;tileRows = i;\n\t}\n\telse {\n\t\tu32 startSb, maxTileHeightSb, widestTileSb;\n\t\twidestTileSb = 0;\n\t\tstartSb = 0;\n\t\tfor (i = 0; startSb &lt; sbCols; i++) {\n\t\t\tu32 maxWidth = MIN((int)(sbCols - startSb), maxTileWidthSb);\n\t\t\tu32 width_in_sbs_minus_1 = av1_read_ns(bs, maxWidth, &quot;width_in_sbs_minus_1&quot;);\n\t\t\tu32 sizeSb = width_in_sbs_minus_1 + 1;\n\t\t\twidestTileSb = MAX(sizeSb, widestTileSb);\n\t\t\tstartSb += sizeSb;\n\t\t}\n\t\tif (!widestTileSb) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] widest tile is 0, broken bitstream\\n&quot;));\n\t\t\treturn;\n\t\t}\n\t\tstate-&gt;tileCols = i;\n\t\tstate-&gt;tileColsLog2 = aom_av1_tile_log2(1, state-&gt;tileCols);\n\n\t\tif (minLog2Tiles &gt; 0)\n\t\t\tmaxTileAreaSb = (sbRows * sbCols) &gt;&gt; (minLog2Tiles + 1);\n\t\telse\n\t\t\tmaxTileAreaSb = sbRows * sbCols;\n\t\tmaxTileHeightSb = MAX(maxTileAreaSb / widestTileSb, 1);\n\n\t\tstartSb = 0;\n\t\tfor (i = 0; startSb &lt; sbRows; i++) {\n\t\t\tu32 maxHeight = MIN((int)(sbRows - startSb), maxTileHeightSb);\n\t\t\tu32 height_in_sbs_minus_1 = av1_read_ns(bs, maxHeight, &quot;height_in_sbs_minus_1&quot;);\n\t\t\tu32 sizeSb = height_in_sbs_minus_1 + 1;\n\t\t\tstartSb += sizeSb;\n\t\t}\n\n\t\tstate-&gt;tileRows = i;\n\t\tstate-&gt;tileRowsLog2 = aom_av1_tile_log2(1, state-&gt;tileRows);\n\t}\n\tif (state-&gt;tileColsLog2 &gt; 0 || state-&gt;tileRowsLog2 &gt; 0) {\n\t\tgf_bs_read_int_log(bs, state-&gt;tileRowsLog2 + state-&gt;tileColsLog2, &quot;context_update_tile_id&quot;);\n\t\tstate-&gt;tile_size_bytes = gf_bs_read_int_log(bs, 2, &quot;tile_size_bytes_minus1&quot;) + 1;\n\t}\n}\n\nstatic void superres_params(GF_BitStream *bs, AV1State *state)\n{\n\tu32 SuperresDenom;\n\tBool use_superres;\n\n\tif (state-&gt;enable_superres) {\n\t\tuse_superres = gf_bs_read_int_log(bs, 1, &quot;use_superres&quot;);\n\t}\n\telse {\n\t\tuse_superres = GF_FALSE;\n\t}\n\tif (use_superres) {\n\t\tu8 coded_denom = gf_bs_read_int_log(bs, AV1_SUPERRES_DENOM_BITS, &quot;coded_denom&quot;);\n\t\tSuperresDenom = coded_denom + AV1_SUPERRES_DENOM_MIN;\n\t}\n\telse {\n\t\tSuperresDenom = AV1_SUPERRES_NUM;\n\t}\n\tstate-&gt;UpscaledWidth = state-&gt;width;\n\tstate-&gt;width = (state-&gt;UpscaledWidth * AV1_SUPERRES_NUM + (SuperresDenom / 2)) / SuperresDenom;\n}\n\nstatic void av1_frame_size(GF_BitStream *bs, AV1State *state, Bool frame_size_override_flag)\n{\n\tif (frame_size_override_flag) {\n\t\tu32 frame_width_minus_1, frame_height_minus_1;\n\t\tu8 n = state-&gt;frame_width_bits_minus_1 + 1;\n\t\tframe_width_minus_1 = gf_bs_read_int_log(bs, n, &quot;frame_width_minus_1&quot;);\n\t\tn = state-&gt;frame_height_bits_minus_1 + 1;\n\t\tframe_height_minus_1 = gf_bs_read_int_log(bs, n, &quot;frame_height_minus_1&quot;);\n\t\tstate-&gt;width = frame_width_minus_1 + 1;\n\t\tstate-&gt;height = frame_height_minus_1 + 1;\n\t} else {\n\t\tstate-&gt;width = state-&gt;sequence_width;\n\t\tstate-&gt;height = state-&gt;sequence_height;\n\t}\n\tsuperres_params(bs, state);\n\t//compute_image_size(); //no bits\n}\n\nstatic void av1_render_size(GF_BitStream *bs)\n{\n\tBool render_and_frame_size_different = gf_bs_read_int_log(bs, 1, &quot;render_and_frame_size_different_flag&quot;);\n\tif (render_and_frame_size_different == GF_TRUE) {\n\t\tgf_bs_read_int_log(bs, 16, &quot;render_width_minus_1&quot;);\n\t\tgf_bs_read_int_log(bs, 16, &quot;render_height_minus_1&quot;);\n\t\t//RenderWidth = render_width_minus_1 + 1;\n\t\t//RenderHeight = render_height_minus_1 + 1;\n\t}\n\telse {\n\t\t//RenderWidth = UpscaledWidth;\n\t\t//RenderHeight = FrameHeight;\n\t}\n}\n\nstatic void read_interpolation_filter(GF_BitStream *bs)\n{\n\tBool is_filter_switchable = gf_bs_read_int_log(bs, 1, &quot;is_filter_switchable&quot;);\n\tif (!is_filter_switchable) {\n\t\t/*interpolation_filter =*/ gf_bs_read_int_log(bs, 2, &quot;interpolation_filter&quot;);\n\t}\n}\n\nstatic void frame_size_with_refs(GF_BitStream *bs, AV1State *state, Bool frame_size_override_flag, s8 *ref_frame_idx)\n{\n\tBool found_ref = GF_FALSE;\n\tu32 i = 0;\n\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\tfound_ref = gf_bs_read_int_log_idx(bs, 1, &quot;found_ref&quot;, i);\n\t\tif (found_ref == 1) {\n\t\t\tstate-&gt;UpscaledWidth = state-&gt;RefUpscaledWidth[ref_frame_idx[i]];\n\t\t\tstate-&gt;width = state-&gt;UpscaledWidth;\n\t\t\tstate-&gt;height = state-&gt;RefFrameHeight[ref_frame_idx[i]];\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (found_ref == 0) {\n\t\tav1_frame_size(bs, state, frame_size_override_flag);\n\t\tav1_render_size(bs);\n\t}\n\telse {\n\t\tsuperres_params(bs, state);\n\t\t//compute_image_size();\n\t}\n}\n\nstatic s32 av1_delta_q(GF_BitStream *bs, const char *name_flag, const char *name)\n{\n\tBool delta_coded = gf_bs_read_int_log(bs, 1, name_flag);\n\ts32 delta_q = 0;\n\tif (delta_coded) {\n\t\tu32 signMask = 1 &lt;&lt; (7 - 1);\n\t\tdelta_q = gf_bs_read_int_log(bs, 7, name);\n\t\tif (delta_q &amp; signMask)\n\t\t\tdelta_q = delta_q - 2 * signMask;\n\t}\n\treturn delta_q;\n}\n\nstatic u8 Segmentation_Feature_Bits[] = { 8,6,6,6,6,3,0,0 };\nstatic u8 Segmentation_Feature_Signed[] = { 1, 1, 1, 1, 1, 0, 0, 0 };\n\nstatic u8 av1_get_qindex(Bool ignoreDeltaQ, u32 segmentId, u32 base_q_idx, u32 delta_q_present, u32 CurrentQIndex, Bool segmentation_enabled, u8 *features_SEG_LVL_ALT_Q_enabled, s32 *features_SEG_LVL_ALT_Q)\n{\n\t//If seg_feature_active_idx( segmentId, SEG_LVL_ALT_Q ) is equal to 1 the following ordered steps apply:\n\tif (segmentation_enabled &amp;&amp; features_SEG_LVL_ALT_Q_enabled[segmentId]) {\n\t\t//Set the variable data equal to FeatureData[ segmentId ][ SEG_LVL_ALT_Q ].\n\t\ts32 data = features_SEG_LVL_ALT_Q[segmentId];\n\t\ts32 qindex = base_q_idx + data;\n\t\t//If ignoreDeltaQ is equal to 0 and delta_q_present is equal to 1, set qindex equal to CurrentQIndex + data.\n\t\tif ((ignoreDeltaQ == 0) &amp;&amp; (delta_q_present == 1)) qindex = CurrentQIndex + data;\n\t\t//Return Clip3( 0, 255, qindex ).\n\t\tif (qindex &lt; 0) return 0;\n\t\telse if (qindex &gt; 255) return 255;\n\t\telse return (u8)qindex;\n\t}\n\t//Otherwise, if ignoreDeltaQ is equal to 0 and delta_q_present is equal to 1, return CurrentQIndex.\n\tif ((ignoreDeltaQ == 0) &amp;&amp; (delta_q_present == 1)) return CurrentQIndex;\n\t//otherwise\n\treturn base_q_idx;\n}\n\nenum {\n\tAV1_RESTORE_NONE = 0,\n\tAV1_RESTORE_SWITCHABLE,\n\tAV1_RESTORE_WIENER,\n\tAV1_RESTORE_SGRPROJ\n};\n\n#define AV1_GMC_IDENTITY  0\n#define AV1_GMC_TRANSLATION 1\n#define AV1_GMC_ROTZOOM 2\n#define AV1_GMC_AFFINE 3\n\n#define AV1_LAST_FRAME 1\n#define AV1_LAST2_FRAME 2\n#define AV1_LAST3_FRAME 3\n#define AV1_GOLDEN_FRAME 4\n#define AV1_BWDREF_FRAME 5\n#define AV1_ALTREF2_FRAME 6\n#define AV1_ALTREF_FRAME 7\n\n#define GM_ABS_ALPHA_BITS 12\n#define GM_ALPHA_PREC_BITS 15\n#define GM_ABS_TRANS_ONLY_BITS 9\n#define GM_TRANS_ONLY_PREC_BITS 3\n#define GM_ABS_TRANS_BITS 12\n#define GM_TRANS_PREC_BITS 6\n#define WARPEDMODEL_PREC_BITS 16\n\n\nstatic u32 av1_decode_subexp(GF_BitStream *bs, s32 numSyms)\n{\n\ts32 i = 0;\n\ts32 mk = 0;\n\ts32 k = 3;\n\twhile (1) {\n\t\ts32 b2 = i ? k + i - 1 : k;\n\t\ts32 a = 1 &lt;&lt; b2;\n\t\tif (numSyms &lt;= mk + 3 * a) {\n\t\t\ts32 subexp_final_bits = av1_read_ns(bs, numSyms - mk, NULL);\n\t\t\treturn subexp_final_bits + mk;\n\t\t}\n\t\telse {\n\t\t\ts32 subexp_more_bits = gf_bs_read_int(bs, 1);\n\t\t\tif (subexp_more_bits) {\n\t\t\t\ti++;\n\t\t\t\tmk += a;\n\t\t\t}\n\t\t\telse {\n\t\t\t\ts32 subexp_bits = gf_bs_read_int(bs, b2);\n\t\t\t\treturn subexp_bits + mk;\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic GFINLINE s32 inverse_recenter(s32 r, u32 v)\n{\n\tif ((s64)v &gt; (s64)(2 * r))\n\t\treturn v;\n\telse if (v &amp; 1)\n\t\treturn r - ((v + 1) &gt;&gt; 1);\n\telse\n\t\treturn r + (v &gt;&gt; 1);\n}\n\nstatic s32 av1_decode_unsigned_subexp_with_ref(GF_BitStream *bs, s32 mx, s32 r)\n{\n\tu32 v = av1_decode_subexp(bs, mx);\n\tif ((r &lt; 0) &amp;&amp; (-(-r &lt;&lt; 1) &lt;= mx)) {\n\t\treturn inverse_recenter(r, v);\n\t}\n\telse if ((r &lt;&lt; 1) &lt;= mx) {\n\t\treturn inverse_recenter(r, v);\n\t}\n\telse {\n\t\treturn mx - 1 - inverse_recenter(mx - 1 - r, v);\n\t}\n}\nstatic s16 av1_decode_signed_subexp_with_ref(GF_BitStream *bs, s32 low, s32 high, s32 r)\n{\n\ts16 x = av1_decode_unsigned_subexp_with_ref(bs, high - low, r - low);\n\treturn x + low;\n}\n\nstatic void av1_read_global_param(AV1State *state, GF_BitStream *bs, u8 type, u8 ref, u8 idx)\n{\n\tu8 absBits = GM_ABS_ALPHA_BITS;\n\tu8 precBits = GM_ALPHA_PREC_BITS;\n\tif (idx &lt; 2) {\n\t\tif (type == AV1_GMC_TRANSLATION) {\n\t\t\tabsBits = GM_ABS_TRANS_ONLY_BITS - (!state-&gt;frame_state.allow_high_precision_mv ? 1 : 0);\n\t\t\tprecBits = GM_TRANS_ONLY_PREC_BITS - (!state-&gt;frame_state.allow_high_precision_mv ? 1 : 0);\n\t\t}\n\t\telse {\n\t\t\tabsBits = GM_ABS_TRANS_BITS;\n\t\t\tprecBits = GM_TRANS_PREC_BITS;\n\t\t}\n\t}\n\ts32 precDiff = WARPEDMODEL_PREC_BITS - precBits;\n\ts32 round = (idx % 3) == 2 ? (1 &lt;&lt; WARPEDMODEL_PREC_BITS) : 0;\n\ts32 sub = (idx % 3) == 2 ? (1 &lt;&lt; precBits) : 0;\n\ts32 mx = (1 &lt;&lt; absBits);\n\ts32 r = (state-&gt;PrevGmParams.coefs[ref][idx] &gt;&gt; precDiff) - sub;\n\ts32 val = av1_decode_signed_subexp_with_ref(bs, -mx, mx + 1, r);\n\n\tif (val &lt; 0) {\n\t\tval = -val;\n\t\tstate-&gt;GmParams.coefs[ref][idx] = (-(val &lt;&lt; precDiff) + round);\n\t}\n\telse {\n\t\tstate-&gt;GmParams.coefs[ref][idx] = (val &lt;&lt; precDiff) + round;\n\t}\n}\n\nstatic s32 av1_get_relative_dist(s32 a, s32 b, AV1State *state)\n{\n\tif (!state-&gt;enable_order_hint)\n\t\treturn 0;\n\ts32 diff = a - b;\n\ts32 m = 1 &lt;&lt; (state-&gt;OrderHintBits - 1);\n\tdiff = (diff &amp; (m - 1)) - (diff &amp; m);\n\treturn diff;\n}\n\nstatic void av1_setup_past_independence(AV1State *state)\n{\n\tu32 ref, i;\n\tfor (ref = AV1_LAST_FRAME; ref &lt;= AV1_ALTREF_FRAME; ref++) {\n\t\tfor (i = 0; i &lt;= 5; i++) {\n\t\t\tstate-&gt;PrevGmParams.coefs[ref][i] = ((i % 3 == 2) ? 1 &lt;&lt; WARPEDMODEL_PREC_BITS : 0);\n\t\t}\n\t}\n}\n\nstatic void av1_load_previous(AV1State *state, u8 primary_ref_frame, s8 *ref_frame_idx)\n{\n\ts8 prevFrame = ref_frame_idx[primary_ref_frame];\n\tif (prevFrame &lt; 0) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] load_previous: prevFrame reference index %d is invalid\\n&quot;, prevFrame));\n\t}\n\telse {\n\t\tstate-&gt;PrevGmParams = state-&gt;SavedGmParams[prevFrame];\n\t\t// load_loop_filter_params( prevFrame )\n\t\t// load_segmentation_params( prevFrame )\n\t}\n}\n\nstatic void av1_decode_frame_wrapup(AV1State *state)\n{\n\tu32 i;\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\tif ((state-&gt;frame_state.refresh_frame_flags &gt;&gt; i) &amp; 1) {\n\t\t\tstate-&gt;RefOrderHint[i] = state-&gt;frame_state.order_hint;\n\t\t\tstate-&gt;SavedGmParams[i] = state-&gt;GmParams;\n\t\t\tstate-&gt;RefFrameType[i] = state-&gt;frame_state.frame_type;\n\t\t\tstate-&gt;RefUpscaledWidth[i] = state-&gt;UpscaledWidth;\n\t\t\tstate-&gt;RefFrameHeight[i] = state-&gt;height;\n\t\t}\n\t}\n\tstate-&gt;frame_state.seen_frame_header = GF_FALSE;\n\t//Otherwise (show_existing_frame is equal to 1), if frame_type is equal to KEY_FRAME, the reference frame loading process as specified in section 7.21 is invoked\n\tif ((state-&gt;frame_state.show_existing_frame) &amp;&amp; (state-&gt;frame_state.frame_type == AV1_KEY_FRAME)) {\n\t\tstate-&gt;frame_state.order_hint = state-&gt;RefOrderHint[state-&gt;frame_state.frame_to_show_map_idx];\n\t\t//OrderHints[ j + LAST_FRAME ] is set equal to SavedOrderHints[state-&gt;frame_to_show_map_idx ][ j + LAST_FRAME ] for j = 0..REFS_PER_FRAME-1.\n\n\t\t//gm_params[ ref ][ j ] is set equal to SavedGmParams[ frame_to_show_map_idx ][ ref ][ j ] for ref = LAST_FRAME..ALTREF_FRAME, for j = 0..5.\n\t\tstate-&gt;GmParams = state-&gt;SavedGmParams[state-&gt;frame_state.frame_to_show_map_idx];\n\n\t}\n}\n\nstatic s32 find_latest_forward(u32 curFrameHint, u8 *shiftedOrderHints, u8 *usedFrame)\n{\n\tu32 i;\n\ts32 ref = -1;\n\ts32 latestOrderHint = 0;\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\ts32 hint = shiftedOrderHints[i];\n\t\tif (!usedFrame[i] &amp;&amp; ((u32)hint &lt; curFrameHint) &amp;&amp; (ref &lt; 0 || hint &gt;= latestOrderHint)) {\n\t\t\tref = i;\n\t\t\tlatestOrderHint = hint;\n\t\t}\n\t}\n\treturn ref;\n}\n\n//see 7.8 of AV1 spec\nstatic void av1_set_frame_refs(AV1State *state, u8 last_frame_idx, u8 gold_frame_idx, s8 *ref_frame_idx)\n{\n\tu32 i;\n\tu8 usedFrame[AV1_NUM_REF_FRAMES];\n\tu8 shiftedOrderHints[AV1_NUM_REF_FRAMES];\n\n\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++)\n\t\tref_frame_idx[i] = -1;\n\n\tref_frame_idx[AV1_LAST_FRAME - AV1_LAST_FRAME] = last_frame_idx;\n\tref_frame_idx[AV1_GOLDEN_FRAME - AV1_LAST_FRAME] = gold_frame_idx;\n\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\tusedFrame[i] = 0;\n\t}\n\n\tusedFrame[last_frame_idx] = 1;\n\tusedFrame[gold_frame_idx] = 1;\n\tu32 curFrameHint = 1 &lt;&lt; (state-&gt;OrderHintBits - 1);\n\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\tshiftedOrderHints[i] = curFrameHint + av1_get_relative_dist(state-&gt;RefOrderHint[i], state-&gt;frame_state.order_hint, state);\n\t}\n\n\tu8 lastOrderHint = shiftedOrderHints[last_frame_idx];\n\tu8 goldOrderHint = shiftedOrderHints[gold_frame_idx];\n\n\t//It is a requirement of bitstream conformance that lastOrderHint is strictly less than curFrameHint.\n\tif (lastOrderHint &gt;= curFrameHint) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] non conformant bitstream detected while setting up frame refs: lastOrderHint(%d) shall be stricly less than curFrameHint(%d)\\n&quot;, lastOrderHint, curFrameHint));\n\t}\n\t//It is a requirement of bitstream conformance that goldOrderHint is strictly less than curFrameHint.\n\tif (goldOrderHint &gt;= curFrameHint) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] non conformant bitstream detected while setting up frame refs: goldOrderHint(%d) shall be stricly less than curFrameHint(%d)\\n&quot;, lastOrderHint, curFrameHint));\n\t}\n\n\t//find_latest_backward() {\n\ts32 ref = -1;\n\ts32 latestOrderHint = 0;\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\ts32 hint = shiftedOrderHints[i];\n\t\tif (!usedFrame[i] &amp;&amp; ((u32)hint &gt;= curFrameHint) &amp;&amp; (ref &lt; 0 || hint &gt;= latestOrderHint)) {\n\t\t\tref = i;\n\t\t\tlatestOrderHint = hint;\n\t\t}\n\t}\n\tif (ref &gt;= 0) {\n\t\tref_frame_idx[AV1_ALTREF_FRAME - AV1_LAST_FRAME] = ref;\n\t\tusedFrame[ref] = 1;\n\t}\n\t//find_earliest_backward() for BWDREF_FRAME\n\tref = -1;\n\ts32 earliestOrderHint = 0;\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\ts32 hint = shiftedOrderHints[i];\n\t\tif (!usedFrame[i] &amp;&amp; ((u32)hint &gt;= curFrameHint) &amp;&amp; (ref &lt; 0 || hint &lt; earliestOrderHint)) {\n\t\t\tref = i;\n\t\t\tearliestOrderHint = hint;\n\t\t}\n\t}\n\tif (ref &gt;= 0) {\n\t\tref_frame_idx[AV1_BWDREF_FRAME - AV1_LAST_FRAME] = ref;\n\t\tusedFrame[ref] = 1;\n\t}\n\n\t//find_earliest_backward() for ALTREF2_FRAME\n\tref = -1;\n\tearliestOrderHint = 0;\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\ts32 hint = shiftedOrderHints[i];\n\t\tif (!usedFrame[i] &amp;&amp; ((u32)hint &gt;= curFrameHint) &amp;&amp; (ref &lt; 0 || hint &lt; earliestOrderHint)) {\n\t\t\tref = i;\n\t\t\tearliestOrderHint = hint;\n\t\t}\n\t}\n\tif (ref &gt;= 0) {\n\t\tref_frame_idx[AV1_ALTREF2_FRAME - AV1_LAST_FRAME] = ref;\n\t\tusedFrame[ref] = 1;\n\t}\n\n\t//The remaining references are set to be forward references in anti-chronological order as follows:\n\n\tconst u8 Ref_Frame_List[AV1_REFS_PER_FRAME - 2] = {\n\t\tAV1_LAST2_FRAME, AV1_LAST3_FRAME, AV1_BWDREF_FRAME, AV1_ALTREF2_FRAME, AV1_ALTREF_FRAME\n\t};\n\n\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME - 2; i++) {\n\t\tu8 refFrame = Ref_Frame_List[i];\n\t\tif (ref_frame_idx[refFrame - AV1_LAST_FRAME] &lt; 0) {\n\t\t\ts32 last_ref = find_latest_forward(curFrameHint, shiftedOrderHints, usedFrame);\n\t\t\tif (last_ref &gt;= 0) {\n\t\t\t\tref_frame_idx[refFrame - AV1_LAST_FRAME] = last_ref;\n\t\t\t\tusedFrame[last_ref] = 1;\n\t\t\t}\n\t\t}\n\t}\n\t//Finally, any remaining references are set to the reference frame with smallest output order as follows:\n\tref = -1;\n\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\ts32 hint = shiftedOrderHints[i];\n\t\tif (ref &lt; 0 || hint &lt; earliestOrderHint) {\n\t\t\tref = i;\n\t\t\tearliestOrderHint = hint;\n\t\t}\n\t}\n\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\tif (ref_frame_idx[i] &lt; 0) {\n\t\t\tref_frame_idx[i] = ref;\n\t\t}\n\t}\n}\n\n\nstatic void av1_parse_uncompressed_header(GF_BitStream *bs, AV1State *state)\n{\n\tBool error_resilient_mode = GF_FALSE, allow_screen_content_tools = GF_FALSE, force_integer_mv = GF_FALSE;\n\tBool /*use_ref_frame_mvs = GF_FALSE,*/ FrameIsIntra = GF_FALSE, frame_size_override_flag = GF_FALSE;\n\tBool disable_cdf_update = GF_FALSE;\n\tu8 showable_frame;\n\tu8 primary_ref_frame;\n\tu16 idLen = 0;\n\tu32 idx;\n\ts8 ref_frame_idx[AV1_REFS_PER_FRAME];\n\tAV1StateFrame *frame_state = &amp;state-&gt;frame_state;\n\n\tif (state-&gt;frame_id_numbers_present_flag) {\n\t\tidLen = (state-&gt;additional_frame_id_length_minus_1 + state-&gt;delta_frame_id_length_minus_2 + 3);\n\t}\n\tframe_state-&gt;refresh_frame_flags = 0;\n\n\tshowable_frame = 0;\n\tif (state-&gt;reduced_still_picture_header) {\n\t\tframe_state-&gt;key_frame = GF_TRUE;\n\t\tFrameIsIntra = GF_TRUE;\n\t\tframe_state-&gt;frame_type = AV1_KEY_FRAME;\n\t\tframe_state-&gt;show_frame = GF_TRUE;\n\t\tframe_state-&gt;show_existing_frame = 0;\n\t}\n\telse {\n\t\tframe_state-&gt;show_existing_frame = gf_bs_read_int_log(bs, 1, &quot;show_existing_frame&quot;);\n\t\tif (frame_state-&gt;show_existing_frame == GF_TRUE) {\n\t\t\tframe_state-&gt;frame_to_show_map_idx = gf_bs_read_int_log(bs, 3, &quot;frame_to_show_map_idx&quot;);\n\t\t\tframe_state-&gt;frame_type = state-&gt;RefFrameType[frame_state-&gt;frame_to_show_map_idx];\n\n\t\t\tif (state-&gt;decoder_model_info_present_flag &amp;&amp; !state-&gt;equal_picture_interval) {\n\t\t\t\tgf_bs_read_int_log(bs, state-&gt;frame_presentation_time_length, &quot;frame_presentation_time&quot;);\n\t\t\t}\n\n\t\t\tframe_state-&gt;refresh_frame_flags = 0;\n\t\t\tif (state-&gt;frame_id_numbers_present_flag) {\n\t\t\t\tgf_bs_read_int_log(bs, idLen, &quot;display_frame_id&quot;);\n\t\t\t}\n\t\t\tif (frame_state-&gt;frame_type == AV1_KEY_FRAME) {\n\t\t\t\tframe_state-&gt;refresh_frame_flags = AV1_ALL_FRAMES;\n\t\t\t}\n\t\t\t/*\n\t\t\tif (film_grain_params_present) {\n\t\t\t\tload_grain_params(frame_to_show_map_idx)\n\t\t\t}*/\n\t\t\treturn;\n\t\t}\n\t\tframe_state-&gt;frame_type = gf_bs_read_int_log(bs, 2, &quot;frame_type&quot;);\n\t\tFrameIsIntra = (frame_state-&gt;frame_type == AV1_INTRA_ONLY_FRAME || frame_state-&gt;frame_type == AV1_KEY_FRAME);\n\t\tframe_state-&gt;show_frame = gf_bs_read_int_log(bs, 1, &quot;show_frame&quot;);\n\t\tif (frame_state-&gt;is_first_frame) {\n\t\t\tframe_state-&gt;key_frame = frame_state-&gt;seen_seq_header &amp;&amp; frame_state-&gt;show_frame &amp;&amp; frame_state-&gt;frame_type == AV1_KEY_FRAME &amp;&amp; frame_state-&gt;seen_frame_header;\n\t\t}\n\t\tif (frame_state-&gt;show_frame &amp;&amp; state-&gt;decoder_model_info_present_flag &amp;&amp; !state-&gt;equal_picture_interval) {\n\t\t\tgf_bs_read_int_log(bs, state-&gt;frame_presentation_time_length, &quot;frame_presentation_time&quot;);\n\t\t}\n\t\tif (frame_state-&gt;show_frame) {\n\t\t\tshowable_frame = frame_state-&gt;frame_type != AV1_KEY_FRAME;\n\n\t\t}\n\t\telse {\n\t\t\tshowable_frame = gf_bs_read_int_log(bs, 1, &quot;showable_frame&quot;);\n\t\t}\n\t\tif (frame_state-&gt;frame_type == AV1_SWITCH_FRAME || (frame_state-&gt;frame_type == AV1_KEY_FRAME &amp;&amp; frame_state-&gt;show_frame))\n\t\t\terror_resilient_mode = GF_TRUE;\n\t\telse\n\t\t\terror_resilient_mode = gf_bs_read_int_log(bs, 1, &quot;error_resilient_mode&quot;);\n\t}\n\n\tif ((frame_state-&gt;frame_type == AV1_KEY_FRAME) &amp;&amp; frame_state-&gt;show_frame) {\n\t\tu32 i;\n\t\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\t\tstate-&gt;RefValid[i] = 0;\n\t\t\tstate-&gt;RefOrderHint[i] = 0;\n\t\t}\n\t\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\t\tstate-&gt;OrderHints[AV1_LAST_FRAME + i] = 0;\n\t\t}\n\t}\n\n\tdisable_cdf_update = gf_bs_read_int_log(bs, 1, &quot;disable_cdf_update&quot;);\n\tif (state-&gt;seq_force_screen_content_tools == 2/*SELECT_SCREEN_CONTENT_TOOLS*/) {\n\t\tallow_screen_content_tools = gf_bs_read_int_log(bs, 1, &quot;allow_screen_content_tools&quot;);\n\t}\n\telse {\n\t\tallow_screen_content_tools = state-&gt;seq_force_screen_content_tools;\n\t}\n\tif (allow_screen_content_tools) {\n\t\tif (state-&gt;seq_force_integer_mv == 2/*SELECT_INTEGER_MV*/) {\n\t\t\tforce_integer_mv = gf_bs_read_int_log(bs, 1, &quot;force_integer_mv&quot;);\n\t\t}\n\t\telse {\n\t\t\tforce_integer_mv = state-&gt;seq_force_integer_mv;\n\t\t}\n\t}\n\telse {\n\t\tforce_integer_mv = 0;\n\t}\n\tif (FrameIsIntra) {\n\t\tforce_integer_mv = 1;\n\t}\n\tif (state-&gt;frame_id_numbers_present_flag) {\n\t\tgf_bs_read_int_log(bs, idLen, &quot;current_frame_id&quot;);\n\t}\n\tif (frame_state-&gt;frame_type == AV1_SWITCH_FRAME)\n\t\tframe_size_override_flag = GF_TRUE;\n\telse if (state-&gt;reduced_still_picture_header)\n\t\tframe_size_override_flag = GF_FALSE;\n\telse\n\t\tframe_size_override_flag = gf_bs_read_int_log(bs, 1, &quot;frame_size_override_flag&quot;);\n\n\tframe_state-&gt;order_hint = gf_bs_read_int_log(bs, state-&gt;OrderHintBits, &quot;order_hint&quot;);\n\tif (FrameIsIntra || error_resilient_mode) {\n\t\tprimary_ref_frame = AV1_PRIMARY_REF_NONE;\n\t}\n\telse {\n\t\tprimary_ref_frame = gf_bs_read_int_log(bs, 3, &quot;primary_ref_frame&quot;);\n\t}\n\n\tif (state-&gt;decoder_model_info_present_flag) {\n\t\tu8 buffer_removal_time_present_flag = gf_bs_read_int_log(bs, 1, &quot;buffer_removal_time_present_flag&quot;);\n\t\tif (buffer_removal_time_present_flag) {\n\t\t\tu32 opNum;\n\t\t\tfor (opNum = 0; opNum &lt; state-&gt;operating_points_count; opNum++) {\n\t\t\t\tif (state-&gt;decoder_model_present_for_this_op[opNum]) {\n\t\t\t\t\tu8 opPtIdc = state-&gt;operating_point_idc[opNum];\n\t\t\t\t\tu8 inTemporalLayer = (opPtIdc &gt;&gt; state-&gt;temporal_id) &amp; 1;\n\t\t\t\t\tu8 inSpatialLayer = (opPtIdc &gt;&gt; (state-&gt;spatial_id + 8)) &amp; 1;\n\t\t\t\t\tif (opPtIdc == 0 || (inTemporalLayer &amp;&amp; inSpatialLayer)) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, state-&gt;buffer_removal_time_length, &quot;buffer_removal_time&quot;, opNum);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (frame_state-&gt;frame_type == AV1_SWITCH_FRAME || (frame_state-&gt;frame_type == AV1_KEY_FRAME &amp;&amp; frame_state-&gt;show_frame)) {\n\t\tframe_state-&gt;refresh_frame_flags = AV1_ALL_FRAMES;\n\t}\n\telse {\n\t\tframe_state-&gt;refresh_frame_flags = gf_bs_read_int_log(bs, 8, &quot;refresh_frame_flags&quot;);\n\t}\n\tif (!FrameIsIntra || frame_state-&gt;refresh_frame_flags != AV1_ALL_FRAMES) {\n\t\tif (error_resilient_mode &amp;&amp; state-&gt;enable_order_hint) {\n\t\t\tu32 i = 0;\n\t\t\tfor (i = 0; i &lt; AV1_NUM_REF_FRAMES; i++) {\n\t\t\t\tu8 ref_order_hint = gf_bs_read_int_log_idx(bs, state-&gt;OrderHintBits, &quot;ref_order_hint&quot;, i);\n\t\t\t\tif (ref_order_hint != state-&gt;RefOrderHint[i]) {\n\t\t\t\t\tstate-&gt;RefValid[i] = 0;\n\t\t\t\t}\n\t\t\t\tstate-&gt;RefOrderHint[i] = ref_order_hint;\n\t\t\t}\n\t\t}\n\t}\n\n\tu8 allow_intrabc = 0;\n\tif (frame_state-&gt;frame_type == AV1_KEY_FRAME) {\n\t\tav1_frame_size(bs, state, frame_size_override_flag);\n\t\tav1_render_size(bs);\n\t\tif (allow_screen_content_tools &amp;&amp; state-&gt;UpscaledWidth == state-&gt;width) {\n\t\t\tallow_intrabc = gf_bs_read_int_log(bs, 1, &quot;allow_intrabc&quot;);\n\t\t}\n\t}\n\telse {\n\t\tif (frame_state-&gt;frame_type == AV1_INTRA_ONLY_FRAME) {\n\t\t\tav1_frame_size(bs, state, frame_size_override_flag);\n\t\t\tav1_render_size(bs);\n\t\t\tif (allow_screen_content_tools &amp;&amp; state-&gt;UpscaledWidth == state-&gt;width) {\n\t\t\t\tallow_intrabc = gf_bs_read_int_log(bs, 1, &quot;allow_intrabc&quot;);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tu32 i = 0;\n\t\t\tBool frame_refs_short_signaling = GF_FALSE;\n\t\t\tif (state-&gt;enable_order_hint) {\n\t\t\t\tframe_refs_short_signaling = gf_bs_read_int_log(bs, 1, &quot;frame_refs_short_signaling&quot;);\n\t\t\t\tif (frame_refs_short_signaling) {\n\t\t\t\t\tu8 last_frame_idx = gf_bs_read_int_log(bs, 3, &quot;last_frame_idx&quot;);\n\t\t\t\t\tu8 gold_frame_idx = gf_bs_read_int_log(bs, 3, &quot;gold_frame_idx&quot;);\n\t\t\t\t\tav1_set_frame_refs(state, last_frame_idx, gold_frame_idx, ref_frame_idx);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\t\t\tif (!frame_refs_short_signaling)\n\t\t\t\t\tref_frame_idx[i] = gf_bs_read_int_log_idx(bs, 3, &quot;ref_frame_idx&quot;, i);\n\n\t\t\t\tif (state-&gt;frame_id_numbers_present_flag) {\n\t\t\t\t\tu32 n = state-&gt;delta_frame_id_length_minus_2 + 2;\n\t\t\t\t\t/*delta_frame_id_minus_1 =*/ gf_bs_read_int_log_idx(bs, n, &quot;delta_frame_id_minus1&quot;, i);\n\t\t\t\t\t//DeltaFrameId = delta_frame_id_minus_1 + 1;\n\t\t\t\t\t//expectedFrameId[i] = ((current_frame_id + (1 &lt;&lt; idLen) - DeltaFrameId) % (1 &lt;&lt; idLen));\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (frame_size_override_flag &amp;&amp; !error_resilient_mode) {\n\t\t\t\tframe_size_with_refs(bs, state, frame_size_override_flag, ref_frame_idx);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tav1_frame_size(bs, state, frame_size_override_flag);\n\t\t\t\tav1_render_size(bs);\n\t\t\t}\n\t\t\tframe_state-&gt;allow_high_precision_mv = 0;\n\t\t\tif (!force_integer_mv) {\n\t\t\t\tframe_state-&gt;allow_high_precision_mv = gf_bs_read_int_log(bs, 1, &quot;allow_high_precision_mv&quot;);\n\t\t\t}\n\n\t\t\tread_interpolation_filter(bs);\n\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;is_motion_mode_switchable&quot;);\n\t\t\tif (!(error_resilient_mode || !state-&gt;enable_ref_frame_mvs)) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;use_ref_frame_mvs&quot;);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!FrameIsIntra) {\n\t\tu32 i;\n\t\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\t\tu8 refFrame = AV1_LAST_FRAME + i;\n\t\t\tu8 ridx = ref_frame_idx[i];\n\t\t\tif (ridx &gt;= 0) {\n\t\t\t\tu8 hint = state-&gt;RefOrderHint[ridx];\n\t\t\t\tstate-&gt;OrderHints[refFrame] = hint;\n\t\t\t\t/*\t\t\tif ( !enable_order_hint ) {\n\t\t\t\t\t\t\t\tRefFrameSignBias[ refFrame ] = 0;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tRefFrameSignBias[ refFrame ] = get_relative_dist( hint, OrderHint) &gt; 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t*/\n\t\t\t}\n\n\t\t}\n\t}\n\n\tif (!(state-&gt;reduced_still_picture_header || disable_cdf_update))\n\t\tgf_bs_read_int_log(bs, 1, &quot;disable_frame_end_update_cdf&quot;);\n\n\tif (primary_ref_frame == AV1_PRIMARY_REF_NONE) {\n\t\t//init_non_coeff_cdfs();\n\t\tav1_setup_past_independence(state);\n\t}\n\telse {\n\t\t//load_cdfs(ref_frame_idx[primary_ref_frame]);\n\t\tav1_load_previous(state, primary_ref_frame, ref_frame_idx);\n\t}\n\n\tav1_parse_tile_info(bs, state);\n\t//quantization_params( ):\n\tu8 base_q_idx = gf_bs_read_int_log(bs, 8, &quot;base_q_idx&quot;);\n\ts32 DeltaQUDc = 0;\n\ts32 DeltaQUAc = 0;\n\ts32 DeltaQVDc = 0;\n\ts32 DeltaQVAc = 0;\n\ts32 DeltaQYDc = av1_delta_q(bs, &quot;DeltaQYDc_coded&quot;, &quot;DeltaQYDc&quot;);\n\tif (!state-&gt;config-&gt;monochrome) {\n\t\tu8 diff_uv_delta = 0;\n\t\tif (state-&gt;separate_uv_delta_q)\n\t\t\tdiff_uv_delta = gf_bs_read_int_log(bs, 1, &quot;diff_uv_delta&quot;);\n\n\t\tDeltaQUDc = av1_delta_q(bs, &quot;DeltaQUDc_coded&quot;, &quot;DeltaQUDc&quot;);\n\t\tDeltaQUAc = av1_delta_q(bs, &quot;DeltaQUAc_coded&quot;, &quot;DeltaQUAc&quot;);\n\t\tif (diff_uv_delta) {\n\t\t\tDeltaQVDc = av1_delta_q(bs, &quot;DeltaQVDc_coded&quot;, &quot;DeltaQVDc&quot;);\n\t\t\tDeltaQVAc = av1_delta_q(bs, &quot;DeltaQVAc_coded&quot;, &quot;DeltaQVAc&quot;);\n\t\t}\n\t}\n\tif (gf_bs_read_int_log(bs, 1, &quot;using_qmatrix&quot;)) {\n\t\tgf_bs_read_int_log(bs, 4, &quot;qm_y&quot;);\n\t\tgf_bs_read_int_log(bs, 4, &quot;qm_u&quot;);\n\t\tif (state-&gt;separate_uv_delta_q) {\n\t\t\tgf_bs_read_int_log(bs, 4, &quot;qm_v&quot;);\n\t\t}\n\t}\n\n\tu8 seg_features_SEG_LVL_ALT_Q_enabled[8] = { 0,0,0,0,0,0,0,0 };\n\ts32 seg_features_SEG_LVL_ALT_Q[8] = { 0,0,0,0,0,0,0,0 };\n\n\t//segmentation_params( ):\n\tu8 segmentation_enabled = gf_bs_read_int_log(bs, 1, &quot;segmentation_enabled&quot;);\n\tif (segmentation_enabled) {\n\t\t/*u8 segmentation_temporal_update = 0;*/\n\t\tu8 segmentation_update_data = 1;\n\t\tif (primary_ref_frame != AV1_PRIMARY_REF_NONE) {\n\t\t\tu8 segmentation_update_map = gf_bs_read_int_log(bs, 1, &quot;segmentation_update_map&quot;);\n\t\t\tif (segmentation_update_map == 1)\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;segmentation_temporal_update&quot;);\n\t\t\tsegmentation_update_data = gf_bs_read_int_log(bs, 1, &quot;segmentation_update_data&quot;);\n\t\t}\n\t\tif (segmentation_update_data == 1) {\n\t\t\tu32 i, j;\n\t\t\tfor (i = 0; i &lt; 8/*=MAX_SEGMENTS*/; i++) {\n\t\t\t\tfor (j = 0; j &lt; 8 /*=SEG_LVL_MAX*/; j++) {\n\t\t\t\t\tif (/*feature_enabled = */gf_bs_read_int_log_idx2(bs, 1, &quot;feature_enabled&quot;, i, j) == 1) {\n\t\t\t\t\t\ts32 val;\n\t\t\t\t\t\tu32 bitsToRead = Segmentation_Feature_Bits[j];\n\t\t\t\t\t\t//this is SEG_LVL_ALT_Q\n\t\t\t\t\t\tif (!j) seg_features_SEG_LVL_ALT_Q_enabled[i] = 1;\n\n\t\t\t\t\t\tif (Segmentation_Feature_Signed[j] == 1) {\n\t\t\t\t\t\t\tval = gf_bs_read_int_log_idx2(bs, 1 + bitsToRead, &quot;signed_feature_value&quot;, i, j);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tval = gf_bs_read_int_log_idx2(bs, bitsToRead, &quot;feature_value&quot;, i, j);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!j) seg_features_SEG_LVL_ALT_Q[i] = val;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t//ignore all init steps\n\t\t}\n\n\t}\n\n\t//delta_q_params():\n\t/*u8 delta_q_res = 0;*/\n\tu8 delta_q_present = 0;\n\tif (base_q_idx &gt; 0) {\n\t\tdelta_q_present = gf_bs_read_int_log(bs, 1, &quot;delta_q_present&quot;);\n\t}\n\tif (delta_q_present) {\n\t\tgf_bs_read_int_log(bs, 2, &quot;delta_q_res&quot;);\n\t}\n\n\t//delta_lf_params():\n\tu8 delta_lf_present = 0;\n\t/*u8 delta_lf_res = 0;\n\tu8 delta_lf_multi = 0;*/\n\tif (delta_q_present) {\n\t\tif (!allow_intrabc) {\n\t\t\tdelta_lf_present = gf_bs_read_int_log(bs, 1, &quot;delta_lf_present&quot;);\n\t\t}\n\t\tif (delta_lf_present) {\n\t\t\tgf_bs_read_int_log(bs, 2, &quot;delta_lf_res&quot;);\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;delta_lf_multi&quot;);\n\t\t}\n\t}\n\n\t//init lossless stuff!\n\tu8 CodedLossless = 1;\n\tfor (idx = 0; idx &lt; 8; idx++) {\n\t\tu8 qindex = av1_get_qindex(GF_TRUE, idx, base_q_idx, delta_q_present, 0/*CurrentQIndex always ignored at this level of parsin*/, segmentation_enabled, seg_features_SEG_LVL_ALT_Q_enabled, seg_features_SEG_LVL_ALT_Q);\n\t\tBool LosslessArray = (qindex == 0) &amp;&amp; (DeltaQYDc == 0) &amp;&amp; (DeltaQUAc == 0) &amp;&amp; (DeltaQUDc == 0) &amp;&amp; (DeltaQVAc == 0) &amp;&amp; (DeltaQVDc == 0);\n\t\tif (!LosslessArray)\n\t\t\tCodedLossless = 0;\n\t}\n\tBool AllLossless = CodedLossless &amp;&amp; (state-&gt;width == state-&gt;UpscaledWidth);\n\n\t//loop_filter_params():\n\tif (!CodedLossless &amp;&amp; !allow_intrabc) {\n\t\tu8 loop_filter_level_0 = gf_bs_read_int_log(bs, 6, &quot;loop_filter_level_0&quot;);\n\t\tu8 loop_filter_level_1 = gf_bs_read_int_log(bs, 6, &quot;loop_filter_level_1&quot;);\n\t\tif (!state-&gt;config-&gt;monochrome) {\n\t\t\tif (loop_filter_level_0 || loop_filter_level_1) {\n\t\t\t\tgf_bs_read_int_log(bs, 6, &quot;loop_filter_level_2&quot;);\n\t\t\t\tgf_bs_read_int_log(bs, 6, &quot;loop_filter_level_3&quot;);\n\t\t\t}\n\t\t}\n\t\tgf_bs_read_int_log(bs, 3, &quot;loop_filter_sharpness&quot;);\n\t\tu8 loop_filter_delta_enabled = gf_bs_read_int_log(bs, 1, &quot;loop_filter_delta_enabled&quot;);\n\t\tif (loop_filter_delta_enabled == 1) {\n\t\t\tu8 loop_filter_delta_update = gf_bs_read_int_log(bs, 1, &quot;loop_filter_delta_update&quot;);\n\t\t\tif (loop_filter_delta_update) {\n\t\t\t\tu32 i;\n\t\t\t\tfor (i = 0; i &lt; 8/*TOTAL_REFS_PER_FRAME*/; i++) {\n\t\t\t\t\tu8 update_ref_delta = gf_bs_read_int_log_idx(bs, 1, &quot;update_ref_delta&quot;, i);\n\t\t\t\t\tif (update_ref_delta == 1) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 1 + 6, &quot;loop_filter_ref_deltas&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (i = 0; i &lt; 2; i++) {\n\t\t\t\t\tu8 update_mode_delta = gf_bs_read_int_log_idx(bs, 1, &quot;update_mode_delta&quot;, i);\n\t\t\t\t\tif (update_mode_delta) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 1 + 6, &quot;loop_filter_mode_deltas&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t//cdef_params( ):\n\tif (!CodedLossless &amp;&amp; !allow_intrabc &amp;&amp; state-&gt;enable_cdef) {\n\t\tgf_bs_read_int_log(bs, 2, &quot;cdef_damping_minus_3&quot;);\n\t\tu8 cdef_bits = gf_bs_read_int_log(bs, 2, &quot;cdef_bits&quot;);\n\t\tu32 i, num_cd = 1 &lt;&lt; cdef_bits;\n\t\tfor (i = 0; i &lt; num_cd; i++) {\n\t\t\tgf_bs_read_int_log_idx(bs, 4, &quot;cdef_y_pri_strength&quot;, i);\n\t\t\tgf_bs_read_int_log_idx(bs, 2, &quot;cdef_y_sec_strength&quot;, i);\n\t\t\tif (!state-&gt;config-&gt;monochrome) {\n\t\t\t\tgf_bs_read_int_log_idx(bs, 4, &quot;cdef_uv_pri_strength&quot;, i);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 2, &quot;cdef_uv_sec_strength&quot;, i);\n\t\t\t}\n\t\t}\n\t}\n\n\t//lr_params( ) :\n\tif (!AllLossless &amp;&amp; !allow_intrabc &amp;&amp; state-&gt;enable_restoration) {\n\t\tu32 i, nb_planes = state-&gt;config-&gt;monochrome ? 1 : 3;\n\t\tu8 UsesLr = 0;\n\t\tu8 usesChromaLr = 0;\n\t\tfor (i = 0; i &lt; nb_planes; i++) {\n\t\t\tu8 lr_type = gf_bs_read_int_log_idx(bs, 2, &quot;lr_type&quot;, i);\n\t\t\t//FrameRestorationType[i] = Remap_Lr_Type[lr_type]\n\t\t\tif (lr_type != AV1_RESTORE_NONE) {\n\t\t\t\tUsesLr = 1;\n\t\t\t\tif (i &gt; 0) {\n\t\t\t\t\tusesChromaLr = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (UsesLr) {\n\t\t\tif (state-&gt;use_128x128_superblock) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;lr_unit_shift_minus_1&quot;);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tu8 lr_unit_shift = gf_bs_read_int_log(bs, 1, &quot;lr_unit_shift&quot;);\n\t\t\t\tif (lr_unit_shift) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;lr_unit_extra_shift&quot;);\n\t\t\t\t\t//lr_unit_shift += lr_unit_extra_shift;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (state-&gt;config-&gt;chroma_subsampling_x &amp;&amp; state-&gt;config-&gt;chroma_subsampling_y &amp;&amp; usesChromaLr) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;lr_uv_shift&quot;);\n\t\t\t}\n\t\t}\n\t}\n\t//read_tx_mode():\n\tif (CodedLossless == 1) {\n\t}\n\telse {\n\t\tgf_bs_read_int_log(bs, 1, &quot;tx_mode_select&quot;);\n\t}\n\n\t//frame_reference_mode( ):\n\tu8 reference_select = 0;\n\tif (FrameIsIntra) {\n\t}\n\telse {\n\t\treference_select = gf_bs_read_int_log(bs, 1, &quot;reference_select&quot;);\n\t}\n\n\t//skip_mode_params( ):\n\tu8 skipModeAllowed = 0;\n\tif (FrameIsIntra || !reference_select || !state-&gt;enable_order_hint) {\n\t}\n\telse {\n\t\tu32 i;\n\t\ts32 forwardIdx = -1;\n\t\ts32 backwardIdx = -1;\n\t\ts32 forwardHint = 0;\n\t\ts32 backwardHint = 0;\n\t\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\t\tu8 refHint = state-&gt;RefOrderHint[ref_frame_idx[i]];\n\t\t\tif (av1_get_relative_dist(refHint, frame_state-&gt;order_hint, state) &lt; 0) {\n\t\t\t\tif (forwardIdx &lt; 0 || av1_get_relative_dist(refHint, forwardHint, state) &gt; 0) {\n\t\t\t\t\tforwardIdx = i;\n\t\t\t\t\tforwardHint = refHint;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (av1_get_relative_dist(refHint, frame_state-&gt;order_hint, state) &gt; 0) {\n\t\t\t\tif (backwardIdx &lt; 0 || av1_get_relative_dist(refHint, backwardHint, state) &lt; 0) {\n\t\t\t\t\tbackwardIdx = i;\n\t\t\t\t\tbackwardHint = refHint;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (forwardIdx &lt; 0) {\n\t\t\tskipModeAllowed = 0;\n\t\t}\n\t\telse if (backwardIdx &gt;= 0) {\n\t\t\tskipModeAllowed = 1;\n\t\t\t//SkipModeFrame[0] = AV1_LAST_FRAME + MIN(forwardIdx, backwardIdx);\n\t\t\t//SkipModeFrame[1] = AV1_LAST_FRAME + MAX(forwardIdx, backwardIdx);\n\t\t}\n\t\telse {\n\t\t\ts32 secondForwardIdx = -1;\n\t\t\ts32 secondForwardHint = 0;\n\t\t\tfor (i = 0; i &lt; AV1_REFS_PER_FRAME; i++) {\n\t\t\t\tu8 refHint = state-&gt;RefOrderHint[ref_frame_idx[i]];\n\t\t\t\tif (av1_get_relative_dist(refHint, forwardHint, state) &lt; 0) {\n\t\t\t\t\tif (secondForwardIdx &lt; 0 || av1_get_relative_dist(refHint, secondForwardHint, state) &gt; 0) {\n\t\t\t\t\t\tsecondForwardIdx = i;\n\t\t\t\t\t\tsecondForwardHint = refHint;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (secondForwardIdx &lt; 0) {\n\t\t\t\tskipModeAllowed = 0;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tskipModeAllowed = 1;\n\t\t\t\t//SkipModeFrame[ 0 ] = LAST_FRAME + Min(forwardIdx, secondForwardIdx)\n\t\t\t\t//SkipModeFrame[ 1 ] = LAST_FRAME + Max(forwardIdx, secondForwardIdx)\n\t\t\t}\n\t\t}\n\t}\n\tif (skipModeAllowed) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;skip_mode_present&quot;);\n\t}\n\n\n\tif (FrameIsIntra || error_resilient_mode || !state-&gt;enable_warped_motion) {\n\n\t}\n\telse {\n\t\tgf_bs_read_int_log(bs, 1, &quot;allow_warped_motion&quot;);\n\t}\n\n\tgf_bs_read_int_log(bs, 1, &quot;reduced_tx&quot;);\n\n\t//global_motion_params( )\n\tu32 ref;\n\tfor (ref = AV1_LAST_FRAME; ref &lt;= AV1_ALTREF_FRAME; ref++) {\n\t\tu32 i;\n\t\tfor (i = 0; i &lt; 6; i++) {\n\t\t\tstate-&gt;GmParams.coefs[ref][i] = ((i % 3 == 2) ? 1 &lt;&lt; WARPEDMODEL_PREC_BITS : 0);\n\t\t}\n\t}\n\tif (!FrameIsIntra) {\n\t\tu32 refs;\n\t\tfor (refs = AV1_LAST_FRAME; refs &lt;= AV1_ALTREF_FRAME; refs++) {\n\t\t\tu8 type = AV1_GMC_IDENTITY;\n\t\t\tBool is_global = gf_bs_read_int_log_idx(bs, 1, &quot;is_global&quot;, refs);\n\t\t\tif (is_global) {\n\t\t\t\tBool is_rot_zoom = gf_bs_read_int_log_idx(bs, 1, &quot;is_rot_zoom&quot;, refs);\n\t\t\t\tif (is_rot_zoom) {\n\t\t\t\t\ttype = AV1_GMC_ROTZOOM;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tBool is_trans = gf_bs_read_int_log_idx(bs, 1, &quot;is_translation&quot;, refs);\n\t\t\t\t\ttype = is_trans ? AV1_GMC_TRANSLATION : AV1_GMC_AFFINE;\n\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (type &gt;= AV1_GMC_ROTZOOM) {\n\t\t\t\tav1_read_global_param(state, bs, type, refs, 2);\n\t\t\t\tav1_read_global_param(state, bs, type, refs, 3);\n\t\t\t\tif (type == AV1_GMC_AFFINE) {\n\t\t\t\t\tav1_read_global_param(state, bs, type, refs, 4);\n\t\t\t\t\tav1_read_global_param(state, bs, type, refs, 5);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tstate-&gt;GmParams.coefs[refs][4] = -state-&gt;GmParams.coefs[refs][3];\n\t\t\t\t\tstate-&gt;GmParams.coefs[refs][5] = state-&gt;GmParams.coefs[refs][2];\n\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (type &gt;= AV1_GMC_TRANSLATION) {\n\t\t\t\tav1_read_global_param(state, bs, type, refs, 0);\n\t\t\t\tav1_read_global_param(state, bs, type, refs, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\t//film_grain_params()\n\tif (!state-&gt;film_grain_params_present || (!state-&gt;frame_state.show_frame &amp;&amp; !showable_frame)) {\n\t}\n\telse {\n\t\tu8 apply_grain = gf_bs_read_int_log(bs, 1, &quot;apply_grain&quot;);\n\t\tif (apply_grain) {\n\t\t\tgf_bs_read_int_log(bs, 16, &quot;grain_seed&quot;);\n\t\t\tu8 update_grain = 1;\n\t\t\tif (state-&gt;frame_state.frame_type == AV1_INTER_FRAME) {\n\t\t\t\tupdate_grain = gf_bs_read_int_log(bs, 1, &quot;update_grain&quot;);\n\t\t\t}\n\t\t\tif (!update_grain) {\n\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;film_grain_params_ref_idx&quot;);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tu32 i, num_y_points = gf_bs_read_int_log(bs, 4, &quot;num_y_points&quot;);\n\t\t\t\tfor (i = 0; i &lt; num_y_points; i++) {\n\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;point_y_value&quot;, i);\n\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;point_y_scaling&quot;, i);\n\t\t\t\t}\n\t\t\t\tu8 chroma_scaling_from_luma = 0;\n\t\t\t\tif (!state-&gt;config-&gt;monochrome)\n\t\t\t\t\tchroma_scaling_from_luma = gf_bs_read_int_log(bs, 1, &quot;chroma_scaling_from_luma&quot;);\n\n\t\t\t\tu8 num_cb_points = 0;\n\t\t\t\tu8 num_cr_points = 0;\n\t\t\t\tif (state-&gt;config-&gt;monochrome || chroma_scaling_from_luma ||\n\t\t\t\t\t((state-&gt;config-&gt;chroma_subsampling_x == 1) &amp;&amp; (state-&gt;config-&gt;chroma_subsampling_y == 1) &amp;&amp; (num_y_points == 0))\n\t\t\t\t\t) {\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tnum_cb_points = gf_bs_read_int_log(bs, 4, &quot;num_cb_points&quot;);\n\t\t\t\t\tfor (i = 0; i &lt; num_cb_points; i++) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;point_cb_value&quot;, i);\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;point_cb_scaling&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t\tnum_cr_points = gf_bs_read_int_log(bs, 4, &quot;num_cr_points&quot;);\n\t\t\t\t\tfor (i = 0; i &lt; num_cr_points; i++) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;point_cr_value&quot;, i);\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;point_cr_scaling&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tgf_bs_read_int_log(bs, 2, &quot;grain_scaling_minus_8&quot;);\n\t\t\t\tu8 ar_coeff_lag = gf_bs_read_int_log(bs, 2, &quot;ar_coeff_lag&quot;);\n\t\t\t\tu16 numPosLuma = 2 * ar_coeff_lag * (ar_coeff_lag + 1);\n\t\t\t\tu16 numPosChroma = numPosLuma;\n\t\t\t\tif (num_y_points) {\n\t\t\t\t\tnumPosChroma = numPosLuma + 1;\n\t\t\t\t\tfor (i = 0; i &lt; numPosLuma; i++) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;ar_coeffs_y_plus_128&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (chroma_scaling_from_luma || num_cb_points) {\n\t\t\t\t\tfor (i = 0; i &lt; numPosChroma; i++) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;ar_coeffs_cb_plus_128&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (chroma_scaling_from_luma || num_cr_points) {\n\t\t\t\t\tfor (i = 0; i &lt; numPosChroma; i++) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;ar_coeffs_cr_plus_128&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tgf_bs_read_int_log(bs, 2, &quot;ar_coeff_shift_minus_6&quot;);\n\t\t\t\tgf_bs_read_int_log(bs, 2, &quot;grain_scale_shift&quot;);\n\t\t\t\tif (num_cb_points) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 8, &quot;cb_mult&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 8, &quot;cb_luma_mult&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 9, &quot;cb_offset&quot;);\n\t\t\t\t}\n\t\t\t\tif (num_cr_points) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 8, &quot;cr_mult&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 8, &quot;cr_luma_mult&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 9, &quot;cr_offset&quot;);\n\t\t\t\t}\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;overlap_flag&quot;);\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;clip_to_restricted_range&quot;);\n\t\t\t}\n\t\t}\n\t}\n\n\t//end of uncompressed header !!\n}\n\nGF_EXPORT\nvoid gf_av1_init_state(AV1State *state)\n{\n\tif (!state) return;\n\tmemset(state, 0, sizeof(AV1State));\n\tstate-&gt;color_primaries = 2;\n\tstate-&gt;transfer_characteristics = 2;\n\tstate-&gt;matrix_coefficients = 2;\n}\n\nGF_EXPORT\nvoid gf_av1_reset_state(AV1State *state, Bool is_destroy)\n{\n\tGF_List *l1, *l2;\n\n\tif (state-&gt;frame_state.header_obus) {\n\t\twhile (gf_list_count(state-&gt;frame_state.header_obus)) {\n\t\t\tGF_AV1_OBUArrayEntry *a = (GF_AV1_OBUArrayEntry*)gf_list_pop_back(state-&gt;frame_state.header_obus);\n\t\t\tif (a-&gt;obu) gf_free(a-&gt;obu);\n\t\t\tgf_free(a);\n\t\t}\n\t}\n\n\tif (state-&gt;frame_state.frame_obus) {\n\t\twhile (gf_list_count(state-&gt;frame_state.frame_obus)) {\n\t\t\tGF_AV1_OBUArrayEntry *a = (GF_AV1_OBUArrayEntry*)gf_list_pop_back(state-&gt;frame_state.frame_obus);\n\t\t\tif (a-&gt;obu) gf_free(a-&gt;obu);\n\t\t\tgf_free(a);\n\t\t}\n\t}\n\tl1 = state-&gt;frame_state.frame_obus;\n\tl2 = state-&gt;frame_state.header_obus;\n\tmemset(&amp;state-&gt;frame_state, 0, sizeof(AV1StateFrame));\n\tstate-&gt;frame_state.is_first_frame = GF_TRUE;\n\n\tif (is_destroy) {\n\t\tgf_list_del(l1);\n\t\tgf_list_del(l2);\n\t\tif (state-&gt;bs) {\n\t\t\tu32 size, asize=0;\n\t\t\tu8 *ptr=NULL;\n\t\t\t//detach BS internal buffer\n\t\t\tgf_bs_get_content_no_truncate(state-&gt;bs, &amp;ptr, &amp;size, &amp;asize);\n\t\t\t//avoid double free, cf issue 1893\n\t\t\tif (ptr != state-&gt;frame_obus) {\n\t\t\t\tgf_free(ptr);\n\t\t\t}\n\t\t\tif (state-&gt;frame_obus) {\n\t\t\t\tgf_free(state-&gt;frame_obus);\n\t\t\t\tstate-&gt;frame_obus = NULL;\n\t\t\t\tstate-&gt;frame_obus_alloc = 0;\n\t\t\t}\n\t\t\tgf_bs_del(state-&gt;bs);\n\t\t}\n\t\tstate-&gt;bs = NULL;\n\t}\n\telse {\n\t\tstate-&gt;frame_state.frame_obus = l1;\n\t\tstate-&gt;frame_state.header_obus = l2;\n\t\tif (state-&gt;bs)\n\t\t\tgf_bs_seek(state-&gt;bs, 0);\n\t}\n}\n\nstatic GF_Err av1_parse_tile_group(GF_BitStream *bs, AV1State *state, u64 obu_start, u64 obu_size)\n{\n\tu32 TileNum, tg_start = 0, tg_end = 0;\n\tu32 numTiles = state-&gt;tileCols * state-&gt;tileRows;\n\tBool tile_start_and_end_present_flag = GF_FALSE;\n\tGF_Err e = GF_OK;\n\tif (numTiles &gt; 1)\n\t\ttile_start_and_end_present_flag = gf_bs_read_int_log(bs, 1, &quot;tile_start_and_end_present_flag&quot;);\n\n\tif (numTiles == 1 || !tile_start_and_end_present_flag) {\n\t\ttg_start = 0;\n\t\ttg_end = numTiles - 1;\n\t\t/*state-&gt;frame_state.tg[0].start_idx = 0;\n\t\tstate-&gt;frame_state.tg[0].end_idx = numTiles - 1;*/\n\t}\n\telse {\n\t\tu32 tileBits = state-&gt;tileColsLog2 + state-&gt;tileRowsLog2;\n\t\t/*state-&gt;frame_state.tg[state-&gt;frame_state.tg_idx].start_idx*/ tg_start = gf_bs_read_int_log(bs, tileBits, &quot;tg_start&quot;);\n\t\t/*state-&gt;frame_state.tg[state-&gt;frame_state.tg_idx].end_idx*/ tg_end = gf_bs_read_int_log(bs, tileBits, &quot;tg_end&quot;);\n\t}\n\t/*state-&gt;frame_state.tg_idx++;*/\n\n\tgf_bs_align(bs);\n\n\tif (tg_end &gt;= GF_ARRAY_LENGTH(state-&gt;frame_state.tiles))\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\n\tstate-&gt;frame_state.nb_tiles_in_obu = 0;\n\tfor (TileNum = tg_start; TileNum &lt;= tg_end; TileNum++) {\n\t\tu32 tile_start_offset, tile_size;\n\t\t/*u32 tileRow = TileNum / state-&gt;tileCols;\n\t\tu32 tileCol = TileNum % state-&gt;tileCols;*/\n\t\tBool lastTile = TileNum == tg_end;\n\t\tu64 pos = gf_bs_get_position(bs);\n\t\tif (lastTile) {\n\t\t\ttile_start_offset = (u32)(pos - obu_start);\n\t\t\ttile_size = (u32)(obu_size - (pos - obu_start));\n\t\t}\n\t\telse {\n\t\t\tu64 tile_size_minus_1 = aom_av1_le(bs, state-&gt;tile_size_bytes, &quot;tile_size_minus_1&quot;);\n\t\t\tpos = gf_bs_get_position(bs);\n\t\t\ttile_start_offset = (u32)(pos - obu_start);\n\t\t\ttile_size = (u32)(tile_size_minus_1 + 1/* + state-&gt;tile_size_bytes*/);\n\t\t}\n\n\n\t\tif (tile_start_offset + tile_size &gt; obu_size) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AV1] Error parsing tile group, tile %d start %d + size %d exceeds OBU length %d\\n&quot;, TileNum, tile_start_offset, tile_size, obu_size));\n\t\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\t\tbreak;\n\t\t}\n\n\t\tstate-&gt;frame_state.tiles[state-&gt;frame_state.nb_tiles_in_obu].obu_start_offset = tile_start_offset;\n\t\tstate-&gt;frame_state.tiles[state-&gt;frame_state.nb_tiles_in_obu].size = tile_size;\n\t\tgf_bs_skip_bytes(bs, tile_size);\n\t\tstate-&gt;frame_state.nb_tiles_in_obu++;\n\t}\n\tif (tg_end == numTiles - 1) {\n\t\tav1_decode_frame_wrapup(state);\n\t}\n\treturn e;\n}\n\nstatic void av1_parse_frame_header(GF_BitStream *bs, AV1State *state)\n{\n\tAV1StateFrame *frame_state = &amp;state-&gt;frame_state;\n\tif (frame_state-&gt;seen_frame_header == GF_FALSE) {\n\t\tu64 pos = gf_bs_get_position(bs);\n\t\tstate-&gt;frame_state.show_existing_frame = GF_FALSE;\n\t\tframe_state-&gt;seen_frame_header = GF_TRUE;\n\t\tav1_parse_uncompressed_header(bs, state);\n\t\tstate-&gt;frame_state.is_first_frame = GF_FALSE;\n\t\tstate-&gt;frame_state.uncompressed_header_bytes = (u32) (gf_bs_get_position(bs) - pos);\n\n\t\tif (state-&gt;frame_state.show_existing_frame) {\n\t\t\tav1_decode_frame_wrapup(state);\n\t\t\tframe_state-&gt;seen_frame_header = GF_FALSE;\n\t\t}\n\t\telse {\n\t\t\t//TileNum = 0;\n\t\t\tframe_state-&gt;seen_frame_header = GF_TRUE;\n\t\t}\n\t}\n}\n\nstatic GF_Err av1_parse_frame(GF_BitStream *bs, AV1State *state, u64 obu_start, u64 obu_size)\n{\n\tav1_parse_frame_header(bs, state);\n\t//byte alignment\n    {\n        u32 nbBits = gf_bs_align(bs);\n        gf_bs_log_idx(bs, nbBits, &quot;alignment&quot;, 0, -1, -1, -1);\n    }\n\treturn av1_parse_tile_group(bs, state, obu_start, obu_size);\n}\n\nstatic void av1_parse_obu_metadata(AV1State *state, GF_BitStream *bs)\n{\n\tu32 metadata_type = (u32)gf_av1_leb128_read(bs, NULL);\n\n\tswitch (metadata_type) {\n\tcase OBU_METADATA_TYPE_ITUT_T35:\n\t\tbreak;\n\tcase OBU_METADATA_TYPE_HDR_CLL:\n\t\tgf_bs_read_data(bs, state-&gt;clli_data, 4);\n\t\tstate-&gt;clli_valid = 1;\n\t\tbreak;\n\tcase OBU_METADATA_TYPE_HDR_MDCV:\n\t\tgf_bs_read_data(bs, state-&gt;mdcv_data, 24);\n\t\tstate-&gt;mdcv_valid = 1;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nGF_EXPORT\nGF_Err gf_av1_parse_obu(GF_BitStream *bs, ObuType *obu_type, u64 *obu_size, u32 *obu_hdr_size, AV1State *state)\n{\n\tGF_Err e = GF_OK;\n\tu32 i, hdr_size;\n\tu64 pos = gf_bs_get_position(bs);\n\n\tif (!bs || !obu_type || !state)\n\t\treturn GF_BAD_PARAM;\n\n\tgf_bs_mark_overflow(bs, GF_TRUE);\n\n\tstate-&gt;obu_extension_flag = state-&gt;obu_has_size_field = 0;\n\tstate-&gt;temporal_id = state-&gt;spatial_id = 0;\n\tstate-&gt;frame_state.uncompressed_header_bytes = 0;\n\te = gf_av1_parse_obu_header(bs, obu_type, &amp;state-&gt;obu_extension_flag, &amp;state-&gt;obu_has_size_field, &amp;state-&gt;temporal_id, &amp;state-&gt;spatial_id);\n\tif (gf_bs_is_overflow(bs)) e = GF_NON_COMPLIANT_BITSTREAM;\n\tif (e)\n\t\treturn e;\n\n\t//at this point obu_size is either zero or the size of the containing buffer (likely the Temporal Unit)\n\tif (state-&gt;obu_has_size_field) {\n\t\t*obu_size = (u32)gf_av1_leb128_read(bs, NULL);\n\t}\n\telse {\n\t\tif (*obu_size &gt;= 1 + state-&gt;obu_extension_flag) {\n\t\t\t*obu_size = *obu_size - 1 - state-&gt;obu_extension_flag;\n\t\t}\n\t\telse {\n\t\t\tGF_LOG(state-&gt;config ? GF_LOG_WARNING : GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[AV1] computed OBU size &quot;LLD&quot; (input value = &quot;LLU&quot;). Skipping.\\n&quot;, *obu_size - 1 - state-&gt;obu_extension_flag, *obu_size));\n\t\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\t}\n\thdr_size = (u32)(gf_bs_get_position(bs) - pos);\n\tif (gf_bs_is_overflow(bs) || (gf_bs_available(bs) &lt; *obu_size) ) {\n\t\tgf_bs_seek(bs, pos);\n\t\treturn GF_BUFFER_TOO_SMALL;\n\t}\n\t//gpac&#x27;s internal obu_size includes the header + the payload\n\t*obu_size += hdr_size;\n\tif (obu_hdr_size) *obu_hdr_size = hdr_size;\n\n\tif (*obu_type != OBU_SEQUENCE_HEADER &amp;&amp; *obu_type != OBU_TEMPORAL_DELIMITER &amp;&amp;\n\t\tstate-&gt;OperatingPointIdc != 0 &amp;&amp; state-&gt;obu_extension_flag == 1)\n\t{\n\t\tu32 inTemporalLayer = (state-&gt;OperatingPointIdc &gt;&gt; state-&gt;temporal_id) &amp; 1;\n\t\tu32 inSpatialLayer = (state-&gt;OperatingPointIdc &gt;&gt; (state-&gt;spatial_id + 8)) &amp; 1;\n\t\tif (!inTemporalLayer || !inSpatialLayer) {\n\t\t\t*obu_type = -1;\n\t\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\t\treturn GF_OK;\n\t\t}\n\t}\n\n\te = GF_OK;\n\n\t/* for AVIF a1lx */\n\tfor (i = state-&gt;spatial_id; i &lt; 4; i++) {\n\t\tstate-&gt;layer_size[i] = (u32) (pos + *obu_size);\n\t}\n\n\tswitch (*obu_type) {\n\tcase OBU_SEQUENCE_HEADER:\n\t\tav1_parse_sequence_header_obu(bs, state);\n\t\tif (gf_bs_is_overflow(bs) || (gf_bs_get_position(bs) &gt; pos + *obu_size)) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] Sequence header parsing consumed too many bytes !\\n&quot;));\n\t\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tbreak;\n\n\tcase OBU_METADATA:\n\t\tav1_parse_obu_metadata(state, bs);\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tif (gf_bs_is_overflow(bs)) e = GF_NON_COMPLIANT_BITSTREAM;\n\t\tbreak;\n\n\tcase OBU_FRAME_HEADER:\n\tcase OBU_REDUNDANT_FRAME_HEADER:\n\t\tif (state-&gt;config) {\n\t\t\tav1_parse_frame_header(bs, state);\n\t\t\tif (gf_bs_is_overflow(bs) || (gf_bs_get_position(bs) &gt; pos + *obu_size)) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] Frame header parsing consumed too many bytes !\\n&quot;));\n\t\t\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t}\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tbreak;\n\tcase OBU_FRAME:\n\t\te = av1_parse_frame(bs, state, pos, *obu_size);\n\t\tif (gf_bs_is_overflow(bs) || (gf_bs_get_position(bs) != pos + *obu_size)) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] Frame parsing did not consume the right number of bytes !\\n&quot;));\n\t\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\t}\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tbreak;\n\tcase OBU_TILE_GROUP:\n\t\tif (state-&gt;config) {\n\t\t\te = av1_parse_tile_group(bs, state, pos, *obu_size);\n\t\t\tif (gf_bs_is_overflow(bs) || (gf_bs_get_position(bs) != pos + *obu_size)) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] Tile group parsing did not consume the right number of bytes !\\n&quot;));\n\t\t\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\t\t}\n\t\t}\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tbreak;\n\tcase OBU_TEMPORAL_DELIMITER:\n\t\tstate-&gt;frame_state.seen_frame_header = GF_FALSE;\n\t\tstate-&gt;clli_valid = state-&gt;mdcv_valid = 0;\n\tcase OBU_PADDING:\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[AV1] unknown OBU type %u (size &quot;LLU&quot;). Skipping.\\n&quot;, *obu_type, *obu_size));\n\t\tgf_bs_seek(bs, pos + *obu_size);\n\t\tbreak;\n\t}\n\treturn e;\n}\n\n\nGF_EXPORT\nGF_Err gf_media_prores_parse_bs(GF_BitStream *bs, GF_ProResFrameInfo *prores_frame)\n{\n\tu32 i, j;\n\tu64 start, pos;\n\tmemset(prores_frame, 0, sizeof(GF_ProResFrameInfo));\n\n\tstart = gf_bs_get_position(bs);\n\tif (gf_bs_available(bs) &lt; 10)\n\t\treturn GF_BUFFER_TOO_SMALL;\n\n\tprores_frame-&gt;frame_size = gf_bs_read_u32(bs);\n\tprores_frame-&gt;frame_identifier = gf_bs_read_u32(bs);\n\tif (prores_frame-&gt;frame_identifier != GF_4CC(&#x27;i&#x27;,&#x27;c&#x27;,&#x27;p&#x27;,&#x27;f&#x27;)) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[ProRes] Invalid frame identifier, expected \\&quot;icpf\\&quot; got \\&quot;%s\\&quot;\\n&quot;, gf_4cc_to_str(prores_frame-&gt;frame_identifier) ));\n\t\tgf_bs_seek(bs, start);\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\t/*parse frame header*/\n\tpos = gf_bs_get_position(bs);\n\tprores_frame-&gt;frame_hdr_size = gf_bs_read_u16(bs);\n\tif (gf_bs_available(bs) + 2 &lt; prores_frame-&gt;frame_hdr_size) {\n\t\tgf_bs_seek(bs, start);\n\t\treturn GF_BUFFER_TOO_SMALL;\n\t}\n\tgf_bs_read_u8(bs);\n\tprores_frame-&gt;version = gf_bs_read_u8(bs);\n\tprores_frame-&gt;encoder_id = gf_bs_read_u32(bs);\n\tprores_frame-&gt;width = gf_bs_read_u16(bs);\n\tprores_frame-&gt;height = gf_bs_read_u16(bs);\n\tprores_frame-&gt;chroma_format = gf_bs_read_int(bs, 2);\n\tgf_bs_read_int(bs, 2);\n\tprores_frame-&gt;interlaced_mode = gf_bs_read_int(bs, 2);\n\tgf_bs_read_int(bs, 2);\n\tprores_frame-&gt;aspect_ratio_information = gf_bs_read_int(bs, 4);\n\tprores_frame-&gt;framerate_code = gf_bs_read_int(bs, 4);\n\tprores_frame-&gt;color_primaries = gf_bs_read_u8(bs);\n\tprores_frame-&gt;transfer_characteristics = gf_bs_read_u8(bs);\n\tprores_frame-&gt;matrix_coefficients = gf_bs_read_u8(bs);\n\tgf_bs_read_int(bs, 4);\n\tprores_frame-&gt;alpha_channel_type = gf_bs_read_int(bs, 4);\n\tgf_bs_read_int(bs, 14);\n\tprores_frame-&gt;load_luma_quant_matrix = gf_bs_read_int(bs, 1);\n\tprores_frame-&gt;load_chroma_quant_matrix = gf_bs_read_int(bs, 1);\n\tif (prores_frame-&gt;load_luma_quant_matrix) {\n\t\tfor (i=0; i&lt;8; i++) {\n\t\t\tfor (j=0; j&lt;8; j++) {\n\t\t\t\tprores_frame-&gt;luma_quant_matrix[i][j] = gf_bs_read_u8(bs);\n\t\t\t}\n\t\t}\n\t}\n\tif (prores_frame-&gt;load_chroma_quant_matrix) {\n\t\tfor (i=0; i&lt;8; i++) {\n\t\t\tfor (j=0; j&lt;8; j++) {\n\t\t\t\tprores_frame-&gt;chroma_quant_matrix[i][j] = gf_bs_read_u8(bs);\n\t\t\t}\n\t\t}\n\t}\n\tpos = gf_bs_get_position(bs) - pos;\n\tif (pos != prores_frame-&gt;frame_hdr_size) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[ProRes] Invalid frame header size, expected %d got %d\\n&quot;, prores_frame-&gt;frame_hdr_size, (u32) pos));\n\t\tgf_bs_seek(bs, start);\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\tprores_frame-&gt;nb_pic = ((prores_frame-&gt;interlaced_mode==1) || (prores_frame-&gt;interlaced_mode==2)) ? 2 : 1;\n\tgf_bs_seek(bs, start);\n\n\treturn GF_OK;\n}\n\n#endif /*GPAC_DISABLE_AV_PARSERS*/\n\nGF_EXPORT\nu8 gf_mp3_version(u32 hdr)\n{\n\treturn ((hdr &gt;&gt; 19) &amp; 0x3);\n}\n\nGF_EXPORT\nconst char *gf_mp3_version_name(u32 hdr)\n{\n\tu32 v = gf_mp3_version(hdr);\n\tswitch (v) {\n\tcase 0:\n\t\treturn &quot;MPEG-2.5&quot;;\n\tcase 1:\n\t\treturn &quot;Reserved&quot;;\n\tcase 2:\n\t\treturn &quot;MPEG-2&quot;;\n\tcase 3:\n\t\treturn &quot;MPEG-1&quot;;\n\tdefault:\n\t\treturn &quot;Unknown&quot;;\n\t}\n}\n\n#ifndef GPAC_DISABLE_AV_PARSERS\n\nGF_EXPORT\nu8 gf_mp3_layer(u32 hdr)\n{\n\treturn 4 - (((hdr &gt;&gt; 17) &amp; 0x3));\n}\n\nGF_EXPORT\nu8 gf_mp3_num_channels(u32 hdr)\n{\n\tif (((hdr &gt;&gt; 6) &amp; 0x3) == 3) return 1;\n\treturn 2;\n}\n\nGF_EXPORT\nu16 gf_mp3_sampling_rate(u32 hdr)\n{\n\tu16 res;\n\t/* extract the necessary fields from the MP3 header */\n\tu8 version = gf_mp3_version(hdr);\n\tu8 sampleRateIndex = (hdr &gt;&gt; 10) &amp; 0x3;\n\n\tswitch (sampleRateIndex) {\n\tcase 0:\n\t\tres = 44100;\n\t\tbreak;\n\tcase 1:\n\t\tres = 48000;\n\t\tbreak;\n\tcase 2:\n\t\tres = 32000;\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[MPEG-1/2 Audio] Samplerate index not valid\\n&quot;));\n\t\treturn 0;\n\t}\n\t/*reserved or MPEG-1*/\n\tif (version &amp; 1) return res;\n\n\t/*MPEG-2*/\n\tres /= 2;\n\t/*MPEG-2.5*/\n\tif (version == 0) res /= 2;\n\treturn res;\n}\n\nGF_EXPORT\nu16 gf_mp3_window_size(u32 hdr)\n{\n\tu8 version = gf_mp3_version(hdr);\n\tu8 layer = gf_mp3_layer(hdr);\n\n\tif (layer == 3) {\n\t\tif (version == 3) return 1152;\n\t\treturn 576;\n\t}\n\tif (layer == 2) return 1152;\n\treturn 384;\n}\n\nGF_EXPORT\nu8 gf_mp3_object_type_indication(u32 hdr)\n{\n\tswitch (gf_mp3_version(hdr)) {\n\tcase 3:\n\t\treturn GF_CODECID_MPEG_AUDIO;\n\tcase 2:\n\tcase 0:\n\t\treturn GF_CODECID_MPEG2_PART3;\n\tdefault:\n\t\treturn 0x00;\n\t}\n}\n\n/*aligned bitrate parsing with libMAD*/\n\nstatic\nu32 const bitrate_table[5][15] = {\n\t/* MPEG-1 */\n\t{\t0,  32000,  64000,  96000, 128000, 160000, 192000, 224000,  /* Layer I   */\n\t\t256000, 288000, 320000, 352000, 384000, 416000, 448000\n\t},\n\t{\t0,  32000,  48000,  56000,  64000,  80000,  96000, 112000,  /* Layer II  */\n\t\t128000, 160000, 192000, 224000, 256000, 320000, 384000\n\t},\n\t{\t0,  32000,  40000,  48000,  56000,  64000,  80000,  96000,  /* Layer III */\n\t\t112000, 128000, 160000, 192000, 224000, 256000, 320000\n\t},\n\n\t/* MPEG-2 LSF */\n\t{\t0,  32000,  48000,  56000,  64000,  80000,  96000, 112000,  /* Layer I   */\n\t\t128000, 144000, 160000, 176000, 192000, 224000, 256000\n\t},\n\t{\t0,   8000,  16000,  24000,  32000,  40000,  48000,  56000,  /* Layers    */\n\t\t64000,  80000,  96000, 112000, 128000, 144000, 160000\n\t} /* II &amp; III  */\n};\n\n\nu32 gf_mp3_bit_rate(u32 hdr)\n{\n\tu8 version = gf_mp3_version(hdr);\n\tu8 layer = gf_mp3_layer(hdr);\n\tu8 bitRateIndex = (hdr &gt;&gt; 12) &amp; 0xF;\n\tu32 lidx;\n\t/*MPEG-1*/\n\tif (version &amp; 1) {\n\t\tif (!layer) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[MPEG-1/2 Audio] layer index not valid\\n&quot;));\n\t\t\treturn 0;\n\t\t}\n\t\tlidx = layer - 1;\n\t}\n\t/*MPEG-2/2.5*/\n\telse {\n\t\tlidx = 3 + (layer &gt;&gt; 1);\n\t}\n\tif (lidx&gt;4) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[MPEG-1/2 Audio] layer index not valid\\n&quot;));\n\t\treturn 0;\n\t}\n\treturn bitrate_table[lidx][bitRateIndex];\n}\n\n\n\nGF_EXPORT\nu16 gf_mp3_frame_size(u32 hdr)\n{\n\tu8 version = gf_mp3_version(hdr);\n\tu8 layer = gf_mp3_layer(hdr);\n\tu32 pad = ((hdr &gt;&gt; 9) &amp; 0x1) ? 1 : 0;\n\tu32 bitrate = gf_mp3_bit_rate(hdr);\n\tu32 samplerate = gf_mp3_sampling_rate(hdr);\n\n\tu32 frameSize = 0;\n\tif (!samplerate || !bitrate) return 0;\n\n\tif (layer == 1) {\n\t\tframeSize = ((12 * bitrate / samplerate) + pad) * 4;\n\t}\n\telse {\n\t\tu32 slots_per_frame = 144;\n\t\tif ((layer == 3) &amp;&amp; !(version &amp; 1)) slots_per_frame = 72;\n\t\tframeSize = (slots_per_frame * bitrate / samplerate) + pad;\n\t}\n\treturn (u16)frameSize;\n}\n\n\nGF_EXPORT\nu32 gf_mp3_get_next_header(FILE* in)\n{\n\tu8 b, state = 0;\n\tu32 dropped = 0;\n\tunsigned char bytes[4];\n\tbytes[0] = bytes[1] = bytes[2] = bytes[3] = 0;\n\n\twhile (1) {\n\t\tif (gf_fread(&amp;b, 1, in) == 0) return 0;\n\n\t\tif (state == 3) {\n\t\t\tbytes[state] = b;\n\t\t\treturn GF_4CC((u32)bytes[0], bytes[1], bytes[2], bytes[3]);\n\t\t}\n\t\tif (state == 2) {\n\t\t\tif (((b &amp; 0xF0) == 0) || ((b &amp; 0xF0) == 0xF0) || ((b &amp; 0x0C) == 0x0C)) {\n\t\t\t\tif (bytes[1] == 0xFF) state = 1;\n\t\t\t\telse state = 0;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tbytes[state] = b;\n\t\t\t\tstate = 3;\n\t\t\t}\n\t\t}\n\t\tif (state == 1) {\n\t\t\tif (((b &amp; 0xE0) == 0xE0) &amp;&amp; ((b &amp; 0x18) != 0x08) &amp;&amp; ((b &amp; 0x06) != 0)) {\n\t\t\t\tbytes[state] = b;\n\t\t\t\tstate = 2;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstate = 0;\n\t\t\t}\n\t\t}\n\n\t\tif (state == 0) {\n\t\t\tif (b == 0xFF) {\n\t\t\t\tbytes[state] = b;\n\t\t\t\tstate = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ((dropped == 0) &amp;&amp; ((b &amp; 0xE0) == 0xE0) &amp;&amp; ((b &amp; 0x18) != 0x08) &amp;&amp; ((b &amp; 0x06) != 0)) {\n\t\t\t\t\tbytes[0] = (u8)0xFF;\n\t\t\t\t\tbytes[1] = b;\n\t\t\t\t\tstate = 2;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdropped++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\nGF_EXPORT\nu32 gf_mp3_get_next_header_mem(const u8 *buffer, u32 size, u32 *pos)\n{\n\tu32 cur;\n\tu8 b, state = 0;\n\tu32 dropped = 0;\n\tunsigned char bytes[4];\n\tbytes[0] = bytes[1] = bytes[2] = bytes[3] = 0;\n\n\tcur = 0;\n\t*pos = 0;\n\twhile (cur &lt; size) {\n\t\tb = (u8)buffer[cur];\n\t\tcur++;\n\n\t\tif (state == 3) {\n\t\t\tu32 val;\n\t\t\tbytes[state] = b;\n\t\t\tval = GF_4CC((u32)bytes[0], bytes[1], bytes[2], bytes[3]);\n\t\t\tif (gf_mp3_frame_size(val)) {\n\t\t\t\t*pos = dropped;\n\t\t\t\treturn val;\n\t\t\t}\n\t\t\tstate = 0;\n\t\t\tdropped = cur;\n\t\t}\n\t\tif (state == 2) {\n\t\t\tif (((b &amp; 0xF0) == 0) || ((b &amp; 0xF0) == 0xF0) || ((b &amp; 0x0C) == 0x0C)) {\n\t\t\t\tif (bytes[1] == 0xFF) {\n\t\t\t\t\tstate = 1;\n\t\t\t\t\tdropped += 1;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tstate = 0;\n\t\t\t\t\tdropped = cur;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tbytes[state] = b;\n\t\t\t\tstate = 3;\n\t\t\t}\n\t\t}\n\t\tif (state == 1) {\n\t\t\tif (((b &amp; 0xE0) == 0xE0) &amp;&amp; ((b &amp; 0x18) != 0x08) &amp;&amp; ((b &amp; 0x06) != 0)) {\n\t\t\t\tbytes[state] = b;\n\t\t\t\tstate = 2;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstate = 0;\n\t\t\t\tdropped = cur;\n\t\t\t}\n\t\t}\n\n\t\tif (state == 0) {\n\t\t\tif (b == 0xFF) {\n\t\t\t\tbytes[state] = b;\n\t\t\t\tstate = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdropped++;\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\n#endif /*GPAC_DISABLE_AV_PARSERS*/\n\nBool gf_avcc_use_extensions(u8 profile_idc)\n{\n\tswitch (profile_idc) {\n\tcase 66:\n\tcase 77:\n\tcase 88:\n\t\treturn GF_FALSE;\n\tdefault:\n\t\treturn GF_TRUE;\n\t}\n}\nGF_EXPORT\nconst char *gf_avc_get_profile_name(u8 video_prof)\n{\n\tswitch (video_prof) {\n\tcase 0x42:\n\t\treturn &quot;Baseline&quot;;\n\tcase 0x4D:\n\t\treturn &quot;Main&quot;;\n\tcase 0x53:\n\t\treturn &quot;Scalable Baseline&quot;;\n\tcase 0x56:\n\t\treturn &quot;Scalable High&quot;;\n\tcase 0x58:\n\t\treturn &quot;Extended&quot;;\n\tcase 0x64:\n\t\treturn &quot;High&quot;;\n\tcase 0x6E:\n\t\treturn &quot;High 10&quot;;\n\tcase 0x7A:\n\t\treturn &quot;High 4:2:2&quot;;\n\tcase 0x90:\n\tcase 0xF4:\n\t\treturn &quot;High 4:4:4&quot;;\n\tdefault:\n\t\treturn &quot;Unknown&quot;;\n\t}\n}\n\nGF_EXPORT\nconst char *gf_hevc_get_profile_name(u8 video_prof)\n{\n\tswitch (video_prof) {\n\tcase 0x01:\n\t\treturn &quot;Main&quot;;\n\tcase 0x02:\n\t\treturn &quot;Main 10&quot;;\n\tcase 0x03:\n\t\treturn &quot;Main Still Picture&quot;;\n\tdefault:\n\t\treturn &quot;Unknown&quot;;\n\t}\n}\nGF_EXPORT\nconst char *gf_avc_hevc_get_chroma_format_name(u8 chroma_format)\n{\n\tswitch (chroma_format) {\n\tcase 1:\n\t\treturn &quot;YUV 4:2:0&quot;;\n\tcase 2:\n\t\treturn &quot;YUV 4:2:2&quot;;\n\tcase 3:\n\t\treturn &quot;YUV 4:4:4&quot;;\n\tdefault:\n\t\treturn &quot;Unknown&quot;;\n\t}\n}\n\n#ifndef GPAC_DISABLE_AV_PARSERS\n\nu32 gf_bs_read_ue_log_idx3(GF_BitStream *bs, const char *fname, s32 idx1, s32 idx2, s32 idx3)\n{\n\tu32 val=0, code;\n\ts32 nb_lead = -1;\n\tu32 bits = 0;\n\tfor (code=0; !code; nb_lead++) {\n\t\tif (nb_lead&gt;=32) {\n\t\t\tbreak;\n\t\t}\n\t\tcode = gf_bs_read_int(bs, 1);\n\t\tbits++;\n\t}\n\n\tif (nb_lead&gt;=32) {\n\t\tif (gf_bs_is_overflow(bs)&lt;2) {\n\t\t\t//gf_bs_read_int keeps returning 0 on EOS, so if no more bits available, rbsp was truncated otherwise code is broken in rbsp)\n\t\t\t//we only test once nb_lead&gt;=32 to avoid testing at each bit read\n\t\t\tif (!gf_bs_available(bs)) {\n\t\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[Core] exp-golomb read failed, not enough bits in bitstream !\\n&quot;));\n\t\t\t} else {\n\t\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[Core] corrupted exp-golomb code, %d leading zeros, max 31 allowed !\\n&quot;, nb_lead));\n\t\t\t}\n\t\t\tgf_bs_mark_overflow(bs, GF_FALSE);\n\t\t}\n\t\treturn 0;\n\t}\n\n\tif (nb_lead) {\n\t\tu32 leads=1;\n\t\tval = gf_bs_read_int(bs, nb_lead);\n\t\tleads &lt;&lt;= nb_lead;\n\t\tleads -= 1;\n\t\tval += leads;\n//\t\tval += (1 &lt;&lt; nb_lead) - 1;\n\t\tbits += nb_lead;\n\t}\n\n\tif (fname) {\n\t\tgf_bs_log_idx(bs, bits, fname, val, idx1, idx2, idx3);\n\t}\n\treturn val;\n}\n\n#define gf_bs_read_ue_log_idx2(_bs, _fname, _idx1, _idx2) gf_bs_read_ue_log_idx3(_bs, _fname, (s32) _idx1, (s32) _idx2, -1)\n#define gf_bs_read_ue_log_idx(_bs, _fname, _idx) gf_bs_read_ue_log_idx3(_bs, _fname, (s32) _idx, -1, -1)\n#define gf_bs_read_ue_log(_bs, _fname) gf_bs_read_ue_log_idx3(_bs, _fname, -1, -1, -1)\n\n\nu32 gf_bs_read_ue(GF_BitStream *bs)\n{\n\treturn gf_bs_read_ue_log(bs, NULL);\n}\n\ns32 gf_bs_read_se(GF_BitStream *bs)\n{\n\tu32 v = gf_bs_read_ue(bs);\n\tif ((v &amp; 0x1) == 0) return (s32)(0 - (v &gt;&gt; 1));\n\treturn (v + 1) &gt;&gt; 1;\n}\n\ns32 gf_bs_read_se_log_idx2(GF_BitStream *bs, const char *fname, s32 idx1, s32 idx2)\n{\n\ts32 res = gf_bs_read_se(bs);\n\tif (fname)\n\t\tgf_bs_log_idx(bs, -1, fname, res, idx1, idx2, -1);\n\treturn res;\n}\n#define gf_bs_read_se_log_idx(_bs, _fname, _idx) gf_bs_read_se_log_idx2(_bs, _fname, (s32) _idx, -1)\n#define gf_bs_read_se_log(_bs, _fname) gf_bs_read_se_log_idx2(_bs, _fname, -1, -1)\n\n\n\nvoid gf_bs_write_ue(GF_BitStream *bs, u32 num) {\n\ts32 length = 1;\n\ts32 temp = ++num;\n\n\twhile (temp != 1) {\n\t\ttemp &gt;&gt;= 1;\n\t\tlength += 2;\n\t}\n\n\tgf_bs_write_int(bs, 0, length &gt;&gt; 1);\n\tgf_bs_write_int(bs, num, (length + 1) &gt;&gt; 1);\n}\n\nstatic u32 gf_get_ue_nb_bits(u32 num) {\n\ts32 length = 1;\n\ts32 temp = ++num;\n\n\twhile (temp != 1) {\n\t\ttemp &gt;&gt;= 1;\n\t\tlength += 2;\n\t}\n\n\treturn (length &gt;&gt; 1) + ( (length + 1) &gt;&gt; 1);\n}\n\nvoid gf_bs_write_se(GF_BitStream *bs, s32 num)\n{\n\tu32 v;\n\tif (num &lt;= 0)\n\t\tv = (-1 * num) &lt;&lt; 1;\n\telse\n\t\tv = (num &lt;&lt; 1) - 1;\n\n\tgf_bs_write_ue(bs, v);\n}\n\nGF_EXPORT\nu32 gf_media_nalu_next_start_code(const u8 *data, u32 data_len, u32 *sc_size)\n{\n\tu32 avail = data_len;\n\tconst u8 *cur = data;\n\n\twhile (cur) {\n\t\tu32 v, bpos;\n\t\tu8 *next_zero = memchr(cur, 0, avail);\n\t\tif (!next_zero) return data_len;\n\n\t\tv = 0xffffff00;\n\t\tbpos = (u32)(next_zero - data) + 1;\n\t\twhile (1) {\n\t\t\tu8 cval;\n\t\t\tif (bpos == (u32)data_len)\n\t\t\t\treturn data_len;\n\n\t\t\tcval = data[bpos];\n\t\t\tv = ((v &lt;&lt; 8) &amp; 0xFFFFFF00) | ((u32)cval);\n\t\t\tbpos++;\n\t\t\tif (v == 0x00000001) {\n\t\t\t\t*sc_size = 4;\n\t\t\t\treturn bpos - 4;\n\t\t\t}\n\t\t\telse if ((v &amp; 0x00FFFFFF) == 0x00000001) {\n\t\t\t\t*sc_size = 3;\n\t\t\t\treturn bpos - 3;\n\t\t\t}\n\t\t\tif (cval)\n\t\t\t\tbreak;\n\t\t}\n\t\tif (bpos &gt;= data_len)\n\t\t\tbreak;\n\t\tcur = data + bpos;\n\t\tavail = data_len - bpos;\n\t}\n\treturn data_len;\n}\n\nBool gf_avc_slice_is_intra(AVCState *avc)\n{\n\tswitch (avc-&gt;s_info.slice_type) {\n\tcase GF_AVC_TYPE_I:\n\tcase GF_AVC_TYPE2_I:\n\tcase GF_AVC_TYPE_SI:\n\tcase GF_AVC_TYPE2_SI:\n\t\treturn 1;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\n#if 0 //unused\nBool gf_avc_slice_is_IDR(AVCState *avc)\n{\n\tif (avc-&gt;sei.recovery_point.valid)\n\t{\n\t\tavc-&gt;sei.recovery_point.valid = 0;\n\t\treturn 1;\n\t}\n\tif (avc-&gt;s_info.nal_unit_type != GF_AVC_NALU_IDR_SLICE)\n\t\treturn 0;\n\treturn gf_avc_slice_is_intra(avc);\n}\n#endif\n\nstatic const struct  {\n\tu32 w, h;\n} avc_hevc_sar[] = {\n\t{ 0,   0 }, { 1,   1 }, { 12, 11 }, { 10, 11 },\n\t{ 16, 11 }, { 40, 33 }, { 24, 11 }, { 20, 11 },\n\t{ 32, 11 }, { 80, 33 }, { 18, 11 }, { 15, 11 },\n\t{ 64, 33 }, { 160,99 }, {  4,  3 }, {  3,  2 },\n\t{  2,  1 }\n};\n\n\n/*ISO 14496-10 (N11084) E.1.2*/\nstatic s32 avc_parse_hrd_parameters(GF_BitStream *bs, AVC_HRD *hrd)\n{\n\tint i, cpb_cnt_minus1;\n\n\tcpb_cnt_minus1 = gf_bs_read_ue_log(bs, &quot;cpb_cnt_minus1&quot;);\n\tif (cpb_cnt_minus1 &gt; 31) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[avc-h264] invalid cpb_cnt_minus1 value: %d (expected in [0;31])\\n&quot;, cpb_cnt_minus1));\n\t\treturn -1;\n\t}\n\tgf_bs_read_int_log(bs, 4, &quot;bit_rate_scale&quot;);\n\tgf_bs_read_int_log(bs, 4, &quot;cpb_size_scale&quot;);\n\n\t/*for( SchedSelIdx = 0; SchedSelIdx &lt;= cpb_cnt_minus1; SchedSelIdx++ ) {*/\n\tfor (i = 0; i &lt;= cpb_cnt_minus1; i++) {\n\t\tgf_bs_read_ue_log_idx(bs, &quot;bit_rate_value_minus1&quot;, i);\n\t\tgf_bs_read_ue_log_idx(bs, &quot;cpb_size_value_minus1&quot;, i);\n\t\tgf_bs_read_int_log_idx(bs, 1, &quot;cbr_flag&quot;, i);\n\t}\n\tgf_bs_read_int_log(bs, 5, &quot;initial_cpb_removal_delay_length_minus1&quot;);\n\thrd-&gt;cpb_removal_delay_length_minus1 = gf_bs_read_int_log(bs, 5, &quot;cpb_removal_delay_length_minus1&quot;);\n\thrd-&gt;dpb_output_delay_length_minus1 = gf_bs_read_int_log(bs, 5, &quot;dpb_output_delay_length_minus1&quot;);\n\thrd-&gt;time_offset_length = gf_bs_read_int_log(bs, 5, &quot;time_offset_length&quot;);\n\treturn 0;\n}\n\n/*returns the nal_size without emulation prevention bytes*/\nu32 gf_media_nalu_emulation_bytes_add_count(u8 *buffer, u32 nal_size)\n{\n\tu32 i = 0, emulation_bytes_count = 0;\n\tu8 num_zero = 0;\n\n\twhile (i &lt; nal_size) {\n\t\t/*ISO 14496-10: &quot;Within the NAL unit, any four-byte sequence that starts with 0x000003\n\t\tother than the following sequences shall not occur at any byte-aligned position:\n\t\t\\96 0x00000300\n\t\t\\96 0x00000301\n\t\t\\96 0x00000302\n\t\t\\96 0x00000303&quot;\n\t\t*/\n\t\tif (num_zero == 2 &amp;&amp; (u8)buffer[i] &lt; 0x04) {\n\t\t\t/*emulation code found*/\n\t\t\tnum_zero = 0;\n\t\t\temulation_bytes_count++;\n\t\t\tif (!buffer[i])\n\t\t\t\tnum_zero = 1;\n\t\t}\n\t\telse {\n\t\t\tif (!buffer[i])\n\t\t\t\tnum_zero++;\n\t\t\telse\n\t\t\t\tnum_zero = 0;\n\t\t}\n\t\ti++;\n\t}\n\treturn emulation_bytes_count;\n}\n\nu32 gf_media_nalu_add_emulation_bytes(const u8 *buffer_src, u8 *buffer_dst, u32 nal_size)\n{\n\tu32 i = 0, emulation_bytes_count = 0;\n\tu8 num_zero = 0;\n\n\twhile (i &lt; nal_size) {\n\t\t/*ISO 14496-10: &quot;Within the NAL unit, any four-byte sequence that starts with 0x000003\n\t\tother than the following sequences shall not occur at any byte-aligned position:\n\t\t0x00000300\n\t\t0x00000301\n\t\t0x00000302\n\t\t0x00000303&quot;\n\t\t*/\n\t\tif (num_zero == 2 &amp;&amp; (u8)buffer_src[i] &lt; 0x04) {\n\t\t\t/*add emulation code*/\n\t\t\tnum_zero = 0;\n\t\t\tbuffer_dst[i + emulation_bytes_count] = 0x03;\n\t\t\temulation_bytes_count++;\n\t\t\tif (!buffer_src[i])\n\t\t\t\tnum_zero = 1;\n\t\t}\n\t\telse {\n\t\t\tif (!buffer_src[i])\n\t\t\t\tnum_zero++;\n\t\t\telse\n\t\t\t\tnum_zero = 0;\n\t\t}\n\t\tbuffer_dst[i + emulation_bytes_count] = buffer_src[i];\n\t\ti++;\n\t}\n\treturn nal_size + emulation_bytes_count;\n}\n\n/*returns the nal_size without emulation prevention bytes*/\nu32 gf_media_nalu_emulation_bytes_remove_count(const u8 *buffer, u32 nal_size)\n{\n\tu32 i = 0, emulation_bytes_count = 0;\n\tu8 num_zero = 0;\n\tif (!buffer || !nal_size) return 0;\n\n\twhile (i &lt; nal_size)\n\t{\n\t\t/*ISO 14496-10: &quot;Within the NAL unit, any four-byte sequence that starts with 0x000003\n\t\t  other than the following sequences shall not occur at any byte-aligned position:\n\t\t  \\96 0x00000300\n\t\t  \\96 0x00000301\n\t\t  \\96 0x00000302\n\t\t  \\96 0x00000303&quot;\n\t\t*/\n\t\tif (num_zero == 2\n\t\t\t&amp;&amp; buffer[i] == 0x03\n\t\t\t&amp;&amp; i + 1 &lt; nal_size /*next byte is readable*/\n\t\t\t&amp;&amp; (u8)buffer[i + 1] &lt; 0x04)\n\t\t{\n\t\t\t/*emulation code found*/\n\t\t\tnum_zero = 0;\n\t\t\temulation_bytes_count++;\n\t\t\ti++;\n\t\t}\n\n\t\tif (!buffer[i])\n\t\t\tnum_zero++;\n\t\telse\n\t\t\tnum_zero = 0;\n\n\t\ti++;\n\t}\n\n\treturn emulation_bytes_count;\n}\n\n/*nal_size is updated to allow better error detection*/\nGF_EXPORT\nu32 gf_media_nalu_remove_emulation_bytes(const u8 *buffer_src, u8 *buffer_dst, u32 nal_size)\n{\n\tu32 i = 0, emulation_bytes_count = 0;\n\tu8 num_zero = 0;\n\n\twhile (i &lt; nal_size)\n\t{\n\t\t/*ISO 14496-10: &quot;Within the NAL unit, any four-byte sequence that starts with 0x000003\n\t\t  other than the following sequences shall not occur at any byte-aligned position:\n\t\t  0x00000300\n\t\t  0x00000301\n\t\t  0x00000302\n\t\t  0x00000303&quot;\n\t\t*/\n\t\tif (num_zero == 2\n\t\t\t&amp;&amp; buffer_src[i] == 0x03\n\t\t\t&amp;&amp; i + 1 &lt; nal_size /*next byte is readable*/\n\t\t\t&amp;&amp; (u8)buffer_src[i + 1] &lt; 0x04)\n\t\t{\n\t\t\t/*emulation code found*/\n\t\t\tnum_zero = 0;\n\t\t\temulation_bytes_count++;\n\t\t\ti++;\n\t\t}\n\n\t\tbuffer_dst[i - emulation_bytes_count] = buffer_src[i];\n\n\t\tif (!buffer_src[i])\n\t\t\tnum_zero++;\n\t\telse\n\t\t\tnum_zero = 0;\n\n\t\ti++;\n\t}\n\n\treturn nal_size - emulation_bytes_count;\n}\n\nstatic s32 gf_avc_read_sps_bs_internal(GF_BitStream *bs, AVCState *avc, u32 subseq_sps, u32 *vui_flag_pos, u32 nal_hdr)\n{\n\tAVC_SPS *sps;\n\ts32 mb_width, mb_height, sps_id = -1;\n\tu32 profile_idc, level_idc, pcomp, i, chroma_format_idc, cl = 0, cr = 0, ct = 0, cb = 0, luma_bd, chroma_bd;\n\tu8 separate_colour_plane_flag = 0;\n\n\tif (!vui_flag_pos) {\n\t\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\t}\n\n\tif (!bs) {\n\t\treturn -1;\n\t}\n\n\tif (!nal_hdr) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;forbidden_zero_bit&quot;);\n\t\tgf_bs_read_int_log(bs, 2, &quot;nal_ref_idc&quot;);\n\t\tgf_bs_read_int_log(bs, 5, &quot;nal_unit_type&quot;);\n\t}\n\tprofile_idc = gf_bs_read_int_log(bs, 8, &quot;profile_idc&quot;);\n\n\tpcomp = gf_bs_read_int_log(bs, 8, &quot;profile_compatibility&quot;);\n\t/*sanity checks*/\n\tif (pcomp &amp; 0x3)\n\t\treturn -1;\n\n\tlevel_idc = gf_bs_read_int_log(bs, 8, &quot;level_idc&quot;);\n\n\t/*SubsetSps is used to be sure that AVC SPS are not going to be scratched\n\tby subset SPS. According to the SVC standard, subset SPS can have the same sps_id\n\tthan its base layer, but it does not refer to the same SPS. */\n\tsps_id = gf_bs_read_ue_log(bs, &quot;sps_id&quot;) + GF_SVC_SSPS_ID_SHIFT * subseq_sps;\n\tif ((sps_id &lt; 0) || (sps_id &gt;= 32)) {\n\t\treturn -1;\n\t}\n\n\tluma_bd = chroma_bd = 0;\n\tsps = &amp;avc-&gt;sps[sps_id];\n\tchroma_format_idc = sps-&gt;ChromaArrayType = 1;\n\tsps-&gt;state |= subseq_sps ? AVC_SUBSPS_PARSED : AVC_SPS_PARSED;\n\n\t/*High Profile and SVC*/\n\tswitch (profile_idc) {\n\tcase 100:\n\tcase 110:\n\tcase 122:\n\tcase 244:\n\tcase 44:\n\t\t/*sanity checks: note1 from 7.4.2.1.1 of iso/iec 14496-10-N11084*/\n\t\tif (pcomp &amp; 0xE0)\n\t\t\treturn -1;\n\tcase 83:\n\tcase 86:\n\tcase 118:\n\tcase 128:\n\t\tchroma_format_idc = gf_bs_read_ue_log(bs, &quot;chroma_format_idc&quot;);\n\t\tsps-&gt;ChromaArrayType = chroma_format_idc;\n\t\tif (chroma_format_idc == 3) {\n\t\t\tseparate_colour_plane_flag = gf_bs_read_int_log(bs, 1, &quot;separate_colour_plane_flag&quot;);\n\t\t\t/*\n\t\t\tDepending on the value of separate_colour_plane_flag, the value of the variable ChromaArrayType is assigned as follows.\n\t\t\t\\96\tIf separate_colour_plane_flag is equal to 0, ChromaArrayType is set equal to chroma_format_idc.\n\t\t\t\\96\tOtherwise (separate_colour_plane_flag is equal to 1), ChromaArrayType is set equal to 0.\n\t\t\t*/\n\t\t\tif (separate_colour_plane_flag) sps-&gt;ChromaArrayType = 0;\n\t\t}\n\t\tluma_bd = gf_bs_read_ue_log(bs, &quot;luma_bit_depth&quot;);\n\t\tchroma_bd = gf_bs_read_ue_log(bs, &quot;chroma_bit_depth&quot;);\n\t\t/*qpprime_y_zero_transform_bypass_flag = */ gf_bs_read_int_log(bs, 1, &quot;qpprime_y_zero_transform_bypass_flag&quot;);\n\t\t/*seq_scaling_matrix_present_flag*/\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;seq_scaling_matrix_present_flag&quot;)) {\n\t\t\tu32 k;\n\t\t\tfor (k = 0; k &lt; 8; k++) {\n\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;seq_scaling_list_present_flag&quot;, k)) {\n\t\t\t\t\tu32 z, last = 8, next = 8;\n\t\t\t\t\tu32 sl = k &lt; 6 ? 16 : 64;\n\t\t\t\t\tfor (z = 0; z &lt; sl; z++) {\n\t\t\t\t\t\tif (next) {\n\t\t\t\t\t\t\ts32 delta = gf_bs_read_se(bs);\n\t\t\t\t\t\t\tnext = (last + delta + 256) % 256;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlast = next ? next : last;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\n\tsps-&gt;profile_idc = profile_idc;\n\tsps-&gt;level_idc = level_idc;\n\tsps-&gt;prof_compat = pcomp;\n\tsps-&gt;log2_max_frame_num = gf_bs_read_ue_log(bs, &quot;log2_max_frame_num&quot;) + 4;\n\tif (sps-&gt;log2_max_frame_num&gt;16) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[avc-h264] invalid SPS: log2_max_frame_num_minus4 shall be less than 12, but is %d\\n&quot;, sps-&gt;log2_max_frame_num-4));\n\t\tsps-&gt;log2_max_frame_num=0;\n\t\treturn -1;\n\t}\n\tsps-&gt;poc_type = gf_bs_read_ue_log(bs, &quot;poc_type&quot;);\n\tif (sps-&gt;poc_type&gt;2) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[avc-h264] invalid SPS: pic_order_cnt_type shall be less than 2, but is %d\\n&quot;, sps-&gt;poc_type));\n\t\tsps-&gt;log2_max_frame_num=0;\n\t\treturn -1;\n\t}\n\tsps-&gt;chroma_format = chroma_format_idc;\n\tsps-&gt;luma_bit_depth_m8 = luma_bd;\n\tsps-&gt;chroma_bit_depth_m8 = chroma_bd;\n\n\tif (sps-&gt;poc_type == 0) {\n\t\tsps-&gt;log2_max_poc_lsb = gf_bs_read_ue_log(bs, &quot;log2_max_poc_lsb&quot;) + 4;\n\t}\n\telse if (sps-&gt;poc_type == 1) {\n\t\tsps-&gt;delta_pic_order_always_zero_flag = gf_bs_read_int_log(bs, 1, &quot;delta_pic_order_always_zero_flag&quot;);\n\t\tsps-&gt;offset_for_non_ref_pic = gf_bs_read_se_log(bs, &quot;offset_for_non_ref_pic&quot;);\n\t\tsps-&gt;offset_for_top_to_bottom_field = gf_bs_read_se_log(bs, &quot;offset_for_top_to_bottom_field&quot;);\n\t\tsps-&gt;poc_cycle_length = gf_bs_read_ue_log(bs, &quot;poc_cycle_length&quot;);\n\t\tif (sps-&gt;poc_cycle_length &gt; GF_ARRAY_LENGTH(sps-&gt;offset_for_ref_frame)) {\n\t\t\tsps-&gt;poc_cycle_length = 255;\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[avc-h264] offset_for_ref_frame overflow from poc_cycle_length\\n&quot;));\n\t\t\treturn -1;\n\t\t}\n\t\tfor (i = 0; i &lt; sps-&gt;poc_cycle_length; i++)\n\t\t\tsps-&gt;offset_for_ref_frame[i] = gf_bs_read_se_log_idx(bs, &quot;offset_for_ref_frame&quot;, i);\n\t}\n\tif (sps-&gt;poc_type &gt; 2) {\n\t\treturn -1;\n\t}\n\tsps-&gt;max_num_ref_frames = gf_bs_read_ue_log(bs, &quot;max_num_ref_frames&quot;);\n\tsps-&gt;gaps_in_frame_num_value_allowed_flag = gf_bs_read_int_log(bs, 1, &quot;gaps_in_frame_num_value_allowed_flag&quot;);\n\tmb_width = gf_bs_read_ue_log(bs, &quot;pic_width_in_mbs_minus1&quot;) + 1;\n\tmb_height = gf_bs_read_ue_log(bs, &quot;pic_height_in_map_units_minus1&quot;) + 1;\n\t//5.1 level max frame size in MBs is 36864, we set our limit at 16k x 16x pixels (eg 1 M MBs) for fuzzed stream detection\n\tif ( (u64) mb_width * (u64) mb_height &gt; 1000000) {\n\t\treturn -1;\n\t}\n\n\tsps-&gt;frame_mbs_only_flag = gf_bs_read_int_log(bs, 1, &quot;frame_mbs_only_flag&quot;);\n\n\tsps-&gt;width = mb_width * 16;\n\tsps-&gt;height = (2 - sps-&gt;frame_mbs_only_flag) * mb_height * 16;\n\n\tif (!sps-&gt;frame_mbs_only_flag) sps-&gt;mb_adaptive_frame_field_flag = gf_bs_read_int_log(bs, 1, &quot;mb_adaptive_frame_field_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;direct_8x8_inference_flag&quot;);\n\n\tif (gf_bs_read_int_log(bs, 1, &quot;frame_cropping_flag&quot;)) {\n\t\tint CropUnitX, CropUnitY, SubWidthC = -1, SubHeightC = -1;\n\n\t\tif (chroma_format_idc == 1) {\n\t\t\tSubWidthC = 2; SubHeightC = 2;\n\t\t}\n\t\telse if (chroma_format_idc == 2) {\n\t\t\tSubWidthC = 2; SubHeightC = 1;\n\t\t}\n\t\telse if ((chroma_format_idc == 3) &amp;&amp; (separate_colour_plane_flag == 0)) {\n\t\t\tSubWidthC = 1; SubHeightC = 1;\n\t\t}\n\n\t\tif (sps-&gt;ChromaArrayType == 0) {\n\t\t\tassert(SubWidthC == -1);\n\t\t\tCropUnitX = 1;\n\t\t\tCropUnitY = 2 - sps-&gt;frame_mbs_only_flag;\n\t\t}\n\t\telse {\n\t\t\tCropUnitX = SubWidthC;\n\t\t\tCropUnitY = SubHeightC * (2 - sps-&gt;frame_mbs_only_flag);\n\t\t}\n\n\t\tcl = gf_bs_read_ue_log(bs, &quot;frame_crop_left_offset&quot;);\n\t\tcr = gf_bs_read_ue_log(bs, &quot;frame_crop_right_offset&quot;);\n\t\tct = gf_bs_read_ue_log(bs, &quot;frame_crop_top_offset&quot;);\n\t\tcb = gf_bs_read_ue_log(bs, &quot;frame_crop_bottom_offset&quot;);\n\n\t\tsps-&gt;width -= CropUnitX * (cl + cr);\n\t\tsps-&gt;height -= CropUnitY * (ct + cb);\n\t\tcl *= CropUnitX;\n\t\tcr *= CropUnitX;\n\t\tct *= CropUnitY;\n\t\tcb *= CropUnitY;\n\t}\n\tsps-&gt;crop.left = cl;\n\tsps-&gt;crop.right = cr;\n\tsps-&gt;crop.top = ct;\n\tsps-&gt;crop.bottom = cb;\n\n\tif (vui_flag_pos) {\n\t\t*vui_flag_pos = (u32)gf_bs_get_bit_offset(bs);\n\t}\n\t/*vui_parameters_present_flag*/\n\tsps-&gt;vui_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_parameters_present_flag&quot;);\n\tif (sps-&gt;vui_parameters_present_flag) {\n\t\tsps-&gt;vui.aspect_ratio_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;aspect_ratio_info_present_flag&quot;);\n\t\tif (sps-&gt;vui.aspect_ratio_info_present_flag) {\n\t\t\ts32 aspect_ratio_idc = gf_bs_read_int_log(bs, 8, &quot;aspect_ratio_idc&quot;);\n\t\t\tif (aspect_ratio_idc == 255) {\n\t\t\t\tsps-&gt;vui.par_num = gf_bs_read_int_log(bs, 16, &quot;aspect_ratio_num&quot;);\n\t\t\t\tsps-&gt;vui.par_den = gf_bs_read_int_log(bs, 16, &quot;aspect_ratio_den&quot;);\n\t\t\t}\n\t\t\telse if (aspect_ratio_idc &lt; GF_ARRAY_LENGTH(avc_hevc_sar) ) {\n\t\t\t\tsps-&gt;vui.par_num = avc_hevc_sar[aspect_ratio_idc].w;\n\t\t\t\tsps-&gt;vui.par_den = avc_hevc_sar[aspect_ratio_idc].h;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[avc-h264] Unknown aspect_ratio_idc: your video may have a wrong aspect ratio. Contact the GPAC team!\\n&quot;));\n\t\t\t}\n\t\t}\n\t\tsps-&gt;vui.overscan_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;overscan_info_present_flag&quot;);\n\t\tif (sps-&gt;vui.overscan_info_present_flag)\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;overscan_appropriate_flag&quot;);\n\n\t\t/* default values */\n\t\tsps-&gt;vui.video_format = 5;\n\t\tsps-&gt;vui.colour_primaries = 2;\n\t\tsps-&gt;vui.transfer_characteristics = 2;\n\t\tsps-&gt;vui.matrix_coefficients = 2;\n\t\t//When the chroma_sample_loc_type_top_field and chroma_sample_loc_type_bottom_field are not present, the values of chroma_sample_loc_type_top_field and chroma_sample_loc_type_bottom_field shall be inferred to be equal to 0.\n\t\tsps-&gt;vui.chroma_sample_loc_type_top_field = sps-&gt;vui.chroma_sample_loc_type_bottom_field = 0;\n\n\t\t/* now read values if possible */\n\t\tsps-&gt;vui.video_signal_type_present_flag = gf_bs_read_int_log(bs, 1, &quot;video_signal_type_present_flag&quot;);\n\t\tif (sps-&gt;vui.video_signal_type_present_flag) {\n\t\t\tsps-&gt;vui.video_format = gf_bs_read_int_log(bs, 3, &quot;video_format&quot;);\n\t\t\tsps-&gt;vui.video_full_range_flag = gf_bs_read_int_log(bs, 1, &quot;video_full_range_flag&quot;);\n\t\t\tsps-&gt;vui.colour_description_present_flag = gf_bs_read_int_log(bs, 1, &quot;colour_description_present_flag&quot;);\n\t\t\tif (sps-&gt;vui.colour_description_present_flag) {\n\t\t\t\tsps-&gt;vui.colour_primaries = gf_bs_read_int_log(bs, 8, &quot;colour_primaries&quot;);\n\t\t\t\tsps-&gt;vui.transfer_characteristics = gf_bs_read_int_log(bs, 8, &quot;transfer_characteristics&quot;);\n\t\t\t\tsps-&gt;vui.matrix_coefficients = gf_bs_read_int_log(bs, 8, &quot;matrix_coefficients&quot;);\n\t\t\t}\n\t\t}\n\n\t\tsps-&gt;vui.chroma_location_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;chroma_location_info_present_flag&quot;);\n\t\tif (sps-&gt;vui.chroma_location_info_present_flag) {\n\t\t\tsps-&gt;vui.chroma_sample_loc_type_top_field = gf_bs_read_ue_log(bs, &quot;chroma_sample_location_type_top_field&quot;);\n\t\t\tsps-&gt;vui.chroma_sample_loc_type_bottom_field = gf_bs_read_ue_log(bs, &quot;chroma_sample_location_type_bottom_field&quot;);\n\t\t}\n\n\t\tsps-&gt;vui.timing_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;timing_info_present_flag&quot;);\n\t\tif (sps-&gt;vui.timing_info_present_flag) {\n\t\t\tsps-&gt;vui.num_units_in_tick = gf_bs_read_int_log(bs, 32, &quot;num_units_in_tick&quot;);\n\t\t\tsps-&gt;vui.time_scale = gf_bs_read_int_log(bs, 32, &quot;time_scale&quot;);\n\t\t\tsps-&gt;vui.fixed_frame_rate_flag = gf_bs_read_int_log(bs, 1, &quot;fixed_frame_rate_flag&quot;);\n\t\t}\n\n\t\tsps-&gt;vui.nal_hrd_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;nal_hrd_parameters_present_flag&quot;);\n\t\tif (sps-&gt;vui.nal_hrd_parameters_present_flag)\n\t\t\tif (avc_parse_hrd_parameters(bs, &amp;sps-&gt;vui.hrd)&lt;0) return -1;\n\n\t\tsps-&gt;vui.vcl_hrd_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;vcl_hrd_parameters_present_flag&quot;);\n\t\tif (sps-&gt;vui.vcl_hrd_parameters_present_flag)\n\t\t\tif (avc_parse_hrd_parameters(bs, &amp;sps-&gt;vui.hrd)&lt;0) return -1;\n\n\t\tif (sps-&gt;vui.nal_hrd_parameters_present_flag || sps-&gt;vui.vcl_hrd_parameters_present_flag)\n\t\t\tsps-&gt;vui.low_delay_hrd_flag = gf_bs_read_int_log(bs, 1, &quot;low_delay_hrd_flag&quot;);\n\n\t\tsps-&gt;vui.pic_struct_present_flag = gf_bs_read_int_log(bs, 1, &quot;pic_struct_present_flag&quot;);\n\t}\n\t/*end of seq_parameter_set_data*/\n\n\tif (subseq_sps) {\n\t\tif ((profile_idc == 83) || (profile_idc == 86)) {\n\t\t\tu8 extended_spatial_scalability_idc;\n\t\t\t/*parsing seq_parameter_set_svc_extension*/\n\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;inter_layer_deblocking_filter_control_present_flag&quot;);\n\t\t\textended_spatial_scalability_idc = gf_bs_read_int_log(bs, 2, &quot;extended_spatial_scalability_idc&quot;);\n\t\t\tif (sps-&gt;ChromaArrayType == 1 || sps-&gt;ChromaArrayType == 2) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;chroma_phase_x_plus1_flag&quot;);\n\t\t\t}\n\t\t\tif (sps-&gt;ChromaArrayType == 1) {\n\t\t\t\tgf_bs_read_int_log(bs, 2, &quot;chroma_phase_y_plus1&quot;);\n\t\t\t}\n\t\t\tif (extended_spatial_scalability_idc == 1) {\n\t\t\t\tif (sps-&gt;ChromaArrayType &gt; 0) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;seq_ref_layer_chroma_phase_x_plus1_flag&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 2, &quot;seq_ref_layer_chroma_phase_y_plus1&quot;);\n\t\t\t\t}\n\t\t\t\tgf_bs_read_se_log(bs, &quot;seq_scaled_ref_layer_left_offset&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;seq_scaled_ref_layer_top_offset&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;seq_scaled_ref_layer_right_offset&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;seq_scaled_ref_layer_bottom_offset&quot;);\n\t\t\t}\n\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;seq_tcoeff_level_prediction_flag&quot;)) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;adaptive_tcoeff_level_prediction_flag&quot;);\n\t\t\t}\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;slice_header_restriction_flag&quot;);\n\n\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;svc_vui_parameters_present&quot;)) {\n\t\t\t\tu32 vui_ext_num_entries_minus1 = gf_bs_read_ue_log(bs, &quot;vui_ext_num_entries_minus1&quot;);\n\n\t\t\t\tfor (i = 0; i &lt;= vui_ext_num_entries_minus1; i++) {\n\t\t\t\t\tu8 vui_ext_nal_hrd_parameters_present_flag, vui_ext_vcl_hrd_parameters_present_flag, vui_ext_timing_info_present_flag;\n\t\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;vui_ext_dependency_id&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 4, &quot;vui_ext_quality_id&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;vui_ext_temporal_id&quot;);\n\t\t\t\t\tvui_ext_timing_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_ext_timing_info_present_flag&quot;);\n\t\t\t\t\tif (vui_ext_timing_info_present_flag) {\n\t\t\t\t\t\tgf_bs_read_int_log(bs, 32, &quot;vui_ext_num_units_in_tick&quot;);\n\t\t\t\t\t\tgf_bs_read_int_log(bs, 32, &quot;vui_ext_time_scale&quot;);\n\t\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;vui_ext_fixed_frame_rate_flag&quot;);\n\t\t\t\t\t}\n\t\t\t\t\tvui_ext_nal_hrd_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_ext_nal_hrd_parameters_present_flag&quot;);\n\t\t\t\t\tif (vui_ext_nal_hrd_parameters_present_flag) {\n\t\t\t\t\t\t//hrd_parameters( )\n\t\t\t\t\t}\n\t\t\t\t\tvui_ext_vcl_hrd_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_ext_vcl_hrd_parameters_present_flag&quot;);\n\t\t\t\t\tif (vui_ext_vcl_hrd_parameters_present_flag) {\n\t\t\t\t\t\t//hrd_parameters( )\n\t\t\t\t\t}\n\t\t\t\t\tif (vui_ext_nal_hrd_parameters_present_flag || vui_ext_vcl_hrd_parameters_present_flag) {\n\t\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;vui_ext_low_delay_hrd_flag&quot;);\n\t\t\t\t\t}\n\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;vui_ext_pic_struct_present_flag&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse if ((profile_idc == 118) || (profile_idc == 128)) {\n\t\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CODING, (&quot;[avc-h264] MVC parsing not implemented - skipping parsing end of Subset SPS\\n&quot;));\n\t\t\treturn sps_id;\n\t\t}\n\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;additional_extension2&quot;)) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[avc-h264] skipping parsing end of Subset SPS (additional_extension2)\\n&quot;));\n\t\t\treturn sps_id;\n\t\t}\n\t}\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn sps_id;\n}\n\nGF_EXPORT\ns32 gf_avc_read_sps_bs(GF_BitStream *bs, AVCState *avc, u32 subseq_sps, u32 *vui_flag_pos)\n{\n\treturn gf_avc_read_sps_bs_internal(bs, avc, subseq_sps, vui_flag_pos, 0);\n}\n\nGF_EXPORT\ns32 gf_avc_read_sps(const u8 *sps_data, u32 sps_size, AVCState *avc, u32 subseq_sps, u32 *vui_flag_pos)\n{\n\ts32 sps_id = -1;\n\tGF_BitStream *bs;\n\tchar *sps_data_without_emulation_bytes = NULL;\n\tu32 sps_data_without_emulation_bytes_size = 0;\n\n\tif (vui_flag_pos) {\n\t\t/*SPS still contains emulation bytes*/\n\t\tsps_data_without_emulation_bytes = gf_malloc(sps_size * sizeof(char));\n\t\tsps_data_without_emulation_bytes_size = gf_media_nalu_remove_emulation_bytes(sps_data, sps_data_without_emulation_bytes, sps_size);\n\t\tbs = gf_bs_new(sps_data_without_emulation_bytes, sps_data_without_emulation_bytes_size, GF_BITSTREAM_READ);\n\n\t\t*vui_flag_pos = 0;\n\t}\n\telse {\n\t\tbs = gf_bs_new(sps_data, sps_size, GF_BITSTREAM_READ);\n\t}\n\n\tif (!bs) {\n\t\tsps_id = -1;\n\t\tgoto exit;\n\t}\n\n\tsps_id = gf_avc_read_sps_bs(bs, avc, subseq_sps, vui_flag_pos);\n\nexit:\n\tgf_bs_del(bs);\n\tif (sps_data_without_emulation_bytes) gf_free(sps_data_without_emulation_bytes);\n\treturn sps_id;\n}\n\nstatic s32 gf_avc_read_pps_bs_internal(GF_BitStream *bs, AVCState *avc, u32 nal_hdr)\n{\n\ts32 pps_id;\n\tAVC_PPS *pps;\n\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tif (!nal_hdr) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;forbidden_zero_bit&quot;);\n\t\tgf_bs_read_int_log(bs, 2, &quot;nal_ref_idc&quot;);\n\t\tgf_bs_read_int_log(bs, 5, &quot;nal_unit_type&quot;);\n\t}\n\tpps_id = gf_bs_read_ue_log(bs, &quot;pps_id&quot;);\n\tif ((pps_id&lt;0) || (pps_id &gt;= 255)) {\n\t\treturn -1;\n\t}\n\tpps = &amp;avc-&gt;pps[pps_id];\n\tpps-&gt;id = pps_id;\n\n\tif (!pps-&gt;status) pps-&gt;status = 1;\n\tpps-&gt;sps_id = gf_bs_read_ue_log(bs, &quot;sps_id&quot;);\n\tif ((pps-&gt;sps_id&lt;0) || (pps-&gt;sps_id &gt;= 32)) {\n\t\tpps-&gt;sps_id = 0;\n\t\treturn -1;\n\t}\n\t/*sps_id may be refer to regular SPS or subseq sps, depending on the coded slice referring to the pps*/\n\tif (!avc-&gt;sps[pps-&gt;sps_id].state &amp;&amp; !avc-&gt;sps[pps-&gt;sps_id + GF_SVC_SSPS_ID_SHIFT].state) {\n\t\treturn -1;\n\t}\n\tavc-&gt;pps_active_idx = pps-&gt;id; /*set active sps*/\n\tavc-&gt;sps_active_idx = pps-&gt;sps_id; /*set active sps*/\n\tpps-&gt;entropy_coding_mode_flag = gf_bs_read_int_log(bs, 1, &quot;entropy_coding_mode_flag&quot;);\n\tpps-&gt;pic_order_present = gf_bs_read_int_log(bs, 1, &quot;pic_order_present&quot;);\n\tpps-&gt;slice_group_count = gf_bs_read_ue_log(bs, &quot;slice_group_count_minus1&quot;) + 1;\n\tif (pps-&gt;slice_group_count &gt; 1) {\n\t\tu32 iGroup;\n\t\tpps-&gt;mb_slice_group_map_type = gf_bs_read_ue_log(bs, &quot;mb_slice_group_map_type&quot;);\n\t\tif (pps-&gt;mb_slice_group_map_type == 0) {\n\t\t\tfor (iGroup = 0; iGroup &lt;= pps-&gt;slice_group_count - 1; iGroup++)\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;run_length_minus1&quot;, iGroup);\n\t\t}\n\t\telse if (pps-&gt;mb_slice_group_map_type == 2) {\n\t\t\tfor (iGroup = 0; iGroup &lt; pps-&gt;slice_group_count - 1; iGroup++) {\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;top_left&quot;, iGroup);\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;bottom_right&quot;, iGroup);\n\t\t\t}\n\t\t}\n\t\telse if (pps-&gt;mb_slice_group_map_type == 3 || pps-&gt;mb_slice_group_map_type == 4 || pps-&gt;mb_slice_group_map_type == 5) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;slice_group_change_direction_flag&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;slice_group_change_rate_minus1&quot;);\n\t\t}\n\t\telse if (pps-&gt;mb_slice_group_map_type == 6) {\n\t\t\tu32 i;\n\t\t\tpps-&gt;pic_size_in_map_units_minus1 = gf_bs_read_ue_log(bs, &quot;pic_size_in_map_units_minus1&quot;);\n\t\t\tfor (i = 0; i &lt;= pps-&gt;pic_size_in_map_units_minus1; i++) {\n\t\t\t\tgf_bs_read_int_log_idx(bs, (u32)ceil(log(pps-&gt;slice_group_count) / log(2)), &quot;slice_group_id&quot;, i);\n\t\t\t}\n\t\t}\n\t}\n\tpps-&gt;num_ref_idx_l0_default_active_minus1 = gf_bs_read_ue_log(bs, &quot;num_ref_idx_l0_default_active_minus1&quot;);\n\tpps-&gt;num_ref_idx_l1_default_active_minus1 = gf_bs_read_ue_log(bs, &quot;num_ref_idx_l1_default_active_minus1&quot;);\n\n\t/*\n\tif ((pps-&gt;ref_count[0] &gt; 32) || (pps-&gt;ref_count[1] &gt; 32)) goto exit;\n\t*/\n\n\tpps-&gt;weighted_pred_flag = gf_bs_read_int_log(bs, 1, &quot;weighted_pred_flag&quot;);\n\tgf_bs_read_int_log(bs, 2, &quot;weighted_bipred_idc&quot;);\n\tgf_bs_read_se_log(bs, &quot;init_qp_minus26&quot;);\n\tgf_bs_read_se_log(bs, &quot;init_qs_minus26&quot;);\n\tgf_bs_read_se_log(bs, &quot;chroma_qp_index_offset&quot;);\n\tpps-&gt;deblocking_filter_control_present_flag = gf_bs_read_int_log(bs, 1, &quot;deblocking_filter_control_present_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;constrained_intra_pred&quot;);\n\tpps-&gt;redundant_pic_cnt_present = gf_bs_read_int_log(bs, 1, &quot;redundant_pic_cnt_present&quot;);\n\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn pps_id;\n}\n\nGF_EXPORT\ns32 gf_avc_read_pps_bs(GF_BitStream *bs, AVCState *avc)\n{\n\treturn gf_avc_read_pps_bs_internal(bs, avc, 0);\n}\n\nGF_EXPORT\ns32 gf_avc_read_pps(const u8 *pps_data, u32 pps_size, AVCState *avc)\n{\n\tGF_BitStream *bs;\n\ts32 pps_id;\n\n\t/*PPS still contains emulation bytes*/\n\tbs = gf_bs_new(pps_data, pps_size, GF_BITSTREAM_READ);\n\tif (!bs) {\n\t\treturn -1;\n\t}\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tpps_id = gf_avc_read_pps_bs(bs, avc);\n\tgf_bs_del(bs);\n\treturn pps_id;\n}\n\n#if 0 //unused\n\ns32 gf_avc_read_sps_ext(const char *spse_data, u32 spse_size)\n{\n\tGF_BitStream *bs;\n\ts32 sps_id;\n\n\tbs = gf_bs_new(spse_data, spse_size, GF_BITSTREAM_READ);\n\tsps_id = gf_avc_read_sps_ext_bs(bs);\n\n\tgf_bs_del(bs);\n\treturn sps_id;\n}\n#endif\n\nstatic s32 SVC_ReadNal_header_extension(GF_BitStream *bs, SVC_NALUHeader *NalHeader)\n{\n\tgf_bs_read_int_log(bs, 1, &quot;reserved_one_bit&quot;);\n\tNalHeader-&gt;idr_pic_flag = gf_bs_read_int_log(bs, 1, &quot;idr_flag&quot;);\n\tNalHeader-&gt;priority_id = gf_bs_read_int_log(bs, 6, &quot;priority_id&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;no_inter_layer_pred_flag&quot;);\n\tNalHeader-&gt;dependency_id = gf_bs_read_int_log(bs, 3, &quot;DependencyId&quot;);\n\tNalHeader-&gt;quality_id = gf_bs_read_int_log(bs, 4, &quot;quality_id&quot;);\n\tNalHeader-&gt;temporal_id = gf_bs_read_int_log(bs, 3, &quot;temporal_id&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;use_ref_base_pic_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;discardable_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;output_flag&quot;);\n\tgf_bs_read_int_log(bs, 2, &quot;reserved_three_2bits&quot;);\n\treturn 1;\n}\n\nstatic void ref_pic_list_modification(GF_BitStream *bs, u32 slice_type) {\n\tif (slice_type % 5 != 2 &amp;&amp; slice_type % 5 != 4) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;ref_pic_list_modification_flag_l0&quot;)) {\n\t\t\tu32 idx=0, modification_of_pic_nums_idc;\n\t\t\tdo {\n\t\t\t\tmodification_of_pic_nums_idc = gf_bs_read_ue_log_idx(bs, &quot;modification_of_pic_nums_idc&quot;, idx);\n\t\t\t\tif (modification_of_pic_nums_idc == 0 || modification_of_pic_nums_idc == 1) {\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;abs_diff_pic_num_minus1&quot;, idx);\n\t\t\t\t}\n\t\t\t\telse if (modification_of_pic_nums_idc == 2) {\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;long_term_pic_num&quot;, idx);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t} while ((modification_of_pic_nums_idc != 3) &amp;&amp; gf_bs_available(bs));\n\t\t}\n\t}\n\tif (slice_type % 5 == 1) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;ref_pic_list_modification_flag_l1&quot;)) {\n\t\t\tu32 idx=0, modification_of_pic_nums_idc;\n\t\t\tdo {\n\t\t\t\tmodification_of_pic_nums_idc = gf_bs_read_ue_log_idx(bs, &quot;modification_of_pic_nums_idc&quot;, idx);\n\t\t\t\tif (modification_of_pic_nums_idc == 0 || modification_of_pic_nums_idc == 1) {\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;abs_diff_pic_num_minus1&quot;, idx);\n\t\t\t\t}\n\t\t\t\telse if (modification_of_pic_nums_idc == 2) {\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;long_term_pic_num&quot;, idx);\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t} while ((modification_of_pic_nums_idc != 3) &amp;&amp; gf_bs_available(bs));\n\t\t}\n\t}\n}\n\nstatic void avc_pred_weight_table(GF_BitStream *bs, u32 slice_type, u32 ChromaArrayType, u32 num_ref_idx_l0_active_minus1, u32 num_ref_idx_l1_active_minus1) {\n\tu32 i, j;\n\tgf_bs_read_ue_log(bs, &quot;luma_log2_weight_denom&quot;);\n\tif (ChromaArrayType != 0) {\n\t\tgf_bs_read_ue_log(bs, &quot;chroma_log2_weight_denom&quot;);\n\t}\n\tfor (i = 0; i &lt;= num_ref_idx_l0_active_minus1; i++) {\n\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;luma_weight_l0_flag&quot;, i)) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_weight_l0&quot;, i);\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_offset_l0&quot;, i);\n\t\t}\n\t\tif (ChromaArrayType != 0) {\n\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;chroma_weight_l0_flag&quot;, i))\n\t\t\t\tfor (j = 0; j &lt; 2; j++) {\n\t\t\t\t\tgf_bs_read_se_log_idx2(bs, &quot;chroma_weight_l0&quot;, i, j);\n\t\t\t\t\tgf_bs_read_se_log_idx2(bs, &quot;chroma_offset_l0&quot;, i, j);\n\t\t\t\t}\n\t\t}\n\t}\n\tif (slice_type % 5 == 1) {\n\t\tfor (i = 0; i &lt;= num_ref_idx_l1_active_minus1; i++) {\n\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;luma_weight_l1_flag&quot;, i)) {\n\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_weight_l1&quot;, i);\n\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_offset_l1&quot;, i);\n\t\t\t}\n\t\t\tif (ChromaArrayType != 0) {\n\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;chroma_weight_l1_flag&quot;, i)) {\n\t\t\t\t\tfor (j = 0; j &lt; 2; j++) {\n\t\t\t\t\t\tgf_bs_read_se_log_idx2(bs, &quot;chroma_weight_l1&quot;, i, j);\n\t\t\t\t\t\tgf_bs_read_se_log_idx2(bs, &quot;chroma_offset_l1&quot;, i, j);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void dec_ref_pic_marking(GF_BitStream *bs, Bool IdrPicFlag) {\n\tif (IdrPicFlag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;no_output_of_prior_pics_flag&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;long_term_reference_flag&quot;);\n\t}\n\telse {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;adaptive_ref_pic_marking_mode_flag&quot;)) {\n\t\t\tu32 idx=0, memory_management_control_operation;\n\t\t\tdo {\n\t\t\t\tmemory_management_control_operation = gf_bs_read_ue_log_idx(bs, &quot;memory_management_control_operation&quot;, idx);\n\t\t\t\tif (memory_management_control_operation == 1 || memory_management_control_operation == 3)\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;difference_of_pic_nums_minus1&quot;, idx);\n\t\t\t\tif (memory_management_control_operation == 2)\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;long_term_pic_num&quot;, idx);\n\t\t\t\tif (memory_management_control_operation == 3 || memory_management_control_operation == 6)\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;long_term_frame_idx&quot;, idx);\n\t\t\t\tif (memory_management_control_operation == 4)\n\t\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;max_long_term_frame_idx_plus1&quot;, idx);\n\t\t\t\tidx++;\n\t\t\t} while (memory_management_control_operation != 0);\n\t\t}\n\t}\n}\n\nstatic s32 avc_parse_slice(GF_BitStream *bs, AVCState *avc, Bool svc_idr_flag, AVCSliceInfo *si)\n{\n\ts32 pps_id, num_ref_idx_l0_active_minus1 = 0, num_ref_idx_l1_active_minus1 = 0;\n\n\t/*s-&gt;current_picture.reference= h-&gt;nal_ref_idc != 0;*/\n\tgf_bs_read_ue_log(bs, &quot;first_mb_in_slice&quot;);\n\tsi-&gt;slice_type = gf_bs_read_ue_log(bs, &quot;slice_type&quot;);\n\tif (si-&gt;slice_type &gt; 9) return -1;\n\n\tpps_id = gf_bs_read_ue_log(bs, &quot;pps_id&quot;);\n\tif ((pps_id&lt;0) || (pps_id &gt; 255)) return -1;\n\tsi-&gt;pps = &amp;avc-&gt;pps[pps_id];\n\tif (!si-&gt;pps-&gt;slice_group_count) return -2;\n\tif (si-&gt;pps-&gt;sps_id&gt;=255) return -1;\n\tsi-&gt;sps = &amp;avc-&gt;sps[si-&gt;pps-&gt;sps_id];\n\tif (!si-&gt;sps-&gt;log2_max_frame_num) return -2;\n\tavc-&gt;sps_active_idx = si-&gt;pps-&gt;sps_id;\n\tavc-&gt;pps_active_idx = pps_id;\n\n\tsi-&gt;frame_num = gf_bs_read_int_log(bs, si-&gt;sps-&gt;log2_max_frame_num, &quot;frame_num&quot;);\n\n\tsi-&gt;field_pic_flag = 0;\n\tsi-&gt;bottom_field_flag = 0;\n\tif (!si-&gt;sps-&gt;frame_mbs_only_flag) {\n\t\tsi-&gt;field_pic_flag = gf_bs_read_int_log(bs, 1, &quot;field_pic_flag&quot;);\n\t\tif (si-&gt;field_pic_flag)\n\t\t\tsi-&gt;bottom_field_flag = gf_bs_read_int_log(bs, 1, &quot;bottom_field_flag&quot;);\n\t}\n\n\tif ((si-&gt;nal_unit_type == GF_AVC_NALU_IDR_SLICE) || svc_idr_flag)\n\t\tsi-&gt;idr_pic_id = gf_bs_read_ue_log(bs, &quot;idr_pic_id&quot;);\n\n\tif (si-&gt;sps-&gt;poc_type == 0) {\n\t\tsi-&gt;poc_lsb = gf_bs_read_int_log(bs, si-&gt;sps-&gt;log2_max_poc_lsb, &quot;poc_lsb&quot;);\n\t\tif (si-&gt;pps-&gt;pic_order_present &amp;&amp; !si-&gt;field_pic_flag) {\n\t\t\tsi-&gt;delta_poc_bottom = gf_bs_read_se_log(bs, &quot;poc_lsb&quot;);\n\t\t}\n\t}\n\telse if ((si-&gt;sps-&gt;poc_type == 1) &amp;&amp; !si-&gt;sps-&gt;delta_pic_order_always_zero_flag) {\n\t\tsi-&gt;delta_poc[0] = gf_bs_read_se_log(bs, &quot;delta_poc0&quot;);\n\t\tif ((si-&gt;pps-&gt;pic_order_present == 1) &amp;&amp; !si-&gt;field_pic_flag)\n\t\t\tsi-&gt;delta_poc[1] = gf_bs_read_se_log(bs, &quot;delta_poc1&quot;);\n\t}\n\n\tif (si-&gt;pps-&gt;redundant_pic_cnt_present) {\n\t\tsi-&gt;redundant_pic_cnt = gf_bs_read_ue_log(bs, &quot;redundant_pic_cnt&quot;);\n\t}\n\n\tif (si-&gt;slice_type % 5 == GF_AVC_TYPE_B) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;direct_spatial_mv_pred_flag&quot;);\n\t}\n\n\tnum_ref_idx_l0_active_minus1 = si-&gt;pps-&gt;num_ref_idx_l0_default_active_minus1;\n\tnum_ref_idx_l1_active_minus1 = si-&gt;pps-&gt;num_ref_idx_l1_default_active_minus1;\n\n\tif (si-&gt;slice_type % 5 == GF_AVC_TYPE_P || si-&gt;slice_type % 5 == GF_AVC_TYPE_SP || si-&gt;slice_type % 5 == GF_AVC_TYPE_B) {\n\t\tBool num_ref_idx_active_override_flag = gf_bs_read_int_log(bs, 1, &quot;num_ref_idx_active_override_flag&quot;);\n\t\tif (num_ref_idx_active_override_flag) {\n\t\t\tnum_ref_idx_l0_active_minus1 = gf_bs_read_ue_log(bs, &quot;num_ref_idx_l0_active_minus1&quot;);\n\t\t\tif (si-&gt;slice_type % 5 == GF_AVC_TYPE_B) {\n\t\t\t\tnum_ref_idx_l1_active_minus1 = gf_bs_read_ue_log(bs, &quot;num_ref_idx_l1_active_minus1&quot;);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (si-&gt;nal_unit_type == 20 || si-&gt;nal_unit_type == 21) {\n\t\t//ref_pic_list_mvc_modification(); /* specified in Annex H */\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[avc-h264] unimplemented ref_pic_list_mvc_modification() in slide header\\n&quot;));\n\t\tassert(0);\n\t\treturn -1;\n\t}\n\telse {\n\t\tref_pic_list_modification(bs, si-&gt;slice_type);\n\t}\n\n\tif ((si-&gt;pps-&gt;weighted_pred_flag &amp;&amp; (si-&gt;slice_type % 5 == GF_AVC_TYPE_P || si-&gt;slice_type % 5 == GF_AVC_TYPE_SP))\n\t\t|| (si-&gt;pps-&gt;weighted_bipred_idc == 1 &amp;&amp; si-&gt;slice_type % 5 == GF_AVC_TYPE_B)) {\n\t\tavc_pred_weight_table(bs, si-&gt;slice_type, si-&gt;sps-&gt;ChromaArrayType, num_ref_idx_l0_active_minus1, num_ref_idx_l1_active_minus1);\n\t}\n\n\tif (si-&gt;nal_ref_idc != 0) {\n\t\tdec_ref_pic_marking(bs, (si-&gt;nal_unit_type == GF_AVC_NALU_IDR_SLICE));\n\t}\n\n\tif (si-&gt;pps-&gt;entropy_coding_mode_flag &amp;&amp; si-&gt;slice_type % 5 != GF_AVC_TYPE_I &amp;&amp; si-&gt;slice_type % 5 != GF_AVC_TYPE_SI) {\n\t\tgf_bs_read_ue_log(bs, &quot;cabac_init_idc&quot;);\n\t}\n\n\t/*slice_qp_delta = */gf_bs_read_se(bs);\n\tif (si-&gt;slice_type % 5 == GF_AVC_TYPE_SP || si-&gt;slice_type % 5 == GF_AVC_TYPE_SI) {\n\t\tif (si-&gt;slice_type % 5 == GF_AVC_TYPE_SP) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;sp_for_switch_flag&quot;);\n\t\t}\n\t\tgf_bs_read_se_log(bs, &quot;slice_qs_delta&quot;);\n\t}\n\n\tif (si-&gt;pps-&gt;deblocking_filter_control_present_flag) {\n\t\tif (gf_bs_read_ue_log(bs, &quot;disable_deblocking_filter_idc&quot;) != 1) {\n\t\t\tgf_bs_read_se_log(bs, &quot;slice_alpha_c0_offset_div2&quot;);\n\t\t\tgf_bs_read_se_log(bs, &quot;slice_beta_offset_div2&quot;);\n\t\t}\n\t}\n\n\tif (si-&gt;pps-&gt;slice_group_count &gt; 1 &amp;&amp; si-&gt;pps-&gt;mb_slice_group_map_type &gt;= 3 &amp;&amp; si-&gt;pps-&gt;mb_slice_group_map_type &lt;= 5) {\n\t\tgf_bs_read_int_log(bs, (u32)ceil(log1p((si-&gt;pps-&gt;pic_size_in_map_units_minus1 + 1) / (si-&gt;pps-&gt;slice_group_change_rate_minus1 + 1) ) / log(2)), &quot;slice_group_change_cycle&quot;);\n\t}\n\treturn 0;\n}\n\n\nstatic s32 svc_parse_slice(GF_BitStream *bs, AVCState *avc, AVCSliceInfo *si)\n{\n\ts32 pps_id;\n\n\t/*s-&gt;current_picture.reference= h-&gt;nal_ref_idc != 0;*/\n\tgf_bs_read_ue_log(bs, &quot;first_mb_in_slice&quot;);\n\tsi-&gt;slice_type = gf_bs_read_ue_log(bs, &quot;slice_type&quot;);\n\tif (si-&gt;slice_type &gt; 9) return -1;\n\n\tpps_id = gf_bs_read_ue_log(bs, &quot;pps_id&quot;);\n\tif ((pps_id&lt;0) || (pps_id &gt; 255))\n\t\treturn -1;\n\tsi-&gt;pps = &amp;avc-&gt;pps[pps_id];\n\tsi-&gt;pps-&gt;id = pps_id;\n\tif (!si-&gt;pps-&gt;slice_group_count)\n\t\treturn -2;\n\tsi-&gt;sps = &amp;avc-&gt;sps[si-&gt;pps-&gt;sps_id + GF_SVC_SSPS_ID_SHIFT];\n\tif (!si-&gt;sps-&gt;log2_max_frame_num)\n\t\treturn -2;\n\n\tsi-&gt;frame_num = gf_bs_read_int_log(bs, si-&gt;sps-&gt;log2_max_frame_num, &quot;frame_num&quot;);\n\n\tsi-&gt;field_pic_flag = 0;\n\tif (si-&gt;sps-&gt;frame_mbs_only_flag) {\n\t\t/*s-&gt;picture_structure= PICT_FRAME;*/\n\t}\n\telse {\n\t\tsi-&gt;field_pic_flag = gf_bs_read_int_log(bs, 1, &quot;field_pic_flag&quot;);\n\t\tif (si-&gt;field_pic_flag) si-&gt;bottom_field_flag = gf_bs_read_int_log(bs, 1, &quot;bottom_field_flag&quot;);\n\t}\n\tif (si-&gt;nal_unit_type == GF_AVC_NALU_IDR_SLICE || si-&gt;svc_nalhdr.idr_pic_flag)\n\t\tsi-&gt;idr_pic_id = gf_bs_read_ue_log(bs, &quot;idr_pic_id&quot;);\n\n\tif (si-&gt;sps-&gt;poc_type == 0) {\n\t\tsi-&gt;poc_lsb = gf_bs_read_int_log(bs, si-&gt;sps-&gt;log2_max_poc_lsb, &quot;poc_lsb&quot;);\n\t\tif (si-&gt;pps-&gt;pic_order_present &amp;&amp; !si-&gt;field_pic_flag) {\n\t\t\tsi-&gt;delta_poc_bottom = gf_bs_read_se_log(bs, &quot;delta_poc_bottom&quot;);\n\t\t}\n\t}\n\telse if ((si-&gt;sps-&gt;poc_type == 1) &amp;&amp; !si-&gt;sps-&gt;delta_pic_order_always_zero_flag) {\n\t\tsi-&gt;delta_poc[0] = gf_bs_read_se_log(bs, &quot;delta_poc0&quot;);\n\t\tif ((si-&gt;pps-&gt;pic_order_present == 1) &amp;&amp; !si-&gt;field_pic_flag)\n\t\t\tsi-&gt;delta_poc[1] = gf_bs_read_se_log(bs, &quot;delta_poc1&quot;);\n\t}\n\tif (si-&gt;pps-&gt;redundant_pic_cnt_present) {\n\t\tsi-&gt;redundant_pic_cnt = gf_bs_read_ue_log(bs, &quot;redundant_pic_cnt&quot;);\n\t}\n\treturn 0;\n}\n\n\nstatic s32 avc_parse_recovery_point_sei(GF_BitStream *bs, AVCState *avc)\n{\n\tAVCSeiRecoveryPoint *rp = &amp;avc-&gt;sei.recovery_point;\n\n\trp-&gt;frame_cnt = gf_bs_read_ue_log(bs, &quot;frame_cnt&quot;);\n\trp-&gt;exact_match_flag = gf_bs_read_int_log(bs, 1, &quot;exact_match_flag&quot;);\n\trp-&gt;broken_link_flag = gf_bs_read_int_log(bs, 1, &quot;broken_link_flag&quot;);\n\trp-&gt;changing_slice_group_idc = gf_bs_read_int_log(bs, 2, &quot;changing_slice_group_idc&quot;);\n\trp-&gt;valid = 1;\n\n\treturn 0;\n}\n\n/*for interpretation see ISO 14496-10 N.11084, table D-1*/\nstatic s32 avc_parse_pic_timing_sei(GF_BitStream *bs, AVCState *avc)\n{\n\tint sps_id = avc-&gt;sps_active_idx;\n\tconst char NumClockTS[] = { 1, 1, 1, 2, 2, 3, 3, 2, 3 };\n\tAVCSeiPicTiming *pt = &amp;avc-&gt;sei.pic_timing;\n\n\tif (sps_id &lt; 0) {\n\t\t/*sps_active_idx equals -1 when no sps has been detected. In this case SEI should not be decoded.*/\n\t\tassert(0);\n\t\treturn 1;\n\t}\n\tif (avc-&gt;sps[sps_id].vui.nal_hrd_parameters_present_flag || avc-&gt;sps[sps_id].vui.vcl_hrd_parameters_present_flag) { /*CpbDpbDelaysPresentFlag, see 14496-10(2003) E.11*/\n\t\tgf_bs_read_int_log(bs, 1 + avc-&gt;sps[sps_id].vui.hrd.cpb_removal_delay_length_minus1, &quot;cpb_removal_delay_minus1&quot;);\n\t\tgf_bs_read_int_log(bs, 1 + avc-&gt;sps[sps_id].vui.hrd.dpb_output_delay_length_minus1, &quot;dpb_output_delay_minus1&quot;);\n\t}\n\n\t/*ISO 14496-10 (2003), D.8.2: we need to get pic_struct in order to know if we display top field first or bottom field first*/\n\tif (avc-&gt;sps[sps_id].vui.pic_struct_present_flag) {\n\t\tint i;\n\t\tpt-&gt;pic_struct = gf_bs_read_int_log(bs, 4, &quot;pic_struct&quot;);\n\t\tif (pt-&gt;pic_struct &gt; 8) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[avc-h264] invalid pic_struct value %d\\n&quot;, pt-&gt;pic_struct));\n\t\t\treturn 1;\n\t\t}\n\n\t\tfor (i = 0; i &lt; NumClockTS[pt-&gt;pic_struct]; i++) {\n\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;clock_timestamp_flag&quot;, i)) {\n\t\t\t\tBool full_timestamp_flag;\n\t\t\t\tgf_bs_read_int_log_idx(bs, 2, &quot;ct_type&quot;, i);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;nuit_field_based_flag&quot;, i);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;counting_type&quot;, i);\n\t\t\t\tfull_timestamp_flag = gf_bs_read_int_log_idx(bs, 1, &quot;full_timestamp_flag&quot;, i);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;discontinuity_flag&quot;, i);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;cnt_dropped_flag&quot;, i);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;n_frames&quot;, i);\n\t\t\t\tif (full_timestamp_flag) {\n\t\t\t\t\tgf_bs_read_int_log_idx(bs, 6, &quot;seconds_value&quot;, i);\n\t\t\t\t\tgf_bs_read_int_log_idx(bs, 6, &quot;minutes_value&quot;, i);\n\t\t\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;hours_value&quot;, i);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;seconds_flag&quot;, i)) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 6, &quot;seconds_value&quot;, i);\n\t\t\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;minutes_flag&quot;, i)) {\n\t\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 6, &quot;minutes_value&quot;, i);\n\t\t\t\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;hours_flag&quot;, i)) {\n\t\t\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;hours_value&quot;, i);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (avc-&gt;sps[sps_id].vui.hrd.time_offset_length &gt; 0)\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, avc-&gt;sps[sps_id].vui.hrd.time_offset_length, &quot;time_offset&quot;, i);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n\n#if !defined(GPAC_DISABLE_HEVC)\nstatic void avc_parse_itu_t_t35_sei(GF_BitStream* bs, AVCSeiItuTT35DolbyVision *dovi)\n{\n\tu8 itu_t_t35_country_code = gf_bs_read_u8(bs);\n\tu16 terminal_provider_code = gf_bs_read_u16(bs);\n\tu32 user_id = gf_bs_read_u32(bs);\n\tu8 data_type_code = gf_bs_read_u8(bs);\n\tif (itu_t_t35_country_code == 0xB5 &amp;&amp; terminal_provider_code == 0x31 &amp;&amp; user_id == 0x47413934 &amp;&amp; (data_type_code == 0x8 || data_type_code == 0x9)) {\n\t\tdovi-&gt;rpu_flag = GF_TRUE;\n\t}\n}\n#endif\n\nstatic void avc_compute_poc(AVCSliceInfo *si)\n{\n\tenum {\n\t\tAVC_PIC_FRAME,\n\t\tAVC_PIC_FIELD_TOP,\n\t\tAVC_PIC_FIELD_BOTTOM,\n\t} pic_type;\n\ts32 field_poc[2] = { 0,0 };\n\ts32 max_frame_num;\n\n\tif (!si-&gt;sps) return;\n\n\tmax_frame_num = 1 &lt;&lt; (si-&gt;sps-&gt;log2_max_frame_num);\n\n\t/* picture type */\n\tif (si-&gt;sps-&gt;frame_mbs_only_flag || !si-&gt;field_pic_flag) pic_type = AVC_PIC_FRAME;\n\telse if (si-&gt;bottom_field_flag) pic_type = AVC_PIC_FIELD_BOTTOM;\n\telse pic_type = AVC_PIC_FIELD_TOP;\n\n\t/* frame_num_offset */\n\tif (si-&gt;nal_unit_type == GF_AVC_NALU_IDR_SLICE) {\n\t\tsi-&gt;poc_lsb_prev = 0;\n\t\tsi-&gt;poc_msb_prev = 0;\n\t\tsi-&gt;frame_num_offset = 0;\n\t}\n\telse {\n\t\tif (si-&gt;frame_num &lt; si-&gt;frame_num_prev)\n\t\t\tsi-&gt;frame_num_offset = si-&gt;frame_num_offset_prev + max_frame_num;\n\t\telse\n\t\t\tsi-&gt;frame_num_offset = si-&gt;frame_num_offset_prev;\n\t}\n\n\t/*ISO 14496-10 N.11084 8.2.1.1*/\n\tif (si-&gt;sps-&gt;poc_type == 0)\n\t{\n\t\tconst u32 max_poc_lsb = 1 &lt;&lt; (si-&gt;sps-&gt;log2_max_poc_lsb);\n\n\t\t/*ISO 14496-10 N.11084 eq (8-3)*/\n\t\tif ((si-&gt;poc_lsb &lt; si-&gt;poc_lsb_prev) &amp;&amp;\n\t\t\t(si-&gt;poc_lsb_prev - si-&gt;poc_lsb &gt;= max_poc_lsb / 2))\n\t\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev + max_poc_lsb;\n\t\telse if ((si-&gt;poc_lsb &gt; si-&gt;poc_lsb_prev) &amp;&amp;\n\t\t\t(si-&gt;poc_lsb - si-&gt;poc_lsb_prev &gt; max_poc_lsb / 2))\n\t\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev - max_poc_lsb;\n\t\telse\n\t\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev;\n\n\t\t/*ISO 14496-10 N.11084 eq (8-4)*/\n\t\tif (pic_type != AVC_PIC_FIELD_BOTTOM)\n\t\t\tfield_poc[0] = si-&gt;poc_msb + si-&gt;poc_lsb;\n\n\t\t/*ISO 14496-10 N.11084 eq (8-5)*/\n\t\tif (pic_type != AVC_PIC_FIELD_TOP) {\n\t\t\tif (!si-&gt;field_pic_flag)\n\t\t\t\tfield_poc[1] = field_poc[0] + si-&gt;delta_poc_bottom;\n\t\t\telse\n\t\t\t\tfield_poc[1] = si-&gt;poc_msb + si-&gt;poc_lsb;\n\t\t}\n\t}\n\t/*ISO 14496-10 N.11084 8.2.1.2*/\n\telse if (si-&gt;sps-&gt;poc_type == 1)\n\t{\n\t\tu32 i;\n\t\ts32 abs_frame_num, expected_delta_per_poc_cycle, expected_poc;\n\n\t\tif (si-&gt;sps-&gt;poc_cycle_length)\n\t\t\tabs_frame_num = si-&gt;frame_num_offset + si-&gt;frame_num;\n\t\telse\n\t\t\tabs_frame_num = 0;\n\n\t\tif (!si-&gt;nal_ref_idc &amp;&amp; (abs_frame_num &gt; 0)) abs_frame_num--;\n\n\t\texpected_delta_per_poc_cycle = 0;\n\t\tfor (i = 0; i &lt; si-&gt;sps-&gt;poc_cycle_length; i++)\n\t\t\texpected_delta_per_poc_cycle += si-&gt;sps-&gt;offset_for_ref_frame[i];\n\n\t\tif (abs_frame_num &gt; 0) {\n\t\t\tconst u32 poc_cycle_cnt = (abs_frame_num - 1) / si-&gt;sps-&gt;poc_cycle_length;\n\t\t\tconst u32 frame_num_in_poc_cycle = (abs_frame_num - 1) % si-&gt;sps-&gt;poc_cycle_length;\n\n\t\t\texpected_poc = poc_cycle_cnt * expected_delta_per_poc_cycle;\n\t\t\tfor (i = 0; i &lt;= frame_num_in_poc_cycle; i++)\n\t\t\t\texpected_poc += si-&gt;sps-&gt;offset_for_ref_frame[i];\n\t\t}\n\t\telse {\n\t\t\texpected_poc = 0;\n\t\t}\n\n\t\tif (!si-&gt;nal_ref_idc) expected_poc += si-&gt;sps-&gt;offset_for_non_ref_pic;\n\n\t\tfield_poc[0] = expected_poc + si-&gt;delta_poc[0];\n\t\tfield_poc[1] = field_poc[0] + si-&gt;sps-&gt;offset_for_top_to_bottom_field;\n\t\tif (pic_type == AVC_PIC_FRAME) field_poc[1] += si-&gt;delta_poc[1];\n\t}\n\t/*ISO 14496-10 N.11084 8.2.1.3*/\n\telse if (si-&gt;sps-&gt;poc_type == 2)\n\t{\n\t\tint poc;\n\t\tif (si-&gt;nal_unit_type == GF_AVC_NALU_IDR_SLICE) {\n\t\t\tpoc = 0;\n\t\t}\n\t\telse {\n\t\t\tconst int abs_frame_num = si-&gt;frame_num_offset + si-&gt;frame_num;\n\t\t\tpoc = 2 * abs_frame_num;\n\t\t\tif (!si-&gt;nal_ref_idc) poc -= 1;\n\t\t}\n\t\tfield_poc[0] = poc;\n\t\tfield_poc[1] = poc;\n\t}\n\n\t/*ISO 14496-10 N.11084 eq (8-1)*/\n\tif (pic_type == AVC_PIC_FRAME)\n\t\tsi-&gt;poc = MIN(field_poc[0], field_poc[1]);\n\telse if (pic_type == AVC_PIC_FIELD_TOP)\n\t\tsi-&gt;poc = field_poc[0];\n\telse\n\t\tsi-&gt;poc = field_poc[1];\n}\n\nGF_EXPORT\ns32 gf_avc_parse_nalu(GF_BitStream *bs, AVCState *avc)\n{\n\tu8 idr_flag;\n\ts32 slice, ret;\n\tu32 nal_hdr;\n\tAVCSliceInfo n_state;\n\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tif (!gf_bs_available(bs)) return -1;\n\tgf_bs_mark_overflow(bs, GF_TRUE);\n\n\tnal_hdr = gf_bs_read_u8(bs);\n\n\tslice = 0;\n\tmemcpy(&amp;n_state, &amp;avc-&gt;s_info, sizeof(AVCSliceInfo));\n\tavc-&gt;last_nal_type_parsed = n_state.nal_unit_type = nal_hdr &amp; 0x1F;\n\tn_state.nal_ref_idc = (nal_hdr &gt;&gt; 5) &amp; 0x3;\n\n\tidr_flag = 0;\n\n\tswitch (n_state.nal_unit_type) {\n\tcase GF_AVC_NALU_ACCESS_UNIT:\n\tcase GF_AVC_NALU_END_OF_SEQ:\n\tcase GF_AVC_NALU_END_OF_STREAM:\n\t\tret = 1;\n\t\tbreak;\n\n\tcase GF_AVC_NALU_SVC_SLICE:\n\t\tSVC_ReadNal_header_extension(bs, &amp;n_state.svc_nalhdr);\n\t\tif (gf_bs_is_overflow(bs)) return -1;\n\n\t\t// slice buffer - read the info and compare.\n\t\t/*ret = */svc_parse_slice(bs, avc, &amp;n_state);\n\t\tif (avc-&gt;s_info.nal_ref_idc) {\n\t\t\tn_state.poc_lsb_prev = avc-&gt;s_info.poc_lsb;\n\t\t\tn_state.poc_msb_prev = avc-&gt;s_info.poc_msb;\n\t\t}\n\t\tavc_compute_poc(&amp;n_state);\n\n\t\tif (avc-&gt;s_info.poc != n_state.poc) {\n\t\t\tmemcpy(&amp;avc-&gt;s_info, &amp;n_state, sizeof(AVCSliceInfo));\n\t\t\treturn 1;\n\t\t}\n\t\tmemcpy(&amp;avc-&gt;s_info, &amp;n_state, sizeof(AVCSliceInfo));\n\t\treturn 0;\n\n\tcase GF_AVC_NALU_SVC_PREFIX_NALU:\n\t\tSVC_ReadNal_header_extension(bs, &amp;avc-&gt;s_info.svc_nalhdr);\n\t\tif (gf_bs_is_overflow(bs)) return -1;\n\t\treturn 0;\n\n\tcase GF_AVC_NALU_IDR_SLICE:\n\tcase GF_AVC_NALU_NON_IDR_SLICE:\n\tcase GF_AVC_NALU_DP_A_SLICE:\n\tcase GF_AVC_NALU_DP_B_SLICE:\n\tcase GF_AVC_NALU_DP_C_SLICE:\n\t\tslice = 1;\n\t\t/* slice buffer - read the info and compare.*/\n\t\tret = avc_parse_slice(bs, avc, idr_flag, &amp;n_state);\n\t\tif (gf_bs_is_overflow(bs)) ret = -1;\n\t\tif (ret &lt; 0) return ret;\n\t\tret = 0;\n\t\tif (\n\t\t\t((avc-&gt;s_info.nal_unit_type &gt; GF_AVC_NALU_IDR_SLICE) || (avc-&gt;s_info.nal_unit_type &lt; GF_AVC_NALU_NON_IDR_SLICE))\n\t\t\t&amp;&amp; (avc-&gt;s_info.nal_unit_type != GF_AVC_NALU_SVC_SLICE)\n\t\t\t) {\n\t\t\tbreak;\n\t\t}\n\t\tif (avc-&gt;s_info.frame_num != n_state.frame_num) {\n\t\t\tret = 1;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (avc-&gt;s_info.field_pic_flag != n_state.field_pic_flag) {\n\t\t\tret = 1;\n\t\t\tbreak;\n\t\t}\n\t\tif ((avc-&gt;s_info.nal_ref_idc != n_state.nal_ref_idc) &amp;&amp;\n\t\t\t(!avc-&gt;s_info.nal_ref_idc || !n_state.nal_ref_idc)) {\n\t\t\tret = 1;\n\t\t\tbreak;\n\t\t}\n\t\tif (!avc-&gt;s_info.sps)\n\t\t\treturn -1;\n\n\t\tif (avc-&gt;s_info.sps-&gt;poc_type == n_state.sps-&gt;poc_type) {\n\t\t\tif (!avc-&gt;s_info.sps-&gt;poc_type) {\n\t\t\t\tif (!n_state.bottom_field_flag &amp;&amp; (avc-&gt;s_info.poc_lsb != n_state.poc_lsb)) {\n\t\t\t\t\tret = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (avc-&gt;s_info.delta_poc_bottom != n_state.delta_poc_bottom) {\n\t\t\t\t\tret = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (avc-&gt;s_info.sps-&gt;poc_type == 1) {\n\t\t\t\tif (avc-&gt;s_info.delta_poc[0] != n_state.delta_poc[0]) {\n\t\t\t\t\tret = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (avc-&gt;s_info.delta_poc[1] != n_state.delta_poc[1]) {\n\t\t\t\t\tret = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (n_state.nal_unit_type == GF_AVC_NALU_IDR_SLICE) {\n\t\t\tif (avc-&gt;s_info.nal_unit_type != GF_AVC_NALU_IDR_SLICE) { /*IdrPicFlag differs in value*/\n\t\t\t\tret = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse if (avc-&gt;s_info.idr_pic_id != n_state.idr_pic_id) { /*both IDR and idr_pic_id differs*/\n\t\t\t\tret = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase GF_AVC_NALU_SEQ_PARAM:\n\t\tavc-&gt;last_ps_idx = gf_avc_read_sps_bs_internal(bs, avc, 0, NULL, nal_hdr);\n\t\tif (gf_bs_is_overflow(bs)) return -1;\n\t\tif (avc-&gt;last_ps_idx &lt; 0) return -1;\n\t\tavc-&gt;last_sps_idx = avc-&gt;last_ps_idx;\n\t\treturn 0;\n\n\tcase GF_AVC_NALU_PIC_PARAM:\n\t\tavc-&gt;last_ps_idx = gf_avc_read_pps_bs_internal(bs, avc, nal_hdr);\n\t\tif (gf_bs_is_overflow(bs)) return -1;\n\t\tif (avc-&gt;last_ps_idx &lt; 0) return -1;\n\t\treturn 0;\n\tcase GF_AVC_NALU_SVC_SUBSEQ_PARAM:\n\t\tavc-&gt;last_ps_idx = gf_avc_read_sps_bs_internal(bs, avc, 1, NULL, nal_hdr);\n\t\tif (gf_bs_is_overflow(bs)) return -1;\n\t\tif (avc-&gt;last_ps_idx &lt; 0) return -1;\n\t\treturn 0;\n\tcase GF_AVC_NALU_SEQ_PARAM_EXT:\n\t\tavc-&gt;last_ps_idx = (s32) gf_bs_read_ue(bs);\n\t\tif (gf_bs_is_overflow(bs)) return -1;\n\t\tif (avc-&gt;last_ps_idx &lt; 0) return -1;\n\t\treturn 0;\n\n\tcase GF_AVC_NALU_SEI:\n\tcase GF_AVC_NALU_FILLER_DATA:\n\t\treturn 0;\n\n\tdefault:\n\t\tif (avc-&gt;s_info.nal_unit_type &lt;= GF_AVC_NALU_IDR_SLICE) ret = 1;\n\t\t//To detect change of AU when multiple sps and pps in stream\n\t\telse if ((nal_hdr &amp; 0x1F) == GF_AVC_NALU_SEI &amp;&amp; avc-&gt;s_info.nal_unit_type == GF_AVC_NALU_SVC_SLICE)\n\t\t\tret = 1;\n\t\telse if ((nal_hdr &amp; 0x1F) == GF_AVC_NALU_SEQ_PARAM &amp;&amp; avc-&gt;s_info.nal_unit_type == GF_AVC_NALU_SVC_SLICE)\n\t\t\tret = 1;\n\t\telse\n\t\t\tret = 0;\n\t\tbreak;\n\t}\n\n\t/* save _prev values */\n\tif (ret &amp;&amp; avc-&gt;s_info.sps) {\n\t\tn_state.frame_num_offset_prev = avc-&gt;s_info.frame_num_offset;\n\t\tif ((avc-&gt;s_info.sps-&gt;poc_type != 2) || (avc-&gt;s_info.nal_ref_idc != 0))\n\t\t\tn_state.frame_num_prev = avc-&gt;s_info.frame_num;\n\t\tif (avc-&gt;s_info.nal_ref_idc) {\n\t\t\tn_state.poc_lsb_prev = avc-&gt;s_info.poc_lsb;\n\t\t\tn_state.poc_msb_prev = avc-&gt;s_info.poc_msb;\n\t\t}\n\t}\n\tif (slice)\n\t\tavc_compute_poc(&amp;n_state);\n\tmemcpy(&amp;avc-&gt;s_info, &amp;n_state, sizeof(AVCSliceInfo));\n\treturn ret;\n}\n\n\nu32 gf_avc_reformat_sei(u8 *buffer, u32 nal_size, Bool isobmf_rewrite, AVCState *avc)\n{\n\tu32 ptype, psize, hdr, var;\n\tu32 start;\n\tGF_BitStream *bs;\n\tGF_BitStream *bs_dest = NULL;\n\tu8 nhdr;\n\tBool sei_removed = GF_FALSE;\n\tchar store;\n\n\thdr = buffer[0];\n\tif ((hdr &amp; 0x1F) != GF_AVC_NALU_SEI) return 0;\n\n\tif (isobmf_rewrite) bs_dest = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\n\tbs = gf_bs_new(buffer, nal_size, GF_BITSTREAM_READ);\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tnhdr = gf_bs_read_int(bs, 8);\n\tif (bs_dest) gf_bs_write_int(bs_dest, nhdr, 8);\n\n\t/*parse SEI*/\n\twhile (gf_bs_available(bs)) {\n\t\tBool do_copy;\n\t\tptype = 0;\n\t\twhile (1) {\n\t\t\tu8 v = gf_bs_read_int(bs, 8);\n\t\t\tptype += v;\n\t\t\tif (v != 0xFF) break;\n\t\t}\n\n\t\tpsize = 0;\n\t\twhile (1) {\n\t\t\tu8 v = gf_bs_read_int(bs, 8);\n\t\t\tpsize += v;\n\t\t\tif (v != 0xFF) break;\n\t\t}\n\n\t\tstart = (u32)gf_bs_get_position(bs);\n\n\t\tdo_copy = 1;\n\n\t\tif (start + psize &gt;= nal_size) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[avc-h264] SEI user message type %d size error (%d but %d remain), keeping full SEI untouched\\n&quot;, ptype, psize, nal_size - start));\n\t\t\tif (bs_dest) gf_bs_del(bs_dest);\n\t\t\tgf_bs_del(bs);\n\t\t\treturn nal_size;\n\t\t}\n\t\tswitch (ptype) {\n\t\t\t/*remove SEI messages forbidden in MP4*/\n\t\tcase 3: /*filler data*/\n\t\tcase 10: /*sub_seq info*/\n\t\tcase 11: /*sub_seq_layer char*/\n\t\tcase 12: /*sub_seq char*/\n\t\t\tdo_copy = 0;\n\t\t\tsei_removed = GF_TRUE;\n\t\t\tbreak;\n\t\tcase 5: /*user unregistered */\n\t\t\tstore = buffer[start + psize];\n\t\t\tbuffer[start + psize] = 0;\n\t\t\tGF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;[avc-h264] SEI user message %s\\n&quot;, buffer + start + 16));\n\t\t\tbuffer[start + psize] = store;\n\t\t\tbreak;\n\n\t\tcase 6: /*recovery point*/\n\t\t\tavc_parse_recovery_point_sei(bs, avc);\n\t\t\tbreak;\n\n\t\tcase 1: /*pic_timing*/\n\t\t\tavc_parse_pic_timing_sei(bs, avc);\n\t\t\tbreak;\n\n\t\tcase 0: /*buffering period*/\n\t\tcase 2: /*pan scan rect*/\n\t\tcase 4: /*user registered ITU t35*/\n\t\tcase 7: /*def_rec_pic_marking_repetition*/\n\t\tcase 8: /*spare_pic*/\n\t\tcase 9: /*scene info*/\n\t\tcase 13: /*full frame freeze*/\n\t\tcase 14: /*full frame freeze release*/\n\t\tcase 15: /*full frame snapshot*/\n\t\tcase 16: /*progressive refinement segment start*/\n\t\tcase 17: /*progressive refinement segment end*/\n\t\tcase 18: /*motion constrained slice group*/\n\t\tdefault: /*add all unknown SEIs*/\n\t\t\tbreak;\n\t\t}\n\n\t\tif (do_copy &amp;&amp; bs_dest) {\n\t\t\tvar = ptype;\n\t\t\twhile (var &gt;= 255) {\n\t\t\t\tgf_bs_write_int(bs_dest, 0xFF, 8);\n\t\t\t\tvar -= 255;\n\t\t\t}\n\t\t\tgf_bs_write_int(bs_dest, var, 8);\n\n\t\t\tvar = psize;\n\t\t\twhile (var &gt;= 255) {\n\t\t\t\tgf_bs_write_int(bs_dest, 0xFF, 8);\n\t\t\t\tvar -= 255;\n\t\t\t}\n\t\t\tgf_bs_write_int(bs_dest, var, 8);\n\t\t\tgf_bs_seek(bs, start);\n\n\t\t\t//bs_read_data does not skip EPB, read byte per byte\n\t\t\tvar = psize;\n\t\t\twhile (var) {\n\t\t\t\tgf_bs_write_u8(bs_dest, gf_bs_read_u8(bs));\n\t\t\t\tvar--;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tgf_bs_seek(bs, start);\n\n\t\t\t//bs_skip_bytes does not skip EPB, skip byte per byte\n\t\t\twhile (psize) {\n\t\t\t\tgf_bs_read_u8(bs);\n\t\t\t\tpsize--;\n\t\t\t}\n\t\t}\n\n\t\tif (gf_bs_available(bs) &lt;= 2) {\n\t\t\tvar = gf_bs_read_int(bs, 8);\n\t\t\tif (var != 0x80) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[avc-h264] SEI user message has less than 2 bytes remaining but no end of sei found, keeping full SEI untouched\\n&quot;));\n\t\t\t\tif (bs_dest) gf_bs_del(bs_dest);\n\t\t\t\tgf_bs_del(bs);\n\t\t\t\treturn nal_size;\n\t\t\t}\n\t\t\tif (bs_dest) gf_bs_write_int(bs_dest, 0x80, 8);\n\t\t\tbreak;\n\t\t}\n\t}\n\tgf_bs_del(bs);\n\t//we cannot compare final size and original size since original may have EPB and final does not yet have them\n\tif (bs_dest &amp;&amp; sei_removed) {\n\t\tu8 *dst_no_epb = NULL;\n\t\tu32 dst_no_epb_size = 0;\n\t\tgf_bs_get_content(bs_dest, &amp;dst_no_epb, &amp;dst_no_epb_size);\n\t\tif (dst_no_epb) {\n\t\t\tu32 nb_bytes_add = gf_media_nalu_emulation_bytes_add_count(dst_no_epb, dst_no_epb_size);\n\t\t\t//if result fits into source buffer, reformat\n\t\t\t//otherwise ignore and return source (happens in some fuzzing cases, cf issue 1903)\n\t\t\tif (dst_no_epb_size + nb_bytes_add &lt;= nal_size)\n\t\t\t\tnal_size = gf_media_nalu_add_emulation_bytes(buffer, dst_no_epb, dst_no_epb_size);\n\n\t\t\tgf_free(dst_no_epb);\n\t\t}\n\t}\n\tif (bs_dest) gf_bs_del(bs_dest);\n\treturn nal_size;\n}\n\nstatic u8 avc_hevc_get_sar_idx(u32 w, u32 h)\n{\n\tu32 i, count = GF_ARRAY_LENGTH(avc_hevc_sar);\n\tfor (i = 0; i &lt; count; i++) {\n\t\tif ((avc_hevc_sar[i].w == w) &amp;&amp; (avc_hevc_sar[i].h == h))\n\t\t\treturn i;\n\t}\n\treturn 0xFF;\n}\n\nstatic void avc_hevc_vvc_rewrite_vui(GF_VUIInfo *vui_info, GF_BitStream *orig, GF_BitStream *mod, GF_CodecID codec)\n{\n\t/* VUI present flag*/\n\tBool vui_present_flag = gf_bs_read_int(orig, 1);\n\n\t/*setup default values*/\n\tBool aspect_ratio_info_present_flag = 0;\n\ts32 aspect_ratio_idc = -1;\n\tu32 ar_n=0, ar_d=0;\n\tBool overscan_info_present_flag = 0;\n\tu32 overscan_info = 0;\n\tu32 video_signal_type_present_flag = 0;\n\tu32 video_format = 5;\n\tu32 video_full_range_flag = 0;\n\tu32 colour_description_present_flag = 0;\n\tu32 colour_primaries = 2;\n\tu32 transfer_characteristics = 2;\n\tu32 matrix_coefficients = 2;\n\t//HEVC\n\tBool neutral_chroma_indication_flag = GF_FALSE;\n\tBool field_seq_flag = GF_FALSE;\n\tBool frame_field_info_present_flag = GF_FALSE;\n\tBool default_display_window_flag = GF_FALSE;\n\tu32 def_disp_win_left_offset = 0;\n\tu32 def_disp_win_right_offset = 0;\n\tu32 def_disp_win_top_offset = 0;\n\tu32 def_disp_win_bottom_offset = 0;\n\t//AVC &amp; HEVC\n\tBool timing_info_present_flag = GF_FALSE;\n\tu32 num_units_in_tick = 0;\n\tu32 time_scale = 0;\n\t//AVC\n\tBool fixed_frame_rate_flag=GF_FALSE;\n\t//HEVC\n\tBool poc_proportional_to_timing_flag = GF_FALSE;\n\tu32 vui_num_ticks_poc_diff_one_minus1 = 0;\n\t//VVC\n\tBool progressive_source_flag = 1;\n\tBool interlaced_source_flag = 0;\n\tBool non_packed_constraint_flag = 0;\n\tBool non_projected_constraint_flag = 0;\n\tBool aspect_ratio_constant_flag = 1;\n\tu32 vui_start_pos = 0;\n\tu32 orig_vvc_payload_size = 0;\n\tBool vui_chroma_loc_info_present_flag = 0;\n\tu32 chroma_loc1=0, chroma_loc2 = 0;\n\tu32 final_vvc_payload_size = 8; //4 first bits + 4 flags (ar, overscan and colour desc, chroma pos)\n\tu32 mod_vui_start_pos = 0;\n\n\t//if VUI is present, read all SAR and overscan values\n\tif (vui_present_flag) { /* VUI found in input bitstream */\n\t\tif (codec == GF_CODECID_VVC) {\n\t\t\t//align\n\t\t\torig_vvc_payload_size = 8 * ( 1 + gf_bs_read_ue(orig) );\n\t\t\tgf_bs_align(orig);\n\t\t\tvui_start_pos = gf_bs_get_bit_offset(orig);\n\n\t\t\tprogressive_source_flag = gf_bs_read_int(orig, 1);\n\t\t\tinterlaced_source_flag = gf_bs_read_int(orig, 1);\n\t\t\tnon_packed_constraint_flag = gf_bs_read_int(orig, 1);\n\t\t\tnon_projected_constraint_flag = gf_bs_read_int(orig, 1);\n\t\t}\n\t\taspect_ratio_info_present_flag = gf_bs_read_int(orig, 1);\n\n\t\tif (aspect_ratio_info_present_flag) {\n\t\t\tif (codec == GF_CODECID_VVC) {\n\t\t\t\taspect_ratio_constant_flag = gf_bs_read_int(orig, 1);\n\t\t\t}\n\t\t\taspect_ratio_idc = gf_bs_read_int(orig, 8); /*aspect_ratio_idc*/\n\t\t\tif (aspect_ratio_idc == 255) {\n\t\t\t\tar_n = gf_bs_read_int(orig, 16); /*sar_width*/\n\t\t\t\tar_d = gf_bs_read_int(orig, 16); /*sar_height*/\n\t\t\t}\n\t\t}\n\n\t\t/*overscan_info_present_flag */\n\t\toverscan_info_present_flag = gf_bs_read_int(orig, 1);\n\t\tif(overscan_info_present_flag) {\n\t\t\toverscan_info = gf_bs_read_int(orig, 1);\n\t\t}\n\n\t\t/* read all video signal related flags first */\n\t\tvideo_signal_type_present_flag = gf_bs_read_int(orig, 1);\n\n\t\tif (video_signal_type_present_flag) {\n\t\t\tif (codec != GF_CODECID_VVC) {\n\t\t\t\tvideo_format = gf_bs_read_int(orig, 3);\n\t\t\t\tvideo_full_range_flag = gf_bs_read_int(orig, 1);\n\t\t\t\tcolour_description_present_flag = gf_bs_read_int(orig, 1);\n\t\t\t} else {\n\t\t\t\tcolour_description_present_flag = 1;\n\t\t\t}\n\n\t\t\tif (colour_description_present_flag) {\n\t\t\t\tcolour_primaries = gf_bs_read_int(orig, 8);\n\t\t\t\ttransfer_characteristics = gf_bs_read_int(orig, 8);\n\t\t\t\tmatrix_coefficients = gf_bs_read_int(orig, 8);\n\t\t\t\tif (codec == GF_CODECID_VVC) {\n\t\t\t\t\tvideo_full_range_flag = gf_bs_read_int(orig, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (codec == GF_CODECID_VVC) {\n\t\t\tvui_chroma_loc_info_present_flag = gf_bs_read_int(orig, 1);\n\t\t\tif (vui_chroma_loc_info_present_flag) {\n\t\t\t\tif (progressive_source_flag &amp;&amp; !interlaced_source_flag) {\n\t\t\t\t\tchroma_loc1 = gf_bs_read_ue(orig);\n\t\t\t\t} else {\n\t\t\t\t\tchroma_loc1 = gf_bs_read_ue(orig);\n\t\t\t\t\tchroma_loc2 = gf_bs_read_ue(orig);\n\t\t\t\t}\n\t\t\t}\n\t\t\t//LAST bit read for VVC\n\t\t} else { //AVC, HEVC\n\t\t\tvui_chroma_loc_info_present_flag = gf_bs_read_int(orig, 1);\n\t\t\tif (vui_chroma_loc_info_present_flag) {\n\t\t\t\tchroma_loc1 = gf_bs_read_ue(orig); //chroma_sample_loc_type_top_field\n\t\t\t\tchroma_loc2 = gf_bs_read_ue(orig); //chroma_sample_loc_type_bottom_field\n\t\t\t}\n\n\t\t\tif (codec == GF_CODECID_HEVC) {\n\t\t\t\tneutral_chroma_indication_flag = gf_bs_read_int(orig, 1);\n\t\t\t\tfield_seq_flag = gf_bs_read_int(orig, 1);\n\t\t\t\tframe_field_info_present_flag = gf_bs_read_int(orig, 1);\n\t\t\t\tdefault_display_window_flag = gf_bs_read_int(orig, 1);\n\t\t\t\tif (default_display_window_flag) {\n\t\t\t\t\tdef_disp_win_left_offset = gf_bs_read_ue(orig);\n\t\t\t\t\tdef_disp_win_right_offset = gf_bs_read_ue(orig);\n\t\t\t\t\tdef_disp_win_top_offset = gf_bs_read_ue(orig);\n\t\t\t\t\tdef_disp_win_bottom_offset = gf_bs_read_ue(orig);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttiming_info_present_flag = gf_bs_read_int(orig, 1);\n\t\t\tif (timing_info_present_flag) {\n\t\t\t\tnum_units_in_tick = gf_bs_read_int(orig, 32);\n\t\t\t\ttime_scale = gf_bs_read_int(orig, 32);\n\t\t\t\tif (codec == GF_CODECID_AVC) {\n\t\t\t\t\tfixed_frame_rate_flag = gf_bs_read_int(orig, 1);\n\n\t\t\t\t\t//LAST bit read for AVC\n\t\t\t\t} else if (codec == GF_CODECID_HEVC) {\n\t\t\t\t\tpoc_proportional_to_timing_flag = gf_bs_read_int(orig, 1);\n\t\t\t\t\tif (poc_proportional_to_timing_flag)\n\t\t\t\t\t\t/*vui_num_ticks_poc_diff_one_minus1 = */gf_bs_read_ue(orig);\n\n\t\t\t\t\t//LAST bit read for HEVC\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t//recompute values\n\t//no change\n\tif ((vui_info-&gt;ar_num&lt;0) || (vui_info-&gt;ar_den&lt;0)) {\n\t}\n\t//remove par\n\telse if ((vui_info-&gt;ar_num==0) || (vui_info-&gt;ar_den==0)) {\n\t\taspect_ratio_info_present_flag = 0;\n\t}\n\t//set par\n\telse {\n\t\taspect_ratio_info_present_flag = 1;\n\t}\n\n\t//add par size\n\tif (aspect_ratio_info_present_flag) {\n\t\tar_n = vui_info-&gt;ar_num;\n\t\tar_d = vui_info-&gt;ar_den;\n\t\taspect_ratio_idc = avc_hevc_get_sar_idx((u32) ar_n, (u32) ar_d);\n\t\tif (codec == GF_CODECID_VVC) {\n\t\t\tfinal_vvc_payload_size += 9;\n\t\t\tif (aspect_ratio_idc==0xFF)\n\t\t\t\tfinal_vvc_payload_size += 32;\n\t\t}\n\t}\n\n\tif (vui_info-&gt;remove_video_info) {\n\t\tvideo_signal_type_present_flag = 0;\n\t}\n\t/* correct the values of each flags */\n\telse if ((vui_info-&gt;fullrange==0) &amp;&amp; (vui_info-&gt;video_format==5) &amp;&amp; (vui_info-&gt;color_prim==2) &amp;&amp; (vui_info-&gt;color_tfc==2) &amp;&amp; (vui_info-&gt;color_matrix==2)) {\n\t\tvideo_signal_type_present_flag = 0; /* all default, nothing to write*/\n\t} else {\n\t\tvideo_signal_type_present_flag = 1;\n\t\tvideo_format = (vui_info-&gt;video_format &lt; 0) ? video_format : vui_info-&gt;video_format;\n\t\tvideo_full_range_flag = (vui_info-&gt;fullrange &lt; 0) ? video_full_range_flag : vui_info-&gt;fullrange;\n\t\tif ((vui_info-&gt;color_prim==2) &amp;&amp; (vui_info-&gt;color_tfc==2) &amp;&amp; (vui_info-&gt;color_matrix==2)) {\n\t\t\tcolour_description_present_flag = 0;\n\t\t} else {\n\t\t\tcolour_description_present_flag = 1;\n\t\t\tcolour_primaries = (vui_info-&gt;color_prim &lt; 0) ? colour_primaries : vui_info-&gt;color_prim;\n\t\t\ttransfer_characteristics = (vui_info-&gt;color_tfc &lt; 0) ? transfer_characteristics : vui_info-&gt;color_tfc;\n\t\t\tmatrix_coefficients = (vui_info-&gt;color_matrix &lt; 0) ? matrix_coefficients : vui_info-&gt;color_matrix;\n\t\t}\n\t\tif ((colour_primaries==2) &amp;&amp; (transfer_characteristics==2) &amp;&amp; (matrix_coefficients==2)) {\n\t\t\tcolour_description_present_flag = 0;\n\t\t\tif ((video_format==5) &amp;&amp; (video_full_range_flag==0))\n\t\t\t\tvideo_signal_type_present_flag = 0;\n\t\t}\n\n\t\tif (codec == GF_CODECID_VVC) {\n\t\t\tif (!video_full_range_flag &amp;&amp; !colour_description_present_flag) {\n\t\t\t\tvideo_signal_type_present_flag = 0;\n\t\t\t} else {\n\t\t\t\tfinal_vvc_payload_size += 25;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ((codec == GF_CODECID_VVC) &amp;&amp; vui_chroma_loc_info_present_flag) {\n\t\tif (progressive_source_flag &amp;&amp; !interlaced_source_flag) {\n\t\t\tfinal_vvc_payload_size += gf_get_ue_nb_bits(chroma_loc1);\n\t\t} else {\n\t\t\tfinal_vvc_payload_size += gf_get_ue_nb_bits(chroma_loc1);\n\t\t\tfinal_vvc_payload_size += gf_get_ue_nb_bits(chroma_loc2);\n\t\t}\n\t}\n\t//remove VUI timing\n\tif (vui_info-&gt;remove_vui_timing_info)\n\t\ttiming_info_present_flag = 0;\n\n\t//always rewrite VUI\n\tgf_bs_write_int(mod, 1, 1);\n\tif (codec == GF_CODECID_VVC) {\n\t\twhile (final_vvc_payload_size%8)\n\t\t\tfinal_vvc_payload_size++;\n\t\tfinal_vvc_payload_size/=8;\n\n\t\tgf_bs_write_ue(mod, final_vvc_payload_size-1);\n\t\tgf_bs_align(mod);\n\t\tmod_vui_start_pos = gf_bs_get_bit_offset(mod);\n\t\tfinal_vvc_payload_size *= 8;\n\n\t\tgf_bs_write_int(mod, progressive_source_flag, 1);\n\t\tgf_bs_write_int(mod, interlaced_source_flag, 1);\n\t\tgf_bs_write_int(mod, non_packed_constraint_flag, 1);\n\t\tgf_bs_write_int(mod, non_projected_constraint_flag, 1);\n\t}\n\n\tgf_bs_write_int(mod, aspect_ratio_info_present_flag, 1);\n\tif (aspect_ratio_info_present_flag) {\n\t\tif (codec == GF_CODECID_VVC)\n\t\t\tgf_bs_write_int(mod, aspect_ratio_constant_flag, 1);\n\n\t\tgf_bs_write_int(mod, aspect_ratio_idc, 8);\n\t\tif (aspect_ratio_idc == 255) {\n\t\t\tgf_bs_write_int(mod, ar_n, 16);\n\t\t\tgf_bs_write_int(mod, ar_d, 16);\n\t\t}\n\t\tif (vui_info-&gt;update) {\n\t\t\tvui_info-&gt;ar_num = ar_n;\n\t\t\tvui_info-&gt;ar_den = ar_d;\n\t\t}\n\t}\n\tgf_bs_write_int(mod, overscan_info_present_flag, 1);\n\tif (overscan_info_present_flag) {\n\t\tgf_bs_write_int(mod, overscan_info, 1);\n\t}\n\n\tgf_bs_write_int(mod, video_signal_type_present_flag, 1);\n\tif (video_signal_type_present_flag) {\n\t\tif (codec != GF_CODECID_VVC) {\n\t\t\tgf_bs_write_int(mod, video_format, 3);\n\t\t\tgf_bs_write_int(mod, video_full_range_flag, 1);\n\t\t\tgf_bs_write_int(mod, colour_description_present_flag, 1);\n\t\t} else {\n\t\t\tcolour_description_present_flag = 1;\n\t\t}\n\n\t\tif (colour_description_present_flag) {\n\t\t\tgf_bs_write_int(mod, colour_primaries, 8);\n\t\t\tgf_bs_write_int(mod, transfer_characteristics, 8);\n\t\t\tgf_bs_write_int(mod, matrix_coefficients, 8);\n\t\t\tif (codec == GF_CODECID_VVC)\n\t\t\t\tgf_bs_write_int(mod, video_full_range_flag, 1);\n\t\t}\n\n\t\tif (vui_info-&gt;update) {\n\t\t\tvui_info-&gt;video_format = video_format;\n\t\t\tvui_info-&gt;fullrange = video_full_range_flag;\n\t\t\tif (colour_description_present_flag) {\n\t\t\t\tvui_info-&gt;color_prim = colour_primaries;\n\t\t\t\tvui_info-&gt;color_tfc = transfer_characteristics;\n\t\t\t\tvui_info-&gt;color_matrix = matrix_coefficients;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (codec == GF_CODECID_VVC) {\n\t\t//write vui_chroma_loc_info_present_flag\n\t\tgf_bs_write_int(mod, vui_chroma_loc_info_present_flag, 1);\n\t\tif (vui_chroma_loc_info_present_flag) {\n\t\t\tif (progressive_source_flag &amp;&amp; !interlaced_source_flag) {\n\t\t\t\tgf_bs_write_ue(mod, chroma_loc1);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_ue(mod, chroma_loc1);\n\t\t\t\tgf_bs_write_ue(mod, chroma_loc2);\n\t\t\t}\n\t\t}\n\t\t//we don&#x27;t copy over vui extension (they&#x27;re not supposed to be present), but we must parse them\n\t\tif (vui_present_flag) {\n\t\t\t//we are byte aligned for vui_paramaters\n\t\t\tBool more_data_in_payload = GF_TRUE;\n\t\t\tvui_start_pos = gf_bs_get_bit_offset(orig) - vui_start_pos;\n\t\t\tif (gf_bs_is_align(orig) &amp;&amp; (vui_start_pos == orig_vvc_payload_size))\n\t\t\t\tmore_data_in_payload = GF_FALSE;\n\n\t\t\tu32 nb_bits = orig_vvc_payload_size - vui_start_pos;\n\t\t\tif (more_data_in_payload) {\n\t\t\t\tif (nb_bits&lt;8) {\n\t\t\t\t\tu32 val = gf_bs_peek_bits(orig, nb_bits, 0);\n\t\t\t\t\tu32 bit_pos = 1&lt;&lt;(nb_bits-1);\n\t\t\t\t\tif (val == bit_pos)\n\t\t\t\t\t\tmore_data_in_payload = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (more_data_in_payload) {\n\t\t\t\twhile (nb_bits) {\n\t\t\t\t\tnb_bits--;\n\t\t\t\t\tgf_bs_read_int(orig, 1); //vui_reserved_payload_extension_data\n\t\t\t\t\t//load next 32 bits, if only 1 at MSB and 0 afterwards, done\n\t\t\t\t\tif (nb_bits&lt;32) {\n\t\t\t\t\t\tu32 val = gf_bs_peek_bits(orig, nb_bits, 0);\n\t\t\t\t\t\tu32 bit_pos = 1&lt;&lt;(nb_bits-1);\n\t\t\t\t\t\tif (val == bit_pos)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//then byte alignment of vui_payload\n\t\t\t\tgf_bs_read_int(orig, 1); //vui_payload_bit_equal_to_one\n\t\t\t\tgf_bs_align(orig);\n\t\t\t}\n\t\t}\n\t\tmod_vui_start_pos = gf_bs_get_bit_offset(mod) - mod_vui_start_pos;\n\t\t//check if we need explicit align\n\t\tif (!gf_bs_is_align(mod) || (mod_vui_start_pos != final_vvc_payload_size)) {\n\t\t\tgf_bs_write_int(mod, 1, 1); //vui_payload_bit_equal_to_one\n\t\t\tgf_bs_align(mod);\n\t\t}\n\t\t//VVC done\n\t\treturn;\n\t}\n\n\t//AVC and HEVC\n\tgf_bs_write_int(mod, vui_chroma_loc_info_present_flag, 1);\n\tif (vui_chroma_loc_info_present_flag) {\n\t\tgf_bs_write_ue(mod, chroma_loc1); //chroma_sample_loc_type_top_field\n\t\tgf_bs_write_ue(mod, chroma_loc2); //chroma_sample_loc_type_bottom_field\n\t}\n\n\tif (codec == GF_CODECID_HEVC) {\n\t\tgf_bs_write_int(mod, neutral_chroma_indication_flag, 1);\n\t\tgf_bs_write_int(mod, field_seq_flag, 1);\n\t\tgf_bs_write_int(mod, frame_field_info_present_flag, 1);\n\t\tgf_bs_write_int(mod, default_display_window_flag, 1);\n\t\tif (default_display_window_flag) {\n\t\t\t gf_bs_write_ue(mod, def_disp_win_left_offset);\n\t\t\t gf_bs_write_ue(mod, def_disp_win_right_offset);\n\t\t\t gf_bs_write_ue(mod, def_disp_win_top_offset);\n\t\t\t gf_bs_write_ue(mod, def_disp_win_bottom_offset);\n\t\t}\n\t}\n\n\tgf_bs_write_int(mod, timing_info_present_flag, 1);\n\tif (timing_info_present_flag) {\n\t\tgf_bs_write_int(mod, num_units_in_tick, 32);\n\t\tgf_bs_write_int(mod, time_scale, 32);\n\t\tif (codec == GF_CODECID_AVC) {\n\t\t\tgf_bs_write_int(mod, fixed_frame_rate_flag, 1);\n\t\t} else if (codec == GF_CODECID_HEVC) {\n\t\t\tgf_bs_write_int(mod, poc_proportional_to_timing_flag, 1);\n\t\t\tif (poc_proportional_to_timing_flag)\n\t\t\t\tgf_bs_write_ue(mod, vui_num_ticks_poc_diff_one_minus1);\n\t\t}\n\t}\n\n\t/*no VUI in input bitstream but we just inserted one, set all remaining vui flags to 0*/\n\tif (!vui_present_flag) {\n\t\tif (codec == GF_CODECID_AVC) {\n\t\t\tgf_bs_write_int(mod, 0, 1);\t\t/*nal_hrd_parameters_present*/\n\t\t\tgf_bs_write_int(mod, 0, 1);\t\t/*vcl_hrd_parameters_present*/\n\t\t\tgf_bs_write_int(mod, 0, 1);\t\t/*pic_struct_present*/\n\t\t\tgf_bs_write_int(mod, 0, 1);\t\t/*bitstream_restriction*/\n\t\t} else if (codec == GF_CODECID_HEVC) {\n\t\t\tif (timing_info_present_flag) {\n\t\t\t\tgf_bs_write_int(mod, 0, 1);\t\t/*vui_hrd_parameters_present_flag*/\n\t\t\t}\n\t\t\tgf_bs_write_int(mod, 0, 1);\t\t/*bitstream_restriction*/\n\t\t}\n\t}\n\t/*otherwise we copy over the bits from the input bitstream*/\n}\n\nGF_Err gf_avc_change_vui(GF_AVCConfig *avcc, GF_VUIInfo *vui_info)\n{\n\tGF_BitStream *orig, *mod;\n\tAVCState avc;\n\tu32 i, bit_offset, flag;\n\ts32 idx;\n\tGF_AVCConfigSlot *slc;\n\torig = NULL;\n\n\tmemset(&amp;avc, 0, sizeof(AVCState));\n\tavc.sps_active_idx = -1;\n\n\ti=0;\n\twhile ((slc = (GF_AVCConfigSlot *)gf_list_enum(avcc-&gt;sequenceParameterSets, &amp;i))) {\n\t\tu8 *no_emulation_buf = NULL;\n\t\tu32 no_emulation_buf_size = 0, emulation_bytes = 0;\n\t\tidx = gf_avc_read_sps(slc-&gt;data, slc-&gt;size, &amp;avc, 0, &amp;bit_offset);\n\t\tif (idx&lt;0) {\n\t\t\tif ( orig )\n\t\t\t\tgf_bs_del(orig);\n\t\t\tcontinue;\n\t\t}\n\n\t\t/*SPS still contains emulation bytes*/\n\t\tno_emulation_buf = gf_malloc((slc-&gt;size - 1) * sizeof(char));\n\t\tno_emulation_buf_size = gf_media_nalu_remove_emulation_bytes(slc-&gt;data + 1, no_emulation_buf, slc-&gt;size - 1);\n\n\t\torig = gf_bs_new(no_emulation_buf, no_emulation_buf_size, GF_BITSTREAM_READ);\n\t\tgf_bs_read_data(orig, no_emulation_buf, no_emulation_buf_size);\n\t\tgf_bs_seek(orig, 0);\n\t\tmod = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\n\t\t/*copy over till vui flag*/\n\t\tassert(bit_offset &gt;= 8);\n\t\twhile (bit_offset - 8/*bit_offset doesn&#x27;t take care of the first byte (NALU type)*/) {\n\t\t\tflag = gf_bs_read_int(orig, 1);\n\t\t\tgf_bs_write_int(mod, flag, 1);\n\t\t\tbit_offset--;\n\t\t}\n\n\t\tavc_hevc_vvc_rewrite_vui(vui_info, orig, mod, GF_CODECID_AVC);\n\n\t\t/*finally copy over remaining*/\n\t\twhile (gf_bs_bits_available(orig)) {\n\t\t\tflag = gf_bs_read_int(orig, 1);\n\t\t\tgf_bs_write_int(mod, flag, 1);\n\t\t}\n\t\tgf_bs_del(orig);\n\t\torig = NULL;\n\t\tgf_free(no_emulation_buf);\n\n\t\t/*set anti-emulation*/\n\t\tgf_bs_get_content(mod, &amp;no_emulation_buf, &amp;flag);\n\t\temulation_bytes = gf_media_nalu_emulation_bytes_add_count(no_emulation_buf, flag);\n\t\tif (flag+emulation_bytes+1&gt;slc-&gt;size)\n\t\t\tslc-&gt;data = (char*)gf_realloc(slc-&gt;data, flag+emulation_bytes+1);\n\t\tslc-&gt;size = gf_media_nalu_add_emulation_bytes(no_emulation_buf, slc-&gt;data + 1, flag) + 1;\n\n\t\tgf_bs_del(mod);\n\t\tgf_free(no_emulation_buf);\n\t}\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_avc_change_par(GF_AVCConfig *avcc, s32 ar_n, s32 ar_d)\n{\n\tGF_VUIInfo vuii;\n\tmemset(&amp;vuii, 0, sizeof(GF_VUIInfo));\n\tvuii.ar_num = ar_n;\n\tvuii.ar_den = ar_d;\n\tvuii.fullrange = -1;\n\tvuii.video_format = -1;\n\tvuii.color_prim = -1;\n\tvuii.color_tfc = -1;\n\tvuii.color_matrix = -1;\n\treturn gf_avc_change_vui(avcc, &amp;vuii);\n}\n\nGF_EXPORT\nGF_Err gf_avc_change_color(GF_AVCConfig *avcc, s32 fullrange, s32 vidformat, s32 colorprim, s32 transfer, s32 colmatrix)\n{\n\tGF_VUIInfo vuii;\n\tmemset(&amp;vuii, 0, sizeof(GF_VUIInfo));\n\tvuii.ar_num = -1;\n\tvuii.ar_den = -1;\n\tvuii.fullrange = fullrange;\n\tvuii.video_format = vidformat;\n\tvuii.color_prim = colorprim;\n\tvuii.color_tfc = transfer;\n\tvuii.color_matrix = colmatrix;\n\treturn gf_avc_change_vui(avcc, &amp;vuii);\n}\n\n\nGF_EXPORT\nGF_Err gf_avc_get_sps_info(u8 *sps_data, u32 sps_size, u32 *sps_id, u32 *width, u32 *height, s32 *par_n, s32 *par_d)\n{\n\tAVCState avc;\n\ts32 idx;\n\tmemset(&amp;avc, 0, sizeof(AVCState));\n\tavc.sps_active_idx = -1;\n\n\tidx = gf_avc_read_sps(sps_data, sps_size, &amp;avc, 0, NULL);\n\tif (idx &lt; 0) {\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\tif (sps_id) *sps_id = idx;\n\n\tif (width) *width = avc.sps[idx].width;\n\tif (height) *height = avc.sps[idx].height;\n\tif (par_n) *par_n = avc.sps[idx].vui.par_num ? avc.sps[idx].vui.par_num : (u32)-1;\n\tif (par_d) *par_d = avc.sps[idx].vui.par_den ? avc.sps[idx].vui.par_den : (u32)-1;\n\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_avc_get_pps_info(u8 *pps_data, u32 pps_size, u32 *pps_id, u32 *sps_id)\n{\n\tGF_BitStream *bs;\n\tGF_Err e = GF_OK;\n\n\tbs = gf_bs_new(pps_data, pps_size, GF_BITSTREAM_READ);\n\tif (!bs) {\n\t\te = GF_NON_COMPLIANT_BITSTREAM;\n\t\tgoto exit;\n\t}\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\t/*nal hdr*/ gf_bs_read_int(bs, 8);\n\n\t*pps_id = gf_bs_read_ue(bs);\n\t*sps_id = gf_bs_read_ue(bs);\n\nexit:\n\tgf_bs_del(bs);\n\treturn e;\n}\n\n#ifndef GPAC_DISABLE_HEVC\n\n/**********\nHEVC parsing\n**********/\n\nBool gf_hevc_slice_is_intra(HEVCState *hevc)\n{\n\tswitch (hevc-&gt;s_info.nal_unit_type) {\n\tcase GF_HEVC_NALU_SLICE_BLA_W_LP:\n\tcase GF_HEVC_NALU_SLICE_BLA_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_BLA_N_LP:\n\tcase GF_HEVC_NALU_SLICE_IDR_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_IDR_N_LP:\n\tcase GF_HEVC_NALU_SLICE_CRA:\n\t\treturn GF_TRUE;\n\tdefault:\n\t\treturn GF_FALSE;\n\t}\n}\n\nBool gf_hevc_slice_is_IDR(HEVCState *hevc)\n{\n\tif (hevc-&gt;sei.recovery_point.valid)\n\t{\n\t\thevc-&gt;sei.recovery_point.valid = 0;\n\t\treturn GF_TRUE;\n\t}\n\tswitch (hevc-&gt;s_info.nal_unit_type) {\n\tcase GF_HEVC_NALU_SLICE_IDR_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_IDR_N_LP:\n\t\treturn GF_TRUE;\n\tdefault:\n\t\treturn GF_FALSE;\n\t}\n}\n\nstatic Bool hevc_parse_short_term_ref_pic_set(GF_BitStream *bs, HEVC_SPS *sps, u32 idx_rps)\n{\n\tu32 i;\n\tBool inter_ref_pic_set_prediction_flag = 0;\n\tif (idx_rps != 0)\n\t\tinter_ref_pic_set_prediction_flag = gf_bs_read_int_log_idx(bs, 1, &quot;inter_ref_pic_set_prediction_flag&quot;, idx_rps);\n\n\tif (inter_ref_pic_set_prediction_flag) {\n\t\tHEVC_ReferencePictureSets *ref_ps, *rps;\n\t\tu32 delta_idx_minus1 = 0;\n\t\tu32 ref_idx;\n\t\tu32 delta_rps_sign;\n\t\tu32 abs_delta_rps_minus1, nb_ref_pics;\n\t\ts32 deltaRPS;\n\t\tu32 k = 0, k0 = 0, k1 = 0;\n\t\tif (idx_rps == sps-&gt;num_short_term_ref_pic_sets)\n\t\t\tdelta_idx_minus1 = gf_bs_read_ue_log_idx(bs, &quot;delta_idx_minus1&quot;, idx_rps);\n\n\t\tassert(delta_idx_minus1 &lt;= idx_rps - 1);\n\t\tref_idx = idx_rps - 1 - delta_idx_minus1;\n\t\tdelta_rps_sign = gf_bs_read_int_log_idx(bs, 1, &quot;delta_rps_sign&quot;, idx_rps);\n\t\tabs_delta_rps_minus1 = gf_bs_read_ue_log_idx(bs, &quot;abs_delta_rps_minus1&quot;, idx_rps);\n\t\tdeltaRPS = (1 - (delta_rps_sign &lt;&lt; 1)) * (abs_delta_rps_minus1 + 1);\n\n\t\trps = &amp;sps-&gt;rps[idx_rps];\n\t\tref_ps = &amp;sps-&gt;rps[ref_idx];\n\t\tnb_ref_pics = ref_ps-&gt;num_negative_pics + ref_ps-&gt;num_positive_pics;\n\t\tfor (i = 0; i &lt;= nb_ref_pics; i++) {\n\t\t\ts32 ref_idc;\n\t\t\ts32 used_by_curr_pic_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;used_by_curr_pic_flag&quot;, idx_rps, i);\n\t\t\tref_idc = used_by_curr_pic_flag ? 1 : 0;\n\t\t\tif (!used_by_curr_pic_flag) {\n\t\t\t\tused_by_curr_pic_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;used_by_curr_pic_flag&quot;, idx_rps, i);\n\t\t\t\tref_idc = used_by_curr_pic_flag &lt;&lt; 1;\n\t\t\t}\n\t\t\tif ((ref_idc == 1) || (ref_idc == 2)) {\n\t\t\t\ts32 deltaPOC = deltaRPS;\n\t\t\t\tif (i &lt; nb_ref_pics)\n\t\t\t\t\tdeltaPOC += ref_ps-&gt;delta_poc[i];\n\n\t\t\t\trps-&gt;delta_poc[k] = deltaPOC;\n\n\t\t\t\tif (deltaPOC &lt; 0)  k0++;\n\t\t\t\telse k1++;\n\n\t\t\t\tk++;\n\t\t\t}\n\t\t}\n\t\trps-&gt;num_negative_pics = k0;\n\t\trps-&gt;num_positive_pics = k1;\n\t}\n\telse {\n\t\ts32 prev = 0, poc;\n\t\tsps-&gt;rps[idx_rps].num_negative_pics = gf_bs_read_ue_log_idx(bs, &quot;num_negative_pics&quot;, idx_rps);\n\t\tsps-&gt;rps[idx_rps].num_positive_pics = gf_bs_read_ue_log_idx(bs, &quot;num_positive_pics&quot;, idx_rps);\n\t\tif (sps-&gt;rps[idx_rps].num_negative_pics &gt; 16)\n\t\t\treturn GF_FALSE;\n\t\tif (sps-&gt;rps[idx_rps].num_positive_pics &gt; 16)\n\t\t\treturn GF_FALSE;\n\t\tfor (i = 0; i &lt; sps-&gt;rps[idx_rps].num_negative_pics; i++) {\n\t\t\tu32 delta_poc_s0_minus1 = gf_bs_read_ue_log_idx2(bs, &quot;delta_poc_s0_minus1&quot;, idx_rps, i);\n\t\t\tpoc = prev - delta_poc_s0_minus1 - 1;\n\t\t\tprev = poc;\n\t\t\tsps-&gt;rps[idx_rps].delta_poc[i] = poc;\n\t\t\tgf_bs_read_int_log_idx2(bs, 1, &quot;delta_poc_s0_minus1&quot;, idx_rps, i);\n\t\t}\n\t\tfor (i = 0; i &lt; sps-&gt;rps[idx_rps].num_positive_pics; i++) {\n\t\t\tu32 delta_poc_s1_minus1 = gf_bs_read_ue_log_idx2(bs, &quot;delta_poc_s1_minus1&quot; , idx_rps, i);\n\t\t\tpoc = prev + delta_poc_s1_minus1 + 1;\n\t\t\tprev = poc;\n\t\t\tsps-&gt;rps[idx_rps].delta_poc[i] = poc;\n\t\t\tgf_bs_read_int_log_idx2(bs, 1, &quot;used_by_curr_pic_s1_flag&quot;, idx_rps, i);\n\t\t}\n\t}\n\treturn GF_TRUE;\n}\n\nvoid hevc_pred_weight_table(GF_BitStream *bs, HEVCState *hevc, HEVCSliceInfo *si, HEVC_PPS *pps, HEVC_SPS *sps, u32 num_ref_idx_l0_active, u32 num_ref_idx_l1_active)\n{\n\tu32 i, num_ref_idx;\n\tBool first_pass = GF_TRUE;\n\tu8 luma_weights[20], chroma_weights[20];\n\tu32 ChromaArrayType = sps-&gt;separate_colour_plane_flag ? 0 : sps-&gt;chroma_format_idc;\n\n\tnum_ref_idx = num_ref_idx_l0_active;\n\n\tgf_bs_read_ue_log(bs, &quot;luma_log2_weight_denom&quot;);\n\tif (ChromaArrayType != 0)\n\t\tgf_bs_read_se_log(bs, &quot;delta_chroma_log2_weight_denom&quot;);\n\nparse_weights:\n\tfor (i = 0; i &lt; num_ref_idx; i++) {\n\t\tluma_weights[i] = gf_bs_read_int_log_idx(bs, 1, &quot;luma_weights&quot;, i);\n\t\t//inferred to be 0 if not present\n\t\tchroma_weights[i] = 0;\n\t}\n\tif (ChromaArrayType != 0) {\n\t\tfor (i = 0; i &lt; num_ref_idx; i++) {\n\t\t\tchroma_weights[i] = gf_bs_read_int_log_idx(bs, 1, &quot;chroma_weights&quot;, i);\n\t\t}\n\t}\n\tfor (i = 0; i &lt; num_ref_idx; i++) {\n\t\tif (luma_weights[i]) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_luma_weight_l0&quot;, i);\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_offset_l0&quot;, i);\n\t\t}\n\t\tif (chroma_weights[i]) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_chroma_weight_l0_0&quot;, i);\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_chroma_offset_l0_0&quot;, i);\n\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_chroma_weight_l0_1&quot;, i);\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_chroma_offset_l0_1&quot;, i);\n\t\t}\n\t}\n\n\tif (si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B) {\n\t\tif (!first_pass) return;\n\t\tfirst_pass = GF_FALSE;\n\t\tnum_ref_idx = num_ref_idx_l1_active;\n\t\tgoto parse_weights;\n\t}\n}\n\nstatic\nBool ref_pic_lists_modification(GF_BitStream *bs, u32 slice_type, u32 num_ref_idx_l0_active, u32 num_ref_idx_l1_active)\n{\n\t//u32 i;\n\tBool ref_pic_list_modification_flag_l0 = gf_bs_read_int_log(bs, 1, &quot;ref_pic_list_modification_flag_l0&quot;);\n\tif (ref_pic_list_modification_flag_l0) {\n\t\t/*for (i=0; i&lt;num_ref_idx_l0_active; i++) {\n\t\t\tlist_entry_l0[i] = *//*gf_bs_read_int(bs, (u32)ceil(log(getNumPicTotalCurr())/log(2)));\n\t\t}*/\n\t\treturn GF_FALSE;\n\t}\n\tif (slice_type == GF_HEVC_SLICE_TYPE_B) {\n\t\tBool ref_pic_list_modification_flag_l1 = gf_bs_read_int_log(bs, 1, &quot;ref_pic_list_modification_flag_l1&quot;);\n\t\tif (ref_pic_list_modification_flag_l1) {\n\t\t\t/*for (i=0; i&lt;num_ref_idx_l1_active; i++) {\n\t\t\t\tlist_entry_l1[i] = *//*gf_bs_read_int(bs, (u32)ceil(log(getNumPicTotalCurr()) / log(2)));\n\t\t\t}*/\n\t\t\treturn GF_FALSE;\n\t\t}\n\t}\n\n\treturn GF_TRUE;\n}\n\nstatic\ns32 hevc_parse_slice_segment(GF_BitStream *bs, HEVCState *hevc, HEVCSliceInfo *si)\n{\n\tu32 i, j;\n\tu32 num_ref_idx_l0_active = 0, num_ref_idx_l1_active = 0;\n\tHEVC_PPS *pps;\n\tHEVC_SPS *sps;\n\ts32 pps_id;\n\tBool RapPicFlag = GF_FALSE;\n\tBool IDRPicFlag = GF_FALSE;\n\n\tsi-&gt;first_slice_segment_in_pic_flag = gf_bs_read_int_log(bs, 1, &quot;first_slice_segment_in_pic_flag&quot;);\n\n\tswitch (si-&gt;nal_unit_type) {\n\tcase GF_HEVC_NALU_SLICE_IDR_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_IDR_N_LP:\n\t\tIDRPicFlag = GF_TRUE;\n\t\tRapPicFlag = GF_TRUE;\n\t\tbreak;\n\tcase GF_HEVC_NALU_SLICE_BLA_W_LP:\n\tcase GF_HEVC_NALU_SLICE_BLA_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_BLA_N_LP:\n\tcase GF_HEVC_NALU_SLICE_CRA:\n\t\tRapPicFlag = GF_TRUE;\n\t\tbreak;\n\t}\n\n\tif (RapPicFlag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;no_output_of_prior_pics_flag&quot;);\n\t}\n\n\tpps_id = gf_bs_read_ue_log(bs, &quot;pps_id&quot;);\n\tif ((pps_id&lt;0) || (pps_id &gt;= 64))\n\t\treturn -1;\n\n\tpps = &amp;hevc-&gt;pps[pps_id];\n\tsps = &amp;hevc-&gt;sps[pps-&gt;sps_id];\n\tsi-&gt;sps = sps;\n\tsi-&gt;pps = pps;\n\n\tif (!si-&gt;first_slice_segment_in_pic_flag &amp;&amp; pps-&gt;dependent_slice_segments_enabled_flag) {\n\t\tsi-&gt;dependent_slice_segment_flag = gf_bs_read_int_log(bs, 1, &quot;dependent_slice_segment_flag&quot;);\n\t}\n\telse {\n\t\tsi-&gt;dependent_slice_segment_flag = GF_FALSE;\n\t}\n\n\tif (!si-&gt;first_slice_segment_in_pic_flag) {\n\t\tsi-&gt;slice_segment_address = gf_bs_read_int_log(bs, sps-&gt;bitsSliceSegmentAddress, &quot;slice_segment_address&quot;);\n\t}\n\telse {\n\t\tsi-&gt;slice_segment_address = 0;\n\t}\n\n\tif (!si-&gt;dependent_slice_segment_flag) {\n\t\tBool deblocking_filter_override_flag = 0;\n\t\tBool slice_temporal_mvp_enabled_flag = 0;\n\t\tBool slice_sao_luma_flag = 0;\n\t\tBool slice_sao_chroma_flag = 0;\n\t\tBool slice_deblocking_filter_disabled_flag = 0;\n\n\t\t//&quot;slice_reserved_undetermined_flag[]&quot;\n\t\tgf_bs_read_int_log(bs, pps-&gt;num_extra_slice_header_bits, &quot;slice_reserved_undetermined_flag&quot;);\n\n\t\tsi-&gt;slice_type = gf_bs_read_ue_log(bs, &quot;slice_type&quot;);\n\n\t\tif (pps-&gt;output_flag_present_flag)\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;pic_output_flag&quot;);\n\n\t\tif (sps-&gt;separate_colour_plane_flag == 1)\n\t\t\tgf_bs_read_int_log(bs, 2, &quot;colour_plane_id&quot;);\n\n\t\tif (IDRPicFlag) {\n\t\t\tsi-&gt;poc_lsb = 0;\n\n\t\t\t//if not asked to parse full header, abort since we know the poc\n\t\t\tif (!hevc-&gt;full_slice_header_parse) return 0;\n\n\t\t}\n\t\telse {\n\t\t\tsi-&gt;poc_lsb = gf_bs_read_int_log(bs, sps-&gt;log2_max_pic_order_cnt_lsb, &quot;poc_lsb&quot;);\n\n\t\t\t//if not asked to parse full header, abort once we have the poc\n\t\t\tif (!hevc-&gt;full_slice_header_parse) return 0;\n\n\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;short_term_ref_pic_set_sps_flag&quot;) == 0) {\n\t\t\t\tBool ret = hevc_parse_short_term_ref_pic_set(bs, sps, sps-&gt;num_short_term_ref_pic_sets);\n\t\t\t\tif (!ret)\n\t\t\t\t\treturn -1;\n\t\t\t}\n\t\t\telse if (sps-&gt;num_short_term_ref_pic_sets &gt; 1) {\n\t\t\t\tu32 numbits = 0;\n\n\t\t\t\twhile ((u32)(1 &lt;&lt; numbits) &lt; sps-&gt;num_short_term_ref_pic_sets)\n\t\t\t\t\tnumbits++;\n\t\t\t\tif (numbits &gt; 0)\n\t\t\t\t\tgf_bs_read_int_log(bs, numbits, &quot;short_term_ref_pic_set_idx&quot;);\n\t\t\t\t/*else\n\t\t\t\t\tshort_term_ref_pic_set_idx = 0;*/\n\t\t\t}\n\t\t\tif (sps-&gt;long_term_ref_pics_present_flag) {\n\t\t\t\tu8 DeltaPocMsbCycleLt[32];\n\t\t\t\tu32 num_long_term_sps = 0;\n\t\t\t\tu32 num_long_term_pics = 0;\n\n\t\t\t\tmemset(DeltaPocMsbCycleLt, 0, sizeof(u8) * 32);\n\t\t\t\t\n\t\t\t\tif (sps-&gt;num_long_term_ref_pic_sps &gt; 0) {\n\t\t\t\t\tnum_long_term_sps = gf_bs_read_ue_log(bs, &quot;num_long_term_sps&quot;);\n\t\t\t\t}\n\t\t\t\tnum_long_term_pics = gf_bs_read_ue_log(bs, &quot;num_long_term_pics&quot;);\n\n\t\t\t\tfor (i = 0; i &lt; num_long_term_sps + num_long_term_pics; i++) {\n\t\t\t\t\tif (i &lt; num_long_term_sps) {\n\t\t\t\t\t\tif (sps-&gt;num_long_term_ref_pic_sps &gt; 1)\n\t\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, gf_get_bit_size(sps-&gt;num_long_term_ref_pic_sps), &quot;lt_idx_sps&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, sps-&gt;log2_max_pic_order_cnt_lsb, &quot;PocLsbLt&quot;, i);\n\t\t\t\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;UsedByCurrPicLt&quot;, i);\n\t\t\t\t\t}\n\t\t\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;delta_poc_msb_present_flag&quot;, i)) {\n\t\t\t\t\t\tif (i == 0 || i == num_long_term_sps)\n\t\t\t\t\t\t\tDeltaPocMsbCycleLt[i] = gf_bs_read_ue_log_idx(bs, &quot;DeltaPocMsbCycleLt&quot;, i);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tDeltaPocMsbCycleLt[i] = gf_bs_read_ue_log_idx(bs, &quot;DeltaPocMsbCycleLt&quot;, i) + DeltaPocMsbCycleLt[i - 1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (sps-&gt;temporal_mvp_enable_flag)\n\t\t\t\tslice_temporal_mvp_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;slice_temporal_mvp_enabled_flag&quot;);\n\t\t}\n\t\tif (sps-&gt;sample_adaptive_offset_enabled_flag) {\n\t\t\tu32 ChromaArrayType = sps-&gt;separate_colour_plane_flag ? 0 : sps-&gt;chroma_format_idc;\n\t\t\tslice_sao_luma_flag = gf_bs_read_int_log(bs, 1, &quot;slice_sao_luma_flag&quot;);\n\t\t\tif (ChromaArrayType != 0)\n\t\t\t\tslice_sao_chroma_flag = gf_bs_read_int_log(bs, 1, &quot;slice_sao_chroma_flag&quot;);\n\t\t}\n\n\t\tif (si-&gt;slice_type == GF_HEVC_SLICE_TYPE_P || si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B) {\n\t\t\t//u32 NumPocTotalCurr;\n\t\t\tnum_ref_idx_l0_active = pps-&gt;num_ref_idx_l0_default_active;\n\t\t\tnum_ref_idx_l1_active = 0;\n\t\t\tif (si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B)\n\t\t\t\tnum_ref_idx_l1_active = pps-&gt;num_ref_idx_l1_default_active;\n\n\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;num_ref_idx_active_override_flag&quot;)) {\n\t\t\t\tnum_ref_idx_l0_active = 1 + gf_bs_read_ue_log(bs, &quot;num_ref_idx_l0_active&quot;);\n\t\t\t\tif (si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B)\n\t\t\t\t\tnum_ref_idx_l1_active = 1 + gf_bs_read_ue_log(bs, &quot;num_ref_idx_l1_active&quot;);\n\t\t\t}\n\n\t\t\tif (pps-&gt;lists_modification_present_flag /*TODO: &amp;&amp; NumPicTotalCurr &gt; 1*/) {\n\t\t\t\tif (!ref_pic_lists_modification(bs, si-&gt;slice_type, num_ref_idx_l0_active, num_ref_idx_l1_active)) {\n\t\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[hevc] ref_pic_lists_modification( ) not implemented\\n&quot;));\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B)\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;mvd_l1_zero_flag&quot;);\n\t\t\tif (pps-&gt;cabac_init_present_flag)\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;cabac_init_flag&quot;);\n\n\t\t\tif (slice_temporal_mvp_enabled_flag) {\n\t\t\t\t// When collocated_from_l0_flag is not present, it is inferred to be equal to 1.\n\t\t\t\tBool collocated_from_l0_flag = 1;\n\t\t\t\tif (si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B)\n\t\t\t\t\tcollocated_from_l0_flag = gf_bs_read_int_log(bs, 1, &quot;collocated_from_l0_flag&quot;);\n\n\t\t\t\tif ((collocated_from_l0_flag &amp;&amp; (num_ref_idx_l0_active &gt; 1))\n\t\t\t\t\t|| (!collocated_from_l0_flag &amp;&amp; (num_ref_idx_l1_active &gt; 1))\n\t\t\t\t) {\n\t\t\t\t\tgf_bs_read_ue_log(bs, &quot;collocated_ref_idx&quot;);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ((pps-&gt;weighted_pred_flag &amp;&amp; si-&gt;slice_type == GF_HEVC_SLICE_TYPE_P)\n\t\t\t\t|| (pps-&gt;weighted_bipred_flag &amp;&amp; si-&gt;slice_type == GF_HEVC_SLICE_TYPE_B)\n\t\t\t\t) {\n\t\t\t\thevc_pred_weight_table(bs, hevc, si, pps, sps, num_ref_idx_l0_active, num_ref_idx_l1_active);\n\t\t\t}\n\t\t\tgf_bs_read_ue_log(bs, &quot;five_minus_max_num_merge_cand&quot;);\n\t\t}\n\t\tsi-&gt;slice_qp_delta_start_bits = (s32) (gf_bs_get_position(bs) - 1) * 8 + gf_bs_get_bit_position(bs);\n\t\tsi-&gt;slice_qp_delta = gf_bs_read_se_log(bs, &quot;slice_qp_delta&quot;);\n\n\t\tif (pps-&gt;slice_chroma_qp_offsets_present_flag) {\n\t\t\tgf_bs_read_se_log(bs, &quot;slice_cb_qp_offset&quot;);\n\t\t\tgf_bs_read_se_log(bs, &quot;slice_cr_qp_offset&quot;);\n\t\t}\n\t\tif (pps-&gt;deblocking_filter_override_enabled_flag) {\n\t\t\tdeblocking_filter_override_flag = gf_bs_read_int_log(bs, 1, &quot;deblocking_filter_override_flag&quot;);\n\t\t}\n\n\t\tif (deblocking_filter_override_flag) {\n\t\t\tslice_deblocking_filter_disabled_flag = gf_bs_read_int_log(bs, 1, &quot;slice_deblocking_filter_disabled_flag&quot;);\n\t\t\tif (!slice_deblocking_filter_disabled_flag) {\n\t\t\t\tgf_bs_read_se_log(bs, &quot;slice_beta_offset_div2&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;slice_tc_offset_div2&quot;);\n\t\t\t}\n\t\t}\n\t\tif (pps-&gt;loop_filter_across_slices_enabled_flag\n\t\t\t&amp;&amp; (slice_sao_luma_flag || slice_sao_chroma_flag || !slice_deblocking_filter_disabled_flag)\n\t\t) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;slice_loop_filter_across_slices_enabled_flag&quot;);\n\t\t}\n\t}\n\t//dependent slice segment\n\telse {\n\t\t//if not asked to parse full header, abort\n\t\tif (!hevc-&gt;full_slice_header_parse) return 0;\n\t}\n\n\tsi-&gt;entry_point_start_bits = ((u32)gf_bs_get_position(bs) - 1) * 8 + gf_bs_get_bit_position(bs);\n\n\tif (pps-&gt;tiles_enabled_flag || pps-&gt;entropy_coding_sync_enabled_flag) {\n\t\tu32 num_entry_point_offsets = gf_bs_read_ue_log(bs, &quot;num_entry_point_offsets&quot;);\n\t\tif (num_entry_point_offsets &gt; 0) {\n\t\t\tu32 offset = gf_bs_read_ue_log(bs, &quot;offset&quot;) + 1;\n\t\t\tu32 segments = offset &gt;&gt; 4;\n\t\t\ts32 remain = (offset &amp; 15);\n\n\t\t\tfor (i = 0; i &lt; num_entry_point_offsets; i++) {\n\t\t\t\t//u32 res = 0;\n\t\t\t\tfor (j = 0; j &lt; segments; j++) {\n\t\t\t\t\t//res &lt;&lt;= 16;\n\t\t\t\t\t/*res +=*/ gf_bs_read_int(bs, 16);\n\t\t\t\t}\n\t\t\t\tif (remain) {\n\t\t\t\t\t//res &lt;&lt;= remain;\n\t\t\t\t\t/* res += */ gf_bs_read_int(bs, remain);\n\t\t\t\t}\n\t\t\t\t// entry_point_offset = val + 1; // +1; // +1 to get the size\n\t\t\t}\n\t\t}\n\t}\n\n\tif (pps-&gt;slice_segment_header_extension_present_flag) {\n\t\tu32 size_ext = gf_bs_read_ue_log(bs, &quot;size_ext&quot;);\n\t\twhile (size_ext) {\n\t\t\tgf_bs_read_int(bs, 8);\n\t\t\tsize_ext--;\n\t\t}\n\t}\n\n\tsi-&gt;header_size_bits = (gf_bs_get_position(bs) - 1) * 8 + gf_bs_get_bit_position(bs); // av_parser.c modified on 16 jan. 2019 \n\n\tif (gf_bs_read_int_log(bs, 1, &quot;byte_align&quot;) == 0) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;Error parsing slice header: byte_align not found at end of header !\\n&quot;));\n\t}\n\n\tgf_bs_align(bs);\n\tsi-&gt;payload_start_offset = (s32)gf_bs_get_position(bs);\n\treturn 0;\n}\n\nstatic void gf_hevc_vvc_parse_sei(char *buffer, u32 nal_size, HEVCState *hevc, VVCState *vvc)\n{\n\tu32 ptype, psize, hdr, i;\n\tu8 *dst_ptr;\n\tu64 start;\n\tGF_BitStream *bs;\n\n\thdr = buffer[0];\n\tif (((hdr &amp; 0x7e) &gt;&gt; 1) != GF_HEVC_NALU_SEI_PREFIX) return;\n\n\tbs = gf_bs_new(buffer, nal_size, GF_BITSTREAM_READ);\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tgf_bs_read_int(bs, 16);\n\n\t/*parse SEI*/\n\twhile (gf_bs_available(bs)) {\n\t\tu32 consumed, nb_zeros;\n\t\tptype = 0;\n\t\twhile (gf_bs_peek_bits(bs, 8, 0)==0xFF) {\n\t\t\tgf_bs_read_int(bs, 8);\n\t\t\tptype += 255;\n\t\t}\n\t\tptype += gf_bs_read_int(bs, 8);\n\t\tpsize = 0;\n\t\twhile (gf_bs_peek_bits(bs, 8, 0)==0xFF) {\n\t\t\tgf_bs_read_int(bs, 8);\n\t\t\tpsize += 255;\n\t\t}\n\t\tpsize += gf_bs_read_int(bs, 8);\n\n\t\tstart = gf_bs_get_position(bs);\n\t\tif (start+psize &gt;= nal_size) {\n\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[%s] SEI user message type %d size error (%d but %d remain), skipping SEI message\\n&quot;, hevc ? &quot;HEVC&quot; : &quot;VVC&quot;, ptype, psize, nal_size-start));\n\t\t\tbreak;\n\t\t}\n\n\t\tnb_zeros = gf_bs_get_emulation_byte_removed(bs);\n\n\t\tswitch (ptype) {\n\t\tcase 4: /*user registered ITU-T T35*/\n\t\t\tif (hevc) {\n\t\t\t\tavc_parse_itu_t_t35_sei(bs, &amp;hevc-&gt;sei.dovi);\n\t\t\t}\n\t\t\tbreak;\n\t\t//clli\n\t\tcase 144:\n\t\t\tdst_ptr = hevc ? hevc-&gt;clli_data : vvc-&gt;clli_data;\n\t\t\t//do not use read data due to possible EPB\n\t\t\tfor (i=0; i&lt;4; i++)\n\t\t\t\tdst_ptr[i] = gf_bs_read_u8(bs);\n\n\t\t\tif (hevc) {\n\t\t\t\thevc-&gt;clli_valid = 1;\n\t\t\t} else {\n\t\t\t\tvvc-&gt;clli_valid = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\t//mdcv\n\t\tcase 137:\n\t\t\tdst_ptr = hevc ? hevc-&gt;mdcv_data : vvc-&gt;mdcv_data;\n\t\t\t//do not use read data due to possible EPB\n\t\t\tfor (i=0; i&lt;24; i++)\n\t\t\t\tdst_ptr[i] = gf_bs_read_u8(bs);\n\n\t\t\tif (hevc) {\n\t\t\t\thevc-&gt;mdcv_valid = 1;\n\t\t\t} else {\n\t\t\t\tvvc-&gt;mdcv_valid = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tnb_zeros = gf_bs_get_emulation_byte_removed(bs) - nb_zeros;\n\n\t\tgf_bs_align(bs);\n\t\tconsumed = (u32) (gf_bs_get_position(bs) - start);\n\t\tconsumed -= nb_zeros;\n\t\tpsize-=consumed;\n\t\t//do not use skip bytes due to possible EPB\n\t\twhile (psize) {\n\t\t\tgf_bs_read_u8(bs);\n\t\t\tpsize--;\n\t\t}\n\t\tif (gf_bs_available(bs) &lt;= 2)\n\t\t\tbreak;\n\t}\n\tgf_bs_del(bs);\n}\n\nvoid gf_hevc_parse_sei(char *buffer, u32 nal_size, HEVCState *hevc)\n{\n\tgf_hevc_vvc_parse_sei(buffer, nal_size, hevc, NULL);\n}\n\nstatic void hevc_compute_poc(HEVCSliceInfo *si)\n{\n\tu32 max_poc_lsb = 1 &lt;&lt; (si-&gt;sps-&gt;log2_max_pic_order_cnt_lsb);\n\n\t/*POC reset for IDR frames, NOT for CRA*/\n\tswitch (si-&gt;nal_unit_type) {\n\tcase GF_HEVC_NALU_SLICE_IDR_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_IDR_N_LP:\n\t\tsi-&gt;poc_lsb_prev = 0;\n\t\tsi-&gt;poc_msb_prev = 0;\n\t\tbreak;\n\t}\n\n\tif ((si-&gt;poc_lsb &lt; si-&gt;poc_lsb_prev) &amp;&amp; (si-&gt;poc_lsb_prev - si-&gt;poc_lsb &gt;= max_poc_lsb / 2))\n\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev + max_poc_lsb;\n\telse if ((si-&gt;poc_lsb &gt; si-&gt;poc_lsb_prev) &amp;&amp; (si-&gt;poc_lsb - si-&gt;poc_lsb_prev &gt; max_poc_lsb / 2))\n\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev - max_poc_lsb;\n\telse\n\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev;\n\n\tswitch (si-&gt;nal_unit_type) {\n\tcase GF_HEVC_NALU_SLICE_BLA_W_LP:\n\tcase GF_HEVC_NALU_SLICE_BLA_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_BLA_N_LP:\n\t\tsi-&gt;poc_msb = 0;\n\t\tbreak;\n\t}\n\tsi-&gt;poc = si-&gt;poc_msb + si-&gt;poc_lsb;\n}\n\n\nstatic Bool hevc_parse_nal_header(GF_BitStream *bs, u8 *nal_unit_type, u8 *temporal_id, u8 *layer_id)\n{\n\tu32 val;\n\tval = gf_bs_read_int_log(bs, 1, &quot;forbidden_zero&quot;);\n\tif (val) return GF_FALSE;\n\n\tval = gf_bs_read_int_log(bs, 6, &quot;nuh_type&quot;);\n\tif (nal_unit_type) *nal_unit_type = val;\n\n\tval = gf_bs_read_int_log(bs, 6, &quot;layerID&quot;);\n\tif (layer_id) *layer_id = val;\n\n\tval = gf_bs_read_int_log(bs, 3, &quot;temporalID&quot;);\n\tif (!val)\n\t\treturn GF_FALSE;\n\tval -= 1;\n\tif (temporal_id) *temporal_id = val;\n\treturn GF_TRUE;\n}\n\n\nvoid hevc_profile_tier_level(GF_BitStream *bs, Bool ProfilePresentFlag, u8 MaxNumSubLayersMinus1, HEVC_ProfileTierLevel *ptl, u32 idx)\n{\n\tu32 i;\n\tif (ProfilePresentFlag) {\n\t\tptl-&gt;profile_space = gf_bs_read_int_log_idx(bs, 2, &quot;profile_space&quot;, idx);\n\t\tptl-&gt;tier_flag = gf_bs_read_int_log_idx(bs, 1, &quot;tier_flag&quot;, idx);\n\t\tptl-&gt;profile_idc = gf_bs_read_int_log_idx(bs, 5, &quot;profile_idc&quot;, idx);\n\n\t\tptl-&gt;profile_compatibility_flag = gf_bs_read_int_log_idx(bs, 32, &quot;profile_compatibility_flag&quot;, idx);\n\n\t\tptl-&gt;general_progressive_source_flag = gf_bs_read_int_log_idx(bs, 1, &quot;general_progressive_source_flag&quot;, idx);\n\t\tptl-&gt;general_interlaced_source_flag = gf_bs_read_int_log_idx(bs, 1, &quot;general_interlaced_source_flag&quot;, idx);\n\t\tptl-&gt;general_non_packed_constraint_flag = gf_bs_read_int_log_idx(bs, 1, &quot;general_non_packed_constraint_flag&quot;, idx);\n\t\tptl-&gt;general_frame_only_constraint_flag = gf_bs_read_int_log_idx(bs, 1, &quot;general_frame_only_constraint_flag&quot;, idx);\n\t\tptl-&gt;general_reserved_44bits = gf_bs_read_long_int(bs, 44);\n\t}\n\tptl-&gt;level_idc = gf_bs_read_int_log(bs, 8, &quot;level_idc&quot;);\n\tfor (i = 0; i &lt; MaxNumSubLayersMinus1; i++) {\n\t\tptl-&gt;sub_ptl[i].profile_present_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;profile_present_flag&quot;, idx, i);\n\t\tptl-&gt;sub_ptl[i].level_present_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;level_present_flag&quot;, idx, i);\n\t}\n\tif (MaxNumSubLayersMinus1 &gt; 0) {\n\t\tfor (i = MaxNumSubLayersMinus1; i &lt; 8; i++) {\n\t\t\t/*reserved_zero_2bits*/gf_bs_read_int(bs, 2);\n\t\t}\n\t}\n\n\tfor (i = 0; i &lt; MaxNumSubLayersMinus1; i++) {\n\t\tif (ptl-&gt;sub_ptl[i].profile_present_flag) {\n\t\t\tptl-&gt;sub_ptl[i].profile_space = gf_bs_read_int_log_idx2(bs, 2, &quot;sublayer_profile_space&quot;, idx, i);\n\t\t\tptl-&gt;sub_ptl[i].tier_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;sublayer_tier_flag&quot;, idx, i);\n\t\t\tptl-&gt;sub_ptl[i].profile_idc = gf_bs_read_int_log_idx2(bs, 5, &quot;sublayer_profile_idc&quot;, idx, i);\n\t\t\tptl-&gt;sub_ptl[i].profile_compatibility_flag = gf_bs_read_int_log_idx2(bs, 32, &quot;sublayer_profile_compatibility_flag&quot;, idx, i);\n\t\t\t/*ptl-&gt;sub_ptl[i].progressive_source_flag =*/ gf_bs_read_int_log_idx2(bs, 1, &quot;sublayer_progressive_source_flag&quot;, idx, i);\n\t\t\t/*ptl-&gt;sub_ptl[i].interlaced_source_flag =*/ gf_bs_read_int_log_idx2(bs, 1, &quot;sublayer_interlaced_source_flag&quot;, idx, i);\n\t\t\t/*ptl-&gt;sub_ptl[i].non_packed_constraint_flag =*/ gf_bs_read_int_log_idx2(bs, 1, &quot;sublayer_non_packed_constraint_flag&quot;, idx, i);\n\t\t\t/*ptl-&gt;sub_ptl[i].frame_only_constraint_flag =*/ gf_bs_read_int_log_idx2(bs, 1, &quot;sublayer_frame_only_constraint_flag&quot;, idx, i);\n\t\t\t/*ptl-&gt;sub_ptl[i].reserved_44bits =*/ gf_bs_read_long_int(bs, 44);\n\t\t}\n\t\tif (ptl-&gt;sub_ptl[i].level_present_flag)\n\t\t\tptl-&gt;sub_ptl[i].level_idc = gf_bs_read_int_log_idx2(bs, 8, &quot;sublayer_level_idc&quot;, idx, i);\n\t}\n}\n\nstatic u32 scalability_type_to_idx(HEVC_VPS *vps, u32 scalability_type)\n{\n\tu32 idx = 0, type;\n\tfor (type = 0; type &lt; scalability_type; type++) {\n\t\tidx += (vps-&gt;scalability_mask[type] ? 1 : 0);\n\t}\n\treturn idx;\n}\n\n#define LHVC_VIEW_ORDER_INDEX  1\n#define LHVC_SCALABILITY_INDEX\t2\n\nstatic u32 lhvc_get_scalability_id(HEVC_VPS *vps, u32 layer_id_in_vps, u32 scalability_type)\n{\n\tu32 idx;\n\tif (!vps-&gt;scalability_mask[scalability_type]) return 0;\n\tidx = scalability_type_to_idx(vps, scalability_type);\n\treturn vps-&gt;dimension_id[layer_id_in_vps][idx];\n}\n\nstatic u32 lhvc_get_view_index(HEVC_VPS *vps, u32 id)\n{\n\treturn lhvc_get_scalability_id(vps, vps-&gt;layer_id_in_vps[id], LHVC_VIEW_ORDER_INDEX);\n}\n\nstatic u32 lhvc_get_num_views(HEVC_VPS *vps)\n{\n\tu32 numViews = 1, i;\n\tfor (i = 0; i &lt; vps-&gt;max_layers; i++) {\n\t\tu32 layer_id = vps-&gt;layer_id_in_nuh[i];\n\t\tif (i &gt; 0 &amp;&amp; (lhvc_get_view_index(vps, layer_id) != lhvc_get_scalability_id(vps, i - 1, LHVC_VIEW_ORDER_INDEX))) {\n\t\t\tnumViews++;\n\t\t}\n\t}\n\treturn numViews;\n}\n\nstatic void lhvc_parse_rep_format(HEVC_RepFormat *fmt, GF_BitStream *bs, u32 idx)\n{\n\tu8 chroma_bitdepth_present_flag;\n\tfmt-&gt;pic_width_luma_samples = gf_bs_read_int_log_idx(bs, 16, &quot;pic_width_luma_samples&quot;, idx);\n\tfmt-&gt;pic_height_luma_samples = gf_bs_read_int_log_idx(bs, 16, &quot;pic_height_luma_samples&quot;, idx);\n\tchroma_bitdepth_present_flag = gf_bs_read_int_log_idx(bs, 1, &quot;chroma_bitdepth_present_flag&quot;, idx);\n\tif (chroma_bitdepth_present_flag) {\n\t\tfmt-&gt;chroma_format_idc = gf_bs_read_int_log_idx(bs, 2, &quot;chroma_format_idc&quot;, idx);\n\n\t\tif (fmt-&gt;chroma_format_idc == 3)\n\t\t\tfmt-&gt;separate_colour_plane_flag = gf_bs_read_int_log_idx(bs, 1, &quot;separate_colour_plane_flag&quot;, idx);\n\t\tfmt-&gt;bit_depth_luma = 8 + gf_bs_read_int_log_idx(bs, 4, &quot;bit_depth_luma_minus8&quot;, idx);\n\t\tfmt-&gt;bit_depth_chroma = 8 + gf_bs_read_int_log_idx(bs, 4, &quot;bit_depth_chroma_minus8&quot;, idx);\n\t}\n\tif (gf_bs_read_int_log_idx(bs, 1, &quot;conformance_window_vps_flag&quot;, idx)) {\n\t\tgf_bs_read_ue_log_idx(bs, &quot;conf_win_vps_left_offset&quot;, idx);\n\t\tgf_bs_read_ue_log_idx(bs, &quot;conf_win_vps_right_offset&quot;, idx);\n\t\tgf_bs_read_ue_log_idx(bs, &quot;conf_win_vps_top_offset&quot;, idx);\n\t\tgf_bs_read_ue_log_idx(bs, &quot;conf_win_vps_bottom_offset&quot;, idx);\n\t}\n}\n\n\nstatic Bool hevc_parse_vps_extension(HEVC_VPS *vps, GF_BitStream *bs)\n{\n\tu8 splitting_flag, vps_nuh_layer_id_present_flag, view_id_len;\n\tu32 i, j, num_scalability_types, num_add_olss, num_add_layer_set, num_indepentdent_layers, nb_bits, default_output_layer_idc = 0;\n\tu8 dimension_id_len[16], dim_bit_offset[16];\n\tu8 /*avc_base_layer_flag, */NumLayerSets, /*default_one_target_output_layer_flag, */rep_format_idx_present_flag, ols_ids_to_ls_idx;\n\tu8 layer_set_idx_for_ols_minus1[MAX_LHVC_LAYERS];\n\tu8 nb_output_layers_in_output_layer_set[MAX_LHVC_LAYERS + 1];\n\tu8 ols_highest_output_layer_id[MAX_LHVC_LAYERS + 1];\n\n\tu32 k, d, r, p, iNuhLId, jNuhLId;\n\tu8 num_direct_ref_layers[64], num_pred_layers[64], num_layers_in_tree_partition[MAX_LHVC_LAYERS];\n\tu8 dependency_flag[MAX_LHVC_LAYERS][MAX_LHVC_LAYERS], id_pred_layers[64][MAX_LHVC_LAYERS];\n\t//\tu8 num_ref_layers[64];\n\t//\tu8 tree_partition_layer_id[MAX_LHVC_LAYERS][MAX_LHVC_LAYERS];\n\t//\tu8 id_ref_layers[64][MAX_LHVC_LAYERS];\n\t//\tu8 id_direct_ref_layers[64][MAX_LHVC_LAYERS];\n\tu8 layer_id_in_list_flag[64];\n\tBool OutputLayerFlag[MAX_LHVC_LAYERS][MAX_LHVC_LAYERS];\n\n\tvps-&gt;vps_extension_found = 1;\n\tif ((vps-&gt;max_layers &gt; 1) &amp;&amp; vps-&gt;base_layer_internal_flag)\n\t\thevc_profile_tier_level(bs, 0, vps-&gt;max_sub_layers - 1, &amp;vps-&gt;ext_ptl[0], 0);\n\n\tsplitting_flag = gf_bs_read_int_log(bs, 1, &quot;splitting_flag&quot;);\n\tnum_scalability_types = 0;\n\tfor (i = 0; i &lt; 16; i++) {\n\t\tvps-&gt;scalability_mask[i] = gf_bs_read_int_log_idx(bs, 1, &quot;scalability_mask&quot;, i);\n\t\tnum_scalability_types += vps-&gt;scalability_mask[i];\n\t}\n\tif (num_scalability_types &gt;= 16) {\n\t\tnum_scalability_types = 16;\n\t}\n\tdimension_id_len[0] = 0;\n\tif (num_scalability_types) {\n\t\tfor (i = 0; i &lt; (num_scalability_types - splitting_flag); i++) {\n\t\t\tdimension_id_len[i] = 1 + gf_bs_read_int_log_idx(bs, 3, &quot;dimension_id_len_minus1&quot;, i);\n\t\t}\n\n\t\tif (splitting_flag) {\n\t\t\tfor (i = 0; i &lt; num_scalability_types; i++) {\n\t\t\t\tdim_bit_offset[i] = 0;\n\t\t\t\tfor (j = 0; j &lt; i; j++)\n\t\t\t\t\tdim_bit_offset[i] += dimension_id_len[j];\n\t\t\t}\n\t\t\tdimension_id_len[num_scalability_types - 1] = 1 + (5 - dim_bit_offset[num_scalability_types - 1]);\n\t\t\tdim_bit_offset[num_scalability_types] = 6;\n\t\t}\n\t}\n\n\tvps_nuh_layer_id_present_flag = gf_bs_read_int_log(bs, 1, &quot;vps_nuh_layer_id_present_flag&quot;);\n\tvps-&gt;layer_id_in_nuh[0] = 0;\n\tvps-&gt;layer_id_in_vps[0] = 0;\n\tfor (i = 1; i &lt; vps-&gt;max_layers; i++) {\n\t\tif (vps_nuh_layer_id_present_flag) {\n\t\t\tvps-&gt;layer_id_in_nuh[i] = gf_bs_read_int_log_idx(bs, 6, &quot;layer_id_in_nuh&quot;, i);\n\t\t}\n\t\telse {\n\t\t\tvps-&gt;layer_id_in_nuh[i] = i;\n\t\t}\n\t\tif (vps-&gt;layer_id_in_nuh[i] &gt; MAX_LHVC_LAYERS) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] %d layers in VPS ext but only %d supported in GPAC\\n&quot;, vps-&gt;layer_id_in_nuh[i], MAX_LHVC_LAYERS));\n\t\t\tvps-&gt;layer_id_in_nuh[i] = 0;\n\t\t\treturn -1;\n\t\t}\n\t\tvps-&gt;layer_id_in_vps[vps-&gt;layer_id_in_nuh[i]] = i;\n\n\t\tif (!splitting_flag) {\n\t\t\tfor (j = 0; j &lt; num_scalability_types; j++) {\n\t\t\t\tvps-&gt;dimension_id[i][j] = gf_bs_read_int_log_idx2(bs, dimension_id_len[j], &quot;dimension_id&quot;, i, j);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (splitting_flag) {\n\t\tfor (i = 0; i &lt; vps-&gt;max_layers; i++)\n\t\t\tfor (j = 0; j &lt; num_scalability_types; j++)\n\t\t\t\tvps-&gt;dimension_id[i][j] = ((vps-&gt;layer_id_in_nuh[i] &amp; ((1 &lt;&lt; dim_bit_offset[j + 1]) - 1)) &gt;&gt; dim_bit_offset[j]);\n\t}\n\telse {\n\t\tfor (j = 0; j &lt; num_scalability_types; j++)\n\t\t\tvps-&gt;dimension_id[0][j] = 0;\n\t}\n\n\tview_id_len = gf_bs_read_int_log(bs, 4, &quot;view_id_len&quot;);\n\tif (view_id_len &gt; 0) {\n\t\tfor (i = 0; i &lt; lhvc_get_num_views(vps); i++) {\n\t\t\tgf_bs_read_int_log_idx(bs, view_id_len, &quot;view_id_val&quot;, i);\n\t\t}\n\t}\n\n\tfor (i = 1; i &lt; vps-&gt;max_layers; i++) {\n\t\tfor (j = 0; j &lt; i; j++) {\n\t\t\tvps-&gt;direct_dependency_flag[i][j] = gf_bs_read_int_log_idx(bs, 1, &quot;direct_dependency_flag&quot;, i);\n\t\t}\n\t}\n\n\t//we do the test on MAX_LHVC_LAYERS and break in the loop to avoid a wrong GCC 4.8 warning on array bounds\n\tfor (i = 0; i &lt; MAX_LHVC_LAYERS; i++) {\n\t\tif (i &gt;= vps-&gt;max_layers) break;\n\t\tfor (j = 0; j &lt; vps-&gt;max_layers; j++) {\n\t\t\tdependency_flag[i][j] = vps-&gt;direct_dependency_flag[i][j];\n\t\t\tfor (k = 0; k &lt; i; k++)\n\t\t\t\tif (vps-&gt;direct_dependency_flag[i][k] &amp;&amp; vps-&gt;direct_dependency_flag[k][j])\n\t\t\t\t\tdependency_flag[i][j] = 1;\n\t\t}\n\t}\n\n\tfor (i = 0; i &lt; vps-&gt;max_layers; i++) {\n\t\tiNuhLId = vps-&gt;layer_id_in_nuh[i];\n\t\td = r = p = 0;\n\t\tfor (j = 0; j &lt; vps-&gt;max_layers; j++) {\n\t\t\tjNuhLId = vps-&gt;layer_id_in_nuh[j];\n\t\t\tif (vps-&gt;direct_dependency_flag[i][j]) {\n\t\t\t\t//\t\t\t\tid_direct_ref_layers[iNuhLId][d] = jNuhLId;\n\t\t\t\td++;\n\t\t\t}\n\t\t\tif (dependency_flag[i][j]) {\n\t\t\t\t//\t\t\t\tid_ref_layers[iNuhLId][r] = jNuhLId;\n\t\t\t\tr++;\n\t\t\t}\n\n\t\t\tif (dependency_flag[j][i])\n\t\t\t\tid_pred_layers[iNuhLId][p++] = jNuhLId;\n\t\t}\n\t\tnum_direct_ref_layers[iNuhLId] = d;\n\t\t//\t\tnum_ref_layers[iNuhLId] = r;\n\t\tnum_pred_layers[iNuhLId] = p;\n\t}\n\n\tmemset(layer_id_in_list_flag, 0, 64 * sizeof(u8));\n\tk = 0; //num_indepentdent_layers\n\tfor (i = 0; i &lt; vps-&gt;max_layers; i++) {\n\t\tiNuhLId = vps-&gt;layer_id_in_nuh[i];\n\t\tif (!num_direct_ref_layers[iNuhLId]) {\n\t\t\tu32 h = 1;\n\t\t\t//tree_partition_layer_id[k][0] = iNuhLId;\n\t\t\tfor (j = 0; j &lt; num_pred_layers[iNuhLId]; j++) {\n\t\t\t\tu32 predLId = id_pred_layers[iNuhLId][j];\n\t\t\t\tif (!layer_id_in_list_flag[predLId]) {\n\t\t\t\t\t//tree_partition_layer_id[k][h++] = predLId;\n\t\t\t\t\tlayer_id_in_list_flag[predLId] = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\tnum_layers_in_tree_partition[k++] = h;\n\t\t}\n\t}\n\tnum_indepentdent_layers = k;\n\n\tnum_add_layer_set = 0;\n\tif (num_indepentdent_layers &gt; 1)\n\t\tnum_add_layer_set = gf_bs_read_ue_log(bs, &quot;num_add_layer_set&quot;);\n\n\tfor (i = 0; i &lt; num_add_layer_set; i++)\n\t\tfor (j = 1; j &lt; num_indepentdent_layers; j++) {\n\t\t\tnb_bits = 1;\n\t\t\twhile ((1 &lt;&lt; nb_bits) &lt; (num_layers_in_tree_partition[j] + 1))\n\t\t\t\tnb_bits++;\n\t\t\tgf_bs_read_int_log_idx2(bs, nb_bits, &quot;highest_layer_idx_plus1&quot;, i, j);\n\t\t}\n\n\n\tif (gf_bs_read_int_log(bs, 1, &quot;vps_sub_layers_max_minus1_present_flag&quot;)) {\n\t\tfor (i = 0; i &lt; vps-&gt;max_layers; i++) {\n\t\t\tgf_bs_read_int_log_idx(bs, 3, &quot;sub_layers_vps_max_minus1&quot;, i);\n\t\t}\n\t}\n\n\tif (gf_bs_read_int_log(bs, 1, &quot;max_tid_ref_present_flag&quot;)) {\n\t\tfor (i = 0; i &lt; (vps-&gt;max_layers - 1); i++) {\n\t\t\tfor (j = i + 1; j &lt; vps-&gt;max_layers; j++) {\n\t\t\t\tif (vps-&gt;direct_dependency_flag[j][i])\n\t\t\t\t\tgf_bs_read_int_log_idx2(bs, 3, &quot;max_tid_il_ref_pics_plus1&quot;, i, j);\n\t\t\t}\n\t\t}\n\t}\n\tgf_bs_read_int_log(bs, 1, &quot;default_ref_layers_active_flag&quot;);\n\n\tvps-&gt;num_profile_tier_level = 1 + gf_bs_read_ue_log(bs, &quot;num_profile_tier_level&quot;);\n\tif (vps-&gt;num_profile_tier_level &gt; MAX_LHVC_LAYERS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Wrong number of PTLs in VPS %d\\n&quot;, vps-&gt;num_profile_tier_level));\n\t\tvps-&gt;num_profile_tier_level = 1;\n\t\treturn GF_FALSE;\n\t}\n\n\tfor (i = vps-&gt;base_layer_internal_flag ? 2 : 1; i &lt; vps-&gt;num_profile_tier_level; i++) {\n\t\tBool vps_profile_present_flag = gf_bs_read_int_log_idx(bs, 1, &quot;vps_profile_present_flag&quot;, i);\n\t\thevc_profile_tier_level(bs, vps_profile_present_flag, vps-&gt;max_sub_layers - 1, &amp;vps-&gt;ext_ptl[i - 1], i-1);\n\t}\n\n\tNumLayerSets = vps-&gt;num_layer_sets + num_add_layer_set;\n\tnum_add_olss = 0;\n\n\tif (NumLayerSets &gt; 1) {\n\t\tnum_add_olss = gf_bs_read_ue_log(bs, &quot;num_add_olss&quot;);\n\t\tdefault_output_layer_idc = gf_bs_read_int_log(bs, 2, &quot;default_output_layer_idc&quot;);\n\t\tdefault_output_layer_idc = default_output_layer_idc &lt; 2 ? default_output_layer_idc : 2;\n\t}\n\tvps-&gt;num_output_layer_sets = num_add_olss + NumLayerSets;\n\n\tif (vps-&gt;num_output_layer_sets &gt; MAX_LHVC_LAYERS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Wrong number of output layer sets in VPS %d, max %d supported\\n&quot;, vps-&gt;num_output_layer_sets, MAX_LHVC_LAYERS));\n\t\tvps-&gt;num_output_layer_sets = 1;\n\t\treturn GF_FALSE;\n\t}\n\n\tlayer_set_idx_for_ols_minus1[0] = 1;\n\tvps-&gt;output_layer_flag[0][0] = 1;\n\n\tfor (i = 0; i &lt; vps-&gt;num_output_layer_sets; i++) {\n\t\tif ((NumLayerSets &gt; 2) &amp;&amp; (i &gt;= NumLayerSets)) {\n\t\t\tnb_bits = 1;\n\t\t\twhile ((1 &lt;&lt; nb_bits) &lt; (NumLayerSets - 1))\n\t\t\t\tnb_bits++;\n\t\t\tlayer_set_idx_for_ols_minus1[i] = gf_bs_read_int_log_idx(bs, nb_bits, &quot;layer_set_idx_for_ols_minus1&quot;, i);\n\t\t}\n\t\telse\n\t\t\tlayer_set_idx_for_ols_minus1[i] = 0;\n\t\tols_ids_to_ls_idx = i &lt; NumLayerSets ? i : layer_set_idx_for_ols_minus1[i] + 1;\n\n\t\tif ((i &gt; (vps-&gt;num_layer_sets - 1)) || (default_output_layer_idc == 2)) {\n\t\t\tfor (j = 0; j &lt; vps-&gt;num_layers_in_id_list[ols_ids_to_ls_idx]; j++)\n\t\t\t\tvps-&gt;output_layer_flag[i][j] = gf_bs_read_int_log_idx2(bs, 1, &quot;output_layer_flag&quot;, i, j);\n\t\t}\n\n\t\tif ((default_output_layer_idc == 0) || (default_output_layer_idc == 1)) {\n\t\t\tfor (j = 0; j &lt; vps-&gt;num_layers_in_id_list[ols_ids_to_ls_idx]; j++) {\n\t\t\t\tif ((default_output_layer_idc == 0) || (vps-&gt;LayerSetLayerIdList[i][j] == vps-&gt;LayerSetLayerIdListMax[i]))\n\t\t\t\t\tOutputLayerFlag[i][j] = GF_TRUE;\n\t\t\t\telse\n\t\t\t\t\tOutputLayerFlag[i][j] = GF_FALSE;\n\t\t\t}\n\t\t}\n\n\t\tfor (j = 0; j &lt; vps-&gt;num_layers_in_id_list[ols_ids_to_ls_idx]; j++) {\n\t\t\tif (OutputLayerFlag[i][j]) {\n\t\t\t\tu32 curLayerID;\n\t\t\t\tvps-&gt;necessary_layers_flag[i][j] = GF_TRUE;\n\t\t\t\tcurLayerID = vps-&gt;LayerSetLayerIdList[i][j];\n\t\t\t\tfor (k = 0; k &lt; j; k++) {\n\t\t\t\t\tu32 refLayerId = vps-&gt;LayerSetLayerIdList[i][k];\n\t\t\t\t\tif (dependency_flag[vps-&gt;layer_id_in_vps[curLayerID]][vps-&gt;layer_id_in_vps[refLayerId]])\n\t\t\t\t\t\tvps-&gt;necessary_layers_flag[i][k] = GF_TRUE;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tvps-&gt;num_necessary_layers[i] = 0;\n\t\tfor (j = 0; j &lt; vps-&gt;num_layers_in_id_list[ols_ids_to_ls_idx]; j++) {\n\t\t\tif (vps-&gt;necessary_layers_flag[i][j])\n\t\t\t\tvps-&gt;num_necessary_layers[i] += 1;\n\t\t}\n\n\t\tif (i == 0) {\n\t\t\tif (vps-&gt;base_layer_internal_flag) {\n\t\t\t\tif (vps-&gt;max_layers &gt; 1)\n\t\t\t\t\tvps-&gt;profile_tier_level_idx[0][0] = 1;\n\t\t\t\telse\n\t\t\t\t\tvps-&gt;profile_tier_level_idx[0][0] = 0;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\tnb_bits = 1;\n\t\twhile ((u32)(1 &lt;&lt; nb_bits) &lt; vps-&gt;num_profile_tier_level)\n\t\t\tnb_bits++;\n\t\tfor (j = 0; j &lt; vps-&gt;num_layers_in_id_list[ols_ids_to_ls_idx]; j++)\n\t\t\tif (vps-&gt;necessary_layers_flag[i][j] &amp;&amp; vps-&gt;num_profile_tier_level)\n\t\t\t\tvps-&gt;profile_tier_level_idx[i][j] = gf_bs_read_int_log_idx2(bs, nb_bits, &quot;profile_tier_level_idx&quot;, i, j);\n\t\t\telse\n\t\t\t\tvps-&gt;profile_tier_level_idx[i][j] = 0;\n\n\n\t\tnb_output_layers_in_output_layer_set[i] = 0;\n\t\tfor (j = 0; j &lt; vps-&gt;num_layers_in_id_list[ols_ids_to_ls_idx]; j++) {\n\t\t\tnb_output_layers_in_output_layer_set[i] += OutputLayerFlag[i][j];\n\t\t\tif (OutputLayerFlag[i][j]) {\n\t\t\t\tols_highest_output_layer_id[i] = vps-&gt;LayerSetLayerIdList[ols_ids_to_ls_idx][j];\n\t\t\t}\n\t\t}\n\t\tif (nb_output_layers_in_output_layer_set[i] == 1 &amp;&amp; ols_highest_output_layer_id[i] &gt; 0)\n\t\t\tvps-&gt;alt_output_layer_flag[i] = gf_bs_read_int_log_idx(bs, 1, &quot;alt_output_layer_flag&quot;, i);\n\t}\n\n\tvps-&gt;num_rep_formats = 1 + gf_bs_read_ue_log(bs, &quot;num_rep_formats_minus1&quot;);\n\tif (vps-&gt;num_rep_formats &gt; 16) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Wrong number of rep formats in VPS %d\\n&quot;, vps-&gt;num_rep_formats));\n\t\tvps-&gt;num_rep_formats = 0;\n\t\treturn GF_FALSE;\n\t}\n\n\tfor (i = 0; i &lt; vps-&gt;num_rep_formats; i++) {\n\t\tlhvc_parse_rep_format(&amp;vps-&gt;rep_formats[i], bs, i);\n\t}\n\tif (vps-&gt;num_rep_formats &gt; 1)\n\t\trep_format_idx_present_flag = gf_bs_read_int_log(bs, 1, &quot;rep_format_idx_present_flag&quot;);\n\telse\n\t\trep_format_idx_present_flag = 0;\n\n\tvps-&gt;rep_format_idx[0] = 0;\n\tnb_bits = 1;\n\twhile ((u32)(1 &lt;&lt; nb_bits) &lt; vps-&gt;num_rep_formats)\n\t\tnb_bits++;\n\tfor (i = vps-&gt;base_layer_internal_flag ? 1 : 0; i &lt; vps-&gt;max_layers; i++) {\n\t\tif (rep_format_idx_present_flag) {\n\t\t\tvps-&gt;rep_format_idx[i] = gf_bs_read_int_log_idx(bs, nb_bits, &quot;rep_format_idx&quot;, i);\n\t\t}\n\t\telse {\n\t\t\tvps-&gt;rep_format_idx[i] = i &lt; vps-&gt;num_rep_formats - 1 ? i : vps-&gt;num_rep_formats - 1;\n\t\t}\n\t}\n\t//TODO - we don&#x27;t use the rest ...\n\n\treturn GF_TRUE;\n}\n\nstatic void sub_layer_hrd_parameters(GF_BitStream *bs, int subLayerId, u32 cpb_cnt, Bool sub_pic_hrd_params_present_flag, u32 idx1, u32 idx2)\n{\n\tu32 i;\n\tif (!gf_bs_available(bs)) return;\n\n\tfor (i = 0; i &lt;= cpb_cnt; i++) {\n\t\tgf_bs_read_ue_log_idx3(bs, &quot;bit_rate_value_minus1&quot;, idx1, idx2, i);\n\t\tgf_bs_read_ue_log_idx3(bs, &quot;cpb_size_value_minus1&quot;, idx1, idx2, i);\n\t\tif (sub_pic_hrd_params_present_flag) {\n\t\t\tgf_bs_read_ue_log_idx3(bs, &quot;cpb_size_du_value_minus1&quot;, idx1, idx2, i);\n\t\t\tgf_bs_read_ue_log_idx3(bs, &quot;bit_rate_du_value_minus1&quot;, idx1, idx2, i);\n\t\t}\n\t\tgf_bs_read_int_log_idx3(bs, 1, &quot;cbr_flag&quot;, idx1, idx2, i);\n\t}\n}\n\nstatic void hevc_parse_hrd_parameters(GF_BitStream *bs, Bool commonInfPresentFlag, int maxNumSubLayersMinus1, u32 idx)\n{\n\tint i;\n\tBool nal_hrd_parameters_present_flag = GF_FALSE;\n\tBool vcl_hrd_parameters_present_flag = GF_FALSE;\n\tBool sub_pic_hrd_params_present_flag = GF_FALSE;\n\n\tif (commonInfPresentFlag) {\n\t\tnal_hrd_parameters_present_flag = gf_bs_read_int_log_idx(bs, 1, &quot;nal_hrd_parameters_present_flag&quot;, idx);\n\t\tvcl_hrd_parameters_present_flag = gf_bs_read_int_log_idx(bs, 1, &quot;vcl_hrd_parameters_present_flag&quot;, idx);\n\t\tif (nal_hrd_parameters_present_flag || vcl_hrd_parameters_present_flag) {\n\t\t\tsub_pic_hrd_params_present_flag = gf_bs_read_int_log_idx(bs, 1, &quot;sub_pic_hrd_params_present_flag&quot;, idx);\n\t\t\tif (sub_pic_hrd_params_present_flag) {\n\t\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;tick_divisor_minus2&quot;, idx);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;du_cpb_removal_delay_increment_length_minus1&quot;, idx);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;sub_pic_cpb_params_in_pic_timing_sei_flag&quot;, idx);\n\t\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;dpb_output_delay_du_length_minus1&quot;, idx);\n\t\t\t}\n\t\t\tgf_bs_read_int_log_idx(bs, 4, &quot;bit_rate_scale&quot;, idx);\n\t\t\tgf_bs_read_int_log_idx(bs, 4, &quot;cpb_size_scale&quot;, idx);\n\t\t\tif (sub_pic_hrd_params_present_flag) {\n\t\t\t\tgf_bs_read_int_log_idx(bs, 4, &quot;cpb_size_du_scale&quot;, idx);\n\t\t\t}\n\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;initial_cpb_removal_delay_length_minus1&quot;, idx);\n\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;au_cpb_removal_delay_length_minus1&quot;, idx);\n\t\t\tgf_bs_read_int_log_idx(bs, 5, &quot;dpb_output_delay_length_minus1&quot;, idx);\n\t\t}\n\t}\n\tfor (i = 0; i &lt;= maxNumSubLayersMinus1; i++) {\n\t\tBool fixed_pic_rate_general_flag_i = gf_bs_read_int_log_idx(bs, 1, &quot;fixed_pic_rate_general_flag&quot;, idx);\n\t\tBool fixed_pic_rate_within_cvs_flag_i = GF_TRUE;\n\t\tBool low_delay_hrd_flag_i = GF_FALSE;\n\t\tu32 cpb_cnt_minus1_i = 0;\n\t\tif (!fixed_pic_rate_general_flag_i) {\n\t\t\tfixed_pic_rate_within_cvs_flag_i = gf_bs_read_int_log_idx(bs, 1, &quot;fixed_pic_rate_within_cvs_flag&quot;, idx);\n\t\t}\n\t\tif (fixed_pic_rate_within_cvs_flag_i)\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;elemental_duration_in_tc_minus1&quot;, idx);\n\t\telse\n\t\t\tlow_delay_hrd_flag_i = gf_bs_read_int_log_idx(bs, 1, &quot;low_delay_hrd_flag&quot;, idx);\n\t\tif (!low_delay_hrd_flag_i) {\n\t\t\tcpb_cnt_minus1_i = gf_bs_read_ue_log_idx(bs, &quot;cpb_cnt_minus1&quot;, idx);\n\t\t}\n\t\tif (nal_hrd_parameters_present_flag) {\n\t\t\tsub_layer_hrd_parameters(bs, i, cpb_cnt_minus1_i, sub_pic_hrd_params_present_flag, idx, i);\n\t\t}\n\t\tif (vcl_hrd_parameters_present_flag) {\n\t\t\tsub_layer_hrd_parameters(bs, i, cpb_cnt_minus1_i, sub_pic_hrd_params_present_flag, idx, i);\n\t\t}\n\t}\n}\n\nstatic s32 gf_hevc_read_vps_bs_internal(GF_BitStream *bs, HEVCState *hevc, Bool stop_at_vps_ext)\n{\n\tu8 vps_sub_layer_ordering_info_present_flag, vps_extension_flag;\n\tu32 i, j;\n\ts32 vps_id;\n\tHEVC_VPS *vps;\n\tu8 layer_id_included_flag[MAX_LHVC_LAYERS][64];\n\n\t//nalu header already parsed\n\tvps_id = gf_bs_read_int_log(bs, 4, &quot;vps_id&quot;);\n\n\tif ((vps_id&lt;0) || (vps_id &gt;= 16)) return -1;\n\n\tvps = &amp;hevc-&gt;vps[vps_id];\n\tvps-&gt;bit_pos_vps_extensions = -1;\n\tif (!vps-&gt;state) {\n\t\tvps-&gt;id = vps_id;\n\t\tvps-&gt;state = 1;\n\t}\n\n\tvps-&gt;base_layer_internal_flag = gf_bs_read_int_log(bs, 1, &quot;base_layer_internal_flag&quot;);\n\tvps-&gt;base_layer_available_flag = gf_bs_read_int_log(bs, 1, &quot;base_layer_available_flag&quot;);\n\tvps-&gt;max_layers = 1 + gf_bs_read_int_log(bs, 6, &quot;max_layers_minus1&quot;);\n\tif (vps-&gt;max_layers &gt; MAX_LHVC_LAYERS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] %d layers in VPS but only %d supported in GPAC\\n&quot;, vps-&gt;max_layers, MAX_LHVC_LAYERS));\n\t\tvps-&gt;max_layers = MAX_LHVC_LAYERS;\n\t\treturn -1;\n\t}\n\tvps-&gt;max_sub_layers = gf_bs_read_int_log(bs, 3, &quot;max_sub_layers_minus1&quot;) + 1;\n\tvps-&gt;temporal_id_nesting = gf_bs_read_int_log(bs, 1, &quot;temporal_id_nesting&quot;);\n\tgf_bs_read_int_log(bs, 16, &quot;vps_reserved_ffff_16bits&quot;);\n\thevc_profile_tier_level(bs, 1, vps-&gt;max_sub_layers - 1, &amp;vps-&gt;ptl, 0);\n\n\tvps_sub_layer_ordering_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;vps_sub_layer_ordering_info_present_flag&quot;);\n\tfor (i = (vps_sub_layer_ordering_info_present_flag ? 0 : vps-&gt;max_sub_layers - 1); i &lt; vps-&gt;max_sub_layers; i++) {\n\t\tgf_bs_read_ue_log_idx(bs, &quot;vps_max_dec_pic_buffering_minus1&quot;, i);\n\t\tgf_bs_read_ue_log_idx(bs, &quot;vps_max_num_reorder_pics&quot;, i);\n\t\tgf_bs_read_ue_log_idx(bs, &quot;vps_max_latency_increase_plus1&quot;, i);\n\t}\n\tvps-&gt;max_layer_id = gf_bs_read_int_log(bs, 6, &quot;max_layer_id&quot;);\n\tif (vps-&gt;max_layer_id &gt;= MAX_LHVC_LAYERS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] VPS max layer ID %u but GPAC only supports %u\\n&quot;, vps-&gt;max_layer_id, MAX_LHVC_LAYERS));\n\t\tvps-&gt;max_layer_id = 0;\n\t\treturn -1;\n\t}\n\tvps-&gt;num_layer_sets = gf_bs_read_ue_log(bs, &quot;num_layer_sets_minus1&quot;) + 1;\n\tif (vps-&gt;num_layer_sets &gt; MAX_LHVC_LAYERS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Wrong number of layer sets in VPS %d\\n&quot;, vps-&gt;num_layer_sets));\n\t\treturn -1;\n\t}\n\tfor (i = 1; i &lt; vps-&gt;num_layer_sets; i++) {\n\t\tfor (j = 0; j &lt;= vps-&gt;max_layer_id; j++) {\n\t\t\tlayer_id_included_flag[i][j] = gf_bs_read_int_log_idx2(bs, 1, &quot;layer_id_included_flag&quot;, i, j);\n\t\t}\n\t}\n\tvps-&gt;num_layers_in_id_list[0] = 1;\n\tfor (i = 1; i &lt; vps-&gt;num_layer_sets; i++) {\n\t\tu32 n, m;\n\t\tn = 0;\n\t\tfor (m = 0; m &lt;= vps-&gt;max_layer_id; m++) {\n\t\t\tif (layer_id_included_flag[i][m]) {\n\t\t\t\tvps-&gt;LayerSetLayerIdList[i][n++] = m;\n\t\t\t\tif (vps-&gt;LayerSetLayerIdListMax[i] &lt; m)\n\t\t\t\t\tvps-&gt;LayerSetLayerIdListMax[i] = m;\n\t\t\t}\n\t\t}\n\t\tvps-&gt;num_layers_in_id_list[i] = n;\n\t}\n\tif (gf_bs_read_int_log(bs, 1, &quot;vps_timing_info_present_flag&quot;)) {\n\t\tu32 vps_num_hrd_parameters;\n\t\tgf_bs_read_int_log(bs, 32, &quot;vps_num_units_in_tick&quot;);\n\t\tgf_bs_read_int_log(bs, 32, &quot;vps_time_scale&quot;);\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;vps_poc_proportional_to_timing_flag&quot;)) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;vps_num_ticks_poc_diff_one_minus1&quot;);\n\t\t}\n\t\tvps_num_hrd_parameters = gf_bs_read_ue_log(bs, &quot;vps_num_hrd_parameters&quot;);\n\t\tfor (i = 0; i &lt; vps_num_hrd_parameters; i++) {\n\t\t\tBool cprms_present_flag = GF_TRUE;\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;hrd_layer_set_idx&quot;, i);\n\t\t\tif (i &gt; 0)\n\t\t\t\tcprms_present_flag = gf_bs_read_int_log(bs, 1, &quot;cprms_present_flag&quot;);\n\t\t\thevc_parse_hrd_parameters(bs, cprms_present_flag, vps-&gt;max_sub_layers - 1, i);\n\t\t}\n\t}\n\tif (stop_at_vps_ext) {\n\t\treturn vps_id;\n\t}\n\n\tvps_extension_flag = gf_bs_read_int_log(bs, 1, &quot;vps_extension_flag&quot;);\n\tif (vps_extension_flag) {\n\t\tBool res;\n\t\tgf_bs_align(bs);\n\t\tres = hevc_parse_vps_extension(vps, bs);\n\t\tif (res != GF_TRUE) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Failed to parse VPS extensions\\n&quot;));\n\t\t\treturn -1;\n\t\t}\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;vps_extension2_flag&quot;)) {\n#if 0\n\t\t\twhile (gf_bs_available(bs)) {\n\t\t\t\t/*vps_extension_data_flag */ gf_bs_read_int(bs, 1);\n\t\t\t}\n#endif\n\n\t\t}\n\t}\n\treturn vps_id;\n}\n\nGF_EXPORT\ns32 gf_hevc_read_vps_ex(u8 *data, u32 *size, HEVCState *hevc, Bool remove_extensions)\n{\n\tGF_BitStream *bs;\n\tchar *data_without_emulation_bytes = NULL;\n\tu32 data_without_emulation_bytes_size = 0;\n\ts32 vps_id = -1;\n\n\t/*still contains emulation bytes*/\n\tdata_without_emulation_bytes_size = remove_extensions ? gf_media_nalu_emulation_bytes_remove_count(data, (*size)) : 0;\n\tif (!data_without_emulation_bytes_size) {\n\t\tbs = gf_bs_new(data, (*size), GF_BITSTREAM_READ);\n\t\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\t}\n\t//when removing VPS ext, we have to get the full buffer without emulation prevention bytes becuase we do a bit-by-bit copy of the vps\n\telse {\n\t\tdata_without_emulation_bytes = gf_malloc((*size) * sizeof(char));\n\t\tdata_without_emulation_bytes_size = gf_media_nalu_remove_emulation_bytes(data, data_without_emulation_bytes, (*size));\n\t\tbs = gf_bs_new(data_without_emulation_bytes, data_without_emulation_bytes_size, GF_BITSTREAM_READ);\n\t}\n\tif (!bs) goto exit;\n\n\n\tif (!hevc_parse_nal_header(bs, NULL, NULL, NULL)) goto exit;\n\n\tvps_id = gf_hevc_read_vps_bs_internal(bs, hevc, remove_extensions);\n\tif (vps_id &lt; 0) goto exit;\n\n\tif (remove_extensions) {\n\t\tu8 *new_vps;\n\t\tu32 new_vps_size, emulation_bytes;\n\t\tu32 bit_pos = gf_bs_get_bit_offset(bs);\n\t\tGF_BitStream *w_bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\t\tgf_bs_seek(bs, 0);\n\t\tgf_bs_write_u8(w_bs, gf_bs_read_u8(bs) );\n\t\tgf_bs_write_u8(w_bs, gf_bs_read_u8(bs) );\n\t\tgf_bs_write_u8(w_bs, gf_bs_read_u8(bs) );\n\t\tgf_bs_write_u8(w_bs, gf_bs_read_u8(bs) );\n\t\tgf_bs_write_u16(w_bs, gf_bs_read_u16(bs) );\n\t\tbit_pos -= 48;\n\t\twhile (bit_pos) {\n\t\t\tu32 v = gf_bs_read_int(bs, 1);\n\t\t\tgf_bs_write_int(w_bs, v, 1);\n\t\t\tbit_pos--;\n\t\t}\n\t\t/*vps extension flag*/\n\t\tgf_bs_write_int(w_bs, 0, 1);\n\t\tnew_vps = NULL;\n\t\tgf_bs_get_content(w_bs, &amp;new_vps, &amp;new_vps_size);\n\t\tgf_bs_del(w_bs);\n\n\t\temulation_bytes = gf_media_nalu_emulation_bytes_add_count(new_vps, new_vps_size);\n\t\tif (emulation_bytes + new_vps_size &gt; *size) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Buffer too small to rewrite VPS - skipping rewrite\\n&quot;));\n\t\t}\n\t\telse {\n\t\t\t*size = gf_media_nalu_add_emulation_bytes(new_vps, data, new_vps_size);\n\t\t}\n\t\tif (new_vps)\n\t\t\tgf_free(new_vps);\n\t}\n\nexit:\n\tif (bs)\n\t\tgf_bs_del(bs);\n\tif (data_without_emulation_bytes) gf_free(data_without_emulation_bytes);\n\treturn vps_id;\n}\n\nGF_EXPORT\ns32 gf_hevc_read_vps(u8 *data, u32 size, HEVCState *hevc)\n{\n\treturn gf_hevc_read_vps_ex(data, &amp;size, hevc, GF_FALSE);\n}\n\nGF_EXPORT\ns32 gf_hevc_read_vps_bs(GF_BitStream *bs, HEVCState *hevc)\n{\n\tif (!bs || !hevc) return -1;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tif (!hevc_parse_nal_header(bs, NULL, NULL, NULL)) return -1;\n\treturn gf_hevc_read_vps_bs_internal(bs, hevc, GF_FALSE);\n}\n\nstatic void hevc_scaling_list_data(GF_BitStream *bs)\n{\n\tu32 i, sizeId, matrixId;\n\tfor (sizeId = 0; sizeId &lt; 4; sizeId++) {\n\t\tfor (matrixId = 0; matrixId &lt; 6; matrixId += (sizeId == 3) ? 3 : 1) {\n\t\t\tu32 idx = sizeId*100 + 10*matrixId;\n\t\t\tu32 scaling_list_pred_mode_flag_sizeId_matrixId = gf_bs_read_int_log_idx(bs, 1, &quot;scaling_list_pred_mode_flag_sizeId_matrixId&quot;, idx);\n\t\t\tif (!scaling_list_pred_mode_flag_sizeId_matrixId) {\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;scaling_list_pred_matrix_id_delta&quot;, idx);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//u32 nextCoef = 8;\n\t\t\t\tu32 coefNum = MIN(64, (1 &lt;&lt; (4 + (sizeId &lt;&lt; 1))));\n\t\t\t\tif (sizeId &gt; 1) {\n\t\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;scaling_list_dc_coef_minus8&quot;, idx);\n\t\t\t\t}\n\t\t\t\tfor (i = 0; i &lt; coefNum; i++) {\n\t\t\t\t\tgf_bs_read_se_log_idx2(bs, &quot;scaling_list_delta_coef&quot;, idx, i);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\n\nstatic const struct {\n\tu32 w, h;\n} hevc_sar[17] =\n{\n\t{ 0,   0 }, { 1,   1 }, { 12, 11 }, { 10, 11 },\n\t{ 16, 11 }, { 40, 33 }, { 24, 11 }, { 20, 11 },\n\t{ 32, 11 }, { 80, 33 }, { 18, 11 }, { 15, 11 },\n\t{ 64, 33 }, { 160,99 }, { 4,3}, { 3,2}, { 2,1}\n};\n\nstatic s32 gf_hevc_read_sps_bs_internal(GF_BitStream *bs, HEVCState *hevc, u8 layer_id, u32 *vui_flag_pos)\n{\n\ts32 vps_id, sps_id = -1;\n\tu32 i, nb_CTUs, depth;\n\tHEVC_SPS *sps;\n\tHEVC_VPS *vps;\n\tHEVC_ProfileTierLevel ptl;\n\tBool multiLayerExtSpsFlag;\n\tu8 sps_ext_or_max_sub_layers_minus1, max_sub_layers_minus1;\n\n\tif (vui_flag_pos) *vui_flag_pos = 0;\n\n\t//nalu header already parsed\n\tvps_id = gf_bs_read_int_log(bs, 4, &quot;vps_id&quot;);\n\tif ((vps_id&lt;0) || (vps_id &gt;= 16)) {\n\t\treturn -1;\n\t}\n\tmemset(&amp;ptl, 0, sizeof(ptl));\n\tmax_sub_layers_minus1 = 0;\n\tsps_ext_or_max_sub_layers_minus1 = 0;\n\tif (layer_id == 0)\n\t\tmax_sub_layers_minus1 = gf_bs_read_int_log(bs, 3, &quot;max_sub_layers_minus1&quot;);\n\telse\n\t\tsps_ext_or_max_sub_layers_minus1 = gf_bs_read_int_log(bs, 3, &quot;sps_ext_or_max_sub_layers_minus1&quot;);\n\tmultiLayerExtSpsFlag = (layer_id != 0) &amp;&amp; (sps_ext_or_max_sub_layers_minus1 == 7);\n\tif (!multiLayerExtSpsFlag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;temporal_id_nesting_flag&quot;);\n\t\thevc_profile_tier_level(bs, 1, max_sub_layers_minus1, &amp;ptl, 0);\n\t}\n\n\tsps_id = gf_bs_read_ue_log(bs, &quot;sps_id&quot;);\n\tif ((sps_id &lt; 0) || (sps_id &gt;= 16)) {\n\t\treturn -1;\n\t}\n\n\tsps = &amp;hevc-&gt;sps[sps_id];\n\tif (!sps-&gt;state) {\n\t\tsps-&gt;state = 1;\n\t\tsps-&gt;id = sps_id;\n\t\tsps-&gt;vps_id = vps_id;\n\t}\n\tsps-&gt;ptl = ptl;\n\tvps = &amp;hevc-&gt;vps[vps_id];\n\tsps-&gt;max_sub_layers_minus1 = 0;\n\tsps-&gt;sps_ext_or_max_sub_layers_minus1 = 0;\n\n\t/* default values */\n\tsps-&gt;colour_primaries = 2;\n\tsps-&gt;transfer_characteristic = 2;\n\tsps-&gt;matrix_coeffs = 2;\n\n\t//sps_rep_format_idx = 0;\n\tif (multiLayerExtSpsFlag) {\n\t\tsps-&gt;update_rep_format_flag = gf_bs_read_int_log(bs, 1, &quot;update_rep_format_flag&quot;);\n\t\tif (sps-&gt;update_rep_format_flag) {\n\t\t\tsps-&gt;rep_format_idx = gf_bs_read_int_log(bs, 8, &quot;rep_format_idx&quot;);\n\t\t} else {\n\t\t\tif (layer_id&lt;MAX_LHVC_LAYERS) {\n\t\t\t\tu32 idx = vps-&gt;layer_id_in_vps[layer_id];\n\t\t\t\tif (idx&lt;=15)\n\t\t\t\t\tsps-&gt;rep_format_idx = vps-&gt;rep_format_idx[idx];\n\t\t\t}\n\t\t}\n\t\tif (sps-&gt;rep_format_idx&gt;15) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Invalid rep_format_idx index %d\\n&quot;, sps-&gt;rep_format_idx));\n\t\t\tsps-&gt;rep_format_idx=0;\n\t\t\treturn -1;\n\t\t}\n\t\tsps-&gt;width = vps-&gt;rep_formats[sps-&gt;rep_format_idx].pic_width_luma_samples;\n\t\tsps-&gt;height = vps-&gt;rep_formats[sps-&gt;rep_format_idx].pic_height_luma_samples;\n\t\tsps-&gt;chroma_format_idc = vps-&gt;rep_formats[sps-&gt;rep_format_idx].chroma_format_idc;\n\t\tsps-&gt;bit_depth_luma = vps-&gt;rep_formats[sps-&gt;rep_format_idx].bit_depth_luma;\n\t\tsps-&gt;bit_depth_chroma = vps-&gt;rep_formats[sps-&gt;rep_format_idx].bit_depth_chroma;\n\t\tsps-&gt;separate_colour_plane_flag = vps-&gt;rep_formats[sps-&gt;rep_format_idx].separate_colour_plane_flag;\n\n\t\t//TODO this is crude ...\n\t\tsps-&gt;ptl = vps-&gt;ext_ptl[0];\n\t}\n\telse {\n\t\tsps-&gt;chroma_format_idc = gf_bs_read_ue_log(bs, &quot;chroma_format_idc&quot;);\n\t\tif (sps-&gt;chroma_format_idc == 3)\n\t\t\tsps-&gt;separate_colour_plane_flag = gf_bs_read_int_log(bs, 1, &quot;separate_colour_plane_flag&quot;);\n\t\tsps-&gt;width = gf_bs_read_ue_log(bs, &quot;width&quot;);\n\t\tsps-&gt;height = gf_bs_read_ue_log(bs, &quot;height&quot;);\n\t\tif ((sps-&gt;cw_flag = gf_bs_read_int_log(bs, 1, &quot;conformance_window_flag&quot;))) {\n\t\t\tu32 SubWidthC, SubHeightC;\n\n\t\t\tif (sps-&gt;chroma_format_idc == 1) {\n\t\t\t\tSubWidthC = SubHeightC = 2;\n\t\t\t}\n\t\t\telse if (sps-&gt;chroma_format_idc == 2) {\n\t\t\t\tSubWidthC = 2;\n\t\t\t\tSubHeightC = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tSubWidthC = SubHeightC = 1;\n\t\t\t}\n\n\t\t\tsps-&gt;cw_left = gf_bs_read_ue_log(bs, &quot;conformance_window_left&quot;);\n\t\t\tsps-&gt;cw_right = gf_bs_read_ue_log(bs, &quot;conformance_window_right&quot;);\n\t\t\tsps-&gt;cw_top = gf_bs_read_ue_log(bs, &quot;conformance_window_top&quot;);\n\t\t\tsps-&gt;cw_bottom = gf_bs_read_ue_log(bs, &quot;conformance_window_bottom&quot;);\n\n\t\t\tsps-&gt;width -= SubWidthC * (sps-&gt;cw_left + sps-&gt;cw_right);\n\t\t\tsps-&gt;height -= SubHeightC * (sps-&gt;cw_top + sps-&gt;cw_bottom);\n\t\t}\n\t\tsps-&gt;bit_depth_luma = 8 + gf_bs_read_ue_log(bs, &quot;bit_depth_luma_minus8&quot;);\n\t\tsps-&gt;bit_depth_chroma = 8 + gf_bs_read_ue_log(bs, &quot;bit_depth_chroma_minus8&quot;);\n\t}\n\n\tsps-&gt;log2_max_pic_order_cnt_lsb = 4 + gf_bs_read_ue_log(bs, &quot;log2_max_pic_order_cnt_lsb_minus4&quot;);\n\tif (sps-&gt;log2_max_pic_order_cnt_lsb&gt;16) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Invalid log2_max_pic_order_cnt_lsb_minus4 %d, max shall be 12\\n&quot;, sps-&gt;log2_max_pic_order_cnt_lsb-4));\n\t\tsps-&gt;log2_max_pic_order_cnt_lsb = 16;\n\t\treturn -1;\n\t}\n\n\tif (!multiLayerExtSpsFlag) {\n\t\tsps-&gt;sub_layer_ordering_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;sub_layer_ordering_info_present_flag&quot;);\n\t\tfor (i = sps-&gt;sub_layer_ordering_info_present_flag ? 0 : sps-&gt;max_sub_layers_minus1; i &lt;= sps-&gt;max_sub_layers_minus1; i++) {\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;max_dec_pic_buffering&quot;, i);\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;num_reorder_pics&quot;, i);\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;max_latency_increase&quot;, i);\n\t\t}\n\t}\n\n\tsps-&gt;log2_min_luma_coding_block_size = 3 + gf_bs_read_ue_log(bs, &quot;log2_min_luma_coding_block_size_minus3&quot;);\n\tsps-&gt;log2_diff_max_min_luma_coding_block_size = gf_bs_read_ue_log(bs, &quot;log2_diff_max_min_luma_coding_block_size&quot;);\n\t//we allow more than in max profile, but make sure we don&#x27;t overflow max CU W/H compute below\n\tif (sps-&gt;log2_min_luma_coding_block_size + sps-&gt;log2_diff_max_min_luma_coding_block_size &gt;= 30) {\n\t\treturn -1;\n\t}\n\tsps-&gt;max_CU_width = (1 &lt;&lt; (sps-&gt;log2_min_luma_coding_block_size + sps-&gt;log2_diff_max_min_luma_coding_block_size));\n\tsps-&gt;max_CU_height = (1 &lt;&lt; (sps-&gt;log2_min_luma_coding_block_size + sps-&gt;log2_diff_max_min_luma_coding_block_size));\n\n\tsps-&gt;log2_min_transform_block_size = 2 + gf_bs_read_ue_log(bs, &quot;log2_min_transform_block_size_minus2&quot;);\n\tsps-&gt;log2_max_transform_block_size = sps-&gt;log2_min_transform_block_size  + gf_bs_read_ue_log(bs, &quot;log2_max_transform_block_size&quot;);\n\n\tdepth = 0;\n\tsps-&gt;max_transform_hierarchy_depth_inter = gf_bs_read_ue_log(bs, &quot;max_transform_hierarchy_depth_inter&quot;);\n\tsps-&gt;max_transform_hierarchy_depth_intra = gf_bs_read_ue_log(bs, &quot;max_transform_hierarchy_depth_intra&quot;);\n\twhile ((u32)(sps-&gt;max_CU_width &gt;&gt; sps-&gt;log2_diff_max_min_luma_coding_block_size) &gt; (u32)(1 &lt;&lt; (sps-&gt;log2_min_transform_block_size + depth)))\n\t{\n\t\tdepth++;\n\t}\n\tsps-&gt;max_CU_depth = sps-&gt;log2_diff_max_min_luma_coding_block_size + depth;\n\n\tnb_CTUs = ((sps-&gt;width + sps-&gt;max_CU_width - 1) / sps-&gt;max_CU_width) * ((sps-&gt;height + sps-&gt;max_CU_height - 1) / sps-&gt;max_CU_height);\n\tsps-&gt;bitsSliceSegmentAddress = 0;\n\twhile (nb_CTUs &gt; (u32)(1 &lt;&lt; sps-&gt;bitsSliceSegmentAddress)) {\n\t\tsps-&gt;bitsSliceSegmentAddress++;\n\t}\n\n\tsps-&gt;scaling_list_enable_flag = gf_bs_read_int_log(bs, 1, &quot;scaling_list_enable_flag&quot;);\n\tif (sps-&gt;scaling_list_enable_flag) {\n\t\tsps-&gt;infer_scaling_list_flag = 0;\n\t\tsps-&gt;scaling_list_ref_layer_id = 0;\n\t\tif (multiLayerExtSpsFlag) {\n\t\t\tsps-&gt;infer_scaling_list_flag = gf_bs_read_int_log(bs, 1, &quot;infer_scaling_list_flag&quot;);\n\t\t}\n\t\tif (sps-&gt;infer_scaling_list_flag) {\n\t\t\tsps-&gt;scaling_list_ref_layer_id = gf_bs_read_int_log(bs, 6, &quot;scaling_list_ref_layer_id&quot;);\n\t\t}\n\t\telse {\n\t\t\tsps-&gt;scaling_list_data_present_flag = gf_bs_read_int_log(bs, 1, &quot;scaling_list_data_present_flag&quot;);\n\t\t\tif (sps-&gt;scaling_list_data_present_flag) {\n\t\t\t\thevc_scaling_list_data(bs);\n\t\t\t}\n\t\t}\n\t}\n\tsps-&gt;asymmetric_motion_partitions_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;asymmetric_motion_partitions_enabled_flag&quot;);\n\tsps-&gt;sample_adaptive_offset_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sample_adaptive_offset_enabled_flag&quot;);\n\tif ( (sps-&gt;pcm_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;pcm_enabled_flag&quot;)) ) {\n\t\tsps-&gt;pcm_sample_bit_depth_luma_minus1 = gf_bs_read_int_log(bs, 4, &quot;pcm_sample_bit_depth_luma_minus1&quot;);\n\t\tsps-&gt;pcm_sample_bit_depth_chroma_minus1 = gf_bs_read_int_log(bs, 4, &quot;pcm_sample_bit_depth_chroma_minus1&quot;);\n\t\tsps-&gt;log2_min_pcm_luma_coding_block_size_minus3 = gf_bs_read_ue_log(bs, &quot;log2_min_pcm_luma_coding_block_size_minus3&quot;);\n\t\tsps-&gt;log2_diff_max_min_pcm_luma_coding_block_size = gf_bs_read_ue_log(bs, &quot;log2_diff_max_min_pcm_luma_coding_block_size&quot;);\n\t\tsps-&gt;pcm_loop_filter_disable_flag = gf_bs_read_int_log(bs, 1, &quot;pcm_loop_filter_disable_flag&quot;);\n\t}\n\tsps-&gt;num_short_term_ref_pic_sets = gf_bs_read_ue_log(bs, &quot;num_short_term_ref_pic_sets&quot;);\n\tif (sps-&gt;num_short_term_ref_pic_sets &gt; 64) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Invalid number of short term reference picture sets %d\\n&quot;, sps-&gt;num_short_term_ref_pic_sets));\n\t\treturn -1;\n\t}\n\n\tfor (i = 0; i &lt; sps-&gt;num_short_term_ref_pic_sets; i++) {\n\t\tBool ret = hevc_parse_short_term_ref_pic_set(bs, sps, i);\n\t\t/*cannot parse short_term_ref_pic_set, skip VUI parsing*/\n\t\tif (!ret) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Invalid short_term_ref_pic_set\\n&quot;));\n\t\t\treturn -1;\n\t\t}\n\t}\n\tsps-&gt;long_term_ref_pics_present_flag = gf_bs_read_int_log(bs, 1, &quot;long_term_ref_pics_present_flag&quot;);\n\tif (sps-&gt;long_term_ref_pics_present_flag) {\n\t\tsps-&gt;num_long_term_ref_pic_sps = gf_bs_read_ue_log(bs, &quot;num_long_term_ref_pic_sps&quot;);\n\t\tfor (i = 0; i &lt; sps-&gt;num_long_term_ref_pic_sps; i++) {\n\t\t\tgf_bs_read_int_log_idx(bs, sps-&gt;log2_max_pic_order_cnt_lsb, &quot;lt_ref_pic_poc_lsb_sps&quot;, i);\n\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;used_by_curr_pic_lt_sps_flag&quot;, i);\n\t\t}\n\t}\n\tsps-&gt;temporal_mvp_enable_flag = gf_bs_read_int_log(bs, 1, &quot;temporal_mvp_enable_flag&quot;);\n\tsps-&gt;strong_intra_smoothing_enable_flag = gf_bs_read_int_log(bs, 1, &quot;strong_intra_smoothing_enable_flag&quot;);\n\n\tif (vui_flag_pos)\n\t\t*vui_flag_pos = (u32)gf_bs_get_bit_offset(bs);\n\n\tif ((sps-&gt;vui_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_parameters_present_flag&quot;)) ) {\n\t\tsps-&gt;aspect_ratio_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;aspect_ratio_info_present_flag&quot;);\n\t\tif (sps-&gt;aspect_ratio_info_present_flag) {\n\t\t\tsps-&gt;sar_idc = gf_bs_read_int_log(bs, 8, &quot;aspect_ratio_idc&quot;);\n\t\t\tif (sps-&gt;sar_idc == 255) {\n\t\t\t\tsps-&gt;sar_width = gf_bs_read_int_log(bs, 16, &quot;aspect_ratio_width&quot;);\n\t\t\t\tsps-&gt;sar_height = gf_bs_read_int_log(bs, 16, &quot;aspect_ratio_height&quot;);\n\t\t\t}\n\t\t\telse if (sps-&gt;sar_idc &lt; 17) {\n\t\t\t\tsps-&gt;sar_width = hevc_sar[sps-&gt;sar_idc].w;\n\t\t\t\tsps-&gt;sar_height = hevc_sar[sps-&gt;sar_idc].h;\n\t\t\t}\n\t\t}\n\n\t\tif ((sps-&gt;overscan_info_present = gf_bs_read_int_log(bs, 1, &quot;overscan_info_present&quot;)))\n\t\t\tsps-&gt;overscan_appropriate = gf_bs_read_int_log(bs, 1, &quot;overscan_appropriate&quot;);\n\n\t\tsps-&gt;video_signal_type_present_flag = gf_bs_read_int_log(bs, 1, &quot;video_signal_type_present_flag&quot;);\n\t\tif (sps-&gt;video_signal_type_present_flag) {\n\t\t\tsps-&gt;video_format = gf_bs_read_int_log(bs, 3, &quot;video_format&quot;);\n\t\t\tsps-&gt;video_full_range_flag = gf_bs_read_int_log(bs, 1, &quot;video_full_range_flag&quot;);\n\t\t\tif ((sps-&gt;colour_description_present_flag = gf_bs_read_int_log(bs, 1, &quot;colour_description_present_flag&quot;))) {\n\t\t\t\tsps-&gt;colour_primaries = gf_bs_read_int_log(bs, 8, &quot;colour_primaries&quot;);\n\t\t\t\tsps-&gt;transfer_characteristic = gf_bs_read_int_log(bs, 8, &quot;transfer_characteristic&quot;);\n\t\t\t\tsps-&gt;matrix_coeffs = gf_bs_read_int_log(bs, 8, &quot;matrix_coefficients&quot;);\n\t\t\t}\n\t\t}\n\n\t\tif ((sps-&gt;chroma_loc_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;chroma_loc_info_present_flag&quot;))) {\n\t\t\tsps-&gt;chroma_sample_loc_type_top_field = gf_bs_read_ue_log(bs, &quot;chroma_sample_loc_type_top_field&quot;);\n\t\t\tsps-&gt;chroma_sample_loc_type_bottom_field = gf_bs_read_ue_log(bs, &quot;chroma_sample_loc_type_bottom_field&quot;);\n\t\t}\n\n\t\tsps-&gt;neutral_chroma_indication_flag = gf_bs_read_int_log(bs, 1, &quot;neutral_chroma_indication_flag&quot;);\n\t\tsps-&gt;field_seq_flag = gf_bs_read_int_log(bs, 1, &quot;field_seq_flag&quot;);\n\t\tsps-&gt;frame_field_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;frame_field_info_present_flag&quot;);\n\n\t\tif ((sps-&gt;default_display_window_flag = gf_bs_read_int_log(bs, 1, &quot;default_display_window_flag&quot;))) {\n\t\t\tsps-&gt;left_offset = gf_bs_read_ue_log(bs, &quot;display_window_left_offset&quot;);\n\t\t\tsps-&gt;right_offset = gf_bs_read_ue_log(bs, &quot;display_window_right_offset&quot;);\n\t\t\tsps-&gt;top_offset = gf_bs_read_ue_log(bs, &quot;display_window_top_offset&quot;);\n\t\t\tsps-&gt;bottom_offset = gf_bs_read_ue_log(bs, &quot;display_window_bottom_offset&quot;);\n\t\t}\n\n\t\tsps-&gt;has_timing_info = gf_bs_read_int_log(bs, 1, &quot;has_timing_info&quot;);\n\t\tif (sps-&gt;has_timing_info) {\n\t\t\tsps-&gt;num_units_in_tick = gf_bs_read_int_log(bs, 32, &quot;num_units_in_tick&quot;);\n\t\t\tsps-&gt;time_scale = gf_bs_read_int_log(bs, 32, &quot;time_scale&quot;);\n\t\t\tsps-&gt;poc_proportional_to_timing_flag = gf_bs_read_int_log(bs, 1, &quot;poc_proportional_to_timing_flag&quot;);\n\t\t\tif (sps-&gt;poc_proportional_to_timing_flag)\n\t\t\t\tsps-&gt;num_ticks_poc_diff_one_minus1 = gf_bs_read_ue_log(bs, &quot;num_ticks_poc_diff_one_minus1&quot;);\n\t\t\tif ((sps-&gt;hrd_parameters_present_flag = gf_bs_read_int_log(bs, 1, &quot;hrd_parameters_present_flag&quot;))) {\n\t\t\t\t//\t\t\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CODING, (&quot;[HEVC] HRD param parsing not implemented\\n&quot;));\n\t\t\t\treturn sps_id;\n\t\t\t}\n\t\t}\n\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;bitstream_restriction_flag&quot;)) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;tiles_fixed_structure_flag&quot;);\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;motion_vectors_over_pic_boundaries_flag&quot;);\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;restricted_ref_pic_lists_flag&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;min_spatial_segmentation_idc&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;max_bytes_per_pic_denom&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;max_bits_per_min_cu_denom&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;log2_max_mv_length_horizontal&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;log2_max_mv_length_vertical&quot;);\n\t\t}\n\t}\n\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_extension_flag&quot;)) {\n#if 0\n\t\twhile (gf_bs_available(bs)) {\n\t\t\t/*sps_extension_data_flag */ gf_bs_read_int(bs, 1);\n\t\t}\n#endif\n\n\t}\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn sps_id;\n}\n\nGF_EXPORT\ns32 gf_hevc_read_sps_ex(char *data, u32 size, HEVCState *hevc, u32 *vui_flag_pos)\n{\n\tGF_BitStream *bs;\n\ts32 sps_id = -1;\n\tu8 layer_id;\n\n\tif (vui_flag_pos) *vui_flag_pos = 0;\n\n\tbs = gf_bs_new(data, size, GF_BITSTREAM_READ);\n\tif (!bs) goto exit;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tif (!hevc_parse_nal_header(bs, NULL, NULL, &amp;layer_id)) goto exit;\n\tsps_id = gf_hevc_read_sps_bs_internal(bs, hevc, layer_id, vui_flag_pos);\n\nexit:\n\tif (bs) gf_bs_del(bs);\n\treturn sps_id;\n}\n\nGF_EXPORT\ns32 gf_hevc_read_sps(u8 *data, u32 size, HEVCState *hevc)\n{\n\treturn gf_hevc_read_sps_ex(data, size, hevc, NULL);\n}\n\nGF_EXPORT\ns32 gf_hevc_read_sps_bs(GF_BitStream *bs, HEVCState *hevc)\n{\n\tu8 layer_id;\n\tif (!bs || !hevc) return -1;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tif (!hevc_parse_nal_header(bs, NULL, NULL, &amp;layer_id)) return -1;\n\treturn gf_hevc_read_sps_bs_internal(bs, hevc, layer_id, NULL);\n}\n\n\nstatic s32 gf_hevc_read_pps_bs_internal(GF_BitStream *bs, HEVCState *hevc)\n{\n\tu32 i;\n\ts32 pps_id;\n\tHEVC_PPS *pps;\n\n\t//NAL header already read\n\tpps_id = gf_bs_read_ue_log(bs, &quot;pps_id&quot;);\n\n\tif ((pps_id &lt; 0) || (pps_id &gt;= 64)) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] wrong PPS ID %d in PPS\\n&quot;, pps_id));\n\t\treturn -1;\n\t}\n\tpps = &amp;hevc-&gt;pps[pps_id];\n\n\tif (!pps-&gt;state) {\n\t\tpps-&gt;id = pps_id;\n\t\tpps-&gt;state = 1;\n\t}\n\tpps-&gt;sps_id = gf_bs_read_ue_log(bs, &quot;sps_id&quot;);\n\tif (((s32)pps-&gt;sps_id&lt;0) || (pps-&gt;sps_id &gt;= 16)) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] wrong SPS ID %d in PPS\\n&quot;, pps-&gt;sps_id));\n\t\tpps-&gt;sps_id=0;\n\t\treturn -1;\n\t}\n\thevc-&gt;sps_active_idx = pps-&gt;sps_id; /*set active sps*/\n\tpps-&gt;dependent_slice_segments_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;dependent_slice_segments_enabled_flag&quot;);\n\n\tpps-&gt;output_flag_present_flag = gf_bs_read_int_log(bs, 1, &quot;output_flag_present_flag&quot;);\n\tpps-&gt;num_extra_slice_header_bits = gf_bs_read_int_log(bs, 3, &quot;num_extra_slice_header_bits&quot;);\n\tpps-&gt;sign_data_hiding_flag = gf_bs_read_int_log(bs, 1, &quot;sign_data_hiding_flag&quot;);\n\tpps-&gt;cabac_init_present_flag = gf_bs_read_int_log(bs, 1, &quot;cabac_init_present_flag&quot;);\n\tpps-&gt;num_ref_idx_l0_default_active = 1 + gf_bs_read_ue_log(bs, &quot;num_ref_idx_l0_default_active&quot;);\n\tpps-&gt;num_ref_idx_l1_default_active = 1 + gf_bs_read_ue_log(bs, &quot;num_ref_idx_l1_default_active&quot;);\n\tpps-&gt;pic_init_qp_minus26 = gf_bs_read_se_log(bs, &quot;pic_init_qp_minus26&quot;);\n\tpps-&gt;constrained_intra_pred_flag = gf_bs_read_int_log(bs, 1, &quot;constrained_intra_pred_flag&quot;);\n\tpps-&gt;transform_skip_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;transform_skip_enabled_flag&quot;);\n\tif ((pps-&gt;cu_qp_delta_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;cu_qp_delta_enabled_flag&quot;)))\n\t\tpps-&gt;diff_cu_qp_delta_depth = gf_bs_read_ue_log(bs, &quot;diff_cu_qp_delta_depth&quot;);\n\n\tpps-&gt;pic_cb_qp_offset = gf_bs_read_se_log(bs, &quot;pic_cb_qp_offset&quot;);\n\tpps-&gt;pic_cr_qp_offset = gf_bs_read_se_log(bs, &quot;pic_cr_qp_offset&quot;);\n\tpps-&gt;slice_chroma_qp_offsets_present_flag = gf_bs_read_int_log(bs, 1, &quot;slice_chroma_qp_offsets_present_flag&quot;);\n\tpps-&gt;weighted_pred_flag = gf_bs_read_int_log(bs, 1, &quot;weighted_pred_flag&quot;);\n\tpps-&gt;weighted_bipred_flag = gf_bs_read_int_log(bs, 1, &quot;weighted_bipred_flag&quot;);\n\tpps-&gt;transquant_bypass_enable_flag = gf_bs_read_int_log(bs, 1, &quot;transquant_bypass_enable_flag&quot;);\n\tpps-&gt;tiles_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;tiles_enabled_flag&quot;);\n\tpps-&gt;entropy_coding_sync_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;entropy_coding_sync_enabled_flag&quot;);\n\tif (pps-&gt;tiles_enabled_flag) {\n\t\tpps-&gt;num_tile_columns = 1 + gf_bs_read_ue_log(bs, &quot;num_tile_columns_minus1&quot;);\n\t\tif (pps-&gt;num_tile_columns &gt; 22) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Invalid num_tile_columns %u\\n&quot;, pps-&gt;num_tile_columns));\n\t\t\treturn -1;\n\t\t}\n\t\tpps-&gt;num_tile_rows = 1 + gf_bs_read_ue_log(bs, &quot;num_tile_rows_minus1&quot;);\n\t\tif (pps-&gt;num_tile_rows &gt; 20) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[HEVC] Invalid num_tile_rows %u\\n&quot;, pps-&gt;num_tile_rows));\n\t\t\treturn -1;\n\t\t}\n\t\tpps-&gt;uniform_spacing_flag = gf_bs_read_int_log(bs, 1, &quot;uniform_spacing_flag&quot;);\n\t\tif (!pps-&gt;uniform_spacing_flag) {\n\t\t\tfor (i = 0; i &lt; pps-&gt;num_tile_columns - 1; i++) {\n\t\t\t\tpps-&gt;column_width[i] = 1 + gf_bs_read_ue_log_idx(bs, &quot;column_width_minus1&quot;, i);\n\t\t\t}\n\t\t\tfor (i = 0; i &lt; pps-&gt;num_tile_rows - 1; i++) {\n\t\t\t\tpps-&gt;row_height[i] = 1 + gf_bs_read_ue_log_idx(bs, &quot;row_height_minus1&quot;, i);\n\t\t\t}\n\t\t}\n\t\tpps-&gt;loop_filter_across_tiles_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;loop_filter_across_tiles_enabled_flag&quot;);\n\t}\n\tpps-&gt;loop_filter_across_slices_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;loop_filter_across_slices_enabled_flag&quot;);\n\tif ((pps-&gt;deblocking_filter_control_present_flag = gf_bs_read_int_log(bs, 1, &quot;deblocking_filter_control_present_flag&quot;))) {\n\t\tpps-&gt;deblocking_filter_override_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;deblocking_filter_override_enabled_flag&quot;);\n\t\tif (! (pps-&gt;pic_disable_deblocking_filter_flag = gf_bs_read_int_log(bs, 1, &quot;pic_disable_deblocking_filter_flag&quot;))) {\n\t\t\tpps-&gt;beta_offset_div2 = gf_bs_read_se_log(bs, &quot;beta_offset_div2&quot;);\n\t\t\tpps-&gt;tc_offset_div2 = gf_bs_read_se_log(bs, &quot;tc_offset_div2&quot;);\n\t\t}\n\t}\n\tif ((pps-&gt;pic_scaling_list_data_present_flag = gf_bs_read_int_log(bs, 1, &quot;pic_scaling_list_data_present_flag&quot;))) {\n\t\thevc_scaling_list_data(bs);\n\t}\n\tpps-&gt;lists_modification_present_flag = gf_bs_read_int_log(bs, 1, &quot;lists_modification_present_flag&quot;);\n\tpps-&gt;log2_parallel_merge_level_minus2 = gf_bs_read_ue_log(bs, &quot;log2_parallel_merge_level_minus2&quot;);\n\tpps-&gt;slice_segment_header_extension_present_flag = gf_bs_read_int_log(bs, 1, &quot;slice_segment_header_extension_present_flag&quot;);\n\tif (gf_bs_read_int_log(bs, 1, &quot;pps_extension_flag&quot;)) {\n#if 0\n\t\twhile (gf_bs_available(bs)) {\n\t\t\t/*pps_extension_data_flag */ gf_bs_read_int(bs, 1);\n\t\t}\n#endif\n\n\t}\n\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn pps_id;\n}\n\n\nGF_EXPORT\ns32 gf_hevc_read_pps(u8 *data, u32 size, HEVCState *hevc)\n{\n\tGF_BitStream *bs;\n\ts32 pps_id = -1;\n\n\tbs = gf_bs_new(data, size, GF_BITSTREAM_READ);\n\tif (!bs) goto exit;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tif (!hevc_parse_nal_header(bs, NULL, NULL, NULL)) goto exit;\n\n\tpps_id = gf_hevc_read_pps_bs_internal(bs, hevc);\n\nexit:\n\tif (bs) gf_bs_del(bs);\n\treturn pps_id;\n}\n\nGF_EXPORT\ns32 gf_hevc_read_pps_bs(GF_BitStream *bs, HEVCState *hevc)\n{\n\tif (!bs || !hevc) return -1;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tif (!hevc_parse_nal_header(bs, NULL, NULL, NULL)) return -1;\n\treturn gf_hevc_read_pps_bs_internal(bs, hevc);\n}\n\nGF_EXPORT\ns32 gf_hevc_parse_nalu_bs(GF_BitStream *bs, HEVCState *hevc, u8 *nal_unit_type, u8 *temporal_id, u8 *layer_id)\n{\n\tBool is_slice = GF_FALSE;\n\ts32 ret = -1;\n\tHEVCSliceInfo n_state;\n\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tif (gf_bs_available(bs)&lt;2) return -1;\n\n\tgf_bs_mark_overflow(bs, GF_TRUE);\n\n\tmemcpy(&amp;n_state, &amp;hevc-&gt;s_info, sizeof(HEVCSliceInfo));\n\tif (!hevc_parse_nal_header(bs, nal_unit_type, temporal_id, layer_id)) return -1;\n\n\tn_state.nal_unit_type = *nal_unit_type;\n\n\tswitch (n_state.nal_unit_type) {\n\tcase GF_HEVC_NALU_ACCESS_UNIT:\n\tcase GF_HEVC_NALU_END_OF_SEQ:\n\tcase GF_HEVC_NALU_END_OF_STREAM:\n\t\tret = 1;\n\t\tbreak;\n\n\t\t/*slice_segment_layer_rbsp*/\n\tcase GF_HEVC_NALU_SLICE_TRAIL_N:\n\tcase GF_HEVC_NALU_SLICE_TRAIL_R:\n\tcase GF_HEVC_NALU_SLICE_TSA_N:\n\tcase GF_HEVC_NALU_SLICE_TSA_R:\n\tcase GF_HEVC_NALU_SLICE_STSA_N:\n\tcase GF_HEVC_NALU_SLICE_STSA_R:\n\tcase GF_HEVC_NALU_SLICE_BLA_W_LP:\n\tcase GF_HEVC_NALU_SLICE_BLA_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_BLA_N_LP:\n\tcase GF_HEVC_NALU_SLICE_IDR_W_DLP:\n\tcase GF_HEVC_NALU_SLICE_IDR_N_LP:\n\tcase GF_HEVC_NALU_SLICE_CRA:\n\tcase GF_HEVC_NALU_SLICE_RADL_N:\n\tcase GF_HEVC_NALU_SLICE_RADL_R:\n\tcase GF_HEVC_NALU_SLICE_RASL_N:\n\tcase GF_HEVC_NALU_SLICE_RASL_R:\n\t\tis_slice = GF_TRUE;\n\t\t/* slice - read the info and compare.*/\n\t\tret = hevc_parse_slice_segment(bs, hevc, &amp;n_state);\n\t\tif (ret &lt; 0) return ret;\n\n\t\thevc_compute_poc(&amp;n_state);\n\n\t\tret = 0;\n\n\t\tif (hevc-&gt;s_info.poc != n_state.poc) {\n\t\t\tret = 1;\n\t\t\tbreak;\n\t\t}\n\t\tif (n_state.first_slice_segment_in_pic_flag) {\n\t\t\tif (!(*layer_id) || (n_state.prev_layer_id_plus1 &amp;&amp; ((*layer_id) &lt;= n_state.prev_layer_id_plus1 - 1))) {\n\t\t\t\tret = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase GF_HEVC_NALU_SEQ_PARAM:\n\t\thevc-&gt;last_parsed_sps_id = gf_hevc_read_sps_bs_internal(bs, hevc, *layer_id, NULL);\n\t\tret = (hevc-&gt;last_parsed_sps_id&gt;=0) ? 0 : -1;\n\t\tbreak;\n\tcase GF_HEVC_NALU_PIC_PARAM:\n\t\thevc-&gt;last_parsed_pps_id = gf_hevc_read_pps_bs_internal(bs, hevc);\n\t\tret = (hevc-&gt;last_parsed_pps_id&gt;=0) ? 0 : -1;\n\t\tbreak;\n\tcase GF_HEVC_NALU_VID_PARAM:\n\t\thevc-&gt;last_parsed_vps_id = gf_hevc_read_vps_bs_internal(bs, hevc, GF_FALSE);\n\t\tret = (hevc-&gt;last_parsed_vps_id&gt;=0) ? 0 : -1;\n\t\tbreak;\n\tdefault:\n\t\tret = 0;\n\t\tbreak;\n\t}\n\n\tif (gf_bs_is_overflow(bs))\n\t\tret = -1;\n\n\t/* save _prev values */\n\tif ((ret&gt;0) &amp;&amp; hevc-&gt;s_info.sps) {\n\t\tn_state.frame_num_offset_prev = hevc-&gt;s_info.frame_num_offset;\n\t\tn_state.frame_num_prev = hevc-&gt;s_info.frame_num;\n\n\t\tn_state.poc_lsb_prev = hevc-&gt;s_info.poc_lsb;\n\t\tn_state.poc_msb_prev = hevc-&gt;s_info.poc_msb;\n\t\tif (is_slice)\n\t\t\tn_state.prev_layer_id_plus1 = *layer_id + 1;\n\t}\n\tif (is_slice) hevc_compute_poc(&amp;n_state);\n\tmemcpy(&amp;hevc-&gt;s_info, &amp;n_state, sizeof(HEVCSliceInfo));\n\n\treturn ret;\n}\n\nGF_EXPORT\ns32 gf_hevc_parse_nalu(u8 *data, u32 size, HEVCState *hevc, u8 *nal_unit_type, u8 *temporal_id, u8 *layer_id)\n{\n\tGF_BitStream *bs = NULL;\n\ts32 ret = -1;\n\n\tif (size&lt;2) return -1;\n\n\tif (!hevc) {\n\t\tif (nal_unit_type) (*nal_unit_type) = (data[0] &amp; 0x7E) &gt;&gt; 1;\n\t\tif (layer_id) {\n\t\t\tu8 id = data[0] &amp; 1;\n\t\t\tid &lt;&lt;= 5;\n\t\t\tid |= (data[1] &gt;&gt; 3) &amp; 0x1F;\n\t\t\t(*layer_id) = id;\n\t\t}\n\t\tif (temporal_id) (*temporal_id) = (data[1] &amp; 0x7);\n\t\treturn -1;\n\t}\n\n\tbs = gf_bs_new(data, size, GF_BITSTREAM_READ);\n\tif (!bs) return -1;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tret = gf_hevc_parse_nalu_bs(bs, hevc, nal_unit_type, temporal_id, layer_id);\n\n\tgf_bs_del(bs);\n\treturn ret;\n}\n\nGF_EXPORT\nGF_Err gf_hevc_change_vui(GF_HEVCConfig *hvcc, GF_VUIInfo *vui_info)\n{\n\tGF_BitStream *orig, *mod;\n\tHEVCState hevc;\n\tu32 i, bit_offset, flag;\n\ts32 idx;\n\tGF_NALUFFParamArray *spss;\n\tGF_NALUFFParam *slc;\n\torig = NULL;\n\n\tmemset(&amp;hevc, 0, sizeof(HEVCState));\n\thevc.sps_active_idx = -1;\n\n\ti = 0;\n\tspss = NULL;\n\twhile ((spss = (GF_NALUFFParamArray *)gf_list_enum(hvcc-&gt;param_array, &amp;i))) {\n\t\tif (spss-&gt;type == GF_HEVC_NALU_SEQ_PARAM)\n\t\t\tbreak;\n\t\tspss = NULL;\n\t}\n\tif (!spss) return GF_NON_COMPLIANT_BITSTREAM;\n\n\ti = 0;\n\twhile ((slc = (GF_NALUFFParam *)gf_list_enum(spss-&gt;nalus, &amp;i))) {\n\t\tu8 *no_emulation_buf;\n\t\tu32 no_emulation_buf_size, emulation_bytes;\n\n\t\t/*SPS may still contains emulation bytes*/\n\t\tno_emulation_buf = gf_malloc((slc-&gt;size) * sizeof(char));\n\t\tno_emulation_buf_size = gf_media_nalu_remove_emulation_bytes(slc-&gt;data, no_emulation_buf, slc-&gt;size);\n\n\t\tidx = gf_hevc_read_sps_ex(no_emulation_buf, no_emulation_buf_size, &amp;hevc, &amp;bit_offset);\n\t\tif (idx &lt; 0) {\n\t\t\tif (orig)\n\t\t\t\tgf_bs_del(orig);\n\t\t\tgf_free(no_emulation_buf);\n\t\t\tcontinue;\n\t\t}\n\n\t\torig = gf_bs_new(no_emulation_buf, no_emulation_buf_size, GF_BITSTREAM_READ);\n\t\tmod = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\n\t\t/*copy over till vui flag*/\n\t\tassert(bit_offset &gt;= 0);\n\t\twhile (bit_offset) {\n\t\t\tflag = gf_bs_read_int(orig, 1);\n\t\t\tgf_bs_write_int(mod, flag, 1);\n\t\t\tbit_offset--;\n\t\t}\n\n\t\tavc_hevc_vvc_rewrite_vui(vui_info, orig, mod, GF_CODECID_HEVC);\n\n\t\t/*finally copy over remaining*/\n\t\twhile (gf_bs_bits_available(orig)) {\n\t\t\tflag = gf_bs_read_int(orig, 1);\n\t\t\tgf_bs_write_int(mod, flag, 1);\n\t\t}\n\t\tgf_bs_del(orig);\n\t\torig = NULL;\n\t\tgf_free(no_emulation_buf);\n\n\t\t/*set anti-emulation*/\n\t\tgf_bs_get_content(mod, &amp;no_emulation_buf, &amp;no_emulation_buf_size);\n\t\temulation_bytes = gf_media_nalu_emulation_bytes_add_count(no_emulation_buf, no_emulation_buf_size);\n\t\tif (no_emulation_buf_size + emulation_bytes &gt; slc-&gt;size)\n\t\t\tslc-&gt;data = (char*)gf_realloc(slc-&gt;data, no_emulation_buf_size + emulation_bytes);\n\n\t\tslc-&gt;size = gf_media_nalu_add_emulation_bytes(no_emulation_buf, slc-&gt;data, no_emulation_buf_size);\n\n\t\tgf_bs_del(mod);\n\t\tgf_free(no_emulation_buf);\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_hevc_change_par(GF_HEVCConfig *hvcc, s32 ar_n, s32 ar_d)\n{\n\tGF_VUIInfo vuii;\n\tmemset(&amp;vuii, 0, sizeof(GF_VUIInfo));\n\tvuii.ar_num = ar_n;\n\tvuii.ar_den = ar_d;\n\tvuii.fullrange = -1;\n\tvuii.video_format = -1;\n\tvuii.color_prim = -1;\n\tvuii.color_tfc = -1;\n\tvuii.color_matrix = -1;\n\treturn gf_hevc_change_vui(hvcc, &amp;vuii);\n}\n\nGF_EXPORT\nGF_Err gf_hevc_change_color(GF_HEVCConfig *hvcc, s32 fullrange, s32 vidformat, s32 colorprim, s32 transfer, s32 colmatrix)\n{\n\tGF_VUIInfo vuii;\n\tmemset(&amp;vuii, 0, sizeof(GF_VUIInfo));\n\tvuii.ar_num = -1;\n\tvuii.ar_den = -1;\n\tvuii.fullrange = fullrange;\n\tvuii.video_format = vidformat;\n\tvuii.color_prim = colorprim;\n\tvuii.color_tfc = transfer;\n\tvuii.color_matrix = colmatrix;\n\treturn gf_hevc_change_vui(hvcc, &amp;vuii);\n}\n\n\nGF_EXPORT\nGF_Err gf_hevc_get_sps_info_with_state(HEVCState *hevc, u8 *sps_data, u32 sps_size, u32 *sps_id, u32 *width, u32 *height, s32 *par_n, s32 *par_d)\n{\n\ts32 idx;\n\tidx = gf_hevc_read_sps(sps_data, sps_size, hevc);\n\tif (idx &lt; 0) {\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\tif (sps_id) *sps_id = idx;\n\n\tif (width) *width = hevc-&gt;sps[idx].width;\n\tif (height) *height = hevc-&gt;sps[idx].height;\n\tif (par_n) *par_n = hevc-&gt;sps[idx].aspect_ratio_info_present_flag ? hevc-&gt;sps[idx].sar_width : (u32)-1;\n\tif (par_d) *par_d = hevc-&gt;sps[idx].aspect_ratio_info_present_flag ? hevc-&gt;sps[idx].sar_height : (u32)-1;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_hevc_get_sps_info(u8 *sps_data, u32 sps_size, u32 *sps_id, u32 *width, u32 *height, s32 *par_n, s32 *par_d)\n{\n\tHEVCState hevc;\n\tmemset(&amp;hevc, 0, sizeof(HEVCState));\n\thevc.sps_active_idx = -1;\n\treturn gf_hevc_get_sps_info_with_state(&amp;hevc, sps_data, sps_size, sps_id, width, height, par_n, par_d);\n}\n\n\n#endif //GPAC_DISABLE_HEVC\n\nstatic u32 AC3_FindSyncCode(u8 *buf, u32 buflen)\n{\n\tu32 end = buflen - 6;\n\tu32 offset = 0;\n\twhile (offset &lt;= end) {\n\t\tif (buf[offset] == 0x0b &amp;&amp; buf[offset + 1] == 0x77) {\n\t\t\treturn offset;\n\t\t}\n\t\toffset++;\n\t}\n\treturn buflen;\n}\n\n\nstatic Bool AC3_FindSyncCodeBS(GF_BitStream *bs)\n{\n\tu8 b1;\n\tif (gf_bs_available(bs)&lt;6) return GF_FALSE;\n\tu64 pos = gf_bs_get_position(bs);\n\tu64 end = gf_bs_get_size(bs);\n\n\tpos += 1;\n\tb1 = gf_bs_read_u8(bs);\n\twhile (pos + 1 &lt;= end) {\n\t\tu8 b2 = gf_bs_read_u8(bs);\n\t\tif ((b1 == 0x0b) &amp;&amp; (b2 == 0x77)) {\n\t\t\tgf_bs_seek(bs, pos - 1);\n\t\t\treturn GF_TRUE;\n\t\t}\n\t\tpos++;\n\t\tb1 = b2;\n\t}\n\treturn GF_FALSE;\n}\n\nstatic const u32 ac3_sizecod_to_bitrate[] = {\n\t32000, 40000, 48000, 56000, 64000, 80000, 96000,\n\t112000, 128000, 160000, 192000, 224000, 256000,\n\t320000, 384000, 448000, 512000, 576000, 640000\n};\n\nstatic const u32 ac3_sizecod2_to_framesize[] = {\n\t96, 120, 144, 168, 192, 240, 288, 336, 384, 480, 576, 672,\n\t768, 960, 1152, 1344, 1536, 1728, 1920\n};\n\nstatic const u32 ac3_sizecod1_to_framesize[] = {\n\t69, 87, 104, 121, 139, 174, 208, 243, 278, 348, 417, 487,\n\t557, 696, 835, 975, 1114, 1253, 1393\n};\nstatic const u32 ac3_sizecod0_to_framesize[] = {\n\t64, 80, 96, 112, 128, 160, 192, 224, 256, 320, 384, 448,\n\t512, 640, 768, 896, 1024, 1152, 1280\n};\n\nstatic const u32 ac3_mod_to_total_chans[] = {\n\t2, 1, 2, 3, 3, 4, 4, 5\n};\n\nstatic const u32 ac3_mod_to_surround_chans[] = {\n\t0, 0, 0, 0, 1, 1, 2, 2\n};\n\nGF_EXPORT\nu32 gf_ac3_get_total_channels(u32 acmod)\n{\n\tu32 nb_ch;\n\tnb_ch = ac3_mod_to_total_chans[acmod];\n\treturn nb_ch;\n}\n\nGF_EXPORT\nu32 gf_ac3_get_surround_channels(u32 acmod)\n{\n\tu32 nb_ch;\n\tnb_ch = ac3_mod_to_surround_chans[acmod];\n\treturn nb_ch;\n}\n\nGF_EXPORT\nu32 gf_ac3_get_bitrate(u32 brcode)\n{\n\treturn ac3_sizecod_to_bitrate[brcode];\n}\n\nBool gf_ac3_parser(u8 *buf, u32 buflen, u32 *pos, GF_AC3Config *hdr, Bool full_parse)\n{\n\tGF_BitStream *bs;\n\tBool ret;\n\n\tif (buflen &lt; 6) return GF_FALSE;\n\t(*pos) = AC3_FindSyncCode(buf, buflen);\n\tif (*pos &gt;= buflen) return GF_FALSE;\n\n\tbs = gf_bs_new((const char*)(buf + *pos), buflen, GF_BITSTREAM_READ);\n\tret = gf_ac3_parser_bs(bs, hdr, full_parse);\n\tgf_bs_del(bs);\n\n\treturn ret;\n}\n\nGF_EXPORT\nBool gf_ac3_parser_bs(GF_BitStream *bs, GF_AC3Config *hdr, Bool full_parse)\n{\n\tu32 fscod, frmsizecod, bsid, ac3_mod, freq, framesize, bsmod, syncword;\n\tu64 pos;\n\tif (!hdr || !AC3_FindSyncCodeBS(bs)) return GF_FALSE;\n\n\tmemset(hdr, 0, sizeof(GF_AC3Header));\n\tpos = gf_bs_get_position(bs);\n\n\tsyncword = gf_bs_read_u16(bs);\n\tif (syncword != 0x0B77) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[AC3] Wrong sync word detected (0x%X - expecting 0x0B77).\\n&quot;, syncword));\n\t\treturn GF_FALSE;\n\t}\n\tgf_bs_read_int_log(bs, 16, &quot;crc1&quot;);\n\tfscod = gf_bs_read_int_log(bs, 2, &quot;fscod&quot;);\n\tfrmsizecod = gf_bs_read_int_log(bs, 6, &quot;frmsizecod&quot;);\n\tbsid = gf_bs_read_int_log(bs, 5, &quot;bsid&quot;);\n\tbsmod = gf_bs_read_int_log(bs, 3, &quot;bsmod&quot;);\n\tac3_mod = gf_bs_read_int_log(bs, 3, &quot;ac3_mod&quot;);\n\n\tif (frmsizecod &gt;= 2 * sizeof(ac3_sizecod_to_bitrate) / sizeof(u32))\n\t\treturn GF_FALSE;\n\n\tswitch (fscod) {\n\tcase 0:\n\t\tfreq = 48000;\n\t\tframesize = ac3_sizecod0_to_framesize[frmsizecod / 2] * 2;\n\t\tbreak;\n\tcase 1:\n\t\tfreq = 44100;\n\t\tframesize = (ac3_sizecod1_to_framesize[frmsizecod / 2] + (frmsizecod &amp; 0x1)) * 2;\n\t\tbreak;\n\tcase 2:\n\t\tfreq = 32000;\n\t\tframesize = ac3_sizecod2_to_framesize[frmsizecod / 2] * 2;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_FALSE;\n\t}\n\thdr-&gt;sample_rate = freq;\n\thdr-&gt;framesize = framesize;\n\thdr-&gt;nb_streams = 1;\n\n\tif (full_parse) {\n\t\thdr-&gt;streams[0].bsid = bsid;\n\t\thdr-&gt;streams[0].bsmod = bsmod;\n\t\thdr-&gt;streams[0].acmod = ac3_mod;\n\t\thdr-&gt;streams[0].lfon = 0;\n\t\thdr-&gt;streams[0].fscod = fscod;\n\t\thdr-&gt;brcode = frmsizecod / 2;\n\t}\n\tif (ac3_mod &gt;= 2 * sizeof(ac3_mod_to_total_chans) / sizeof(u32))\n\t\treturn GF_FALSE;\n\n\thdr-&gt;streams[0].channels = ac3_mod_to_total_chans[ac3_mod];\n\thdr-&gt;streams[0].surround_channels = ac3_mod_to_surround_chans[ac3_mod];\n\tif ((ac3_mod &amp; 0x1) &amp;&amp; (ac3_mod != 1)) gf_bs_read_int_log(bs, 2, &quot;cmixlev&quot;);\n\tif (ac3_mod &amp; 0x4) gf_bs_read_int_log(bs, 2, &quot;surmixlev&quot;);\n\tif (ac3_mod == 0x2) gf_bs_read_int_log(bs, 2, &quot;dsurmod&quot;);\n\n\tif (gf_bs_read_int_log(bs, 1, &quot;lfeon&quot;)) {\n\t\thdr-&gt;streams[0].channels += 1;\n\t\thdr-&gt;streams[0].lfon = 1;\n\t}\n\n\tgf_bs_seek(bs, pos);\n\n\treturn GF_TRUE;\n}\n\nGF_EXPORT\nu32 gf_eac3_get_chan_loc_count(u32 chan_loc)\n{\n\tu32 nb_ch=0;\n\tif (chan_loc &amp; 1) nb_ch+=2; //Lc/Rc pair\n\tif (chan_loc &amp; (1&lt;&lt;1)) nb_ch+=2; //Lrs/Rrs pair\n\tif (chan_loc &amp; (1&lt;&lt;2)) nb_ch+=1; //Cs\n\tif (chan_loc &amp; (1&lt;&lt;3)) nb_ch+=1; //Ts\n\tif (chan_loc &amp; (1&lt;&lt;4)) nb_ch+=2; //Lsd/Rsd pair\n\tif (chan_loc &amp; (1&lt;&lt;5)) nb_ch+=2; //Lw/Rw pair\n\tif (chan_loc &amp; (1&lt;&lt;6)) nb_ch+=2; //Lvh/Rvh pair\n\tif (chan_loc &amp; (1&lt;&lt;7)) nb_ch+=1; //Cvh\n\tif (chan_loc &amp; (1&lt;&lt;8)) nb_ch+=1; //LFE2\n\treturn nb_ch;\n}\n\nstatic u32 eac3_chanmap_to_chan_loc(u32 chan_map)\n{\n\tu32 chan_loc = 0;\n\tif (chan_map &amp; (1&lt;&lt;10)) chan_loc |= (1);\n\tif (chan_map &amp; (1&lt;&lt;9)) chan_loc |= (1&lt;&lt;1);\n\tif (chan_map &amp; (1&lt;&lt;8)) chan_loc |= (1&lt;&lt;2);\n\tif (chan_map &amp; (1&lt;&lt;7)) chan_loc |= (1&lt;&lt;3);\n\tif (chan_map &amp; (1&lt;&lt;6)) chan_loc |= (1&lt;&lt;4);\n\tif (chan_map &amp; (1&lt;&lt;5)) chan_loc |= (1&lt;&lt;5);\n\tif (chan_map &amp; (1&lt;&lt;4)) chan_loc |= (1&lt;&lt;6);\n\tif (chan_map &amp; (1&lt;&lt;3)) chan_loc |= (1&lt;&lt;7);\n\t//Lts/Rts pair (LSB 2) is not exposed in chan_loc\n\tif (chan_map &amp; (1&lt;&lt;1)) chan_loc |= (1&lt;&lt;8);\n\treturn chan_loc;\n}\n\nstatic void eac3_update_channels(GF_AC3Config *hdr)\n{\n\tu32 i;\n\tfor (i=0; i&lt;hdr-&gt;nb_streams; i++) {\n\t\tu32 nb_ch = ac3_mod_to_total_chans[hdr-&gt;streams[i].acmod];\n\t\tif (hdr-&gt;streams[i].nb_dep_sub) {\n\t\t\thdr-&gt;streams[i].chan_loc = eac3_chanmap_to_chan_loc(hdr-&gt;streams[i].chan_loc);\n\t\t\tnb_ch += gf_eac3_get_chan_loc_count(hdr-&gt;streams[i].chan_loc);\n\t\t}\n\t\tif (hdr-&gt;streams[i].lfon) nb_ch++;\n\t\thdr-&gt;streams[i].channels = nb_ch;\n\t\thdr-&gt;streams[i].surround_channels = ac3_mod_to_surround_chans[hdr-&gt;streams[i].acmod];\n\t}\n}\n\nstatic Bool gf_eac3_parser_internal(GF_BitStream *bs, GF_AC3Config *hdr, Bool full_parse)\n{\n\tu32 fscod, bsid, acmod, freq, framesize, syncword, substreamid, lfon, numblkscod, strmtyp, frmsiz, bsmod;\n\tu64 pos, hdr_pos;\n\tu16 chanmap;\n\tBool main_indep_found = GF_FALSE;\n\ts32 cur_main_id = -1;\n\tu32 nb_blocks_main;\n\tu32 cur_main_ac3 = 0;\n\tu16 main_substreams; //bit-mask of independent channels found so far\n\tstatic u32 numblks[4] = {1, 2, 3, 6};\n\n\tif (!hdr || !AC3_FindSyncCodeBS(bs))\n\t\treturn GF_FALSE;\n\nretry_frame:\n\tpos = gf_bs_get_position(bs);\n\tframesize = 0;\n\tnumblkscod = 0;\n\tbsmod = 0;\n\tnb_blocks_main = 0;\n\tmain_substreams = 0;\n\tmemset(hdr, 0, sizeof(GF_AC3Config));\n\nnext_block:\n\thdr_pos = gf_bs_get_position(bs);\n\n\tbsid = gf_bs_peek_bits(bs, 5, 5);\n\t//&quot;If an AC-3 bit stream is present in the Enhanced AC-3 bit stream, then the AC-3 bit stream shall be treated\n\t//as an independent substream assigned substream ID 0.&quot;\n\tif (bsid&lt;=8) {\n\t\tGF_AC3Header ac3h;\n\t\t//we are done\n\t\tif (main_indep_found) {\n\t\t\teac3_update_channels(hdr);\n\t\t\tgf_bs_seek(bs, pos);\n\t\t\treturn GF_TRUE;\n\t\t}\n\t\tif (!gf_ac3_parser_bs(bs, &amp;ac3h, GF_TRUE)) {\n\t\t\tgf_bs_seek(bs, pos);\n\t\t\treturn GF_FALSE;\n\t\t}\n\t\thdr-&gt;streams[0] = ac3h.streams[0];\n\t\thdr-&gt;nb_streams = 1;\n\t\thdr-&gt;sample_rate = ac3h.sample_rate;\n\t\tmain_substreams |= 1;\n\t\thdr-&gt;framesize = ac3h.framesize;\n\t\tnb_blocks_main = 6;\n\t\thdr-&gt;brcode = gf_ac3_get_bitrate(ac3h.brcode)/1000;\n\n\t\tgf_bs_skip_bytes(bs, ac3h.framesize);\n\t\tif (!AC3_FindSyncCodeBS(bs)) {\n\t\t\tgf_bs_seek(bs, pos);\n\t\t\treturn GF_FALSE;\n\t\t}\n\t\tmain_indep_found = GF_TRUE;\n\t\tcur_main_id = 0;\n\t\tcur_main_ac3 = 1;\n\t\tgoto next_block;\n\t}\n\t//corrupted frame, trash\n\tif ((bsid&lt;10) || (bsid&gt;16)) {\n\t\tgf_bs_skip_bytes(bs, 1);//we are still at the startcode\n\t\tif (!AC3_FindSyncCodeBS(bs)) {\n\t\t\tgf_bs_seek(bs, pos);\n\t\t\treturn GF_FALSE;\n\t\t}\n\t\tgoto next_block;\n\t}\n\tsyncword = gf_bs_read_u16(bs);\n\tif (syncword != 0x0B77) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[E-AC3] Wrong sync word detected (0x%X - expecting 0x0B77).\\n&quot;, syncword));\n\t\treturn GF_FALSE;\n\t}\n\n\thdr-&gt;is_ec3 = 1;\n\tstrmtyp = gf_bs_read_int_log(bs, 2, &quot;strmtyp&quot;);\n\tsubstreamid = gf_bs_read_int_log(bs, 3, &quot;substreamid&quot;);\n\n\t//independent stream\n\tif (strmtyp!=0x1) {\n\t\tcur_main_ac3 = 0;\n\t\t//all blocks gathered and we have seen this substreamid, done with whole frame\n\t\tif ( (nb_blocks_main&gt;=6) &amp;&amp; ( (main_substreams &gt;&gt; substreamid) &amp; 0x1)) {\n\t\t\teac3_update_channels(hdr);\n\t\t\tgf_bs_seek(bs, pos);\n\t\t\treturn GF_TRUE;\n\t\t}\n\t\t//main independent: &quot;All Enhanced AC-3 bit streams shall contain an independent substream assigned substream ID 0.\n\t\t// The independent substream assigned substream ID 0 shall be the first substream present in the bit stream.&quot;\n\t\tif (!substreamid)\n\t\t\tmain_indep_found = 1;\n\t\tif (cur_main_id != substreamid)\n\t\t\tnb_blocks_main=0;\n\t\tcur_main_id = substreamid;\n\t}\n\n\t//trash everything until we find first indep stream\n\tif (!main_indep_found) {\n\t\tgf_bs_align(bs);\n\t\tif (!AC3_FindSyncCodeBS(bs)) {\n\t\t\tgf_bs_seek(bs, pos);\n\t\t\treturn GF_FALSE;\n\t\t}\n\t\tgoto retry_frame;\n\t}\n\t//quick hack (not sure if the spec forbids this): some AC3+EAC3 streams use substreamid=0 for the eac3\n\t//which breaks nb_dep_sub / chan_loc signaling\n\t//we increase by one in this case\n\tif (cur_main_ac3 &amp;&amp; !substreamid) cur_main_ac3=2;\n\tif (cur_main_ac3==2) substreamid++;\n\n\tfrmsiz = gf_bs_read_int_log(bs, 11, &quot;frmsiz&quot;);\n\tframesize += 2 * (1 + frmsiz);\n\tfscod = gf_bs_read_int_log(bs, 2, &quot;fscod&quot;);\n\tif (fscod == 0x3) {\n\t\tfscod = gf_bs_read_int_log(bs, 2, &quot;fscod2&quot;);\n\t\tnumblkscod = 3;\n\t} else {\n\t\tnumblkscod = gf_bs_read_int_log(bs, 2, &quot;numblkscod&quot;);\n\t}\n\n\t//remember our independent substreams\n\tif (strmtyp!=0x1) {\n\t\tmain_substreams |= (1 &lt;&lt; substreamid);\n\t}\n\n\tswitch (fscod) {\n\tcase 0:\n\t\tfreq = 48000;\n\t\tbreak;\n\tcase 1:\n\t\tfreq = 44100;\n\t\tbreak;\n\tcase 2:\n\t\tfreq = 32000;\n\t\tbreak;\n\tdefault:\n\t\t//do not sync\n\t\tgf_bs_align(bs);\n\t\treturn GF_FALSE;\n\t}\n\n\tacmod = gf_bs_read_int_log(bs, 3, &quot;acmod&quot;);\n\tlfon = gf_bs_read_int_log(bs, 1, &quot;lfon&quot;);\n\tbsid = gf_bs_read_int_log(bs, 5, &quot;bsid&quot;);\n\n\tgf_bs_read_int_log(bs, 5, &quot;dialnorm&quot;);\n\tif (gf_bs_read_int_log(bs, 1, &quot;compre&quot;)) {\n\t\tgf_bs_read_int_log(bs, 8, &quot;compr&quot;);\n\t}\n\tif (acmod==0) {\n\t\tgf_bs_read_int_log(bs, 5, &quot;dialnorm2&quot;);\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;compr2e&quot;)) {\n\t\t\tgf_bs_read_int_log(bs, 8, &quot;compr2&quot;);\n\t\t}\n\t}\n\tchanmap = 0;\n\tif (strmtyp==0x1) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;chanmape&quot;)) {\n\t\t\tchanmap = gf_bs_read_int_log(bs, 16, &quot;chanmap&quot;);\n\t\t}\n\t}\n\n\thdr-&gt;sample_rate = freq;\n\thdr-&gt;framesize += framesize;\n\tif (strmtyp != 1) {\n\t\tassert(cur_main_id == substreamid);\n\t\thdr-&gt;streams[substreamid].lfon = lfon;\n\t\thdr-&gt;streams[substreamid].bsid = bsid;\n\t\thdr-&gt;streams[substreamid].bsmod = bsmod;\n\t\thdr-&gt;streams[substreamid].acmod = acmod;\n\t\thdr-&gt;streams[substreamid].fscod = fscod;\n\t\thdr-&gt;brcode = 0;\n\t\tif (hdr-&gt;nb_streams&lt;8)\n\t\t\thdr-&gt;nb_streams++;\n\t}\n\t//dependent stream, record max substream ID of dep and store chan map\n\telse {\n\t\thdr-&gt;streams[cur_main_id].nb_dep_sub = substreamid;\n\t\thdr-&gt;streams[cur_main_id].chan_loc |= chanmap;\n\t}\n\n\t//not clear if this is only for the independent streams - spec says &quot;The value is the sum of the data rates of all the substreams&quot;\n\thdr-&gt;brcode += ((frmsiz+1) * freq) / (numblks[numblkscod]*16) / 1000;\n\n\t//start of header only, we are done - chan info might be wrong\n\tif (!full_parse) {\n\t\teac3_update_channels(hdr);\n\t\tgf_bs_seek(bs, pos);\n\t\treturn GF_TRUE;\n\t}\n\n\t//mix metadata\n\tif (gf_bs_read_int(bs, 1)) {\n\t\tif (acmod &gt; 0x2) gf_bs_read_int(bs, 2);\n\t\tif ((acmod &amp; 0x1) &amp;&amp; (acmod &gt; 0x2)) gf_bs_read_int(bs, 6);\n\t\tif (acmod &amp; 0x4) gf_bs_read_int(bs, 6);\n\t\tif (lfon) {\n\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\tgf_bs_read_int(bs, 5);\n\t\t}\n\t\tif (strmtyp == 0) {\n\t\t\t//pgmscle\n\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\tgf_bs_read_int(bs, 6);\n\t\t\tif (acmod==0) {\n\t\t\t\t//pgmscl2e\n\t\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\t\tgf_bs_read_int(bs, 6);\n\t\t\t}\n\t\t\t//extpgmscle\n\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\tgf_bs_read_int(bs, 6);\n\t\t\tu8 mixdef = gf_bs_read_int(bs, 2);\n\t\t\tif (mixdef == 0x1) {\n\t\t\t\tgf_bs_read_int(bs, 5);\n\t\t\t} else if (mixdef == 0x2) {\n\t\t\t\tgf_bs_read_int(bs, 12);\n\t\t\t} else if (mixdef == 0x3) {\n\t\t\t\tu32 mixdeflen = gf_bs_read_int(bs, 5);\n\t\t\t\tmixdeflen = 8 * (mixdeflen + 2);\n\t\t\t\twhile (mixdeflen) {\n\t\t\t\t\tgf_bs_read_int(bs, 1);\n\t\t\t\t\tmixdeflen--;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (acmod &lt; 0x2) {\n\t\t\t\t//paninfoe\n\t\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\t\tgf_bs_read_int(bs, 14);\n\t\t\t\tif (acmod == 0) {\n\t\t\t\t\t//paninfo2e\n\t\t\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\t\t\tgf_bs_read_int(bs, 14);\n\t\t\t\t}\n\n\t\t\t}\n\t\t\t//frmmixcfginfoe\n\t\t\tif (gf_bs_read_int(bs, 1)) {\n\t\t\t\tif (numblkscod == 0x0) {\n\t\t\t\t\tgf_bs_read_int(bs, 5);\n\t\t\t\t} else {\n\t\t\t\t\tu32 i, nb_blocks = numblks[numblkscod];\n\t\t\t\t\tfor (i=0; i&lt;nb_blocks; i++) {\n\t\t\t\t\t\tif (gf_bs_read_int(bs, 1))\n\t\t\t\t\t\t\tgf_bs_read_int(bs, 5);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t//info metadata\n\tif (gf_bs_read_int(bs, 1)) {\n\t\tgf_bs_read_int(bs, 5);\n\t\tif (acmod == 0x2) gf_bs_read_int(bs, 4);\n\t\tif (acmod &gt;= 0x6) gf_bs_read_int(bs, 2);\n\t\t//audprodie\n\t\tif (gf_bs_read_int(bs, 1)) gf_bs_read_int(bs, 8);\n\t\tif (acmod == 0x0) {\n\t\t\t//audprodi2e\n\t\t\tif (gf_bs_read_int(bs, 1)) gf_bs_read_int(bs, 8);\n\t\t}\n\t\tif (fscod &lt; 0x3)  gf_bs_read_int(bs, 1);\n\t}\n\tif ((strmtyp == 0) &amp;&amp; (numblkscod != 0x3)) gf_bs_read_int(bs, 1);\n\tif (strmtyp == 0x2) {\n\t\tu32 blkid=0;\n\t\tif (numblkscod == 0x3) blkid=1;\n\t\telse blkid = gf_bs_read_int(bs, 1);\n\t\tif (blkid) gf_bs_read_int(bs, 6);\n\t}\n\tu8 addbsie = gf_bs_read_int(bs, 1);\n\tif (addbsie) {\n\t\tu32 addbsil = gf_bs_read_int(bs, 6) + 1;\n\t\t//we only use the first 2 bytes - cf 8.3 of ETSI 103 420 V1.2.1\n\t\tif (addbsil&gt;=2) {\n\t\t\tgf_bs_read_int(bs, 7);\n\t\t\tif (gf_bs_read_int(bs, 1)) {\n\t\t\t\thdr-&gt;atmos_ec3_ext = 1;\n\t\t\t\thdr-&gt;complexity_index_type = gf_bs_read_int(bs, 8);\n\t\t\t}\n\t\t}\n\t}\n\n\t//remember numbers of block for main\n\tif (strmtyp!=0x1) {\n\t\tnb_blocks_main += numblks[numblkscod];\n\t}\n\n\tif (gf_bs_seek(bs, hdr_pos + framesize) != GF_OK) {\n\t\tgf_bs_seek(bs, pos);\n\t\treturn GF_FALSE;\n\t}\n\n\tif (!AC3_FindSyncCodeBS(bs)) {\n\t\tgf_bs_seek(bs, pos);\n\t\treturn GF_FALSE;\n\t}\n\t//we go to next block even if we have 6 of main (to check deps)\n\tgoto next_block;\n}\n\nGF_EXPORT\nBool gf_eac3_parser_bs(GF_BitStream *bs, GF_AC3Config *hdr, Bool full_parse)\n{\n\treturn gf_eac3_parser_internal(bs, hdr, full_parse);\n}\n\nGF_EXPORT\nBool gf_eac3_parser(u8 *buf, u32 buflen, u32 *pos, GF_AC3Config *hdr, Bool full_parse)\n{\n\tGF_BitStream *bs;\n\tBool ret;\n\n\tif (buflen &lt; 6) return GF_FALSE;\n\t(*pos) = AC3_FindSyncCode(buf, buflen);\n\tif (*pos &gt;= buflen) return GF_FALSE;\n\n\tbs = gf_bs_new((const char*)(buf + *pos), buflen, GF_BITSTREAM_READ);\n\tret = gf_eac3_parser_internal(bs, hdr, full_parse);\n\tgf_bs_del(bs);\n\treturn ret;\n}\n\n#endif /*GPAC_DISABLE_AV_PARSERS*/\n\nu32 gf_id3_read_size(GF_BitStream *bs)\n{\n\tu32 size = 0;\n\tgf_bs_read_int(bs, 1);\n\tsize |= gf_bs_read_int(bs, 7);\n\tsize&lt;&lt;=7;\n\tgf_bs_read_int(bs, 1);\n\tsize |= gf_bs_read_int(bs, 7);\n\tsize&lt;&lt;=7;\n\tgf_bs_read_int(bs, 1);\n\tsize |= gf_bs_read_int(bs, 7);\n\tsize&lt;&lt;=7;\n\tgf_bs_read_int(bs, 1);\n\tsize |= gf_bs_read_int(bs, 7);\n\treturn size;\n}\n\n\n#if !defined(GPAC_DISABLE_AV_PARSERS) &amp;&amp; !defined (GPAC_DISABLE_OGG)\n\n/*\n\tVorbis parser\n*/\n\nstatic u32 vorbis_book_maptype1_quantvals(u32 entries, u32 dim)\n{\n\tu32 vals = (u32)floor(pow(entries, 1.0 / dim));\n\twhile (1) {\n\t\tu32 acc = 1;\n\t\tu32 acc1 = 1;\n\t\tu32 i;\n\t\tfor (i = 0; i &lt; dim; i++) {\n\t\t\tacc *= vals;\n\t\t\tacc1 *= vals + 1;\n\t\t}\n\t\tif (acc &lt;= entries &amp;&amp; acc1 &gt; entries) return (vals);\n\t\telse {\n\t\t\tif (acc &gt; entries) vals--;\n\t\t\telse vals++;\n\t\t}\n\t}\n}\n\nstatic u32 ilog(u32 v, Bool dec)\n{\n\tu32 ret = 0;\n\tif (dec &amp;&amp; v) --v;\n\twhile (v) {\n\t\tret++;\n\t\tv &gt;&gt;= 1;\n\t}\n\treturn (ret);\n}\n\nstatic u32 icount(u32 v)\n{\n\tu32 ret = 0;\n\twhile (v) {\n\t\tret += v &amp; 1;\n\t\tv &gt;&gt;= 1;\n\t}\n\treturn(ret);\n}\n\n\nGF_EXPORT\nBool gf_vorbis_parse_header(GF_VorbisParser *vp, u8 *data, u32 data_len)\n{\n\tu32 pack_type, i, j, k, times, nb_part, nb_books, nb_modes;\n\tu32 l;\n\tchar szNAME[8];\n\toggpack_buffer opb;\n\n\toggpack_readinit(&amp;opb, (u8*)data, data_len);\n\tpack_type = oggpack_read(&amp;opb, 8);\n\ti = 0;\n\twhile (i &lt; 6) {\n\t\tszNAME[i] = oggpack_read(&amp;opb, 8);\n\t\ti++;\n\t}\n\tszNAME[i] = 0;\n\tif (strcmp(szNAME, &quot;vorbis&quot;)) {\n\t\treturn GF_FALSE;\n\t}\n\n\tswitch (pack_type) {\n\tcase 0x01:\n\t\tvp-&gt;version = oggpack_read(&amp;opb, 32);\n\t\tif (vp-&gt;version != 0) {\n\t\t\treturn GF_FALSE;\n\t\t}\n\t\tvp-&gt;channels = oggpack_read(&amp;opb, 8);\n\t\tvp-&gt;sample_rate = oggpack_read(&amp;opb, 32);\n\t\tvp-&gt;max_r = oggpack_read(&amp;opb, 32);\n\t\tvp-&gt;avg_r = oggpack_read(&amp;opb, 32);\n\t\tvp-&gt;low_r = oggpack_read(&amp;opb, 32);\n\n\t\tvp-&gt;min_block = 1&lt;&lt;oggpack_read(&amp;opb, 4);\n\t\tvp-&gt;max_block = 1&lt;&lt;oggpack_read(&amp;opb, 4);\n\t\tif (vp-&gt;sample_rate &lt; 1 || vp-&gt;channels &lt; 1 || vp-&gt;min_block &lt; 8 || vp-&gt;max_block &lt; vp-&gt;min_block\n\t\t    || oggpack_read(&amp;opb, 1) != 1) {\n\t\t\treturn GF_FALSE;\n\t\t}\n\t\tvp-&gt;nb_init=1;\n\t\treturn GF_TRUE;\n\n\tcase 0x03:\n\t\t/*trash comments*/\n\t\tvp-&gt;nb_init++;\n\t\treturn GF_TRUE;\n\tcase 0x05:\n\t\t/*need at least bitstream header to make sure we&#x27;re parsing the right thing*/\n\t\tif (!vp-&gt;nb_init) return GF_FALSE;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_FALSE;\n\t}\n\t/*OK parse codebook*/\n\tnb_books = oggpack_read(&amp;opb, 8) + 1;\n\t/*skip vorbis static books*/\n\tfor (i = 0; i &lt; nb_books; i++) {\n\t\tu32 map_type, qb, qq;\n\t\tu32 entries, dim;\n\t\toggpack_read(&amp;opb, 24);\n\t\tdim = oggpack_read(&amp;opb, 16);\n\t\tentries = oggpack_read(&amp;opb, 24);\n\t\tif ((s32)entries &lt; 0) entries = 0;\n\t\tif (oggpack_read(&amp;opb, 1) == 0) {\n\t\t\tif (oggpack_read(&amp;opb, 1)) {\n\t\t\t\tfor (j = 0; j &lt; entries; j++) {\n\t\t\t\t\tif (oggpack_read(&amp;opb, 1)) {\n\t\t\t\t\t\toggpack_read(&amp;opb, 5);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfor (j = 0; j &lt; entries; j++)\n\t\t\t\t\toggpack_read(&amp;opb, 5);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\toggpack_read(&amp;opb, 5);\n\t\t\tfor (j = 0; j &lt; entries;) {\n\t\t\t\tu32 num = oggpack_read(&amp;opb, ilog(entries - j, GF_FALSE));\n\t\t\t\tfor (k = 0; k &lt; num &amp;&amp; j &lt; entries; k++, j++) {\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tswitch ((map_type = oggpack_read(&amp;opb, 4))) {\n\t\tcase 0:\n\t\t\tbreak;\n\t\tcase 1:\n\t\tcase 2:\n\t\t\toggpack_read(&amp;opb, 32);\n\t\t\toggpack_read(&amp;opb, 32);\n\t\t\tqq = oggpack_read(&amp;opb, 4) + 1;\n\t\t\toggpack_read(&amp;opb, 1);\n\t\t\tif (map_type == 1) qb = vorbis_book_maptype1_quantvals(entries, dim);\n\t\t\telse if (map_type == 2) qb = entries * dim;\n\t\t\telse qb = 0;\n\t\t\tfor (j = 0; j &lt; qb; j++) oggpack_read(&amp;opb, qq);\n\t\t\tbreak;\n\t\t}\n\t}\n\ttimes = oggpack_read(&amp;opb, 6) + 1;\n\tfor (i = 0; i &lt; times; i++) oggpack_read(&amp;opb, 16);\n\ttimes = oggpack_read(&amp;opb, 6) + 1;\n\tfor (i = 0; i &lt; times; i++) {\n\t\tu32 type = oggpack_read(&amp;opb, 16);\n\t\tif (type) {\n\t\t\tu32 *parts, *class_dims, count, rangebits;\n\t\t\tu32 max_class = 0;\n\t\t\tnb_part = oggpack_read(&amp;opb, 5);\n\t\t\tparts = (u32*)gf_malloc(sizeof(u32) * nb_part);\n\t\t\tfor (j = 0; j &lt; nb_part; j++) {\n\t\t\t\tparts[j] = oggpack_read(&amp;opb, 4);\n\t\t\t\tif (max_class &lt; parts[j]) max_class = parts[j];\n\t\t\t}\n\t\t\tclass_dims = (u32*)gf_malloc(sizeof(u32) * (max_class + 1));\n\t\t\tfor (j = 0; j &lt; max_class + 1; j++) {\n\t\t\t\tu32 class_sub;\n\t\t\t\tclass_dims[j] = oggpack_read(&amp;opb, 3) + 1;\n\t\t\t\tclass_sub = oggpack_read(&amp;opb, 2);\n\t\t\t\tif (class_sub) oggpack_read(&amp;opb, 8);\n\t\t\t\tfor (k = 0; k &lt; (u32)(1 &lt;&lt; class_sub); k++) oggpack_read(&amp;opb, 8);\n\t\t\t}\n\t\t\toggpack_read(&amp;opb, 2);\n\t\t\trangebits = oggpack_read(&amp;opb, 4);\n\t\t\tcount = 0;\n\t\t\tfor (j = 0, k = 0; j &lt; nb_part; j++) {\n\t\t\t\tcount += class_dims[parts[j]];\n\t\t\t\tfor (; k &lt; count; k++) oggpack_read(&amp;opb, rangebits);\n\t\t\t}\n\t\t\tgf_free(parts);\n\t\t\tgf_free(class_dims);\n\t\t}\n\t\telse {\n\t\t\toggpack_read(&amp;opb, 8 + 16 + 16 + 6 + 8);\n\t\t\tnb_books = oggpack_read(&amp;opb, 4) + 1;\n\t\t\tfor (j = 0; j &lt; nb_books; j++)\n\t\t\t\toggpack_read(&amp;opb, 8);\n\t\t}\n\t}\n\ttimes = oggpack_read(&amp;opb, 6) + 1;\n\tfor (i = 0; i &lt; times; i++) {\n\t\tu32 acc = 0;\n\t\toggpack_read(&amp;opb, 16);/*type*/\n\t\toggpack_read(&amp;opb, 24);\n\t\toggpack_read(&amp;opb, 24);\n\t\toggpack_read(&amp;opb, 24);\n\t\tnb_part = oggpack_read(&amp;opb, 6) + 1;\n\t\toggpack_read(&amp;opb, 8);\n\t\tfor (j = 0; j &lt; nb_part; j++) {\n\t\t\tu32 cascade = oggpack_read(&amp;opb, 3);\n\t\t\tif (oggpack_read(&amp;opb, 1)) cascade |= (oggpack_read(&amp;opb, 5) &lt;&lt; 3);\n\t\t\tacc += icount(cascade);\n\t\t}\n\t\tfor (j = 0; j &lt; acc; j++) oggpack_read(&amp;opb, 8);\n\t}\n\ttimes = oggpack_read(&amp;opb, 6) + 1;\n\tfor (i = 0; i &lt; times; i++) {\n\t\tu32 sub_maps = 1;\n\t\toggpack_read(&amp;opb, 16);\n\t\tif (oggpack_read(&amp;opb, 1)) sub_maps = oggpack_read(&amp;opb, 4) + 1;\n\t\tif (oggpack_read(&amp;opb, 1)) {\n\t\t\tu32 nb_steps = oggpack_read(&amp;opb, 8) + 1;\n\t\t\tfor (j = 0; j &lt; nb_steps; j++) {\n\t\t\t\toggpack_read(&amp;opb, ilog(vp-&gt;channels, GF_TRUE));\n\t\t\t\toggpack_read(&amp;opb, ilog(vp-&gt;channels, GF_TRUE));\n\t\t\t}\n\t\t}\n\t\toggpack_read(&amp;opb, 2);\n\t\tif (sub_maps&gt;1) {\n\t\t\tfor(l=0; l&lt;vp-&gt;channels; l++)\n\t\t\t\toggpack_read(&amp;opb, 4);\n\t\t}\n\t\tfor (j = 0; j &lt; sub_maps; j++) {\n\t\t\toggpack_read(&amp;opb, 8);\n\t\t\toggpack_read(&amp;opb, 8);\n\t\t\toggpack_read(&amp;opb, 8);\n\t\t}\n\t}\n\tnb_modes = oggpack_read(&amp;opb, 6) + 1;\n\tfor (i = 0; i &lt; nb_modes; i++) {\n\t\tvp-&gt;mode_flag[i] = oggpack_read(&amp;opb, 1);\n\t\toggpack_read(&amp;opb, 16);\n\t\toggpack_read(&amp;opb, 16);\n\t\toggpack_read(&amp;opb, 8);\n\t}\n\n\tvp-&gt;modebits = 0;\n\tj = nb_modes;\n\twhile (j &gt; 1) {\n\t\tvp-&gt;modebits++;\n\t\tj &gt;&gt;= 1;\n\t}\n\n\treturn GF_TRUE;\n}\n\nGF_EXPORT\nu32 gf_vorbis_check_frame(GF_VorbisParser *vp, u8 *data, u32 data_length)\n{\n\ts32 block_size;\n\toggpack_buffer opb;\n\tif (!vp) return 0;\n\toggpack_readinit(&amp;opb, (unsigned char*)data, data_length);\n\t/*not audio*/\n\tif (oggpack_read(&amp;opb, 1) != 0) return 0;\n\tblock_size = oggpack_read(&amp;opb, vp-&gt;modebits);\n\tif (block_size == -1) return 0;\n\treturn ((vp-&gt;mode_flag[block_size]) ? vp-&gt;max_block : vp-&gt;min_block) / (2);\n}\n\n\n#endif /*!defined(GPAC_DISABLE_AV_PARSERS) &amp;&amp; !defined (GPAC_DISABLE_OGG)*/\n\n\n#if !defined(GPAC_DISABLE_AV_PARSERS)\n\n/*call with vorbis header packets - initializes the parser on success, leave it to NULL otherwise\nreturns 1 if success, 0 if error.*/\nBool gf_opus_parse_header(GF_OpusConfig *ocfg, u8 *data, u32 data_len)\n{\n\tchar tag[9];\n\tGF_BitStream *bs = gf_bs_new(data, data_len, GF_BITSTREAM_READ);\n\tgf_bs_read_data(bs, tag, 8);\n\ttag[8]=0;\n\n\tif (memcmp(data, &quot;OpusHead&quot;, sizeof(char)*8)) {\n\t\tgf_bs_del(bs);\n\t\treturn GF_FALSE;\n\t}\n\t/*Identification Header*/\n\tocfg-&gt;version = gf_bs_read_u8(bs); /*version*/\n\tif (ocfg-&gt;version != 1) {\n\t\tgf_bs_del(bs);\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[Opus] Unsupported version %d\\n&quot;, ocfg-&gt;version));\n\t\treturn GF_FALSE;\n\t}\n\tocfg-&gt;OutputChannelCount = gf_bs_read_u8(bs);\n\tocfg-&gt;PreSkip = gf_bs_read_u16_le(bs);\n\tocfg-&gt;InputSampleRate = gf_bs_read_u32_le(bs);\n\tocfg-&gt;OutputGain = gf_bs_read_u16_le(bs);\n\tocfg-&gt;ChannelMappingFamily = gf_bs_read_u8(bs);\n\tif (ocfg-&gt;ChannelMappingFamily != 0) {\n\t\tocfg-&gt;StreamCount = gf_bs_read_u8(bs);\n\t\tocfg-&gt;CoupledCount = gf_bs_read_u8(bs);\n\t\tgf_bs_read_data(bs, (char *) ocfg-&gt;ChannelMapping, ocfg-&gt;OutputChannelCount);\n\t}\n\tgf_bs_del(bs);\n\treturn GF_TRUE;\n}\n\n/*returns 0 if init error or not an opus frame, otherwise returns the number of audio samples\nin this frame*/\nu32 gf_opus_check_frame(GF_OpusConfig *ocfg, u8 *data, u32 data_length)\n{\n\tu32 block_size;\n\n\tif (!data || !data_length) return 0;\n\tif (!memcmp(data, &quot;OpusHead&quot;, sizeof(char)*8)) return 0;\n\tif (!memcmp(data, &quot;OpusTags&quot;, sizeof(char)*8)) return 0;\n\n\t/*consider the whole packet as Ogg packets and ISOBMFF samples for Opus are framed similarly*/\n\tstatic const int OpusFrameDurIn48k[] = { 480, 960, 1920, 2880, 480, 960, 1920, 2880, 480, 960, 1920, 2880,\n\t\t480, 960, 480, 960,\n\t\t120, 240, 480, 960, 120, 240, 480, 960, 120, 240, 480, 960, 120, 240, 480, 960,\n\t};\n\tint TOC_config = (data[0] &amp; 0xf8) &gt;&gt; 3;\n\t//int s = (data[0] &amp; 0x04) &gt;&gt; 2;\n\tblock_size = OpusFrameDurIn48k[TOC_config];\n\n\tint c = data[0] &amp; 0x03;\n\tif (c == 1 || c == 2) {\n\t\tblock_size *= 2;\n\t} else if (c == 3) {\n\t\t/*unknown number of frames*/\n\t\tint num_frames = data[1] &amp; 0x3f;\n\t\tblock_size *= num_frames;\n\t}\n\treturn block_size;\n}\n\n/* return nb bytes read */\nstatic u8 gf_opus_read_length(u8 *data, u32 data_length, u32 offset, u16 *read_length) {\n    if (!data || !data_length || !read_length) {\n        GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Cannot read Opus length value\\n&quot;));\n        return 0;\n    }\n    if (offset &gt;= data_length) {\n        GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Not enough bytes to read Opus length\\n&quot;));\n        return 0;\n    }\n    if (data[offset] &lt; 252) {\n        *read_length = data[offset];\n        return 1;\n    } else {\n        if (offset+1 &gt;= data_length) {\n            GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Not enough bytes to read 2-byte Opus length\\n&quot;));\n            return 0;\n        }\n        *read_length = data[offset+1]*4+data[offset];\n        return 2;\n    }\n}\n\nGF_EXPORT\nu8 gf_opus_parse_packet_header(u8 *data, u32 data_length, Bool self_delimited, GF_OpusPacketHeader *header)\n{\n    u32 i;\n    u32 nb_read_bytes;\n    if (!data || !data_length)\n        return 0;\n    if (!header)\n        return 0;\n    if (!memcmp(data, &quot;OpusHead&quot;, sizeof(char)*8))\n        return 0;\n    if (!memcmp(data, &quot;OpusTags&quot;, sizeof(char)*8))\n        return 0;\n\n    GF_LOG(GF_LOG_DEBUG, GF_LOG_CODING, (&quot;Processing Opus packet, self: %d, size %d\\n&quot;, self_delimited, data_length));\n\n    if (data_length &lt; 1) {\n        GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Opus packet size must be at least one to parse TOC byte\\n&quot;));\n        return 0;\n    }\n    memset(header, 0, sizeof(GF_OpusPacketHeader));\n    header-&gt;self_delimited = self_delimited;\n    header-&gt;TOC_config = (data[0] &amp; 0xf8) &gt;&gt; 3;\n    header-&gt;TOC_stereo = (data[0] &amp; 0x4) &gt;&gt; 2;\n    header-&gt;TOC_code = data[0] &amp; 0x03;\n    header-&gt;size = 1;\n    if (header-&gt;TOC_code == 0) {\n        header-&gt;nb_frames = 1;\n        if (self_delimited) {\n            nb_read_bytes = gf_opus_read_length(data, data_length, header-&gt;size, &amp;header-&gt;self_delimited_length);\n            if (nb_read_bytes) {\n                header-&gt;size += nb_read_bytes;\n            } else {\n                GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Could not read self delimited length in Opus packet code 0\\n&quot;));\n                return 0;\n            }\n//            0                   1                   2                   3\n//            0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           | config  |s|0|0| N1 (1-2 bytes):                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |\n//           |               Compressed frame 1 (N1 bytes)...                :\n//           :                                                               |\n//           |                                                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n            header-&gt;frame_lengths[0] = header-&gt;self_delimited_length;\n        } else {\n//            0                   1                   2                   3\n//            0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           | config  |s|0|0|                                               |\n//           +-+-+-+-+-+-+-+-+                                               |\n//           |                    Compressed frame 1 (N-1 bytes)...          :\n//           :                                                               |\n//           |                                                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n            header-&gt;frame_lengths[0] = data_length - header-&gt;size;\n        }\n        header-&gt;packet_size = header-&gt;size + header-&gt;frame_lengths[0];\n    } else if (header-&gt;TOC_code == 1) {\n        header-&gt;nb_frames = 2;\n        if (self_delimited) {\n            nb_read_bytes = gf_opus_read_length(data, data_length, header-&gt;size, &amp;header-&gt;self_delimited_length);\n            if (nb_read_bytes) {\n                header-&gt;size += nb_read_bytes;\n            } else {\n                GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Could not read self delimited length in Opus packet code 1\\n&quot;));\n                return 0;\n            }\n//            0                   1                   2                   3\n//            0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           | config  |s|0|1| N1 (1-2 bytes):                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               :\n//           |               Compressed frame 1 (N1 bytes)...                |\n//           :                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           |                               |                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               :\n//           |               Compressed frame 2 (N1 bytes)...                |\n//           :                                               +-+-+-+-+-+-+-+-+\n//           |                                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n            header-&gt;frame_lengths[0] = header-&gt;self_delimited_length;\n            header-&gt;frame_lengths[1] = header-&gt;self_delimited_length;\n        } else {\n//            0                   1                   2                   3\n//            0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           | config  |s|0|1|                                               |\n//           +-+-+-+-+-+-+-+-+                                               :\n//           |             Compressed frame 1 ((N-1)/2 bytes)...             |\n//           :                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           |                               |                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               :\n//           |             Compressed frame 2 ((N-1)/2 bytes)...             |\n//           :                                               +-+-+-+-+-+-+-+-+\n//           |                                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n            if ((data_length-header-&gt;size) % 2) {\n                GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Size of non-self-delimited Opus packet with code 2 must be even but is %d\\n&quot;,data_length-header-&gt;size));\n                return 0;\n            }\n            header-&gt;frame_lengths[0] = (data_length-header-&gt;size)/2;\n            header-&gt;frame_lengths[1] = (data_length-header-&gt;size)/2;\n        }\n        header-&gt;packet_size = header-&gt;size + header-&gt;frame_lengths[0] + header-&gt;frame_lengths[1];\n    } else if (header-&gt;TOC_code == 2) {\n        header-&gt;nb_frames = 2;\n        if (self_delimited) {\n            nb_read_bytes = gf_opus_read_length(data, data_length, header-&gt;size, &amp;header-&gt;self_delimited_length);\n            if (nb_read_bytes) {\n                header-&gt;size += nb_read_bytes;\n            } else {\n                GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Could not read self delimited length in Opus packet code 2\\n&quot;));\n                return 0;\n            }\n        }\n        nb_read_bytes = gf_opus_read_length(data, data_length, header-&gt;size, &amp;header-&gt;code2_frame_length);\n        if (nb_read_bytes) {\n            header-&gt;size += nb_read_bytes;\n        } else {\n            GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Could not read frame length in Opus packet code 2\\n&quot;));\n            return 0;\n        }\n        if (self_delimited) {\n//            0                   1                   2                   3\n//            0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           | config  |s|1|0| N1 (1-2 bytes): N2 (1-2 bytes :               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               :\n//           |               Compressed frame 1 (N1 bytes)...                |\n//           :                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           |                               |                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |\n//           |               Compressed frame 2 (N2 bytes)...                :\n//           :                                                               |\n//           |                                                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n            header-&gt;frame_lengths[0] = header-&gt;self_delimited_length;\n            header-&gt;frame_lengths[1] = header-&gt;code2_frame_length;\n        } else {\n//            0                   1                   2                   3\n//            0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           | config  |s|1|0| N1 (1-2 bytes):                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               :\n//           |               Compressed frame 1 (N1 bytes)...                |\n//           :                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//           |                               |                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |\n//           |                     Compressed frame 2...                     :\n//           :                                                               |\n//           |                                                               |\n//           +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n            header-&gt;frame_lengths[0] = header-&gt;code2_frame_length;\n            header-&gt;frame_lengths[1] = data_length - header-&gt;size - header-&gt;code2_frame_length;\n        }\n        header-&gt;packet_size = header-&gt;size + header-&gt;frame_lengths[0] + header-&gt;frame_lengths[1];\n    } else if (header-&gt;TOC_code == 3) {\n        u32 sum = 0;\n        if (data_length &lt;= header-&gt;size) {\n            GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Not enough data to parse TOC code 3 data\\n&quot;));\n            return 0;\n        }\n        header-&gt;code3_vbr = (data[header-&gt;size] &amp; 0x80) &gt;&gt; 7;\n        header-&gt;code3_padding = (data[header-&gt;size] &amp; 0x40) &gt;&gt; 6;\n        header-&gt;nb_frames = data[header-&gt;size] &amp; 0x3f;\n        header-&gt;size++;\n        if (header-&gt;code3_padding) {\n            if (data_length &lt;= header-&gt;size) {\n                GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Not enough data to parse TOC code 3 padding length\\n&quot;));\n                return 0;\n            }\n            if (data[header-&gt;size] == 255) {\n                header-&gt;code3_padding_length = 254 + data[header-&gt;size+1];\n                header-&gt;size += 2;\n            } else {\n                header-&gt;code3_padding_length = data[header-&gt;size];\n                header-&gt;size++;\n            }\n        } else {\n            header-&gt;code3_padding_length = 0;\n        }\n        if (self_delimited) {\n            nb_read_bytes = gf_opus_read_length(data, data_length, header-&gt;size, &amp;header-&gt;self_delimited_length);\n            if (nb_read_bytes) {\n                header-&gt;size += nb_read_bytes;\n            } else {\n                GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Could not read self delimited length in Opus packet code 3\\n&quot;));\n                return 0;\n            }\n        }\n        if (header-&gt;code3_vbr) {\n            u32 max;\n            u32 min;\n            if (self_delimited) {\n//                0                   1                   2                   3\n//                0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               | config  |s|1|1|1|p|     M     | Padding length (Optional)     :\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               : N1 (1-2 bytes):     ...       :     N[M-1]    |     N[M]      :\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 1 (N1 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 2 (N2 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :                              ...                              :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :              Compressed frame M (N[M] bytes)...               :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               :                  Opus Padding (Optional)...                   |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n                header-&gt;frame_lengths[0] = header-&gt;self_delimited_length;\n                min = 1;\n                max = header-&gt;nb_frames;\n                sum += header-&gt;frame_lengths[0];\n            } else {\n//                0                   1                   2                   3\n//                0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               | config  |s|1|1|1|p|     M     | Padding length (Optional)     :\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               : N1 (1-2 bytes): N2 (1-2 bytes):     ...       :     N[M-1]    |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 1 (N1 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 2 (N2 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :                              ...                              :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :                     Compressed frame M...                     :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               :                  Opus Padding (Optional)...                   |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n                min = 0;\n                max = header-&gt;nb_frames-1;\n            }\n            for (i = min; i &lt; max; i++) {\n                if (data_length &lt;= header-&gt;size) {\n                    GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Not enough data to parse TOC code 3 length\\n&quot;));\n                    return 0;\n                }\n                nb_read_bytes = gf_opus_read_length(data, data_length, header-&gt;size, &amp;(header-&gt;frame_lengths[i]));\n                if (nb_read_bytes) {\n                    header-&gt;size += nb_read_bytes;\n                } else {\n                    GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Could not read frame length in Opus packet code 3\\n&quot;));\n                    return 0;\n                }\n                sum += header-&gt;frame_lengths[i];\n            }\n            if (!self_delimited) {\n                header-&gt;frame_lengths[header-&gt;nb_frames-1] = data_length - header-&gt;size - header-&gt;code3_padding_length - sum;\n                sum += header-&gt;frame_lengths[header-&gt;nb_frames-1];\n            }\n        } else {\n            u32 cbr_length;\n            if (self_delimited) {\n//                0                   1                   2                   3\n//                0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               | config  |s|1|1|0|p|     M     | Pad len (Opt) : N1 (1-2 bytes):\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 1 (N1 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 2 (N1 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :                              ...                              :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame M (N1 bytes)...                :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               :                  Opus Padding (Optional)...                   |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n                cbr_length = header-&gt;self_delimited_length;\n            } else {\n//                0                   1                   2                   3\n//                0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               | config  |s|1|1|0|p|     M     |  Padding length (Optional)    :\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 1 (R/M bytes)...               :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame 2 (R/M bytes)...               :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :                              ...                              :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               |                                                               |\n//               :               Compressed frame M (R/M bytes)...               :\n//               |                                                               |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n//               :                  Opus Padding (Optional)...                   |\n//               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n                if ((data_length - header-&gt;size - header-&gt;code3_padding_length) % header-&gt;nb_frames) {\n                    GF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;Sum of frame lengths is not a multiple of the number of frames\\n&quot;));\n                    return 0;\n                }\n                cbr_length = (data_length - header-&gt;size - header-&gt;code3_padding_length)/header-&gt;nb_frames;\n            }\n            for (i = 0; i &lt; header-&gt;nb_frames; i++) {\n                header-&gt;frame_lengths[i] = cbr_length;\n                sum += header-&gt;frame_lengths[i];\n            }\n        }\n        header-&gt;packet_size = header-&gt;size + header-&gt;code3_padding_length + sum;\n    }\n    return 1;\n}\n\nu64 gf_mpegh_escaped_value(GF_BitStream *bs, u32 nBits1, u32 nBits2, u32 nBits3)\n{\n\tu64 value = gf_bs_read_int(bs, nBits1);\n\tif (value == (1&lt;&lt;nBits1)-1) {\n\t\tu32 vadd = gf_bs_read_int(bs, nBits2);\n\t\tvalue += vadd;\n\t\tif (vadd == (1&lt;&lt;nBits2)-1) {\n\t\t\tvadd = gf_bs_read_int(bs, nBits3);\n\t\t\tvalue += vadd;\n\t\t}\n\t}\n\treturn value;\n}\n\nGF_EXPORT\ns32 gf_mpegh_get_mhas_pl(u8 *ptr, u32 size, u64 *ch_layout)\n{\n\ts32 PL = -1;\n\tGF_BitStream *bs;\n\tu32 i;\n\ts32 sync_pos=-1;\n\n\tif (!ptr || !size) return 0;\n\t\n\tfor (i=0; i&lt;size-3; i++) {\n\t\tif ((ptr[i]==0xC0) &amp;&amp; (ptr[i+1]== 0x01) &amp;&amp; (ptr[i+2]==0xA5)) {\n\t\t\tsync_pos = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (sync_pos&lt;0) return 0;\n\tif (ch_layout) *ch_layout = 0;\n\tbs = gf_bs_new(ptr, size, GF_BITSTREAM_READ);\n\tgf_bs_skip_bytes(bs, sync_pos);\n\n\twhile (gf_bs_available(bs)) {\n\t\tu32 type = (u32) gf_mpegh_escaped_value(bs, 3, 8, 8);\n\t\t/*u64 label = */gf_mpegh_escaped_value(bs, 2, 8, 32);\n\t\tu64 mh_size = gf_mpegh_escaped_value(bs, 11, 24, 24);\n\t\tif (mh_size &gt; gf_bs_available(bs))\n\t\t\tbreak;\n\t\t//MHAS config\n\t\tif (type==1) {\n\t\t\tPL = gf_bs_read_int(bs, 8);\n\t\t\tif (ch_layout) {\n\t\t\t\tu32 idx = gf_bs_read_int(bs, 5);\n\t\t\t\tif (idx==0x1f)\n\t\t\t\t\tgf_bs_read_int(bs, 24);\n\t\t\t\t/*idx = */gf_bs_read_int(bs, 3);\n\t\t\t\tgf_bs_read_int(bs, 1);\n\t\t\t\tgf_bs_read_int(bs, 1);\n\n\t\t\t\t//speaker config\n\t\t\t\tidx = gf_bs_read_int(bs, 2);\n\t\t\t\tif (idx == 0) {\n\t\t\t\t\t*ch_layout = gf_audio_fmt_get_layout_from_cicp( gf_bs_read_int(bs, 6) );\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tgf_bs_skip_bytes(bs, mh_size);\n\t}\n\tgf_bs_del(bs);\n\treturn PL;\n}\n\nGF_EXPORT\nvoid gf_vvc_parse_sei(char *buffer, u32 nal_size, VVCState *vvc)\n{\n\tgf_hevc_vvc_parse_sei(buffer, nal_size, NULL, vvc);\n}\n\nstatic Bool vvc_parse_nal_header(GF_BitStream *bs, u8 *nal_unit_type, u8 *temporal_id, u8 *layer_id)\n{\n\tu32 val;\n\tval = gf_bs_read_int_log(bs, 1, &quot;forbidden_zero&quot;);\n\tif (val) return GF_FALSE;\n\tval = gf_bs_read_int_log(bs, 1, &quot;reserved_zero&quot;);\n\tif (val) return GF_FALSE;\n\n\tval = gf_bs_read_int_log(bs, 6, &quot;layerID&quot;);\n\tif (layer_id) *layer_id = val;\n\n\tval = gf_bs_read_int_log(bs, 5, &quot;nuh_type&quot;);\n\tif (nal_unit_type) *nal_unit_type = val;\n\n\tval = gf_bs_read_int_log(bs, 3, &quot;temporalID&quot;);\n\tif (!val) return GF_FALSE;\n\tval -= 1;\n\tif (temporal_id) *temporal_id = val;\n\treturn GF_TRUE;\n}\n\nstatic void vvc_profile_tier_level(GF_BitStream *bs, VVC_ProfileTierLevel *ptl, u32 idx)\n{\n\tu32 i;\n\tif (ptl-&gt;pt_present) {\n\t\tptl-&gt;general_profile_idc = gf_bs_read_int_log_idx(bs, 7, &quot;general_profile_idc&quot;, idx);\n\t\tptl-&gt;general_tier_flag = gf_bs_read_int_log_idx(bs, 1, &quot;general_tier_flag&quot;, idx);\n\t}\n\tptl-&gt;general_level_idc = gf_bs_read_int_log_idx(bs, 8, &quot;general_level_idc&quot;, idx);\n\tptl-&gt;frame_only_constraint = gf_bs_read_int_log_idx(bs, 1, &quot;frame_only_constraint&quot;, idx);\n\tptl-&gt;multilayer_enabled = gf_bs_read_int_log_idx(bs, 1, &quot;multilayer_enabled&quot;, idx);\n\t//general constraints info - max size if 1 + 81 + 8 + 255\n\tif (ptl-&gt;pt_present) {\n\t\t//\t\tgeneral_constraints_info\n\t\tptl-&gt;gci_present = gf_bs_read_int_log_idx(bs, 1, &quot;gci_present&quot;, idx);\n\t\tif (ptl-&gt;gci_present) {\n\t\t\tu8 res;\n\t\t\tptl-&gt;gci[0] = 0x80;\n\t\t\tptl-&gt;gci[0] |= gf_bs_read_int(bs, 7);\n\t\t\t//71 buts till reserved, so 71-7 = 64bits = 8 bytes till reserved\n\t\t\tgf_bs_read_data(bs, ptl-&gt;gci+1, 8);\n\t\t\tptl-&gt;gci[10] = gf_bs_read_int(bs, 2)&lt;&lt;6;\n\t\t\t//skip extensions\n\t\t\tptl-&gt;gci[11] = 0;\n\t\t\tres = gf_bs_read_int(bs, 8);\n\t\t\tgf_bs_read_int(bs, res);\n\t\t}\n\t\tgf_bs_align(bs);\n\t}\n\tfor (i=ptl-&gt;ptl_max_tid; i&gt;0; i--) {\n\t\tptl-&gt;sub_ptl[i-1].level_present_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;level_present_flag&quot;, idx, i);\n\t}\n\tgf_bs_align(bs);\n\tfor (i=ptl-&gt;ptl_max_tid; i&gt;0; i--) {\n\t\tif (ptl-&gt;sub_ptl[i-1].level_present_flag)\n\t\t\tptl-&gt;sub_ptl[i-1].sublayer_level_idc = gf_bs_read_int_log_idx2(bs, 8, &quot;sublayer_level_idc&quot;, idx, i);\n\t}\n\tif (ptl-&gt;pt_present) {\n\t\tptl-&gt;num_sub_profiles = gf_bs_read_int_log_idx(bs, 8, &quot;num_sub_profiles&quot;, idx);\n\t\tfor (i=0; i&lt;ptl-&gt;num_sub_profiles; i++) {\n\t\t\tptl-&gt;sub_profile_idc[i] = gf_bs_read_int_log_idx2(bs, 32, &quot;sub_profile_idc&quot;, idx, i);\n\t\t}\n\t}\n}\n\nstatic s32 gf_vvc_read_vps_bs_internal(GF_BitStream *bs, VVCState *vvc, Bool stop_at_vps_ext)\n{\n\tu32 i, j;\n\ts32 vps_id;\n\tVVC_VPS *vps;\n\tBool vps_default_ptl_dpb_hrd_max_tid_flag=0;\n\n\t//nalu header already parsed\n\tvps_id = gf_bs_read_int_log(bs, 4, &quot;vps_id&quot;);\n\tif ((vps_id&lt;0) || (vps_id &gt;= 16)) return -1;\n\tif (!vps_id) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] VPS ID 0 is forbidden\\n&quot;));\n\t\treturn -1;\n\t}\n\tvps = &amp;vvc-&gt;vps[vps_id];\n\tif (!vps-&gt;state) {\n\t\tvps-&gt;id = vps_id;\n\t\tvps-&gt;state = 1;\n\t}\n\tvps-&gt;max_layers = 1 + gf_bs_read_int_log(bs, 6, &quot;max_layers&quot;);\n\tif (vps-&gt;max_layers &gt; VVC_MAX_LAYERS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] %d layers in VPS but only %d supported in GPAC\\n&quot;, vps-&gt;max_layers, VVC_MAX_LAYERS));\n\t\tvps-&gt;max_layers = VVC_MAX_LAYERS;\n\t\treturn -1;\n\t}\n\tvps-&gt;max_sub_layers = gf_bs_read_int_log(bs, 3, &quot;max_sub_layers_minus1&quot;) + 1;\n\n\tif ((vps-&gt;max_layers&gt;1) &amp;&amp; (vps-&gt;max_sub_layers&gt;1))\n\t\tvps_default_ptl_dpb_hrd_max_tid_flag = gf_bs_read_int_log(bs, 1, &quot;vps_default_ptl_dpb_hrd_max_tid_flag&quot;);\n\n\tif (vps-&gt;max_layers&gt;1)\n\t\tvps-&gt;all_layers_independent = gf_bs_read_int_log(bs, 1, &quot;all_layers_independent&quot;);\n\n\tfor (i=0; i&lt;vps-&gt;max_layers; i++) {\n\t\tu32 layer_id = gf_bs_read_int_log_idx(bs, 6, &quot;layer_id&quot;, i);\n\t\tif (layer_id&gt;vps-&gt;max_layer_id) vps-&gt;max_layer_id = layer_id;\n\t\tif (i &amp;&amp; !vps-&gt;all_layers_independent) {\n\t\t\tBool layer_indep = gf_bs_read_int_log_idx(bs, 1, &quot;layer_independent&quot;, i);\n\t\t\tif (!layer_indep) {\n\t\t\t\tBool vps_max_tid_ref_present_flag = gf_bs_read_int_log_idx(bs, 1, &quot;vps_max_tid_ref_present_flag&quot;, i);\n\t\t\t\tfor (j=0; j&lt;i; j++) {\n\t\t\t\t\tBool vps_direct_ref_layer_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;vps_direct_ref_layer_flag&quot;, i, j);\n\t\t\t\t\tif (vps_max_tid_ref_present_flag &amp;&amp; vps_direct_ref_layer_flag) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx2(bs, 3, &quot;vps_max_tid_il_ref_pics_plus1&quot;, i, j);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tvps-&gt;num_ptl = 1;\n\tif (vps-&gt;max_layers &gt; 1) {\n\t\tif (vps-&gt;all_layers_independent) {\n\t\t\tvps-&gt;each_layer_is_ols = gf_bs_read_int_log(bs, 1, &quot;each_layer_is_ols&quot;);\n\t\t}\n\t\tif (!vps-&gt;each_layer_is_ols) {\n\t\t\tu32 vps_ols_mode_idc = 2;\n\t\t\tif (!vps-&gt;all_layers_independent) {\n\t\t\t\tvps_ols_mode_idc = gf_bs_read_int_log(bs, 2, &quot;vps_ols_mode_idc&quot;);\n\t\t\t}\n\t\t\tif (vps_ols_mode_idc==2) {\n\t\t\t\tu8 vps_num_output_layer_sets = 2 + gf_bs_read_int_log(bs, 8, &quot;vps_num_output_layer_sets_minus2&quot;);\n\t\t\t\tfor (i=0; i&lt;vps_num_output_layer_sets; i++) {\n\t\t\t\t\tfor (j=0; j&lt;vps-&gt;max_layers; j++) {\n\t\t\t\t\t\tgf_bs_read_int_log_idx2(bs, 1, &quot;vps_ols_output_layer_flag&quot;, i, j);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tvps-&gt;num_ptl = 1 + gf_bs_read_int_log(bs, 8, &quot;num_ptl_minus1&quot;);\n\t}\n\tvps-&gt;ptl[0].pt_present = 1;\n\tfor (i=0; i&lt;vps-&gt;num_ptl; i++) {\n\t\tif (i)\n\t\t\tvps-&gt;ptl[i].pt_present = gf_bs_read_int_log_idx(bs, 1, &quot;pt_present&quot;, i);\n\t\tif (!vps_default_ptl_dpb_hrd_max_tid_flag)\n\t\t\tvps-&gt;ptl[i].ptl_max_tid = gf_bs_read_int_log_idx(bs, 3, &quot;ptl_max_tid&quot;, i);\n\t\telse\n\t\t\tvps-&gt;ptl[i].ptl_max_tid = vps-&gt;max_sub_layers - 1;\n\t}\n\t//align\n\tgf_bs_align(bs);\n\n\tfor (i=0; i&lt;vps-&gt;num_ptl; i++) {\n\t\tvvc_profile_tier_level(bs, &amp;vps-&gt;ptl[i], i);\n\t}\n\n\t//TODO, parse multilayer stuff\n\n\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn vps_id;\n}\n\nstatic s32 vvc_parse_ref_pic_list_struct(GF_BitStream *bs, VVC_SPS *sps, u32 listIdx, u32 rplsIdx, VVC_RefPicList *rpl)\n{\n\tu32 i;\n\tmemset(rpl, 0, sizeof(VVC_RefPicList));\n\trpl-&gt;num_ref_entries = gf_bs_read_ue_log_idx2(bs, &quot;num_ref_entries&quot;, listIdx, rplsIdx);\n\tif (rpl-&gt;num_ref_entries&gt;=VVC_MAX_REF_PICS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] num_ref_entries %d exceeds maximum allowed value %d\\n&quot;, rpl-&gt;num_ref_entries, VVC_MAX_REF_PICS));\n\t\treturn -1;\n\t}\n\n\trpl-&gt;ltrp_in_header_flag = 1;\n\tif (sps-&gt;long_term_ref_pics_flag\n\t\t&amp;&amp; rplsIdx &lt; sps-&gt;num_ref_pic_lists[listIdx]\n\t\t&amp;&amp; (rpl-&gt;num_ref_entries &gt; 0)\n\t) {\n\t\trpl-&gt;ltrp_in_header_flag = gf_bs_read_int_log_idx2(bs, 1, &quot;ltrp_in_header_flag&quot;, listIdx, rplsIdx);\n\t}\n\tfor (i=0; i &lt; rpl-&gt;num_ref_entries; i++) {\n\t\tBool inter_layer_ref_pic_flag = 0;\n\t\tif (sps-&gt;inter_layer_prediction_enabled_flag) {\n\t\t\tinter_layer_ref_pic_flag = gf_bs_read_int_log_idx3(bs, 1, &quot;inter_layer_ref_pic_flag&quot;, listIdx, rplsIdx, i);\n\t\t}\n\t\tif (!inter_layer_ref_pic_flag) {\n\t\t\tu32 AbsDeltaPocSt;\n\t\t\tBool st_ref_pic_flag = 1;\n\t\t\tif (sps-&gt;long_term_ref_pics_flag) {\n\t\t\t\tst_ref_pic_flag = gf_bs_read_int_log_idx3(bs, 1, &quot;st_ref_pic_flag&quot;, listIdx, rplsIdx, i);\n\t\t\t}\n\t\t\tif (st_ref_pic_flag) {\n\t\t\t\tu32 abs_delta_poc_st = gf_bs_read_ue_log_idx3(bs, &quot;abs_delta_poc_st&quot;, listIdx, rplsIdx, i);\n\n\t\t\t\tif ((sps-&gt;weighted_pred_flag || sps-&gt;weighted_bipred_flag) &amp;&amp; (i!=0)) {\n\t\t\t\t\tAbsDeltaPocSt = abs_delta_poc_st;\n\t\t\t\t} else {\n\t\t\t\t\tAbsDeltaPocSt = abs_delta_poc_st + 1;\n\t\t\t\t}\n\t\t\t\tif (AbsDeltaPocSt&gt;0) {\n\t\t\t\t\tgf_bs_read_int_log_idx3(bs, 1, &quot;strp_entry_sign_flag&quot;, listIdx, rplsIdx, i);\n\t\t\t\t}\n\t\t\t\trpl-&gt;nb_short_term_pictures++;\n\t\t\t\trpl-&gt;ref_pic_type[i] = VVC_RPL_ST;\n\t\t\t} else if( !rpl-&gt;ltrp_in_header_flag) {\n\t\t\t\tgf_bs_read_int_log_idx3(bs, sps-&gt;log2_max_poc_lsb, &quot;rpls_poc_lsb_lt&quot;, listIdx, rplsIdx, i);\n\t\t\t\trpl-&gt;nb_long_term_pictures++;\n\t\t\t\trpl-&gt;ref_pic_type[i] = VVC_RPL_LT;\n\t\t\t}\n\t\t} else {\n\t\t\tgf_bs_read_ue_log_idx3(bs, &quot;ilrp_idx&quot;, listIdx, rplsIdx, i);\n\t\t\trpl-&gt;nb_inter_layer_pictures ++;\n\t\t\trpl-&gt;ref_pic_type[i] = VVC_RPL_IL;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic void vvc_parse_general_timing_hrd_parameters(GF_BitStream *bs, VVC_SPS *sps, VVC_VPS *vps, Bool *general_nal_hrd_params_present_flag, Bool *general_vcl_hrd_params_present_flag, Bool *general_du_hrd_params_present_flag, u32 *hrd_cpb_cnt_minus1)\n{\n\tsps-&gt;has_timing_info = 1;\n\tsps-&gt;num_units_in_tick = gf_bs_read_int_log(bs, 32, &quot;num_units_in_tick&quot;);\n\tsps-&gt;time_scale = gf_bs_read_int_log(bs, 32, &quot;timescale&quot;);\n\t*general_du_hrd_params_present_flag = GF_FALSE;\n\t*general_nal_hrd_params_present_flag = gf_bs_read_int_log(bs, 1, &quot;general_nal_hrd_params_present_flag&quot;);\n\t*general_vcl_hrd_params_present_flag = gf_bs_read_int_log(bs, 1, &quot;general_vcl_hrd_params_present_flag&quot;);\n\tif (*general_nal_hrd_params_present_flag || *general_vcl_hrd_params_present_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;general_same_pic_timing_in_all_ols_flag&quot;);\n\t\t*general_du_hrd_params_present_flag = gf_bs_read_int_log(bs, 1, &quot;general_du_hrd_params_present_flag&quot;);\n\t\tif (*general_du_hrd_params_present_flag)\n\t\t\tgf_bs_read_int_log(bs, 8, &quot;tick_divisor_minus2&quot;);\n\t\tgf_bs_read_int_log(bs, 4, &quot;bit_rate_scale&quot;);\n\t\tgf_bs_read_int_log(bs, 4, &quot;cpb_size_scale&quot;);\n\t\tif (*general_du_hrd_params_present_flag)\n\t\t\tgf_bs_read_int_log(bs, 4, &quot;cpb_size_du_scale&quot;);\n\t\t*hrd_cpb_cnt_minus1 = gf_bs_read_ue_log(bs, &quot;hrd_cpb_cnt_minus1&quot;);\n\t}\n}\n\nstatic void vvc_parse_sublayer_hrd_parameters(GF_BitStream *bs, u32 subLayerId, Bool general_du_hrd_params_present_flag, u32 hrd_cpb_cnt_minus1)\n{\n\tu32 j;\n\tfor (j=0; j &lt;= hrd_cpb_cnt_minus1; j++) {\n\t\tgf_bs_read_ue_log_idx2(bs, &quot;bit_rate_value_minus1&quot;, subLayerId, j);\n\t\tgf_bs_read_ue_log_idx2(bs, &quot;cpb_size_value_minus1&quot;, subLayerId, j);\n\t\tif( general_du_hrd_params_present_flag ) {\n\t\t\tgf_bs_read_ue_log_idx2(bs, &quot;cpb_size_du_value_minus1&quot;, subLayerId, j);\n\t\t\tgf_bs_read_ue_log_idx2(bs, &quot;bit_rate_du_value_minus1&quot;, subLayerId, j);\n\t\t}\n\t\tgf_bs_read_int_log_idx2(bs, 1, &quot;cbr_flag&quot;, subLayerId, j);\n\t}\n}\n\nstatic void vvc_parse_ols_timing_hrd_parameters(GF_BitStream *bs, u32 firstSubLayer, u32 MaxSubLayersVal, Bool general_nal_hrd_params_present_flag, Bool general_vcl_hrd_params_present_flag, Bool general_du_hrd_params_present_flag, u32 hrd_cpb_cnt_minus1)\n{\n\tu32 i;\n\tfor (i=firstSubLayer; i&lt;=MaxSubLayersVal; i++) {\n\t\tBool fixed_pic_rate_within_cvs_flag = GF_TRUE;\n\t\tif (! gf_bs_read_int_log_idx(bs, 1, &quot;fixed_pic_rate_general_flag&quot;, i)) {\n\t\t\tfixed_pic_rate_within_cvs_flag = gf_bs_read_int_log_idx(bs, 1, &quot;fixed_pic_rate_within_cvs_flag&quot;, i);\n\t\t}\n\t\tif (fixed_pic_rate_within_cvs_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;elemental_duration_in_tc_minus1&quot;);\n\t\t} else if ( (general_nal_hrd_params_present_flag || general_vcl_hrd_params_present_flag)\n\t\t\t&amp;&amp; (hrd_cpb_cnt_minus1 ==0)\n\t\t) {\n\t\t\tgf_bs_read_int_log_idx(bs, 1, &quot;low_delay_hrd_flag&quot;, i);\n\t\t}\n\t\tif (general_nal_hrd_params_present_flag) {\n\t\t\tvvc_parse_sublayer_hrd_parameters(bs, i, general_du_hrd_params_present_flag, hrd_cpb_cnt_minus1);\n\t\t}\n\t\tif (general_vcl_hrd_params_present_flag) {\n\t\t\tvvc_parse_sublayer_hrd_parameters(bs, i, general_du_hrd_params_present_flag, hrd_cpb_cnt_minus1);\n\t\t}\n\t}\n}\n\nstatic s32 gf_vvc_read_sps_bs_internal(GF_BitStream *bs, VVCState *vvc, u8 layer_id, u32 *vui_flag_pos)\n{\n\ts32 vps_id, sps_id;\n\tu32 i, CtbSizeY;\n\tVVC_SPS *sps;\n\tu8 sps_ptl_dpb_hrd_params_present_flag;\n\n\tif (vui_flag_pos) *vui_flag_pos = 0;\n\n\tsps_id = gf_bs_read_int_log(bs, 4, &quot;sps_id&quot;);\n\tif ((sps_id&lt;0) || (sps_id &gt;= 16)) {\n\t\treturn -1;\n\t}\n\tvps_id = gf_bs_read_int_log(bs, 4, &quot;vps_id&quot;);\n\tif ((vps_id&lt;0) || (vps_id &gt;= 16)) {\n\t\treturn -1;\n\t}\n\tif (!vps_id &amp;&amp; !vvc-&gt;vps[0].state) {\n\t\tvvc-&gt;vps[0].state = 1;\n\t\tvvc-&gt;vps[0].num_ptl = 1;\n\t\tvvc-&gt;vps[0].max_layers = 1;\n\t\tvvc-&gt;vps[0].all_layers_independent = 1;\n\t}\n\n\tsps = &amp;vvc-&gt;sps[sps_id];\n\tif (!sps-&gt;state) {\n\t\tsps-&gt;state = 1;\n\t\tsps-&gt;id = sps_id;\n\t\tsps-&gt;vps_id = vps_id;\n\t}\n\tsps-&gt;max_sublayers = 1 + gf_bs_read_int_log(bs, 3, &quot;max_sublayers_minus1&quot;);\n\tsps-&gt;chroma_format_idc = gf_bs_read_int_log(bs, 2, &quot;chroma_format_idc&quot;);\n\tsps-&gt;log2_ctu_size = 5 + gf_bs_read_int_log(bs, 2, &quot;log2_ctu_size_minus5&quot;);\n\tCtbSizeY = 1&lt;&lt;sps-&gt;log2_ctu_size;\n\n\tsps_ptl_dpb_hrd_params_present_flag = gf_bs_read_int_log(bs, 1, &quot;sps_ptl_dpb_hrd_params_present_flag&quot;);\n\tif (sps_ptl_dpb_hrd_params_present_flag) {\n\t\tVVC_ProfileTierLevel ptl, *p_ptl;\n\t\tif (sps-&gt;vps_id) {\n\t\t\tp_ptl = &amp;ptl;\n\t\t} else {\n\t\t\tp_ptl = &amp;vvc-&gt;vps[0].ptl[0];\n\t\t}\n\t\tmemset(p_ptl, 0, sizeof(VVC_ProfileTierLevel));\n\t\tp_ptl-&gt;pt_present = 1;\n\t\tp_ptl-&gt;ptl_max_tid = sps-&gt;max_sublayers-1;\n\t\tvvc_profile_tier_level(bs, p_ptl, 0);\n\t}\n\tsps-&gt;gdr_enabled = gf_bs_read_int_log(bs, 1, &quot;gdr_enabled&quot;);\n\tsps-&gt;ref_pic_resampling = gf_bs_read_int_log(bs, 1, &quot;ref_pic_resampling&quot;);\n\tif (sps-&gt;ref_pic_resampling)\n\t\tsps-&gt;res_change_in_clvs = gf_bs_read_int_log(bs, 1, &quot;res_change_in_clvs&quot;);\n\tsps-&gt;width = gf_bs_read_ue_log(bs, &quot;width&quot;);\n\tsps-&gt;height = gf_bs_read_ue_log(bs, &quot;height&quot;);\n\tsps-&gt;conf_window = gf_bs_read_int_log(bs, 1, &quot;conformance_window_present_flag&quot;);\n\tif (sps-&gt;conf_window) {\n\t\tu32 SubWidthC, SubHeightC;\n\t\tsps-&gt;cw_left = gf_bs_read_ue_log(bs, &quot;conformance_window_left&quot;);\n\t\tsps-&gt;cw_right = gf_bs_read_ue_log(bs, &quot;conformance_window_right&quot;);\n\t\tsps-&gt;cw_top = gf_bs_read_ue_log(bs, &quot;conformance_window_top&quot;);\n\t\tsps-&gt;cw_bottom = gf_bs_read_ue_log(bs, &quot;conformance_window_bottom&quot;);\n\n\n\t\tif (sps-&gt;chroma_format_idc == 1) {\n\t\t\tSubWidthC = SubHeightC = 2;\n\t\t} else if (sps-&gt;chroma_format_idc == 2) {\n\t\t\tSubWidthC = 2;\n\t\t\tSubHeightC = 1;\n\t\t} else {\n\t\t\tSubWidthC = SubHeightC = 1;\n\t\t}\n\t\tsps-&gt;width -= SubWidthC * (sps-&gt;cw_left + sps-&gt;cw_right);\n\t\tsps-&gt;height -= SubHeightC * (sps-&gt;cw_top + sps-&gt;cw_bottom);\n\t}\n\t\n\tsps-&gt;subpic_info_present = gf_bs_read_int_log(bs, 1, &quot;subpic_info_present&quot;);\n\tif (sps-&gt;subpic_info_present) {\n\t\tsps-&gt;nb_subpics = 1 + gf_bs_read_ue_log(bs, &quot;nb_subpics_minus1&quot;);\n\t\tif (sps-&gt;nb_subpics&gt;1) {\n\t\t\tu32 tmpWidthVal, tmpHeightVal;\n\t\t\tsps-&gt;independent_subpic_flags = gf_bs_read_int_log(bs, 1, &quot;independent_subpic_flags&quot;);\n\t\t\tsps-&gt;subpic_same_size = gf_bs_read_int_log(bs, 1, &quot;subpic_same_size&quot;);\n\n\t\t\ttmpWidthVal = (sps-&gt;width + CtbSizeY-1) / CtbSizeY;\n\t\t\ttmpWidthVal = gf_get_bit_size(tmpWidthVal);\n\t\t\ttmpHeightVal = (sps-&gt;height + CtbSizeY-1) / CtbSizeY;\n\t\t\ttmpHeightVal = gf_get_bit_size(tmpHeightVal);\n\n\t\t\tfor (i=0; i&lt;sps-&gt;nb_subpics; i++) {\n\t\t\t\tif( !sps-&gt;subpic_same_size || !i) {\n\t\t\t\t\tif (i &amp;&amp; (sps-&gt;width &gt; CtbSizeY))\n\t\t\t\t\t\tgf_bs_read_int_log(bs, tmpWidthVal, &quot;subpic_ctu_top_left_x&quot;);\n\t\t\t\t\tif (i &amp;&amp; (sps-&gt;height &gt; CtbSizeY))\n\t\t\t\t\t\tgf_bs_read_int_log(bs, tmpHeightVal, &quot;subpic_ctu_top_left_y&quot;);\n\t\t\t\t\tif ((i+1 &lt; sps-&gt;nb_subpics) &amp;&amp; (sps-&gt;width &gt; CtbSizeY))\n\t\t\t\t\t\tgf_bs_read_int_log(bs, tmpWidthVal, &quot;subpic_width_minus1&quot;);\n\t\t\t\t\tif ((i+1 &lt; sps-&gt;nb_subpics) &amp;&amp; (sps-&gt;height &gt; CtbSizeY))\n\t\t\t\t\t\tgf_bs_read_int_log(bs, tmpHeightVal, &quot;subpic_height_minus1&quot;);\n\t\t\t\t}\n\t\t\t\tif (!sps-&gt;independent_subpic_flags) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;subpic_treated_as_pic_flag&quot;);\n\t\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;loop_filter_across_subpic_enabled_flag&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t\tsps-&gt;subpicid_len = gf_bs_read_ue_log(bs, &quot;subpic_id_len_minus1&quot;) + 1;\n\t\t\tsps-&gt;subpicid_mapping_explicit = gf_bs_read_int_log(bs, 1, &quot;subpic_id_mapping_explicitly_signalled_flag&quot;);\n\t\t\tif (sps-&gt;subpicid_mapping_explicit) {\n\t\t\t\tsps-&gt;subpicid_mapping_present = gf_bs_read_int_log(bs, 1, &quot;subpic_id_mapping_present_flag&quot;);\n\t\t\t\tif (sps-&gt;subpicid_mapping_present) {\n\t\t\t\t\tfor (i=0; i&lt;sps-&gt;nb_subpics; i++) {\n\t\t\t\t\t\tgf_bs_read_ue_log(bs, &quot;subpic_id&quot;);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tsps-&gt;nb_subpics = 1;\n\t}\n\tsps-&gt;bitdepth = gf_bs_read_ue_log(bs, &quot;bitdepth_minus8&quot;) + 8;\n\tsps-&gt;entropy_coding_sync_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;entropy_coding_sync_enabled_flag&quot;);\n\tsps-&gt;entry_point_offsets_present_flag = gf_bs_read_int_log(bs, 1, &quot;entry_point_offsets_present_flag&quot;);\n\tsps-&gt;log2_max_poc_lsb = 4 + gf_bs_read_int_log(bs, 4, &quot;log2_max_poc_lsb_minus4&quot;);\n\tif ((sps-&gt;poc_msb_cycle_flag = gf_bs_read_int_log(bs, 1, &quot;poc_msb_cycle_flag&quot;)))\n\t\tsps-&gt;poc_msb_cycle_len = 1 + gf_bs_read_ue_log(bs, &quot;poc_msb_cycle_len_minus1&quot;);\n\n\tu8 sps_num_extra_ph_bits = 8 * gf_bs_read_int_log(bs, 2, &quot;sps_num_extra_ph_bytes&quot;);\n\tfor (i=0; i&lt;sps_num_extra_ph_bits; i++) {\n\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;extra_ph_bit_present_flag&quot;, 1))\n\t\t\tsps-&gt;ph_num_extra_bits++;\n\t}\n\tu8 sps_num_extra_sh_bits = 8 * gf_bs_read_int_log(bs, 2, &quot;num_extra_sh_bytes&quot;);\n\tfor (i=0; i&lt;sps_num_extra_sh_bits; i++) {\n\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;extra_sh_bit_present_flag&quot;, i))\n\t\t\tsps-&gt;sh_num_extra_bits++;\n\t}\n\n\tif (sps_ptl_dpb_hrd_params_present_flag) {\n\t\tu8 sps_sublayer_dpb_params_flag = 0;\n\t\tif (sps-&gt;max_sublayers&gt;1) {\n\t\t\tsps_sublayer_dpb_params_flag = gf_bs_read_int_log(bs, 1, &quot;sps_sublayer_dpb_params_flag&quot;);\n\t\t}\n\t\tfor (i=(sps_sublayer_dpb_params_flag ? 0 : sps-&gt;max_sublayers-1); i &lt; sps-&gt;max_sublayers; i++ ) {\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;dpb_max_dec_pic_buffering_minus1&quot;, i);\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;dpb_max_num_reorder_pics&quot;, i);\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;dpb_max_latency_increase_plus1&quot;, i);\n\t\t}\n\t}\n\tgf_bs_read_ue_log(bs, &quot;sps_log2_min_luma_coding_block_size_minus2&quot;);\n\tsps-&gt;partition_constraints_override_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_partition_constraints_override_enabled_flag&quot;);\n\tgf_bs_read_ue_log(bs, &quot;sps_log2_min_luma_coding_block_size_minus2&quot;);\n\tu8 sps_max_mtt_hierarchy_depth_intra_slice_luma = gf_bs_read_ue_log(bs, &quot;sps_max_mtt_hierarchy_depth_intra_slice_luma&quot;);\n\tif (sps_max_mtt_hierarchy_depth_intra_slice_luma != 0) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_max_bt_min_qt_intra_slice_luma&quot;);\n\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_max_tt_min_qt_intra_slice_luma&quot;);\n\t}\n\tu8 sps_qtbtt_dual_tree_intra_flag = 0;\n\tif (sps-&gt;chroma_format_idc) {\n\t\tsps_qtbtt_dual_tree_intra_flag = gf_bs_read_int_log(bs, 1, &quot;sps_qtbtt_dual_tree_intra_flag&quot;);\n\t}\n\tif (sps_qtbtt_dual_tree_intra_flag) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_min_qt_min_cb_intra_slice_chroma&quot;);\n\t\tu8 sps_max_mtt_hierarchy_depth_intra_slice_chroma = gf_bs_read_ue_log(bs, &quot;sps_max_mtt_hierarchy_depth_intra_slice_chroma&quot;);\n\t\tif( sps_max_mtt_hierarchy_depth_intra_slice_chroma != 0) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_max_bt_min_qt_intra_slice_chroma&quot;);\n\t\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_max_tt_min_qt_intra_slice_chroma&quot;);\n\t\t}\n\t}\n\n\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_min_qt_min_cb_inter_slice&quot;);\n\tu8 sps_max_mtt_hierarchy_depth_inter_slice = gf_bs_read_ue_log(bs, &quot;sps_max_mtt_hierarchy_depth_inter_slice&quot;);\n\tif (sps_max_mtt_hierarchy_depth_inter_slice != 0) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_max_bt_min_qt_inter_slice&quot;);\n\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_diff_max_tt_min_qt_inter_slice&quot;);\n\t}\n\tu8 max_luma_transform_size_64_flag = 0;\n\tif (CtbSizeY &gt; 32) {\n\t\tmax_luma_transform_size_64_flag = gf_bs_read_int_log(bs, 1, &quot;sps_max_luma_transform_size_64_flag&quot;);\n\t}\n\tsps-&gt;transform_skip_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_transform_skip_enabled_flag&quot;);\n\n\tif (sps-&gt;transform_skip_enabled_flag) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_log2_transform_skip_max_size_minus2&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_bdpcm_enabled_flag&quot;);\n\t}\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_mts_enabled_flag&quot;)) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_explicit_mts_intra_enabled_flag&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_explicit_mts_inter_enabled_flag&quot;);\n\t}\n\tBool lfnst_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_lfnst_enabled_flag&quot;);\n\tsps-&gt;joint_cbcr_enabled_flag = 0;\n\tif (sps-&gt;chroma_format_idc) {\n\t\tsps-&gt;joint_cbcr_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_joint_cbcr_enabled_flag&quot;);\n\t\tu8 sps_same_qp_table_for_chroma_flag = gf_bs_read_int_log(bs, 1, &quot;sps_same_qp_table_for_chroma_flag&quot;);\n\t\tu32 numQpTables = sps_same_qp_table_for_chroma_flag ? 1 : (sps-&gt;joint_cbcr_enabled_flag ? 3 : 2);\n\t\tfor (i=0; i&lt;numQpTables; i++) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;sps_qp_table_start_minus26&quot;, i);\n\t\t\tu32 j, sps_num_points_in_qp_table = 1 + gf_bs_read_ue_log_idx(bs, &quot;sps_num_points_in_qp_table_minus1&quot;, i);\n\t\t\tfor (j=0; j&lt;sps_num_points_in_qp_table; j++) {\n\t\t\t\tgf_bs_read_ue_log_idx2(bs, &quot;sps_delta_qp_in_val_minus1&quot;, i, j);\n\t\t\t\tgf_bs_read_ue_log_idx2(bs, &quot;sps_delta_qp_diff_val&quot;, i, j);\n\t\t\t}\n\t\t}\n\t}\n\tsps-&gt;sao_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_sao_enabled_flag&quot;);\n\tsps-&gt;alf_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_alf_enabled_flag&quot;);\n\tif (sps-&gt;alf_enabled_flag &amp;&amp; sps-&gt;chroma_format_idc) {\n\t\tsps-&gt;ccalf_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_ccalf_enabled_flag&quot;);\n\t}\n\tsps-&gt;lmcs_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_lmcs_enabled_flag&quot;);\n\tsps-&gt;weighted_pred_flag = gf_bs_read_int_log(bs, 1, &quot;sps_weighted_pred_flag&quot;);\n\tsps-&gt;weighted_bipred_flag = gf_bs_read_int_log(bs, 1, &quot;sps_weighted_bipred_flag&quot;);\n\tsps-&gt;long_term_ref_pics_flag = gf_bs_read_int_log(bs, 1, &quot;sps_long_term_ref_pics_flag&quot;);\n\tif (sps-&gt;vps_id&gt;0)\n\t\tsps-&gt;inter_layer_prediction_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_inter_layer_prediction_enabled_flag&quot;);\n\tsps-&gt;idr_rpl_present_flag = gf_bs_read_int_log(bs, 1, &quot;sps_idr_rpl_present_flag&quot;);\n\tu32 sps_rpl1_same_as_rpl0 = gf_bs_read_int_log(bs, 1, &quot;sps_rpl1_same_as_rpl0_flag&quot;) ? 1: 2;\n\tfor (i=0; i&lt;sps_rpl1_same_as_rpl0; i++) {\n\t\tu32 j;\n\t\tsps-&gt;num_ref_pic_lists[i] = gf_bs_read_ue_log_idx(bs, &quot;sps_num_ref_pic_lists&quot;, i);\n\t\tif (sps-&gt;num_ref_pic_lists[i] &gt; 64) return -1;\n\t\tfor (j=0; j&lt;sps-&gt;num_ref_pic_lists[i]; j++) {\n\t\t\ts32 res = vvc_parse_ref_pic_list_struct(bs, sps, i, j, &amp;sps-&gt;rps[i][j]);\n\t\t\tif (res&lt;0) return res;\n\t\t}\n\t}\n\tgf_bs_read_int_log(bs, 1, &quot;sps_ref_wraparound_enabled_flag&quot;);\n\tsps-&gt;temporal_mvp_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_temporal_mvp_enabled_flag&quot;);\n\tif (sps-&gt;temporal_mvp_enabled_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_sbtmvp_enabled_flag&quot;);\n\t}\n\tBool amvr_enabled = gf_bs_read_int_log(bs, 1, &quot;sps_amvr_enabled_flag&quot;);\n\tsps-&gt;bdof_control_present_in_ph_flag = 0;\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_bdof_enabled_flag&quot;)) {\n\t\tsps-&gt;bdof_control_present_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;sps_bdof_control_present_in_ph_flag&quot;);\n\t}\n\tgf_bs_read_int_log(bs, 1, &quot;sps_smvd_enabled_flag&quot;);\n\tsps-&gt;dmvr_control_present_in_ph_flag = 0;\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_dmvr_enabled_flag&quot;)) {\n\t\tsps-&gt;dmvr_control_present_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;sps_dmvr_control_present_in_ph_flag&quot;);\n\t}\n\tsps-&gt;mmvd_fullpel_only_enabled_flag = 0;\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_mmvd_enabled_flag&quot;)) {\n\t\tsps-&gt;mmvd_fullpel_only_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_mmvd_fullpel_only_enabled_flag&quot;);\n\t}\n\tu32 MaxNumMergeCand  = 6 - gf_bs_read_ue_log(bs, &quot;sps_six_minus_max_num_merge_cand&quot;);\n\n\tsps-&gt;prof_control_present_in_ph_flag = 0;\n\tgf_bs_read_int_log(bs, 1, &quot;sps_sbt_enabled_flag&quot;);\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_affine_enabled_flag&quot;)) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_five_minus_max_num_subblock_merge_cand&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_6param_affine_enabled_flag&quot;);\n\t\tif (amvr_enabled) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;sps_affine_amvr_enabled_flag&quot;);\n\t\t}\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;sps_affine_prof_enabled_flag&quot;)) {\n\t\t\tsps-&gt;prof_control_present_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;sps_prof_control_present_in_ph_flag&quot;);\n\t\t}\n\t}\n\n\tgf_bs_read_int_log(bs, 1, &quot;sps_bcw_enabled_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;sps_ciip_enabled_flag&quot;);\n\tif (MaxNumMergeCand &gt;= 2) {\n\t\tBool gpm_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_gpm_enabled_flag&quot;);\n\t\tif (gpm_enabled_flag &amp;&amp; (MaxNumMergeCand &gt;= 3)) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;sps_max_num_merge_cand_minus_max_num_gpm_cand&quot;);\n\t\t}\n\t}\n\tgf_bs_read_ue_log(bs, &quot;sps_log2_parallel_merge_level_minus2&quot;);\n\n\tgf_bs_read_int_log(bs, 1, &quot;sps_isp_enabled_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;sps_mrl_enabled_flag&quot;);\n\tgf_bs_read_int_log(bs, 1, &quot;sps_mip_enabled_flag&quot;);\n\tif (sps-&gt;chroma_format_idc != 0) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_cclm_enabled_flag&quot;);\n\t}\n\tif (sps-&gt;chroma_format_idc == 1) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_chroma_horizontal_collocated_flag&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_chroma_vertical_collocated_flag&quot;);\n\t}\n\tBool act_enabled_flag = GF_FALSE;\n\tBool palette_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_palette_enabled_flag&quot;);\n\tif ((sps-&gt;chroma_format_idc == 3) &amp;&amp; !max_luma_transform_size_64_flag) {\n\t\tact_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_act_enabled_flag&quot;);\n\t}\n\tif (sps-&gt;transform_skip_enabled_flag || palette_enabled_flag) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_min_qp_prime_ts&quot;);\n\t}\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_ibc_enabled_flag&quot;)) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_six_minus_max_num_ibc_merge_cand&quot;);\n\t}\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_ladf_enabled_flag&quot;)) {\n\t\tu32 num_ladf_intervals_minus2 = gf_bs_read_int_log(bs, 2, &quot;sps_num_ladf_intervals_minus2&quot;);\n\t\tgf_bs_read_se_log(bs, &quot;sps_ladf_lowest_interval_qp_offset&quot;);\n\t\tfor (i=0; i&lt;num_ladf_intervals_minus2+1; i++) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;sps_ladf_qp_offset&quot;, i);\n\t\t\tgf_bs_read_ue_log_idx(bs, &quot;sps_ladf_delta_threshold_minus1&quot;, i);\n\t\t}\n\t}\n\tsps-&gt;explicit_scaling_list_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_explicit_scaling_list_enabled_flag&quot;);\n\tif (lfnst_enabled_flag &amp;&amp; sps-&gt;explicit_scaling_list_enabled_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_scaling_matrix_for_lfnst_disabled_flag&quot;);\n\t}\n\tBool scaling_matrix_for_alternative_colour_space_disabled_flag = 0;\n\tif (act_enabled_flag &amp;&amp; sps-&gt;explicit_scaling_list_enabled_flag) {\n\t\tscaling_matrix_for_alternative_colour_space_disabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_scaling_matrix_for_alternative_colour_space_disabled_flag&quot;);\n\t}\n\tif (scaling_matrix_for_alternative_colour_space_disabled_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sps_scaling_matrix_designated_colour_space_flag&quot;);\n\t}\n\tsps-&gt;dep_quant_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_dep_quant_enabled_flag&quot;);\n\tsps-&gt;sign_data_hiding_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_sign_data_hiding_enabled_flag&quot;);\n\tsps-&gt;virtual_boundaries_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sps_virtual_boundaries_enabled_flag&quot;);\n\tif (sps-&gt;virtual_boundaries_enabled_flag) {\n\t\tsps-&gt;virtual_boundaries_present_flag = gf_bs_read_int_log(bs, 1, &quot;sps_virtual_boundaries_present_flag&quot;);\n\t\tif (sps-&gt;virtual_boundaries_present_flag) {\n\t\t\tu32 num_virtual_boundaries = gf_bs_read_ue_log(bs, &quot;sps_num_ver_virtual_boundaries&quot;);\n\t\t\tfor (i=0; i&lt;num_virtual_boundaries; i++) {\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;sps_virtual_boundary_pos_x_minus1&quot;, i);\n\t\t\t}\n\t\t\tnum_virtual_boundaries = gf_bs_read_ue_log(bs, &quot;sps_num_hor_virtual_boundaries&quot;);\n\t\t\tfor (i=0; i&lt;num_virtual_boundaries; i++) {\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;sps_virtual_boundary_pos_y_minus1&quot;, i);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (sps_ptl_dpb_hrd_params_present_flag) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;sps_timing_hrd_params_present_flag&quot;)) {\n\t\t\tBool general_nal_hrd_params_present_flag, general_vcl_hrd_params_present_flag, general_du_hrd_params_present_flag;\n\t\t\tu32 hrd_cpb_cnt_minus1=0;\n\t\t\tu32 sublayer_cpb_params_present_flag = 0;\n\t\t\tvvc_parse_general_timing_hrd_parameters(bs, sps, NULL, &amp;general_nal_hrd_params_present_flag, &amp;general_vcl_hrd_params_present_flag, &amp;general_du_hrd_params_present_flag, &amp;hrd_cpb_cnt_minus1);\n\t\t\tif (sps-&gt;max_sublayers &gt; 1) {\n\t\t\t\tsublayer_cpb_params_present_flag = gf_bs_read_int_log(bs, 1, &quot;sps_sublayer_cpb_params_present_flag&quot;);\n\t\t\t}\n\t\t\tu32 firstSubLayer = sublayer_cpb_params_present_flag ? 0 : sps-&gt;max_sublayers - 1;\n\t\t\tvvc_parse_ols_timing_hrd_parameters(bs, firstSubLayer, sps-&gt;max_sublayers-1, general_nal_hrd_params_present_flag, general_vcl_hrd_params_present_flag, general_du_hrd_params_present_flag, hrd_cpb_cnt_minus1);\n\n\t\t}\n\t}\n\n\tgf_bs_read_int_log(bs, 1, &quot;sps_field_seq_flag&quot;);\n\tif (vui_flag_pos) {\n\t\t*vui_flag_pos = (u32)gf_bs_get_bit_offset(bs);\n\t}\n\t//all this to get to VUI !!!\n\tif (gf_bs_read_int_log(bs, 1, &quot;sps_vui_parameters_present_flag&quot;)) {\n\t\tgf_bs_read_ue_log(bs, &quot;sps_vui_payload_size_minus1&quot;);\n\t\twhile (!gf_bs_is_align(bs)) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;sps_vui_alignment_zero_bit&quot;);\n\t\t}\n\t\t//vui parameters\n\t\tBool vui_progressive_source_flag = gf_bs_read_int_log(bs, 1, &quot;vui_progressive_source_flag&quot;);\n\t\tBool vui_interlaced_source_flag = gf_bs_read_int_log(bs, 1, &quot;vui_interlaced_source_flag&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;vui_non_packed_constraint_flag&quot;);\n\t\tgf_bs_read_int_log(bs, 1, &quot;vui_non_projected_constraint_flag&quot;);\n\t\tsps-&gt;aspect_ratio_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_aspect_ratio_info_present_flag&quot;);\n\t\tif (sps-&gt;aspect_ratio_info_present_flag) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;vui_aspect_ratio_constant_flag&quot;);\n\t\t\tsps-&gt;sar_idc = gf_bs_read_int_log(bs, 8, &quot;vui_aspect_ratio_idc&quot;);\n\t\t\tif (sps-&gt;sar_idc== 0xFF) {\n\t\t\t\tsps-&gt;sar_width = gf_bs_read_int_log(bs, 16, &quot;vui_sar_width&quot;);\n\t\t\t\tsps-&gt;sar_height = gf_bs_read_int_log(bs, 16, &quot;vui_sar_height&quot;);\n\t\t\t}\n\t\t}\n\t\tsps-&gt;overscan_info_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_overscan_info_present_flag&quot;);\n\t\tif (sps-&gt;overscan_info_present_flag) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;vui_overscan_appropriate_flag&quot;);\n\t\t}\n\t\tsps-&gt;colour_description_present_flag = gf_bs_read_int_log(bs, 1, &quot;vui_colour_description_present_flag&quot;);\n\t\tif (sps-&gt;colour_description_present_flag) {\n\t\t\tsps-&gt;colour_primaries = gf_bs_read_int_log(bs, 8, &quot;vui_colour_primaries&quot;);\n\t\t\tsps-&gt;transfer_characteristics = gf_bs_read_int_log(bs, 8, &quot;vui_transfer_characteristics&quot;);\n\t\t\tsps-&gt;matrix_coefficients = gf_bs_read_int_log(bs, 8, &quot;vui_matrix_coeffs&quot;);\n\t\t\tsps-&gt;video_full_range_flag = gf_bs_read_int_log(bs, 1, &quot;vui_full_range_flag&quot;);\n\t\t}\n\t\tif (gf_bs_read_int_log(bs, 1, &quot; vui_chroma_loc_info_present_flag&quot;)) {\n\t\t\tif (vui_progressive_source_flag &amp;&amp; !vui_interlaced_source_flag) {\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;vui_chroma_sample_loc_type_frame&quot;);\n\t\t\t} else {\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;vui_chroma_sample_loc_type_top_field&quot;);\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;vui_chroma_sample_loc_type_bottom_field&quot;);\n\t\t\t}\n\t\t}\n\t\t//WE DON&#x27;T PARSE vui_payload_bit_equal_to_one because we dont parse the rest (sps extensions)\n\t\t//if needed, see rewrite_vui code\n\t}\n\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn sps_id;\n}\n\nstatic s32 gf_vvc_read_pps_bs_internal(GF_BitStream *bs, VVCState *vvc)\n{\n\tu32 i;\n\ts32 pps_id;\n\tVVC_PPS *pps;\n\n\t//NAL header already read\n\tpps_id = gf_bs_read_int_log(bs, 6, &quot;pps_id&quot;);\n\n\tif ((pps_id &lt; 0) || (pps_id &gt;= 64)) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] wrong PPS ID %d in PPS\\n&quot;, pps_id));\n\t\treturn -1;\n\t}\n\tpps = &amp;vvc-&gt;pps[pps_id];\n\n\tif (!pps-&gt;state) {\n\t\tpps-&gt;id = pps_id;\n\t\tpps-&gt;state = 1;\n\t}\n\tpps-&gt;sps_id = gf_bs_read_int_log(bs, 4, &quot;sps_id&quot;);\n\tif (((s32)pps-&gt;sps_id&lt;0) || (pps-&gt;sps_id &gt;= 16)) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] wrong SPS ID %d in PPS\\n&quot;, pps-&gt;sps_id));\n\t\tpps-&gt;sps_id=0;\n\t\treturn -1;\n\t}\n\tvvc-&gt;sps_active_idx = pps-&gt;sps_id; /*set active sps*/\n\tpps-&gt;mixed_nal_types = gf_bs_read_int_log(bs, 1, &quot;mixed_nal_types&quot;);\n\tpps-&gt;width = gf_bs_read_ue_log(bs, &quot;width&quot;);\n\tpps-&gt;height = gf_bs_read_ue_log(bs, &quot;height&quot;);\n\tpps-&gt;conf_window = gf_bs_read_int_log(bs, 1, &quot;conformance_window_flag&quot;);\n\tif (pps-&gt;conf_window) {\n\t\tpps-&gt;cw_left = gf_bs_read_ue_log(bs, &quot;conf_win_left_offset&quot;);\n\t\tpps-&gt;cw_right = gf_bs_read_ue_log(bs, &quot;conf_win_right_offset&quot;);\n\t\tpps-&gt;cw_top = gf_bs_read_ue_log(bs, &quot;conf_win_top_offset&quot;);\n\t\tpps-&gt;cw_bottom = gf_bs_read_ue_log(bs, &quot;conf_win_bottom_offset&quot;);\n\t}\n\t//scaling window\n\tif (gf_bs_read_int_log(bs, 1, &quot;scaling_window_explicit_signaling_flag&quot;)) {\n\t\tgf_bs_read_se_log(bs, &quot;scaling_win_left_offset&quot;);\n\t\tgf_bs_read_se_log(bs, &quot;scaling_win_right_offset&quot;);\n\t\tgf_bs_read_se_log(bs, &quot;scaling_win_top_offset&quot;);\n\t\tgf_bs_read_se_log(bs, &quot;scaling_win_bottom_offset&quot;);\n\t}\n\tpps-&gt;output_flag_present_flag = gf_bs_read_int_log(bs, 1, &quot;output_flag_present_flag&quot;);\n\tpps-&gt;no_pic_partition_flag = gf_bs_read_int_log(bs, 1, &quot;no_pic_partition_flag&quot;);\n\tpps-&gt;subpic_id_mapping_present_flag = gf_bs_read_int_log(bs, 1, &quot;subpic_id_mapping_present_flag&quot;);\n\tu32 pps_num_subpics = 1;\n\tif (pps-&gt;subpic_id_mapping_present_flag) {\n\t\tu32 pps_subpic_id_len;\n\t\tif (!pps-&gt;no_pic_partition_flag) {\n\t\t\tpps_num_subpics = 1+gf_bs_read_ue_log(bs, &quot;pps_num_subpics_minus1&quot;);\n\t\t}\n\t\tpps_subpic_id_len = 1 + gf_bs_read_ue(bs);\n\t\tfor (i=0; i&lt;pps_num_subpics; i++) {\n\t\t\tgf_bs_read_int_log_idx(bs, pps_subpic_id_len, &quot;subpic_id&quot;, i);\n\t\t}\n\t}\n\tpps-&gt;single_slice_per_subpic_flag = 1;\n\tpps-&gt;num_slices_in_pic = 1;\n\n\tpps-&gt;num_tiles_in_pic = 0;\n\tif (!pps-&gt;no_pic_partition_flag) {\n\t\tu32 ctu_size = 5 + gf_bs_read_int_log(bs, 2, &quot;pps_log2_ctu_size_minus5&quot;);\n\t\tu32 num_exp_tile_columns = 1 + gf_bs_read_ue_log(bs, &quot;num_exp_tile_columns_minus1&quot;);\n\t\tu32 num_exp_tile_rows = 1 + gf_bs_read_ue_log(bs, &quot;num_exp_tile_rows_minus1&quot;);\n\n\t\tif (num_exp_tile_columns &gt; VVC_MAX_TILE_COLS) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] wrong num tile columns %d in PPS\\n&quot;, num_exp_tile_columns));\n\t\t\tpps-&gt;sps_id=0;\n\t\t\treturn -1;\n\t\t}\n\t\tif (num_exp_tile_rows &gt; VVC_MAX_TILE_ROWS) {\n\t\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] wrong num tile rows %d in PPS\\n&quot;, num_exp_tile_rows));\n\t\t\tpps-&gt;sps_id=0;\n\t\t\treturn -1;\n\t\t}\n\n\t\tctu_size = 1&lt;&lt;ctu_size;\n\t\tpps-&gt;pic_width_in_ctbsY = pps-&gt;width / ctu_size;\n\t\tif (pps-&gt;pic_width_in_ctbsY * ctu_size &lt; pps-&gt;width) pps-&gt;pic_width_in_ctbsY++;\n\t\tpps-&gt;pic_height_in_ctbsY = pps-&gt;height / ctu_size;\n\t\tif (pps-&gt;pic_height_in_ctbsY * ctu_size &lt; pps-&gt;height) pps-&gt;pic_height_in_ctbsY++;\n\n\t\tu32 nb_ctb_left = pps-&gt;pic_width_in_ctbsY;\n\t\tpps-&gt;num_tile_cols=0;\n\t\tu32 nb_ctb_last=0;\n\t\tfor (i=0; i&lt;num_exp_tile_columns; i++) {\n\t\t\tu32 nb_ctb_width = 1 + gf_bs_read_ue_log_idx(bs, &quot;tile_column_width_minus1&quot;, i);\n\t\t\tif (nb_ctb_left &lt; nb_ctb_width) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tnb_ctb_left -= nb_ctb_width;\n\t\t\tpps-&gt;tile_cols_width_ctb[i] = nb_ctb_width;\n\t\t\tnb_ctb_last = nb_ctb_width;\n\t\t\tpps-&gt;num_tile_cols++;\n\t\t\tif (pps-&gt;num_tile_cols &gt; VVC_MAX_TILE_COLS) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t}\n\t\tu32 uni_size_ctb = nb_ctb_last;\n\t\twhile (nb_ctb_left &gt;= uni_size_ctb) {\n\t\t\tnb_ctb_left -= uni_size_ctb;\n\t\t\tif (pps-&gt;num_tile_cols &gt;= VVC_MAX_TILE_COLS) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tpps-&gt;tile_cols_width_ctb[pps-&gt;num_tile_cols] = uni_size_ctb;\n\t\t\tpps-&gt;num_tile_cols++;\n\t\t}\n\t\tif (nb_ctb_left&gt;0) {\n\t\t\tif (pps-&gt;num_tile_cols &gt;= VVC_MAX_TILE_COLS) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tpps-&gt;tile_cols_width_ctb[pps-&gt;num_tile_cols] = nb_ctb_left;\n\t\t\tpps-&gt;num_tile_cols++;\n\t\t}\n\n\t\tnb_ctb_left = pps-&gt;pic_height_in_ctbsY;\n\t\tnb_ctb_last=0;\n\t\tpps-&gt;num_tile_rows=0;\n\t\tfor (i=0; i&lt;num_exp_tile_rows; i++) {\n\t\t\tu32 nb_ctb_height = 1 + gf_bs_read_ue_log_idx(bs, &quot;tile_row_height_minus1&quot;, i);\n\t\t\tif (nb_ctb_left &lt; nb_ctb_height) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tnb_ctb_left -= nb_ctb_height;\n\t\t\tpps-&gt;tile_rows_height_ctb[i] = nb_ctb_height;\n\t\t\tpps-&gt;num_tile_rows++;\n\t\t\tnb_ctb_last = nb_ctb_height;\n\t\t\tif (pps-&gt;num_tile_rows &gt; VVC_MAX_TILE_ROWS) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t}\n\t\tuni_size_ctb = nb_ctb_last;\n\t\twhile (nb_ctb_left &gt;= uni_size_ctb) {\n\t\t\tnb_ctb_left -= uni_size_ctb;\n\t\t\tif (pps-&gt;num_tile_rows &gt;= VVC_MAX_TILE_ROWS) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tpps-&gt;tile_rows_height_ctb[pps-&gt;num_tile_rows] = uni_size_ctb;\n\t\t\tpps-&gt;num_tile_rows++;\n\t\t}\n\t\tif (nb_ctb_left&gt;0) {\n\t\t\tif (pps-&gt;num_tile_rows &gt;= VVC_MAX_TILE_ROWS) {\n\t\t\t\tpps-&gt;sps_id=0;\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tpps-&gt;tile_rows_height_ctb[pps-&gt;num_tile_rows] = nb_ctb_left;\n\t\t\tpps-&gt;num_tile_rows++;\n\t\t}\n\n\t\tpps-&gt;num_tiles_in_pic = pps-&gt;num_tile_cols * pps-&gt;num_tile_rows;\n\t\tpps-&gt;slice_address_len = gf_get_bit_size(pps-&gt;num_tiles_in_pic);\n\t\tif (pps-&gt;num_tiles_in_pic &gt; 1) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;pps_loop_filter_across_tiles_enabled_flag&quot;);\n\t\t\tpps-&gt;rect_slice_flag = gf_bs_read_int_log(bs, 1, &quot;pps_rect_slice_flag&quot;);\n\t\t}\n\n\t\tif (pps-&gt;rect_slice_flag) {\n\t\t\tpps-&gt;single_slice_per_subpic_flag = gf_bs_read_int_log(bs, 1, &quot;pps_single_slice_per_subpic_flag&quot;);\n\t\t\tpps-&gt;num_slices_in_pic = pps_num_subpics;\n\t\t}\n\n\t\tif (pps-&gt;rect_slice_flag &amp;&amp; !pps-&gt;single_slice_per_subpic_flag) {\n\t\t\tpps-&gt;num_slices_in_pic = 1 + gf_bs_read_ue_log(bs, &quot;pps_num_slices_in_pic_minus1&quot;);\n\t\t\tu8 tile_idx_delta_present_flag = 0;\n\t\t\tif (pps-&gt;num_slices_in_pic &gt; 1) {\n\t\t\t\ttile_idx_delta_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_tile_idx_delta_present_flag&quot;);\n\t\t\t}\n\t\t\tfor (i=0; i&lt;pps-&gt;num_slices_in_pic-1; i++) {\n\t\t\t\t//TODO FIXME we assume single slice per tile\n\t\t\t\tu32 SliceTopLeftTileIdx=0;\n\t\t\t\tu32 RowHeightVal=0;\n\n\n\t\t\t\tu32 slice_width_in_tiles_minus1=0;\n\t\t\t\tu32 slice_height_in_tiles_minus1=0;\n\t\t\t\tif (SliceTopLeftTileIdx % pps-&gt;num_tile_cols != pps-&gt;num_tile_cols - 1) {\n\t\t\t\t\tslice_width_in_tiles_minus1 = gf_bs_read_ue_log_idx(bs, &quot;pps_slice_width_in_tiles_minus1&quot;, i);\n\t\t\t\t}\n\n\t\t\t\tif ( (SliceTopLeftTileIdx / pps-&gt;num_tile_cols != pps-&gt;num_tile_rows - 1)\n\t\t\t\t\t&amp;&amp; (tile_idx_delta_present_flag || (SliceTopLeftTileIdx % pps-&gt;num_tile_cols == 0) )\n\t\t\t\t) {\n\t\t\t\t\tslice_height_in_tiles_minus1 = gf_bs_read_ue_log_idx(bs, &quot;pps_slice_height_in_tiles_minus1&quot;, i);\n\t\t\t\t}\n\n\t\t\t\tif (!slice_width_in_tiles_minus1 &amp;&amp; !slice_height_in_tiles_minus1 &amp;&amp; (RowHeightVal &gt; 1 )\n\t\t\t\t) {\n\t\t\t\t\tu32 j, num_exp_slices_in_tile = gf_bs_read_ue_log_idx(bs, &quot;pps_num_exp_slices_in_tile&quot;, i);\n\t\t\t\t\tfor (j=0; j&lt;num_exp_slices_in_tile; j++) {\n\t\t\t\t\t\tgf_bs_read_ue_log_idx2 (bs, &quot;pps_exp_slice_height_in_ctus_minus1&quot;, i, j);\n\t\t\t\t\t}\n\t\t\t\t\t//TODO FIXME i += NumSlicesInTile[ i ] \u2212 1\n\t\t\t\t}\n\n\t\t\t\tif (tile_idx_delta_present_flag &amp;&amp; (i &lt; pps-&gt;num_slices_in_pic)) {\n\t\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;pps_tile_idx_delta_val&quot;, i);\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\tif (!pps-&gt;rect_slice_flag || pps-&gt;single_slice_per_subpic_flag || (pps-&gt;num_slices_in_pic &gt; 1)) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;pps_loop_filter_across_slices_enabled_flag&quot;);\n\t\t}\n\t}\n\n\n\tpps-&gt;cabac_init_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_cabac_init_present_flag&quot;);\n\tfor (i=0; i&lt;2; i++) {\n\t\tpps-&gt;num_ref_idx_default_active[i] = 1 + gf_bs_read_ue_log_idx(bs, &quot;pps_num_ref_idx_default_active_minus1&quot;, i);\n\t}\n\tpps-&gt;rpl1_idx_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_rpl1_idx_present_flag&quot;);\n\tpps-&gt;weighted_pred_flag = gf_bs_read_int_log(bs, 1, &quot;pps_weighted_pred_flag&quot;);\n\tpps-&gt;weighted_bipred_flag = gf_bs_read_int_log(bs, 1, &quot;pps_weighted_bipred_flag&quot;);\n\tif (gf_bs_read_int_log(bs, 1, &quot;pps_ref_wraparound_enabled_flag&quot;)) {\n\t\tgf_bs_read_ue_log(bs, &quot;pps_pic_width_minus_wraparound_offset&quot;);\n\t}\n\tgf_bs_read_se_log(bs, &quot;pps_init_qp_minus26&quot;);\n\tpps-&gt;cu_qp_delta_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;pps_cu_qp_delta_enabled_flag&quot;);\n\tpps-&gt;slice_chroma_qp_offsets_present_flag = 0;\n\tpps-&gt;chroma_tool_offsets_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_chroma_tool_offsets_present_flag&quot;);\n\tif (pps-&gt;chroma_tool_offsets_present_flag) {\n\t\tgf_bs_read_se_log(bs, &quot;pps_cb_qp_offset&quot;);\n\t\tgf_bs_read_se_log(bs, &quot;pps_cr_qp_offset&quot;);\n\t\tu8 joint_cbcr_qp_offset_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_joint_cbcr_qp_offset_present_flag&quot;);\n\t\tif (joint_cbcr_qp_offset_present_flag) {\n\t\t\tgf_bs_read_se_log(bs, &quot;pps_joint_cbcr_qp_offset_value&quot;);\n\t\t}\n\t\tpps-&gt;slice_chroma_qp_offsets_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_slice_chroma_qp_offsets_present_flag&quot;);\n\t\tpps-&gt;cu_chroma_qp_offset_list_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;pps_cu_chroma_qp_offset_list_enabled_flag&quot;);\n\t\tif (pps-&gt;cu_chroma_qp_offset_list_enabled_flag) {\n\t\t\tu32 pps_chroma_qp_offset_list_len = 1 + gf_bs_read_ue_log(bs, &quot;pps_chroma_qp_offset_list_len_minus1&quot;);\n\t\t\tfor (i=0; i&lt;pps_chroma_qp_offset_list_len; i++) {\n\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;pps_cb_qp_offset_list&quot;, i);\n\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;pps_cr_qp_offset_list&quot;, i);\n\t\t\t\tif (joint_cbcr_qp_offset_present_flag) {\n\t\t\t\t\tgf_bs_read_se_log_idx(bs, &quot;pps_joint_cbcr_qp_offset_list&quot;, i);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tpps-&gt;dbf_info_in_ph_flag = 0;\n\tpps-&gt;deblocking_filter_disabled_flag = 0;\n\tpps-&gt;deblocking_filter_override_enabled_flag = 0;\n\tif (gf_bs_read_int_log(bs, 1, &quot;pps_deblocking_filter_control_present_flag&quot;)) {\n\t\tpps-&gt;deblocking_filter_override_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;pps_deblocking_filter_override_enabled_flag&quot;);\n\t\tpps-&gt;deblocking_filter_disabled_flag = gf_bs_read_int_log(bs, 1, &quot;pps_deblocking_filter_disabled_flag&quot;);\n\n\t\tif (!pps-&gt;no_pic_partition_flag &amp;&amp; pps-&gt;deblocking_filter_override_enabled_flag) {\n\t\t\tpps-&gt;dbf_info_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;pps_dbf_info_in_ph_flag&quot;);\n\t\t}\n\t\tif (!pps-&gt;deblocking_filter_disabled_flag) {\n\t\t\tgf_bs_read_se_log(bs, &quot;pps_luma_beta_offset_div2&quot;);\n\t\t\tgf_bs_read_se_log(bs, &quot;pps_luma_tc_offset_div2&quot;);\n\t\t\tif (pps-&gt;chroma_tool_offsets_present_flag) {\n\t\t\t\tgf_bs_read_se_log(bs, &quot;pps_cb_beta_offset_div2&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;pps_cb_tc_offset_div2&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;pps_cr_beta_offset_div2&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;pps_cr_tc_offset_div2&quot;);\n\t\t\t}\n\t\t}\n\t}\n\tpps-&gt;wp_info_in_ph_flag = 0;\n\tpps-&gt;qp_delta_info_in_ph_flag = 0;\n\tpps-&gt;sao_info_in_ph_flag = 0;\n\tif (!pps-&gt;no_pic_partition_flag) {\n\t\tpps-&gt;rpl_info_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;pps_rpl_info_in_ph_flag&quot;);\n\t\tpps-&gt;sao_info_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;pps_sao_info_in_ph_flag&quot;);\n\t\tpps-&gt;alf_info_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;pps_alf_info_in_ph_flag&quot;);\n\t\tif ( (pps-&gt;weighted_pred_flag || pps-&gt;weighted_bipred_flag) &amp;&amp; pps-&gt;rpl_info_in_ph_flag) {\n\t\t\tpps-&gt;wp_info_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;pps_wp_info_in_ph_flag&quot;);\n\t\t}\n\t\tpps-&gt;qp_delta_info_in_ph_flag = gf_bs_read_int_log(bs, 1, &quot;pps_qp_delta_info_in_ph_flag&quot;);\n\t}\n\tpps-&gt;picture_header_extension_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_picture_header_extension_present_flag&quot;);\n\tpps-&gt;slice_header_extension_present_flag = gf_bs_read_int_log(bs, 1, &quot;pps_slice_header_extension_present_flag&quot;);\n\n\t//TODO\n\tif (gf_bs_read_int_log(bs, 1, &quot;pps_extension_flag&quot;)) {\n\t\t//while ( more_rbsp_data()) bit(1);\n\t}\n\t//rbsp_trailing_bits()\n\n\tif (gf_bs_is_overflow(bs))\n\t\treturn -1;\n\treturn pps_id;\n}\n\n\nstatic s32 vvc_parse_ref_pic_lists(GF_BitStream *bs, VVCSliceInfo *si, Bool is_pic_header)\n{\n\tu32 i;\n\ts32 *p_rpl_idx = is_pic_header ? &amp;si-&gt;ph_rpl_idx[0] : &amp;si-&gt;rpl_idx[0];\n\n\tu8 rpl_sps_flag_prev=0;\n\tfor (i=0; i&lt;2; i++) {\n\t\tVVC_RefPicList *rpl=NULL;\n\t\tu32 j;\n\t\tu8 rpl_sps_flag=0;\n\t\tu32 rpl_idx = 0;\n\t\tif ((si-&gt;sps-&gt;num_ref_pic_lists[i]&gt;0) &amp;&amp; (!i || si-&gt;pps-&gt;rpl1_idx_present_flag)) {\n\t\t\trpl_sps_flag = gf_bs_read_int_log_idx(bs, 1, &quot;rpl_sps_flag&quot;, i);\n\t\t}\n\t\t/*\n\t\tWhen rpl_sps_flag[ i ] is not present, it is inferred as follows:\n\t\t\u23af If sps_num_ref_pic_lists[ i ] is equal to 0, the value of rpl_sps_flag[ i ] is inferred to be equal to 0.\n\t\t\u23af Otherwise (sps_num_ref_pic_lists[ i ] is greater than 0), when pps_rpl1_idx_present_flag is equal to 0 and i is equal to 1, the value of rpl_sps_flag[ 1 ] is inferred to be equal to rpl_sps_flag[ 0 ].\n\t\t*/\n\t\telse {\n\t\t\tif (si-&gt;sps-&gt;num_ref_pic_lists[i]==0) {\n\t\t\t\trpl_sps_flag = 0;\n\t\t\t} else {\n\t\t\t\trpl_sps_flag = rpl_sps_flag_prev;\n\t\t\t}\n\t\t}\n\t\trpl_sps_flag_prev = rpl_sps_flag;\n\t\tif (is_pic_header) {\n\t\t\trpl = &amp;si-&gt;ph_rpl[i];\n\t\t} else {\n\t\t\trpl = &amp;si-&gt;rpl[i];\n\t\t}\n\n\t\tif (rpl_sps_flag) {\n\t\t\tif ((si-&gt;sps-&gt;num_ref_pic_lists[i]&gt;1) &amp;&amp; (!i || si-&gt;pps-&gt;rpl1_idx_present_flag)) {\n\t\t\t\tu32 nb_bits =  gf_get_bit_size(si-&gt;sps-&gt;num_ref_pic_lists[i]);\n\t\t\t\trpl_idx = gf_bs_read_int_log_idx(bs, nb_bits, &quot;rpl_idx&quot;, i);\n\t\t\t}\n\t\t\telse if (si-&gt;sps-&gt;num_ref_pic_lists[i] == 1) {\n\t\t\t\trpl_idx = 0;\n\t\t\t} else {\n\t\t\t\tassert(p_rpl_idx[0] != -1);\n\t\t\t\trpl_idx = p_rpl_idx[0];\n\t\t\t}\n\t\t\tp_rpl_idx[i] = rpl_idx;\n\t\t\tif (rpl_idx&gt;=VVC_MAX_REF_PICS) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[VVC] Picture header RplIdx %d greater than max allowed %d\\n&quot;, rpl_idx, VVC_MAX_REF_PICS));\n\t\t\t\treturn -1;\n\t\t\t}\n\n\t\t\tmemcpy(rpl, &amp;si-&gt;sps-&gt;rps[i][rpl_idx], sizeof(VVC_RefPicList));\n\n\t\t} else {\n\t\t\ts32 res = vvc_parse_ref_pic_list_struct(bs, si-&gt;sps, i, si-&gt;sps-&gt;num_ref_pic_lists[i], rpl);\n\t\t\tif (res&lt;0) return res;\n\t\t\tp_rpl_idx[i] = -1;\n\t\t}\n\n\t\tif (rpl-&gt;nb_long_term_pictures) {\n\t\t\tfor (j=0; j&lt;rpl-&gt;num_ref_entries; j++) {\n\t\t\t\tif (rpl-&gt;ref_pic_type[j] != VVC_RPL_LT) continue;\n\n\t\t\t\tif (rpl-&gt;ltrp_in_header_flag) {\n\t\t\t\t\tgf_bs_read_int_log_idx2(bs, si-&gt;sps-&gt;log2_max_poc_lsb, &quot;poc_lsb_lt&quot;, i, j);\n\t\t\t\t}\n\t\t\t\tif (gf_bs_read_int_log_idx2(bs, 1, &quot;delta_poc_msb_cycle_present_flag&quot;, i, j)) {\n\t\t\t\t\tgf_bs_read_ue_log_idx2(bs, &quot;delta_poc_msb_cycle_lt&quot;, i, j);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic s32 vvc_pred_weight_table(GF_BitStream *bs, VVCState *vvc, VVCSliceInfo *si, VVC_PPS *pps, VVC_SPS *sps, u32 *num_ref_idx_active)\n{\n\tu32 i, num_weights;\n\tu8 weights[VVC_MAX_REF_PICS];\n\tgf_bs_read_ue_log(bs, &quot;luma_log2_weight_denom&quot;);\n\tif (sps-&gt;chroma_format_idc) {\n\t\tgf_bs_read_se_log(bs, &quot;delta_chroma_log2_weight_denom&quot;);\n\t}\n\tif (pps-&gt;wp_info_in_ph_flag) {\n\t\tnum_weights = gf_bs_read_ue_log(bs, &quot;num_l0_weights&quot;);\n\t} else {\n\t\tnum_weights = num_ref_idx_active[0];\n\t}\n\tif (num_weights&gt;VVC_MAX_REF_PICS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] num weights L0 %d greater than max allowed %d\\n&quot;, num_weights, VVC_MAX_REF_PICS));\n\t\treturn -1;\n\t}\n\n\tmemset(weights, 0, sizeof(u8)*VVC_MAX_REF_PICS);\n\tfor (i=0; i&lt;num_weights; i++) {\n\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;luma_weight_l0_flag&quot;, i))\n\t\t\tweights[i] |= 1;\n\t}\n\tif (sps-&gt;chroma_format_idc) {\n\t\tfor (i=0; i&lt;num_weights; i++) {\n\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;chroma_weight_l0_flag&quot;, i))\n\t\t\t\tweights[i] |= 2;\n\t\t}\n\t}\n\tfor (i=0; i&lt;num_weights; i++) {\n\t\tif (weights[i] &amp; 1) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_luma_weight_l0&quot;, i);\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_offset_l0&quot;, i);\n\t\t}\n\t\tif (weights[i] &amp; 2) {\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_weight_l0&quot;, i, 0);\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_offset_l0&quot;, i, 0);\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_weight_l0&quot;, i, 1);\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_offset_l0&quot;, i, 1);\n\t\t}\n\t}\n\tnum_weights = 0;\n\tif (pps-&gt;weighted_bipred_flag &amp;&amp; pps-&gt;wp_info_in_ph_flag &amp;&amp; (si-&gt;ph_rpl[1].num_ref_entries &gt; 0)) {\n\t\tnum_weights = gf_bs_read_ue_log(bs, &quot;num_l1_weights&quot;);\n\t}\n\tif (!num_weights) return 0;\n\n\tif (num_weights&gt;VVC_MAX_REF_PICS) {\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CODING, (&quot;[VVC] num weights L1 %d greater than max allowed %d\\n&quot;, num_weights, VVC_MAX_REF_PICS));\n\t\treturn -1;\n\t}\n\n\tmemset(weights, 0, sizeof(u8)*VVC_MAX_REF_PICS);\n\tfor (i=0; i&lt;num_weights; i++) {\n\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;luma_weight_l1_flag&quot;, i))\n\t\t\tweights[i] |= 1;\n\t}\n\tif (sps-&gt;chroma_format_idc) {\n\t\tfor (i=0; i&lt;num_weights; i++) {\n\t\t\tif (gf_bs_read_int_log_idx(bs, 1, &quot;chroma_weight_l1_flag&quot;, i))\n\t\t\t\tweights[i] |= 2;\n\t\t}\n\t}\n\tfor (i=0; i&lt;num_weights; i++) {\n\t\tif (weights[i] &amp; 1) {\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;delta_luma_weight_l1&quot;, i);\n\t\t\tgf_bs_read_se_log_idx(bs, &quot;luma_offset_l1&quot;, i);\n\t\t}\n\t\tif (weights[i] &amp; 2) {\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_weight_l1&quot;, i, 0);\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_offset_l1&quot;, i, 0);\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_weight_l1&quot;, i, 1);\n\t\t\tgf_bs_read_se_log_idx2(bs, &quot;delta_chroma_offset_l1&quot;, i, 1);\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic s32 vvc_parse_picture_header(GF_BitStream *bs, VVCState *vvc, VVCSliceInfo *si)\n{\n\ts32 pps_id;\n\n\tsi-&gt;irap_or_gdr_pic = gf_bs_read_int_log(bs, 1, &quot;irap_or_gdr_pic&quot;);\n\tsi-&gt;non_ref_pic = gf_bs_read_int_log(bs, 1, &quot;non_ref_pic&quot;);\n\tif (si-&gt;irap_or_gdr_pic)\n\t\tsi-&gt;gdr_pic = gf_bs_read_int_log(bs, 1, &quot;gdr_pic&quot;);\n\n\tsi-&gt;intra_slice_allowed_flag = 1;\n\tif ((si-&gt;inter_slice_allowed_flag = gf_bs_read_int_log(bs, 1, &quot;inter_slice_allowed_flag&quot;)))\n\t\tsi-&gt;intra_slice_allowed_flag = gf_bs_read_int_log(bs, 1, &quot;intra_slice_allowed_flag&quot;);\n\n\tpps_id = gf_bs_read_ue_log(bs, &quot;pps_id&quot;);\n\tif ((pps_id&lt;0) || (pps_id &gt;= 64))\n\t\treturn -1;\n\tsi-&gt;pps = &amp;vvc-&gt;pps[pps_id];\n\tsi-&gt;sps = &amp;vvc-&gt;sps[si-&gt;pps-&gt;sps_id];\n\tsi-&gt;poc_lsb = gf_bs_read_int_log(bs, si-&gt;sps-&gt;log2_max_poc_lsb, &quot;poc_lsb&quot;);\n\n\tsi-&gt;recovery_point_valid = 0;\n\tsi-&gt;gdr_recovery_count = 0;\n\tif (si-&gt;gdr_pic) {\n\t\tsi-&gt;recovery_point_valid = 1;\n\t\tsi-&gt;gdr_recovery_count = gf_bs_read_ue_log(bs, &quot;gdr_recovery_count&quot;);\n\t}\n\tgf_bs_read_int_log(bs, si-&gt;sps-&gt;ph_num_extra_bits, &quot;ph_extra_bits&quot;);\n\n\tif (si-&gt;sps-&gt;poc_msb_cycle_flag) {\n\t\tif ( (si-&gt;poc_msb_cycle_present_flag = gf_bs_read_int_log(bs, 1, &quot;poc_msb_cycle_present_flag&quot;))) {\n\t\t\tsi-&gt;poc_msb_cycle = gf_bs_read_int_log(bs, si-&gt;sps-&gt;poc_msb_cycle_len, &quot;poc_msb_cycle&quot;);\n\t\t}\n\t}\n\n\tif (si-&gt;sps-&gt;alf_enabled_flag &amp;&amp; si-&gt;pps-&gt;alf_info_in_ph_flag ) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;ph_alf_enabled_flag&quot;)) {\n\t\t\tu32 i, nb_aps_id = gf_bs_read_int_log(bs, 3, &quot;ph_num_alf_aps_ids_luma&quot;);\n\t\t\tfor (i=0; i&lt;nb_aps_id; i++) {\n\t\t\t\tgf_bs_read_int_log_idx(bs, 3, &quot;ph_alf_aps_id_luma&quot;, i);\n\t\t\t}\n\t\t\tu8 alf_cb_enabled_flag = 0, alf_cr_enabled_flag=0;\n\t\t\tif (si-&gt;sps-&gt;chroma_format_idc) {\n\t\t\t\talf_cb_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;ph_alf_cb_enabled_flag&quot;);\n\t\t\t\talf_cr_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;ph_alf_cr_enabled_flag&quot;);\n\t\t\t}\n\t\t\tif (alf_cb_enabled_flag || alf_cr_enabled_flag) {\n\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;ph_alf_aps_id_chroma&quot;);\n\t\t\t}\n\t\t\tif (si-&gt;sps-&gt;ccalf_enabled_flag ) {\n\t\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;ph_alf_cc_cb_enabled_flag&quot;)) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;ph_alf_cc_cb_aps_id&quot;);\n\t\t\t\t}\n\t\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;ph_alf_cc_cr_enabled_flag&quot;)) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;ph_alf_cc_cr_aps_id&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tsi-&gt;lmcs_enabled_flag = 0;\n\tif (si-&gt;sps-&gt;lmcs_enabled_flag) {\n\t\tsi-&gt;lmcs_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;ph_lmcs_enabled_flag&quot;);\n\t\tif (si-&gt;lmcs_enabled_flag) {\n\t\t\tgf_bs_read_int_log(bs, 2, &quot;ph_lmcs_aps_id&quot;);\n\t\t\tif (si-&gt;sps-&gt;chroma_format_idc) {\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_chroma_residual_scale_flag&quot;);\n\t\t\t}\n\t\t}\n\t}\n\tsi-&gt;explicit_scaling_list_enabled_flag = 0;\n\tif (si-&gt;sps-&gt;explicit_scaling_list_enabled_flag) {\n\t\tsi-&gt;explicit_scaling_list_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;ph_explicit_scaling_list_enabled_flag&quot;);\n\t\tif (si-&gt;explicit_scaling_list_enabled_flag) {\n\t\t\tgf_bs_read_int_log(bs, 3, &quot;ph_scaling_list_aps_id&quot;);\n\t\t}\n\t}\n\tif (si-&gt;sps-&gt;virtual_boundaries_enabled_flag &amp;&amp; !si-&gt;sps-&gt;virtual_boundaries_present_flag) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;ph_virtual_boundaries_present_flag&quot;)) {\n\t\t\tu32 i, nb_virt_boundaries = gf_bs_read_ue_log(bs, &quot;ph_num_ver_virtual_boundaries&quot;);\n\t\t\tfor (i=0; i&lt;nb_virt_boundaries; i++) {\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;ph_virtual_boundary_pos_x_minus1&quot;, i);\n\t\t\t}\n\t\t\tnb_virt_boundaries = gf_bs_read_ue_log(bs, &quot;ph_num_hor_virtual_boundaries&quot;);\n\t\t\tfor (i=0; i&lt;nb_virt_boundaries; i++) {\n\t\t\t\tgf_bs_read_ue_log_idx(bs, &quot;ph_virtual_boundary_pos_x_minus1&quot;, i);\n\t\t\t}\n\t\t}\n\t}\n\tif (si-&gt;pps-&gt;output_flag_present_flag &amp;&amp; !si-&gt;non_ref_pic) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;ph_pic_output_flag&quot;);\n\t}\n\tif (si-&gt;pps-&gt;rpl_info_in_ph_flag) {\n\t\ts32 res = vvc_parse_ref_pic_lists(bs, si, GF_TRUE);\n\t\tif (res&lt;0) return res;\n\t}\n\tu8 partition_constraints_override_flag = 0;\n\tif (si-&gt;sps-&gt;partition_constraints_override_enabled_flag) {\n\t\tpartition_constraints_override_flag = gf_bs_read_int_log(bs, 1, &quot;ph_partition_constraints_override_flag&quot;);\n\t}\n\tif (si-&gt;intra_slice_allowed_flag) {\n\t\tif (partition_constraints_override_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;ph_log2_diff_min_qt_min_cb_inter_slice&quot;);\n\t\t\tu32 max_mtt_hierarchy_depth_inter_slice = gf_bs_read_ue_log(bs, &quot;ph_max_mtt_hierarchy_depth_inter_slice&quot;);\n\t\t\tif (max_mtt_hierarchy_depth_inter_slice) {\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;ph_log2_diff_max_bt_min_qt_inter_slice&quot;);\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;ph_log2_diff_max_tt_min_qt_inter_slice&quot;);\n\t\t\t}\n\t\t}\n\t\tif (si-&gt;pps-&gt;cu_qp_delta_enabled_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;ph_cu_qp_delta_subdiv_inter_slice&quot;);\n\t\t}\n\t\tif (si-&gt;pps-&gt;cu_chroma_qp_offset_list_enabled_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;ph_cu_chroma_qp_offset_subdiv_intra_slice&quot;);\n\t\t}\n\t}\n\tsi-&gt;temporal_mvp_enabled_flag = 0;\n\tif (si-&gt;inter_slice_allowed_flag) {\n\t\tif (partition_constraints_override_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;ph_log2_diff_min_qt_min_cb_inter_slice&quot;);\n\t\t\tu32 max_mtt_hierarchy_depth_inter_slice = gf_bs_read_ue_log(bs, &quot;ph_max_mtt_hierarchy_depth_inter_slice&quot;);\n\t\t\tif (max_mtt_hierarchy_depth_inter_slice) {\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;ph_log2_diff_max_bt_min_qt_inter_slice&quot;);\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;ph_log2_diff_max_tt_min_qt_inter_slice&quot;);\n\t\t\t}\n\t\t}\n\t\tif (si-&gt;pps-&gt;cu_qp_delta_enabled_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;ph_cu_qp_delta_subdiv_inter_slice&quot;);\n\t\t}\n\t\tif (si-&gt;pps-&gt;cu_chroma_qp_offset_list_enabled_flag) {\n\t\t\tgf_bs_read_ue_log(bs, &quot;ph_cu_chroma_qp_offset_subdiv_inter_slice&quot;);\n\t\t}\n\t\tif (si-&gt;sps-&gt;temporal_mvp_enabled_flag) {\n\t\t\tsi-&gt;temporal_mvp_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;ph_temporal_mvp_enabled_flag&quot;);\n\t\t\tif (si-&gt;temporal_mvp_enabled_flag &amp;&amp; si-&gt;pps-&gt;rpl_info_in_ph_flag) {\n\t\t\t\tu8 collocated_from_l0_flag = 1;\n\t\t\t\tif (si-&gt;ph_rpl[1].num_ref_entries&gt;0)\n\t\t\t\t\tcollocated_from_l0_flag = gf_bs_read_int_log(bs, 1, &quot;ph_collocated_from_l0_flag&quot;);\n\n\t\t\t\tif ( (collocated_from_l0_flag &amp;&amp; si-&gt;ph_rpl[0].num_ref_entries &gt; 1)\n\t\t\t\t\t|| (!collocated_from_l0_flag &amp;&amp; si-&gt;ph_rpl[1].num_ref_entries &gt; 1)\n\t\t\t\t) {\n\t\t\t\t\tgf_bs_read_ue_log(bs, &quot;ph_collocated_ref_idx&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (si-&gt;sps-&gt;mmvd_fullpel_only_enabled_flag) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_mmvd_fullpel_only_flag&quot;);\n\t\t}\n\t\tu8 presenceFlag = 0;\n\t\tif (!si-&gt;pps-&gt;rpl_info_in_ph_flag) {\n\t\t\tpresenceFlag = 1;\n\t\t}\n\t\telse if (si-&gt;ph_rpl[1].num_ref_entries &gt; 0) {\n\t\t\tpresenceFlag = 1;\n\t\t}\n\t\tif (presenceFlag) {\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_mvd_l1_zero_flag&quot;);\n\t\t\tif (si-&gt;sps-&gt;bdof_control_present_in_ph_flag)\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_bdof_disabled_flag&quot;);\n\t\t\tif (si-&gt;sps-&gt;dmvr_control_present_in_ph_flag)\n\t\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_dmvr_disabled_flag&quot;);\n\t\t}\n\t\tif (si-&gt;sps-&gt;prof_control_present_in_ph_flag)\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_prof_disabled_flag&quot;);\n\n\t\tif ( (si-&gt;pps-&gt;weighted_pred_flag || si-&gt;pps-&gt;weighted_bipred_flag) &amp;&amp; si-&gt;pps-&gt;wp_info_in_ph_flag) {\n\t\t\ts32 res = vvc_pred_weight_table(bs, vvc, si, si-&gt;pps, si-&gt;sps, NULL);\n\t\t\tif (res&lt;0) return res;\n\t\t}\n\t}\n\tif (si-&gt;pps-&gt;qp_delta_info_in_ph_flag) {\n\t\tgf_bs_read_se_log(bs, &quot;ph_qp_delta&quot;);\n\t}\n\tif (si-&gt;sps-&gt;joint_cbcr_enabled_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;ph_joint_cbcr_sign_flag&quot;);\n\t}\n\tif (si-&gt;sps-&gt;sao_enabled_flag &amp;&amp; si-&gt;pps-&gt;sao_info_in_ph_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;ph_sao_luma_enabled_flag&quot;);\n\t\tif (si-&gt;sps-&gt;chroma_format_idc)\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;ph_sao_chroma_enabled_flag&quot;);\n\t}\n\tif (si-&gt;pps-&gt;dbf_info_in_ph_flag) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;ph_deblocking_params_present_flag&quot;)) {\n\t\t\t//defaults to 0\n\t\t\tu8 deblocking_filter_disabled_flag = 0;\n\n\t\t\tif (!si-&gt;pps-&gt;deblocking_filter_disabled_flag) {\n\t\t\t\tdeblocking_filter_disabled_flag = gf_bs_read_int_log(bs, 1, &quot;deblocking_filter_disabled_flag&quot;);\n\t\t\t}\n\t\t\tif (!deblocking_filter_disabled_flag) {\n\t\t\t\tgf_bs_read_se_log(bs, &quot;ph_luma_beta_offset_div2&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;ph_luma_tc_offset_div2&quot;);\n\t\t\t\tif (si-&gt;pps-&gt;chroma_tool_offsets_present_flag) {\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;ph_cb_beta_offset_div2&quot;);\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;ph_cb_tc_offset_div2&quot;);\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;ph_cr_beta_offset_div2&quot;);\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;ph_cr_tc_offset_div2&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (si-&gt;pps-&gt;picture_header_extension_present_flag) {\n\t\tu32 i=0, num_ext = gf_bs_read_ue_log(bs, &quot;ph_extension_length&quot;);\n\t\twhile (i&lt;num_ext) {\n\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;ph_extension_data_byte&quot;, i);\n\t\t\ti++;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic s32 vvc_get_ctb_info_in_slice(VVCSliceInfo *si, u32 sh_slice_address, u32 sh_num_tiles_in_slice, s32 ctu_index)\n{\n\tif (si-&gt;pps-&gt;rect_slice_flag) {\n/*\n\tTODO\n\t\tu32 picLevelSliceIdx = sh_slice_address;\n\t\tfor (j=0; j&lt;CurrSubpicIdx; j++) {\n\t\t\tpicLevelSliceIdx += NumSlicesInSubpic[j];\n\n\t\tu32 NumCtusInCurrSlice = NumCtusInSlice[picLevelSliceIdx];\n\t\tfor (i=0; i&lt;NumCtusInCurrSlice; i++)\n\t\t\tCtbAddrInCurrSlice[i] = CtbAddrInSlice[ picLevelSliceIdx ][ i ]\n*/\n\n\t} else {\n\t\tu32 i, tidx, NumCtusInCurrSlice = 0;\n\n\t\tfor (tidx=sh_slice_address; tidx &lt; sh_slice_address + sh_num_tiles_in_slice; tidx++) {\n\t\t\tu32 ctb_y, ctb_x;\n\t\t\tu32 tileX = tidx % si-&gt;pps-&gt;num_tile_cols;\n\t\t\tu32 tileY = tidx / si-&gt;pps-&gt;num_tile_cols;\n\t\t\tu32 min_ctbx=0;\n\t\t\tu32 max_ctbx=0;\n\t\t\tu32 min_ctby=0;\n\t\t\tu32 max_ctby=0;\n\n\t\t\tfor (i=0; i&lt;tileY; i++) min_ctby += si-&gt;pps-&gt;tile_rows_height_ctb[i];\n\t\t\tmax_ctby = min_ctby + si-&gt;pps-&gt;tile_rows_height_ctb[i];\n\n\t\t\tfor (i=0; i&lt;tileX; i++) min_ctbx += si-&gt;pps-&gt;tile_cols_width_ctb[i];\n\t\t\tmax_ctbx = min_ctbx + si-&gt;pps-&gt;tile_cols_width_ctb[i];\n\n\n\t\t\tfor (ctb_y=min_ctby; ctb_y &lt; max_ctby; ctb_y++) {\n\t\t\t\tfor (ctb_x=min_ctbx; ctb_x &lt; max_ctbx; ctb_x++) {\n\t\t\t\t\tif (ctu_index&gt;=0) {\n\t\t\t\t\t\tif (ctu_index == NumCtusInCurrSlice)\n\t\t\t\t\t\t\treturn ctb_y * si-&gt;pps-&gt;pic_width_in_ctbsY + ctb_x;\n\t\t\t\t\t}\n\t\t\t\t\tNumCtusInCurrSlice++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (ctu_index&gt;=0) return -1;\n\t\treturn NumCtusInCurrSlice;\n\t}\n\treturn -1;\n}\n\nstatic u32 vvc_ctb_to_tile_row_bd(VVCSliceInfo *si, u32 ctb_addr_y)\n{\n\tu32 i, tile_y = 0;\n\tu32 tile_row_bd_val = 0;\n\n\tfor (i=0; i &lt;= si-&gt;pps-&gt;pic_height_in_ctbsY; i++) {\n\t\tif (i == tile_row_bd_val + si-&gt;pps-&gt;tile_rows_height_ctb[tile_y]) {\n\t\t\ttile_row_bd_val += si-&gt;pps-&gt;tile_rows_height_ctb[tile_y];\n\t\t\ttile_y++;\n\t\t}\n\t\tif (ctb_addr_y == i) return tile_row_bd_val;\n\t}\n\treturn 0;\n}\n\nstatic u32 vvc_ctb_to_tile_col_bd(VVCSliceInfo *si, u32 ctb_addr_x)\n{\n\tu32 i, tile_x = 0;\n\tu32 tile_col_bd_val = 0;\n\tfor (i=0; i &lt;= si-&gt;pps-&gt;pic_width_in_ctbsY; i++) {\n\t\tif (i == tile_col_bd_val + si-&gt;pps-&gt;tile_cols_width_ctb[tile_x] ) {\n\t\t\ttile_col_bd_val += si-&gt;pps-&gt;tile_cols_width_ctb[tile_x];\n\t\t\ttile_x++;\n\t\t}\n\t\tif (ctb_addr_x == i) return tile_col_bd_val;\n\t}\n\treturn 0;\n}\n\nstatic u32 vvc_get_num_entry_points(VVCSliceInfo *si, u32 sh_slice_address, u32 sh_num_tiles_in_slice)\n{\n\tif (!si-&gt;sps-&gt;entry_point_offsets_present_flag) return 0;\n\n\tu32 nb_entry_points = 0;\n\tu32 prev_ctb_addr_y=0;\n\tu32 prev_ctb_to_tile_row_bd, prev_ctb_to_tile_col_bd;\n\ts32 i;\n\ts32 nb_ctus_in_slice = vvc_get_ctb_info_in_slice(si, sh_slice_address, sh_num_tiles_in_slice, -1);\n\tif (nb_ctus_in_slice&lt;0) return 0;\n\n\tfor (i=0; i &lt; nb_ctus_in_slice; i++ ) {\n\t\ts32 addr;\n\t\tu32 ctb_addr_x, ctb_addr_y;\n\t\tu32 ctb_to_tile_row_bd, ctb_to_tile_col_bd;\n\n\t\taddr = vvc_get_ctb_info_in_slice(si, sh_slice_address, sh_num_tiles_in_slice, i);\n\t\tif (addr&lt;0) return 0;\n\t\tctb_addr_x = (u32) ( addr % si-&gt;pps-&gt;pic_width_in_ctbsY );\n\t\tctb_addr_y = (u32) ( addr / si-&gt;pps-&gt;pic_width_in_ctbsY );\n\n\t\tctb_to_tile_row_bd = vvc_ctb_to_tile_row_bd(si, ctb_addr_y);\n\t\tctb_to_tile_col_bd = vvc_ctb_to_tile_col_bd(si, ctb_addr_x);\n\n\t\tif (i) {\n\n\t\t\tif ( ctb_to_tile_row_bd != prev_ctb_to_tile_row_bd\n\t\t\t\t|| ctb_to_tile_col_bd != prev_ctb_to_tile_col_bd\n\t\t\t\t|| ((ctb_addr_y != prev_ctb_addr_y) &amp;&amp; si-&gt;sps-&gt;entropy_coding_sync_enabled_flag)\n\t\t\t) {\n\t\t\t\tnb_entry_points++;\n\t\t\t}\n\n\t\t}\n\n\t\tprev_ctb_addr_y = ctb_addr_y;\n\t\tprev_ctb_to_tile_row_bd = ctb_to_tile_row_bd;\n\t\tprev_ctb_to_tile_col_bd = ctb_to_tile_col_bd;\n\t}\n\treturn nb_entry_points;\n}\n\nstatic s32 vvc_parse_slice(GF_BitStream *bs, VVCState *vvc, VVCSliceInfo *si)\n{\n\tu32 i, slice_address=0, num_tiles_in_slice=1;\n\n\tsi-&gt;picture_header_in_slice_header_flag = gf_bs_read_int_log(bs, 1, &quot;picture_header_in_slice_header_flag&quot;);\n\tif (si-&gt;picture_header_in_slice_header_flag) {\n\t\ts32 res = vvc_parse_picture_header(bs, vvc, si);\n\t\tif (res&lt;0) return res;\n\t}\n\tif (!si-&gt;sps) return -1;\n\tif (!si-&gt;pps) return -1;\n\tsi-&gt;slice_type = GF_VVC_SLICE_TYPE_I;\n\tif (si-&gt;sps-&gt;subpic_info_present) {\n\t\tgf_bs_read_int_log(bs, si-&gt;sps-&gt;subpicid_len, &quot;subpic_id&quot;);\n\t}\n\n\tif (si-&gt;pps-&gt;rect_slice_flag) {\n\t\tif ((si-&gt;sps-&gt;nb_subpics==1) &amp;&amp; (si-&gt;pps-&gt;num_slices_in_pic&lt;=1)) {\n\n\t\t} else {\n\t\t\tif (vvc-&gt;parse_mode==1) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[VVC] sub-picture parsing not yet implemented, wrong slice header size estimation (result might be non-compliant) - patch welcome\\n&quot;));\n\n\t\t\t\tgf_bs_align(bs);\n\t\t\t\tsi-&gt;payload_start_offset = (u32) gf_bs_get_position(bs);\n\t\t\t\treturn -2;\n\t\t\t}\n\t\t\tif (vvc-&gt;parse_mode) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[VVC] sub-picture parsing not supported, aborting slice header parsing - patch welcome\\n&quot;));\n\t\t\t}\n\t\t\treturn 0;\n\t\t\t//TODO\n\t// update CurrSubpicIdx\n\t//\t\tif (NumSlicesInSubpic[CurrSubpicIdx] &gt; 1) {\n\t//\t\t\tsh_slice_address\n\t//\t\t}\n\t\t}\n\t} else {\n\t\tif (si-&gt;pps-&gt;num_tiles_in_pic &gt; 1) {\n\t\t\tslice_address = gf_bs_read_int_log(bs, si-&gt;pps-&gt;slice_address_len, &quot;sh_slice_address&quot;);\n\t\t}\n\t}\n\n\tgf_bs_read_int_log(bs, si-&gt;sps-&gt;sh_num_extra_bits, &quot;num_extra_bits&quot;);\n\n\tif (!si-&gt;pps-&gt;rect_slice_flag &amp;&amp; (si-&gt;pps-&gt;num_tiles_in_pic - slice_address &gt; 1)) {\n\t\tnum_tiles_in_slice = 1 + gf_bs_read_ue_log(bs, &quot;sh_num_tiles_in_slice_minus1&quot;);\n\t}\n\n\tif (si-&gt;inter_slice_allowed_flag )\n\t\tsi-&gt;slice_type = gf_bs_read_ue_log(bs, &quot;slice_type&quot;);\n\n\tif (!vvc-&gt;parse_mode) return 0;\n\n\tswitch (si-&gt;nal_unit_type) {\n\tcase GF_VVC_NALU_SLICE_IDR_W_RADL:\n\tcase GF_VVC_NALU_SLICE_IDR_N_LP:\n\tcase GF_VVC_NALU_SLICE_CRA:\n\tcase GF_VVC_NALU_SLICE_GDR:\n\t\tgf_bs_read_int_log(bs, 1, &quot;sh_no_output_of_prior_pics_flag&quot;);\n\t\tbreak;\n\t}\n\tif (si-&gt;sps-&gt;alf_enabled_flag &amp;&amp; !si-&gt;pps-&gt;alf_info_in_ph_flag) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;sh_alf_enabled_flag&quot;)) {\n\t\t\tu32 nb_vals = gf_bs_read_int_log(bs, 3, &quot;sh_num_alf_aps_ids_luma&quot;);\n\t\t\tfor (i=0; i&lt;nb_vals; i++) {\n\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;sh_alf_aps_id_luma&quot;);\n\t\t\t}\n\t\t\tu8 sh_alf_cb_enabled_flag = 0;\n\t\t\tu8 sh_alf_cr_enabled_flag = 0;\n\t\t\tif (si-&gt;sps-&gt;chroma_format_idc) {\n\t\t\t\tsh_alf_cb_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sh_alf_cb_enabled_flag&quot;);\n\t\t\t\tsh_alf_cr_enabled_flag = gf_bs_read_int_log(bs, 1, &quot;sh_alf_cr_enabled_flag&quot;);\n\t\t\t}\n\t\t\tif (sh_alf_cb_enabled_flag || sh_alf_cr_enabled_flag) {\n\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;sh_alf_aps_id_chroma&quot;);\n\t\t\t}\n\t\t\tif (si-&gt;sps-&gt;ccalf_enabled_flag) {\n\t\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;sh_alf_cc_cb_enabled_flag&quot;)) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;sh_alf_cc_cb_aps_id&quot;);\n\t\t\t\t}\n\t\t\t\tif (gf_bs_read_int_log(bs, 1, &quot;sh_alf_cc_cr_enabled_flag&quot;)) {\n\t\t\t\t\tgf_bs_read_int_log(bs, 3, &quot;sh_alf_cc_cr_aps_id&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (si-&gt;lmcs_enabled_flag &amp;&amp; !si-&gt;picture_header_in_slice_header_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sh_lmcs_used_flag&quot;);\n\t}\n\tif (si-&gt;explicit_scaling_list_enabled_flag &amp;&amp; !si-&gt;picture_header_in_slice_header_flag) {\n\t\tgf_bs_read_int_log(bs, 3, &quot;sh_explicit_scaling_list_used_flag&quot;);\n\t}\n\n\tif (si-&gt;pps-&gt;rpl_info_in_ph_flag) {\n\t\tsi-&gt;rpl[0] = si-&gt;ph_rpl[0];\n\t\tsi-&gt;rpl[1] = si-&gt;ph_rpl[1];\n\t} else {\n\t\tmemset(&amp;si-&gt;rpl[0], 0, sizeof(VVC_RefPicList));\n\t\tmemset(&amp;si-&gt;rpl[1], 0, sizeof(VVC_RefPicList));\n\t}\n\n\tif (!si-&gt;pps-&gt;rpl_info_in_ph_flag\n\t\t&amp;&amp; ( ( (si-&gt;nal_unit_type != GF_VVC_NALU_SLICE_IDR_N_LP) &amp;&amp; (si-&gt;nal_unit_type != GF_VVC_NALU_SLICE_IDR_W_RADL) ) || si-&gt;sps-&gt;idr_rpl_present_flag)\n\t) {\n\t\ts32 res = vvc_parse_ref_pic_lists(bs, si, GF_FALSE);\n\t\tif (res&lt;0) return (vvc-&gt;parse_mode==1) ? res : 0;\n\t}\n\n\tu32 num_ref_idx_active[2] = {0, 0};\n\n\tif (\n\t\t((si-&gt;slice_type != GF_VVC_SLICE_TYPE_I) &amp;&amp; (si-&gt;rpl[0].num_ref_entries &gt; 1) )\n\t\t|| ((si-&gt;slice_type == GF_VVC_SLICE_TYPE_B) &amp;&amp; (si-&gt;rpl[1].num_ref_entries &gt; 1))\n\t) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;sh_num_ref_idx_active_override_flag&quot;)) {\n\t\t\t//L0\n\t\t\tu32 nb_active = 0;\n\t\t\tif (si-&gt;rpl[0].num_ref_entries&gt;1) {\n\t\t\t\tnb_active = 1 + gf_bs_read_ue_log_idx(bs, &quot;sh_num_ref_idx_active_minus1&quot;, 0);\n\t\t\t}\n\t\t\tnum_ref_idx_active[0] = nb_active;\n\t\t\t//L1\n\t\t\tif (si-&gt;slice_type == GF_VVC_SLICE_TYPE_B) {\n\t\t\t\tnb_active = 0;\n\t\t\t\tif (si-&gt;rpl[1].num_ref_entries&gt;1) {\n\t\t\t\t\tnb_active = 1 + gf_bs_read_ue_log_idx(bs, &quot;sh_num_ref_idx_active_minus1&quot;, 1);\n\t\t\t\t}\n\t\t\t\tnum_ref_idx_active[1] = nb_active;\n\t\t\t} else {\n\t\t\t\tnum_ref_idx_active[1] = 0;\n\t\t\t}\n\t\t} else {\n\t\t\tif (si-&gt;rpl[0].num_ref_entries &gt;= si-&gt;pps-&gt;num_ref_idx_default_active[0]) {\n\t\t\t\tnum_ref_idx_active[0] = si-&gt;pps-&gt;num_ref_idx_default_active[0];\n\t\t\t} else {\n\t\t\t\tnum_ref_idx_active[0] = si-&gt;rpl[0].num_ref_entries;\n\t\t\t}\n\t\t\tif (si-&gt;slice_type == GF_VVC_SLICE_TYPE_B) {\n\t\t\t\tif (si-&gt;rpl[1].num_ref_entries &gt;= si-&gt;pps-&gt;num_ref_idx_default_active[1]) {\n\t\t\t\t\tnum_ref_idx_active[1] = si-&gt;pps-&gt;num_ref_idx_default_active[1];\n\t\t\t\t} else {\n\t\t\t\t\tnum_ref_idx_active[1] = si-&gt;rpl[1].num_ref_entries;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tnum_ref_idx_active[1] = 0;\n\t\t\t}\n\t\t}\n\t} else {\n        num_ref_idx_active[0] = (si-&gt;slice_type == GF_VVC_SLICE_TYPE_I) ? 0 : 1;\n        num_ref_idx_active[1] = (si-&gt;slice_type == GF_VVC_SLICE_TYPE_B) ? 1 : 0;\n\t}\n\n\tif (si-&gt;slice_type != GF_VVC_SLICE_TYPE_I) {\n\t\tif (si-&gt;pps-&gt;cabac_init_present_flag)\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;sh_cabac_init_flag&quot;);\n\n\t\tif (si-&gt;temporal_mvp_enabled_flag &amp;&amp; !si-&gt;pps-&gt;rpl_info_in_ph_flag) {\n\t\t\tu8 collocated_from_l0_flag = 0;\n\t\t\tif (si-&gt;slice_type == GF_VVC_SLICE_TYPE_B) {\n\t\t\t\tcollocated_from_l0_flag = gf_bs_read_int_log(bs, 1, &quot;sh_collocated_from_l0_flag&quot;);\n\t\t\t}\n\t\t\tif ( (collocated_from_l0_flag &amp;&amp; (num_ref_idx_active[0] &gt; 1))\n\t\t\t\t|| (!collocated_from_l0_flag &amp;&amp; (num_ref_idx_active[1] &gt; 1))\n\t\t\t) {\n\t\t\t\tgf_bs_read_ue_log(bs, &quot;sh_collocated_ref_idx&quot;);\n\t\t\t}\n\t\t}\n\t\tif (!si-&gt;pps-&gt;wp_info_in_ph_flag\n\t\t\t&amp;&amp; (\n\t\t\t\t(si-&gt;pps-&gt;weighted_pred_flag &amp;&amp; (si-&gt;slice_type == GF_VVC_SLICE_TYPE_P) )\n\t\t\t\t|| (si-&gt;pps-&gt;weighted_bipred_flag &amp;&amp; (si-&gt;slice_type == GF_VVC_SLICE_TYPE_B))\n\t\t\t)\n\t\t) {\n\t\t\ts32 res = vvc_pred_weight_table(bs, vvc, si, si-&gt;pps, si-&gt;sps, num_ref_idx_active);\n\t\t\tif (res&lt;0) return (vvc-&gt;parse_mode==1) ? res : 0;\n\t\t}\n\t}\n\tif (!si-&gt;pps-&gt;qp_delta_info_in_ph_flag) {\n\t\tgf_bs_read_se_log(bs, &quot;sh_qp_delta&quot;);\n\t}\n\tif (si-&gt;pps-&gt;slice_chroma_qp_offsets_present_flag) {\n\t\tgf_bs_read_se_log(bs, &quot;sh_cb_qp_offset&quot;);\n\t\tgf_bs_read_se_log(bs, &quot;sh_cr_qp_offset&quot;);\n\t\tif (si-&gt;sps-&gt;joint_cbcr_enabled_flag)\n\t\t\tgf_bs_read_se_log(bs, &quot;sh_joint_cbcr_qp_offset&quot;);\n\t}\n\tif (si-&gt;pps-&gt;cu_chroma_qp_offset_list_enabled_flag)\n\t\tgf_bs_read_int_log(bs, 1, &quot;sh_cu_chroma_qp_offset_enabled_flag&quot;);\n\tif (si-&gt;sps-&gt;sao_enabled_flag &amp;&amp; !si-&gt;pps-&gt;sao_info_in_ph_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sh_sao_luma_used_flag&quot;);\n\t\tif (si-&gt;sps-&gt;chroma_format_idc)\n\t\t\tgf_bs_read_int_log(bs, 1, &quot;sh_sao_chroma_used_flag&quot;);\n\t}\n\n\tif (si-&gt;pps-&gt;deblocking_filter_override_enabled_flag &amp;&amp; !si-&gt;pps-&gt;dbf_info_in_ph_flag) {\n\t\tif (gf_bs_read_int_log(bs, 1, &quot;sh_deblocking_params_present_flag&quot;)) {\n\t\t\tu8 deblocking_params_present_flag=0;\n\t\t\tif (!si-&gt;pps-&gt;deblocking_filter_disabled_flag) {\n\t\t\t\tdeblocking_params_present_flag = gf_bs_read_int_log(bs, 1, &quot;sh_deblocking_filter_disabled_flag&quot;);\n\t\t\t}\n\t\t\tif (deblocking_params_present_flag) {\n\t\t\t\tgf_bs_read_se_log(bs, &quot;sh_luma_beta_offset_div2&quot;);\n\t\t\t\tgf_bs_read_se_log(bs, &quot;sh_luma_tc_offset_div2&quot;);\n\t\t\t\tif (si-&gt;pps-&gt;chroma_tool_offsets_present_flag) {\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;sh_cb_beta_offset_div2&quot;);\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;sh_cb_tc_offset_div2&quot;);\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;sh_cr_beta_offset_div2&quot;);\n\t\t\t\t\tgf_bs_read_se_log(bs, &quot;sh_cr_tc_offset_div2&quot;);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tu8 dep_quant_used_flag = 0;\n\tif (si-&gt;sps-&gt;dep_quant_enabled_flag) {\n\t\tdep_quant_used_flag = gf_bs_read_int_log(bs, 1, &quot;sh_dep_quant_used_flag&quot;);\n\t}\n\tu8 sign_data_hiding_used_flag = 0;\n\tif (si-&gt;sps-&gt;sign_data_hiding_enabled_flag &amp;&amp; !dep_quant_used_flag) {\n\t\tsign_data_hiding_used_flag = gf_bs_read_int_log(bs, 1, &quot;sh_sign_data_hiding_used_flag&quot;);\n\t}\n\tu8 ts_residual_coding_disabled_flag = 0;\n\tif (si-&gt;sps-&gt;transform_skip_enabled_flag &amp;&amp; !dep_quant_used_flag &amp;&amp; !sign_data_hiding_used_flag) {\n\t\tts_residual_coding_disabled_flag = gf_bs_read_int_log(bs, 1, &quot;sh_ts_residual_coding_disabled_flag&quot;);\n\t}\n\tif (!ts_residual_coding_disabled_flag &amp;&amp; si-&gt;sps-&gt;ts_residual_coding_rice_present_in_sh_flag) {\n\t\tgf_bs_read_int_log(bs, 3, &quot;sh_ts_residual_coding_rice_idx_minus1&quot;);\n\t}\n\tif (si-&gt;sps-&gt;reverse_last_sig_coeff_enabled_flag) {\n\t\tgf_bs_read_int_log(bs, 1, &quot;sh_reverse_last_sig_coeff_flag&quot;);\n\t}\n\tif (si-&gt;pps-&gt;slice_header_extension_present_flag) {\n\t\tu32 j=0, slice_header_extension_length = gf_bs_read_ue_log(bs, &quot;sh_slice_header_extension_length&quot;);\n\t\twhile (j&lt;slice_header_extension_length) {\n\t\t\tgf_bs_read_int_log_idx(bs, 8, &quot;sh_slice_header_extension_data_byte&quot;, j);\n\t\t\tj++;\n\t\t}\n\t}\n\n\tif (!si-&gt;pps-&gt;rect_slice_flag &amp;&amp; !si-&gt;pps-&gt;num_tile_cols &amp;&amp; !si-&gt;pps-&gt;num_tile_rows) {\n\t} else {\n\t\tif (si-&gt;sps-&gt;entry_point_offsets_present_flag &amp;&amp; si-&gt;pps-&gt;rect_slice_flag) {\n\t\t\tif (vvc-&gt;parse_mode==1) {\n\t\t\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[VVC] Entry point offsets parsing for sub-picture not yet implemented, wrong slice header size estimation (result might be non-compliant) - patch welcome\\n&quot;));\n\n\t\t\t\tgf_bs_align(bs);\n\t\t\t\tsi-&gt;payload_start_offset = (u32) gf_bs_get_position(bs);\n\t\t\t\treturn -2;\n\t\t\t}\n\t\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CODING, (&quot;[VVC] Entry point offsets parsing for sub-picture not yet implemented, aborting slice header parsing - patch welcome\\n&quot;));\n\t\t\treturn 0;\n\t\t}\n\n\t\tu32 nb_entry_points = vvc_get_num_entry_points(si, slice_address, num_tiles_in_slice);\n\t\tif (nb_entry_points) {\n\t\t\tu32 nb_bits = 1 + gf_bs_read_ue_log(bs, &quot;sh_entry_offset_len_minus1&quot;);\n\t\t\tfor (i=0; i&lt;nb_entry_points; i++) {\n\t\t\t\tgf_bs_read_int_log_idx(bs, nb_bits, &quot;sh_entry_point_offset_minus1&quot;, i);\n\t\t\t}\n\t\t}\n\t}\n\n\tu8 align_bit = gf_bs_read_int(bs, 1);\n\tif (align_bit != 1) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CODING, (&quot;[VVC] Align bit at end of slice header not set to 1 !\\n&quot;));\n\t\t//return error only for strict mdoe\n\t\tif (vvc-&gt;parse_mode==1) {\n\t\t\treturn -1;\n\t\t}\n\t}\n\tgf_bs_align(bs);\n\t//end of slice header\n\tsi-&gt;payload_start_offset = (u32) gf_bs_get_position(bs);\n\treturn 0;\n}\n\nstatic void vvc_compute_poc(VVCSliceInfo *si, Bool poc_reset)\n{\n\tu32 max_poc_lsb = 1 &lt;&lt; (si-&gt;sps-&gt;log2_max_poc_lsb);\n\n\tif (si-&gt;poc_msb_cycle_present_flag) {\n\t\tsi-&gt;poc_msb = si-&gt;poc_msb_cycle * max_poc_lsb;\n\t} else if (poc_reset) {\n\t\tsi-&gt;poc_msb = 0;\n\t} else {\n\t\tif ((si-&gt;poc_lsb &lt; si-&gt;poc_lsb_prev) &amp;&amp; (si-&gt;poc_lsb_prev - si-&gt;poc_lsb &gt;= max_poc_lsb / 2))\n\t\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev + max_poc_lsb;\n\t\telse if ((si-&gt;poc_lsb &gt; si-&gt;poc_lsb_prev) &amp;&amp; (si-&gt;poc_lsb - si-&gt;poc_lsb_prev &gt; max_poc_lsb / 2))\n\t\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev - max_poc_lsb;\n\t\telse\n\t\t\tsi-&gt;poc_msb = si-&gt;poc_msb_prev;\n\t}\n\n\tsi-&gt;poc = si-&gt;poc_msb + si-&gt;poc_lsb;\n}\n\n\nGF_EXPORT\ns32 gf_vvc_parse_nalu_bs(GF_BitStream *bs, VVCState *vvc, u8 *nal_unit_type, u8 *temporal_id, u8 *layer_id)\n{\n\tBool is_slice = GF_FALSE;\n\ts32 ret = -1;\n\tBool poc_reset = GF_FALSE;\n\tVVCSliceInfo n_state;\n\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\tif (gf_bs_available(bs)&lt;2) return -1;\n\tgf_bs_mark_overflow(bs, GF_TRUE);\n\n\tmemcpy(&amp;n_state, &amp;vvc-&gt;s_info, sizeof(VVCSliceInfo));\n\tif (!vvc_parse_nal_header(bs, nal_unit_type, temporal_id, layer_id)) return -1;\n\n\tn_state.nal_unit_type = *nal_unit_type;\n\n\tswitch (n_state.nal_unit_type) {\n\tcase GF_VVC_NALU_ACCESS_UNIT:\n\tcase GF_VVC_NALU_END_OF_SEQ:\n\tcase GF_VVC_NALU_END_OF_STREAM:\n\t\t//don&#x27;t restore slice info, we don&#x27;t have any change and n_state.poc_lsb / n_state.poc_msb is not valid\n\t\tvvc-&gt;s_info.nal_unit_type = n_state.nal_unit_type;\n\t\treturn 1;\n\n\tcase GF_VVC_NALU_SLICE_IDR_W_RADL:\n\tcase GF_VVC_NALU_SLICE_IDR_N_LP:\n\t\tpoc_reset = GF_TRUE;\n\tcase GF_VVC_NALU_SLICE_TRAIL:\n\tcase GF_VVC_NALU_SLICE_STSA:\n\tcase GF_VVC_NALU_SLICE_RADL:\n\tcase GF_VVC_NALU_SLICE_RASL:\n\tcase GF_VVC_NALU_SLICE_CRA:\n\tcase GF_VVC_NALU_SLICE_GDR:\n\t\t/* slice - read the info and compare.*/\n\t\tret = vvc_parse_slice(bs, vvc, &amp;n_state);\n\t\tif (ret &lt; 0) {\n\t\t\tmemcpy(&amp;vvc-&gt;s_info, &amp;n_state, sizeof(VVCSliceInfo));\n\t\t\treturn ret;\n\t\t}\n\t\t\n\t\tret = 0;\n\t\tif (n_state.compute_poc_defer || n_state.picture_header_in_slice_header_flag) {\n\t\t\tis_slice = GF_TRUE;\n\t\t\tn_state.compute_poc_defer = 0;\n\n\t\t\tvvc_compute_poc(&amp;n_state, poc_reset);\n\t\t\tif (vvc-&gt;s_info.poc != n_state.poc) {\n\t\t\t\tret = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (!(*layer_id) || (n_state.prev_layer_id_plus1 &amp;&amp; ((*layer_id) &lt;= n_state.prev_layer_id_plus1 - 1))) {\n\t\t\t\tret = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase GF_VVC_NALU_PIC_HEADER:\n\t\tif (vvc_parse_picture_header(bs, vvc, &amp;n_state)&lt;0) {\n\t\t\tret = -1;\n\t\t\tbreak;\n\t\t}\n\t\tis_slice = GF_TRUE;\n\n\t\t//we cannot compute poc until we know the first picture unit type, since IDR will reset poc count\n\t\t//and irap_or_gdr_pic=0 does not prevent IDR from following\n\t\tn_state.compute_poc_defer = 1;\n\n\t\tif (!(*layer_id) || (n_state.prev_layer_id_plus1 &amp;&amp; ((*layer_id) &lt;= n_state.prev_layer_id_plus1 - 1))) {\n\t\t\tret = 1;\n\t\t}\n\t\tbreak;\n\tcase GF_VVC_NALU_SEQ_PARAM:\n\t\tvvc-&gt;last_parsed_sps_id = gf_vvc_read_sps_bs_internal(bs, vvc, *layer_id, NULL);\n\t\tret = (vvc-&gt;last_parsed_sps_id&gt;=0) ? 0 : -1;\n\t\tbreak;\n\tcase GF_VVC_NALU_PIC_PARAM:\n\t\tvvc-&gt;last_parsed_pps_id = gf_vvc_read_pps_bs_internal(bs, vvc);\n\t\tret = (vvc-&gt;last_parsed_pps_id&gt;=0) ? 0 : -1;\n\t\tbreak;\n\tcase GF_VVC_NALU_VID_PARAM:\n\t\tvvc-&gt;last_parsed_vps_id = gf_vvc_read_vps_bs_internal(bs, vvc, GF_FALSE);\n\t\tret = (vvc-&gt;last_parsed_vps_id&gt;=0) ? 0 : -1;\n\t\tbreak;\n\tcase GF_VVC_NALU_DEC_PARAM:\n\t\tret = 0;\n\t\tbreak;\n\tcase GF_VVC_NALU_APS_PREFIX:\n\t\t//we use the mix aps type + aps id (first 8 bits) as unique identifier\n\t\tvvc-&gt;last_parsed_aps_id = gf_bs_read_int_log(bs, 8, &quot;aps_id&quot;);\n\t\tret = 0;\n\t\tbreak;\n\tdefault:\n\t\tret = 0;\n\t\tbreak;\n\t}\n\tif (gf_bs_is_overflow(bs)) ret = -1;\n\n\t/* save current POC lsb/msb to prev values */\n\tif ((ret&gt;0) &amp;&amp; vvc-&gt;s_info.sps) {\n\t\tif (!n_state.compute_poc_defer) {\n\t\t\tn_state.poc_lsb_prev = n_state.poc_lsb;\n\t\t\tn_state.poc_msb_prev = n_state.poc_msb;\n\t\t}\n\t\tif (is_slice)\n\t\t\tn_state.prev_layer_id_plus1 = *layer_id + 1;\n\t}\n\n\tmemcpy(&amp;vvc-&gt;s_info, &amp;n_state, sizeof(VVCSliceInfo));\n\n\treturn ret;\n}\n\nGF_EXPORT\ns32 gf_vvc_parse_nalu(u8 *data, u32 size, VVCState *vvc, u8 *nal_unit_type, u8 *temporal_id, u8 *layer_id)\n{\n\tGF_BitStream *bs = NULL;\n\ts32 ret;\n\n\tif (size&lt;2) return -1;\n\n\tif (!vvc) {\n\t\tif (nal_unit_type) (*nal_unit_type) = data[1] &gt;&gt; 3;\n\t\tif (layer_id) (*layer_id) = data[0] &amp; 0x3f;\n\t\tif (temporal_id) (*temporal_id) = (data[1] &amp; 0x7);\n\t\treturn -1;\n\t}\n\tbs = gf_bs_new(data, size, GF_BITSTREAM_READ);\n\tif (!bs) return -1;\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tret = gf_vvc_parse_nalu_bs(bs, vvc, nal_unit_type, temporal_id, layer_id);\n\tgf_bs_del(bs);\n\treturn ret;\n}\n\nBool gf_vvc_slice_is_ref(VVCState *vvc)\n{\n\tif (!vvc-&gt;s_info.irap_or_gdr_pic) {\n\t\treturn GF_FALSE;\n\t}\n\tif (vvc-&gt;s_info.gdr_pic) {\n\t\tif (vvc-&gt;s_info.recovery_point_valid) {\n\t\t\tvvc-&gt;s_info.recovery_point_valid = 0;\n\t\t\treturn GF_TRUE;\n\t\t}\n\t\treturn GF_FALSE;\n\t}\n\treturn GF_TRUE;\n}\n\n\nGF_EXPORT\nGF_Err gf_vvc_change_vui(GF_VVCConfig *vvcc, GF_VUIInfo *vui_info)\n{\n\tGF_BitStream *orig, *mod;\n\tVVCState *vvc;\n\tu32 i, bit_offset, flag;\n\ts32 idx;\n\tGF_NALUFFParamArray *spss;\n\tGF_NALUFFParam *slc;\n\torig = NULL;\n\n\tGF_SAFEALLOC(vvc, VVCState);\n\tif (!vvc) return GF_OUT_OF_MEM;\n\tvvc-&gt;sps_active_idx = -1;\n\n\ti = 0;\n\tspss = NULL;\n\twhile ((spss = (GF_NALUFFParamArray *)gf_list_enum(vvcc-&gt;param_array, &amp;i))) {\n\t\tif (spss-&gt;type == GF_VVC_NALU_SEQ_PARAM)\n\t\t\tbreak;\n\t\tspss = NULL;\n\t}\n\tif (!spss) {\n\t\tgf_free(vvc);\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\ti = 0;\n\twhile ((slc = (GF_NALUFFParam *)gf_list_enum(spss-&gt;nalus, &amp;i))) {\n\t\tu8 *no_emulation_buf;\n\t\tu32 no_emulation_buf_size, emulation_bytes;\n\t\tu8 nal_unit_type, temporal_id, layer_id;\n\n\t\t/*SPS may still contains emulation bytes*/\n\t\tno_emulation_buf = gf_malloc((slc-&gt;size) * sizeof(char));\n\t\tno_emulation_buf_size = gf_media_nalu_remove_emulation_bytes(slc-&gt;data, no_emulation_buf, slc-&gt;size);\n\n\t\torig = gf_bs_new(no_emulation_buf, no_emulation_buf_size, GF_BITSTREAM_READ);\n\t\tvvc_parse_nal_header(orig, &amp;nal_unit_type, &amp;temporal_id, &amp;layer_id);\n\t\tidx = gf_vvc_read_sps_bs_internal(orig, vvc, layer_id, &amp;bit_offset);\n\n\t\tif (idx &lt; 0) {\n\t\t\tif (orig)\n\t\t\t\tgf_bs_del(orig);\n\t\t\tgf_free(no_emulation_buf);\n\t\t\tgf_bs_del(orig);\n\t\t\tcontinue;\n\t\t}\n\n\t\tgf_bs_seek(orig, 0);\n\t\tmod = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);\n\n\t\t/*copy over till vui flag*/\n\t\tassert(bit_offset &gt;= 0);\n\t\twhile (bit_offset) {\n\t\t\tflag = gf_bs_read_int(orig, 1);\n\t\t\tgf_bs_write_int(mod, flag, 1);\n\t\t\tbit_offset--;\n\t\t}\n\n\t\tavc_hevc_vvc_rewrite_vui(vui_info, orig, mod, GF_CODECID_VVC);\n\n\t\t/*finally copy over remaining*/\n\t\twhile (gf_bs_bits_available(orig)) {\n\t\t\tflag = gf_bs_read_int(orig, 1);\n\t\t\tgf_bs_write_int(mod, flag, 1);\n\t\t}\n\t\tgf_bs_del(orig);\n\t\torig = NULL;\n\t\tgf_free(no_emulation_buf);\n\n\t\t/*set anti-emulation*/\n\t\tgf_bs_get_content(mod, &amp;no_emulation_buf, &amp;no_emulation_buf_size);\n\t\temulation_bytes = gf_media_nalu_emulation_bytes_add_count(no_emulation_buf, no_emulation_buf_size);\n\t\tif (no_emulation_buf_size + emulation_bytes &gt; slc-&gt;size)\n\t\t\tslc-&gt;data = (char*)gf_realloc(slc-&gt;data, no_emulation_buf_size + emulation_bytes);\n\n\t\tslc-&gt;size = gf_media_nalu_add_emulation_bytes(no_emulation_buf, slc-&gt;data, no_emulation_buf_size);\n\n\t\tgf_bs_del(mod);\n\t\tgf_free(no_emulation_buf);\n\t}\n\tgf_free(vvc);\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_vvc_change_par(GF_VVCConfig *vvcc, s32 ar_n, s32 ar_d)\n{\n\tGF_VUIInfo vuii;\n\tmemset(&amp;vuii, 0, sizeof(GF_VUIInfo));\n\tvuii.ar_num = ar_n;\n\tvuii.ar_den = ar_d;\n\tvuii.fullrange = -1;\n\tvuii.video_format = -1;\n\tvuii.color_prim = -1;\n\tvuii.color_tfc = -1;\n\tvuii.color_matrix = -1;\n\treturn gf_vvc_change_vui(vvcc, &amp;vuii);\n}\n\nGF_EXPORT\nGF_Err gf_vvc_change_color(GF_VVCConfig *vvcc, s32 fullrange, s32 vidformat, s32 colorprim, s32 transfer, s32 colmatrix)\n{\n\tGF_VUIInfo vuii;\n\tmemset(&amp;vuii, 0, sizeof(GF_VUIInfo));\n\tvuii.ar_num = -1;\n\tvuii.ar_den = -1;\n\tvuii.fullrange = fullrange;\n\tvuii.video_format = vidformat;\n\tvuii.color_prim = colorprim;\n\tvuii.color_tfc = transfer;\n\tvuii.color_matrix = colmatrix;\n\treturn gf_vvc_change_vui(vvcc, &amp;vuii);\n}\n\n\nGF_EXPORT\nGF_Err gf_vvc_get_sps_info(u8 *sps_data, u32 sps_size, u32 *sps_id, u32 *width, u32 *height, s32 *par_n, s32 *par_d)\n{\n\tVVCState *vvc;\n\ts32 idx;\n\tGF_SAFEALLOC(vvc, VVCState);\n\tif (!vvc) return GF_OUT_OF_MEM;\n\tvvc-&gt;sps_active_idx = -1;\n\n\tGF_BitStream *bs = gf_bs_new(sps_data, sps_size, GF_BITSTREAM_READ);\n\tgf_bs_enable_emulation_byte_removal(bs, GF_TRUE);\n\n\tu8 nal_unit_type, temporal_id, layer_id;\n\n\tvvc_parse_nal_header(bs, &amp;nal_unit_type, &amp;temporal_id, &amp;layer_id);\n\tidx = gf_vvc_read_sps_bs_internal(bs, vvc, layer_id, NULL);\n\tgf_bs_del(bs);\n\tif (idx &lt; 0) {\n\t\tgf_free(vvc);\n\t\treturn GF_NON_COMPLIANT_BITSTREAM;\n\t}\n\n\tif (sps_id) *sps_id = idx;\n\n\tif (width) *width = vvc-&gt;sps[idx].width;\n\tif (height) *height = vvc-&gt;sps[idx].height;\n\tif (par_n) *par_n = vvc-&gt;sps[idx].aspect_ratio_info_present_flag ? vvc-&gt;sps[idx].sar_width : (u32)-1;\n\tif (par_d) *par_d = vvc-&gt;sps[idx].aspect_ratio_info_present_flag ? vvc-&gt;sps[idx].sar_height : (u32)-1;\n\tgf_free(vvc);\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_vvc_get_profile_name(u8 video_prof)\n{\n\tswitch (video_prof) {\n\tcase 1:\n\t\treturn &quot;Main 10&quot;;\n\tcase 65:\n\t\treturn &quot;Main 10 Still Picture&quot;;\n\tcase 17:\n\t\treturn &quot;Multilayer Main 10&quot;;\n\tcase 2:\n\t\treturn &quot;Main 12&quot;;\n\tcase 10:\n\t\treturn &quot;Main 12 Intra&quot;;\n\tcase 66:\n\t\treturn &quot;Main 12 Still Picture&quot;;\n\tcase 34:\n\t\treturn &quot;Main 12 4:4:4&quot;;\n\tcase 42:\n\t\treturn &quot;Main 12 4:4:4 Intra&quot;;\n\tcase 98:\n\t\treturn &quot;Main 12 4:4:4 Still Picture&quot;;\n\tcase 36:\n\t\treturn &quot;Main 16 4:4:4&quot;;\n\tcase 44:\n\t\treturn &quot;Main 16 4:4:4 Intra&quot;;\n\tcase 100:\n\t\treturn &quot;Main 16 4:4:4 Still Picture&quot;;\n\tdefault:\n\t\treturn &quot;Unknown&quot;;\n\t}\n}\n\n\nGF_Err gf_media_vc1_seq_header_to_dsi(const u8 *seq_hdr, u32 seq_hdr_len, u8 **dsi, u32 *dsi_size)\n{\n\tGF_BitStream *bs;\n\tu8 level=0, interlace=0;\n\tu8 profile=12;\n\tu8 *sqhdr = memchr(seq_hdr+1, 0x0F, seq_hdr_len);\n\tif (sqhdr) {\n\t\tu32 skip = (u32) (sqhdr - seq_hdr - 3);\n\t\tseq_hdr+=skip;\n\t\tseq_hdr_len-=skip;\n\t\tbs = gf_bs_new(seq_hdr+4, seq_hdr_len-4, GF_BITSTREAM_READ);\n\t\tprofile = gf_bs_read_int(bs, 2);\n\t\tif (profile==3) {\n\t\t\tlevel = gf_bs_read_int(bs, 3);\n\t\t\t/*cfmt*/gf_bs_read_int(bs, 2);\n\t\t\t/*fps*/gf_bs_read_int(bs, 3);\n\t\t\t/*btrt*/gf_bs_read_int(bs, 5);\n\t\t\tgf_bs_read_int(bs, 1);\n\t\t\t/*mw*/gf_bs_read_int(bs, 12);\n\t\t\t/*mh*/gf_bs_read_int(bs, 12);\n\t\t\t/*bcast*/gf_bs_read_int(bs, 1);\n\t\t\tinterlace = gf_bs_read_int(bs, 1);\n\t\t}\n\t\tgf_bs_del(bs);\n\t}\n\t*dsi_size = seq_hdr_len+7;\n\t*dsi = gf_malloc(seq_hdr_len+7);\n\tif (! (*dsi) ) return  GF_OUT_OF_MEM;\n\n\tbs = gf_bs_new(*dsi, *dsi_size, GF_BITSTREAM_WRITE);\n\tgf_bs_write_int(bs, 12, 4); //profile\n\tgf_bs_write_int(bs, level, 3); //level\n\tgf_bs_write_int(bs, 0, 1); //reserved\n\tgf_bs_write_int(bs, level, 3); //level\n\tgf_bs_write_int(bs, 0, 1); //cbr\n\tgf_bs_write_int(bs, 0, 6); //reserved\n\tgf_bs_write_int(bs, !interlace, 1); //no interlace\n\tgf_bs_write_int(bs, 1, 1); //no multiple seq\n\tgf_bs_write_int(bs, 1, 1); //no multiple entry\n\tgf_bs_write_int(bs, 1, 1); //no slice present\n\tgf_bs_write_int(bs, 0, 1); //no b-frames\n\tgf_bs_write_int(bs, 0, 1); //reserved\n\tgf_bs_write_u32(bs, 0xFFFFFFFF); //framerate\n\tgf_bs_write_data(bs, seq_hdr, seq_hdr_len); //VOS\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n#endif /*GPAC_DISABLE_AV_PARSERS*/\n"}}, "reports": [{"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "a1124f36b6460882d35bf767163f19cf", "checker": {"name": "core.NullDereference", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-nulldereference-c-c-objc"}, "analyzerName": null, "line": 7403, "column": 16, "message": "Array access (from variable 'dst_ptr') results in a null pointer dereference", "events": [{"message": "Calling 'gf_hevc_vvc_parse_sei'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7446, "column": 2}, {"message": "Entered call from 'gf_hevc_parse_sei'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7353, "column": 1}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7361, "column": 6}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7369, "column": 9}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7372, "column": 10}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7372, "column": 10}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7378, "column": 10}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7378, "column": 10}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7385, "column": 7}, {"message": "Assuming 'hevc' is null", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7400, "column": 14}, {"message": "Null pointer value stored to 'dst_ptr'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7400, "column": 4}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7402, "column": 14}, {"message": "Array access (from variable 'dst_ptr') results in a null pointer dereference", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7403, "column": 16}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "a1124f36b6460882d35bf767163f19cf", "checker": {"name": "core.NullDereference", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-nulldereference-c-c-objc"}, "analyzerName": null, "line": 7416, "column": 16, "message": "Array access (from variable 'dst_ptr') results in a null pointer dereference", "events": [{"message": "Calling 'gf_hevc_vvc_parse_sei'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7446, "column": 2}, {"message": "Entered call from 'gf_hevc_parse_sei'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7353, "column": 1}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7361, "column": 6}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7369, "column": 9}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7372, "column": 10}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7372, "column": 10}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7378, "column": 10}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7378, "column": 10}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7385, "column": 7}, {"message": "Assuming 'hevc' is null", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7413, "column": 14}, {"message": "Null pointer value stored to 'dst_ptr'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7413, "column": 4}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7415, "column": 14}, {"message": "Array access (from variable 'dst_ptr') results in a null pointer dereference", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7416, "column": 16}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "9428e22af312d80812a3ed923f6b05f1", "checker": {"name": "alpha.security.ArrayBound", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#alpha-security-arraybound-c"}, "analyzerName": null, "line": 7641, "column": 24, "message": "Access out-of-bound array element (buffer overflow)", "events": [{"message": "Assuming field 'max_layers' is <= 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 3}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Access out-of-bound array element (buffer overflow)", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7641, "column": 24}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "b4d0f82ede3b46415ef55c17ba62aec9", "checker": {"name": "core.uninitialized.Assign", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-uninitialized-assign-c"}, "analyzerName": null, "line": 7648, "column": 24, "message": "Assigned value is garbage or undefined", "events": [{"message": "Assuming field 'max_layers' is <= 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Assuming 'splitting_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7644, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 16}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 17}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 4}, {"message": "Assuming 'i' is < 'num_scalability_types'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 17}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 5}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 4}, {"message": "Assuming 'i' is < 'num_scalability_types'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7645, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 17}, {"message": "The value 1 is assigned to 'j'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 24}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 5}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7647, "column": 17}, {"message": "Assigned value is garbage or undefined", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7648, "column": 24}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "a53d12434c2eb41d49e198a8e79d10b5", "checker": {"name": "alpha.security.ArrayBound", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#alpha-security-arraybound-c"}, "analyzerName": null, "line": 7660, "column": 28, "message": "Access out-of-bound array element (buffer overflow)", "events": [{"message": "Assuming field 'max_layers' is > 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Assuming field 'base_layer_internal_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 31}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming 'vps_nuh_layer_id_present_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7659, "column": 7}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7665, "column": 7}, {"message": "Assuming 'splitting_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7672, "column": 7}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 2}, {"message": "Assuming 'i' is < field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7665, "column": 7}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 2}, {"message": "Assuming 'i' is < field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7665, "column": 7}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 2}, {"message": "Assuming 'i' is < field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Access out-of-bound array element (buffer overflow)", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7660, "column": 28}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "cb331572e49dd0b2aad7a3ba222d8ca4", "checker": {"name": "alpha.security.ArrayBound", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#alpha-security-arraybound-c"}, "analyzerName": null, "line": 7663, "column": 28, "message": "Access out-of-bound array element (buffer overflow)", "events": [{"message": "Assuming field 'max_layers' is > 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Assuming field 'base_layer_internal_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 31}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming 'vps_nuh_layer_id_present_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7659, "column": 7}, {"message": "Assuming 'splitting_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7672, "column": 7}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 2}, {"message": "Assuming 'i' is < field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 2}, {"message": "Assuming 'i' is < field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 2}, {"message": "Assuming 'i' is < field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Access out-of-bound array element (buffer overflow)", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7663, "column": 28}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "7820609bc1c81d48c026ced2d2c0fd48", "checker": {"name": "core.CallAndMessage", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-callandmessage-c-c-objc"}, "analyzerName": null, "line": 7674, "column": 31, "message": "2nd function call argument is an uninitialized value", "events": [{"message": "Assuming field 'max_layers' is > 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Assuming field 'base_layer_internal_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 31}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7640, "column": 15}, {"message": "Assuming 'splitting_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7644, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming 'vps_nuh_layer_id_present_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7659, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7673, "column": 16}, {"message": "The value 1 is assigned to 'j'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7673, "column": 43}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7673, "column": 4}, {"message": "Assuming 'j' is < 'num_scalability_types'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7673, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7673, "column": 16}, {"message": "2nd function call argument is an uninitialized value", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7674, "column": 31}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "04694ba9e3eac8e629d77fc5472c8f1d", "checker": {"name": "alpha.security.ArrayBound", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#alpha-security-arraybound-c"}, "analyzerName": null, "line": 7827, "column": 34, "message": "Access out-of-bound array element (buffer overflow)", "events": [{"message": "Assuming field 'max_layers' is <= 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming 'splitting_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7679, "column": 6}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7685, "column": 15}, {"message": "Assuming 'view_id_len' is <= 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7690, "column": 6}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7696, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7703, "column": 14}, {"message": "Assuming 'i' is >= field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7704, "column": 7}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7713, "column": 14}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7737, "column": 14}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7758, "column": 14}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7767, "column": 6}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7773, "column": 6}, {"message": "Assuming field 'num_profile_tier_level' is <= MAX_LHVC_LAYERS", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7784, "column": 6}, {"message": "Assuming field 'base_layer_internal_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7790, "column": 11}, {"message": "Assuming 'i' is >= field 'num_profile_tier_level'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7790, "column": 50}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7790, "column": 50}, {"message": "Assuming 'NumLayerSets' is > 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7798, "column": 6}, {"message": "Assuming 'default_output_layer_idc' is >= 2", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7801, "column": 30}, {"message": "Assuming field 'num_output_layer_sets' is <= MAX_LHVC_LAYERS", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7805, "column": 6}, {"message": "Assuming 'i' is < field 'num_output_layer_sets'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 14}, {"message": "Assuming 'NumLayerSets' is <= 2", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7815, "column": 8}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7839, "column": 15}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7852, "column": 15}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 2}, {"message": "Assuming 'i' is < field 'num_output_layer_sets'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 14}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 4}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 4}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 4}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 4}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Access out-of-bound array element (buffer overflow)", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7827, "column": 34}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "fb7c99f6a8e0866b1c667df81eac034d", "checker": {"name": "core.uninitialized.Branch", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-uninitialized-branch-c"}, "analyzerName": null, "line": 7840, "column": 8, "message": "Branch condition evaluates to a garbage value", "events": [{"message": "Assuming field 'max_layers' is <= 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7626, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 14}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7631, "column": 2}, {"message": "Assuming 'num_scalability_types' is < 16", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7635, "column": 6}, {"message": "Assuming 'num_scalability_types' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7639, "column": 6}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7658, "column": 14}, {"message": "Assuming 'splitting_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7679, "column": 6}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7685, "column": 15}, {"message": "Assuming 'view_id_len' is <= 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7690, "column": 6}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7696, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7703, "column": 14}, {"message": "Assuming 'i' is >= field 'max_layers'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7704, "column": 7}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7713, "column": 14}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7737, "column": 14}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7758, "column": 14}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7767, "column": 6}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7773, "column": 6}, {"message": "Assuming field 'num_profile_tier_level' is <= MAX_LHVC_LAYERS", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7784, "column": 6}, {"message": "Assuming field 'base_layer_internal_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7790, "column": 11}, {"message": "Assuming 'i' is >= field 'num_profile_tier_level'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7790, "column": 50}, {"message": "Loop body executed 0 times", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7790, "column": 50}, {"message": "Assuming 'NumLayerSets' is > 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7798, "column": 6}, {"message": "Assuming 'default_output_layer_idc' is >= 2", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7801, "column": 30}, {"message": "Assuming field 'num_output_layer_sets' is <= MAX_LHVC_LAYERS", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7805, "column": 6}, {"message": "Assuming 'i' is < field 'num_output_layer_sets'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 14}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7814, "column": 14}, {"message": "Assuming 'NumLayerSets' is <= 2", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7815, "column": 8}, {"message": "Assuming the condition is true", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "Looping back to the head of the loop", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 4}, {"message": "Assuming the condition is false", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7826, "column": 16}, {"message": "The value 0 is assigned to 'j'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7839, "column": 8}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7839, "column": 15}, {"message": "Branch condition evaluates to a garbage value", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 7840, "column": 8}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "7ccdc31c13b76171e216c5f6a1afdc90", "checker": {"name": "deadcode.DeadStores", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#deadcode-deadstores-c"}, "analyzerName": null, "line": 9171, "column": 2, "message": "Value stored to 'numblkscod' is never read", "events": [{"message": "Value stored to 'numblkscod' is never read", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 9171, "column": 2}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "LOW"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "06bd88151d453df9d5428e66dfe783d3", "checker": {"name": "core.DivideZero", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-dividezero-c-c-objc"}, "analyzerName": null, "line": 11602, "column": 21, "message": "Division by zero", "events": [{"message": "Assuming field 'picture_header_in_slice_header_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11708, "column": 6}, {"message": "Assuming field 'sps' is non-null", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11712, "column": 6}, {"message": "Assuming field 'pps' is non-null", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11713, "column": 6}, {"message": "Assuming field 'subpic_info_present' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11715, "column": 6}, {"message": "Assuming field 'rect_slice_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11719, "column": 6}, {"message": "Assuming field 'num_tiles_in_pic' is <= 1", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11741, "column": 7}, {"message": "Assuming field 'inter_slice_allowed_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11752, "column": 6}, {"message": "Assuming field 'parse_mode' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11755, "column": 6}, {"message": "Assuming field 'alf_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11765, "column": 6}, {"message": "Assuming field 'lmcs_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11790, "column": 6}, {"message": "Assuming field 'explicit_scaling_list_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11793, "column": 6}, {"message": "Assuming field 'rpl_info_in_ph_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11797, "column": 6}, {"message": "Assuming field 'qp_delta_info_in_ph_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11881, "column": 6}, {"message": "Assuming field 'slice_chroma_qp_offsets_present_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11884, "column": 6}, {"message": "Assuming field 'cu_chroma_qp_offset_list_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11890, "column": 6}, {"message": "Assuming field 'sao_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11892, "column": 6}, {"message": "Assuming field 'deblocking_filter_override_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11898, "column": 6}, {"message": "Assuming field 'dep_quant_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11918, "column": 6}, {"message": "Assuming field 'sign_data_hiding_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11922, "column": 6}, {"message": "Assuming field 'transform_skip_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11926, "column": 6}, {"message": "Assuming field 'ts_residual_coding_rice_present_in_sh_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11929, "column": 43}, {"message": "Assuming field 'reverse_last_sig_coeff_enabled_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11932, "column": 6}, {"message": "Assuming field 'slice_header_extension_present_flag' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11935, "column": 6}, {"message": "Assuming field 'num_tile_cols' is 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11943, "column": 35}, {"message": "Assuming field 'num_tile_rows' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11943, "column": 62}, {"message": "Assuming field 'entry_point_offsets_present_flag' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11945, "column": 7}, {"message": "Calling 'vvc_get_num_entry_points'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11957, "column": 25}, {"message": "Entered call from 'vvc_parse_slice'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11661, "column": 1}, {"message": "Calling 'vvc_get_ctb_info_in_slice'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11669, "column": 25}, {"message": "Entered call from 'vvc_get_num_entry_points'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11583, "column": 1}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11600, "column": 31}, {"message": "Division by zero", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 11602, "column": 21}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "f7910d3acba49d395e3c8bdbff408cfe", "checker": {"name": "core.CallAndMessage", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-callandmessage-c-c-objc"}, "analyzerName": null, "line": 12193, "column": 9, "message": "3rd function call argument is an uninitialized value", "events": [{"message": "Calling 'gf_vvc_change_vui'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12268, "column": 9}, {"message": "Entered call from 'gf_vvc_change_color'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12154, "column": 1}, {"message": "Assuming 'vvc' is non-null", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12165, "column": 2}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12171, "column": 10}, {"message": "Assuming field 'type' is equal to GF_VVC_NALU_SEQ_PARAM", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12172, "column": 7}, {"message": "Entering loop body", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12182, "column": 10}, {"message": "'layer_id' declared without an initial value", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12185, "column": 34}, {"message": "Calling 'vvc_parse_nal_header'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12192, "column": 3}, {"message": "Entered call from 'gf_vvc_change_vui'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 10258, "column": 1}, {"message": "Assuming 'val' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 10262, "column": 6}, {"message": "Returning without writing to '*layer_id'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 10262, "column": 11}, {"message": "Returning from 'vvc_parse_nal_header'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12192, "column": 3}, {"message": "3rd function call argument is an uninitialized value", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12193, "column": 9}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}, {"fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "reportHash": "66e2f810ebe7048a3d4287211d9455c6", "checker": {"name": "core.CallAndMessage", "url": "https://clang.llvm.org/docs/analyzer/checkers.html#core-callandmessage-c-c-objc"}, "analyzerName": null, "line": 12287, "column": 8, "message": "3rd function call argument is an uninitialized value", "events": [{"message": "Assuming 'vvc' is non-null", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12277, "column": 2}, {"message": "'layer_id' declared without an initial value", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12284, "column": 33}, {"message": "Calling 'vvc_parse_nal_header'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12286, "column": 2}, {"message": "Entered call from 'gf_vvc_get_sps_info'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 10258, "column": 1}, {"message": "Assuming 'val' is not equal to 0", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 10262, "column": 6}, {"message": "Returning without writing to '*layer_id'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 10262, "column": 11}, {"message": "Returning from 'vvc_parse_nal_header'", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12286, "column": 2}, {"message": "3rd function call argument is an uninitialized value", "fileId": "/home/l0tus/workplace/GOSSIP/csabp/CSABlindSpot/gpac/issue2366/gpac-2.2.0/src/media_tools/av_parsers.c", "line": 12287, "column": 8}], "macros": [], "notes": [], "reviewStatus": "unreviewed", "severity": "HIGH"}]};
      window.onload = function() {
        if (!browserCompatible) {
          setNonCompatibleBrowserMessage();
        } else {
          BugViewer.init(data.files, data.reports);
          BugViewer.create();
          BugViewer.initByUrl();
        }
      };
    </script>
  </head>
  <body>
  <div class="container">
    <div id="content">
      <div id="side-bar">
        <div class="header">
          <a href="index.html" class="button">&#8249; Return to List</a>
        </div>
        <div id="report-nav">
          <div class="header">Reports</div>
        </div>
      </div>
      <div id="editor-wrapper">
        <div class="header">
          <div id="file">
            <span class="label">File:</span>
            <span id="file-path"></span>
          </div>
          <div id="checker">
            <span class="label">Checker name:</span>
            <span id="checker-name"></span>
          </div>
          <div id="review-status-wrapper">
            <span class="label">Review status:</span>
            <span id="review-status"></span>
          </div>
        </div>
        <div id="editor"></div>
      </div>
    </div>
  </div>
  </body>
</html>
